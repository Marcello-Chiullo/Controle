<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Sistema de Controle Gerencial para Confeitaria - Deia Cakes">
    <title>Deia Cakes - Controle Gerencial v2.0</title>
    
    <!-- Firebase SDK v9 (Compat para facilitar migra√ß√£o) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- Biblioteca para Scanner de C√≥digo de Barras -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.4/html5-qrcode.min.js"></script>
    
    <style>
        /* ====================================
           RESET E VARI√ÅVEIS GLOBAIS
           ==================================== */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            /* Cores principais */
            --cor-primaria: #ff85a2;
            --cor-primaria-escura: #ff6b8f;
            --cor-secundaria: #ffb5c8;
            --cor-secundaria-clara: #ffe0e8;
            
            /* Cores de status */
            --cor-sucesso: #28a745;
            --cor-sucesso-claro: #d4edda;
            --cor-erro: #dc3545;
            --cor-erro-claro: #f8d7da;
            --cor-aviso: #ffc107;
            --cor-aviso-claro: #fff3cd;
            --cor-info: #17a2b8;
            --cor-info-claro: #d1ecf1;
            
            /* Cores neutras */
            --cor-texto: #333333;
            --cor-texto-claro: #666666;
            --cor-borda: #dddddd;
            --cor-fundo: #f8f9fa;
            --cor-branco: #ffffff;
            
            /* Sombras */
            --sombra-leve: 0 2px 4px rgba(0, 0, 0, 0.1);
            --sombra-media: 0 4px 8px rgba(0, 0, 0, 0.1);
            --sombra-forte: 0 8px 16px rgba(0, 0, 0, 0.15);
            
            /* Transi√ß√µes */
            --transicao-rapida: 0.2s ease;
            --transicao-normal: 0.3s ease;
            
            /* Espa√ßamentos */
            --espacamento-xs: 5px;
            --espacamento-sm: 10px;
            --espacamento-md: 15px;
            --espacamento-lg: 20px;
            --espacamento-xl: 30px;
            
            /* Bordas */
            --borda-radius: 8px;
            --borda-radius-sm: 5px;
        }
        
        /* ====================================
           ESTILOS GERAIS
           ==================================== */
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--cor-texto);
            background-color: var(--cor-fundo);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--espacamento-lg);
        }
        
        /* ====================================
           HEADER
           ==================================== */
        
        header {
            background: linear-gradient(135deg, var(--cor-primaria) 0%, var(--cor-primaria-escura) 100%);
            color: var(--cor-branco);
            padding: var(--espacamento-md) 0;
            box-shadow: var(--sombra-media);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 var(--espacamento-lg);
        }
        
        .header-logo h1 {
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--espacamento-sm);
        }
        
        .header-logo h1::before {
            content: "üéÇ";
            font-size: 28px;
        }
        
        #user-info {
            display: flex;
            align-items: center;
            gap: var(--espacamento-md);
            font-size: 14px;
        }
        
        #user-email {
            background: rgba(255, 255, 255, 0.2);
            padding: var(--espacamento-xs) var(--espacamento-sm);
            border-radius: var(--borda-radius-sm);
            display: flex;
            align-items: center;
            gap: var(--espacamento-xs);
        }
        
        #user-email::before {
            content: "üë§";
        }
        
        #btn-logout,
        #btn-admin-nav {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: var(--cor-branco);
            padding: var(--espacamento-xs) var(--espacamento-md);
            border-radius: var(--borda-radius-sm);
            cursor: pointer;
            transition: var(--transicao-rapida);
            font-size: 13px;
        }
        
        #btn-logout:hover,
        #btn-admin-nav:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        
        #date-time {
            font-size: 13px;
            opacity: 0.9;
        }
        
        /* ====================================
           NAVEGA√á√ÉO PRINCIPAL
           ==================================== */
        
        nav {
            background-color: var(--cor-secundaria);
            box-shadow: var(--sombra-leve);
        }
        
        nav ul {
            display: flex;
            list-style: none;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 var(--espacamento-lg);
            gap: var(--espacamento-xs);
        }
        
        nav ul li a {
            display: block;
            color: var(--cor-texto);
            text-decoration: none;
            font-weight: 500;
            padding: var(--espacamento-md) var(--espacamento-lg);
            border-radius: var(--borda-radius-sm) var(--borda-radius-sm) 0 0;
            transition: var(--transicao-rapida);
            position: relative;
        }
        
        nav ul li a:hover {
            background-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }
        
        nav ul li a.active {
            background-color: var(--cor-primaria);
            color: var(--cor-branco);
        }
        
        nav ul li a.active::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background-color: var(--cor-branco);
        }
        
        /* ====================================
           CARDS E CONTAINERS
           ==================================== */
        
        .card {
            background-color: var(--cor-branco);
            border-radius: var(--borda-radius);
            box-shadow: var(--sombra-leve);
            padding: var(--espacamento-lg);
            margin-bottom: var(--espacamento-lg);
            transition: var(--transicao-normal);
        }
        
        .card:hover {
            box-shadow: var(--sombra-media);
        }
        
        .card h2,
        .card h3 {
            color: var(--cor-primaria);
            margin-bottom: var(--espacamento-md);
            display: flex;
            align-items: center;
            gap: var(--espacamento-sm);
        }
        
        .card h2 {
            font-size: 22px;
            border-bottom: 2px solid var(--cor-secundaria-clara);
            padding-bottom: var(--espacamento-sm);
        }
        
        .card h3 {
            font-size: 18px;
        }
        
        /* ====================================
           BOT√ïES
           ==================================== */
        
        .btn {
            padding: var(--espacamento-sm) var(--espacamento-lg);
            border: none;
            border-radius: var(--borda-radius-sm);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transicao-rapida);
            display: inline-flex;
            align-items: center;
            gap: var(--espacamento-xs);
            text-decoration: none;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--sombra-media);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-primary {
            background-color: var(--cor-primaria);
            color: var(--cor-branco);
        }
        
        .btn-primary:hover {
            background-color: var(--cor-primaria-escura);
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: var(--cor-branco);
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .btn-success {
            background-color: var(--cor-sucesso);
            color: var(--cor-branco);
        }
        
        .btn-success:hover {
            background-color: #218838;
        }
        
        .btn-danger {
            background-color: var(--cor-erro);
            color: var(--cor-branco);
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .btn-info {
            background-color: var(--cor-info);
            color: var(--cor-branco);
        }
        
        .btn-info:hover {
            background-color: #138496;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* ====================================
           FORMUL√ÅRIOS
           ==================================== */
        
        .form-group {
            margin-bottom: var(--espacamento-md);
        }
        
        .form-group label {
            display: block;
            margin-bottom: var(--espacamento-xs);
            font-weight: 500;
            color: var(--cor-texto);
            font-size: 14px;
        }
        
        .form-control {
            width: 100%;
            padding: var(--espacamento-sm);
            border: 1px solid var(--cor-borda);
            border-radius: var(--borda-radius-sm);
            font-size: 14px;
            font-family: inherit;
            transition: var(--transicao-rapida);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--cor-primaria);
            box-shadow: 0 0 0 3px rgba(255, 133, 162, 0.1);
        }
        
        .form-control:disabled {
            background-color: var(--cor-fundo);
            cursor: not-allowed;
        }
        
        .form-row {
            display: flex;
            gap: var(--espacamento-md);
            margin-bottom: var(--espacamento-md);
        }
        
        .form-col {
            flex: 1;
        }
        
        textarea.form-control {
            resize: vertical;
            min-height: 80px;
        }
        
        /* ====================================
           TABELAS
           ==================================== */
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: var(--espacamento-md);
        }
        
        table th,
        table td {
            padding: var(--espacamento-sm) var(--espacamento-md);
            text-align: left;
            border-bottom: 1px solid var(--cor-borda);
        }
        
        table th {
            background-color: var(--cor-fundo);
            font-weight: 600;
            color: var(--cor-texto);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        table tr:hover {
            background-color: var(--cor-secundaria-clara);
        }
        
        table td {
            font-size: 14px;
        }
        
        /* ====================================
           TABS (ABAS)
           ==================================== */
        
        .tab-buttons {
            display: flex;
            gap: var(--espacamento-xs);
            margin-bottom: var(--espacamento-lg);
            border-bottom: 2px solid var(--cor-borda);
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: var(--espacamento-sm) var(--espacamento-lg);
            border: none;
            background-color: transparent;
            cursor: pointer;
            transition: var(--transicao-rapida);
            border-radius: var(--borda-radius-sm) var(--borda-radius-sm) 0 0;
            font-weight: 500;
            color: var(--cor-texto-claro);
            position: relative;
        }
        
        .tab-button:hover {
            background-color: var(--cor-secundaria-clara);
            color: var(--cor-texto);
        }
        
        .tab-button.active {
            background-color: var(--cor-primaria);
            color: var(--cor-branco);
        }
        
        .tab-button.active::after {
            content: "";
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--cor-primaria);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* ====================================
           P√ÅGINAS
           ==================================== */
        
        .page-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .page-content.active {
            display: block;
        }
        
        /* ====================================
           MODAIS
           ==================================== */
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.2s ease-in-out;
        }
        
        .modal-content {
            background-color: var(--cor-branco);
            padding: var(--espacamento-xl);
            border-radius: var(--borda-radius);
            box-shadow: var(--sombra-forte);
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            width: 600px;
            animation: slideUp 0.3s ease-in-out;
        }
        
        .modal-content h3 {
            margin-bottom: var(--espacamento-lg);
            color: var(--cor-primaria);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--espacamento-lg);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--cor-texto-claro);
            transition: var(--transicao-rapida);
        }
        
        .modal-close:hover {
            color: var(--cor-erro);
            transform: scale(1.1);
        }
        
        /* ====================================
           NOTIFICA√á√ïES
           ==================================== */
        
        .notification {
            padding: var(--espacamento-md);
            border-radius: var(--borda-radius-sm);
            margin-bottom: var(--espacamento-md);
            animation: fadeIn 0.3s ease-in-out;
            display: flex;
            align-items: center;
            gap: var(--espacamento-sm);
        }
        
        .notification::before {
            font-size: 20px;
        }
        
        .notification-success {
            background-color: var(--cor-sucesso-claro);
            color: #155724;
            border-left: 4px solid var(--cor-sucesso);
        }
        
        .notification-success::before {
            content: "‚úì";
        }
        
        .notification-error {
            background-color: var(--cor-erro-claro);
            color: #721c24;
            border-left: 4px solid var(--cor-erro);
        }
        
        .notification-error::before {
            content: "‚úï";
        }
        
        .notification-warning {
            background-color: var(--cor-aviso-claro);
            color: #856404;
            border-left: 4px solid var(--cor-aviso);
        }
        
        .notification-warning::before {
            content: "‚ö†";
        }
        
        .notification-info {
            background-color: var(--cor-info-claro);
            color: #0c5460;
            border-left: 4px solid var(--cor-info);
        }
        
        .notification-info::before {
            content: "‚Ñπ";
        }
        
        /* Toast Notifications (canto inferior direito) */
        .toast-notification {
            position: fixed;
            bottom: var(--espacamento-lg);
            right: var(--espacamento-lg);
            background-color: var(--cor-sucesso);
            color: var(--cor-branco);
            padding: var(--espacamento-md) var(--espacamento-lg);
            border-radius: var(--borda-radius);
            box-shadow: var(--sombra-forte);
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: var(--espacamento-sm);
            min-width: 300px;
            animation: slideInRight 0.3s ease-in-out, slideOutRight 0.3s ease-in-out 2.7s;
        }
        
        .toast-notification.error {
            background-color: var(--cor-erro);
        }
        
        .toast-notification.warning {
            background-color: var(--cor-aviso);
            color: var(--cor-texto);
        }
        
        .toast-notification.info {
            background-color: var(--cor-info);
        }
        
        /* ====================================
           LOADER
           ==================================== */
        
        .loader {
            border: 4px solid var(--cor-secundaria-clara);
            border-top: 4px solid var(--cor-primaria);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: var(--espacamento-lg) auto;
        }
        
        /* ====================================
           UTILIT√ÅRIOS
           ==================================== */
        
        .hidden {
            display: none !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-right {
            text-align: right;
        }
        
        .mt-1 { margin-top: var(--espacamento-xs); }
        .mt-2 { margin-top: var(--espacamento-sm); }
        .mt-3 { margin-top: var(--espacamento-md); }
        .mt-4 { margin-top: var(--espacamento-lg); }
        
        .mb-1 { margin-bottom: var(--espacamento-xs); }
        .mb-2 { margin-bottom: var(--espacamento-sm); }
        .mb-3 { margin-bottom: var(--espacamento-md); }
        .mb-4 { margin-bottom: var(--espacamento-lg); }
        
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-success {
            background-color: var(--cor-sucesso-claro);
            color: var(--cor-sucesso);
        }
        
        .badge-warning {
            background-color: var(--cor-aviso-claro);
            color: #856404;
        }
        
        .badge-danger {
            background-color: var(--cor-erro-claro);
            color: var(--cor-erro);
        }
        
        .badge-info {
            background-color: var(--cor-info-claro);
            color: var(--cor-info);
        }
        
        /* ====================================
           ANIMA√á√ïES
           ==================================== */
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ====================================
           RESPONSIVIDADE
           ==================================== */
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: var(--espacamento-sm);
            }
            
            nav ul {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            nav ul li a {
                padding: var(--espacamento-sm) var(--espacamento-md);
                font-size: 13px;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .modal-content {
                width: 95%;
                padding: var(--espacamento-lg);
            }
            
            .toast-notification {
                left: var(--espacamento-sm);
                right: var(--espacamento-sm);
                bottom: var(--espacamento-sm);
            }
            
            table {
                font-size: 12px;
            }
            
            table th,
            table td {
                padding: var(--espacamento-xs) var(--espacamento-sm);
            }
        }
        
        /* ====================================
           CALEND√ÅRIO (Preview)
           ==================================== */
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: var(--espacamento-xs);
            margin-top: var(--espacamento-md);
        }
        
        .calendar-day {
            aspect-ratio: 1;
            border: 1px solid var(--cor-borda);
            border-radius: var(--borda-radius-sm);
            padding: var(--espacamento-xs);
            text-align: center;
            cursor: pointer;
            transition: var(--transicao-rapida);
            position: relative;
        }
        
        .calendar-day:hover {
            background-color: var(--cor-secundaria-clara);
            transform: scale(1.05);
        }
        
        .calendar-day.has-delivery {
            background-color: var(--cor-primaria);
            color: var(--cor-branco);
            font-weight: 600;
        }
        
        .calendar-day.selected {
            border: 2px solid var(--cor-primaria);
            box-shadow: var(--sombra-media);
        }
        
        .calendar-day-number {
            font-size: 14px;
            font-weight: 600;
        }
        
        .calendar-day-indicator {
            font-size: 10px;
            margin-top: 2px;
        }
    </style>
</head>
<body>
    
    <!-- ====================================
         HEADER
         ==================================== -->
    
    <header>
        <div class="header-content">
            <div class="header-logo">
                <h1>Deia Cakes Controle Gerencial</h1>
            </div>
            <div id="user-info" class="hidden">
                <span id="user-email"></span>
                <button id="btn-admin-nav" class="hidden">üë• Navegar Usu√°rios</button>
                <button id="btn-upload-firebase" class="hidden">‚¨ÜÔ∏è Enviar</button>
                <button id="btn-download-firebase" class="hidden">‚¨áÔ∏è Buscar</button>
                <button id="btn-logout">üö™ Sair</button>
            </div>
            <div>
                <span id="date-time"></span>
            </div>
        </div>
    </header>
    
    <!-- ====================================
         NAVEGA√á√ÉO PRINCIPAL
         ==================================== -->
    
    <nav>
        <ul>
            <li><a href="#estoque" class="nav-link active" data-page="estoque">üì¶ Estoque</a></li>
            <li><a href="#materiais" class="nav-link" data-page="materiais">üè∑Ô∏è Materiais</a></li>
            <li><a href="#receitas" class="nav-link" data-page="receitas">üç∞ Receitas</a></li>
            <li><a href="#vendas" class="nav-link" data-page="vendas">üí∞ Vendas</a></li>
            <li><a href="#calendario" class="nav-link" data-page="calendario">üìÖ Calend√°rio</a></li>
        </ul>
    </nav>
    
    <!-- ====================================
         CONTAINER PRINCIPAL - P√ÅGINAS
         ==================================== -->
    
    <div class="container">
        
        <!-- P√ÅGINA: ESTOQUE -->
        <div id="estoque-page" class="page-content active">
            <h2>üì¶ Gest√£o de Estoque</h2>
            <div class="card">
                <h3>Itens em Estoque</h3>
                <p>Carregando...</p>
            </div>
        </div>
        
        <!-- P√ÅGINA: MATERIAIS -->
        <div id="materiais-page" class="page-content">
            <h2>üè∑Ô∏è Gest√£o de Materiais</h2>
            <div class="card">
                <p>Carregando...</p>
            </div>
        </div>
        
        <!-- P√ÅGINA: RECEITAS -->
        <div id="receitas-page" class="page-content">
            <h2>üç∞ Gest√£o de Receitas</h2>
            <div class="card">
                <p>Carregando...</p>
            </div>
        </div>
        
        <!-- P√ÅGINA: VENDAS -->
        <div id="vendas-page" class="page-content">
            <h2>üí∞ Gest√£o de Vendas</h2>
            <div class="card">
                <p>Carregando...</p>
            </div>
        </div>
        
        <!-- P√ÅGINA: CALEND√ÅRIO -->
        <div id="calendario-page" class="page-content">
            <h2>üìÖ Calend√°rio de Entregas</h2>
            <div class="card">
                <p>Carregando...</p>
            </div>
        </div>
        
    </div>
    
    <!-- ====================================
         MODAL: LOGIN
         ==================================== -->
    
    <div id="login-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>üîê Login - Deia Cakes</h3>
            <div id="login-notification"></div>
            
            <div class="form-group">
                <label for="login-email">Email:</label>
                <input type="email" id="login-email" class="form-control" placeholder="seu@email.com" required>
            </div>
            
            <div class="form-group">
                <label for="login-senha">Senha:</label>
                <input type="password" id="login-senha" class="form-control" placeholder="Sua senha" required>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button id="btn-login" class="btn btn-primary" style="flex: 1;">üîë Entrar</button>
                <button id="btn-cadastrar" class="btn btn-secondary" style="flex: 1;">‚ûï Cadastrar</button>
            </div>
        </div>
    </div>
    
    <!-- ====================================
         MODAL: PROCESSAMENTO
         ==================================== -->
    
    <div id="processing-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <h3 id="modal-title">Processando...</h3>
            <div class="loader"></div>
            <p id="modal-message">Aguarde enquanto processamos as informa√ß√µes.</p>
        </div>
    </div>
    
    <!-- ====================================
         JAVASCRIPT
         ==================================== -->
    
    <script>
        // ====================================
        // CONFIGURA√á√ÉO DO FIREBASE
        // ====================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyABzQdTgR9-Al-drNRMBcEb1dN76wUjqvY",
            authDomain: "deiacontrole-faabc.firebaseapp.com",
            databaseURL: "https://deiacontrole-faabc-default-rtdb.firebaseio.com",
            projectId: "deiacontrole-faabc",
            storageBucket: "deiacontrole-faabc.firebasestorage.app",
            messagingSenderId: "216368622292",
            appId: "1:216368622292:web:20522a4725c30907c92941",
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        
        // ====================================
        // VARI√ÅVEIS GLOBAIS
        // ====================================
        
        let currentUser = null;
        let isAdmin = false;
        let visualizandoUsuario = null; // Para quando ADM navega entre usu√°rios
        
        // Dados do sistema
        let materiais = [];
        let receitas = [];
        let vendas = [];
        let estoque = []; // Ser√° sempre calculado, n√£o armazenado
        
        // Scanner de QR Code
        let html5QrCode = null;
        
        // Constantes
        const EMAIL_ADMIN = "marcellochiullo@gmail.com";
        
        // ====================================
        // FUN√á√ïES UTILIT√ÅRIAS
        // ====================================
        
        /**
         * Gera ID √∫nico
         */
        function gerarId() {
            return 'id_' + Date.now().toString(36) + '_' + Math.random().toString(36).substring(2, 11);
        }
        
        /**
         * Formata data para exibi√ß√£o
         */
        function formatarData(data) {
            try {
                const d = new Date(data);
                const dia = String(d.getDate()).padStart(2, '0');
                const mes = String(d.getMonth() + 1).padStart(2, '0');
                const ano = d.getFullYear();
                return `${dia}/${mes}/${ano}`;
            } catch (e) {
                return 'Data inv√°lida';
            }
        }

        /**
         * Formata quantidade grande em unidades maiores
         */
        function formatarQuantidadeGrande(quantidade, unidade) {
            if (unidade === 'ml' && quantidade >= 1000) {
                return `${(quantidade / 1000).toFixed(2)} L (${quantidade.toFixed(2)} ml)`;
            }
            if (unidade === 'g' && quantidade >= 1000) {
                return `${(quantidade / 1000).toFixed(2)} Kg (${quantidade.toFixed(2)} g)`;
            }
            return `${quantidade.toFixed(2)} ${unidade}`;
        }
        
        /**
         * Formata valor monet√°rio
         */
        function formatarMoeda(valor) {
            if (isNaN(valor)) valor = 0;
            return 'R$ ' + parseFloat(valor).toFixed(2).replace('.', ',');
        }
        
        /**
         * Normaliza nome para compara√ß√£o (remove acentos, lowercase, trim)
         */
        function normalizarNome(nome) {
            if (!nome) return '';
            return nome
                .toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .replace(/\s+/g, " ")
                .trim();
        }
        
        /**
         * Converte unidades (kg‚Üíg, l‚Üíml, etc)
         */
        function converterUnidade(quantidade, unidadeOrigem, unidadeDestino) {
            if (!unidadeOrigem || !unidadeDestino) return quantidade;
            
            const origem = unidadeOrigem.toLowerCase();
            const destino = unidadeDestino.toLowerCase();
            
            // Mesma unidade
            if (origem === destino) return quantidade;
            
            // kg ‚Üí g
            if (origem === 'kg' && destino === 'g') return quantidade * 1000;
            if (origem === 'g' && destino === 'kg') return quantidade / 1000;
            
            // l ‚Üí ml
            if (origem === 'l' && destino === 'ml') return quantidade * 1000;
            if (origem === 'ml' && destino === 'l') return quantidade / 1000;
            
            // Se n√£o houver convers√£o conhecida, retorna a quantidade original
            return quantidade;
        }
        
        /**
         * Mostra/esconde modal de processamento
         */
        function toggleModal(mostrar, titulo = "Processando...", mensagem = "Aguarde...") {
            const modal = document.getElementById('processing-modal');
            if (!modal) return;
            
            if (mostrar) {
                document.getElementById('modal-title').textContent = titulo;
                document.getElementById('modal-message').textContent = mensagem;
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }
        
        /**
         * Mostra notifica√ß√£o toast (canto inferior direito)
         */
        function mostrarToast(mensagem, tipo = 'success', duracao = 3000) {
            // Remove toast existente
            const toastExistente = document.querySelector('.toast-notification');
            if (toastExistente) {
                document.body.removeChild(toastExistente);
            }
            
            // Cria novo toast
            const toast = document.createElement('div');
            toast.className = `toast-notification ${tipo}`;
            toast.textContent = mensagem;
            
            document.body.appendChild(toast);
            
            // Remove ap√≥s dura√ß√£o especificada
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, duracao);
        }
        
        /**
         * Mostra notifica√ß√£o inline
         */
        function mostrarNotificacao(elementoId, mensagem, tipo = 'info', duracao = 5000) {
            const elemento = document.getElementById(elementoId);
            if (!elemento) return;
            
            elemento.className = `notification notification-${tipo}`;
            elemento.textContent = mensagem;
            elemento.classList.remove('hidden');
            
            if (duracao > 0) {
                setTimeout(() => {
                    elemento.classList.add('hidden');
                }, duracao);
            }
        }
        
        /**
         * Atualiza rel√≥gio no header
         */
        function atualizarDataHora() {
            const elemento = document.getElementById('date-time');
            if (!elemento) return;
            
            const agora = new Date();
            const opcoes = { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            elemento.textContent = agora.toLocaleString('pt-BR', opcoes);
        }
        
        // Atualiza rel√≥gio a cada segundo
        setInterval(atualizarDataHora, 1000);
        atualizarDataHora();
        
        /**
         * Salva dados no localStorage
         */
        function salvarLocalStorage() {
            try {
                localStorage.setItem('materiais', JSON.stringify(materiais));
                localStorage.setItem('receitas', JSON.stringify(receitas));
                localStorage.setItem('vendas', JSON.stringify(vendas));
                localStorage.setItem('ultimaAtualizacao', new Date().toISOString());
                return true;
            } catch (erro) {
                console.error('Erro ao salvar no localStorage:', erro);
                return false;
            }
        }
        
        /**
         * Carrega dados do localStorage
         */
        function carregarLocalStorage() {
            try {
                materiais = JSON.parse(localStorage.getItem('materiais')) || [];
                receitas = JSON.parse(localStorage.getItem('receitas')) || [];
                vendas = JSON.parse(localStorage.getItem('vendas')) || [];
                return true;
            } catch (erro) {
                console.error('Erro ao carregar do localStorage:', erro);
                materiais = [];
                receitas = [];
                vendas = [];
                return false;
            }
        }
        
        /**
         * Obt√©m o usu√°rio atual (considerando navega√ß√£o ADM)
         */
        function getUsuarioAtual() {
            return visualizandoUsuario || currentUser.email;
        }
        
        /**
         * Navega entre p√°ginas
         */
        function navegarPagina(nomePagina) {
            // Esconde todas as p√°ginas
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
            });
            
            // Mostra p√°gina selecionada
            const pagina = document.getElementById(`${nomePagina}-page`);
            if (pagina) {
                pagina.classList.add('active');
            }
            
            // Atualiza navega√ß√£o
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            const linkAtivo = document.querySelector(`.nav-link[data-page="${nomePagina}"]`);
            if (linkAtivo) {
                linkAtivo.classList.add('active');
            }
            
            // Carrega dados da p√°gina se necess√°rio
            switch(nomePagina) {
                case 'estoque':
                    carregarPaginaEstoque();
                    break;
                case 'materiais':
                    carregarPaginaMateriais();
                    break;
                case 'receitas':
                    carregarPaginaReceitas();
                    break;
                case 'vendas':
                    carregarPaginaVendas();
                    break;
                case 'calendario':
                    carregarPaginaCalendario();
                    break;
            }
        }
        
        // ====================================
        // NAVEGA√á√ÉO - EVENT LISTENERS
        // ====================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Links de navega√ß√£o
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const pagina = this.getAttribute('data-page');
                    navegarPagina(pagina);
                });
            });
        });
        
        // ====================================
        // PLACEHOLDERS DE FUN√á√ïES
        // (Ser√£o implementadas nas pr√≥ximas partes)
        // ====================================
        
        function carregarPaginaEstoque() {
            console.log('Carregando p√°gina de estoque...');
        }
        
        function carregarPaginaMateriais() {
            console.log('Carregando p√°gina de materiais...');
        }
        
        function carregarPaginaReceitas() {
            console.log('Carregando p√°gina de receitas...');
        }
        
        function carregarPaginaVendas() {
            console.log('Carregando p√°gina de vendas...');
        }
        
        function carregarPaginaCalendario() {
            console.log('Carregando calend√°rio de entregas...');
        }
        
        // ====================================
        // INICIALIZA√á√ÉO
        // ====================================
        
        console.log('‚úÖ Sistema Deia Cakes v2.0 inicializado');
        console.log('üî• Firebase conectado');
        console.log('üì¶ Aguardando autentica√ß√£o...');
        // ====================================
        // PARTE 2: AUTENTICA√á√ÉO HIER√ÅRQUICA
        // ====================================
        
        /**
         * Verifica se o email √© do administrador
         */
        function isEmailAdmin(email) {
            return email && email.toLowerCase() === EMAIL_ADMIN.toLowerCase();
        }
        
        /**
         * Inicializa o sistema ap√≥s autentica√ß√£o
         */
        async function inicializarSistema(user) {
            try {
                currentUser = user;
                isAdmin = isEmailAdmin(user.email);
                
                console.log('üë§ Usu√°rio autenticado:', user.email);
                console.log('üîë √â administrador:', isAdmin);
                
                // Mostrar informa√ß√µes do usu√°rio
                document.getElementById('user-email').textContent = user.email;
                document.getElementById('user-info').classList.remove('hidden');
                
                // Mostrar bot√µes de admin
                if (isAdmin) {
                    document.getElementById('btn-admin-nav').classList.remove('hidden');
                }
                
                // Mostrar bot√µes de sincroniza√ß√£o para todos
                document.getElementById('btn-upload-firebase').classList.remove('hidden');
                document.getElementById('btn-download-firebase').classList.remove('hidden');
                
                // Esconder modal de login
                document.getElementById('login-modal').classList.add('hidden');
                
                // Carregar dados
                toggleModal(true, "Carregando dados...", "Buscando suas informa√ß√µes...");
                
                await carregarDadosUsuario();
                
                toggleModal(false);
                
                // Navegar para primeira p√°gina
                navegarPagina('estoque');
                
                mostrarToast('Bem-vindo(a) ao sistema!', 'success');
                
            } catch (erro) {
                console.error('Erro ao inicializar sistema:', erro);
                toggleModal(false);
                mostrarToast('Erro ao carregar dados do usu√°rio', 'error');
            }
        }
        
        /**
         * Carrega dados do usu√°rio (localStorage + Firebase)
         */
        async function carregarDadosUsuario() {
            const emailUsuario = getUsuarioAtual();
            
            try {
                // 1. Tentar carregar do localStorage primeiro
                carregarLocalStorage();
                
                // 2. Buscar dados do Firebase
                const snapshot = await database.ref(`usuarios/${emailUsuario.replace(/\./g, '_')}`).once('value');
                const dadosNuvem = snapshot.val();
                
                if (dadosNuvem) {
                    console.log('‚òÅÔ∏è Dados encontrados na nuvem');
                    
                    // Verificar se dados da nuvem s√£o mais recentes
                    const timestampLocal = localStorage.getItem('ultimaAtualizacao');
                    const timestampNuvem = dadosNuvem.ultimaAtualizacao;
                    
                    if (!timestampLocal || new Date(timestampNuvem) > new Date(timestampLocal)) {
                        console.log('üì• Usando dados da nuvem (mais recentes)');
                        materiais = dadosNuvem.materiais || [];
                        receitas = dadosNuvem.receitas || [];
                        vendas = dadosNuvem.vendas || [];
                        
                        salvarLocalStorage();
                    } else {
                        console.log('üíæ Usando dados locais (mais recentes)');
                    }
                } else {
                    console.log('üì≠ Nenhum dado na nuvem, usando localStorage');
                }
                
                // 3. Calcular estoque
                estoque = calcularEstoqueCompleto();
                
                console.log('‚úÖ Dados carregados:', {
                    materiais: materiais.length,
                    receitas: receitas.length,
                    vendas: vendas.length
                });
                
            } catch (erro) {
                console.error('Erro ao carregar dados do usu√°rio:', erro);
                throw erro;
            }
        }
        
        /**
         * Sincroniza dados com Firebase
         */
        async function sincronizarComNuvem() {
            const emailUsuario = getUsuarioAtual();
            
            try {
                toggleModal(true, "Sincronizando...", "Salvando dados na nuvem...");
                
                const dados = {
                    materiais: materiais,
                    receitas: receitas,
                    vendas: vendas,
                    ultimaAtualizacao: new Date().toISOString()
                };
                
                await database.ref(`usuarios/${emailUsuario.replace(/\./g, '_')}`).set(dados);
                
                salvarLocalStorage();
                
                toggleModal(false);
                mostrarToast('Dados sincronizados com sucesso!', 'success');
                
                return true;
            } catch (erro) {
                console.error('Erro ao sincronizar:', erro);
                toggleModal(false);
                mostrarToast('Erro ao sincronizar dados', 'error');
                return false;
            }
        }
        
        /**
         * For√ßa upload dos dados locais para o Firebase
         */
        async function forcarUploadFirebase() {
            const confirma = confirm(
                '‚¨ÜÔ∏è ENVIAR DADOS PARA NUVEM\n\n' +
                'Isso vai SOBRESCREVER os dados no Firebase\n' +
                'com os dados que est√£o no seu navegador.\n\n' +
                'Deseja continuar?'
            );
            
            if (!confirma) return;
            
            try {
                toggleModal(true, "Enviando para nuvem...", "Fazendo upload dos dados...");
                
                const emailUsuario = getUsuarioAtual();
                const dados = {
                    materiais: materiais,
                    receitas: receitas,
                    vendas: vendas,
                    ultimaAtualizacao: new Date().toISOString()
                };
                
                await database.ref(`usuarios/${emailUsuario.replace(/\./g, '_')}`).set(dados);
                
                // Atualizar localStorage tamb√©m
                salvarLocalStorage();
                
                toggleModal(false);
                mostrarToast('‚úÖ Dados enviados para nuvem com sucesso!', 'success');
                
            } catch (erro) {
                console.error('Erro ao enviar para nuvem:', erro);
                toggleModal(false);
                mostrarToast('‚ùå Erro ao enviar dados: ' + erro.message, 'error');
            }
        }

        /**
         * For√ßa download dos dados do Firebase para local
         */
        async function forcarDownloadFirebase() {
            const confirma = confirm(
                '‚¨áÔ∏è BUSCAR DADOS DA NUVEM\n\n' +
                'Isso vai SOBRESCREVER os dados no seu navegador\n' +
                'com os dados que est√£o no Firebase.\n\n' +
                'ATEN√á√ÉO: Voc√™ vai perder as altera√ß√µes\n' +
                'n√£o sincronizadas que est√£o no navegador!\n\n' +
                'Deseja continuar?'
            );
            
            if (!confirma) return;
            
            try {
                toggleModal(true, "Buscando da nuvem...", "Fazendo download dos dados...");
                
                const emailUsuario = getUsuarioAtual();
                const snapshot = await database.ref(`usuarios/${emailUsuario.replace(/\./g, '_')}`).once('value');
                const dadosNuvem = snapshot.val();
                
                if (!dadosNuvem) {
                    toggleModal(false);
                    mostrarToast('‚ö†Ô∏è Nenhum dado encontrado na nuvem', 'warning');
                    return;
                }
                
                // Substituir dados locais pelos da nuvem
                materiais = dadosNuvem.materiais || [];
                receitas = dadosNuvem.receitas || [];
                vendas = dadosNuvem.vendas || [];
                
                // Recalcular estoque
                estoque = calcularEstoqueCompleto();
                
                // Salvar no localStorage
                salvarLocalStorage();
                
                // Recarregar p√°gina atual
                const paginaAtual = document.querySelector('.page-content.active').id.replace('-page', '');
                navegarPagina(paginaAtual);
                
                toggleModal(false);
                mostrarToast('‚úÖ Dados baixados da nuvem com sucesso!', 'success');
                
            } catch (erro) {
                console.error('Erro ao baixar da nuvem:', erro);
                toggleModal(false);
                mostrarToast('‚ùå Erro ao baixar dados: ' + erro.message, 'error');
            }
        }
        
        /**
         * Placeholder para c√°lculo de estoque (ser√° implementado na Parte 3)
         */
        function calcularEstoqueCompleto() {
            // TODO: Implementar na Parte 3
            return [];
        }
        
        /**
         * Faz login do usu√°rio
         */
        async function fazerLogin() {
            const email = document.getElementById('login-email').value.trim();
            const senha = document.getElementById('login-senha').value;
            
            if (!email || !senha) {
                mostrarNotificacao('login-notification', 'Preencha todos os campos', 'error');
                return;
            }
            
            try {
                toggleModal(true, "Entrando...", "Autenticando credenciais...");
                
                const userCredential = await auth.signInWithEmailAndPassword(email, senha);
                
                toggleModal(false);
                
                // Sistema ser√° inicializado pelo onAuthStateChanged
                
            } catch (erro) {
                toggleModal(false);
                console.error('Erro ao fazer login:', erro);
                
                let mensagem = 'Erro ao fazer login';
                
                switch(erro.code) {
                    case 'auth/user-not-found':
                        mensagem = 'Usu√°rio n√£o encontrado';
                        break;
                    case 'auth/wrong-password':
                        mensagem = 'Senha incorreta';
                        break;
                    case 'auth/invalid-email':
                        mensagem = 'Email inv√°lido';
                        break;
                    case 'auth/too-many-requests':
                        mensagem = 'Muitas tentativas. Tente novamente mais tarde';
                        break;
                    default:
                        mensagem = erro.message;
                }
                
                mostrarNotificacao('login-notification', mensagem, 'error');
            }
        }
        
        /**
         * Cadastra novo usu√°rio
         */
        async function fazerCadastro() {
            const email = document.getElementById('login-email').value.trim();
            const senha = document.getElementById('login-senha').value;
            
            if (!email || !senha) {
                mostrarNotificacao('login-notification', 'Preencha todos os campos', 'error');
                return;
            }
            
            if (senha.length < 6) {
                mostrarNotificacao('login-notification', 'A senha deve ter pelo menos 6 caracteres', 'error');
                return;
            }
            
            // Verificar se √© o primeiro usu√°rio (ADM)
            const isFirstUser = !currentUser;
            
            // Se n√£o for o primeiro usu√°rio, precisa ser ADM para criar
            if (!isFirstUser && !isAdmin) {
                mostrarNotificacao('login-notification', 'Apenas administradores podem criar usu√°rios', 'error');
                return;
            }
            
            try {
                toggleModal(true, "Criando conta...", "Registrando novo usu√°rio...");
                
                const userCredential = await auth.createUserWithEmailAndPassword(email, senha);
                
                // Registrar informa√ß√µes do usu√°rio
                await database.ref(`usuarios/${email.replace(/\./g, '_')}/info`).set({
                    email: email,
                    criadoEm: new Date().toISOString(),
                    criadoPor: isFirstUser ? 'sistema' : currentUser.email,
                    role: isEmailAdmin(email) ? 'admin' : 'user'
                });
                
                toggleModal(false);
                
                mostrarNotificacao('login-notification', 'Conta criada com sucesso!', 'success', 3000);
                
                // Se n√£o for o primeiro usu√°rio (ADM criando outro), fazer logout autom√°tico
                // para o novo usu√°rio fazer login
                if (!isFirstUser) {
                    setTimeout(() => {
                        mostrarToast('Usu√°rio criado! Ele j√° pode fazer login.', 'success');
                    }, 500);
                }
                
            } catch (erro) {
                toggleModal(false);
                console.error('Erro ao criar conta:', erro);
                
                let mensagem = 'Erro ao criar conta';
                
                switch(erro.code) {
                    case 'auth/email-already-in-use':
                        mensagem = 'Este email j√° est√° em uso';
                        break;
                    case 'auth/invalid-email':
                        mensagem = 'Email inv√°lido';
                        break;
                    case 'auth/weak-password':
                        mensagem = 'Senha muito fraca';
                        break;
                    default:
                        mensagem = erro.message;
                }
                
                mostrarNotificacao('login-notification', mensagem, 'error');
            }
        }
        
        /**
         * Faz logout do usu√°rio
         */
        async function fazerLogout() {
            const confirma = confirm('Deseja realmente sair do sistema?');
            if (!confirma) return;
            
            try {
                // Sincronizar antes de sair
                await sincronizarComNuvem();
                
                await auth.signOut();
                
                // Limpar dados
                currentUser = null;
                isAdmin = false;
                visualizandoUsuario = null;
                materiais = [];
                receitas = [];
                vendas = [];
                estoque = [];
                
                // Esconder info do usu√°rio
                document.getElementById('user-info').classList.add('hidden');
                
                // Mostrar modal de login
                document.getElementById('login-modal').classList.remove('hidden');
                
                mostrarToast('Logout realizado com sucesso!', 'success');
                
            } catch (erro) {
                console.error('Erro ao fazer logout:', erro);
                mostrarToast('Erro ao fazer logout', 'error');
            }
        }
        
        /**
         * Abre modal para navega√ß√£o entre usu√°rios (ADM apenas)
         */
        async function abrirNavegacaoUsuarios() {
            if (!isAdmin) {
                mostrarToast('Apenas administradores podem acessar esta fun√ß√£o', 'error');
                return;
            }
            
            try {
                toggleModal(true, "Buscando usu√°rios...", "Carregando lista de usu√°rios...");
                
                // Buscar todos os usu√°rios
                const snapshot = await database.ref('usuarios').once('value');
                const usuarios = snapshot.val();
                
                // Se n√£o tiver usu√°rios, retornar
                if (!usuarios) {
                    toggleModal(false);
                    mostrarToast('Nenhum usu√°rio encontrado', 'info');
                    return;
                }
                
                // Filtrar apenas os usu√°rios que t√™m dados (n√£o apenas /info)
                const usuariosComDados = Object.keys(usuarios).filter(key => {
                    const usuario = usuarios[key];
                    return usuario && (usuario.materiais || usuario.receitas || usuario.vendas);
                });
                
                // Criar modal de sele√ß√£o
                const usuariosArray = usuariosComDados
                    .map(key => key.replace(/_/g, '.'))
                    .filter(email => email !== EMAIL_ADMIN); // Excluir o pr√≥prio ADM
                
                if (usuariosArray.length === 0) {
                    mostrarToast('Nenhum outro usu√°rio cadastrado', 'info');
                    return;
                }
                
                mostrarModalSelecaoUsuario(usuariosArray);
                
            } catch (erro) {
                console.error('Erro ao buscar usu√°rios:', erro);
                toggleModal(false);
                mostrarToast('Erro ao buscar usu√°rios', 'error');
            }
        }
        
        /**
         * Mostra modal de sele√ß√£o de usu√°rio
         */
        function mostrarModalSelecaoUsuario(usuarios) {
            // Criar modal dinamicamente
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>üë• Navegar como Usu√°rio</h3>
                        <button class="modal-close" onclick="this.parentElement.parentElement.parentElement.remove()">√ó</button>
                    </div>
                    <p style="margin-bottom: 15px;">Selecione um usu√°rio para visualizar seus dados:</p>
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${usuarios.map(email => `
                            <button class="btn btn-secondary" style="width: 100%; margin-bottom: 10px; justify-content: flex-start;"
                                onclick="navegarParaUsuario('${email}')">
                                üìß ${email}
                            </button>
                        `).join('')}
                    </div>
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--cor-borda);">
                        ${visualizandoUsuario ? `
                            <button class="btn btn-primary" style="width: 100%;" onclick="voltarParaAdmin()">
                                ‚Ü©Ô∏è Voltar para Conta Admin
                            </button>
                        ` : ''}
                        <button class="btn btn-secondary" style="width: 100%; margin-top: 10px;" 
                            onclick="this.parentElement.parentElement.parentElement.remove()">
                            ‚ùå Fechar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        /**
         * Navega para visualizar dados de outro usu√°rio (ADM apenas)
         */
        async function navegarParaUsuario(email) {
            if (!isAdmin) {
                mostrarToast('Apenas administradores podem acessar esta fun√ß√£o', 'error');
                return;
            }
            
            try {
                // Fechar modal
                const modal = document.querySelector('.modal-overlay:last-child');
                if (modal) modal.remove();
                
                toggleModal(true, "Carregando dados...", `Buscando dados de ${email}...`);
                
                // Salvar dados atuais se necess√°rio
                if (visualizandoUsuario) {
                    await sincronizarComNuvem();
                }
                
                // Definir usu√°rio sendo visualizado
                visualizandoUsuario = email;
                
                // Carregar dados do usu√°rio
                await carregarDadosUsuario();
                
                // Atualizar interface
                document.getElementById('user-email').innerHTML = `
                    üëÅÔ∏è Visualizando: <strong>${email}</strong>
                    <span class="badge badge-warning" style="margin-left: 10px;">Modo Admin</span>
                `;
                
                // Recarregar p√°gina atual
                const paginaAtual = document.querySelector('.page-content.active').id.replace('-page', '');
                navegarPagina(paginaAtual);
                
                toggleModal(false);
                mostrarToast(`Agora visualizando dados de: ${email}`, 'info');
                
            } catch (erro) {
                console.error('Erro ao navegar para usu√°rio:', erro);
                toggleModal(false);
                mostrarToast('Erro ao carregar dados do usu√°rio', 'error');
            }
        }
        
        /**
         * Volta para conta admin
         */
        async function voltarParaAdmin() {
            if (!isAdmin) return;
            
            try {
                // Fechar modal
                const modal = document.querySelector('.modal-overlay:last-child');
                if (modal) modal.remove();
                
                toggleModal(true, "Voltando...", "Retornando para conta admin...");
                
                // Salvar dados do usu√°rio atual
                await sincronizarComNuvem();
                
                // Limpar visualiza√ß√£o
                visualizandoUsuario = null;
                
                // Carregar dados do admin
                await carregarDadosUsuario();
                
                // Restaurar interface
                document.getElementById('user-email').textContent = currentUser.email;
                
                // Recarregar p√°gina atual
                const paginaAtual = document.querySelector('.page-content.active').id.replace('-page', '');
                navegarPagina(paginaAtual);
                
                toggleModal(false);
                mostrarToast('Voltou para conta admin', 'success');
                
            } catch (erro) {
                console.error('Erro ao voltar para admin:', erro);
                toggleModal(false);
                mostrarToast('Erro ao retornar para conta admin', 'error');
            }
        }
        
        // ====================================
        // EVENT LISTENERS - AUTENTICA√á√ÉO
        // ====================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Bot√£o de login
            const btnLogin = document.getElementById('btn-login');
            if (btnLogin) {
                btnLogin.addEventListener('click', fazerLogin);
            }
            
            // Bot√£o de cadastro
            const btnCadastrar = document.getElementById('btn-cadastrar');
            if (btnCadastrar) {
                btnCadastrar.addEventListener('click', fazerCadastro);
            }
            
            // Bot√£o de logout
            const btnLogout = document.getElementById('btn-logout');
            if (btnLogout) {
                btnLogout.addEventListener('click', fazerLogout);
            }
            
            // Bot√£o de navega√ß√£o admin
            const btnAdminNav = document.getElementById('btn-admin-nav');
            if (btnAdminNav) {
                btnAdminNav.addEventListener('click', abrirNavegacaoUsuarios);
            }

            // Bot√£o de upload for√ßado
            const btnUpload = document.getElementById('btn-upload-firebase');
            if (btnUpload) {
                btnUpload.addEventListener('click', forcarUploadFirebase);
            }
            
            // Bot√£o de download for√ßado
            const btnDownload = document.getElementById('btn-download-firebase');
            if (btnDownload) {
                btnDownload.addEventListener('click', forcarDownloadFirebase);
            }
            
            // Enter no campo de senha
            const senhaInput = document.getElementById('login-senha');
            if (senhaInput) {
                senhaInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        fazerLogin();
                    }
                });
            }
        });
        
        // ====================================
        // MONITORAMENTO DE AUTENTICA√á√ÉO
        // ====================================
        
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // Usu√°rio est√° logado
                await inicializarSistema(user);
            } else {
                // Usu√°rio n√£o est√° logado
                console.log('üîí Nenhum usu√°rio autenticado');
                
                // Esconder info do usu√°rio
                document.getElementById('user-info').classList.add('hidden');

                // Esconder bot√µes de sincroniza√ß√£o
                document.getElementById('btn-upload-firebase').classList.add('hidden');
                document.getElementById('btn-download-firebase').classList.add('hidden');
                document.getElementById('btn-admin-nav').classList.add('hidden');
                
                // Mostrar modal de login
                document.getElementById('login-modal').classList.remove('hidden');
            }
        });
        
        // ====================================
        // SINCRONIZA√á√ÉO AUTOM√ÅTICA
        // ====================================
        
        // Sincronizar a cada 5 minutos
        setInterval(() => {
            if (currentUser) {
                console.log('üîÑ Sincroniza√ß√£o autom√°tica...');
                sincronizarComNuvem();
            }
        }, 5 * 60 * 1000);
        
        // Sincronizar antes de fechar a p√°gina
        window.addEventListener('beforeunload', () => {
            if (currentUser) {
                sincronizarComNuvem();
            }
        });
        
        console.log('‚úÖ Sistema de autentica√ß√£o inicializado');
        // ====================================
        // PARTE 3: GEST√ÉO DE MATERIAIS + ESTOQUE
        // ====================================
        
        /**
         * C√ÅLCULO DE PRE√áO M√âDIO PONDERADO (CORRIGIDO)
         * Retorna o pre√ßo m√©dio POR UNIDADE de medida (por ml, por g, etc)
         */
        function calcularPrecoMedioPonderado(nomeMaterial) {
            // Buscar todos os materiais com mesmo nome (normalizado)
            const materiaisGrupo = materiais.filter(m => 
                normalizarNome(m.nome) === normalizarNome(nomeMaterial) &&
                !m.removed
            );
            
            if (materiaisGrupo.length === 0) return 0;
            
            let somaPrecosPonderados = 0;
            let somaQuantidadeTotal = 0;
            
            materiaisGrupo.forEach(material => {
                if (material.historicoCompras && material.historicoCompras.length > 0) {
                    material.historicoCompras.forEach(compra => {
                        if (!compra.removed) {
                            // Valor total e quantidade desta compra
                            const valorTotal = parseFloat(compra.preco) || 0;
                            const quantidade = parseFloat(compra.quantidade) || 0;
                            
                            if (quantidade > 0) {
                                // Pre√ßo unit√°rio desta compra (por ml, por g, etc)
                                const precoUnitario = valorTotal / quantidade;
                                
                                // Ponderar pelo peso (quantidade)
                                somaPrecosPonderados += precoUnitario * quantidade;
                                somaQuantidadeTotal += quantidade;
                            }
                        }
                    });
                }
            });
            
            if (somaQuantidadeTotal === 0) return 0;
            
            // Retorna o pre√ßo m√©dio POR UNIDADE (ml, g, etc)
            return somaPrecosPonderados / somaQuantidadeTotal;
        }
        
        /**
         * CALCULA ESTOQUE COMPLETO
         * F√≥rmula: Lan√ßamentos - Vendas - Remo√ß√µes
         * Agrupa por NOME (normalizado)
         */
        function calcularEstoqueCompleto() {
            const estoqueCalculado = {};
            
            // 1. PROCESSAR LAN√áAMENTOS (de todos os materiais)
            materiais.forEach(material => {
                if (!material.nome) return;
                
                const nomeNorm = normalizarNome(material.nome);
                
                // Inicializar grupo se n√£o existe
                if (!estoqueCalculado[nomeNorm]) {
                    estoqueCalculado[nomeNorm] = {
                        nome: material.nome,
                        unidadePadrao: material.unidadeMedida || 'un',
                        totalLancado: 0,
                        totalVendido: 0,
                        totalRemovido: 0,
                        disponivel: 0,
                        registros: []
                    };
                }
                
                // Somar lan√ßamentos do hist√≥rico de compras
                if (material.historicoCompras) {
                    material.historicoCompras.forEach(compra => {
                        const quantidade = parseFloat(compra.quantidade) || 0;
                        
                        if (compra.removed) {
                            // Compra removida (erro de lan√ßamento)
                            estoqueCalculado[nomeNorm].totalRemovido += quantidade;
                        } else {
                            // Compra v√°lida
                            estoqueCalculado[nomeNorm].totalLancado += quantidade;
                            estoqueCalculado[nomeNorm].registros.push({
                                tipo: 'lancamento',
                                materialId: material.id,
                                quantidade: quantidade,
                                data: compra.data,
                                preco: compra.preco
                            });
                        }
                    });
                }
            });
            
            // 2. PROCESSAR VENDAS (subtrair do estoque)
            vendas.forEach(venda => {
                if (venda.cancelada || !venda.ingredientesSnapshot) return;
                
                venda.ingredientesSnapshot.forEach(ingrediente => {
                    // Encontrar material pelo ID
                    const material = materiais.find(m => m.id === ingrediente.materialId);
                    if (!material || !material.nome) return;
                    
                    const nomeNorm = normalizarNome(material.nome);
                    
                    if (estoqueCalculado[nomeNorm]) {
                        const quantidade = parseFloat(ingrediente.quantidade) || 0;
                        estoqueCalculado[nomeNorm].totalVendido += quantidade;
                    }
                });
            });
            
            // 3. CALCULAR DISPON√çVEL para cada grupo
            Object.keys(estoqueCalculado).forEach(nomeNorm => {
                const grupo = estoqueCalculado[nomeNorm];
                grupo.disponivel = grupo.totalLancado - grupo.totalVendido - grupo.totalRemovido;
                
                // Garantir que n√£o fique negativo
                if (grupo.disponivel < 0) grupo.disponivel = 0;
            });
            
            // 4. Converter para array
            return Object.values(estoqueCalculado);
        }
        
        /**
         * Busca material por c√≥digo
         */
        function buscarMaterialPorCodigo(codigo) {
            if (!codigo) return null;
            return materiais.find(m => m.codigo === codigo && !m.removed);
        }
        
        /**
         * Busca materiais por nome (normalizado)
         */
        function buscarMateriaisPorNome(nome) {
            if (!nome) return [];
            const nomeNorm = normalizarNome(nome);
            return materiais.filter(m => 
                normalizarNome(m.nome) === nomeNorm && !m.removed
            );
        }
        
        /**
         * ADICIONA OU ATUALIZA MATERIAL
         */
        function adicionarMaterial(dados) {
            try {
                // Valida√ß√µes
                if (!dados.nome) throw new Error('Nome √© obrigat√≥rio');
                if (!dados.preco || dados.preco <= 0) throw new Error('Pre√ßo inv√°lido');
                if (!dados.quantidade || dados.quantidade <= 0) throw new Error('Quantidade inv√°lida');
                
                // Verificar se c√≥digo j√° existe com nome diferente
                if (dados.codigo) {
                    const materialComCodigo = buscarMaterialPorCodigo(dados.codigo);
                    if (materialComCodigo && normalizarNome(materialComCodigo.nome) !== normalizarNome(dados.nome)) {
                        throw new Error(`C√≥digo ${dados.codigo} j√° est√° cadastrado para "${materialComCodigo.nome}"`);
                    }
                }
                
                // Buscar material existente (mesmo c√≥digo ou mesmo nome)
                let materialExistente = null;
                
                if (dados.codigo) {
                    materialExistente = buscarMaterialPorCodigo(dados.codigo);
                }
                
                if (!materialExistente) {
                    const materiaisMesmoNome = buscarMateriaisPorNome(dados.nome);
                    if (materiaisMesmoNome.length > 0) {
                        materialExistente = materiaisMesmoNome[0];
                    }
                }
                
                const agora = new Date().toISOString();
                
                if (materialExistente) {
                    // ATUALIZAR material existente
                    
                    // Adicionar nova compra ao hist√≥rico
                    if (!materialExistente.historicoCompras) {
                        materialExistente.historicoCompras = [];
                    }
                    
                    materialExistente.historicoCompras.push({
                        id: gerarId(),
                        data: dados.dataCompra || agora,
                        preco: parseFloat(dados.preco),
                        quantidade: parseFloat(dados.quantidade),
                        fornecedor: dados.fornecedor || '',
                        notaFiscal: dados.notaFiscal || '',
                        removed: false
                    });
                    
                    // Atualizar informa√ß√µes
                    materialExistente.precoUltimaCompra = parseFloat(dados.preco);
                    materialExistente.dataUltimaCompra = dados.dataCompra || agora;
                    materialExistente.atualizadoEm = agora;
                    
                    // Recalcular pre√ßo m√©dio
                    materialExistente.precoMedio = calcularPrecoMedioPonderado(materialExistente.nome);
                    
                    console.log('‚úÖ Material atualizado:', materialExistente.nome);
                    
                } else {
                    // CRIAR novo material
                    
                    const novoMaterial = {
                        id: gerarId(),
                        codigo: dados.codigo || '',
                        nome: dados.nome,
                        marca: dados.marca || '',
                        
                        unidadeCompra: dados.unidadeCompra || 'un',
                        unidadeMedida: dados.unidadeMedida || 'un',
                        quantidadePorUnidade: parseFloat(dados.quantidadePorUnidade) || 1,
                        
                        precoUltimaCompra: parseFloat(dados.preco),
                        dataUltimaCompra: dados.dataCompra || agora,
                        precoMedio: parseFloat(dados.preco), // Primeiro pre√ßo = m√©dia
                        
                        historicoCompras: [{
                            id: gerarId(),
                            data: dados.dataCompra || agora,
                            preco: parseFloat(dados.preco),
                            quantidade: parseFloat(dados.quantidade),
                            fornecedor: dados.fornecedor || '',
                            notaFiscal: dados.notaFiscal || '',
                            removed: false
                        }],
                        
                        criadoEm: agora,
                        atualizadoEm: agora,
                        criadoPor: getUsuarioAtual(),
                        removed: false
                    };
                    
                    materiais.push(novoMaterial);
                    
                    console.log('‚úÖ Material criado:', novoMaterial.nome);
                }
                
                // Recalcular estoque
                estoque = calcularEstoqueCompleto();
                
                // Salvar
                salvarLocalStorage();
                sincronizarComNuvem();
                
                return true;
                
            } catch (erro) {
                console.error('Erro ao adicionar material:', erro);
                mostrarToast(erro.message, 'error');
                return false;
            }
        }
        
        /**
         * REMOVE MATERIAL (soft delete)
         */
        function removerMaterial(materialId) {
            try {
                const material = materiais.find(m => m.id === materialId);
                if (!material) throw new Error('Material n√£o encontrado');
                
                const confirma = confirm(
                    `Remover material "${material.nome}"?\n\n` +
                    `Isso marcar√° o material como removido.\n` +
                    `O estoque ser√° recalculado.`
                );
                
                if (!confirma) return false;
                
                // Marcar como removido
                material.removed = true;
                material.removidoEm = new Date().toISOString();
                material.removidoPor = getUsuarioAtual();
                
                // Recalcular estoque
                estoque = calcularEstoqueCompleto();
                
                // Salvar
                salvarLocalStorage();
                sincronizarComNuvem();
                
                mostrarToast('Material removido com sucesso!', 'success');
                
                return true;
                
            } catch (erro) {
                console.error('Erro ao remover material:', erro);
                mostrarToast(erro.message, 'error');
                return false;
            }
        }
        
        /**
         * REMOVE COMPRA DO HIST√ìRICO
         */
        function removerCompra(materialId, compraId, motivo) {
            try {
                const material = materiais.find(m => m.id === materialId);
                if (!material) throw new Error('Material n√£o encontrado');
                
                const compra = material.historicoCompras.find(c => c.id === compraId);
                if (!compra) throw new Error('Compra n√£o encontrada');
                
                const confirma = confirm(
                    `Remover compra de ${compra.quantidade} unidades?\n\n` +
                    `Pre√ßo: ${formatarMoeda(compra.preco)}\n` +
                    `Data: ${formatarData(compra.data)}\n\n` +
                    `O estoque ser√° recalculado.`
                );
                
                if (!confirma) return false;
                
                // Marcar compra como removida
                compra.removed = true;
                compra.removidoEm = new Date().toISOString();
                compra.removidoPor = getUsuarioAtual();
                compra.motivoRemocao = motivo || 'N√£o informado';
                
                // Recalcular pre√ßo m√©dio
                material.precoMedio = calcularPrecoMedioPonderado(material.nome);
                
                // Recalcular estoque
                estoque = calcularEstoqueCompleto();
                
                // Salvar
                salvarLocalStorage();
                sincronizarComNuvem();
                
                mostrarToast('Compra removida com sucesso!', 'success');
                
                return true;
                
            } catch (erro) {
                console.error('Erro ao remover compra:', erro);
                mostrarToast(erro.message, 'error');
                return false;
            }
        }
        
        // ====================================
        // INTERFACE - P√ÅGINA DE ESTOQUE
        // ====================================
        
        function carregarPaginaEstoque() {
            const page = document.getElementById('estoque-page');
            if (!page) return;
            
            // Recalcular estoque
            estoque = calcularEstoqueCompleto();
            
            page.innerHTML = `
                <h2>üì¶ Gest√£o de Estoque</h2>
                
                <div class="card">
                    <h3>Itens em Estoque</h3>
                    <p style="color: var(--cor-texto-claro); margin-bottom: 15px;">
                        ‚ÑπÔ∏è O estoque √© calculado automaticamente: <strong>Lan√ßamentos - Vendas - Remo√ß√µes</strong>
                    </p>
                    
                    <input type="text" id="pesquisar-estoque" class="form-control" 
                        placeholder="üîç Pesquisar material..." style="margin-bottom: 20px;">
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Material</th>
                                <th>Estoque (Unidades)</th>
                                <th>Lan√ßado</th>
                                <th>Vendido</th>
                                <th>Removido</th>
                                <th>Dispon√≠vel</th>
                                <th>Pre√ßo M√©dio</th>
                                <th>Valor Total</th>
                            </tr>
                        </thead>
                        <tbody id="lista-estoque">
                            ${estoque.length === 0 ? 
                                '<tr><td colspan="7" style="text-align: center;">Nenhum item no estoque</td></tr>' :
                                estoque.map(item => {
                                    const precoMedio = calcularPrecoMedioPonderado(item.nome);
                                    const valorTotal = item.disponivel * precoMedio;
                                    
                                    return `
                                        <tr>
                                            <td><strong>${item.nome}</strong></td>
                                            <td>${formatarQuantidadeGrande(item.disponivel, item.unidadePadrao)}</td>
                                            <td>${item.totalLancado.toFixed(2)} ${item.unidadePadrao}</td>
                                            <td>${item.totalVendido.toFixed(2)} ${item.unidadePadrao}</td>
                                            <td>${item.totalRemovido.toFixed(2)} ${item.unidadePadrao}</td>
                                            <td>
                                                <strong style="color: ${item.disponivel > 0 ? 'var(--cor-sucesso)' : 'var(--cor-erro)'}">
                                                    ${item.disponivel.toFixed(2)} ${item.unidadePadrao}
                                                </strong>
                                            </td>
                                            <td>${formatarMoeda(precoMedio)}/${item.unidadePadrao}</td>
                                            <td><strong>${formatarMoeda(valorTotal)}</strong></td>
                                        </tr>
                                    `;
                                }).join('')
                            }
                        </tbody>
                    </table>
                    
                    ${estoque.length > 0 ? `
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--cor-borda);">
                            <h4>üí∞ Resumo Financeiro</h4>
                            <p><strong>Valor Total em Estoque:</strong> ${formatarMoeda(
                                estoque.reduce((total, item) => {
                                    const precoMedio = calcularPrecoMedioPonderado(item.nome);
                                    return total + (item.disponivel * precoMedio);
                                }, 0)
                            )}</p>
                        </div>
                    ` : ''}
                </div>
            `;
            
            // Event listener para pesquisa
            const inputPesquisa = document.getElementById('pesquisar-estoque');
            if (inputPesquisa) {
                inputPesquisa.addEventListener('input', function() {
                    const termo = this.value.toLowerCase();
                    const linhas = document.querySelectorAll('#lista-estoque tr');
                    
                    linhas.forEach(linha => {
                        const texto = linha.textContent.toLowerCase();
                        linha.style.display = texto.includes(termo) ? '' : 'none';
                    });
                });
            }
        }
        
        // ====================================
        // INTERFACE - P√ÅGINA DE MATERIAIS
        // ====================================
        
        function carregarPaginaMateriais() {
            const page = document.getElementById('materiais-page');
            if (!page) return;
            
            page.innerHTML = `
                <h2>üè∑Ô∏è Gest√£o de Materiais</h2>
                
                <div class="tab-buttons">
                    <button class="tab-button active" data-tab="listar-materiais">üìã Listar Materiais</button>
                    <button class="tab-button" data-tab="adicionar-material">‚ûï Adicionar Material</button>
                </div>
                
                <!-- TAB: Listar Materiais -->
                <div class="tab-content active" id="tab-listar-materiais">
                    <div class="card">
                        <h3>Materiais Cadastrados</h3>
                        
                        <input type="text" id="pesquisar-materiais" class="form-control" 
                            placeholder="üîç Pesquisar material..." style="margin-bottom: 20px;">
                        
                        <div id="lista-materiais-cards">
                            ${renderizarListaMateriais()}
                        </div>
                    </div>
                </div>
                
                <!-- TAB: Adicionar Material -->
                <div class="tab-content" id="tab-adicionar-material">
                    <div class="card">
                        <h3>Adicionar Material ao Cat√°logo</h3>
                        
                        <form id="form-adicionar-material">
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="codigo-material">C√≥digo de Barras:</label>
                                        <input type="text" id="codigo-material" class="form-control" 
                                            placeholder="Digite ou escaneie o c√≥digo">
                                    </div>
                                </div>
                                <div class="form-col" style="flex: 0.5;">
                                    <div class="form-group">
                                        <label>&nbsp;</label>
                                        <button type="button" id="btn-scanner" class="btn btn-secondary" 
                                            style="width: 100%;">üì∑ Escanear</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="nome-material">Nome do Material: *</label>
                                <input type="text" id="nome-material" class="form-control" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="marca-material">Marca:</label>
                                        <input type="text" id="marca-material" class="form-control">
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="fornecedor-material">Fornecedor:</label>
                                        <input type="text" id="fornecedor-material" class="form-control">
                                    </div>
                                </div>
                            </div>
                            
                            <h4 style="margin-top: 25px; margin-bottom: 15px; color: var(--cor-primaria);">
                                üì¶ Informa√ß√µes da Compra
                            </h4>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="preco-material">Pre√ßo Total: *</label>
                                        <input type="number" id="preco-material" class="form-control" 
                                            min="0.01" step="0.01" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="quantidade-material">Quantidade: *</label>
                                        <input type="number" id="quantidade-material" class="form-control" 
                                            min="0.01" step="0.01" value="1" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="unidade-compra-material">Unidade:</label>
                                        <select id="unidade-compra-material" class="form-control">
                                            <option value="un">Unidade</option>
                                            <option value="kg">Quilograma</option>
                                            <option value="l">Litro</option>
                                            <option value="pct">Pacote</option>
                                            <option value="cx">Caixa</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <h4 style="margin-top: 25px; margin-bottom: 15px; color: var(--cor-primaria);">
                                üìè Como usar nas receitas
                            </h4>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="unidade-medida-material">Unidade de Medida:</label>
                                        <select id="unidade-medida-material" class="form-control">
                                            <option value="g">Gramas (g)</option>
                                            <option value="kg">Quilogramas (kg)</option>
                                            <option value="ml">Mililitros (ml)</option>
                                            <option value="l">Litros (l)</option>
                                            <option value="un">Unidades</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="quantidade-por-unidade-material">Quantidade por Unidade:</label>
                                        <input type="number" id="quantidade-por-unidade-material" 
                                            class="form-control" min="0.01" step="0.01" value="1000" 
                                            placeholder="Ex: 1000 (1kg = 1000g)">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="data-compra-material">Data da Compra:</label>
                                        <input type="date" id="data-compra-material" class="form-control">
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="nota-fiscal-material">Nota Fiscal:</label>
                                        <input type="text" id="nota-fiscal-material" class="form-control" 
                                            placeholder="N√∫mero da NF">
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 25px; display: flex; gap: 10px;">
                                <button type="submit" class="btn btn-primary">üíæ Salvar Material</button>
                                <button type="button" class="btn btn-secondary" 
                                    onclick="document.getElementById('form-adicionar-material').reset()">
                                    üîÑ Limpar
                                </button>
                            </div>
                        </form>
                        
                        <!-- Scanner Container -->
                        <div id="scanner-container" class="hidden" style="margin-top: 30px;">
                            <h4>üì∑ Scanner de C√≥digo de Barras</h4>
                            <div id="reader" style="width: 100%; max-width: 500px; margin: 20px auto;"></div>
                            <button type="button" id="btn-stop-scanner" class="btn btn-danger">
                                ‚èπÔ∏è Parar Scanner
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Configurar tabs
            configurarTabsMateriais();
            
            // Configurar formul√°rio
            configurarFormularioMaterial();
            
            // Configurar scanner
            configurarScanner();
            
            // Configurar pesquisa
            configurarPesquisaMateriais();
            
            // Definir data atual
            const dataInput = document.getElementById('data-compra-material');
            if (dataInput) {
                dataInput.valueAsDate = new Date();
            }
        }
        
        /**
         * Renderiza lista de materiais
         */
        function renderizarListaMateriais() {
            if (materiais.length === 0) {
                return '<p style="text-align: center; color: var(--cor-texto-claro);">Nenhum material cadastrado.</p>';
            }
            
            // Agrupar materiais por nome
            const grupos = {};
            materiais.forEach(m => {
                if (m.removed) return;
                const nomeNorm = normalizarNome(m.nome);
                if (!grupos[nomeNorm]) {
                    grupos[nomeNorm] = [];
                }
                grupos[nomeNorm].push(m);
            });
            
            let html = '';
            
            Object.keys(grupos).forEach(nomeNorm => {
                const grupo = grupos[nomeNorm];
                const primeiro = grupo[0];
                const precoMedio = calcularPrecoMedioPonderado(primeiro.nome);
                
                // Contar compras
                let totalCompras = 0;
                grupo.forEach(m => {
                    if (m.historicoCompras) {
                        totalCompras += m.historicoCompras.filter(c => !c.removed).length;
                    }
                });
                
                html += `
                    <div class="card" style="margin-bottom: 15px; border-left: 4px solid var(--cor-primaria);">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 10px 0;">${primeiro.nome}</h4>
                                ${primeiro.marca ? `<p style="margin: 0; color: var(--cor-texto-claro); font-size: 14px;">Marca: ${primeiro.marca}</p>` : ''}
                            </div>
                            <div style="text-align: right;">
                                <div class="badge badge-info">${primeiro.codigo || 'Sem c√≥digo'}</div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--cor-borda);">
                            <div>
                                <div style="font-size: 12px; color: var(--cor-texto-claro);">Pre√ßo M√©dio</div>
                                <div style="font-size: 18px; font-weight: 600; color: var(--cor-primaria);">
                                    ${formatarMoeda(precoMedio)}/${primeiro.unidadeMedida}
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--cor-texto-claro);">√öltima Compra</div>
                                <div style="font-size: 14px; font-weight: 600;">
                                    ${formatarMoeda(primeiro.precoUltimaCompra)}
                                </div>
                                <div style="font-size: 12px; color: var(--cor-texto-claro);">
                                    ${formatarData(primeiro.dataUltimaCompra)}
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--cor-texto-claro);">Hist√≥rico</div>
                                <div style="font-size: 14px; font-weight: 600;">
                                    ${totalCompras} compra(s)
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; display: flex; gap: 5px; flex-wrap: wrap;">
                            <button class="btn btn-primary btn-sm" onclick="verHistoricoMaterial('${primeiro.nome}')">
                                üìä Ver Hist√≥rico
                            </button>
                            <button class="btn btn-success btn-sm" onclick="adicionarCompraMaterial('${primeiro.nome}')">
                                ‚ûï Nova Compra
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="removerMaterial('${primeiro.id}')">
                                üóëÔ∏è Remover
                            </button>
                        </div>
                    </div>
                `;
            });
            
            return html;
        }
        
        /**
         * Configura tabs de materiais
         */
        function configurarTabsMateriais() {
            const tabButtons = document.querySelectorAll('#materiais-page .tab-button');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remover active de todos
                    tabButtons.forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('#materiais-page .tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Adicionar active no clicado
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    const tabContent = document.getElementById('tab-' + tabId);
                    if (tabContent) {
                        tabContent.classList.add('active');
                    }
                });
            });
        }
        
        /**
         * Configura formul√°rio de material
         */
        function configurarFormularioMaterial() {
            const form = document.getElementById('form-adicionar-material');
            if (!form) return;
            
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const dados = {
                    codigo: document.getElementById('codigo-material').value.trim(),
                    nome: document.getElementById('nome-material').value.trim(),
                    marca: document.getElementById('marca-material').value.trim(),
                    fornecedor: document.getElementById('fornecedor-material').value.trim(),
                    preco: document.getElementById('preco-material').value,
                    quantidade: document.getElementById('quantidade-material').value,
                    unidadeCompra: document.getElementById('unidade-compra-material').value,
                    unidadeMedida: document.getElementById('unidade-medida-material').value,
                    quantidadePorUnidade: document.getElementById('quantidade-por-unidade-material').value,
                    dataCompra: document.getElementById('data-compra-material').value,
                    notaFiscal: document.getElementById('nota-fiscal-material').value.trim()
                };
                
                if (adicionarMaterial(dados)) {
                    form.reset();
                    
                    // Voltar para lista
                    document.querySelector('.tab-button[data-tab="listar-materiais"]').click();
                    
                    // Recarregar lista
                    carregarPaginaMateriais();
                    carregarPaginaEstoque();
                    
                    mostrarToast('Material adicionado com sucesso!', 'success');
                }
            });
            
            // Buscar ao digitar c√≥digo
            const codigoInput = document.getElementById('codigo-material');
            if (codigoInput) {
                codigoInput.addEventListener('blur', function() {
                    const codigo = this.value.trim();
                    if (codigo) {
                        const material = buscarMaterialPorCodigo(codigo);
                        if (material) {
                            // Preencher campos
                            document.getElementById('nome-material').value = material.nome;
                            document.getElementById('marca-material').value = material.marca || '';
                            document.getElementById('unidade-compra-material').value = material.unidadeCompra || 'un';
                            document.getElementById('unidade-medida-material').value = material.unidadeMedida || 'g';
                            document.getElementById('quantidade-por-unidade-material').value = material.quantidadePorUnidade || 1000;
                            
                            mostrarToast('Material encontrado! Preencha apenas pre√ßo e quantidade.', 'info');
                        }
                    }
                });
            }
        }
        
        /**
         * Configura scanner de c√≥digo de barras
         */
        function configurarScanner() {
            const btnScanner = document.getElementById('btn-scanner');
            const btnStop = document.getElementById('btn-stop-scanner');
            const container = document.getElementById('scanner-container');
            
            if (btnScanner) {
                btnScanner.addEventListener('click', function() {
                    container.classList.remove('hidden');
                    iniciarScanner();
                });
            }
            
            if (btnStop) {
                btnStop.addEventListener('click', function() {
                    pararScanner();
                    container.classList.add('hidden');
                });
            }
        }
        
        /**
         * Inicia scanner de c√≥digo de barras
         */
        function iniciarScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                console.log('Scanner j√° est√° ativo');
                return;
            }
            
            html5QrCode = new Html5Qrcode("reader");
            
            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 }
            };
            
            html5QrCode.start(
                { facingMode: "environment" },
                config,
                (decodedText) => {
                    // C√≥digo escaneado com sucesso
                    document.getElementById('codigo-material').value = decodedText;
                    pararScanner();
                    document.getElementById('scanner-container').classList.add('hidden');
                    mostrarToast('C√≥digo escaneado: ' + decodedText, 'success');
                    
                    // Buscar material
                    const material = buscarMaterialPorCodigo(decodedText);
                    if (material) {
                        document.getElementById('nome-material').value = material.nome;
                        document.getElementById('marca-material').value = material.marca || '';
                    }
                },
                (errorMessage) => {
                    // Erro no scan (pode ignorar, √© normal)
                }
            ).catch(err => {
                console.error('Erro ao iniciar scanner:', err);
                mostrarToast('Erro ao acessar c√¢mera', 'error');
            });
        }
        
        /**
         * Para scanner
         */
        function pararScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => {
                    console.log('Scanner parado');
                }).catch(err => {
                    console.error('Erro ao parar scanner:', err);
                });
            }
        }
        
        /**
         * Configura pesquisa de materiais
         */
        function configurarPesquisaMateriais() {
            const inputPesquisa = document.getElementById('pesquisar-materiais');
            if (!inputPesquisa) return;
            
            inputPesquisa.addEventListener('input', function() {
                const termo = this.value.toLowerCase();
                const cards = document.querySelectorAll('#lista-materiais-cards .card');
                
                cards.forEach(card => {
                    const texto = card.textContent.toLowerCase();
                    card.style.display = texto.includes(termo) ? '' : 'none';
                });
            });
        }
        
        /**
         * Ver hist√≥rico de um material
         */
        function verHistoricoMaterial(nomeMaterial) {
            const materiaisGrupo = buscarMateriaisPorNome(nomeMaterial);
            if (materiaisGrupo.length === 0) {
                mostrarToast('Material n√£o encontrado', 'error');
                return;
            }
            
            // Coletar todas as compras
            let todasCompras = [];
            materiaisGrupo.forEach(material => {
                if (material.historicoCompras) {
                    material.historicoCompras.forEach(compra => {
                        todasCompras.push({
                            ...compra,
                            materialId: material.id,
                            materialNome: material.nome
                        });
                    });
                }
            });
            
            // Ordenar por data (mais recente primeiro)
            todasCompras.sort((a, b) => new Date(b.data) - new Date(a.data));
            
            const precoMedio = calcularPrecoMedioPonderado(nomeMaterial);
            
            // Criar modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3>üìä Hist√≥rico: ${nomeMaterial}</h3>
                        <button class="modal-close" onclick="this.parentElement.parentElement.parentElement.remove()">√ó</button>
                    </div>
                    
                    <div class="notification notification-info">
                        <strong>Pre√ßo M√©dio Ponderado:</strong> ${formatarMoeda(precoMedio)}
                        <br>
                        <small>Calculado com base em ${todasCompras.filter(c => !c.removed).length} compra(s)</small>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Qtd</th>
                                <th>Pre√ßo</th>
                                <th>Fornecedor</th>
                                <th>NF</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${todasCompras.map(compra => `
                                <tr style="${compra.removed ? 'opacity: 0.5; text-decoration: line-through;' : ''}">
                                    <td>${formatarData(compra.data)}</td>
                                    <td>${compra.quantidade}</td>
                                    <td>${formatarMoeda(compra.preco)}</td>
                                    <td>${compra.fornecedor || '-'}</td>
                                    <td>${compra.notaFiscal || '-'}</td>
                                    <td>
                                        ${compra.removed ? 
                                            '<span class="badge badge-danger">Removido</span>' : 
                                            '<span class="badge badge-success">Ativo</span>'
                                        }
                                    </td>
                                    <td>
                                        ${!compra.removed ? `
                                            <button class="btn btn-danger btn-sm" 
                                                onclick="removerCompraERecarregar('${compra.materialId}', '${compra.id}')">
                                                üóëÔ∏è
                                            </button>
                                        ` : ''}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">
                            ‚ùå Fechar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        /**
         * Adicionar nova compra a um material existente
         */
        function adicionarCompraMaterial(nomeMaterial) {
            // Ir para aba de adicionar e preencher nome
            document.querySelector('.tab-button[data-tab="adicionar-material"]').click();
            
            setTimeout(() => {
                document.getElementById('nome-material').value = nomeMaterial;
                document.getElementById('nome-material').focus();
                mostrarToast('Preencha os dados da nova compra', 'info');
            }, 100);
        }
        
        /**
         * Remove compra e recarrega p√°gina
         */
        function removerCompraERecarregar(materialId, compraId) {
            const motivo = prompt('Motivo da remo√ß√£o (opcional):') || 'N√£o informado';
            
            if (removerCompra(materialId, compraId, motivo)) {
                // Fechar modal
                const modal = document.querySelector('.modal-overlay:last-child');
                if (modal) modal.remove();
                
                // Recarregar p√°ginas
                carregarPaginaMateriais();
                carregarPaginaEstoque();
            }
        }
        
        console.log('‚úÖ M√≥dulo de Materiais e Estoque carregado');
        // ====================================
        // PARTE 4: GEST√ÉO DE RECEITAS
        // ====================================
        
        /**
         * CALCULA CUSTO DE PRODU√á√ÉO DE UMA RECEITA
         * Os custos s√£o VOL√ÅTEIS (atualizam quando pre√ßo m√©dio muda)
         */
        function calcularCustoReceita(receita) {
            if (!receita.ingredientes || receita.ingredientes.length === 0) {
                return {
                    custoIngredientes: 0,
                    custosVariados: 0,
                    custoTotal: 0,
                    ingredientesDetalhados: []
                };
            }
            
            let custoIngredientes = 0;
            const ingredientesDetalhados = [];
            
            // Calcular custo de cada ingrediente
            receita.ingredientes.forEach(ing => {
                const material = materiais.find(m => m.id === ing.materialId && !m.removed);
                
                if (material) {
                    // Pegar pre√ßo m√©dio ATUAL
                    const precoMedioAtual = calcularPrecoMedioPonderado(material.nome);
                    
                    // Quantidade do ingrediente
                    const quantidade = parseFloat(ing.quantidade) || 0;
                    
                    // Custo deste ingrediente
                    const custoIngrediente = quantidade * precoMedioAtual;
                    
                    custoIngredientes += custoIngrediente;
                    
                    ingredientesDetalhados.push({
                        materialId: ing.materialId,
                        materialNome: material.nome,
                        quantidade: quantidade,
                        unidadeMedida: ing.unidadeMedida,
                        precoMedioAtual: precoMedioAtual,
                        custoIngrediente: custoIngrediente
                    });
                }
            });
            
            // Custos variados (energia, g√°s, etc) - padr√£o 10%
            const percentualCustosVariados = receita.percentualCustosVariados || 0.10;
            const custosVariados = custoIngredientes * percentualCustosVariados;
            
            // Custo total
            const custoTotal = custoIngredientes + custosVariados;
            
            return {
                custoIngredientes: custoIngredientes,
                custosVariados: custosVariados,
                custoTotal: custoTotal,
                ingredientesDetalhados: ingredientesDetalhados
            };
        }
        
        /**
         * CALCULA PRE√áO ESTIMADO COM BASE NO MARKUP
         */
        function calcularPrecoEstimado(custoTotal, markup) {
            const markupFator = parseFloat(markup) || 2.5; // Padr√£o: 150% de lucro
            return custoTotal * markupFator;
        }
        
        /**
         * CALCULA MARGEM DE LUCRO
         */
        function calcularMargemLucro(precoVenda, custoTotal) {
            if (precoVenda <= 0 || custoTotal <= 0) return 0;
            return ((precoVenda - custoTotal) / precoVenda) * 100;
        }
        
        /**
         * VALIDA SE H√Å ESTOQUE SUFICIENTE PARA PRODUZIR RECEITA
         */
        function validarEstoqueReceita(receita, quantidade = 1) {
            const faltando = [];
            
            if (!receita.ingredientes || receita.ingredientes.length === 0) {
                return { valido: false, faltando: ['Receita sem ingredientes'] };
            }
            
            receita.ingredientes.forEach(ing => {
                const material = materiais.find(m => m.id === ing.materialId && !m.removed);
                
                if (!material) {
                    faltando.push(`Material ID ${ing.materialId} n√£o encontrado`);
                    return;
                }
                
                // Buscar estoque do material
                const itemEstoque = estoque.find(e => 
                    normalizarNome(e.nome) === normalizarNome(material.nome)
                );
                
                const quantidadeNecessaria = parseFloat(ing.quantidade) * quantidade;
                const disponivel = itemEstoque ? itemEstoque.disponivel : 0;
                
                if (disponivel < quantidadeNecessaria) {
                    faltando.push(
                        `${material.nome}: necess√°rio ${quantidadeNecessaria.toFixed(2)}${ing.unidadeMedida}, ` +
                        `dispon√≠vel ${disponivel.toFixed(2)}${ing.unidadeMedida}`
                    );
                }
            });
            
            return {
                valido: faltando.length === 0,
                faltando: faltando
            };
        }
        
        /**
         * ADICIONA OU ATUALIZA RECEITA
         */
        function salvarReceita(dados) {
            try {
                // Valida√ß√µes
                if (!dados.nome) throw new Error('Nome da receita √© obrigat√≥rio');
                if (!dados.ingredientes || dados.ingredientes.length === 0) {
                    throw new Error('Adicione pelo menos um ingrediente');
                }
                
                const agora = new Date().toISOString();
                
                if (dados.id) {
                    // ATUALIZAR receita existente
                    const receita = receitas.find(r => r.id === dados.id);
                    if (!receita) throw new Error('Receita n√£o encontrada');
                    
                    receita.nome = dados.nome;
                    receita.descricao = dados.descricao || '';
                    receita.categoria = dados.categoria || 'Geral';
                    receita.ingredientes = dados.ingredientes;
                    receita.percentualCustosVariados = parseFloat(dados.percentualCustosVariados) || 0.10;
                    receita.markupPadrao = parseFloat(dados.markupPadrao) || 2.5;
                    receita.precoVenda = parseFloat(dados.precoVenda) || 0;
                    receita.atualizadaEm = agora;
                    
                    // Recalcular custos
                    const custos = calcularCustoReceita(receita);
                    receita.custoProducao = custos.custoIngredientes;
                    receita.custosVariados = custos.custosVariados;
                    receita.custoTotal = custos.custoTotal;
                    receita.precoEstimado = calcularPrecoEstimado(custos.custoTotal, receita.markupPadrao);
                    receita.margemLucro = calcularMargemLucro(receita.precoVenda, custos.custoTotal);
                    
                    console.log('‚úÖ Receita atualizada:', receita.nome);
                    
                } else {
                    // CRIAR nova receita
                    
                    const novaReceita = {
                        id: gerarId(),
                        nome: dados.nome,
                        descricao: dados.descricao || '',
                        categoria: dados.categoria || 'Geral',
                        ingredientes: dados.ingredientes,
                        
                        percentualCustosVariados: parseFloat(dados.percentualCustosVariados) || 0.10,
                        markupPadrao: parseFloat(dados.markupPadrao) || 2.5,
                        
                        precoVenda: parseFloat(dados.precoVenda) || 0,
                        
                        ativa: true,
                        criadaEm: agora,
                        criadaPor: getUsuarioAtual()
                    };
                    
                    // Calcular custos
                    const custos = calcularCustoReceita(novaReceita);
                    novaReceita.custoProducao = custos.custoIngredientes;
                    novaReceita.custosVariados = custos.custosVariados;
                    novaReceita.custoTotal = custos.custoTotal;
                    novaReceita.precoEstimado = calcularPrecoEstimado(custos.custoTotal, novaReceita.markupPadrao);
                    novaReceita.margemLucro = calcularMargemLucro(novaReceita.precoVenda, custos.custoTotal);
                    
                    receitas.push(novaReceita);
                    
                    console.log('‚úÖ Receita criada:', novaReceita.nome);
                }
                
                // Salvar
                salvarLocalStorage();
                sincronizarComNuvem();
                
                return true;
                
            } catch (erro) {
                console.error('Erro ao salvar receita:', erro);
                mostrarToast(erro.message, 'error');
                return false;
            }
        }
        
        /**
         * REMOVE RECEITA (soft delete)
         */
        function removerReceita(receitaId) {
            try {
                const receita = receitas.find(r => r.id === receitaId);
                if (!receita) throw new Error('Receita n√£o encontrada');
                
                // Verificar se tem vendas usando esta receita
                const vendasComReceita = vendas.filter(v => 
                    v.receitaId === receitaId && !v.cancelada
                );
                
                if (vendasComReceita.length > 0) {
                    throw new Error(
                        `N√£o √© poss√≠vel remover esta receita.\n` +
                        `Existem ${vendasComReceita.length} venda(s) usando esta receita.`
                    );
                }
                
                const confirma = confirm(
                    `Remover receita "${receita.nome}"?\n\n` +
                    `Esta a√ß√£o n√£o pode ser desfeita.`
                );
                
                if (!confirma) return false;
                
                // Marcar como inativa
                receita.ativa = false;
                receita.removidaEm = new Date().toISOString();
                receita.removidaPor = getUsuarioAtual();
                
                // Salvar
                salvarLocalStorage();
                sincronizarComNuvem();
                
                mostrarToast('Receita removida com sucesso!', 'success');
                
                return true;
                
            } catch (erro) {
                console.error('Erro ao remover receita:', erro);
                mostrarToast(erro.message, 'error');
                return false;
            }
        }
        
        /**
         * ATUALIZA CUSTOS DE TODAS AS RECEITAS
         * (Chamado quando pre√ßos de materiais mudam)
         */
        function atualizarCustosReceitas() {
            receitas.forEach(receita => {
                if (receita.ativa) {
                    const custos = calcularCustoReceita(receita);
                    receita.custoProducao = custos.custoIngredientes;
                    receita.custosVariados = custos.custosVariados;
                    receita.custoTotal = custos.custoTotal;
                    receita.precoEstimado = calcularPrecoEstimado(custos.custoTotal, receita.markupPadrao);
                    receita.margemLucro = calcularMargemLucro(receita.precoVenda, custos.custoTotal);
                }
            });
            
            console.log('‚úÖ Custos das receitas atualizados');
        }
        
        // ====================================
        // INTERFACE - P√ÅGINA DE RECEITAS
        // ====================================
        
        function carregarPaginaReceitas() {
            const page = document.getElementById('receitas-page');
            if (!page) return;
            
            // Atualizar custos antes de exibir
            atualizarCustosReceitas();
            
            page.innerHTML = `
                <h2>üç∞ Gest√£o de Receitas</h2>
                
                <div class="tab-buttons">
                    <button class="tab-button active" data-tab="listar-receitas">üìã Listar Receitas</button>
                    <button class="tab-button" data-tab="adicionar-receita">‚ûï Nova Receita</button>
                </div>
                
                <!-- TAB: Listar Receitas -->
                <div class="tab-content active" id="tab-listar-receitas">
                    <div class="card">
                        <h3>Receitas Cadastradas</h3>
                        
                        <input type="text" id="pesquisar-receitas" class="form-control" 
                            placeholder="üîç Pesquisar receita..." style="margin-bottom: 20px;">
                        
                        <div id="lista-receitas-cards">
                            ${renderizarListaReceitas()}
                        </div>
                    </div>
                </div>
                
                <!-- TAB: Adicionar Receita -->
                <div class="tab-content" id="tab-adicionar-receita">
                    <div class="card">
                        <h3 id="titulo-form-receita">‚ûï Nova Receita</h3>
                        
                        <form id="form-receita">
                            <input type="hidden" id="receita-id" value="">
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="receita-nome">Nome da Receita: *</label>
                                        <input type="text" id="receita-nome" class="form-control" 
                                            placeholder="Ex: Bolo de Chocolate" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="receita-categoria">Categoria:</label>
                                        <select id="receita-categoria" class="form-control">
                                            <option value="Bolos">Bolos</option>
                                            <option value="Cupcakes">Cupcakes</option>
                                            <option value="Tortas">Tortas</option>
                                            <option value="Doces">Doces</option>
                                            <option value="Salgados">Salgados</option>
                                            <option value="Outros">Outros</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="receita-descricao">Descri√ß√£o:</label>
                                <textarea id="receita-descricao" class="form-control" rows="2" 
                                    placeholder="Descri√ß√£o opcional da receita"></textarea>
                            </div>
                            
                            <h4 style="margin-top: 30px; margin-bottom: 15px; color: var(--cor-primaria);">
                                ü•Ñ Ingredientes
                            </h4>
                            
                            <div style="background: var(--cor-fundo); padding: 15px; border-radius: var(--borda-radius); margin-bottom: 15px;">
                                <div class="form-row">
                                    <div class="form-col" style="flex: 2;">
                                        <label for="ingrediente-material">Material:</label>
                                        <select id="ingrediente-material" class="form-control">
                                            <option value="">Selecione um material...</option>
                                            ${materiais
                                                .filter(m => !m.removed)
                                                .sort((a, b) => a.nome.localeCompare(b.nome))
                                                .map(m => {
                                                    const precoMedio = calcularPrecoMedioPonderado(m.nome);
                                                    const unidade = m.unidadeMedida || 'un';
                                                    
                                                    return `
                                                        <option value="${m.id}">
                                                            ${m.nome} (${formatarMoeda(precoMedio)}/${unidade})
                                                        </option>
                                                    `;
                                                }).join('')
                                            }
                                        </select>
                                    </div>
                                    <div class="form-col">
                                        <label for="ingrediente-quantidade">Quantidade:</label>
                                        <input type="number" id="ingrediente-quantidade" class="form-control" 
                                            min="0.01" step="0.01" placeholder="0">
                                    </div>
                                    <div class="form-col">
                                        <label for="ingrediente-unidade">Unidade:</label>
                                        <input type="text" id="ingrediente-unidade" class="form-control" 
                                            placeholder="g, ml, un" readonly>
                                    </div>
                                    <div class="form-col" style="flex: 0.5;">
                                        <label>&nbsp;</label>
                                        <button type="button" id="btn-add-ingrediente" class="btn btn-success" 
                                            style="width: 100%;">
                                            ‚ûï
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="lista-ingredientes-receita">
                                <!-- Ingredientes adicionados aparecer√£o aqui -->
                            </div>
                            
                            <h4 style="margin-top: 30px; margin-bottom: 15px; color: var(--cor-primaria);">
                                üí∞ Custos e Precifica√ß√£o
                            </h4>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="receita-custos-variados">
                                            Custos Variados (%):
                                            <small style="color: var(--cor-texto-claro);">
                                                (energia, g√°s, √°gua)
                                            </small>
                                        </label>
                                        <input type="number" id="receita-custos-variados" class="form-control" 
                                            min="0" max="100" step="1" value="10">
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="receita-markup">
                                            Markup:
                                            <small style="color: var(--cor-texto-claro);">
                                                (2.5 = 150% lucro)
                                            </small>
                                        </label>
                                        <input type="number" id="receita-markup" class="form-control" 
                                            min="1" step="0.1" value="2.5">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="receita-preco-venda">Pre√ßo de Venda: *</label>
                                <input type="number" id="receita-preco-venda" class="form-control" 
                                    min="0.01" step="0.01" required>
                            </div>
                            
                            <!-- Resumo de Custos -->
                            <div id="resumo-custos-receita" style="display: none; background: var(--cor-info-claro); 
                                padding: 15px; border-radius: var(--borda-radius); margin-top: 20px;">
                                <h4 style="margin: 0 0 10px 0;">üìä Resumo de Custos</h4>
                                <table style="width: 100%;">
                                    <tr>
                                        <td><strong>Custo Ingredientes:</strong></td>
                                        <td id="resumo-custo-ingredientes" style="text-align: right;">R$ 0,00</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Custos Variados:</strong></td>
                                        <td id="resumo-custos-variados" style="text-align: right;">R$ 0,00</td>
                                    </tr>
                                    <tr style="border-top: 2px solid var(--cor-borda);">
                                        <td><strong>Custo Total:</strong></td>
                                        <td id="resumo-custo-total" style="text-align: right; font-weight: bold;">R$ 0,00</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Pre√ßo Estimado:</strong></td>
                                        <td id="resumo-preco-estimado" style="text-align: right; color: var(--cor-info);">R$ 0,00</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Pre√ßo de Venda:</strong></td>
                                        <td id="resumo-preco-venda" style="text-align: right; font-weight: bold;">R$ 0,00</td>
                                    </tr>
                                    <tr style="border-top: 2px solid var(--cor-borda);">
                                        <td><strong>Margem de Lucro:</strong></td>
                                        <td id="resumo-margem-lucro" style="text-align: right; font-weight: bold; font-size: 18px;">0%</td>
                                    </tr>
                                </table>
                            </div>
                            
                            <div style="margin-top: 25px; display: flex; gap: 10px;">
                                <button type="submit" class="btn btn-primary">üíæ Salvar Receita</button>
                                <button type="button" class="btn btn-secondary" onclick="cancelarEdicaoReceita()">
                                    ‚ùå Cancelar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Configurar tabs
            configurarTabsReceitas();
            
            // Configurar formul√°rio
            configurarFormularioReceita();
            
            // Configurar pesquisa
            configurarPesquisaReceitas();
        }
        
        /**
         * Renderiza lista de receitas
         */
        function renderizarListaReceitas() {
            const receitasAtivas = receitas.filter(r => r.ativa);
            
            if (receitasAtivas.length === 0) {
                return '<p style="text-align: center; color: var(--cor-texto-claro);">Nenhuma receita cadastrada.</p>';
            }
            
            let html = '';
            
            receitasAtivas.forEach(receita => {
                const custos = calcularCustoReceita(receita);
                const margemLucro = calcularMargemLucro(receita.precoVenda, custos.custoTotal);
                const corMargem = margemLucro >= 20 ? 'var(--cor-sucesso)' : 
                                 margemLucro >= 10 ? 'var(--cor-aviso)' : 'var(--cor-erro)';
                
                // Validar estoque
                const validacao = validarEstoqueReceita(receita, 1);
                
                html += `
                    <div class="card" style="margin-bottom: 15px; border-left: 4px solid var(--cor-primaria);">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 5px 0;">${receita.nome}</h4>
                                ${receita.descricao ? `
                                    <p style="margin: 5px 0; color: var(--cor-texto-claro); font-size: 14px;">
                                        ${receita.descricao}
                                    </p>
                                ` : ''}
                                <div style="margin-top: 10px;">
                                    <span class="badge badge-info">${receita.categoria}</span>
                                    ${!validacao.valido ? 
                                        '<span class="badge badge-danger">‚ö†Ô∏è Estoque Insuficiente</span>' : 
                                        '<span class="badge badge-success">‚úì Estoque OK</span>'
                                    }
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 24px; font-weight: bold; color: var(--cor-primaria);">
                                    ${formatarMoeda(receita.precoVenda)}
                                </div>
                                <div style="font-size: 14px; color: ${corMargem}; font-weight: 600;">
                                    Margem: ${margemLucro.toFixed(1)}%
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
                            gap: 15px; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--cor-borda);">
                            <div>
                                <div style="font-size: 12px; color: var(--cor-texto-claro);">Custo Total</div>
                                <div style="font-size: 16px; font-weight: 600;">
                                    ${formatarMoeda(custos.custoTotal)}
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--cor-texto-claro);">Ingredientes</div>
                                <div style="font-size: 16px; font-weight: 600;">
                                    ${formatarMoeda(custos.custoIngredientes)}
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--cor-texto-claro);">Custos Variados</div>
                                <div style="font-size: 16px; font-weight: 600;">
                                    ${formatarMoeda(custos.custosVariados)}
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--cor-texto-claro);">Lucro Unit√°rio</div>
                                <div style="font-size: 16px; font-weight: 600; color: var(--cor-sucesso);">
                                    ${formatarMoeda(receita.precoVenda - custos.custoTotal)}
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; display: flex; gap: 5px; flex-wrap: wrap;">
                            <button class="btn btn-primary btn-sm" onclick="verDetalhesReceita('${receita.id}')">
                                üëÅÔ∏è Ver Detalhes
                            </button>
                            <button class="btn btn-success btn-sm" onclick="editarReceita('${receita.id}')">
                                ‚úèÔ∏è Editar
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="removerReceita('${receita.id}'); carregarPaginaReceitas();">
                                üóëÔ∏è Remover
                            </button>
                        </div>
                    </div>
                `;
            });
            
            return html;
        }
        
        /**
         * Configura tabs de receitas
         */
        function configurarTabsReceitas() {
            const tabButtons = document.querySelectorAll('#receitas-page .tab-button');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remover active de todos
                    tabButtons.forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('#receitas-page .tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Adicionar active no clicado
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    const tabContent = document.getElementById('tab-' + tabId);
                    if (tabContent) {
                        tabContent.classList.add('active');
                    }
                });
            });
        }
        
        /**
         * Configurapesquisa de receitas
         */
        function configurarPesquisaReceitas() {
            const inputPesquisa = document.getElementById('pesquisar-receitas');
            if (!inputPesquisa) return;
            
            inputPesquisa.addEventListener('input', function() {
                const termo = this.value.toLowerCase();
                const cards = document.querySelectorAll('#lista-receitas-cards .card');
                
                cards.forEach(card => {
                    const texto = card.textContent.toLowerCase();
                    card.style.display = texto.includes(termo) ? '' : 'none';
                });
            });
        }
        
        // Array tempor√°rio para ingredientes da receita sendo editada
        let ingredientesTemp = [];
        
        /**
         * Configura formul√°rio de receita
         */
        function configurarFormularioReceita() {
            const form = document.getElementById('form-receita');
            if (!form) return;
            
            // Limpar ingredientes tempor√°rios
            ingredientesTemp = [];
            
            // Bot√£o adicionar ingrediente
            const btnAdd = document.getElementById('btn-add-ingrediente');
            if (btnAdd) {
                btnAdd.addEventListener('click', adicionarIngredienteTemp);
            }
            
            // Ao selecionar material, preencher unidade
            const selectMaterial = document.getElementById('ingrediente-material');
            if (selectMaterial) {
                selectMaterial.addEventListener('change', function() {
                    const materialId = this.value;
                    if (materialId) {
                        const material = materiais.find(m => m.id === materialId);
                        if (material) {
                            document.getElementById('ingrediente-unidade').value = material.unidadeMedida || 'un';
                        }
                    }
                });
            }
            
            // Recalcular custos ao mudar valores
            ['receita-custos-variados', 'receita-markup', 'receita-preco-venda'].forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', atualizarResumoCustos);
                }
            });
            
            // Submit do formul√°rio
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (ingredientesTemp.length === 0) {
                    mostrarToast('Adicione pelo menos um ingrediente', 'warning');
                    return;
                }
                
                const dados = {
                    id: document.getElementById('receita-id').value || null,
                    nome: document.getElementById('receita-nome').value.trim(),
                    categoria: document.getElementById('receita-categoria').value,
                    descricao: document.getElementById('receita-descricao').value.trim(),
                    ingredientes: ingredientesTemp,
                    percentualCustosVariados: parseFloat(document.getElementById('receita-custos-variados').value) / 100,
                    markupPadrao: parseFloat(document.getElementById('receita-markup').value),
                    precoVenda: parseFloat(document.getElementById('receita-preco-venda').value)
                };
                
                if (salvarReceita(dados)) {
                    // Limpar formul√°rio
                    form.reset();
                    ingredientesTemp = [];
                    document.getElementById('receita-id').value = '';
                    document.getElementById('lista-ingredientes-receita').innerHTML = '';
                    document.getElementById('resumo-custos-receita').style.display = 'none';
                    document.getElementById('titulo-form-receita').textContent = '‚ûï Nova Receita';
                    
                    // Voltar para lista
                    document.querySelector('.tab-button[data-tab="listar-receitas"]').click();
                    
                    // Recarregar lista
                    carregarPaginaReceitas();
                    
                    mostrarToast('Receita salva com sucesso!', 'success');
                }
            });
        }
        
        /**
         * Adiciona ingrediente ao array tempor√°rio
         */
        function adicionarIngredienteTemp() {
            const materialId = document.getElementById('ingrediente-material').value;
            const quantidade = parseFloat(document.getElementById('ingrediente-quantidade').value);
            const unidade = document.getElementById('ingrediente-unidade').value;
            
            if (!materialId) {
                mostrarToast('Selecione um material', 'warning');
                return;
            }
            
            if (!quantidade || quantidade <= 0) {
                mostrarToast('Informe uma quantidade v√°lida', 'warning');
                return;
            }
            
            const material = materiais.find(m => m.id === materialId);
            if (!material) {
                mostrarToast('Material n√£o encontrado', 'error');
                return;
            }
            
            // Adicionar ao array
            ingredientesTemp.push({
                materialId: materialId,
                materialNome: material.nome,
                quantidade: quantidade,
                unidadeMedida: unidade
            });
            
            // Limpar campos
            document.getElementById('ingrediente-material').value = '';
            document.getElementById('ingrediente-quantidade').value = '';
            document.getElementById('ingrediente-unidade').value = '';
            
            // Atualizar lista
            renderizarIngredientesTemp();
            
            // Atualizar resumo de custos
            atualizarResumoCustos();
            
            mostrarToast('Ingrediente adicionado!', 'success', 1500);
        }
        
        /**
         * Renderiza lista de ingredientes tempor√°rios
         */
        function renderizarIngredientesTemp() {
            const container = document.getElementById('lista-ingredientes-receita');
            if (!container) return;
            
            if (ingredientesTemp.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--cor-texto-claro); padding: 20px;">Nenhum ingrediente adicionado</p>';
                return;
            }
            
            let html = '<table style="width: 100%; margin-top: 10px;"><thead><tr><th>Ingrediente</th><th>Quantidade</th><th>Pre√ßo M√©dio</th><th>Custo</th><th>A√ß√µes</th></tr></thead><tbody>';
            
            ingredientesTemp.forEach((ing, index) => {
                const precoMedio = calcularPrecoMedioPonderado(ing.materialNome);
                const custo = ing.quantidade * precoMedio;
                
                html += `
                    <tr>
                        <td><strong>${ing.materialNome}</strong></td>
                        <td>${ing.quantidade} ${ing.unidadeMedida}</td>
                        <td>${formatarMoeda(precoMedio)}/${ing.unidadeMedida}</td>
                        <td><strong>${formatarMoeda(custo)}</strong></td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm" onclick="removerIngredienteTemp(${index})">
                                üóëÔ∏è
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        /**
         * Remove ingrediente do array tempor√°rio
         */
        function removerIngredienteTemp(index) {
            ingredientesTemp.splice(index, 1);
            renderizarIngredientesTemp();
            atualizarResumoCustos();
            mostrarToast('Ingrediente removido', 'info', 1500);
        }
        
        /**
         * Atualiza resumo de custos no formul√°rio
         */
        function atualizarResumoCustos() {
            if (ingredientesTemp.length === 0) {
                document.getElementById('resumo-custos-receita').style.display = 'none';
                return;
            }
            
            // Calcular custo dos ingredientes
            let custoIngredientes = 0;
            ingredientesTemp.forEach(ing => {
                const precoMedio = calcularPrecoMedioPonderado(ing.materialNome);
                custoIngredientes += ing.quantidade * precoMedio;
            });
            
            // Custos variados
            const percentualVariados = parseFloat(document.getElementById('receita-custos-variados').value) / 100;
            const custosVariados = custoIngredientes * percentualVariados;
            
            // Custo total
            const custoTotal = custoIngredientes + custosVariados;
            
            // Pre√ßo estimado
            const markup = parseFloat(document.getElementById('receita-markup').value) || 2.5;
            const precoEstimado = custoTotal * markup;
            
            // Pre√ßo de venda
            const precoVenda = parseFloat(document.getElementById('receita-preco-venda').value) || 0;
            
            // Margem de lucro
            const margemLucro = calcularMargemLucro(precoVenda, custoTotal);
            const corMargem = margemLucro >= 20 ? 'var(--cor-sucesso)' : 
                             margemLucro >= 10 ? 'var(--cor-aviso)' : 'var(--cor-erro)';
            
            // Atualizar campos
            document.getElementById('resumo-custo-ingredientes').textContent = formatarMoeda(custoIngredientes);
            document.getElementById('resumo-custos-variados').textContent = formatarMoeda(custosVariados);
            document.getElementById('resumo-custo-total').textContent = formatarMoeda(custoTotal);
            document.getElementById('resumo-preco-estimado').textContent = formatarMoeda(precoEstimado);
            document.getElementById('resumo-preco-venda').textContent = formatarMoeda(precoVenda);
            document.getElementById('resumo-margem-lucro').textContent = margemLucro.toFixed(1) + '%';
            document.getElementById('resumo-margem-lucro').style.color = corMargem;
            
            // Mostrar resumo
            document.getElementById('resumo-custos-receita').style.display = 'block';
            
            // Sugerir pre√ßo se n√£o preenchido
            if (!precoVenda || precoVenda === 0) {
                document.getElementById('receita-preco-venda').value = precoEstimado.toFixed(2);
            }
        }
        
        /**
         * Edita receita existente
         */
        function editarReceita(receitaId) {
            const receita = receitas.find(r => r.id === receitaId);
            if (!receita) {
                mostrarToast('Receita n√£o encontrada', 'error');
                return;
            }
            
            // Ir para aba de adicionar
            document.querySelector('.tab-button[data-tab="adicionar-receita"]').click();
            
            // Aguardar um pouco para garantir que a aba carregou
            setTimeout(() => {
                // Preencher campos
                document.getElementById('receita-id').value = receita.id;
                document.getElementById('receita-nome').value = receita.nome;
                document.getElementById('receita-categoria').value = receita.categoria || 'Geral';
                document.getElementById('receita-descricao').value = receita.descricao || '';
                document.getElementById('receita-custos-variados').value = (receita.percentualCustosVariados * 100) || 10;
                document.getElementById('receita-markup').value = receita.markupPadrao || 2.5;
                document.getElementById('receita-preco-venda').value = receita.precoVenda || 0;
                
                // Copiar ingredientes
                ingredientesTemp = [...receita.ingredientes];
                
                // Renderizar ingredientes
                renderizarIngredientesTemp();
                
                // Atualizar resumo
                atualizarResumoCustos();
                
                // Mudar t√≠tulo
                document.getElementById('titulo-form-receita').textContent = '‚úèÔ∏è Editar Receita';
                
                mostrarToast('Editando receita: ' + receita.nome, 'info');
            }, 100);
        }
        
        /**
         * Cancela edi√ß√£o de receita
         */
        function cancelarEdicaoReceita() {
            const confirma = confirm('Descartar altera√ß√µes?');
            if (!confirma) return;
            
            // Limpar formul√°rio
            document.getElementById('form-receita').reset();
            ingredientesTemp = [];
            document.getElementById('receita-id').value = '';
            document.getElementById('lista-ingredientes-receita').innerHTML = '';
            document.getElementById('resumo-custos-receita').style.display = 'none';
            document.getElementById('titulo-form-receita').textContent = '‚ûï Nova Receita';
            
            // Voltar para lista
            document.querySelector('.tab-button[data-tab="listar-receitas"]').click();
        }
        
        /**
         * Ver detalhes completos da receita
         */
        function verDetalhesReceita(receitaId) {
            const receita = receitas.find(r => r.id === receitaId);
            if (!receita) {
                mostrarToast('Receita n√£o encontrada', 'error');
                return;
            }
            
            const custos = calcularCustoReceita(receita);
            const validacao = validarEstoqueReceita(receita, 1);
            const margemLucro = calcularMargemLucro(receita.precoVenda, custos.custoTotal);
            
            // Criar modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h3>üç∞ ${receita.nome}</h3>
                        <button class="modal-close" onclick="this.parentElement.parentElement.parentElement.remove()">√ó</button>
                    </div>
                    
                    ${receita.descricao ? `
                        <p style="color: var(--cor-texto-claro); margin-bottom: 20px;">
                            ${receita.descricao}
                        </p>
                    ` : ''}
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <span class="badge badge-info">${receita.categoria}</span>
                        ${validacao.valido ? 
                            '<span class="badge badge-success">‚úì Estoque OK</span>' :
                            '<span class="badge badge-danger">‚ö†Ô∏è Estoque Insuficiente</span>'
                        }
                    </div>
                    
                    ${!validacao.valido ? `
                        <div class="notification notification-warning">
                            <strong>‚ö†Ô∏è Itens faltando:</strong><br>
                            ${validacao.faltando.map(item => `‚Ä¢ ${item}`).join('<br>')}
                        </div>
                    ` : ''}
                    
                    <h4 style="margin-top: 25px; margin-bottom: 15px; color: var(--cor-primaria);">
                        ü•Ñ Ingredientes
                    </h4>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Ingrediente</th>
                                <th>Quantidade</th>
                                <th>Pre√ßo M√©dio</th>
                                <th>Custo</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${custos.ingredientesDetalhados.map(ing => `
                                <tr>
                                    <td><strong>${ing.materialNome}</strong></td>
                                    <td>${ing.quantidade.toFixed(2)} ${ing.unidadeMedida}</td>
                                    <td>${formatarMoeda(ing.precoMedioAtual)}/${ing.unidadeMedida}</td>
                                    <td><strong>${formatarMoeda(ing.custoIngrediente)}</strong></td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr style="border-top: 2px solid var(--cor-borda); font-weight: bold;">
                                <td colspan="3">CUSTO INGREDIENTES</td>
                                <td>${formatarMoeda(custos.custoIngredientes)}</td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <h4 style="margin-top: 25px; margin-bottom: 15px; color: var(--cor-primaria);">
                        üí∞ An√°lise Financeira
                    </h4>
                    
                    <table style="font-size: 16px;">
                        <tr>
                            <td><strong>Custo Ingredientes:</strong></td>
                            <td style="text-align: right;">${formatarMoeda(custos.custoIngredientes)}</td>
                        </tr>
                        <tr>
                            <td><strong>Custos Variados (${(receita.percentualCustosVariados * 100).toFixed(0)}%):</strong></td>
                            <td style="text-align: right;">${formatarMoeda(custos.custosVariados)}</td>
                        </tr>
                        <tr style="border-top: 2px solid var(--cor-borda); font-weight: bold;">
                            <td><strong>CUSTO TOTAL:</strong></td>
                            <td style="text-align: right; font-size: 18px;">${formatarMoeda(custos.custoTotal)}</td>
                        </tr>
                        <tr style="border-top: 1px solid var(--cor-borda);">
                            <td><strong>Pre√ßo Estimado (Markup ${receita.markupPadrao}x):</strong></td>
                            <td style="text-align: right; color: var(--cor-info);">${formatarMoeda(receita.precoEstimado)}</td>
                        </tr>
                        <tr>
                            <td><strong>PRE√áO DE VENDA:</strong></td>
                            <td style="text-align: right; font-size: 20px; font-weight: bold; color: var(--cor-primaria);">
                                ${formatarMoeda(receita.precoVenda)}
                            </td>
                        </tr>
                        <tr style="border-top: 2px solid var(--cor-borda);">
                            <td><strong>LUCRO UNIT√ÅRIO:</strong></td>
                            <td style="text-align: right; font-size: 18px; font-weight: bold; color: var(--cor-sucesso);">
                                ${formatarMoeda(receita.precoVenda - custos.custoTotal)}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>MARGEM DE LUCRO:</strong></td>
                            <td style="text-align: right; font-size: 22px; font-weight: bold; 
                                color: ${margemLucro >= 20 ? 'var(--cor-sucesso)' : margemLucro >= 10 ? 'var(--cor-aviso)' : 'var(--cor-erro)'};">
                                ${margemLucro.toFixed(1)}%
                            </td>
                        </tr>
                    </table>
                    
                    ${margemLucro < 15 ? `
                        <div class="notification notification-warning" style="margin-top: 20px;">
                            <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Margem de lucro abaixo de 15%. 
                            Considere aumentar o pre√ßo de venda ou reduzir custos.
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 25px; display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="editarReceita('${receita.id}'); this.parentElement.parentElement.parentElement.remove();">
                            ‚úèÔ∏è Editar Receita
                        </button>
                        <button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">
                            ‚ùå Fechar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        console.log('‚úÖ M√≥dulo de Receitas carregado');
        // ====================================
        // PARTE 5: GEST√ÉO DE VENDAS
        // ====================================
        
        /**
         * GERA N√öMERO DE VENDA SEQUENCIAL
         */
        function gerarNumeroVenda() {
            const ano = new Date().getFullYear();
            const vendasAno = vendas.filter(v => {
                const dataVenda = new Date(v.dataVenda);
                return dataVenda.getFullYear() === ano;
            });
            
            const proximoNumero = vendasAno.length + 1;
            return `VND-${ano}-${String(proximoNumero).padStart(3, '0')}`;
        }
        
        /**
         * REGISTRA NOVA VENDA COM SNAPSHOT DE CUSTOS
         */
        function registrarVenda(dados) {
            try {
                // Valida√ß√µes b√°sicas
                if (!dados.receitaId) throw new Error('Selecione uma receita');
                if (!dados.quantidade || dados.quantidade <= 0) throw new Error('Quantidade inv√°lida');
                if (!dados.cliente || !dados.cliente.nome) throw new Error('Informe o nome do cliente');
                
                const receita = receitas.find(r => r.id === dados.receitaId && r.ativa);
                if (!receita) throw new Error('Receita n√£o encontrada');
                
                const quantidade = parseFloat(dados.quantidade);
                
                // 1. VALIDAR ESTOQUE
                const validacao = validarEstoqueReceita(receita, quantidade);
                if (!validacao.valido) {
                    throw new Error(
                        'Estoque insuficiente:\n\n' + 
                        validacao.faltando.join('\n')
                    );
                }
                
                // 2. CRIAR SNAPSHOT DOS INGREDIENTES (custos congelados)
                const custos = calcularCustoReceita(receita);
                const ingredientesSnapshot = custos.ingredientesDetalhados.map(ing => ({
                    materialId: ing.materialId,
                    materialNome: ing.materialNome,
                    quantidade: ing.quantidade * quantidade, // Multiplicar pela quantidade vendida
                    unidadeMedida: ing.unidadeMedida,
                    precoMedioMomento: ing.precoMedioAtual,
                    custoTotal: ing.custoIngrediente * quantidade
                }));
                
                // 3. CALCULAR CUSTOS TOTAIS (congelados)
                const custoIngredientesTotal = custos.custoIngredientes * quantidade;
                
                // Despesas adicionais
                const frete = parseFloat(dados.frete) || 0;
                const decoracao = parseFloat(dados.decoracao) || 0;
                const despesasAdicionais = frete + decoracao;
                
                // Brindes com acr√©scimo de 10%
                const brindes = parseFloat(dados.brindes) || 0;
                const percentualAcrescimoBrindes = 0.10;
                const brindesComAcrescimo = brindes * (1 + percentualAcrescimoBrindes);
                
                const despesasAdicionaisTotal = despesasAdicionais + brindesComAcrescimo;
                
                // Custo direto
                const custoDiretoTotal = custoIngredientesTotal + despesasAdicionaisTotal;
                
                // Custo indireto (10% sobre ingredientes)
                const percentualCustoIndireto = 0.10;
                const custoIndiretoTotal = custoIngredientesTotal * percentualCustoIndireto;
                
                // Custo total
                const custoTotal = custoDiretoTotal + custoIndiretoTotal;
                
                // 4. CALCULAR RECEITA
                const precoUnitario = parseFloat(dados.precoVenda) || receita.precoVenda;
                const valorTotal = precoUnitario * quantidade;
                
                // 5. CALCULAR LUCRO (l√≥gica simplificada)
                const lucroBruto = valorTotal - custoTotal;
                const margemLucroBruto = (lucroBruto / valorTotal) * 100;
                
                // Destina√ß√£o do lucro (50% reinvestimento, 50% l√≠quido)
                const percentualReinvestimento = 0.50;
                const valorReinvestimento = lucroBruto * percentualReinvestimento;
                const lucroLiquido = lucroBruto * (1 - percentualReinvestimento);
                const margemLiquida = (lucroLiquido / valorTotal) * 100;
                
                const agora = new Date().toISOString();
                
                // 6. CRIAR OBJETO DE VENDA
                const novaVenda = {
                    id: gerarId(),
                    numero: gerarNumeroVenda(),
                    
                    receitaId: receita.id,
                    receitaNome: receita.nome,
                    quantidade: quantidade,
                    
                    // SNAPSHOT - custos congelados
                    ingredientesSnapshot: ingredientesSnapshot,
                    
                    // CUSTOS
                    custoDireto: {
                        ingredientes: custoIngredientesTotal,
                        frete: frete,
                        decoracao: decoracao,
                        despesasAdicionais: despesasAdicionais,
                        brindes: brindes,
                        percentualAcrescimoBrindes: percentualAcrescimoBrindes,
                        brindesComAcrescimo: brindesComAcrescimo,
                        despesasAdicionaisTotal: despesasAdicionaisTotal,
                        total: custoDiretoTotal
                    },
                    
                    custoIndireto: {
                        percentual: percentualCustoIndireto,
                        valor: custoIndiretoTotal,
                        descricao: 'Custos indiretos (energia, g√°s, √°gua)'
                    },
                    
                    custoTotal: custoTotal,
                    
                    // RECEITA
                    precoUnitario: precoUnitario,
                    valorTotal: valorTotal,
                    
                    // LUCRO
                    lucroBruto: lucroBruto,
                    margemLucroBruto: margemLucroBruto,
                    
                    destinacaoLucro: {
                        percentualReinvestimento: percentualReinvestimento,
                        valorReinvestimento: valorReinvestimento,
                        lucroLiquido: lucroLiquido,
                        margemLiquida: margemLiquida
                    },
                    
                    // CLIENTE
                    cliente: {
                        nome: dados.cliente.nome || '',
                        telefone: dados.cliente.telefone || '',
                        endereco: dados.cliente.endereco || '',
                        email: dados.cliente.email || '',
                        cpf: dados.cliente.cpf || ''
                    },
                    
                    // ENTREGA
                    dataVenda: agora,
                    dataEntrega: dados.dataEntrega || agora,
                    horaEntrega: dados.horaEntrega || '',
                    statusEntrega: 'pendente',
                    
                    // PAGAMENTO
                    pagamento: {
                        formaPagamento: dados.formaPagamento || 'Dinheiro',
                        statusPagamento: dados.statusPagamento || 'pendente',
                        valorPago: dados.statusPagamento === 'pago' ? valorTotal : 0,
                        dataPagamento: dados.statusPagamento === 'pago' ? agora : null
                    },
                    
                    observacoes: dados.observacoes || '',
                    observacoesInternas: dados.observacoesInternas || '',
                    
                    // CONTROLE
                    ativa: true,
                    cancelada: false,
                    criadaEm: agora,
                    criadaPor: getUsuarioAtual(),
                    historicoEdicoes: []
                };
                
                // 7. ADICIONAR VENDA
                vendas.push(novaVenda);
                
                // 8. RECALCULAR ESTOQUE (ir√° subtrair automaticamente)
                estoque = calcularEstoqueCompleto();
                
                // 9. SALVAR
                salvarLocalStorage();
                sincronizarComNuvem();
                
                console.log('‚úÖ Venda registrada:', novaVenda.numero);
                
                return novaVenda;
                
            } catch (erro) {
                console.error('Erro ao registrar venda:', erro);
                throw erro;
            }
        }
        
        /**
         * EDITA VENDA EXISTENTE
         */
        function editarVenda(vendaId, novosDados) {
            try {
                const venda = vendas.find(v => v.id === vendaId);
                if (!venda) throw new Error('Venda n√£o encontrada');
                
                if (venda.cancelada) {
                    throw new Error('N√£o √© poss√≠vel editar uma venda cancelada');
                }
                
                // 1. DEVOLVER ESTOQUE DA VENDA ORIGINAL
                // (O estoque ser√° recalculado automaticamente, ent√£o n√£o precisa fazer nada aqui)
                
                // 2. REGISTRAR NO HIST√ìRICO
                venda.historicoEdicoes.push({
                    data: new Date().toISOString(),
                    usuario: getUsuarioAtual(),
                    alteracoes: 'Venda editada',
                    dadosAnteriores: {
                        quantidade: venda.quantidade,
                        precoUnitario: venda.precoUnitario,
                        valorTotal: venda.valorTotal,
                        dataEntrega: venda.dataEntrega,
                        cliente: { ...venda.cliente }
                    }
                });
                
                // 3. ATUALIZAR DADOS PERMITIDOS
                if (novosDados.cliente) {
                    venda.cliente = {
                        ...venda.cliente,
                        ...novosDados.cliente
                    };
                }
                
                if (novosDados.dataEntrega) {
                    venda.dataEntrega = novosDados.dataEntrega;
                }
                
                if (novosDados.horaEntrega) {
                    venda.horaEntrega = novosDados.horaEntrega;
                }
                
                if (novosDados.observacoes !== undefined) {
                    venda.observacoes = novosDados.observacoes;
                }
                
                if (novosDados.observacoesInternas !== undefined) {
                    venda.observacoesInternas = novosDados.observacoesInternas;
                }
                
                if (novosDados.statusEntrega) {
                    venda.statusEntrega = novosDados.statusEntrega;
                    
                    if (novosDados.statusEntrega === 'entregue') {
                        venda.dataEntregaRealizada = new Date().toISOString();
                    }
                }
                
                if (novosDados.statusPagamento) {
                    venda.pagamento.statusPagamento = novosDados.statusPagamento;
                    
                    if (novosDados.statusPagamento === 'pago' && !venda.pagamento.dataPagamento) {
                        venda.pagamento.dataPagamento = new Date().toISOString();
                        venda.pagamento.valorPago = venda.valorTotal;
                    }
                }
                
                venda.atualizadaEm = new Date().toISOString();
                venda.atualizadaPor = getUsuarioAtual();
                
                // 4. RECALCULAR ESTOQUE
                estoque = calcularEstoqueCompleto();
                
                // 5. SALVAR
                salvarLocalStorage();
                sincronizarComNuvem();
                
                console.log('‚úÖ Venda editada:', venda.numero);
                
                return true;
                
            } catch (erro) {
                console.error('Erro ao editar venda:', erro);
                throw erro;
            }
        }
        
        /**
         * CANCELA VENDA (devolve estoque)
         */
        function cancelarVenda(vendaId, motivo) {
            try {
                const venda = vendas.find(v => v.id === vendaId);
                if (!venda) throw new Error('Venda n√£o encontrada');
                
                if (venda.cancelada) {
                    throw new Error('Esta venda j√° foi cancelada');
                }
                
                const confirma = confirm(
                    `Cancelar venda ${venda.numero}?\n\n` +
                    `Cliente: ${venda.cliente.nome}\n` +
                    `Produto: ${venda.quantidade}x ${venda.receitaNome}\n` +
                    `Valor: ${formatarMoeda(venda.valorTotal)}\n\n` +
                    `Os ingredientes ser√£o devolvidos ao estoque.\n` +
                    `Esta a√ß√£o N√ÉO pode ser desfeita.`
                );
                
                if (!confirma) return false;
                
                // Marcar como cancelada
                venda.cancelada = true;
                venda.canceladaEm = new Date().toISOString();
                venda.canceladaPor = getUsuarioAtual();
                venda.motivoCancelamento = motivo || 'N√£o informado';
                
                // Recalcular estoque (ir√° devolver automaticamente)
                estoque = calcularEstoqueCompleto();
                
                // Salvar
                salvarLocalStorage();
                sincronizarComNuvem();
                
                mostrarToast('Venda cancelada e estoque devolvido!', 'success');
                
                console.log('‚úÖ Venda cancelada:', venda.numero);
                
                return true;
                
            } catch (erro) {
                console.error('Erro ao cancelar venda:', erro);
                mostrarToast(erro.message, 'error');
                return false;
            }
        }
        
        /**
         * MARCA VENDA COMO ENTREGUE
         */
        function marcarComoEntregue(vendaId) {
            try {
                return editarVenda(vendaId, { statusEntrega: 'entregue' });
            } catch (erro) {
                mostrarToast(erro.message, 'error');
                return false;
            }
        }
        
        /**
         * CONFIRMA PAGAMENTO
         */
        function confirmarPagamento(vendaId) {
            try {
                return editarVenda(vendaId, { statusPagamento: 'pago' });
            } catch (erro) {
                mostrarToast(erro.message, 'error');
                return false;
            }
        }
        
        // ====================================
        // INTERFACE - P√ÅGINA DE VENDAS
        // ====================================
        
        function carregarPaginaVendas() {
            const page = document.getElementById('vendas-page');
            if (!page) return;
            
            page.innerHTML = `
                <h2>üí∞ Gest√£o de Vendas</h2>
                
                <div class="tab-buttons">
                    <button class="tab-button active" data-tab="listar-vendas">üìã Hist√≥rico</button>
                    <button class="tab-button" data-tab="nova-venda">‚ûï Nova Venda</button>
                    <button class="tab-button" data-tab="resumo-vendas">üìä Resumo</button>
                </div>
                
                <!-- TAB: Listar Vendas -->
                <div class="tab-content active" id="tab-listar-vendas">
                    <div class="card">
                        <h3>Hist√≥rico de Vendas</h3>
                        
                        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                            <input type="text" id="pesquisar-vendas" class="form-control" 
                                placeholder="üîç Pesquisar..." style="flex: 1; min-width: 200px;">
                            
                            <select id="filtro-status-venda" class="form-control" style="flex: 0.5; min-width: 150px;">
                                <option value="">Todos os status</option>
                                <option value="pendente">Pendente</option>
                                <option value="entregue">Entregue</option>
                                <option value="cancelada">Cancelada</option>
                            </select>
                            
                            <select id="filtro-receita-venda" class="form-control" style="flex: 0.5; min-width: 150px;">
                                <option value="">Todas as receitas</option>
                                ${receitas.filter(r => r.ativa).map(r => `
                                    <option value="${r.id}">${r.nome}</option>
                                `).join('')}
                            </select>
                            
                            <button class="btn btn-secondary" onclick="aplicarFiltrosVendas()">
                                üîÑ Filtrar
                            </button>
                        </div>
                        
                        <div id="lista-vendas">
                            ${renderizarListaVendas()}
                        </div>
                    </div>
                </div>
                
                <!-- TAB: Nova Venda -->
                <div class="tab-content" id="tab-nova-venda">
                    <div class="card">
                        <h3>‚ûï Registrar Nova Venda</h3>
                        
                        <form id="form-nova-venda">
                            
                            <h4 style="margin-top: 0; margin-bottom: 15px; color: var(--cor-primaria);">
                                üç∞ Produto
                            </h4>
                            
                            <div class="form-row">
                                <div class="form-col" style="flex: 2;">
                                    <div class="form-group">
                                        <label for="venda-receita">Receita: *</label>
                                        <select id="venda-receita" class="form-control" required>
                                            <option value="">Selecione uma receita...</option>
                                            ${receitas.filter(r => r.ativa).map(r => {
                                                const custos = calcularCustoReceita(r);
                                                return `
                                                    <option value="${r.id}">
                                                        ${r.nome} - ${formatarMoeda(r.precoVenda)} 
                                                        (Custo: ${formatarMoeda(custos.custoTotal)})
                                                    </option>
                                                `;
                                            }).join('')}
                                        </select>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="venda-quantidade">Quantidade: *</label>
                                        <input type="number" id="venda-quantidade" class="form-control" 
                                            min="1" step="1" value="1" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="venda-preco">Pre√ßo Unit.: *</label>
                                        <input type="number" id="venda-preco" class="form-control" 
                                            min="0.01" step="0.01" required readonly>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="alerta-estoque-venda" class="notification notification-warning hidden">
                                ‚ö†Ô∏è <span id="mensagem-estoque-venda"></span>
                            </div>
                            
                            <h4 style="margin-top: 25px; margin-bottom: 15px; color: var(--cor-primaria);">
                                üë§ Cliente
                            </h4>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="venda-cliente-nome">Nome: *</label>
                                        <input type="text" id="venda-cliente-nome" class="form-control" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="venda-cliente-telefone">Telefone:</label>
                                        <input type="tel" id="venda-cliente-telefone" class="form-control" 
                                            placeholder="(00) 00000-0000">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="venda-cliente-endereco">Endere√ßo de Entrega:</label>
                                <input type="text" id="venda-cliente-endereco" class="form-control">
                            </div>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="venda-cliente-email">Email:</label>
                                        <input type="email" id="venda-cliente-email" class="form-control">
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="venda-cliente-cpf">CPF:</label>
                                        <input type="text" id="venda-cliente-cpf" class="form-control" 
                                            placeholder="000.000.000-00">
                                    </div>
                                </div>
                            </div>
                            
                            <h4 style="margin-top: 25px; margin-bottom: 15px; color: var(--cor-primaria);">
                                üìÖ Entrega e Pagamento
                            </h4>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="venda-data-entrega">Data de Entrega: *</label>
                                        <input type="date" id="venda-data-entrega" class="form-control" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="venda-hora-entrega">Hor√°rio:</label>
                                        <input type="time" id="venda-hora-entrega" class="form-control">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="venda-forma-pagamento">Forma de Pagamento:</label>
                                        <select id="venda-forma-pagamento" class="form-control">
                                            <option value="Dinheiro">Dinheiro</option>
                                            <option value="PIX">PIX</option>
                                            <option value="Cart√£o D√©bito">Cart√£o de D√©bito</option>
                                            <option value="Cart√£o Cr√©dito">Cart√£o de Cr√©dito</option>
                                            <option value="Transfer√™ncia">Transfer√™ncia Banc√°ria</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="venda-status-pagamento">Status do Pagamento:</label>
                                        <select id="venda-status-pagamento" class="form-control">
                                            <option value="pendente">Pendente</option>
                                            <option value="pago">Pago</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <h4 style="margin-top: 25px; margin-bottom: 15px; color: var(--cor-primaria);">
                                üíµ Despesas Adicionais
                            </h4>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="venda-frete">Frete:</label>
                                        <input type="number" id="venda-frete" class="form-control" 
                                            min="0" step="0.01" value="0">
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="venda-decoracao">Decora√ß√£o:</label>
                                        <input type="number" id="venda-decoracao" class="form-control" 
                                            min="0" step="0.01" value="0">
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="venda-brindes">Brindes (+10%):</label>
                                        <input type="number" id="venda-brindes" class="form-control" 
                                            min="0" step="0.01" value="0">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="venda-observacoes">Observa√ß√µes do Cliente:</label>
                                <textarea id="venda-observacoes" class="form-control" rows="2" 
                                    placeholder="Ex: Embalagem rosa com la√ßo"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="venda-observacoes-internas">Observa√ß√µes Internas:</label>
                                <textarea id="venda-observacoes-internas" class="form-control" rows="2" 
                                    placeholder="Ex: Cliente √© al√©rgica a nozes"></textarea>
                            </div>
                            
                            <!-- Resumo Financeiro da Venda -->
                            <div id="resumo-financeiro-venda" style="display: none; background: var(--cor-info-claro); 
                                padding: 20px; border-radius: var(--borda-radius); margin-top: 25px;">
                                <h4 style="margin: 0 0 15px 0;">üí∞ Resumo Financeiro</h4>
                                <table style="width: 100%; font-size: 15px;">
                                    <tr>
                                        <td><strong>Valor Total:</strong></td>
                                        <td id="resumo-valor-total-venda" style="text-align: right; font-size: 20px; font-weight: bold;">
                                            R$ 0,00
                                        </td>
                                    </tr>
                                    <tr style="border-top: 1px solid var(--cor-borda);">
                                        <td>Custo Total:</td>
                                        <td id="resumo-custo-total-venda" style="text-align: right;">R$ 0,00</td>
                                    </tr>
                                    <tr>
                                        <td>Lucro Bruto:</td>
                                        <td id="resumo-lucro-bruto-venda" style="text-align: right; color: var(--cor-sucesso);">
                                            R$ 0,00
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Lucro L√≠quido (50%):</td>
                                        <td id="resumo-lucro-liquido-venda" style="text-align: right; font-weight: bold; color: var(--cor-sucesso);">
                                            R$ 0,00
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Margem L√≠quida:</strong></td>
                                        <td id="resumo-margem-venda" style="text-align: right; font-size: 18px; font-weight: bold;">
                                            0%
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            
                            <div style="margin-top: 25px; display: flex; gap: 10px;">
                                <button type="submit" class="btn btn-primary">üíæ Registrar Venda</button>
                                <button type="button" class="btn btn-secondary" onclick="document.getElementById('form-nova-venda').reset()">
                                    üîÑ Limpar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- TAB: Resumo -->
                <div class="tab-content" id="tab-resumo-vendas">
                    <div class="card">
                        <h3>üìä Resumo de Vendas</h3>
                        ${renderizarResumoVendas()}
                    </div>
                </div>
            `;
            
            // Configurar tabs
            configurarTabsVendas();
            
            // Configurar formul√°rio
            configurarFormularioVenda();
            
            // Configurar pesquisa e filtros
            configurarPesquisaVendas();
            
            // Definir data atual
            const dataInput = document.getElementById('venda-data-entrega');
            if (dataInput) {
                dataInput.valueAsDate = new Date();
            }
        }
        
        /**
         * Renderiza lista de vendas
         */
        function renderizarListaVendas() {
            if (vendas.length === 0) {
                return '<p style="text-align: center; color: var(--cor-texto-claro); padding: 40px;">Nenhuma venda registrada.</p>';
            }
            
            // Ordenar por data (mais recente primeiro)
            const vendasOrdenadas = [...vendas].sort((a, b) => 
                new Date(b.dataVenda) - new Date(a.dataVenda)
            );
            
            let html = '';
            
            vendasOrdenadas.forEach(venda => {
                const statusEntregaClass = venda.cancelada ? 'danger' : 
                                          venda.statusEntrega === 'entregue' ? 'success' : 'warning';
                const statusPagClass = venda.pagamento.statusPagamento === 'pago' ? 'success' : 'warning';
                
                const corCard = venda.cancelada ? 'var(--cor-erro)' : 'var(--cor-primaria)';
                
                html += `
                    <div class="card" style="margin-bottom: 15px; border-left: 4px solid ${corCard}; 
                        ${venda.cancelada ? 'opacity: 0.7;' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div>
                                <h4 style="margin: 0 0 5px 0;">
                                    ${venda.numero}
                                    ${venda.cancelada ? ' <span style="color: var(--cor-erro);">üö´ CANCELADA</span>' : ''}
                                </h4>
                                <div style="font-size: 14px; color: var(--cor-texto-claro);">
                                    ${formatarData(venda.dataVenda)} √†s ${new Date(venda.dataVenda).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 24px; font-weight: bold; color: var(--cor-primaria);">
                                    ${formatarMoeda(venda.valorTotal)}
                                </div>
                                <div style="font-size: 13px; color: var(--cor-sucesso); font-weight: 600;">
                                    Lucro: ${formatarMoeda(venda.destinacaoLucro.lucroLiquido)} (${venda.destinacaoLucro.margemLiquida.toFixed(1)}%)
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; 
                            background: var(--cor-fundo); border-radius: var(--borda-radius);">
                            <div>
                                <div style="font-size: 12px; color: var(--cor-texto-claro);">Cliente</div>
                                <div style="font-weight: 600;">üë§ ${venda.cliente.nome}</div>
                                ${venda.cliente.telefone ? `<div style="font-size: 13px;">üìû ${venda.cliente.telefone}</div>` : ''}
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--cor-texto-claro);">Produto</div>
                                <div style="font-weight: 600;">üç∞ ${venda.quantidade}x ${venda.receitaNome}</div>
                                <div style="font-size: 13px; color: var(--cor-texto-claro);">
                                    ${formatarMoeda(venda.precoUnitario)}/un
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--cor-texto-claro);">Entrega</div>
                                <div style="font-weight: 600;">üìÖ ${formatarData(venda.dataEntrega)}</div>
                                ${venda.horaEntrega ? `<div style="font-size: 13px;">üïê ${venda.horaEntrega}</div>` : ''}
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--cor-texto-claro);">Pagamento</div>
                                <div style="font-weight: 600;">üí≥ ${venda.pagamento.formaPagamento}</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                            <span class="badge badge-${statusEntregaClass}">
                                ${venda.cancelada ? 'üö´ Cancelada' : 
                                  venda.statusEntrega === 'entregue' ? '‚úÖ Entregue' : 'üü° Pendente'}
                            </span>
                            <span class="badge badge-${statusPagClass}">
                                ${venda.pagamento.statusPagamento === 'pago' ? 'üí∞ Pago' : '‚è≥ Pagamento Pendente'}
                            </span>
                        </div>
                        
                        <div style="margin-top: 15px; display: flex; gap: 5px; flex-wrap: wrap;">
                            <button class="btn btn-primary btn-sm" onclick="verDetalhesVenda('${venda.id}')">
                                üëÅÔ∏è Ver Detalhes
                            </button>
                            
                            ${!venda.cancelada ? `
                                ${venda.statusEntrega !== 'entregue' ? `
                                    <button class="btn btn-success btn-sm" onclick="marcarComoEntregueERecarregar('${venda.id}')">
                                        ‚úÖ Marcar Entregue
                                    </button>
                                ` : ''}
                                
                                ${venda.pagamento.statusPagamento !== 'pago' ? `
                                    <button class="btn btn-info btn-sm" onclick="confirmarPagamentoERecarregar('${venda.id}')">
                                        üí≥ Confirmar Pagamento
                                    </button>
                                ` : ''}
                                
                                <button class="btn btn-secondary btn-sm" onclick="abrirModalEditarVenda('${venda.id}')">
                                    ‚úèÔ∏è Editar
                                </button>
                                
                                <button class="btn btn-danger btn-sm" onclick="cancelarVendaERecarregar('${venda.id}')">
                                    üóëÔ∏è Cancelar
                                </button>
                            ` : `
                                ${venda.motivoCancelamento ? `
                                    <span style="font-size: 13px; color: var(--cor-texto-claro);">
                                        Motivo: ${venda.motivoCancelamento}
                                    </span>
                                ` : ''}
                            `}
                        </div>
                    </div>
                `;
            });
            
            return html;
        }
        
        /**
         * Renderiza resumo de vendas
         */
        function renderizarResumoVendas() {
            const vendasAtivas = vendas.filter(v => !v.cancelada);
            
            if (vendasAtivas.length === 0) {
                return '<p style="text-align: center; color: var(--cor-texto-claro);">Nenhuma venda para exibir.</p>';
            }
            
            // Calcular totais
            const totalVendas = vendasAtivas.length;
            const faturamentoTotal = vendasAtivas.reduce((sum, v) => sum + v.valorTotal, 0);
            const custoTotal = vendasAtivas.reduce((sum, v) => sum + v.custoTotal, 0);
            const lucroLiquido = vendasAtivas.reduce((sum, v) => sum + v.destinacaoLucro.lucroLiquido, 0);
            const margemMedia = (lucroLiquido / faturamentoTotal) * 100;
            const ticketMedio = faturamentoTotal / totalVendas;
            
            // Vendas por receita
            const vendasPorReceita = {};
            vendasAtivas.forEach(v => {
                if (!vendasPorReceita[v.receitaNome]) {
                    vendasPorReceita[v.receitaNome] = {
                        quantidade: 0,
                        faturamento: 0
                    };
                }
                vendasPorReceita[v.receitaNome].quantidade += v.quantidade;
                vendasPorReceita[v.receitaNome].faturamento += v.valorTotal;
            });
            
            const receitasOrdenadas = Object.entries(vendasPorReceita)
                .sort((a, b) => b[1].faturamento - a[1].faturamento);
            
            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
                    gap: 20px; margin-bottom: 30px;">
                    <div style="background: var(--cor-fundo); padding: 20px; border-radius: var(--borda-radius); 
                        text-align: center;">
                        <div style="font-size: 14px; color: var(--cor-texto-claro); margin-bottom: 5px;">
                            Total de Vendas
                        </div>
                        <div style="font-size: 32px; font-weight: bold; color: var(--cor-primaria);">
                            ${totalVendas}
                        </div>
                    </div>
                    
                    <div style="background: var(--cor-fundo); padding: 20px; border-radius: var(--borda-radius); 
                        text-align: center;">
                        <div style="font-size: 14px; color: var(--cor-texto-claro); margin-bottom: 5px;">
                            Faturamento Total
                        </div>
                        <div style="font-size: 28px; font-weight: bold; color: var(--cor-primaria);">
                            ${formatarMoeda(faturamentoTotal)}
                        </div>
                    </div>
                    
                    <div style="background: var(--cor-fundo); padding: 20px; border-radius: var(--borda-radius); 
                        text-align: center;">
                        <div style="font-size: 14px; color: var(--cor-texto-claro); margin-bottom: 5px;">
                            Lucro L√≠quido
                        </div>
                        <div style="font-size: 28px; font-weight: bold; color: var(--cor-sucesso);">
                            ${formatarMoeda(lucroLiquido)}
                        </div>
                    </div>
                    
                    <div style="background: var(--cor-fundo); padding: 20px; border-radius: var(--borda-radius); 
                        text-align: center;">
                        <div style="font-size: 14px; color: var(--cor-texto-claro); margin-bottom: 5px;">
                            Margem M√©dia
                        </div>
                        <div style="font-size: 28px; font-weight: bold; color: var(--cor-info);">
                            ${margemMedia.toFixed(1)}%
                        </div>
                    </div>
                    
                    <div style="background: var(--cor-fundo); padding: 20px; border-radius: var(--borda-radius); 
                        text-align: center;">
                        <div style="font-size: 14px; color: var(--cor-texto-claro); margin-bottom: 5px;">
                            Ticket M√©dio
                        </div>
                        <div style="font-size: 28px; font-weight: bold; color: var(--cor-info);">
                            ${formatarMoeda(ticketMedio)}
                        </div>
                    </div>
                    
                    <div style="background: var(--cor-fundo); padding: 20px; border-radius: var(--borda-radius); 
                        text-align: center;">
                        <div style="font-size: 14px; color: var(--cor-texto-claro); margin-bottom: 5px;">
                            Custo Total
                        </div>
                        <div style="font-size: 28px; font-weight: bold; color: var(--cor-texto-claro);">
                            ${formatarMoeda(custoTotal)}
                        </div>
                    </div>
                </div>
                
                <h4 style="margin-top: 30px; margin-bottom: 15px;">üèÜ Produtos Mais Vendidos</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Produto</th>
                            <th>Quantidade</th>
                            <th>Faturamento</th>
                            <th>% do Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${receitasOrdenadas.map(([nome, dados]) => `
                            <tr>
                                <td><strong>${nome}</strong></td>
                                <td>${dados.quantidade} unidades</td>
                                <td>${formatarMoeda(dados.faturamento)}</td>
                                <td>${((dados.faturamento / faturamentoTotal) * 100).toFixed(1)}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        /**
         * Configura tabs de vendas
         */
        function configurarTabsVendas() {
            const tabButtons = document.querySelectorAll('#vendas-page .tab-button');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remover active de todos
                    tabButtons.forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('#vendas-page .tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Adicionar active no clicado
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    const tabContent = document.getElementById('tab-' + tabId);
                    if (tabContent) {
                        tabContent.classList.add('active');
                        
                        // Se for aba de resumo, recarregar
                        if (tabId === 'resumo-vendas') {
                            const resumoDiv = tabContent.querySelector('.card');
                            if (resumoDiv) {
                                resumoDiv.innerHTML = '<h3>üìä Resumo de Vendas</h3>' + renderizarResumoVendas();
                            }
                        }
                    }
                });
            });
        }
        
        /**
         * Configura formul√°rio de venda
         */
        function configurarFormularioVenda() {
            const form = document.getElementById('form-nova-venda');
            if (!form) return;
            
            // Ao selecionar receita, preencher pre√ßo e validar estoque
            const selectReceita = document.getElementById('venda-receita');
            if (selectReceita) {
                selectReceita.addEventListener('change', function() {
                    const receitaId = this.value;
                    if (receitaId) {
                        const receita = receitas.find(r => r.id === receitaId);
                        if (receita) {
                            document.getElementById('venda-preco').value = receita.precoVenda.toFixed(2);
                            validarEstoqueVenda();
                            atualizarResumoFinanceiroVenda();
                        }
                    }
                });
            }
            
            // Validar estoque ao mudar quantidade
            const inputQuantidade = document.getElementById('venda-quantidade');
            if (inputQuantidade) {
                inputQuantidade.addEventListener('input', function() {
                    validarEstoqueVenda();
                    atualizarResumoFinanceiroVenda();
                });
            }
            
            // Recalcular ao mudar despesas
            ['venda-preco', 'venda-frete', 'venda-decoracao', 'venda-brindes'].forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', atualizarResumoFinanceiroVenda);
                }
            });
            
            // Submit do formul√°rio
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const receitaId = document.getElementById('venda-receita').value;
                if (!receitaId) {
                    mostrarToast('Selecione uma receita', 'warning');
                    return;
                }
                
                const dados = {
                    receitaId: receitaId,
                    quantidade: parseFloat(document.getElementById('venda-quantidade').value),
                    precoVenda: parseFloat(document.getElementById('venda-preco').value),
                    
                    cliente: {
                        nome: document.getElementById('venda-cliente-nome').value.trim(),
                        telefone: document.getElementById('venda-cliente-telefone').value.trim(),
                        endereco: document.getElementById('venda-cliente-endereco').value.trim(),
                        email: document.getElementById('venda-cliente-email').value.trim(),
                        cpf: document.getElementById('venda-cliente-cpf').value.trim()
                    },
                    
                    dataEntrega: document.getElementById('venda-data-entrega').value,
                    horaEntrega: document.getElementById('venda-hora-entrega').value,
                    formaPagamento: document.getElementById('venda-forma-pagamento').value,
                    statusPagamento: document.getElementById('venda-status-pagamento').value,
                    
                    frete: parseFloat(document.getElementById('venda-frete').value) || 0,
                    decoracao: parseFloat(document.getElementById('venda-decoracao').value) || 0,
                    brindes: parseFloat(document.getElementById('venda-brindes').value) || 0,
                    
                    observacoes: document.getElementById('venda-observacoes').value.trim(),
                    observacoesInternas: document.getElementById('venda-observacoes-internas').value.trim()
                };
                
                try {
                    toggleModal(true, "Registrando venda...", "Processando informa√ß√µes...");
                    
                    const venda = registrarVenda(dados);
                    
                    toggleModal(false);
                    
                    // Limpar formul√°rio
                    form.reset();
                    document.getElementById('resumo-financeiro-venda').style.display = 'none';
                    
                    // Voltar para lista
                    document.querySelector('.tab-button[data-tab="listar-vendas"]').click();
                    
                    // Recarregar p√°ginas
                    carregarPaginaVendas();
                    carregarPaginaEstoque();
                    
                    mostrarToast(`Venda ${venda.numero} registrada com sucesso!`, 'success');
                    
                } catch (erro) {
                    toggleModal(false);
                    mostrarToast(erro.message, 'error');
                }
            });
        }
        
        /**
         * Valida estoque para a venda
         */
        function validarEstoqueVenda() {
            const receitaId = document.getElementById('venda-receita').value;
            const quantidade = parseFloat(document.getElementById('venda-quantidade').value) || 0;
            const alertaDiv = document.getElementById('alerta-estoque-venda');
            const mensagemSpan = document.getElementById('mensagem-estoque-venda');
            
            if (!receitaId || quantidade <= 0) {
                alertaDiv.classList.add('hidden');
                return true;
            }
            
            const receita = receitas.find(r => r.id === receitaId);
            if (!receita) return false;
            
            const validacao = validarEstoqueReceita(receita, quantidade);
            
            if (!validacao.valido) {
                alertaDiv.classList.remove('hidden');
                mensagemSpan.innerHTML = `<strong>Estoque insuficiente:</strong><br>${validacao.faltando.join('<br>')}`;
                return false;
            } else {
                alertaDiv.classList.add('hidden');
                return true;
            }
        }
        
        /**
         * Atualiza resumo financeiro da venda
         */
        function atualizarResumoFinanceiroVenda() {
            const receitaId = document.getElementById('venda-receita').value;
            const quantidade = parseFloat(document.getElementById('venda-quantidade').value) || 0;
            const precoVenda = parseFloat(document.getElementById('venda-preco').value) || 0;
            
            if (!receitaId || quantidade <= 0 || precoVenda <= 0) {
                document.getElementById('resumo-financeiro-venda').style.display = 'none';
                return;
            }
            
            const receita = receitas.find(r => r.id === receitaId);
            if (!receita) return;
            
            // Calcular custos
            const custos = calcularCustoReceita(receita);
            const custoIngredientesTotal = custos.custoIngredientes * quantidade;
            
            const frete = parseFloat(document.getElementById('venda-frete').value) || 0;
            const decoracao = parseFloat(document.getElementById('venda-decoracao').value) || 0;
            const brindes = parseFloat(document.getElementById('venda-brindes').value) || 0;
            const brindesComAcrescimo = brindes * 1.10;
            
            const despesasAdicionaisTotal = frete + decoracao + brindesComAcrescimo;
            const custoDiretoTotal = custoIngredientesTotal + despesasAdicionaisTotal;
            const custoIndiretoTotal = custoIngredientesTotal * 0.10;
            const custoTotal = custoDiretoTotal + custoIndiretoTotal;
            
            const valorTotal = precoVenda * quantidade;
            const lucroBruto = valorTotal - custoTotal;
            const lucroLiquido = lucroBruto * 0.50;
            const margemLiquida = (lucroLiquido / valorTotal) * 100;
            
            const corMargem = margemLiquida >= 15 ? 'var(--cor-sucesso)' : 
                             margemLiquida >= 10 ? 'var(--cor-aviso)' : 'var(--cor-erro)';
            
            // Atualizar campos
            document.getElementById('resumo-valor-total-venda').textContent = formatarMoeda(valorTotal);
            document.getElementById('resumo-custo-total-venda').textContent = formatarMoeda(custoTotal);
            document.getElementById('resumo-lucro-bruto-venda').textContent = formatarMoeda(lucroBruto);
            document.getElementById('resumo-lucro-liquido-venda').textContent = formatarMoeda(lucroLiquido);
            document.getElementById('resumo-margem-venda').textContent = margemLiquida.toFixed(1) + '%';
            document.getElementById('resumo-margem-venda').style.color = corMargem;
            
            // Mostrar resumo
            document.getElementById('resumo-financeiro-venda').style.display = 'block';
        }
        
        /**
         * Configura pesquisa e filtros de vendas
         */
        function configurarPesquisaVendas() {
            const inputPesquisa = document.getElementById('pesquisar-vendas');
            if (inputPesquisa) {
                inputPesquisa.addEventListener('input', aplicarFiltrosVendas);
            }
        }
        
        /**
         * Aplica filtros na lista de vendas
         */
        function aplicarFiltrosVendas() {
            const termo = document.getElementById('pesquisar-vendas').value.toLowerCase();
            const filtroStatus = document.getElementById('filtro-status-venda').value;
            const filtroReceita = document.getElementById('filtro-receita-venda').value;
            
            const cards = document.querySelectorAll('#lista-vendas .card');
            
            cards.forEach(card => {
                const texto = card.textContent.toLowerCase();
                let mostrar = texto.includes(termo);
                
                // Aplicar filtro de status
                if (mostrar && filtroStatus) {
                    if (filtroStatus === 'cancelada') {
                        mostrar = card.innerHTML.includes('CANCELADA');
                    } else if (filtroStatus === 'entregue') {
                        mostrar = card.innerHTML.includes('Entregue') && !card.innerHTML.includes('CANCELADA');
                    } else if (filtroStatus === 'pendente') {
                        mostrar = card.innerHTML.includes('Pendente') && !card.innerHTML.includes('CANCELADA');
                    }
                }
                
                // Aplicar filtro de receita
                if (mostrar && filtroReceita) {
                    const receita = receitas.find(r => r.id === filtroReceita);
                    if (receita) {
                        mostrar = texto.includes(receita.nome.toLowerCase());
                    }
                }
                
                card.style.display = mostrar ? '' : 'none';
            });
        }
        
        /**
         * Ver detalhes completos da venda
         */
        function verDetalhesVenda(vendaId) {
            const venda = vendas.find(v => v.id === vendaId);
            if (!venda) {
                mostrarToast('Venda n√£o encontrada', 'error');
                return;
            }
            
            // Criar modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>üìã Venda ${venda.numero}</h3>
                        <button class="modal-close" onclick="this.parentElement.parentElement.parentElement.remove()">√ó</button>
                    </div>
                    
                    ${venda.cancelada ? `
                        <div class="notification notification-error">
                            <strong>üö´ VENDA CANCELADA</strong><br>
                            Cancelada em: ${formatarData(venda.canceladaEm)}<br>
                            Por: ${venda.canceladaPor}<br>
                            Motivo: ${venda.motivoCancelamento}
                        </div>
                    ` : ''}
                    
                    <h4 style="margin-top: 20px; color: var(--cor-primaria);">üë§ Cliente</h4>
                    <table style="font-size: 15px;">
                        <tr><td><strong>Nome:</strong></td><td>${venda.cliente.nome}</td></tr>
                        ${venda.cliente.telefone ? `<tr><td><strong>Telefone:</strong></td><td>${venda.cliente.telefone}</td></tr>` : ''}
                        ${venda.cliente.email ? `<tr><td><strong>Email:</strong></td><td>${venda.cliente.email}</td></tr>` : ''}
                        ${venda.cliente.cpf ? `<tr><td><strong>CPF:</strong></td><td>${venda.cliente.cpf}</td></tr>` : ''}
                        ${venda.cliente.endereco ? `<tr><td><strong>Endere√ßo:</strong></td><td>${venda.cliente.endereco}</td></tr>` : ''}
                    </table>
                    
                    <h4 style="margin-top: 20px; color: var(--cor-primaria);">üç∞ Produto</h4>
                    <table style="font-size: 15px;">
                        <tr><td><strong>Receita:</strong></td><td>${venda.receitaNome}</td></tr>
                        <tr><td><strong>Quantidade:</strong></td><td>${venda.quantidade} unidade(s)</td></tr>
                        <tr><td><strong>Pre√ßo Unit√°rio:</strong></td><td>${formatarMoeda(venda.precoUnitario)}</td></tr>
                        <tr style="border-top: 2px solid var(--cor-borda);">
                            <td><strong>VALOR TOTAL:</strong></td>
                            <td style="font-size: 20px; font-weight: bold; color: var(--cor-primaria);">
                                ${formatarMoeda(venda.valorTotal)}
                            </td>
                        </tr>
                    </table>
                    
                    <h4 style="margin-top: 20px; color: var(--cor-primaria);">ü•Ñ Ingredientes Utilizados</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Ingrediente</th>
                                <th>Quantidade</th>
                                <th>Pre√ßo M√©dio</th>
                                <th>Custo</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${venda.ingredientesSnapshot.map(ing => `
                                <tr>
                                    <td>${ing.materialNome}</td>
                                    <td>${ing.quantidade.toFixed(2)} ${ing.unidadeMedida}</td>
                                    <td>${formatarMoeda(ing.precoMedioMomento)}/${ing.unidadeMedida}</td>
                                    <td>${formatarMoeda(ing.custoTotal)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <h4 style="margin-top: 20px; color: var(--cor-primaria);">üí∞ An√°lise Financeira Detalhada</h4>
                    <table style="font-size: 15px;">
                        <tr style="background: var(--cor-fundo);">
                            <td colspan="2"><strong>CUSTOS DIRETOS</strong></td>
                        </tr>
                        <tr>
                            <td>Ingredientes:</td>
                            <td style="text-align: right;">${formatarMoeda(venda.custoDireto.ingredientes)}</td>
                        </tr>
                        ${venda.custoDireto.frete > 0 ? `
                            <tr>
                                <td>Frete:</td>
                                <td style="text-align: right;">${formatarMoeda(venda.custoDireto.frete)}</td>
                            </tr>
                        ` : ''}
                        ${venda.custoDireto.decoracao > 0 ? `
                            <tr>
                                <td>Decora√ß√£o:</td>
                                <td style="text-align: right;">${formatarMoeda(venda.custoDireto.decoracao)}</td>
                            </tr>
                        ` : ''}
                        ${venda.custoDireto.brindes > 0 ? `
                            <tr>
                                <td>Brindes (+ 10% acr√©scimo):</td>
                                <td style="text-align: right;">
                                    ${formatarMoeda(venda.custoDireto.brindes)} ‚Üí ${formatarMoeda(venda.custoDireto.brindesComAcrescimo)}
                                </td>
                            </tr>
                        ` : ''}
                        <tr style="font-weight: bold; border-top: 1px solid var(--cor-borda);">
                            <td>SUBTOTAL DIRETO:</td>
                            <td style="text-align: right;">${formatarMoeda(venda.custoDireto.total)}</td>
                        </tr>
                        
                        <tr style="background: var(--cor-fundo);">
                            <td colspan="2"><strong>CUSTOS INDIRETOS</strong></td>
                        </tr>
                        <tr>
                            <td>${venda.custoIndireto.descricao} (${(venda.custoIndireto.percentual * 100).toFixed(0)}%):</td>
                            <td style="text-align: right;">${formatarMoeda(venda.custoIndireto.valor)}</td>
                        </tr>
                        
                        <tr style="font-weight: bold; border-top: 2px solid var(--cor-borda); background: var(--cor-aviso-claro);">
                            <td>CUSTO TOTAL:</td>
                            <td style="text-align: right; font-size: 18px;">${formatarMoeda(venda.custoTotal)}</td>
                        </tr>
                        
                        <tr style="border-top: 2px solid var(--cor-borda);">
                            <td><strong>RECEITA TOTAL:</strong></td>
                            <td style="text-align: right; font-size: 18px;">${formatarMoeda(venda.valorTotal)}</td>
                        </tr>
                        
                        <tr style="background: var(--cor-sucesso-claro);">
                            <td><strong>LUCRO BRUTO:</strong></td>
                            <td style="text-align: right; font-weight: bold; color: var(--cor-sucesso);">
                                ${formatarMoeda(venda.lucroBruto)} (${venda.margemLucroBruto.toFixed(1)}%)
                            </td>
                        </tr>
                        
                        <tr>
                            <td>Reinvestimento (50%):</td>
                            <td style="text-align: right;">${formatarMoeda(venda.destinacaoLucro.valorReinvestimento)}</td>
                        </tr>
                        
                        <tr style="font-weight: bold; background: var(--cor-sucesso-claro); border-top: 2px solid var(--cor-sucesso);">
                            <td><strong>LUCRO L√çQUIDO (50%):</strong></td>
                            <td style="text-align: right; font-size: 20px; color: var(--cor-sucesso);">
                                ${formatarMoeda(venda.destinacaoLucro.lucroLiquido)}
                            </td>
                        </tr>
                        
                        <tr style="border-top: 2px solid var(--cor-borda);">
                            <td><strong>MARGEM L√çQUIDA:</strong></td>
                            <td style="text-align: right; font-size: 22px; font-weight: bold; 
                                color: ${venda.destinacaoLucro.margemLiquida >= 15 ? 'var(--cor-sucesso)' : 
                                        venda.destinacaoLucro.margemLiquida >= 10 ? 'var(--cor-aviso)' : 'var(--cor-erro)'};">
                                ${venda.destinacaoLucro.margemLiquida.toFixed(1)}%
                            </td>
                        </tr>
                    </table>
                    
                    <h4 style="margin-top: 20px; color: var(--cor-primaria);">üìÖ Entrega e Pagamento</h4>
                    <table style="font-size: 15px;">
                        <tr>
                            <td><strong>Data da Venda:</strong></td>
                            <td>${formatarData(venda.dataVenda)} √†s ${new Date(venda.dataVenda).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}</td>
                        </tr>
                        <tr>
                            <td><strong>Data de Entrega:</strong></td>
                            <td>${formatarData(venda.dataEntrega)} ${venda.horaEntrega ? `√†s ${venda.horaEntrega}` : ''}</td>
                        </tr>
                        <tr>
                            <td><strong>Status Entrega:</strong></td>
                            <td>
                                <span class="badge badge-${venda.cancelada ? 'danger' : venda.statusEntrega === 'entregue' ? 'success' : 'warning'}">
                                    ${venda.cancelada ? 'üö´ Cancelada' : venda.statusEntrega === 'entregue' ? '‚úÖ Entregue' : 'üü° Pendente'}
                                </span>
                            </td>
                        </tr>
                        ${venda.statusEntrega === 'entregue' && venda.dataEntregaRealizada ? `
                            <tr>
                                <td><strong>Entregue em:</strong></td>
                                <td>${formatarData(venda.dataEntregaRealizada)}</td>
                            </tr>
                        ` : ''}
                        <tr style="border-top: 1px solid var(--cor-borda);">
                            <td><strong>Forma de Pagamento:</strong></td>
                            <td>${venda.pagamento.formaPagamento}</td>
                        </tr>
                        <tr>
                            <td><strong>Status Pagamento:</strong></td>
                            <td>
                                <span class="badge badge-${venda.pagamento.statusPagamento === 'pago' ? 'success' : 'warning'}">
                                    ${venda.pagamento.statusPagamento === 'pago' ? 'üí∞ Pago' : '‚è≥ Pendente'}
                                </span>
                            </td>
                        </tr>
                        ${venda.pagamento.statusPagamento === 'pago' && venda.pagamento.dataPagamento ? `
                            <tr>
                                <td><strong>Pago em:</strong></td>
                                <td>${formatarData(venda.pagamento.dataPagamento)}</td>
                            </tr>
                        ` : ''}
                    </table>
                    
                    ${venda.observacoes || venda.observacoesInternas ? `
                        <h4 style="margin-top: 20px; color: var(--cor-primaria);">üìù Observa√ß√µes</h4>
                        ${venda.observacoes ? `
                            <div style="background: var(--cor-info-claro); padding: 10px; border-radius: var(--borda-radius); margin-bottom: 10px;">
                                <strong>Cliente:</strong><br>${venda.observacoes}
                            </div>
                        ` : ''}
                        ${venda.observacoesInternas ? `
                            <div style="background: var(--cor-aviso-claro); padding: 10px; border-radius: var(--borda-radius);">
                                <strong>Internas:</strong><br>${venda.observacoesInternas}
                            </div>
                        ` : ''}
                    ` : ''}
                    
                    ${venda.historicoEdicoes && venda.historicoEdicoes.length > 0 ? `
                        <h4 style="margin-top: 20px; color: var(--cor-primaria);">üìú Hist√≥rico de Edi√ß√µes</h4>
                        <table style="font-size: 14px;">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Usu√°rio</th>
                                    <th>Altera√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${venda.historicoEdicoes.map(edit => `
                                    <tr>
                                        <td>${formatarData(edit.data)}</td>
                                        <td>${edit.usuario}</td>
                                        <td>${edit.alteracoes}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : ''}
                    
                    <div style="margin-top: 25px; display: flex; gap: 10px; flex-wrap: wrap;">
                        ${!venda.cancelada ? `
                            <button class="btn btn-secondary" onclick="abrirModalEditarVenda('${venda.id}'); this.parentElement.parentElement.parentElement.remove();">
                                ‚úèÔ∏è Editar Venda
                            </button>
                            <button class="btn btn-danger" onclick="cancelarVendaERecarregar('${venda.id}'); this.parentElement.parentElement.parentElement.remove();">
                                üóëÔ∏è Cancelar Venda
                            </button>
                        ` : ''}
                        <button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">
                            ‚ùå Fechar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        /**
         * Abre modal para editar venda
         */
        function abrirModalEditarVenda(vendaId) {
            const venda = vendas.find(v => v.id === vendaId);
            if (!venda) {
                mostrarToast('Venda n√£o encontrada', 'error');
                return;
            }
            
            if (venda.cancelada) {
                mostrarToast('N√£o √© poss√≠vel editar uma venda cancelada', 'error');
                return;
            }
            
            // Criar modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h3>‚úèÔ∏è Editar Venda ${venda.numero}</h3>
                        <button class="modal-close" onclick="this.parentElement.parentElement.parentElement.remove()">√ó</button>
                    </div>
                    
                    <div class="notification notification-warning">
                        ‚ö†Ô∏è <strong>Aten√ß√£o:</strong> Voc√™ pode editar apenas informa√ß√µes do cliente, datas e status. 
                        Produtos e valores n√£o podem ser alterados ap√≥s a venda.
                    </div>
                    
                    <form id="form-editar-venda">
                        <h4 style="margin-top: 20px; color: var(--cor-primaria);">üë§ Cliente</h4>
                        
                        <div class="form-group">
                            <label>Nome: *</label>
                            <input type="text" id="edit-cliente-nome" class="form-control" 
                                value="${venda.cliente.nome}" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label>Telefone:</label>
                                    <input type="tel" id="edit-cliente-telefone" class="form-control" 
                                        value="${venda.cliente.telefone || ''}">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label>Email:</label>
                                    <input type="email" id="edit-cliente-email" class="form-control" 
                                        value="${venda.cliente.email || ''}">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Endere√ßo:</label>
                            <input type="text" id="edit-cliente-endereco" class="form-control" 
                                value="${venda.cliente.endereco || ''}">
                        </div>
                        
                        <h4 style="margin-top: 20px; color: var(--cor-primaria);">üìÖ Entrega</h4>
                        
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label>Data de Entrega: *</label>
                                    <input type="date" id="edit-data-entrega" class="form-control" 
                                        value="${venda.dataEntrega ? venda.dataEntrega.split('T')[0] : ''}" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label>Hor√°rio:</label>
                                    <input type="time" id="edit-hora-entrega" class="form-control" 
                                        value="${venda.horaEntrega || ''}">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Status da Entrega:</label>
                            <select id="edit-status-entrega" class="form-control">
                                <option value="pendente" ${venda.statusEntrega === 'pendente' ? 'selected' : ''}>Pendente</option>
                                <option value="entregue" ${venda.statusEntrega === 'entregue' ? 'selected' : ''}>Entregue</option>
                            </select>
                        </div>
                        
                        <h4 style="margin-top: 20px; color: var(--cor-primaria);">üí≥ Pagamento</h4>
                        
                        <div class="form-group">
                            <label>Status do Pagamento:</label>
                            <select id="edit-status-pagamento" class="form-control">
                                <option value="pendente" ${venda.pagamento.statusPagamento === 'pendente' ? 'selected' : ''}>Pendente</option>
                                <option value="pago" ${venda.pagamento.statusPagamento === 'pago' ? 'selected' : ''}>Pago</option>
                            </select>
                        </div>
                        
                        <h4 style="margin-top: 20px; color: var(--cor-primaria);">üìù Observa√ß√µes</h4>
                        
                        <div class="form-group">
                            <label>Observa√ß√µes do Cliente:</label>
                            <textarea id="edit-observacoes" class="form-control" rows="2">${venda.observacoes || ''}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Observa√ß√µes Internas:</label>
                            <textarea id="edit-observacoes-internas" class="form-control" rows="2">${venda.observacoesInternas || ''}</textarea>
                        </div>
                        
                        <div style="margin-top: 25px; display: flex; gap: 10px;">
                            <button type="submit" class="btn btn-primary">üíæ Salvar Altera√ß√µes</button>
                            <button type="button" class="btn btn-secondary" 
                                onclick="this.parentElement.parentElement.parentElement.parentElement.remove()">
                                ‚ùå Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Configurar submit
            const form = document.getElementById('form-editar-venda');
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                try {
                    const novosDados = {
                        cliente: {
                            nome: document.getElementById('edit-cliente-nome').value.trim(),
                            telefone: document.getElementById('edit-cliente-telefone').value.trim(),
                            email: document.getElementById('edit-cliente-email').value.trim(),
                            endereco: document.getElementById('edit-cliente-endereco').value.trim()
                        },
                        dataEntrega: document.getElementById('edit-data-entrega').value,
                        horaEntrega: document.getElementById('edit-hora-entrega').value,
                        statusEntrega: document.getElementById('edit-status-entrega').value,
                        statusPagamento: document.getElementById('edit-status-pagamento').value,
                        observacoes: document.getElementById('edit-observacoes').value.trim(),
                        observacoesInternas: document.getElementById('edit-observacoes-internas').value.trim()
                    };
                    
                    if (editarVenda(vendaId, novosDados)) {
                        // Fechar modal
                        modal.remove();
                        
                        // Recarregar p√°gina
                        carregarPaginaVendas();
                        
                        mostrarToast('Venda atualizada com sucesso!', 'success');
                    }
                    
                } catch (erro) {
                    mostrarToast(erro.message, 'error');
                }
            });
        }
        
        /**
         * Fun√ß√µes auxiliares para recarregar ap√≥s a√ß√µes
         */
        function marcarComoEntregueERecarregar(vendaId) {
            if (marcarComoEntregue(vendaId)) {
                carregarPaginaVendas();
                mostrarToast('Venda marcada como entregue!', 'success');
            }
        }
        
        function confirmarPagamentoERecarregar(vendaId) {
            if (confirmarPagamento(vendaId)) {
                carregarPaginaVendas();
                mostrarToast('Pagamento confirmado!', 'success');
            }
        }
        
        function cancelarVendaERecarregar(vendaId) {
            const motivo = prompt('Informe o motivo do cancelamento (opcional):');
            if (motivo !== null) { // null = cancelou o prompt
                if (cancelarVenda(vendaId, motivo || 'N√£o informado')) {
                    carregarPaginaVendas();
                    carregarPaginaEstoque();
                }
            }
        }
        
        console.log('‚úÖ M√≥dulo de Vendas carregado');
        // ====================================
        // PARTE 6: CALEND√ÅRIO DE ENTREGAS
        // ====================================
        
        let mesAtualCalendario = new Date().getMonth();
        let anoAtualCalendario = new Date().getFullYear();
        let diaSelecionado = null;
        
        /**
         * Retorna nome do m√™s
         */
        function getNomeMes(mes) {
            const meses = [
                'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];
            return meses[mes];
        }
        
        /**
         * Retorna nome do dia da semana
         */
        function getNomeDiaSemana(dia) {
            const dias = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            return dias[dia];
        }
        
        /**
         * Busca entregas de um dia espec√≠fico
         */
        function getEntregasDoDia(ano, mes, dia) {
            return vendas.filter(v => {
                if (v.cancelada) return false;
                
                const dataEntrega = new Date(v.dataEntrega);
                return dataEntrega.getFullYear() === ano &&
                       dataEntrega.getMonth() === mes &&
                       dataEntrega.getDate() === dia;
            }).sort((a, b) => {
                // Ordenar por hor√°rio
                if (a.horaEntrega && b.horaEntrega) {
                    return a.horaEntrega.localeCompare(b.horaEntrega);
                }
                return 0;
            });
        }
        
        /**
         * Conta entregas do m√™s
         */
        function getEntregasDoMes(ano, mes) {
            return vendas.filter(v => {
                if (v.cancelada) return false;
                
                const dataEntrega = new Date(v.dataEntrega);
                return dataEntrega.getFullYear() === ano &&
                       dataEntrega.getMonth() === mes;
            });
        }
        
        /**
         * Retorna emoji do produto
         */
        function getEmojiProduto(receitaNome) {
            const nome = receitaNome.toLowerCase();
            if (nome.includes('bolo')) return 'üéÇ';
            if (nome.includes('cupcake')) return 'üßÅ';
            if (nome.includes('torta')) return 'üç∞';
            if (nome.includes('doce')) return 'üç¨';
            if (nome.includes('brigadeiro')) return 'üç´';
            return 'üç∞';
        }
        
        // ====================================
        // INTERFACE - P√ÅGINA DO CALEND√ÅRIO
        // ====================================
        
        function carregarPaginaCalendario() {
            const page = document.getElementById('calendario-page');
            if (!page) return;
            
            page.innerHTML = `
                <h2>üìÖ Calend√°rio de Entregas</h2>
                
                <div class="card">
                    <!-- Controles do Calend√°rio -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <button class="btn btn-secondary" onclick="navegarMesCalendario(-1)">
                            ‚óÄ ${getNomeMes((mesAtualCalendario - 1 + 12) % 12)}
                        </button>
                        
                        <h3 style="margin: 0;">${getNomeMes(mesAtualCalendario)} ${anoAtualCalendario}</h3>
                        
                        <button class="btn btn-secondary" onclick="navegarMesCalendario(1)">
                            ${getNomeMes((mesAtualCalendario + 1) % 12)} ‚ñ∂
                        </button>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="btn btn-info btn-sm" onclick="irParaHoje()">
                            üìç Hoje
                        </button>
                        <span class="badge badge-info">üéÇ Bolos</span>
                        <span class="badge badge-info">üßÅ Cupcakes</span>
                        <span class="badge badge-info">üç∞ Tortas</span>
                        <span style="flex: 1;"></span>
                        <span class="badge badge-success">‚úÖ Entregue</span>
                        <span class="badge badge-warning">üü° Pendente</span>
                    </div>
                    
                    <!-- Grid do Calend√°rio -->
                    <div id="calendario-grid">
                        ${renderizarCalendario()}
                    </div>
                </div>
                
                <!-- Entregas do Dia Selecionado -->
                <div class="card" id="entregas-dia-card" style="display: none;">
                    <h3 id="titulo-entregas-dia">Entregas do Dia</h3>
                    <div id="lista-entregas-dia"></div>
                </div>
                
                <!-- Resumo do M√™s -->
                <div class="card">
                    <h3>üìä Resumo do M√™s</h3>
                    <div id="resumo-mes-calendario">
                        ${renderizarResumoMes()}
                    </div>
                </div>
            `;
        }
        
        /**
         * Renderiza o calend√°rio
         */
        function renderizarCalendario() {
            const primeiroDia = new Date(anoAtualCalendario, mesAtualCalendario, 1);
            const ultimoDia = new Date(anoAtualCalendario, mesAtualCalendario + 1, 0);
            const diasNoMes = ultimoDia.getDate();
            const diaSemanaInicio = primeiroDia.getDay(); // 0 = Domingo
            
            const hoje = new Date();
            const ehMesAtual = hoje.getMonth() === mesAtualCalendario && 
                              hoje.getFullYear() === anoAtualCalendario;
            const diaHoje = ehMesAtual ? hoje.getDate() : -1;
            
            let html = `
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px;">
                    <!-- Cabe√ßalho com dias da semana -->
                    ${['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'].map(dia => `
                        <div style="text-align: center; font-weight: bold; padding: 10px; 
                            background: var(--cor-fundo); border-radius: var(--borda-radius-sm);">
                            ${dia}
                        </div>
                    `).join('')}
            `;
            
            // Espa√ßos em branco antes do primeiro dia
            for (let i = 0; i < diaSemanaInicio; i++) {
                html += '<div style="aspect-ratio: 1; border: 1px solid transparent;"></div>';
            }
            
            // Dias do m√™s
            for (let dia = 1; dia <= diasNoMes; dia++) {
                const entregas = getEntregasDoDia(anoAtualCalendario, mesAtualCalendario, dia);
                const temEntregas = entregas.length > 0;
                
                // Contar por tipo
                const contagemPorProduto = {};
                entregas.forEach(venda => {
                    const emoji = getEmojiProduto(venda.receitaNome);
                    contagemPorProduto[emoji] = (contagemPorProduto[emoji] || 0) + 1;
                });
                
                // Verificar se todas foram entregues
                const todasEntregues = entregas.every(v => v.statusEntrega === 'entregue');
                const ehHoje = dia === diaHoje;
                const ehSelecionado = diaSelecionado === dia;
                
                let corFundo = 'var(--cor-branco)';
                let corBorda = 'var(--cor-borda)';
                
                if (ehHoje) {
                    corFundo = 'var(--cor-secundaria-clara)';
                    corBorda = 'var(--cor-primaria)';
                }
                
                if (temEntregas) {
                    if (todasEntregues) {
                        corFundo = 'var(--cor-sucesso-claro)';
                        corBorda = 'var(--cor-sucesso)';
                    } else {
                        corFundo = 'var(--cor-aviso-claro)';
                        corBorda = 'var(--cor-aviso)';
                    }
                }
                
                if (ehSelecionado) {
                    corBorda = 'var(--cor-primaria)';
                }
                
                html += `
                    <div class="calendar-day ${temEntregas ? 'has-delivery' : ''} ${ehSelecionado ? 'selected' : ''}" 
                        style="aspect-ratio: 1; border: 2px solid ${corBorda}; 
                            background: ${corFundo}; border-radius: var(--borda-radius-sm); 
                            padding: 5px; cursor: pointer; transition: var(--transicao-rapida);
                            display: flex; flex-direction: column; position: relative;"
                        onclick="selecionarDia(${dia})"
                        onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='var(--sombra-media)';"
                        onmouseout="this.style.transform=''; this.style.boxShadow='';">
                        
                        <div style="font-weight: ${ehHoje ? 'bold' : '600'}; 
                            color: ${ehHoje ? 'var(--cor-primaria)' : 'var(--cor-texto)'}; 
                            font-size: ${ehHoje ? '18px' : '16px'};">
                            ${dia}
                            ${ehHoje ? ' üìç' : ''}
                        </div>
                        
                        ${temEntregas ? `
                            <div style="flex: 1; display: flex; flex-direction: column; 
                                justify-content: center; align-items: center; gap: 2px; margin-top: 5px;">
                                ${Object.entries(contagemPorProduto).slice(0, 3).map(([emoji, qtd]) => `
                                    <div style="font-size: 14px; white-space: nowrap;">
                                        ${emoji}${qtd > 1 ? `√ó${qtd}` : ''}
                                    </div>
                                `).join('')}
                                ${Object.keys(contagemPorProduto).length > 3 ? `
                                    <div style="font-size: 11px; color: var(--cor-texto-claro);">
                                        +${Object.keys(contagemPorProduto).length - 3}
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div style="font-size: 10px; text-align: center; margin-top: auto; font-weight: 600;
                                color: ${todasEntregues ? 'var(--cor-sucesso)' : 'var(--cor-aviso)'};">
                                ${todasEntregues ? '‚úÖ' : 'üü°'}
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            html += '</div>';
            
            return html;
        }
        
        /**
         * Renderiza resumo do m√™s
         */
        function renderizarResumoMes() {
            const entregasMes = getEntregasDoMes(anoAtualCalendario, mesAtualCalendario);
            
            if (entregasMes.length === 0) {
                return '<p style="text-align: center; color: var(--cor-texto-claro);">Nenhuma entrega agendada para este m√™s.</p>';
            }
            
            const totalEntregas = entregasMes.length;
            const entregasConcluidas = entregasMes.filter(v => v.statusEntrega === 'entregue').length;
            const entregasPendentes = totalEntregas - entregasConcluidas;
            const faturamentoMes = entregasMes.reduce((sum, v) => sum + v.valorTotal, 0);
            const lucroMes = entregasMes.reduce((sum, v) => sum + v.destinacaoLucro.lucroLiquido, 0);
            
            // Agrupar por receita
            const porReceita = {};
            entregasMes.forEach(v => {
                if (!porReceita[v.receitaNome]) {
                    porReceita[v.receitaNome] = {
                        quantidade: 0,
                        faturamento: 0,
                        emoji: getEmojiProduto(v.receitaNome)
                    };
                }
                porReceita[v.receitaNome].quantidade += v.quantidade;
                porReceita[v.receitaNome].faturamento += v.valorTotal;
            });
            
            const receitasOrdenadas = Object.entries(porReceita)
                .sort((a, b) => b[1].quantidade - a[1].quantidade);
            
            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
                    gap: 15px; margin-bottom: 20px;">
                    <div style="background: var(--cor-fundo); padding: 15px; border-radius: var(--borda-radius); text-align: center;">
                        <div style="font-size: 12px; color: var(--cor-texto-claro);">Total</div>
                        <div style="font-size: 28px; font-weight: bold; color: var(--cor-primaria);">${totalEntregas}</div>
                        <div style="font-size: 12px;">entregas</div>
                    </div>
                    
                    <div style="background: var(--cor-sucesso-claro); padding: 15px; border-radius: var(--borda-radius); text-align: center;">
                        <div style="font-size: 12px; color: var(--cor-texto-claro);">Conclu√≠das</div>
                        <div style="font-size: 28px; font-weight: bold; color: var(--cor-sucesso);">${entregasConcluidas}</div>
                        <div style="font-size: 12px;">${((entregasConcluidas / totalEntregas) * 100).toFixed(0)}%</div>
                    </div>
                    
                    <div style="background: var(--cor-aviso-claro); padding: 15px; border-radius: var(--borda-radius); text-align: center;">
                        <div style="font-size: 12px; color: var(--cor-texto-claro);">Pendentes</div>
                        <div style="font-size: 28px; font-weight: bold; color: var(--cor-aviso);">${entregasPendentes}</div>
                        <div style="font-size: 12px;">${((entregasPendentes / totalEntregas) * 100).toFixed(0)}%</div>
                    </div>
                    
                    <div style="background: var(--cor-fundo); padding: 15px; border-radius: var(--borda-radius); text-align: center;">
                        <div style="font-size: 12px; color: var(--cor-texto-claro);">Faturamento</div>
                        <div style="font-size: 20px; font-weight: bold; color: var(--cor-primaria);">
                            ${formatarMoeda(faturamentoMes)}
                        </div>
                    </div>
                    
                    <div style="background: var(--cor-fundo); padding: 15px; border-radius: var(--borda-radius); text-align: center;">
                        <div style="font-size: 12px; color: var(--cor-texto-claro);">Lucro L√≠quido</div>
                        <div style="font-size: 20px; font-weight: bold; color: var(--cor-sucesso);">
                            ${formatarMoeda(lucroMes)}
                        </div>
                    </div>
                </div>
                
                <h4 style="margin-top: 20px; margin-bottom: 10px;">üèÜ Produtos Mais Agendados</h4>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    ${receitasOrdenadas.map(([nome, dados]) => {
                        const percentual = (dados.quantidade / entregasMes.reduce((sum, v) => sum + v.quantidade, 0)) * 100;
                        return `
                            <div style="display: flex; align-items: center; gap: 10px; 
                                background: var(--cor-fundo); padding: 10px; border-radius: var(--borda-radius);">
                                <div style="font-size: 24px;">${dados.emoji}</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600;">${nome}</div>
                                    <div style="font-size: 13px; color: var(--cor-texto-claro);">
                                        ${dados.quantidade} unidades (${percentual.toFixed(0)}%)
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: bold; color: var(--cor-primaria);">
                                        ${formatarMoeda(dados.faturamento)}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        /**
         * Navega para m√™s anterior/pr√≥ximo
         */
        function navegarMesCalendario(direcao) {
            mesAtualCalendario += direcao;
            
            if (mesAtualCalendario > 11) {
                mesAtualCalendario = 0;
                anoAtualCalendario++;
            } else if (mesAtualCalendario < 0) {
                mesAtualCalendario = 11;
                anoAtualCalendario--;
            }
            
            diaSelecionado = null;
            carregarPaginaCalendario();
        }
        
        /**
         * Volta para o m√™s atual
         */
        function irParaHoje() {
            const hoje = new Date();
            mesAtualCalendario = hoje.getMonth();
            anoAtualCalendario = hoje.getFullYear();
            diaSelecionado = hoje.getDate();
            
            carregarPaginaCalendario();
            
            // Auto-selecionar o dia
            setTimeout(() => {
                selecionarDia(diaSelecionado);
            }, 100);
        }
        
        /**
         * Seleciona um dia e mostra suas entregas
         */
        function selecionarDia(dia) {
            diaSelecionado = dia;
            
            const entregas = getEntregasDoDia(anoAtualCalendario, mesAtualCalendario, dia);
            
            // Atualizar calend√°rio
            const calendarioGrid = document.getElementById('calendario-grid');
            if (calendarioGrid) {
                calendarioGrid.innerHTML = renderizarCalendario();
            }
            
            // Mostrar/esconder card de entregas
            const card = document.getElementById('entregas-dia-card');
            const titulo = document.getElementById('titulo-entregas-dia');
            const lista = document.getElementById('lista-entregas-dia');
            
            if (entregas.length === 0) {
                card.style.display = 'none';
                return;
            }
            
            const data = new Date(anoAtualCalendario, mesAtualCalendario, dia);
            const nomeDia = getNomeDiaSemana(data.getDay());
            
            titulo.textContent = `Entregas de ${nomeDia}, ${dia} de ${getNomeMes(mesAtualCalendario)} de ${anoAtualCalendario}`;
            lista.innerHTML = renderizarEntregasDoDia(entregas);
            card.style.display = 'block';
            
            // Scroll suave at√© o card
            card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        /**
         * Renderiza lista de entregas do dia
         */
        function renderizarEntregasDoDia(entregas) {
            if (entregas.length === 0) {
                return '<p style="text-align: center; color: var(--cor-texto-claro);">Nenhuma entrega agendada para este dia.</p>';
            }
            
            let html = '';
            
            entregas.forEach(venda => {
                const statusClass = venda.statusEntrega === 'entregue' ? 'success' : 'warning';
                const statusPagClass = venda.pagamento.statusPagamento === 'pago' ? 'success' : 'warning';
                const emoji = getEmojiProduto(venda.receitaNome);
                
                html += `
                    <div class="card" style="margin-bottom: 15px; border-left: 4px solid ${
                        venda.statusEntrega === 'entregue' ? 'var(--cor-sucesso)' : 'var(--cor-aviso)'
                    };">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                    <span style="font-size: 24px;">${emoji}</span>
                                    <div>
                                        <div style="font-weight: 600; font-size: 16px;">
                                            ${venda.horaEntrega || '‚è∞'} - ${venda.cliente.nome}
                                        </div>
                                        <div style="font-size: 14px; color: var(--cor-texto-claro);">
                                            ${venda.numero}
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-top: 10px;">
                                    <span class="badge badge-${statusClass}">
                                        ${venda.statusEntrega === 'entregue' ? '‚úÖ Entregue' : 'üü° Pendente'}
                                    </span>
                                    <span class="badge badge-${statusPagClass}">
                                        ${venda.pagamento.statusPagamento === 'pago' ? 'üí∞ Pago' : '‚è≥ Pag. Pendente'}
                                    </span>
                                </div>
                            </div>
                            
                            <div style="text-align: right;">
                                <div style="font-size: 18px; font-weight: bold; color: var(--cor-primaria);">
                                    ${formatarMoeda(venda.valorTotal)}
                                </div>
                                <div style="font-size: 13px; color: var(--cor-texto-claro);">
                                    ${venda.quantidade}x ${venda.receitaNome}
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: var(--cor-fundo); padding: 10px; border-radius: var(--borda-radius-sm); 
                            font-size: 14px; margin-bottom: 10px;">
                            ${venda.cliente.telefone ? `<div>üìû ${venda.cliente.telefone}</div>` : ''}
                            ${venda.cliente.endereco ? `<div>üìç ${venda.cliente.endereco}</div>` : ''}
                            ${venda.observacoes ? `<div style="margin-top: 5px; color: var(--cor-texto-claro);">üí¨ ${venda.observacoes}</div>` : ''}
                        </div>
                        
                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                            <button class="btn btn-primary btn-sm" onclick="verDetalhesVenda('${venda.id}')">
                                üëÅÔ∏è Ver Detalhes
                            </button>
                            
                            ${venda.statusEntrega !== 'entregue' ? `
                                <button class="btn btn-success btn-sm" onclick="marcarEntregueCalendario('${venda.id}')">
                                    ‚úÖ Marcar Entregue
                                </button>
                            ` : ''}
                            
                            ${venda.pagamento.statusPagamento !== 'pago' ? `
                                <button class="btn btn-info btn-sm" onclick="confirmarPagamentoCalendario('${venda.id}')">
                                    üí≥ Confirmar Pagamento
                                </button>
                            ` : ''}
                            
                            <button class="btn btn-secondary btn-sm" onclick="abrirModalEditarVenda('${venda.id}')">
                                ‚úèÔ∏è Editar
                            </button>
                        </div>
                    </div>
                `;
            });
            
            return html;
        }
        
        /**
         * Marca entrega como conclu√≠da (no calend√°rio)
         */
        function marcarEntregueCalendario(vendaId) {
            if (marcarComoEntregue(vendaId)) {
                // Recarregar apenas o dia selecionado
                if (diaSelecionado) {
                    const entregas = getEntregasDoDia(anoAtualCalendario, mesAtualCalendario, diaSelecionado);
                    const lista = document.getElementById('lista-entregas-dia');
                    if (lista) {
                        lista.innerHTML = renderizarEntregasDoDia(entregas);
                    }
                }
                
                // Recarregar calend√°rio
                const calendarioGrid = document.getElementById('calendario-grid');
                if (calendarioGrid) {
                    calendarioGrid.innerHTML = renderizarCalendario();
                }
                
                // Recarregar resumo
                const resumo = document.getElementById('resumo-mes-calendario');
                if (resumo) {
                    resumo.innerHTML = renderizarResumoMes();
                }
                
                mostrarToast('Entrega marcada como conclu√≠da!', 'success');
            }
        }
        
        /**
         * Confirma pagamento (no calend√°rio)
         */
        function confirmarPagamentoCalendario(vendaId) {
            if (confirmarPagamento(vendaId)) {
                // Recarregar apenas o dia selecionado
                if (diaSelecionado) {
                    const entregas = getEntregasDoDia(anoAtualCalendario, mesAtualCalendario, diaSelecionado);
                    const lista = document.getElementById('lista-entregas-dia');
                    if (lista) {
                        lista.innerHTML = renderizarEntregasDoDia(entregas);
                    }
                }
                
                mostrarToast('Pagamento confirmado!', 'success');
            }
        }
        
        console.log('‚úÖ M√≥dulo de Calend√°rio carregado');
        
        // ====================================
        // INICIALIZA√á√ÉO FINAL DO SISTEMA
        // ====================================
        
        console.log('');
        console.log('üéÇ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('   SISTEMA DEIA CAKES v2.0 - TOTALMENTE CARREGADO');
        console.log('üéÇ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('');
        console.log('‚úÖ M√≥dulos carregados:');
        console.log('   1. Base + Firebase');
        console.log('   2. Autentica√ß√£o Hier√°rquica');
        console.log('   3. Materiais + Estoque');
        console.log('   4. Receitas');
        console.log('   5. Vendas');
        console.log('   6. Calend√°rio de Entregas');
        console.log('');
        console.log('üì¶ Funcionalidades dispon√≠veis:');
        console.log('   ‚Ä¢ Sistema ADM/Usu√°rio');
        console.log('   ‚Ä¢ Pre√ßo m√©dio ponderado correto');
        console.log('   ‚Ä¢ Estoque calculado em tempo real');
        console.log('   ‚Ä¢ Custos vol√°teis ‚Üí congelados na venda');
        console.log('   ‚Ä¢ Scanner de c√≥digo de barras');
        console.log('   ‚Ä¢ Valida√ß√£o de estoque antes de vender');
        console.log('   ‚Ä¢ Sincroniza√ß√£o inteligente');
        console.log('   ‚Ä¢ Calend√°rio visual de entregas');
        console.log('');
        console.log('üöÄ Sistema pronto para uso!');
        console.log('');
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão de Confeitaria</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.4/html5-qrcode.min.js"></script>
    <style>
        /* Estilos Gerais */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #ff85a2;
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        nav {
            background-color: #ffb5c8;
            padding: 10px 0;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        nav ul li {
            margin-right: 20px;
        }
        
        nav ul li a {
            color: #333;
            text-decoration: none;
            font-weight: 500;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        
        nav ul li a:hover, nav ul li a.active {
            background-color: #ff85a2;
            color: white;
        }
        
        h1, h2, h3 {
            margin-top: 0;
            color: #333;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            padding: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background-color: #ff85a2;
            color: white;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        table th, table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        table th {
            background-color: #f4f4f4;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Estilos de Página */
        .page-content {
            display: none;
        }
        
        .page-content.active {
            display: block;
        }
        
        /* Estilos do Scanner */
        #reader {
            width: 100%;
            height: 300px;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .scanner-container {
            margin-top: 20px;
        }
        
        /* Estilos de Formulários */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .form-row {
            display: flex;
            margin: 0 -10px;
        }
        
        .form-col {
            flex: 1;
            padding: 0 10px;
        }
        
        /* Animações */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        /* Notificações */
        .notification {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .notification-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .notification-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .notification-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        .notification-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* Estilos para Receitas */
        .recipe-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .recipe-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        
        .ingredients-table {
            margin-top: 10px;
        }
        
        .tab-buttons {
            display: flex;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: 10px 20px;
            border: none;
            background-color: #f1f1f1;
            cursor: pointer;
            transition: background-color 0.3s;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        .tab-button.active {
            background-color: #ff85a2;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        /* Modal para carregamento e feedback */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            max-width: 80%;
            width: 500px;
            text-align: center;
        }
        
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #ff85a2;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #iframe-container {
            width: 100%;
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 15px;
            display: none;
        }
        
        #web-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* Estilos para área de vendas */
        .sale-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .sale-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .sale-title {
            font-weight: bold;
            font-size: 18px;
        }
        
        .sale-date {
            color: #666;
        }
        
        .sale-details {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>Confeitaria System</h1>
            <div>
                <span id="date-time"></span>
            </div>
        </div>
    </header>
    
    <nav>
        <ul>
            <li><a href="#estoque" class="nav-link active" data-page="estoque">Estoque</a></li>
            <li><a href="#materiais" class="nav-link" data-page="materiais">Materiais</a></li>
            <li><a href="#receitas" class="nav-link" data-page="receitas">Receitas</a></li>
            <li><a href="#vendas" class="nav-link" data-page="vendas">Vendas</a></li>
        </ul>
    </nav>
    
    <div class="container">
        <!-- Página de Estoque -->
        <div class="page-content active" id="estoque-page">
            <h2>Gestão de Estoque</h2>
            
            <div class="tab-buttons">
                <button class="tab-button active" data-tab="listar-estoque">Listar Estoque</button>
                <button class="tab-button" data-tab="adicionar-estoque">Adicionar Item</button>
                <button class="tab-button" data-tab="remover-estoque">Remover com Receita</button>
            </div>
            
            <!-- Tab: Listar Estoque -->
            <div class="tab-content active" id="listar-estoque">
                <div class="card">
                    <h3>Itens em Estoque</h3>
                    <div id="notification-estoque"></div>
                    <input type="text" id="pesquisar-estoque" class="form-control" placeholder="Pesquisar item..." style="margin-bottom: 20px;">
                    
                    <table id="tabela-estoque">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Nome</th>
                                <th>Quantidade</th>
                                <th>Unidade</th>
                                <th>Unidade de Medida</th>
                                <th>Preço (R$)</th>
                                <th>Data de Adição</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="itens-estoque">
                            <!-- Os itens do estoque serão adicionados aqui dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Tab: Adicionar Item ao Estoque -->
            <div class="tab-content" id="adicionar-estoque">
                <div class="card">
                    <h3>Adicionar Item ao Estoque</h3>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <button id="iniciar-scanner" class="btn btn-primary">Escanear Código de Barras/QR</button>
                            <div class="scanner-container hidden" id="scanner-container">
                                <div id="reader"></div>
                                <div id="scanner-result"></div>
                                <button id="parar-scanner" class="btn btn-secondary" style="margin-top: 10px;">Parar Scanner</button>
                            </div>
                            <div id="iframe-container">
                                <iframe id="web-iframe" sandbox="allow-same-origin allow-scripts"></iframe>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="codigo-item">Código do Item:</label>
                                <input type="text" id="codigo-item" class="form-control" placeholder="Código ou código de barras">
                            </div>
                        </div>
                    </div>
                    
                    <form id="form-adicionar-estoque">
                        <div class="form-group">
                            <label for="nome-item">Nome do Item:</label>
                            <input type="text" id="nome-item" class="form-control" placeholder="Ex: Farinha de Trigo" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="quantidade-item">Quantidade de Itens:</label>
                                    <input type="number" id="quantidade-item" class="form-control" min="0" step="0.01" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="unidade-item">Unidade:</label>
                                    <select id="unidade-item" class="form-control" required>
                                        <option value="un">Unidades (un)</option>
                                        <option value="cx">Caixas (cx)</option>
                                        <option value="pct">Pacotes (pct)</option>
                                        <option value="lata">Latas (lata)</option>
                                        <option value="garrafa">Garrafas (garrafa)</option>
                                        <option value="caixa">Caixas (caixa)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="unidade-medida-item">Unidade de Medida:</label>
                                    <select id="unidade-medida-item" class="form-control" required>
                                        <option value="kg">Quilogramas (kg)</option>
                                        <option value="g">Gramas (g)</option>
                                        <option value="l">Litros (l)</option>
                                        <option value="ml">Mililitros (ml)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="quantidade-medida-item">Quantidade por Unidade:</label>
                                    <input type="number" id="quantidade-medida-item" class="form-control" min="0" step="0.01" required placeholder="Ex: 350 (para 350ml)">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="preco-item">Preço (R$):</label>
                                    <input type="number" id="preco-item" class="form-control" min="0" step="0.01" placeholder="0.00" required>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Adicionar ao Estoque</button>
                    </form>
                </div>
            </div>
            
            <!-- Tab: Remover com Receita -->
            <div class="tab-content" id="remover-estoque">
                <div class="card">
                    <h3>Remover Itens com Receita</h3>
                    
                    <div class="form-group">
                        <label for="selecionar-receita">Selecione uma Receita:</label>
                        <select id="selecionar-receita" class="form-control">
                            <option value="">Selecione uma receita...</option>
                            <!-- As receitas serão adicionadas aqui dinamicamente -->
                        </select>
                    </div>
                    
                    <div id="detalhes-receita" class="hidden">
                        <h4>Detalhes da Receita: <span id="nome-receita-selecionada"></span></h4>
                        
                        <table id="tabela-ingredientes-receita">
                            <thead>
                                <tr>
                                    <th>Ingrediente</th>
                                    <th>Quantidade Necessária</th>
                                    <th>Estoque Atual</th>
                                    <th>Preço Unitário</th>
                                    <th>Custo</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="ingredientes-receita-selecionada">
                                <!-- Os ingredientes da receita serão adicionados aqui dinamicamente -->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="4" style="text-align: right;"><strong>Custo Total:</strong></td>
                                    <td id="custo-total-receita" style="font-weight: bold;"></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                        
                        <div id="aviso-estoque" class="notification hidden"></div>
                        
                        <div class="form-group">
                            <label for="quantidade-receitas">Quantidade de Receitas:</label>
                            <input type="number" id="quantidade-receitas" class="form-control" value="1" min="1">
                        </div>
                        
                        <button id="confirmar-remocao" class="btn btn-primary">Confirmar Produção</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Página de Materiais -->
        <div class="page-content" id="materiais-page">
            <h2>Catálogo de Materiais</h2>
            
            <div class="tab-buttons">
                <button class="tab-button active" data-tab="listar-materiais">Listar Materiais</button>
                <button class="tab-button" data-tab="adicionar-material">Adicionar Material</button>
            </div>
            
            <!-- Tab: Listar Materiais -->
            <div class="tab-content active" id="listar-materiais">
                <div class="card">
                    <h3>Materiais Cadastrados</h3>
                    <div id="notification-materiais"></div>
                    <input type="text" id="pesquisar-materiais" class="form-control" placeholder="Pesquisar material..." style="margin-bottom: 20px;">
                    
                    <table id="tabela-materiais">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Nome</th>
                                <th>Unidade</th>
                                <th>Unidade de Medida</th>
                                <th>Quantidade por Unidade</th>
                                <th>Última Compra</th>
                                <th>Último Preço (R$)</th>
                                <th>Preço Médio (R$)</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="itens-materiais">
                            <!-- Os materiais serão adicionados aqui dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Tab: Adicionar Material -->
            <div class="tab-content" id="adicionar-material">
                <div class="card">
                    <h3>Adicionar Novo Material</h3>
                    
                    <form id="form-adicionar-material">
                        <div class="form-group">
                            <label for="codigo-material">Código do Material:</label>
                            <input type="text" id="codigo-material" class="form-control" placeholder="Código ou código de barras">
                        </div>
                        
                        <div class="form-group">
                            <label for="nome-material">Nome do Material:</label>
                            <input type="text" id="nome-material" class="form-control" placeholder="Ex: Farinha de Trigo" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="unidade-material">Unidade:</label>
                                    <select id="unidade-material" class="form-control" required>
                                        <option value="un">Unidades (un)</option>
                                        <option value="cx">Caixas (cx)</option>
                                        <option value="pct">Pacotes (pct)</option>
                                        <option value="lata">Latas (lata)</option>
                                        <option value="garrafa">Garrafas (garrafa)</option>
                                        <option value="caixa">Caixas (caixa)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="unidade-medida-material">Unidade de Medida:</label>
                                    <select id="unidade-medida-material" class="form-control" required>
                                        <option value="kg">Quilogramas (kg)</option>
                                        <option value="g">Gramas (g)</option>
                                        <option value="l">Litros (l)</option>
                                        <option value="ml">Mililitros (ml)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="quantidade-medida-material">Quantidade por Unidade:</label>
                                    <input type="number" id="quantidade-medida-material" class="form-control" min="0" step="0.01" required placeholder="Ex: 350 (para 350ml)">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="preco-material">Preço (R$):</label>
                                    <input type="number" id="preco-material" class="form-control" min="0" step="0.01" placeholder="0.00" required>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Adicionar Material</button>
                    </form>
                </div>
            </div>
        </div>
        <!-- Página de Receitas -->
        <div class="page-content" id="receitas-page">
            <h2>Gestão de Receitas</h2>
            
            <div class="tab-buttons">
                <button class="tab-button active" data-tab="listar-receitas">Listar Receitas</button>
                <button class="tab-button" data-tab="adicionar-receita">Adicionar Receita</button>
            </div>
            
            <!-- Tab: Listar Receitas -->
            <div class="tab-content active" id="listar-receitas">
                <div class="card">
                    <h3>Receitas Cadastradas</h3>
                    <input type="text" id="pesquisar-receita" class="form-control" placeholder="Pesquisar receita..." style="margin-bottom: 20px;">
                    
                    <div id="lista-receitas">
                        <!-- As receitas serão adicionadas aqui dinamicamente -->
                    </div>
                </div>
            </div>
            
            <!-- Tab: Adicionar Receita -->
            <div class="tab-content" id="adicionar-receita">
                <div class="card">
                    <h3>Adicionar Nova Receita</h3>
                    
                    <form id="form-adicionar-receita">
                        <div class="form-group">
                            <label for="nome-receita">Nome da Receita:</label>
                            <input type="text" id="nome-receita" class="form-control" placeholder="Ex: Bolo de Chocolate" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="descricao-receita">Descrição:</label>
                            <textarea id="descricao-receita" class="form-control" rows="3" placeholder="Descreva brevemente a receita..."></textarea>
                        </div>
                        
                        <h4>Ingredientes</h4>
                        <div id="lista-ingredientes">
                            <!-- Os ingredientes serão adicionados aqui dinamicamente -->
                        </div>
                        
                        <button type="button" id="adicionar-ingrediente" class="btn btn-secondary">+ Adicionar Ingrediente</button>
                        
                        <div style="margin-top: 20px;">
                            <button type="submit" class="btn btn-primary">Salvar Receita</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Página de Vendas -->
        <div class="page-content" id="vendas-page">
            <h2>Histórico de Vendas</h2>
            
            <div class="tab-buttons">
                <button class="tab-button active" data-tab="listar-vendas">Histórico de Vendas</button>
            </div>
            
            <!-- Tab: Listar Vendas -->
            <div class="tab-content active" id="listar-vendas">
                <div class="card">
                    <h3>Registro de Produções / Vendas</h3>
                    <div id="notification-vendas"></div>
                    <input type="text" id="pesquisar-vendas" class="form-control" placeholder="Pesquisar vendas..." style="margin-bottom: 20px;">
                    
                    <div class="form-row" style="margin-bottom: 20px;">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="filtro-data-inicio">Data Inicial:</label>
                                <input type="date" id="filtro-data-inicio" class="form-control">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="filtro-data-fim">Data Final:</label>
                                <input type="date" id="filtro-data-fim" class="form-control">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="filtro-receita">Receita:</label>
                                <select id="filtro-receita" class="form-control">
                                    <option value="">Todas as receitas</option>
                                    <!-- As receitas serão adicionadas aqui dinamicamente -->
                                </select>
                            </div>
                        </div>
                        <div class="form-col" style="display: flex; align-items: flex-end;">
                            <button id="btn-filtrar-vendas" class="btn btn-primary">Filtrar</button>
                            <button id="btn-limpar-filtros" class="btn btn-secondary" style="margin-left: 10px;">Limpar</button>
                        </div>
                    </div>
                    
                    <div id="lista-vendas">
                        <!-- As vendas serão adicionadas aqui dinamicamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para processamento de dados -->
    <div id="processing-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="modal-title">Processando...</h3>
            <div class="loader"></div>
            <p id="modal-message">Aguarde enquanto processamos as informações.</p>
        </div>
    </div>
    <script>
// Inicialização do localStorage se necessário
if (!localStorage.getItem('estoque')) {
    localStorage.setItem('estoque', JSON.stringify([]));
}

if (!localStorage.getItem('materiais')) {
    localStorage.setItem('materiais', JSON.stringify([]));
}

if (!localStorage.getItem('receitas')) {
    localStorage.setItem('receitas', JSON.stringify([]));
}

if (!localStorage.getItem('vendas')) {
    localStorage.setItem('vendas', JSON.stringify([]));
}

// Variáveis globais
let estoque = JSON.parse(localStorage.getItem('estoque')) || [];
let materiais = JSON.parse(localStorage.getItem('materiais')) || [];
let receitas = JSON.parse(localStorage.getItem('receitas')) || [];
let vendas = JSON.parse(localStorage.getItem('vendas')) || [];
let html5QrCode;

// Função para atualizar o localStorage
function atualizarLocalStorage() {
    localStorage.setItem('estoque', JSON.stringify(estoque));
    localStorage.setItem('materiais', JSON.stringify(materiais));
    localStorage.setItem('receitas', JSON.stringify(receitas));
    localStorage.setItem('vendas', JSON.stringify(vendas));
}

// Função para mostrar uma notificação
function mostrarNotificacao(elemento, mensagem, tipo) {
    const notificacao = document.getElementById(elemento);
    notificacao.className = `notification notification-${tipo}`;
    notificacao.textContent = mensagem;
    
    // Esconder a notificação após 5 segundos
    setTimeout(() => {
        notificacao.className = 'notification hidden';
    }, 5000);
}

// Função para mostrar/esconder o modal de processamento
function toggleModal(show, title = "Processando...", message = "Aguarde enquanto processamos as informações.") {
    const modal = document.getElementById('processing-modal');
    
    if (!modal) {
        console.error('Modal não encontrado');
        return;
    }
    
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-message').textContent = message;
    
    if (show) {
        modal.classList.remove('hidden');
        
        // Adicionar timer de segurança - fechará o modal após 10 segundos
        window.modalSafetyTimer = setTimeout(() => {
            modal.classList.add('hidden');
        }, 10000);
    } else {
        modal.classList.add('hidden');
        // Limpar o timer de segurança se o modal for fechado manualmente
        if (window.modalSafetyTimer) {
            clearTimeout(window.modalSafetyTimer);
        }
    }
}

// Função para formatar data
function formatarData(data) {
    const d = new Date(data);
    return `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getFullYear()}`;
}

// Função para formatar valor monetário
function formatarMoeda(valor) {
    return 'R$ ' + valor.toFixed(2).replace('.', ',');
}

// Função para gerar ID único
function gerarId() {
    return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// Função para encontrar um material pelo código
function encontrarMaterialPorCodigo(codigo) {
    return materiais.find(m => m.codigo === codigo);
}

// Função para adicionar ou atualizar um material no catálogo
function adicionarOuAtualizarMaterial(codigoMaterial, nomeMaterial, unidadeMaterial, unidadeMedidaMaterial, quantidadeMedidaMaterial, precoMaterial) {
    // Verificar se o material já existe
    const materialExistente = encontrarMaterialPorCodigo(codigoMaterial);
    
    if (materialExistente) {
        // Atualizar material existente
        materialExistente.nome = nomeMaterial;
        materialExistente.unidade = unidadeMaterial;
        materialExistente.unidadeMedida = unidadeMedidaMaterial;
        materialExistente.quantidadeMedida = quantidadeMedidaMaterial;
        
        // Adicionar histórico de preço
        materialExistente.historicoPrecos.push({
            data: new Date().toISOString(),
            preco: precoMaterial
        });
        
        // Atualizar o último preço
        materialExistente.ultimoPreco = precoMaterial;
        materialExistente.ultimaCompra = new Date().toISOString();
        
        // Recalcular o preço médio
        const totalPrecos = materialExistente.historicoPrecos.reduce((soma, item) => soma + item.preco, 0);
        materialExistente.precoMedio = totalPrecos / materialExistente.historicoPrecos.length;
        
        return materialExistente.id;
    } else {
        // Criar novo material
        const novoMaterial = {
            id: gerarId(),
            codigo: codigoMaterial,
            nome: nomeMaterial,
            unidade: unidadeMaterial,
            unidadeMedida: unidadeMedidaMaterial,
            quantidadeMedida: quantidadeMedidaMaterial,
            ultimoPreco: precoMaterial,
            precoMedio: precoMaterial,
            ultimaCompra: new Date().toISOString(),
            dataCadastro: new Date().toISOString(),
            historicoPrecos: [{
                data: new Date().toISOString(),
                preco: precoMaterial
            }]
        };
        
        materiais.push(novoMaterial);
        return novoMaterial.id;
    }
}

// Função para carregar materiais na tabela
function carregarMateriais() {
    const tbody = document.getElementById('itens-materiais');
    tbody.innerHTML = '';
    
    if (materiais.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="9" style="text-align: center;">Nenhum material cadastrado.</td>';
        tbody.appendChild(tr);
        return;
    }
    
    materiais.forEach((material, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${material.codigo || 'N/A'}</td>
            <td>${material.nome}</td>
            <td>${material.unidade}</td>
            <td>${material.unidadeMedida}</td>
            <td>${material.quantidadeMedida}</td>
            <td>${formatarData(material.ultimaCompra)}</td>
            <td>${formatarMoeda(material.ultimoPreco)}</td>
            <td>${formatarMoeda(material.precoMedio)}</td>
            <td>
                <button class="btn btn-primary btn-editar-material" data-index="${index}">Editar</button>
                <button class="btn btn-success btn-adicionar-estoque" data-id="${material.id}">+ Estoque</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
    
    // Adicionar eventos aos botões
    document.querySelectorAll('.btn-editar-material').forEach(btn => {
        btn.addEventListener('click', function() {
            const index = this.getAttribute('data-index');
            editarMaterial(index);
        });
    });
    
    document.querySelectorAll('.btn-adicionar-estoque').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            adicionarAoEstoque(id);
        });
    });
}

// Função para editar um material
function editarMaterial(index) {
    const material = materiais[index];
    
    // Mudar para a aba de adicionar material
    document.querySelector('[data-tab="adicionar-material"]').click();
    
    // Preencher o formulário
    document.getElementById('codigo-material').value = material.codigo || '';
    document.getElementById('nome-material').value = material.nome;
    document.getElementById('unidade-material').value = material.unidade;
    document.getElementById('unidade-medida-material').value = material.unidadeMedida;
    document.getElementById('quantidade-medida-material').value = material.quantidadeMedida;
    document.getElementById('preco-material').value = material.ultimoPreco;
    
    // Modificar o botão de submit
    const submitBtn = document.querySelector('#form-adicionar-material button[type="submit"]');
    submitBtn.textContent = 'Atualizar Material';
    submitBtn.setAttribute('data-edicao', index);
}

// Função para adicionar um material ao estoque
function adicionarAoEstoque(materialId) {
    const material = materiais.find(m => m.id === materialId);
    if (!material) return;
    
    // Mudar para a página de estoque e a aba de adicionar
    document.querySelector('[data-page="estoque"]').click();
    document.querySelector('[data-tab="adicionar-estoque"]').click();
    
    // Preencher o formulário com os dados do material
    document.getElementById('codigo-item').value = material.codigo || '';
    document.getElementById('nome-item').value = material.nome;
    document.getElementById('quantidade-item').value = 1;
    document.getElementById('unidade-item').value = material.unidade;
    document.getElementById('unidade-medida-item').value = material.unidadeMedida;
    document.getElementById('quantidade-medida-item').value = material.quantidadeMedida;
    document.getElementById('preco-item').value = material.ultimoPreco;
}

// Função para calcular o custo de uma receita
function calcularCustoReceita(receita) {
    let custoTotal = 0;
    
    receita.ingredientes.forEach(ingrediente => {
        const itemEstoque = estoque.find(item => item.id === ingrediente.id);
        if (itemEstoque && itemEstoque.preco) {
            // Calculamos o custo com base na quantidade da unidade de medida
            const custoUnitario = itemEstoque.preco / (itemEstoque.quantidade * itemEstoque.quantidadeMedida);
            custoTotal += custoUnitario * ingrediente.quantidade;
        }
    });
    
    return custoTotal;
}
        // Função para carregar o estoque na tabela
function carregarEstoque() {
    const tbody = document.getElementById('itens-estoque');
    tbody.innerHTML = '';
    
    if (estoque.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="8" style="text-align: center;">Nenhum item no estoque.</td>';
        tbody.appendChild(tr);
        return;
    }
    
    estoque.forEach((item, index) => {
        // Calcular a quantidade em unidade de medida (ex: ml restantes)
        const quantidadeTotalMedida = item.quantidade * item.quantidadeMedida;
        // Verificar se é um número fracionário
        const quantidadeFracionada = item.quantidade % 1 !== 0;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${item.codigo || 'N/A'}</td>
            <td>${item.nome}</td>
            <td>${item.quantidade.toFixed(2)} ${quantidadeFracionada ? `(${Math.floor(item.quantidade)} + ${((item.quantidade % 1) * 100).toFixed(0)}%)` : ''}</td>
            <td>${item.unidade}</td>
            <td>${quantidadeTotalMedida.toFixed(0)} ${item.unidadeMedida || 'N/A'}</td>
            <td>${formatarMoeda(item.preco || 0)}</td>
            <td>${formatarData(item.dataAdicao)}</td>
            <td>
                <button class="btn btn-primary btn-editar-estoque" data-index="${index}">Editar</button>
                <button class="btn btn-danger btn-remover-estoque" data-index="${index}">Remover</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
    
    // Adicionar eventos aos botões
    document.querySelectorAll('.btn-editar-estoque').forEach(btn => {
        btn.addEventListener('click', function() {
            const index = this.getAttribute('data-index');
            editarItemEstoque(index);
        });
    });
    
    document.querySelectorAll('.btn-remover-estoque').forEach(btn => {
        btn.addEventListener('click', function() {
            const index = this.getAttribute('data-index');
            removerItemEstoque(index);
        });
    });
}

// Função para editar um item do estoque
function editarItemEstoque(index) {
    const item = estoque[index];
    
    // Mudar para a aba de adicionar
    document.querySelector('[data-tab="adicionar-estoque"]').click();
    
    // Preencher o formulário
    document.getElementById('codigo-item').value = item.codigo || '';
    document.getElementById('nome-item').value = item.nome;
    document.getElementById('quantidade-item').value = item.quantidade;
    document.getElementById('unidade-item').value = item.unidade;
    document.getElementById('unidade-medida-item').value = item.unidadeMedida || 'ml';
    document.getElementById('quantidade-medida-item').value = item.quantidadeMedida || '';
    document.getElementById('preco-item').value = item.preco || '';
    
    // Modificar o botão de submit
    const submitBtn = document.querySelector('#form-adicionar-estoque button[type="submit"]');
    submitBtn.textContent = 'Atualizar Item';
    submitBtn.setAttribute('data-edicao', index);
}

// Função para remover um item do estoque
function removerItemEstoque(index) {
    if (confirm('Tem certeza que deseja remover este item do estoque?')) {
        estoque.splice(index, 1);
        atualizarLocalStorage();
        carregarEstoque();
        atualizarSelectsIngredientes();
        mostrarNotificacao('notification-estoque', 'Item removido com sucesso!', 'success');
    }
}

// Função para carregar receitas
function carregarReceitas() {
    const container = document.getElementById('lista-receitas');
    container.innerHTML = '';
    
    // Carregar no select da página de remoção com receita
    const selectRemocao = document.getElementById('selecionar-receita');
    selectRemocao.innerHTML = '<option value="">Selecione uma receita...</option>';
    
    // Carregar no select do filtro de vendas
    const selectFiltroVendas = document.getElementById('filtro-receita');
    if (selectFiltroVendas) {
        selectFiltroVendas.innerHTML = '<option value="">Todas as receitas</option>';
    }
    
    if (receitas.length === 0) {
        container.innerHTML = '<p>Nenhuma receita cadastrada.</p>';
        return;
    }
    
    receitas.forEach((receita, index) => {
        // Calcular o custo total da receita
        const custoTotal = calcularCustoReceita(receita);
        
        // Adicionar ao container de lista
        const card = document.createElement('div');
        card.className = 'recipe-card';
        card.innerHTML = `
            <h3>${receita.nome}</h3>
            <p>${receita.descricao || 'Sem descrição'}</p>
            <p><strong>Custo de Produção:</strong> ${formatarMoeda(custoTotal)}</p>
            <div class="ingredients-table">
                <h4>Ingredientes:</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Ingrediente</th>
                            <th>Quantidade</th>
                            <th>Custo</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${receita.ingredientes.map(ing => {
                            const itemEstoque = estoque.find(item => item.id === ing.id);
                            let custoExibicao = 0;
                            
                            if (itemEstoque) {
                                // Calculamos o custo unitário baseado na unidade de medida
                                const custoUnitario = itemEstoque.preco / (itemEstoque.quantidade * itemEstoque.quantidadeMedida);
                                custoExibicao = custoUnitario * ing.quantidade;
                            }
                            
                            return `
                                <tr>
                                    <td>${ing.nome}</td>
                                    <td>${ing.quantidade} ${ing.unidadeMedida}</td>
                                    <td>${formatarMoeda(custoExibicao)}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            <div style="margin-top: 15px;">
                <button class="btn btn-primary btn-editar-receita" data-index="${index}">Editar</button>
                <button class="btn btn-danger btn-remover-receita" data-index="${index}">Remover</button>
                <button class="btn btn-success btn-produzir-receita" data-index="${index}">Produzir</button>
            </div>
        `;
        container.appendChild(card);
        
        // Adicionar ao select de remoção de estoque
        const optionRemocao = document.createElement('option');
        optionRemocao.value = index;
        optionRemocao.textContent = receita.nome;
        selectRemocao.appendChild(optionRemocao);
        
        // Adicionar ao select de filtro de vendas
        if (selectFiltroVendas) {
            const optionFiltro = document.createElement('option');
            optionFiltro.value = receita.id;
            optionFiltro.textContent = receita.nome;
            selectFiltroVendas.appendChild(optionFiltro);
        }
    });
    
    // Adicionar eventos aos botões
    document.querySelectorAll('.btn-editar-receita').forEach(btn => {
        btn.addEventListener('click', function() {
            const index = this.getAttribute('data-index');
            editarReceita(index);
        });
    });
    
    document.querySelectorAll('.btn-remover-receita').forEach(btn => {
        btn.addEventListener('click', function() {
            const index = this.getAttribute('data-index');
            removerReceita(index);
        });
    });
    
    document.querySelectorAll('.btn-produzir-receita').forEach(btn => {
        btn.addEventListener('click', function() {
            const index = this.getAttribute('data-index');
            
            // Mudar para a página de estoque e aba de remover
            document.querySelector('[data-page="estoque"]').click();
            document.querySelector('[data-tab="remover-estoque"]').click();
            
            // Selecionar a receita
            document.getElementById('selecionar-receita').value = index;
            document.getElementById('selecionar-receita').dispatchEvent(new Event('change'));
        });
    });
}

// Função para editar uma receita
function editarReceita(index) {
    const receita = receitas[index];
    
    // Mudar para a aba de adicionar receita
    document.querySelector('[data-tab="adicionar-receita"]').click();
    
    // Preencher o formulário
    document.getElementById('nome-receita').value = receita.nome;
    document.getElementById('descricao-receita').value = receita.descricao || '';
    
    // Limpar os ingredientes existentes
    document.getElementById('lista-ingredientes').innerHTML = '';
    
    // Adicionar cada ingrediente
    receita.ingredientes.forEach(ingrediente => {
        adicionarCampoIngrediente(ingrediente);
    });
    
    // Modificar o botão de submit
    const submitBtn = document.querySelector('#form-adicionar-receita button[type="submit"]');
    submitBtn.textContent = 'Atualizar Receita';
    submitBtn.setAttribute('data-edicao', index);
}

// Função para remover uma receita
function removerReceita(index) {
    if (confirm('Tem certeza que deseja remover esta receita?')) {
        receitas.splice(index, 1);
        atualizarLocalStorage();
        carregarReceitas();
        mostrarNotificacao('notification-estoque', 'Receita removida com sucesso!', 'success');
    }
}

// Função para adicionar campo de ingrediente
function adicionarCampoIngrediente(ingredienteData = null) {
    const container = document.getElementById('lista-ingredientes');
    const div = document.createElement('div');
    div.className = 'ingrediente-item';
    div.innerHTML = `
        <div class="form-row">
            <div class="form-col">
                <div class="form-group">
                    <label>Ingrediente:</label>
                    <select class="form-control ingrediente-select" required>
                        <option value="">Selecione um ingrediente...</option>
                        ${estoque.map(item => `
                            <option value="${item.id}" 
                                data-unidade="${item.unidade}" 
                                data-preco="${item.preco || 0}"
                                data-unidade-medida="${item.unidadeMedida || ''}"
                                data-quantidade-medida="${item.quantidadeMedida || 0}">
                                ${item.nome}
                            </option>
                        `).join('')}
                    </select>
                </div>
            </div>
            <div class="form-col">
                <div class="form-group">
                    <label>Quantidade:</label>
                    <input type="number" class="form-control ingrediente-quantidade" min="0.01" step="0.01" required>
                </div>
            </div>
            <div class="form-col">
                <div class="form-group">
                    <label>Unidade de Medida:</label>
                    <select class="form-control ingrediente-unidade-medida" required>
                        <option value="kg">Quilogramas (kg)</option>
                        <option value="g">Gramas (g)</option>
                        <option value="l">Litros (l)</option>
                        <option value="ml">Mililitros (ml)</option>
                    </select>
                </div>
            </div>
            <div class="form-col" style="flex: 0.5;">
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button type="button" class="btn btn-danger remover-ingrediente" style="display: block;">X</button>
                </div>
            </div>
        </div>
    `;
    container.appendChild(div);
    
    // Configurar o novo campo
    const select = div.querySelector('.ingrediente-select');
    const quantidadeInput = div.querySelector('.ingrediente-quantidade');
    const unidadeMedidaSelect = div.querySelector('.ingrediente-unidade-medida');
    const removerBtn = div.querySelector('.remover-ingrediente');
    
    // Preencher com dados se fornecidos
    if (ingredienteData) {
        // Encontrar o ingrediente no estoque
        const ingredienteEstoque = estoque.find(item => item.id === ingredienteData.id);
        if (ingredienteEstoque) {
            select.value = ingredienteEstoque.id;
            quantidadeInput.value = ingredienteData.quantidade;
            unidadeMedidaSelect.value = ingredienteData.unidadeMedida || 'ml';
        }
    }
    
    // Adicionar eventos
    select.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
            const unidadeMedida = selectedOption.getAttribute('data-unidade-medida');
            if (unidadeMedida) {
                unidadeMedidaSelect.value = unidadeMedida;
            }
        }
    });
    
    removerBtn.addEventListener('click', function() {
        container.removeChild(div);
    });
}

// Função para atualizar todos os selects de ingredientes
function atualizarSelectsIngredientes() {
    document.querySelectorAll('.ingrediente-select').forEach(select => {
        const valorAtual = select.value;
        
        // Limpar as opções atuais
        select.innerHTML = '<option value="">Selecione um ingrediente...</option>';
        
        // Adicionar as novas opções
        estoque.forEach(item => {
            const option = document.createElement('option');
            option.value = item.id;
            option.textContent = item.nome;
            option.setAttribute('data-unidade', item.unidade);
            option.setAttribute('data-preco', item.preco || 0);
            option.setAttribute('data-unidade-medida', item.unidadeMedida || '');
            option.setAttribute('data-quantidade-medida', item.quantidadeMedida || 0);
            select.appendChild(option);
        });
        
        // Tentar restaurar o valor anterior
        if (valorAtual) {
            select.value = valorAtual;
        }
    });
}

// Função para calcular quantidades de unidades utilizadas em uma receita
function calcularUnidadesUtilizadas(itemEstoque, quantidadeNecessaria) {
    // Se não tem informações de unidade de medida, retorna a quantidade direta
    if (!itemEstoque.quantidadeMedida || itemEstoque.quantidadeMedida <= 0) {
        return {
            unidades: quantidadeNecessaria,
            fracao: 0,
            texto: `${quantidadeNecessaria} ${itemEstoque.unidade}`
        };
    }
    
    // Calcula quantas unidades inteiras são necessárias
    const unidadesInteiras = Math.floor(quantidadeNecessaria / itemEstoque.quantidadeMedida);
    
    // Calcula a fração restante
    const fracaoRestante = (quantidadeNecessaria % itemEstoque.quantidadeMedida) / itemEstoque.quantidadeMedida;
    
    // Formata o texto de saída
    let textoSaida = '';
    if (unidadesInteiras > 0) {
        textoSaida += `${unidadesInteiras} ${itemEstoque.unidade}`;
    }
    
    if (fracaoRestante > 0) {
        // Formata a fração como percentual
        const percentual = Math.round(fracaoRestante * 100);
        if (unidadesInteiras > 0) {
            textoSaida += ` + `;
        }
        textoSaida += `${percentual}% de 1 ${itemEstoque.unidade}`;
    }
    
    // Se não tem nada, significa que é uma quantidade muito pequena
    if (textoSaida === '') {
        textoSaida = `quantidade mínima`;
    }
    
    return {
        unidades: unidadesInteiras,
        fracao: fracaoRestante,
        texto: textoSaida
    };
}

// Função para carregar detalhes da receita para remoção de estoque
function carregarDetalhesReceita(index) {
    const receita = receitas[index];
    if (!receita) return;
    
    const detalhes = document.getElementById('detalhes-receita');
    const nomeReceita = document.getElementById('nome-receita-selecionada');
    const tbodyIngredientes = document.getElementById('ingredientes-receita-selecionada');
    const avisoEstoque = document.getElementById('aviso-estoque');
    const custoTotalElement = document.getElementById('custo-total-receita');
    
    detalhes.classList.remove('hidden');
    nomeReceita.textContent = receita.nome;
    tbodyIngredientes.innerHTML = '';
    
    let todosProdutosDisponiveis = true;
    let custoTotal = 0;
    
    // Obter a quantidade desejada
    const quantidade = parseInt(document.getElementById('quantidade-receitas').value) || 1;
    
    receita.ingredientes.forEach(ingrediente => {
        const itemEstoque = estoque.find(item => item.id === ingrediente.id);
        const quantidadeNecessaria = ingrediente.quantidade * quantidade;
        
        if (!itemEstoque) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${ingrediente.nome} (não encontrado)</td>
                <td>${quantidadeNecessaria} ${ingrediente.unidadeMedida || 'N/A'}</td>
                <td>N/A</td>
                <td>N/A</td>
                <td>N/A</td>
                <td style="color: red">Não disponível</td>
            `;
            tbodyIngredientes.appendChild(tr);
            todosProdutosDisponiveis = false;
            return;
        }
        
        // Converter a quantidade necessária para a unidade de medida do item no estoque
        let quantidadeTotalNecessaria = 0;
        
        // Se as unidades de medida são iguais, usamos diretamente
        if (ingrediente.unidadeMedida === itemEstoque.unidadeMedida) {
            quantidadeTotalNecessaria = quantidadeNecessaria;
        } else {
            // Conversão entre unidades (simplificado)
            if (ingrediente.unidadeMedida === 'ml' && itemEstoque.unidadeMedida === 'l') {
                quantidadeTotalNecessaria = quantidadeNecessaria / 1000;
            } else if (ingrediente.unidadeMedida === 'l' && itemEstoque.unidadeMedida === 'ml') {
                quantidadeTotalNecessaria = quantidadeNecessaria * 1000;
            } else if (ingrediente.unidadeMedida === 'g' && itemEstoque.unidadeMedida === 'kg') {
                quantidadeTotalNecessaria = quantidadeNecessaria / 1000;
            } else if (ingrediente.unidadeMedida === 'kg' && itemEstoque.unidadeMedida === 'g') {
                quantidadeTotalNecessaria = quantidadeNecessaria * 1000;
            } else {
                // Caso não consigamos converter, usamos a quantidade diretamente
                quantidadeTotalNecessaria = quantidadeNecessaria;
            }
        }
        
        // Calcular quantas unidades físicas (embalagens) precisaremos usar
        const unidadesUtilizadas = calcularUnidadesUtilizadas(itemEstoque, quantidadeTotalNecessaria);
        
        // Verificar disponibilidade
        // Calcular unidades necessárias baseado na fração
        const unidadesNecessarias = unidadesUtilizadas.unidades + unidadesUtilizadas.fracao;
        const disponivel = itemEstoque.quantidade >= unidadesNecessarias;
        
        if (!disponivel) {
            todosProdutosDisponiveis = false;
        }
        
        // Calcular custo
        const custoUnitario = itemEstoque.preco / itemEstoque.quantidade;
        const custo = custoUnitario * unidadesNecessarias;
        custoTotal += custo;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${itemEstoque.nome}</td>
            <td>${quantidadeNecessaria} ${ingrediente.unidadeMedida} (${unidadesUtilizadas.texto})</td>
            <td>${itemEstoque.quantidade.toFixed(2)} ${itemEstoque.unidade} (${(itemEstoque.quantidade * itemEstoque.quantidadeMedida).toFixed(0)} ${itemEstoque.unidadeMedida})</td>
            <td>${formatarMoeda(custoUnitario)}</td>
            <td>${formatarMoeda(custo)}</td>
            <td style="color: ${disponivel ? 'green' : 'red'}">${disponivel ? 'Disponível' : 'Insuficiente'}</td>
        `;
        
        tbodyIngredientes.appendChild(tr);
    });
    
    // Mostrar custo total
    custoTotalElement.textContent = formatarMoeda(custoTotal);
    
    // Mostrar aviso de estoque
    if (!todosProdutosDisponiveis) {
        avisoEstoque.classList.remove('hidden');
        avisoEstoque.className = 'notification notification-error';
        avisoEstoque.textContent = 'Atenção: Alguns ingredientes não estão disponíveis em quantidade suficiente!';
        document.getElementById('confirmar-remocao').disabled = true;
    } else {
        avisoEstoque.classList.remove('hidden');
        avisoEstoque.className = 'notification notification-success';
        avisoEstoque.textContent = 'Todos os ingredientes estão disponíveis. Você pode prosseguir com a produção.';
        document.getElementById('confirmar-remocao').disabled = false;
    }
}

// Função para produzir receita (remover ingredientes do estoque)
function produzirReceita(index, quantidade = 1) {
    const receita = receitas[index];
    if (!receita) return false;
    
    // Verificar se todos os ingredientes estão disponíveis na quantidade necessária
    let todosProdutosDisponiveis = true;
    let itensParaRemover = [];
    let detalhesVenda = []; // Para registrar a venda
    
    receita.ingredientes.forEach(ingrediente => {
        const itemEstoque = estoque.find(item => item.id === ingrediente.id);
        
        if (!itemEstoque) {
            todosProdutosDisponiveis = false;
            return;
        }
        
        // Converter a quantidade necessária para a unidade de medida do item no estoque
        let quantidadeTotalNecessaria = 0;
        
        // Se as unidades de medida são iguais, usamos diretamente
        if (ingrediente.unidadeMedida === itemEstoque.unidadeMedida) {
            quantidadeTotalNecessaria = ingrediente.quantidade * quantidade;
        } else {
            // Conversão entre unidades (simplificado)
            if (ingrediente.unidadeMedida === 'ml' && itemEstoque.unidadeMedida === 'l') {
                quantidadeTotalNecessaria = (ingrediente.quantidade * quantidade) / 1000;
            } else if (ingrediente.unidadeMedida === 'l' && itemEstoque.unidadeMedida === 'ml') {
                quantidadeTotalNecessaria = (ingrediente.quantidade * quantidade) * 1000;
            } else if (ingrediente.unidadeMedida === 'g' && itemEstoque.unidadeMedida === 'kg') {
                quantidadeTotalNecessaria = (ingrediente.quantidade * quantidade) / 1000;
            } else if (ingrediente.unidadeMedida === 'kg' && itemEstoque.unidadeMedida === 'g') {
                quantidadeTotalNecessaria = (ingrediente.quantidade * quantidade) * 1000;
            } else {
                quantidadeTotalNecessaria = ingrediente.quantidade * quantidade;
            }
        }
        
        // Calcular quantas unidades físicas (embalagens) precisaremos usar
        const unidadesUtilizadas = calcularUnidadesUtilizadas(itemEstoque, quantidadeTotalNecessaria);
        const unidadesNecessarias = unidadesUtilizadas.unidades + unidadesUtilizadas.fracao;
        
        if (itemEstoque.quantidade < unidadesNecessarias) {
            todosProdutosDisponiveis = false;
        } else {
            // Adicionar à lista de itens para remover
            itensParaRemover.push({
                id: itemEstoque.id,
                quantidade: unidadesNecessarias
            });
            
            // Adicionar detalhes para o registro de venda
            detalhesVenda.push({
                itemId: itemEstoque.id,
                nome: itemEstoque.nome,
                quantidadeUsada: unidadesNecessarias,
                unidade: itemEstoque.unidade,
                quantidadeMedida: quantidadeTotalNecessaria,
                unidadeMedida: ingrediente.unidadeMedida,
                custo: (itemEstoque.preco / itemEstoque.quantidade) * unidadesNecessarias
            });
        }
    });
    
    if (!todosProdutosDisponiveis) {
        return false;
    }
    
    // Criar registro da venda antes de remover os itens (para o caso de reversão)
    const venda = {
        id: gerarId(),
        receitaId: receita.id,
        receitaNome: receita.nome,
        quantidade: quantidade,
        data: new Date().toISOString(),
        itensUtilizados: detalhesVenda,
        estoqueAntes: JSON.parse(JSON.stringify(estoque)) // Clone do estoque antes da remoção
    };
    
    // Remover os ingredientes do estoque
    itensParaRemover.forEach(item => {
        const itemIndex = estoque.findIndex(i => i.id === item.id);
        
        if (itemIndex !== -1) {
            estoque[itemIndex].quantidade -= item.quantidade;
            // Arredondar para 2 casas decimais para evitar problemas de ponto flutuante
            estoque[itemIndex].quantidade = Math.round(estoque[itemIndex].quantidade * 100) / 100;
            
            // Remover item se a quantidade for zero ou negativa (não deveria acontecer)
            if (estoque[itemIndex].quantidade <= 0) {
                estoque.splice(itemIndex, 1);
            }
        }
    });
    
    // Adicionar a venda ao histórico
    vendas.push(venda);
    
    atualizarLocalStorage();
    return true;
}

// Função para carregar vendas
function carregarVendas() {
    const container = document.getElementById('lista-vendas');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (vendas.length === 0) {
        container.innerHTML = '<p>Nenhuma venda registrada.</p>';
        return;
    }
    
    // Obter filtros
    const filtroTexto = document.getElementById('pesquisar-vendas').value.toLowerCase();
    const filtroDataInicio = document.getElementById('filtro-data-inicio').value ? new Date(document.getElementById('filtro-data-inicio').value) : null;
    const filtroDataFim = document.getElementById('filtro-data-fim').value ? new Date(document.getElementById('filtro-data-fim').value) : null;
    const filtroReceita = document.getElementById('filtro-receita').value;
    
    // Aplicar filtros
    const vendasFiltradas = vendas.filter(venda => {
        const dataVenda = new Date(venda.data);
        
        // Filtro de texto
        if (filtroTexto && !venda.receitaNome.toLowerCase().includes(filtroTexto)) {
            return false;
        }
        
        // Filtro de data de início
        if (filtroDataInicio && dataVenda < filtroDataInicio) {
            return false;
        }
        
        // Filtro de data final
        if (filtroDataFim) {
            // Ajustar para o final do dia
            const dataFimAjustada = new Date(filtroDataFim);
            dataFimAjustada.setHours(23, 59, 59, 999);
            
            if (dataVenda > dataFimAjustada) {
                return false;
            }
        }
        
        // Filtro de receita
        if (filtroReceita && venda.receitaId !== filtroReceita) {
            return false;
        }
        
        return true;
    });
    
    // Ordenar por data (mais recente primeiro)
    vendasFiltradas.sort((a, b) => new Date(b.data) - new Date(a.data));
    
    // Exibir vendas filtradas
    vendasFiltradas.forEach(venda => {
        const card = document.createElement('div');
        card.className = 'sale-card';
        
        // Calcular custo total
        const custoTotal = venda.itensUtilizados.reduce((total, item) => total + item.custo, 0);
        
        card.innerHTML = `
            <div class="sale-header">
                <div class="sale-title">${venda.receitaNome}</div>
                <div class="sale-date">${formatarData(venda.data)}</div>
            </div>
            <div>Quantidade: ${venda.quantidade}</div>
            <div>Custo Total: ${formatarMoeda(custoTotal)}</div>
            <button class="btn btn-secondary btn-detalhes-venda" data-id="${venda.id}">Ver Detalhes</button>
            <button class="btn btn-danger btn-cancelar-venda" data-id="${venda.id}">Cancelar Venda</button>
            <div class="sale-details hidden" id="detalhes-venda-${venda.id}">
                <h4>Itens Utilizados:</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Quantidade</th>
                            <th>Unidade de Medida</th>
                            <th>Custo</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${venda.itensUtilizados.map(item => `
                            <tr>
                                <td>${item.nome}</td>
                                <td>${item.quantidadeUsada.toFixed(2)} ${item.unidade}</td>
                                <td>${item.quantidadeMedida.toFixed(0)} ${item.unidadeMedida}</td>
                                <td>${formatarMoeda(item.custo)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        container.appendChild(card);
    });
    
    // Adicionar eventos aos botões
    document.querySelectorAll('.btn-detalhes-venda').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            const detalhes = document.getElementById(`detalhes-venda-${id}`);
            detalhes.classList.toggle('hidden');
        });
    });
    
    document.querySelectorAll('.btn-cancelar-venda').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            cancelarVenda(id);
        });
    });
}

// Função para cancelar uma venda (reverter o estoque)
function cancelarVenda(vendaId) {
    if (!confirm('Tem certeza que deseja cancelar esta venda? Isso restaurará os itens ao estoque.')) {
        return;
    }
    
    const vendaIndex = vendas.findIndex(v => v.id === vendaId);
    if (vendaIndex === -1) {
        mostrarNotificacao('notification-vendas', 'Venda não encontrada!', 'error');
        return;
    }
    
    const venda = vendas[vendaIndex];
    
    // Restaurar o estoque para o estado anterior à venda
    estoque = JSON.parse(JSON.stringify(venda.estoqueAntes));
    
    // Remover a venda do histórico
    vendas.splice(vendaIndex, 1);
    
    // Atualizar localStorage e interfaces
    atualizarLocalStorage();
    carregarEstoque();
    carregarVendas();
    
    mostrarNotificacao('notification-vendas', 'Venda cancelada e estoque restaurado com sucesso!', 'success');
}

// Função para extrair informações de um site via QR code
async function extrairInformacoesDoSite(url) {
    // Mostrar o modal de processamento
    toggleModal(true, "Acessando site...", "Aguarde enquanto processamos as informações do site.");
    
    try {
        // Mostrar o iframe com o site
        const iframeContainer = document.getElementById('iframe-container');
        const iframe = document.getElementById('web-iframe');
        
        iframe.src = url;
        iframeContainer.style.display = 'block';
        
        // Simular o processamento (em um ambiente real, isto seria substituído por código real de extração)
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // Dados simulados - em um ambiente real, estes dados seriam extraídos do site
        const dadosExtraidos = {
            nome: "Red Bull Energy Drink",
            quantidade: 1,
            unidade: "lata",
            unidadeMedida: "ml",
            quantidadeMedida: 250,
            preco: 7.99
        };
        
        // Preencher o formulário com os dados extraídos
        document.getElementById('codigo-item').value = url;
        document.getElementById('nome-item').value = dadosExtraidos.nome;
        document.getElementById('quantidade-item').value = dadosExtraidos.quantidade;
        document.getElementById('unidade-item').value = dadosExtraidos.unidade;
        document.getElementById('unidade-medida-item').value = dadosExtraidos.unidadeMedida;
        document.getElementById('quantidade-medida-item').value = dadosExtraidos.quantidadeMedida;
        document.getElementById('preco-item').value = dadosExtraidos.preco;
        
        // Esconder o modal
        toggleModal(false);
        
        // Mostrar uma mensagem de sucesso
        mostrarNotificacao('notification-estoque', 'Informações extraídas com sucesso!', 'success');
        
        return dadosExtraidos;
    } catch (error) {
        console.error("Erro ao extrair informações:", error);
        
        // Esconder o modal
        toggleModal(false);
        
        // Mostrar uma mensagem de erro
        mostrarNotificacao('notification-estoque', 'Erro ao extrair informações do site. ' + error.message, 'error');
        
        return null;
    } finally {
        // Esconder o iframe após a extração
        setTimeout(() => {
            document.getElementById('iframe-container').style.display = 'none';
        }, 5000);
    }
}

// Função para iniciar o scanner de código de barras
function iniciarScanner() {
    const scannerContainer = document.getElementById('scanner-container');
    scannerContainer.classList.remove('hidden');
    
    // Configuração do leitor HTML5QrCode
    html5QrCode = new Html5Qrcode("reader");
    
    // Configurações para o scanner
    const config = {
        fps: 10,
        qrbox: 250,
        supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
    };
    
    // Iniciar a câmera
    html5QrCode.start(
        { facingMode: "environment" },
        config,
        onScanSuccess,
        onScanFailure
    ).catch(err => {
        console.error("Erro ao iniciar o scanner: ", err);
        document.getElementById('scanner-result').innerHTML = 
            `<div class="notification notification-error">Erro ao iniciar o scanner: ${err.message}</div>`;
    });
}

// Função chamada quando o scan é bem-sucedido
async function onScanSuccess(decodedText) {
    // Parar o scanner após o sucesso
    html5QrCode.stop().then(() => {
        console.log('Scanner parado');
    }).catch(err => {
        console.error('Erro ao parar o scanner:', err);
    });
    
    // Verificar se o texto decodificado é uma URL
    if (decodedText.startsWith('http')) {
        // Atualizar a interface
        document.getElementById('scanner-result').innerHTML = 
            `<div class="notification notification-info">QR code com URL detectado. Tentando extrair informações...</div>`;
        
        // Atualizar o campo de código
        document.getElementById('codigo-item').value = decodedText;
        
        // Tentar extrair informações do site
        await extrairInformacoesDoSite(decodedText);
    } else {
        // É um código normal (não URL)
        // Atualizar a interface
        document.getElementById('scanner-result').innerHTML = 
            `<div class="notification notification-success">Código escaneado com sucesso: ${decodedText}</div>`;
        document.getElementById('codigo-item').value = decodedText;
        
        // Verificar se já existe um produto com esse código no estoque
        const produtoExistente = estoque.find(item => item.codigo === decodedText);
        
        if (produtoExistente) {
            // Preencher o formulário com os dados do produto
            document.getElementById('nome-item').value = produtoExistente.nome;
            document.getElementById('quantidade-item').value = produtoExistente.quantidade;
            document.getElementById('unidade-item').value = produtoExistente.unidade;
            document.getElementById('unidade-medida-item').value = produtoExistente.unidadeMedida || 'ml';
            document.getElementById('quantidade-medida-item').value = produtoExistente.quantidadeMedida || '';
            document.getElementById('preco-item').value = produtoExistente.preco || '';
            
            // Modificar o botão de submit para edição
            const submitBtn = document.querySelector('#form-adicionar-estoque button[type="submit"]');
            submitBtn.textContent = 'Atualizar Item';
            const index = estoque.findIndex(item => item.codigo === decodedText);
            submitBtn.setAttribute('data-edicao', index);
        } else {
            // Verificar se existe um material com esse código no catálogo
            const materialExistente = encontrarMaterialPorCodigo(decodedText);
            
            if (materialExistente) {
                // Preencher o formulário com os dados do material
                document.getElementById('nome-item').value = materialExistente.nome;
                document.getElementById('quantidade-item').value = 1;
                document.getElementById('unidade-item').value = materialExistente.unidade;
                document.getElementById('unidade-medida-item').value = materialExistente.unidadeMedida;
                document.getElementById('quantidade-medida-item').value = materialExistente.quantidadeMedida;
                document.getElementById('preco-item').value = materialExistente.ultimoPreco;
            }
        }
    }
}

// Função chamada quando ocorre um erro no scan
function onScanFailure(error) {
    // Não mostrar erros de scan normais (como quando nenhum código é encontrado)
    // console.error(`Erro no scan: ${error}`);
}

// Função para parar o scanner
function pararScanner() {
    if (html5QrCode) {
        html5QrCode.stop().then(() => {
            console.log('Scanner parado');
            document.getElementById('scanner-container').classList.add('hidden');
        }).catch(err => {
            console.error('Erro ao parar o scanner:', err);
        });
    }
}

// Evento para mostrar a data/hora atual
function atualizarDataHora() {
    const agora = new Date();
    const dataFormatada = agora.toLocaleDateString('pt-BR');
    const horaFormatada = agora.toLocaleTimeString('pt-BR');
    document.getElementById('date-time').textContent = `${dataFormatada} ${horaFormatada}`;
}

// Configurar eventos quando o DOM estiver carregado
document.addEventListener('DOMContentLoaded', function() {
    // Garantir que o modal esteja oculto ao iniciar
    const modalElement = document.getElementById('processing-modal');
    if (modalElement) {
        modalElement.classList.add('hidden');
    }
    
    // Inicializar IDs para itens de estoque e materiais
    estoque.forEach((item, index) => {
        if (!item.id) {
            item.id = gerarId();
        }
    });
    
    materiais.forEach((material, index) => {
        if (!material.id) {
            material.id = gerarId();
        }
        
        // Garantir que o histórico de preços existe
        if (!material.historicoPrecos) {
            material.historicoPrecos = [{
                data: material.dataCadastro || new Date().toISOString(),
                preco: material.ultimoPreco || 0
            }];
        }
    });
    
    receitas.forEach(receita => {
        if (!receita.id) {
            receita.id = gerarId();
        }
    });
    
    vendas.forEach(venda => {
        if (!venda.id) {
            venda.id = gerarId();
        }
    });
    
    atualizarLocalStorage();
    
    // Carregar dados nas interfaces
    carregarEstoque();
    carregarMateriais();
    carregarReceitas();
    carregarVendas();
    
    // Eventos de navegação
    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Atualizar navegação
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            this.classList.add('active');
            
            // Mostrar página correspondente
            const pagina = this.getAttribute('data-page');
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            document.getElementById(`${pagina}-page`).classList.add('active');
        });
    });
    
    // Eventos das abas
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', function() {
            // Atualizar botões
            const parent = this.parentElement;
            parent.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Mostrar conteúdo correspondente
            const tab = this.getAttribute('data-tab');
            const container = parent.parentElement;
            container.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
        });
    });
    
    // Evento para pesquisar no estoque
    document.getElementById('pesquisar-estoque').addEventListener('input', function() {
        const termo = this.value.toLowerCase();
        document.querySelectorAll('#tabela-estoque tbody tr').forEach(tr => {
            const nome = tr.children[1].textContent.toLowerCase();
            const codigo = tr.children[0].textContent.toLowerCase();
            
            if (nome.includes(termo) || codigo.includes(termo)) {
                tr.style.display = '';
            } else {
                tr.style.display = 'none';
            }
        });
    });
    
    // Evento para pesquisar materiais
    document.getElementById('pesquisar-materiais').addEventListener('input', function() {
        const termo = this.value.toLowerCase();
        document.querySelectorAll('#tabela-materiais tbody tr').forEach(tr => {
            const nome = tr.children[1].textContent.toLowerCase();
            const codigo = tr.children[0].textContent.toLowerCase();
            
            if (nome.includes(termo) || codigo.includes(termo)) {
                tr.style.display = '';
            } else {
                tr.style.display = 'none';
            }
        });
    });
    
    // Evento para pesquisar receitas
    document.getElementById('pesquisar-receita').addEventListener('input', function() {
        const termo = this.value.toLowerCase();
        document.querySelectorAll('.recipe-card').forEach(card => {
            const nome = card.querySelector('h3').textContent.toLowerCase();
            
            if (nome.includes(termo)) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
    });
    
    // Evento para pesquisar vendas
    if (document.getElementById('pesquisar-vendas')) {
        document.getElementById('pesquisar-vendas').addEventListener('input', function() {
            carregarVendas();
        });
    }
    
    // Evento para filtrar vendas
    if (document.getElementById('btn-filtrar-vendas')) {
        document.getElementById('btn-filtrar-vendas').addEventListener('click', function() {
            carregarVendas();
        });
    }
    
    // Evento para limpar filtros de vendas
    if (document.getElementById('btn-limpar-filtros')) {
        document.getElementById('btn-limpar-filtros').addEventListener('click', function() {
            document.getElementById('filtro-data-inicio').value = '';
            document.getElementById('filtro-data-fim').value = '';
            document.getElementById('filtro-receita').value = '';
            document.getElementById('pesquisar-vendas').value = '';
            carregarVendas();
        });
    }
    
    // Evento para adicionar item ao estoque
    document.getElementById('form-adicionar-estoque').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const codigo = document.getElementById('codigo-item').value;
        const nome = document.getElementById('nome-item').value;
        const quantidade = parseFloat(document.getElementById('quantidade-item').value);
        const unidade = document.getElementById('unidade-item').value;
        const unidadeMedida = document.getElementById('unidade-medida-item').value;
        const quantidadeMedida = parseFloat(document.getElementById('quantidade-medida-item').value) || 0;
        const preco = parseFloat(document.getElementById('preco-item').value) || 0;
        
        // Adicionar ou atualizar o material no catálogo
        adicionarOuAtualizarMaterial(codigo, nome, unidade, unidadeMedida, quantidadeMedida, preco);
        
        // Verificar se é uma edição
        const submitBtn = document.querySelector('#form-adicionar-estoque button[type="submit"]');
        const indexEdicao = submitBtn.getAttribute('data-edicao');
        
        if (indexEdicao !== null && indexEdicao !== undefined) {
            // Edição de item existente
            estoque[indexEdicao].codigo = codigo;
            estoque[indexEdicao].nome = nome;
            estoque[indexEdicao].quantidade = quantidade;
            estoque[indexEdicao].unidade = unidade;
            estoque[indexEdicao].unidadeMedida = unidadeMedida;
            estoque[indexEdicao].quantidadeMedida = quantidadeMedida;
            estoque[indexEdicao].preco = preco;
            
            // Resetar o botão
            submitBtn.textContent = 'Adicionar ao Estoque';
            submitBtn.removeAttribute('data-edicao');
            
            mostrarNotificacao('notification-estoque', 'Item atualizado com sucesso!', 'success');
        } else {
            // Novo item
            const novoItem = {
                id: gerarId(),
                codigo: codigo,
                nome: nome,
                quantidade: quantidade,
                unidade: unidade,
                unidadeMedida: unidadeMedida,
                quantidadeMedida: quantidadeMedida,
                preco: preco,
                dataAdicao: new Date().toISOString()
            };
            
            estoque.push(novoItem);
            mostrarNotificacao('notification-estoque', 'Item adicionado com sucesso!', 'success');
        }
        
        // Atualizar localStorage e interface
        atualizarLocalStorage();
        carregarEstoque();
        carregarMateriais();
        atualizarSelectsIngredientes();
        
        // Limpar o formulário
        this.reset();
        document.getElementById('codigo-item').value = '';
        document.getElementById('scanner-result').innerHTML = '';
    });
    
    // Evento para adicionar material
    document.getElementById('form-adicionar-material').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const codigo = document.getElementById('codigo-material').value;
        const nome = document.getElementById('nome-material').value;
        const unidade = document.getElementById('unidade-material').value;
        const unidadeMedida = document.getElementById('unidade-medida-material').value;
        const quantidadeMedida = parseFloat(document.getElementById('quantidade-medida-material').value) || 0;
        const preco = parseFloat(document.getElementById('preco-material').value) || 0;
        
        // Adicionar ou atualizar o material
        adicionarOuAtualizarMaterial(codigo, nome, unidade, unidadeMedida, quantidadeMedida, preco);
        
        // Atualizar localStorage e interface
        atualizarLocalStorage();
        carregarMateriais();
        
        // Resetar o botão de submit caso esteja em modo de edição
        const submitBtn = document.querySelector('#form-adicionar-material button[type="submit"]');
        submitBtn.textContent = 'Adicionar Material';
        submitBtn.removeAttribute('data-edicao');
        
        // Limpar o formulário
        this.reset();
        
        mostrarNotificacao('notification-materiais', 'Material cadastrado com sucesso!', 'success');
    });
    
    // Evento para adicionar receita
    document.getElementById('form-adicionar-receita').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const nome = document.getElementById('nome-receita').value;
        const descricao = document.getElementById('descricao-receita').value;
        
        // Coletar ingredientes
        const ingredientes = [];
        document.querySelectorAll('.ingrediente-item').forEach(item => {
            const select = item.querySelector('.ingrediente-select');
            if (select.value) {
                const quantidade = parseFloat(item.querySelector('.ingrediente-quantidade').value);
                const unidadeMedidaSelect = item.querySelector('.ingrediente-unidade-medida');
                
                ingredientes.push({
                    id: select.value,
                    nome: select.options[select.selectedIndex].text,
                    quantidade: quantidade,
                    unidadeMedida: unidadeMedidaSelect.value
                });
            }
        });
        
        // Verificar se tem ingredientes
        if (ingredientes.length === 0) {
            alert('Adicione pelo menos um ingrediente à receita!');
            return;
        }
        
        // Verificar se é uma edição
        const submitBtn = document.querySelector('#form-adicionar-receita button[type="submit"]');
        const indexEdicao = submitBtn.getAttribute('data-edicao');
        
        if (indexEdicao !== null && indexEdicao !== undefined) {
            // Edição de receita existente
            receitas[indexEdicao].nome = nome;
            receitas[indexEdicao].descricao = descricao;
            receitas[indexEdicao].ingredientes = ingredientes;
            
            // Resetar o botão
            submitBtn.textContent = 'Salvar Receita';
            submitBtn.removeAttribute('data-edicao');
            
            mostrarNotificacao('notification-estoque', 'Receita atualizada com sucesso!', 'success');
        } else {
            // Nova receita
            const novaReceita = {
                id: gerarId(),
                nome: nome,
                descricao: descricao,
                ingredientes: ingredientes,
                dataCriacao: new Date().toISOString()
            };
            
            receitas.push(novaReceita);
            mostrarNotificacao('notification-estoque', 'Receita adicionada com sucesso!', 'success');
        }
        
        // Atualizar localStorage e interface
        atualizarLocalStorage();
        carregarReceitas();
        
        // Limpar o formulário
        this.reset();
        document.getElementById('lista-ingredientes').innerHTML = '';
        adicionarCampoIngrediente();  // Adicionar um campo vazio de ingrediente
        
        // Mudar para a aba de listar receitas
        document.querySelector('[data-tab="listar-receitas"]').click();
    });
    
    // Evento para adicionar ingrediente à receita
    document.getElementById('adicionar-ingrediente').addEventListener('click', function() {
        adicionarCampoIngrediente();
    });
    
    // Evento para selecionar receita para remoção de estoque
    document.getElementById('selecionar-receita').addEventListener('change', function() {
        const index = this.value;
        if (index) {
            carregarDetalhesReceita(index);
        } else {
            document.getElementById('detalhes-receita').classList.add('hidden');
        }
    });
    
    // Evento para atualizar cálculos quando a quantidade de receitas mudar
    document.getElementById('quantidade-receitas').addEventListener('input', function() {
        const receitaIndex = document.getElementById('selecionar-receita').value;
        if (receitaIndex) {
            carregarDetalhesReceita(receitaIndex);
        }
    });
    
    // Evento para confirmar produção (remover ingredientes do estoque)
    document.getElementById('confirmar-remocao').addEventListener('click', function() {
        // Mostrar modal de processamento
        toggleModal(true, "Processando produção...", "Aguarde enquanto atualizamos o estoque.");
        
        setTimeout(() => {
            const selectReceita = document.getElementById('selecionar-receita');
            const index = selectReceita.value;
            const quantidade = parseInt(document.getElementById('quantidade-receitas').value) || 1;
            
            if (index) {
                const sucesso = produzirReceita(index, quantidade);
                
                if (sucesso) {
                    toggleModal(false);
                    mostrarNotificacao('notification-estoque', `Produção de ${quantidade} ${quantidade > 1 ? 'unidades' : 'unidade'} concluída com sucesso!`, 'success');
                    
                    // Atualizar a interface
                    carregarEstoque();
                    carregarDetalhesReceita(index);
                    carregarVendas();
                    
                    // Mostrar a aba de listar estoque
                    document.querySelector('[data-tab="listar-estoque"]').click();
                } else {
                    toggleModal(false);
                    mostrarNotificacao('notification-estoque', 'Não foi possível produzir a receita. Verifique o estoque!', 'error');
                }
            } else {
                toggleModal(false);
                mostrarNotificacao('notification-estoque', 'Selecione uma receita primeiro!', 'error');
            }
        }, 300);
    });
    
    // Evento para iniciar scanner
    document.getElementById('iniciar-scanner').addEventListener('click', iniciarScanner);
    
    // Evento para parar scanner
    document.getElementById('parar-scanner').addEventListener('click', pararScanner);
    
    // Adicionar um campo de ingrediente inicial
    if (document.getElementById('lista-ingredientes')) {
        adicionarCampoIngrediente();
    }
    
    // Iniciar o relógio
    atualizarDataHora();
    setInterval(atualizarDataHora, 1000);
});

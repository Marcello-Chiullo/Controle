<!-- PARTE 1 HTML-->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deia Cakes Controle Gerencial</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- Bibliotecas originais -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.4/html5-qrcode.min.js"></script>
    <style>
        /* Estilos Gerais */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #ff85a2;
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .header-logo {
            display: flex;
            align-items: center;
        }
        
        .header-logo img {
            height: 60px;
            margin-left: 15px;
        }
        
        nav {
            background-color: #ffb5c8;
            padding: 10px 0;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        nav ul li {
            margin-right: 20px;
        }
        
        nav ul li a {
            color: #333;
            text-decoration: none;
            font-weight: 500;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        
        nav ul li a:hover, nav ul li a.active {
            background-color: #ff85a2;
            color: white;
        }
        
        h1, h2, h3 {
            margin-top: 0;
            color: #333;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            padding: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 2px;
        }
        
        .btn-primary {
            background-color: #ff85a2;
            color: white;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        table th, table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        table th {
            background-color: #f4f4f4;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Estilos de Página */
        .page-content {
            display: none;
        }
        
        .page-content.active {
            display: block;
        }
        
        /* Estilos do Scanner */
        #reader {
            width: 100%;
            height: 300px;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .scanner-container {
            margin-top: 20px;
        }
        
        /* Estilos de Formulários */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .form-row {
            display: flex;
            margin: 0 -10px;
        }
        
        .form-col {
            flex: 1;
            padding: 0 10px;
        }
        
        /* Animações */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        /* Notificações */
        .notification {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .notification-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .notification-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .notification-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        .notification-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* Estilos para Receitas */
        .recipe-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        
        .recipe-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        
        .ingredients-table {
            margin-top: 10px;
        }
        
        .tab-buttons {
            display: flex;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: 10px 20px;
            border: none;
            background-color: #f1f1f1;
            cursor: pointer;
            transition: background-color 0.3s;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        .tab-button.active {
            background-color: #ff85a2;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        /* Modal para carregamento e feedback */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            max-width: 80%;
            width: 500px;
            text-align: center;
        }
        
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #ff85a2;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Estilos para área de vendas */
        .sale-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .sale-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .sale-title {
            font-weight: bold;
            font-size: 18px;
        }
        
        .sale-date {
            color: #666;
        }
        
        .sale-details {
            margin-top: 10px;
        }
        
        /* Novas classes para preços de receitas */
        .recipe-pricing {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        
        .recipe-price-item {
            text-align: center;
            flex: 1;
        }
        
        .recipe-price-label {
            font-size: 12px;
            color: #666;
        }
        
        .recipe-price-value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        
        .recipe-price-value.highlight {
            color: #ff85a2;
        }
        
        /* Estilos para tela de login */
        #user-info {
            position: absolute;
            top: 10px;
            right: 20px;
            color: white;
            font-size: 14px;
        }
        
        #btn-logout {
            margin-left: 10px;
            background: transparent;
            border: 1px solid white;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            cursor: pointer;
        }
        
        #login-form {
            max-width: 400px;
            margin: 50px auto;
        }
        
        /* Novo estilo para resumo de vendas */
        .venda-resumo-financeiro {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            border: 1px solid #ddd;
        }
        
        .venda-resumo-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .venda-resumo-item {
            text-align: center;
        }
        
        .venda-resumo-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .venda-resumo-valor {
            font-size: 18px;
            font-weight: bold;
        }
        
        .venda-resumo-valor.lucro-positivo {
            color: #28a745;
        }
        
        .venda-resumo-valor.lucro-negativo {
            color: #dc3545;
        }
        
        /* Estilos para histórico de materiais */
        .material-historico-toggle {
            margin-left: 10px;
            font-size: 12px;
            cursor: pointer;
            color: #6c757d;
            text-decoration: underline;
        }
        
        .material-historico-container {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <header>
       <div class="header-content">
           <h1>Deia Cakes Controle Gerencial</h1>
           <div id="user-info" class="hidden">
               <span id="user-email"></span>
               <button id="btn-logout">Sair</button>
           </div>
           <div>
               <span id="date-time"></span>
           </div>
       </div>
    </header>
    <nav>
        <ul>
            <li><a href="#estoque" class="nav-link active" data-page="estoque">Estoque</a></li>
            <li><a href="#materiais" class="nav-link" data-page="materiais">Materiais</a></li>
            <li><a href="#receitas" class="nav-link" data-page="receitas">Receitas</a></li>
            <li><a href="#vendas" class="nav-link" data-page="vendas">Vendas</a></li>
        </ul>
    </nav>
    
    <!-- Página de Estoque -->
    <div class="container">
        <div class="page-content active" id="estoque-page">
            <h2>Gestão de Estoque</h2>
            
            <div class="card">
                <h3>Itens em Estoque</h3>
                <div id="notification-estoque"></div>
                <input type="text" id="pesquisar-estoque" class="form-control" placeholder="Pesquisar item..." style="margin-bottom: 20px;">
                
                <table id="tabela-estoque">
                    <thead>
                        <tr>
                            <th>Código</th>
                            <th>Nome</th>
                            <th>Quantidade</th>
                            <th>Unidade</th>
                            <th>Unidade de Medida</th>
                            <th>Preço (R$)</th>
                            <th>Data de Adição</th>
                        </tr>
                    </thead>
                    <tbody id="itens-estoque">
                        <!-- Os itens do estoque serão adicionados aqui dinamicamente -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Página de Materiais -->
        <div class="page-content" id="materiais-page">
            <h2>Catálogo de Materiais</h2>
            
            <div class="tab-buttons">
                <button class="tab-button active" data-tab="listar-materiais">Listar Materiais</button>
                <button class="tab-button" data-tab="adicionar-item">Adicionar Item</button>
            </div>
            
            <!-- Tab: Listar Materiais -->
            <div class="tab-content active" id="listar-materiais">
                <div class="card">
                    <h3>Materiais Cadastrados</h3>
                    <div id="notification-materiais"></div>
                    <input type="text" id="pesquisar-materiais" class="form-control" placeholder="Pesquisar material..." style="margin-bottom: 20px;">
                    
                    <table id="tabela-materiais">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Nome</th>
                                <th>Unidade</th>
                                <th>Unidade de Medida</th>
                                <th>Quantidade por Unidade</th>
                                <th>Data da Compra</th>
                                <th>Preço (R$)</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="itens-materiais">
                            <!-- Os materiais serão adicionados aqui dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Tab: Adicionar Item -->
            <div class="tab-content" id="adicionar-item">
                <div class="card">
                    <h3>Adicionar Novo Item</h3>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <button id="iniciar-scanner" class="btn btn-primary">Escanear Código de Barras/QR</button>
                            <div class="scanner-container hidden" id="scanner-container">
                                <div id="reader"></div>
                                <div id="scanner-result"></div>
                                <button id="parar-scanner" class="btn btn-secondary" style="margin-top: 10px;">Parar Scanner</button>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="codigo-material">Código do Item:</label>
                                <input type="text" id="codigo-material" class="form-control" placeholder="Código ou código de barras">
                            </div>
                        </div>
                    </div>
                    
                    <form id="form-adicionar-material">
                        <div class="form-group">
                            <label for="nome-material">Nome do Item:</label>
                            <input type="text" id="nome-material" class="form-control" placeholder="Ex: Farinha de Trigo" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="quantidade-material">Quantidade:</label>
                                    <input type="number" id="quantidade-material" class="form-control" min="0" step="1" value="1" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="unidade-material">Unidade:</label>
                                    <select id="unidade-material" class="form-control" required>
                                        <option value="un">Unidades (un)</option>
                                        <option value="cx">Caixas (cx)</option>
                                        <option value="pct">Pacotes (pct)</option>
                                        <option value="lata">Latas (lata)</option>
                                        <option value="garrafa">Garrafas (garrafa)</option>
                                        <option value="caixa">Caixas (caixa)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="unidade-medida-material">Unidade de Medida:</label>
                                    <select id="unidade-medida-material" class="form-control" required>
                                        <option value="kg">Quilogramas (kg)</option>
                                        <option value="g">Gramas (g)</option>
                                        <option value="l">Litros (l)</option>
                                        <option value="ml">Mililitros (ml)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="quantidade-medida-material">Quantidade por Unidade:</label>
                                    <input type="number" id="quantidade-medida-material" class="form-control" min="0" step="0.01" required placeholder="Ex: 350 (para 350ml)">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="preco-material">Preço (R$):</label>
                                    <input type="number" id="preco-material" class="form-control" min="0" step="0.01" placeholder="0.00" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="data-compra-material">Data da Compra:</label>
                                    <input type="date" id="data-compra-material" class="form-control">
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Adicionar ao Estoque</button>
                    </form>
                </div>
            </div>
        </div>
        <!-- PARTE 2: PÁGINA DE RECEITAS -->
    
<!-- Página de Receitas -->
<div class="page-content" id="receitas-page">
    <h2>Gestão de Receitas</h2>
    
    <div class="tab-buttons">
        <button class="tab-button active" data-tab="listar-receitas">Listar Receitas</button>
        <button class="tab-button" data-tab="adicionar-receita">Adicionar Receita</button>
    </div>
    
    <!-- Tab: Listar Receitas -->
    <div class="tab-content active" id="listar-receitas">
        <div class="card">
            <h3>Receitas Cadastradas</h3>
            <input type="text" id="pesquisar-receita" class="form-control" placeholder="Pesquisar receita..." style="margin-bottom: 20px;">
            
            <div id="lista-receitas">
                <!-- As receitas serão adicionadas aqui dinamicamente -->
            </div>
        </div>
    </div>
    
    <!-- Tab: Adicionar Receita -->
    <div class="tab-content" id="adicionar-receita">
        <div class="card">
            <h3>Adicionar Nova Receita</h3>
            
            <form id="form-adicionar-receita">
                <div class="form-group">
                    <label for="nome-receita">Nome da Receita:</label>
                    <input type="text" id="nome-receita" class="form-control" placeholder="Ex: Bolo de Chocolate" required>
                </div>
                
                <div class="form-group">
                    <label for="descricao-receita">Descrição:</label>
                    <textarea id="descricao-receita" class="form-control" rows="3" placeholder="Descreva brevemente a receita..."></textarea>
                </div>
                
                <h4>Ingredientes</h4>
                <div id="lista-ingredientes">
                    <!-- Os ingredientes serão adicionados aqui dinamicamente -->
                </div>
                
                <button type="button" id="adicionar-ingrediente" class="btn btn-secondary">+ Adicionar Ingrediente</button>
                
                <div class="recipe-pricing" style="margin-top: 20px;">
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Custo de Produção</div>
                        <div id="custo-producao" class="recipe-price-value">R$ 0,00</div>
                    </div>
                    
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Custos Variados (10%)</div>
                        <div id="custos-variados" class="recipe-price-value">R$ 0,00</div>
                    </div>
                    
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Preço Estimado (150%)</div>
                        <div id="preco-estimado" class="recipe-price-value">R$ 0,00</div>
                    </div>
                    
                    <div class="recipe-price-item">
                        <div class="form-group">
                            <label for="preco-venda" class="recipe-price-label">Preço de Venda Final</label>
                            <input type="number" id="preco-venda" class="form-control" min="0" step="0.01" placeholder="0.00" required>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Salvar Receita</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- PARTE 3: PÁGINA DE VENDAS E MODAL (MODIFICADA) -->

<!-- Página de Vendas -->
<div class="page-content" id="vendas-page">
    <h2>Histórico de Vendas</h2>
    
    <div class="tab-buttons">
        <button class="tab-button active" data-tab="listar-vendas">Histórico de Vendas</button>
        <button class="tab-button" data-tab="registrar-venda">Registrar Venda</button>
    </div>
    
    <!-- Tab: Listar Vendas -->
    <div class="tab-content active" id="listar-vendas">
        <div class="card">
            <h3>Registro de Vendas</h3>
            <div id="notification-vendas"></div>
            <input type="text" id="pesquisar-vendas" class="form-control" placeholder="Pesquisar vendas..." style="margin-bottom: 20px;">
            
            <div class="form-row" style="margin-bottom: 20px;">
                <div class="form-col">
                    <div class="form-group">
                        <label for="filtro-data-inicio">Data Inicial:</label>
                        <input type="date" id="filtro-data-inicio" class="form-control">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="filtro-data-fim">Data Final:</label>
                        <input type="date" id="filtro-data-fim" class="form-control">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="filtro-receita">Receita:</label>
                        <select id="filtro-receita" class="form-control">
                            <option value="">Todas as receitas</option>
                            <!-- As receitas serão adicionadas aqui dinamicamente -->
                        </select>
                    </div>
                </div>
                <div class="form-col" style="display: flex; align-items: flex-end;">
                    <button id="btn-filtrar-vendas" class="btn btn-primary">Filtrar</button>
                    <button id="btn-limpar-filtros" class="btn btn-secondary" style="margin-left: 10px;">Limpar</button>
                </div>
            </div>
            
            <div id="lista-vendas">
                <!-- As vendas serão adicionadas aqui dinamicamente -->
            </div>
        </div>
    </div>
    
    <!-- Tab: Registrar Venda -->
    <div class="tab-content" id="registrar-venda">
        <div class="card">
            <h3>Registrar Nova Venda</h3>
            
            <div class="form-group">
                <label for="selecionar-receita-venda">Selecione uma Receita:</label>
                <select id="selecionar-receita-venda" class="form-control">
                    <option value="">Selecione uma receita...</option>
                    <!-- As receitas serão adicionadas aqui dinamicamente -->
                </select>
            </div>
            
            <div id="detalhes-receita-venda" class="hidden">
                <h4>Detalhes da Receita: <span id="nome-receita-selecionada-venda"></span></h4>
                
                <div class="recipe-pricing" style="margin: 15px 0;">
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Custo de Produção</div>
                        <div id="custo-producao-venda" class="recipe-price-value">R$ 0,00</div>
                    </div>
                    
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Custos Variados</div>
                        <div id="custos-variados-venda" class="recipe-price-value">R$ 0,00</div>
                    </div>
                    
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Preço de Venda</div>
                        <div id="preco-venda-venda" class="recipe-price-value highlight">R$ 0,00</div>
                    </div>
                </div>
                
                <form id="form-registrar-venda">
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="cliente-nome">Nome do Cliente:</label>
                                <input type="text" id="cliente-nome" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="cliente-telefone">Telefone:</label>
                                <input type="tel" id="cliente-telefone" class="form-control" placeholder="(00) 00000-0000">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="cliente-endereco">Endereço:</label>
                        <textarea id="cliente-endereco" class="form-control" rows="2"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="observacoes-venda">Observações:</label>
                        <textarea id="observacoes-venda" class="form-control" rows="2" placeholder="Motivo da compra, brindes, informações adicionais..."></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="custo-frete">Custo de Frete (R$):</label>
                                <input type="number" id="custo-frete" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="custo-decoracao">Custo de Decoração (R$):</label>
                                <input type="number" id="custo-decoracao" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="despesas-adicionais" title="Despesas que reduzirão o lucro, como brindes">Despesas Adicionais (R$):</label>
                                <input type="number" id="despesas-adicionais" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="quantidade-venda">Quantidade:</label>
                                <input type="number" id="quantidade-venda" class="form-control" min="1" value="1">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="data-venda">Data da Venda:</label>
                                <input type="date" id="data-venda" class="form-control">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="valor-total-venda">Valor Total (R$):</label>
                                <input type="number" id="valor-total-venda" class="form-control" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <table id="tabela-ingredientes-venda">
                        <thead>
                            <tr>
                                <th>Ingrediente</th>
                                <th>Quantidade Necessária</th>
                                <th>Estoque Atual</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="ingredientes-venda-selecionada">
                            <!-- Os ingredientes da receita serão adicionados aqui dinamicamente -->
                        </tbody>
                    </table>
                    
                    <div id="aviso-estoque-venda" class="notification hidden"></div>
                    
                    <!-- Adicionado: Resumo financeiro da venda -->
                    <div class="venda-resumo-financeiro">
                        <h4>Resumo Financeiro</h4>
                        <div class="venda-resumo-grid">
                            <div class="venda-resumo-item">
                                <div class="venda-resumo-label">Valor Total</div>
                                <div id="resumo-valor-total" class="venda-resumo-valor">R$ 0,00</div>
                            </div>
                            <div class="venda-resumo-item">
                                <div class="venda-resumo-label">Despesa</div>
                                <div id="resumo-despesa" class="venda-resumo-valor">R$ 0,00</div>
                            </div>
                            <div class="venda-resumo-item">
                                <div class="venda-resumo-label">Reinvestir</div>
                                <div id="resumo-reinvestir" class="venda-resumo-valor">R$ 0,00</div>
                            </div>
                            <div class="venda-resumo-item">
                                <div class="venda-resumo-label">Total Desp. Adic.</div>
                                <div id="resumo-desp-adic" class="venda-resumo-valor">R$ 0,00</div>
                            </div>
                            <div class="venda-resumo-item">
                                <div class="venda-resumo-label">Lucro</div>
                                <div id="resumo-lucro" class="venda-resumo-valor">R$ 0,00</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: right;">
                        <button type="submit" id="confirmar-venda" class="btn btn-success">Confirmar Venda</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal para processamento de dados -->
<div id="processing-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h3 id="modal-title">Processando...</h3>
        <div class="loader"></div>
        <p id="modal-message">Aguarde enquanto processamos as informações.</p>
    </div>
</div>

<!-- Modal para visualização de detalhes da venda -->
<div id="venda-details-modal" class="modal-overlay hidden">
    <div class="modal-content" style="width: 700px; max-width: 90%;">
        <div style="text-align: right;">
            <button id="fechar-detalhes-venda" class="btn btn-secondary">X</button>
        </div>
        <h3>Detalhes da Venda</h3>
        <div id="venda-details-content">
            <!-- Conteúdo dos detalhes da venda -->
        </div>
    </div>
</div>

<!-- Modal para editar venda -->
<div id="editar-venda-modal" class="modal-overlay hidden">
    <div class="modal-content" style="width: 700px; max-width: 90%;">
        <div style="text-align: right;">
            <button id="fechar-editar-venda" class="btn btn-secondary">X</button>
        </div>
        <h3>Editar Venda</h3>
        <form id="form-editar-venda">
            <input type="hidden" id="editar-venda-id">
            
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="editar-cliente-nome">Nome do Cliente:</label>
                        <input type="text" id="editar-cliente-nome" class="form-control" required>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="editar-cliente-telefone">Telefone:</label>
                        <input type="tel" id="editar-cliente-telefone" class="form-control" placeholder="(00) 00000-0000">
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="editar-cliente-endereco">Endereço:</label>
                <textarea id="editar-cliente-endereco" class="form-control" rows="2"></textarea>
            </div>
            
            <div class="form-group">
                <label for="editar-observacoes-venda">Observações:</label>
                <textarea id="editar-observacoes-venda" class="form-control" rows="2"></textarea>
            </div>
            
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="editar-custo-frete">Custo de Frete (R$):</label>
                        <input type="number" id="editar-custo-frete" class="form-control" min="0" step="0.01">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="editar-custo-decoracao">Custo de Decoração (R$):</label>
                        <input type="number" id="editar-custo-decoracao" class="form-control" min="0" step="0.01">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="editar-despesas-adicionais">Despesas Adicionais (R$):</label>
                        <input type="number" id="editar-despesas-adicionais" class="form-control" min="0" step="0.01">
                    </div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="editar-quantidade-venda">Quantidade:</label>
                        <input type="number" id="editar-quantidade-venda" class="form-control" min="1">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="editar-data-venda">Data da Venda:</label>
                        <input type="date" id="editar-data-venda" class="form-control">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="editar-valor-total-venda">Valor Total (R$):</label>
                        <input type="number" id="editar-valor-total-venda" class="form-control">
                    </div>
                </div>
            </div>
            
            <!-- Adicionado: Resumo financeiro da venda para edição -->
            <div class="venda-resumo-financeiro">
                <h4>Resumo Financeiro</h4>
                <div class="venda-resumo-grid">
                    <div class="venda-resumo-item">
                        <div class="venda-resumo-label">Valor Total</div>
                        <div id="editar-resumo-valor-total" class="venda-resumo-valor">R$ 0,00</div>
                    </div>
                    <div class="venda-resumo-item">
                        <div class="venda-resumo-label">Despesa</div>
                        <div id="editar-resumo-despesa" class="venda-resumo-valor">R$ 0,00</div>
                    </div>
                    <div class="venda-resumo-item">
                        <div class="venda-resumo-label">Reinvestir</div>
                        <div id="editar-resumo-reinvestir" class="venda-resumo-valor">R$ 0,00</div>
                    </div>
                    <div class="venda-resumo-item">
                        <div class="venda-resumo-label">Total Desp. Adic.</div>
                        <div id="editar-resumo-desp-adic" class="venda-resumo-valor">R$ 0,00</div>
                    </div>
                    <div class="venda-resumo-item">
                        <div class="venda-resumo-label">Lucro</div>
                        <div id="editar-resumo-lucro" class="venda-resumo-valor">R$ 0,00</div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px; text-align: right;">
                <button type="submit" class="btn btn-primary">Salvar Alterações</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de confirmação para exclusão -->
<div id="confirmar-exclusao-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h3>Confirmar Exclusão</h3>
        <p>Tem certeza que deseja excluir esta venda? Esta ação não pode ser desfeita.</p>
        <input type="hidden" id="excluir-venda-id">
        <div style="margin-top: 20px; text-align: right;">
            <button id="cancelar-exclusao" class="btn btn-secondary">Cancelar</button>
            <button id="confirmar-exclusao" class="btn btn-danger">Excluir</button>
        </div>
    </div>
</div>

<!-- Modal de login -->
<div id="login-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h3>Login</h3>
        <div id="login-notification" class="notification hidden"></div>
        
        <div class="form-group">
            <label for="login-email">Email:</label>
            <input type="email" id="login-email" class="form-control" placeholder="email@exemplo.com" required>
        </div>
        
        <div class="form-group">
            <label for="login-senha">Senha:</label>
            <input type="password" id="login-senha" class="form-control" placeholder="Sua senha" required>
        </div>
        
        <div style="margin-top: 20px; display: flex; justify-content: space-between;">
            <button id="btn-login" class="btn btn-primary" onclick="fazerLogin()">Entrar</button>
            <button id="btn-cadastrar" class="btn btn-secondary" onclick="fazerCadastro()">Cadastrar</button>
        </div>
    </div>
</div>
<script>
// PARTE 4: JAVASCRIPT (PRIMEIRA PARTE - FIREBASE E FUNÇÕES GLOBAIS)

// Funções utilitárias para seleção de elementos
function $(selector) {
    return document.querySelector(selector);
}

function $$(selector) {
    return document.querySelectorAll(selector);
}

// Configuração do Firebase
const firebaseConfig = {
    apiKey: "AIzaSyABzQdTgR9-Al-drNRMBcEb1dN76wUjqvY",
    authDomain: "deiacontrole-faabc.firebaseapp.com",
    databaseURL: "https://deiacontrole-faabc-default-rtdb.firebaseio.com",
    projectId: "deiacontrole-faabc",
    storageBucket: "deiacontrole-faabc.firebasestorage.app",
    messagingSenderId: "216368622292",
    appId: "1:216368622292:web:20522a4725c30907c92941",
};

// Inicializar Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
let currentUser = null;

// Variáveis globais
let estoque = JSON.parse(localStorage.getItem('estoque')) || [];
let materiais = JSON.parse(localStorage.getItem('materiais')) || [];
let receitas = JSON.parse(localStorage.getItem('receitas')) || [];
let vendas = JSON.parse(localStorage.getItem('vendas')) || [];
let html5QrCode;
let sincronizacaoAtiva = false;

// Função para atualizar o localStorage
function atualizarLocalStorage() {
    localStorage.setItem('estoque', JSON.stringify(estoque));
    localStorage.setItem('materiais', JSON.stringify(materiais));
    localStorage.setItem('receitas', JSON.stringify(receitas));
    localStorage.setItem('vendas', JSON.stringify(vendas));
    localStorage.setItem('ultimaAtualizacao', new Date().toISOString());
    
    // Sincronizar com nuvem
    sincronizarComNuvem();
}

// Função para sincronizar com o Firebase
function sincronizarComNuvem() {
    if (currentUser && !sincronizacaoAtiva) {
        const userId = currentUser.uid;
        database.ref('usuarios/' + userId).set({
            estoque: estoque,
            materiais: materiais,
            receitas: receitas,
            vendas: vendas,
            ultimaAtualizacao: new Date().toISOString()
        });
    }
}

// Função para mostrar uma notificação
function mostrarNotificacao(elemento, mensagem, tipo) {
    const notificacao = document.getElementById(elemento);
    if (!notificacao) return;
    
    notificacao.className = `notification notification-${tipo}`;
    notificacao.textContent = mensagem;
    
    // Esconder a notificação após 5 segundos
    setTimeout(() => {
        notificacao.className = 'notification hidden';
    }, 5000);
}

// Função para mostrar/esconder o modal de processamento
function toggleModal(show, title = "Processando...", message = "Aguarde enquanto processamos as informações.") {
    const modal = document.getElementById('processing-modal');
    if (!modal) return;
    
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-message').textContent = message;
    
    if (show) {
        modal.classList.remove('hidden');
        
        // Adicionar timer de segurança - fechará o modal após 10 segundos
        window.modalSafetyTimer = setTimeout(() => {
            modal.classList.add('hidden');
        }, 10000);
    } else {
        modal.classList.add('hidden');
        // Limpar o timer de segurança se o modal for fechado manualmente
        if (window.modalSafetyTimer) {
            clearTimeout(window.modalSafetyTimer);
        }
    }
}

// Função para formatar data
function formatarData(data) {
    const d = new Date(data);
    return `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getFullYear()}`;
}

// Função para formatar valor monetário
function formatarMoeda(valor) {
    return 'R$ ' + parseFloat(valor).toFixed(2).replace('.', ',');
}

// Função para gerar ID único
function gerarId() {
    return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// FUNÇÕES PARA ESTOQUE E MATERIAIS

// Função para encontrar um material pelo código
function encontrarMaterialPorCodigo(codigo) {
    // Encontra o material mais recente com o código informado
    const materiaisComCodigo = materiais.filter(m => m.codigo === codigo);
    if (materiaisComCodigo.length === 0) return null;
    
    // Ordena por data de cadastro decrescente (mais recente primeiro)
    materiaisComCodigo.sort((a, b) => new Date(b.dataCadastro) - new Date(a.dataCadastro));
    
    // Retorna o material mais recente
    return materiaisComCodigo[0];
}

// Função para adicionar ou atualizar um material no catálogo - MODIFICADA
function adicionarOuAtualizarMaterial(codigoMaterial, nomeMaterial, unidadeMaterial, unidadeMedidaMaterial, quantidadeMedidaMaterial, precoMaterial, dataCompra = null) {
    // Converter valores para números
    quantidadeMedidaMaterial = parseFloat(quantidadeMedidaMaterial);
    precoMaterial = parseFloat(precoMaterial);
    
    // Verificar se valores são válidos
    if (isNaN(quantidadeMedidaMaterial) || quantidadeMedidaMaterial <= 0) {
        alert('A quantidade por unidade deve ser um número válido maior que zero.');
        return null;
    }
    
    if (isNaN(precoMaterial) || precoMaterial <= 0) {
        alert('O preço deve ser um número válido maior que zero.');
        return null;
    }
    
    // MODIFICADO: Criar sempre um novo registro, mas manter referência do material existente
    const materialExistente = encontrarMaterialPorCodigo(codigoMaterial);
    
    // Criar novo material (sempre, mesmo que exista um com o mesmo código)
    const novoMaterial = {
        id: gerarId(),
        codigo: codigoMaterial,
        nome: nomeMaterial,
        unidade: unidadeMaterial,
        unidadeMedida: unidadeMedidaMaterial,
        quantidadeMedida: quantidadeMedidaMaterial,
        ultimoPreco: precoMaterial,
        precoMedio: materialExistente ? 
            ((materialExistente.precoMedio * materialExistente.historicoPrecos.length) + precoMaterial) / 
            (materialExistente.historicoPrecos.length + 1) : 
            precoMaterial,
        ultimaCompra: dataCompra || new Date().toISOString(),
        dataCadastro: new Date().toISOString(),
        historicoPrecos: [{
            data: dataCompra || new Date().toISOString(),
            preco: precoMaterial
        }]
    };
    
    materiais.push(novoMaterial);
    return novoMaterial.id;
}

// Função para adicionar item ao estoque
function adicionarItemEstoque(materialId, quantidade, preco = null) {
    const material = materiais.find(m => m.id === materialId);
    if (!material) return false;
    
    // Verificar se a quantidade é válida
    quantidade = parseFloat(quantidade);
    if (isNaN(quantidade) || quantidade <= 0) {
        alert('A quantidade deve ser um número válido maior que zero.');
        return false;
    }
    
    // Verificar se o item já existe no estoque
    const itemExistente = estoque.find(i => i.materialId === materialId);
    
    if (itemExistente) {
        // Atualizar item existente
        itemExistente.quantidade += quantidade;
        if (preco !== null) {
            itemExistente.preco = parseFloat(preco);
        }
        return true;
    } else {
        // Criar novo item
        const novoItem = {
            id: gerarId(),
            materialId: materialId,
            codigo: material.codigo,
            nome: material.nome,
            quantidade: quantidade,
            unidade: material.unidade,
            unidadeMedida: material.unidadeMedida,
            quantidadeMedida: material.quantidadeMedida,
            preco: preco !== null ? parseFloat(preco) : parseFloat(material.ultimoPreco),
            dataAdicao: new Date().toISOString()
        };
        
        estoque.push(novoItem);
        return true;
    }
}

// Função para remover item do estoque - FUNÇÃO MODIFICADA
function removerItemEstoque(materialId, quantidade, unidadeMedida) {
    const item = estoque.find(i => i.materialId === materialId);
    if (!item) return false;
    
    // Normalizar unidades para a menor unidade (g ou ml)
    let quantidadeNormalizada = quantidade;
    
    // Se a unidade de medida for passada, converter conforme necessário
    if (unidadeMedida) {
        // Converter KG para g, L para ml
        if (unidadeMedida.toLowerCase() === 'kg' && item.unidadeMedida.toLowerCase() === 'g') {
            quantidadeNormalizada *= 1000;
        } else if (unidadeMedida.toLowerCase() === 'l' && item.unidadeMedida.toLowerCase() === 'ml') {
            quantidadeNormalizada *= 1000;
        }
        // Converter g para kg, ml para l se necessário
        else if (unidadeMedida.toLowerCase() === 'g' && item.unidadeMedida.toLowerCase() === 'kg') {
            quantidadeNormalizada /= 1000;
        } else if (unidadeMedida.toLowerCase() === 'ml' && item.unidadeMedida.toLowerCase() === 'l') {
            quantidadeNormalizada /= 1000;
        }
    }
    
    // Converter a quantidade solicitada para unidades do estoque
    const quantidadeEmUnidades = quantidadeNormalizada / item.quantidadeMedida;
    
    // Verificar se a quantidade disponível é suficiente
    if (item.quantidade < quantidadeEmUnidades) {
        return false;
    }
    
    // Atualizar a quantidade
    item.quantidade -= quantidadeEmUnidades;
    
    // Se a quantidade ficar zero ou negativa, remover o item
    if (item.quantidade <= 0) {
        const index = estoque.findIndex(i => i.materialId === materialId);
        if (index !== -1) {
            estoque.splice(index, 1);
        }
    }
    
    return true;
}

// Função para adicionar estoque de volta (quando cancela uma venda)
function adicionarEstoqueDeVolta(materialId, quantidade, unidadeMedida) {
    // Essa função é o inverso de removerItemEstoque
    const item = estoque.find(i => i.materialId === materialId);
    const material = materiais.find(m => m.id === materialId);
    
    if (!item && !material) return false;
    
    // Normalizar unidades
    let quantidadeNormalizada = quantidade;
    
    if (unidadeMedida) {
        if (item) {
            // Usar o item atual do estoque
            if (unidadeMedida.toLowerCase() === 'kg' && item.unidadeMedida.toLowerCase() === 'g') {
                quantidadeNormalizada *= 1000;
            } else if (unidadeMedida.toLowerCase() === 'l' && item.unidadeMedida.toLowerCase() === 'ml') {
                quantidadeNormalizada *= 1000;
            } else if (unidadeMedida.toLowerCase() === 'g' && item.unidadeMedida.toLowerCase() === 'kg') {
                quantidadeNormalizada /= 1000;
            } else if (unidadeMedida.toLowerCase() === 'ml' && item.unidadeMedida.toLowerCase() === 'l') {
                quantidadeNormalizada /= 1000;
            }
            
            // Converter para unidades
            const quantidadeEmUnidades = quantidadeNormalizada / item.quantidadeMedida;
            
            // Adicionar de volta
            item.quantidade += quantidadeEmUnidades;
        } else if (material) {
            // Criar novo item no estoque se não existir
            const novoItem = {
                id: gerarId(),
                materialId: materialId,
                codigo: material.codigo,
                nome: material.nome,
                quantidade: quantidade / material.quantidadeMedida, // Converter para unidades
                unidade: material.unidade,
                unidadeMedida: material.unidadeMedida,
                quantidadeMedida: material.quantidadeMedida,
                preco: material.ultimoPreco,
                dataAdicao: new Date().toISOString()
            };
            
            estoque.push(novoItem);
        }
    }
    
    return true;
}

// Função para remover um material e todas suas referências
function removerMaterial(id) {
    if (!confirm('Tem certeza que deseja remover este material e todas as suas referências?')) {
        return;
    }
    
    // Remover do estoque
    estoque = estoque.filter(item => item.materialId !== id);
    
    // Remover das receitas - remover ingredientes que usam este material
    receitas.forEach(receita => {
        receita.ingredientes = receita.ingredientes.filter(ing => ing.materialId !== id);
    });
    
    // Remover do cadastro de materiais
    const index = materiais.findIndex(m => m.id === id);
    if (index !== -1) {
        materiais.splice(index, 1);
    }
    
    // Atualizar localStorage e recarregar interfaces
    atualizarLocalStorage();
    carregarMateriais();
    carregarEstoque();
    carregarReceitas();
    
    mostrarNotificacao('notification-materiais', 'Material removido com sucesso!', 'success');
}

// Função para carregar materiais na tabela - MODIFICADA
function carregarMateriais() {
    const tbody = document.getElementById('itens-materiais');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (materiais.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="8" style="text-align: center;">Nenhum material cadastrado.</td>';
        tbody.appendChild(tr);
        return;
    }
    
    // MODIFICADO: Exibir cada material como uma entrada separada, ordenado por data decrescente
    const materiaisOrdenados = [...materiais].sort((a, b) => new Date(b.dataCadastro) - new Date(a.dataCadastro));
    
    materiaisOrdenados.forEach((material, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${material.codigo || 'N/A'}</td>
            <td>${material.nome}</td>
            <td>${material.unidade}</td>
            <td>${material.unidadeMedida}</td>
            <td>${material.quantidadeMedida}</td>
            <td>${formatarData(material.ultimaCompra)}</td>
            <td>${formatarMoeda(material.ultimoPreco)}</td>
            <td>
                <button class="btn btn-primary btn-editar-material" data-id="${material.id}">Editar</button>
                <button class="btn btn-success btn-adicionar-estoque" data-id="${material.id}">+ Estoque</button>
                <button class="btn btn-danger btn-remover-material" data-id="${material.id}">Excluir</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
    
    // Adicionar eventos aos botões
    document.querySelectorAll('.btn-editar-material').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            const material = materiais.find(m => m.id === id);
            const index = materiais.indexOf(material);
            if (index !== -1) {
                editarMaterial(index);
            }
        });
    });
    
    document.querySelectorAll('.btn-adicionar-estoque').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            adicionarAoEstoque(id);
        });
    });
    
    document.querySelectorAll('.btn-remover-material').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            removerMaterial(id);
        });
    });
}

// Função para editar um material
function editarMaterial(index) {
    const material = materiais[index];
    if(!material) return;
    
    // Mudar para a aba de adicionar item
    const tabButton = document.querySelector('[data-tab="adicionar-item"]');
    if (tabButton) {
        tabButton.click();
    }
    
    // Preencher o formulário
    document.getElementById('codigo-material').value = material.codigo || '';
    document.getElementById('nome-material').value = material.nome;
    document.getElementById('unidade-material').value = material.unidade;
    document.getElementById('unidade-medida-material').value = material.unidadeMedida;
    document.getElementById('quantidade-medida-material').value = material.quantidadeMedida;
    document.getElementById('preco-material').value = material.ultimoPreco;
    
    // Quantidade para estoque
    document.getElementById('quantidade-material').value = 1;
    
    // Data de compra
    const dataCompra = document.getElementById('data-compra-material');
    if (dataCompra) {
        const data = new Date(material.ultimaCompra);
        dataCompra.value = data.toISOString().split('T')[0];
    }
    
    // Modificar o botão de submit
    const submitBtn = document.querySelector('#form-adicionar-material button[type="submit"]');
    if (submitBtn) {
        submitBtn.textContent = 'Atualizar Material';
        submitBtn.setAttribute('data-edicao', index);
    }
}

// Função para adicionar um material ao estoque
function adicionarAoEstoque(materialId) {
    const material = materiais.find(m => m.id === materialId);
    if (!material) return;
    
    // Mudar para a aba de adicionar item
    const tabButton = document.querySelector('[data-tab="adicionar-item"]');
    if (tabButton) {
        tabButton.click();
    }
    
    // Preencher o formulário com os dados do material
    document.getElementById('codigo-material').value = material.codigo || '';
    document.getElementById('nome-material').value = material.nome;
    document.getElementById('quantidade-material').value = 1;
    document.getElementById('unidade-material').value = material.unidade;
    document.getElementById('unidade-medida-material').value = material.unidadeMedida;
    document.getElementById('quantidade-medida-material').value = material.quantidadeMedida;
    document.getElementById('preco-material').value = material.ultimoPreco;
    
    // Data atual para compra
    const dataCompra = document.getElementById('data-compra-material');
    if (dataCompra) {
        const hoje = new Date();
        dataCompra.value = hoje.toISOString().split('T')[0];
    }
}

// Função para carregar o estoque na tabela
function carregarEstoque() {
    const tbody = document.getElementById('itens-estoque');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (estoque.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="7" style="text-align: center;">Nenhum item no estoque.</td>';
        tbody.appendChild(tr);
        return;
    }
    
    estoque.forEach((item) => {
        // Calcular a quantidade em unidade de medida (ex: ml restantes)
        const quantidadeTotalMedida = item.quantidade * (item.quantidadeMedida || 1);
        // Verificar se é um número fracionário
        const quantidadeFracionada = item.quantidade % 1 !== 0;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${item.codigo || 'N/A'}</td>
            <td>${item.nome}</td>
            <td>${item.quantidade.toFixed(2)} ${quantidadeFracionada ? `(${Math.floor(item.quantidade)} + ${((item.quantidade % 1) * 100).toFixed(0)}%)` : ''}</td>
            <td>${item.unidade}</td>
            <td>${quantidadeTotalMedida.toFixed(0)} ${item.unidadeMedida || 'N/A'}</td>
            <td>${formatarMoeda(item.preco || 0)}</td>
            <td>${formatarData(item.dataAdicao)}</td>
        `;
        tbody.appendChild(tr);
    });
}

// FUNÇÕES PARA SCANNER DE QR CODE/CÓDIGO DE BARRAS
function iniciarScanner() {
    const scannerContainer = document.getElementById('scanner-container');
    if (!scannerContainer) return;
    
    scannerContainer.classList.remove('hidden');
    
    html5QrCode = new Html5Qrcode("reader");
    const config = { fps: 10, qrbox: { width: 250, height: 250 } };
    
    html5QrCode.start(
        { facingMode: "environment" }, 
        config, 
        onScanSuccess, 
        onScanFailure
    );
}

function pararScanner() {
    if (html5QrCode && html5QrCode.isScanning) {
        html5QrCode.stop().then(() => {
            console.log('Scanner parado.');
            document.getElementById('scanner-container').classList.add('hidden');
        }).catch(err => {
            console.error('Erro ao parar o scanner:', err);
        });
    }
}

function onScanSuccess(decodedText, decodedResult) {
    console.log(`Código escaneado: ${decodedText}`);
    
    // Preencher o campo de código
    document.getElementById('codigo-material').value = decodedText;
    
    // Mostrar resultado
    document.getElementById('scanner-result').innerHTML = `
        <div class="notification notification-success">
            Código detectado: ${decodedText}
        </div>
    `;
    
    // Parar o scanner
    pararScanner();
    
    // Buscar informações do produto
    buscarInformacoesProduto(decodedText);
}

function onScanFailure(error) {
    // Silenciar erro para não encher o console
    // console.warn(`Erro ao escanear: ${error}`);
}

// Função para buscar informações do produto - MODIFICADA
function buscarInformacoesProduto(codigo) {
    // Verificar se o código já existe no catálogo
    const materialExistente = encontrarMaterialPorCodigo(codigo);
    
    if (materialExistente) {
        // Preencher formulário com dados existentes
        document.getElementById('nome-material').value = materialExistente.nome;
        document.getElementById('unidade-material').value = materialExistente.unidade;
        document.getElementById('unidade-medida-material').value = materialExistente.unidadeMedida;
        document.getElementById('quantidade-medida-material').value = materialExistente.quantidadeMedida;
        document.getElementById('preco-material').value = materialExistente.ultimoPreco;
        
        mostrarNotificacao('notification-materiais', 'Produto encontrado no catálogo!', 'success');
    } else {
        // Mostrar mensagem
        mostrarNotificacao('notification-materiais', 'Produto não encontrado no catálogo. Preencha os detalhes manualmente.', 'info');
    }
}

// Função para atualizar data/hora atual
function atualizarDataHora() {
    const elemento = document.getElementById('date-time');
    if (!elemento) return;
    
    const agora = new Date();
    const dataFormatada = agora.toLocaleDateString('pt-BR');
    const horaFormatada = agora.toLocaleTimeString('pt-BR');
    elemento.textContent = `${dataFormatada} ${horaFormatada}`;
}

// Funções de Autenticação e Login - NOVA
function mostrarTelaLogin() {
    document.getElementById('login-modal').classList.remove('hidden');
}

function esconderTelaLogin() {
    document.getElementById('login-modal').classList.add('hidden');
}

function fazerLogin() {
    const email = document.getElementById('login-email').value;
    const senha = document.getElementById('login-senha').value;
    
    if (!email || !senha) {
        mostrarNotificacao('login-notification', 'Preencha email e senha', 'error');
        return;
    }
    
    toggleModal(true, "Fazendo login...", "Por favor aguarde...");
    
    firebase.auth().signInWithEmailAndPassword(email, senha)
        .then((userCredential) => {
            // Login bem-sucedido
            currentUser = userCredential.user;
            
            // Mostrar email do usuário logado
            const userInfoEl = document.getElementById('user-info');
            if (userInfoEl) {
                userInfoEl.classList.remove('hidden');
                document.getElementById('user-email').textContent = currentUser.email;
            }
            
            // Esconder a tela de login
            esconderTelaLogin();
            
            // Verificar se há dados na nuvem
            iniciarSincronizacao();
            
            toggleModal(false);
        })
        .catch((error) => {
            toggleModal(false);
            mostrarNotificacao('login-notification', 'Erro ao fazer login: ' + error.message, 'error');
        });
}

function fazerCadastro() {
    const email = document.getElementById('login-email').value;
    const senha = document.getElementById('login-senha').value;
    
    if (!email || !senha || senha.length < 6) {
        mostrarNotificacao('login-notification', 'Email válido e senha com pelo menos 6 caracteres são necessários', 'error');
        return;
    }
    
    toggleModal(true, "Criando conta...", "Por favor aguarde...");
    
    firebase.auth().createUserWithEmailAndPassword(email, senha)
        .then((userCredential) => {
            currentUser = userCredential.user;
            
            // Mostrar email do usuário logado
            const userInfoEl = document.getElementById('user-info');
            if (userInfoEl) {
                userInfoEl.classList.remove('hidden');
                document.getElementById('user-email').textContent = currentUser.email;
            }
            
            // Esconder a tela de login
            esconderTelaLogin();
            
            // Salvar dados locais na nuvem
            sincronizarComNuvem();
            
            toggleModal(false);
            mostrarNotificacao('notification-estoque', 'Conta criada com sucesso!', 'success');
        })
        .catch((error) => {
            toggleModal(false);
            mostrarNotificacao('login-notification', 'Erro ao criar conta: ' + error.message, 'error');
        });
}

function iniciarSincronizacao() {
    if (!currentUser) return;
    
    const userId = currentUser.uid;
    sincronizacaoAtiva = true;
    
    // Escutar por mudanças nos dados
    database.ref('usuarios/' + userId).on('value', (snapshot) => {
        const dados = snapshot.val();
        if (dados) {
            const ultimaAtualizacaoLocal = localStorage.getItem('ultimaAtualizacao');
            
            // Verificar se os dados da nuvem são mais recentes
            if (!ultimaAtualizacaoLocal || new Date(dados.ultimaAtualizacao) > new Date(ultimaAtualizacaoLocal)) {
                console.log('Sincronizando dados da nuvem...');
                
                // Atualizar dados locais
                estoque = dados.estoque || [];
                materiais = dados.materiais || [];
                receitas = dados.receitas || [];
                vendas = dados.vendas || [];
                
                // Salvar no localStorage
                localStorage.setItem('estoque', JSON.stringify(estoque));
                localStorage.setItem('materiais', JSON.stringify(materiais));
                localStorage.setItem('receitas', JSON.stringify(receitas));
                localStorage.setItem('vendas', JSON.stringify(vendas));
                localStorage.setItem('ultimaAtualizacao', dados.ultimaAtualizacao);
                
                // Recarregar interfaces
                carregarEstoque();
                carregarMateriais();
                carregarReceitas();
                carregarVendas();
                
                mostrarNotificacao('notification-estoque', 'Dados sincronizados com sucesso!', 'success');
            }
        }
        sincronizacaoAtiva = false;
    });
}

// Configurar eventos
function setupEventListeners() {
    // Garantir que o modal esteja oculto ao iniciar
    const modalElement = document.getElementById('processing-modal');
    if (modalElement) {
        modalElement.classList.add('hidden');
    }

    // Eventos de navegação
    const navLinks = document.querySelectorAll('.nav-link');
    if (navLinks.length > 0) {
        navLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Atualizar navegação
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
                
                // Mostrar página correspondente
                const pagina = this.getAttribute('data-page');
                document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
                const pageElement = document.getElementById(`${pagina}-page`);
                if (pageElement) {
                    pageElement.classList.add('active');
                }
            });
        });
    }
   
    // Eventos das abas
    const tabButtons = document.querySelectorAll('.tab-button');
    if (tabButtons.length > 0) {
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Obter todos os botões na mesma tab
                const parent = this.parentElement;
                parent.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // Obter o ID da aba a ser mostrada
                const tabId = this.getAttribute('data-tab');
                
                // Encontrar o conteúdo da aba
                const tabContents = parent.parentElement.querySelectorAll('.tab-content');
                tabContents.forEach(content => {
                    content.classList.remove('active');
                });
                
                const tabContent = document.getElementById(tabId);
                if (tabContent) {
                    tabContent.classList.add('active');
                }
            });
        });
    }
   
    // Eventos de pesquisa
    ['pesquisar-estoque', 'pesquisar-materiais', 'pesquisar-receita', 'pesquisar-vendas'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('input', function() {
                const termo = this.value.toLowerCase();
                let itens;
                
                switch(id) {
                    case 'pesquisar-estoque':
                        itens = document.querySelectorAll('#tabela-estoque tbody tr');
                        itens.forEach(tr => {
                            const nome = tr.children[1].textContent.toLowerCase();
                            const codigo = tr.children[0].textContent.toLowerCase();
                            tr.style.display = (nome.includes(termo) || codigo.includes(termo)) ? '' : 'none';
                        });
                        break;
                    case 'pesquisar-materiais':
                        itens = document.querySelectorAll('#tabela-materiais tbody tr');
                        itens.forEach(tr => {
                            const nome = tr.children[1].textContent.toLowerCase();
                            const codigo = tr.children[0].textContent.toLowerCase();
                            tr.style.display = (nome.includes(termo) || codigo.includes(termo)) ? '' : 'none';
                        });
                        break;
                    case 'pesquisar-receita':
                        itens = document.querySelectorAll('.recipe-card');
                        itens.forEach(card => {
                            const nome = card.querySelector('h3').textContent.toLowerCase();
                            card.style.display = nome.includes(termo) ? '' : 'none';
                        });
                        break;
                    case 'pesquisar-vendas':
                        itens = document.querySelectorAll('.sale-card');
                        itens.forEach(card => {
                            const nome = card.querySelector('.sale-title').textContent.toLowerCase();
                            const cliente = card.querySelector('div:nth-child(2)').textContent.toLowerCase();
                            card.style.display = (nome.includes(termo) || cliente.includes(termo)) ? '' : 'none';
                        });
                        break;
                }
            });
        }
    });
   
    // Eventos para scanner de QR/código de barras
    const btnIniciarScanner = document.getElementById('iniciar-scanner');
    if (btnIniciarScanner) {
        btnIniciarScanner.addEventListener('click', iniciarScanner);
    }
   
    const btnPararScanner = document.getElementById('parar-scanner');
    if (btnPararScanner) {
        btnPararScanner.addEventListener('click', pararScanner);
    }
   
    // Evento para adicionar material/item
    const formAdicionarMaterial = document.getElementById('form-adicionar-material');
    if (formAdicionarMaterial) {
        formAdicionarMaterial.addEventListener('submit', function(e) {
            e.preventDefault();
           
            const codigo = document.getElementById('codigo-material').value;
            const nome = document.getElementById('nome-material').value;
            const quantidade = document.getElementById('quantidade-material').value;
            const unidade = document.getElementById('unidade-material').value;
            const unidadeMedida = document.getElementById('unidade-medida-material').value;
            const quantidadeMedida = document.getElementById('quantidade-medida-material').value;
            const preco = document.getElementById('preco-material').value;
           
            // Data de compra - se disponível
            let dataCompra = null;
            const dataCompraEl = document.getElementById('data-compra-material');
            if (dataCompraEl && dataCompraEl.value) {
                dataCompra = new Date(dataCompraEl.value).toISOString();
            }
           
            // Adicionar ou atualizar o material no catálogo
            const materialId = adicionarOuAtualizarMaterial(codigo, nome, unidade, unidadeMedida, quantidadeMedida, preco, dataCompra);
            
            if (materialId === null) {
                return; // Erro na validação
            }
           
            // Adicionar ao estoque
            const resultado = adicionarItemEstoque(materialId, quantidade, preco);
            
            if (!resultado) {
                return; // Erro na validação
            }
           
            // Atualizar localStorage e interface
            atualizarLocalStorage();
            carregarMateriais();
            carregarEstoque();
           
            // Resetar o botão de submit caso esteja em modo de edição
            const submitBtn = document.querySelector('#form-adicionar-material button[type="submit"]');
            submitBtn.textContent = 'Adicionar ao Estoque';
            submitBtn.removeAttribute('data-edicao');
           
            // Limpar o formulário
            this.reset();
           
            mostrarNotificacao('notification-materiais', 'Material adicionado com sucesso!', 'success');
           
            // Mudar para a aba de listar materiais
            const tabButton = document.querySelector('[data-tab="listar-materiais"]');
            if (tabButton) {
                tabButton.click();
            }
        });
    }
    
    // Evento de logout
    const btnLogout = document.getElementById('btn-logout');
    if (btnLogout) {
        btnLogout.addEventListener('click', function() {
            firebase.auth().signOut().then(() => {
                // Sign-out successful.
                currentUser = null;
                localStorage.clear();
                location.reload();
            }).catch((error) => {
                // An error happened.
                console.error('Erro ao fazer logout:', error);
            });
        });
    }
    
    // Eventos de login
    const btnLogin = document.getElementById('btn-login');
    if (btnLogin) {
      btnLogin.addEventListener('click', function(e) {
        e.preventDefault();
        fazerLogin();
      });
    }
    
    const btnCadastrar = document.getElementById('btn-cadastrar');
    if (btnCadastrar) {
      btnCadastrar.addEventListener('click', function(e) {
        e.preventDefault();
        fazerCadastro();
      });
    }
}  
// PARTE 5: JAVASCRIPT (SEGUNDA PARTE - MATERIAIS E RECEITAS)

// FUNÇÕES PARA RECEITAS

// Função para calcular o custo de uma receita
function calcularCustoReceita(receita) {
   let custoTotal = 0;
   
   if (!receita || !receita.ingredientes) return 0;
   
   receita.ingredientes.forEach(ingrediente => {
       // Encontrar o item do estoque com base no materialId do ingrediente
       const itemEstoque = estoque.find(item => item.materialId === ingrediente.materialId);
       if (itemEstoque && itemEstoque.preco) {
           // Calculamos o custo com base na quantidade da unidade de medida
           const precoUnitarioMedida = itemEstoque.preco / (itemEstoque.quantidadeMedida || 1);
           custoTotal += precoUnitarioMedida * ingrediente.quantidade;
       }
   });
   
   return custoTotal;
}

// Função para adicionar campo de ingrediente
function adicionarCampoIngrediente(ingredienteData = null) {
   const container = document.getElementById('lista-ingredientes');
   if (!container) return;
   
   // Verificar se existem materiais
   if (materiais.length === 0) {
       container.innerHTML = `
           <div class="notification notification-warning">
               Nenhum material cadastrado. Adicione materiais antes de criar receitas.
           </div>
       `;
       return;
   }
   
   const div = document.createElement('div');
   div.className = 'ingrediente-item';
   div.innerHTML = `
       <div class="form-row">
           <div class="form-col">
               <div class="form-group">
                   <label>Ingrediente:</label>
                   <select class="form-control ingrediente-select" required>
                       <option value="">Selecione um ingrediente...</option>
                       ${obterOpcoesIngredientes()}
                   </select>
               </div>
           </div>
           <div class="form-col">
               <div class="form-group">
                   <label>Quantidade:</label>
                   <input type="number" class="form-control ingrediente-quantidade" min="0.01" step="0.01" required>
               </div>
           </div>
           <div class="form-col">
               <div class="form-group">
                   <label>Unidade de Medida:</label>
                   <select class="form-control ingrediente-unidade-medida" required>
                       <option value="kg">Quilogramas (kg)</option>
                       <option value="g">Gramas (g)</option>
                       <option value="l">Litros (l)</option>
                       <option value="ml">Mililitros (ml)</option>
                   </select>
               </div>
           </div>
           <div class="form-col" style="flex: 0.5;">
               <div class="form-group">
                   <label>&nbsp;</label>
                   <button type="button" class="btn btn-danger remover-ingrediente" style="display: block;">X</button>
               </div>
           </div>
       </div>
   `;
   container.appendChild(div);
   
   // Configurar o novo campo
   const select = div.querySelector('.ingrediente-select');
   const quantidadeInput = div.querySelector('.ingrediente-quantidade');
   const unidadeMedidaSelect = div.querySelector('.ingrediente-unidade-medida');
   const removerBtn = div.querySelector('.remover-ingrediente');
   
   // Preencher com dados se fornecidos
   if (ingredienteData) {
       select.value = ingredienteData.materialId;
       quantidadeInput.value = ingredienteData.quantidade;
       unidadeMedidaSelect.value = ingredienteData.unidadeMedida || 'g';
   }
   
   // Adicionar eventos
   select.addEventListener('change', function() {
       const selectedOption = this.options[this.selectedIndex];
       if (selectedOption.value) {
           const unidadeMedida = selectedOption.getAttribute('data-unidade-medida');
           if (unidadeMedida) {
               unidadeMedidaSelect.value = unidadeMedida;
           }
           
           // Atualizar cálculos
           atualizarCalculosReceita();
       }
   });
   
   quantidadeInput.addEventListener('input', atualizarCalculosReceita);
   unidadeMedidaSelect.addEventListener('change', atualizarCalculosReceita);
   
   removerBtn.addEventListener('click', function() {
       container.removeChild(div);
       atualizarCalculosReceita();
   });
}

// NOVA função para obter opções de ingredientes
function obterOpcoesIngredientes() {
    // Agrupar materiais por código
    const materiaisPorCodigo = {};
    
    materiais.forEach(material => {
        if (!materiaisPorCodigo[material.codigo]) {
            materiaisPorCodigo[material.codigo] = [];
        }
        materiaisPorCodigo[material.codigo].push(material);
    });
    
    // Para cada código, pegar apenas o material mais recente
    const materiaisUnicos = [];
    Object.values(materiaisPorCodigo).forEach(grupo => {
        // Ordenar por data decrescente e pegar o primeiro (mais recente)
        grupo.sort((a, b) => new Date(b.dataCadastro) - new Date(a.dataCadastro));
        materiaisUnicos.push(grupo[0]);
    });
    
    // Gerar as opções HTML
    return materiaisUnicos.map(material => `
        <option value="${material.id}" 
            data-unidade="${material.unidade}" 
            data-preco="${material.ultimoPreco || 0}"
            data-unidade-medida="${material.unidadeMedida || ''}"
            data-quantidade-medida="${material.quantidadeMedida || 0}">
            ${material.nome}
        </option>
    `).join('');
}

// Função para atualizar os cálculos de preço da receita
function atualizarCalculosReceita() {
   let custoTotal = 0;
   
   // Coletar dados de ingredientes
   document.querySelectorAll('.ingrediente-item').forEach(item => {
       const select = item.querySelector('.ingrediente-select');
       if (select.value) {
           const quantidade = parseFloat(item.querySelector('.ingrediente-quantidade').value) || 0;
           const selectedOption = select.options[select.selectedIndex];
           const preco = parseFloat(selectedOption.getAttribute('data-preco')) || 0;
           const quantidadeMedida = parseFloat(selectedOption.getAttribute('data-quantidade-medida')) || 1;
           
           // Calcular custo proporcional
           const precoUnitarioMedida = preco / quantidadeMedida;
           custoTotal += precoUnitarioMedida * quantidade;
       }
   });
   
   // Atualizar elementos de preço
   const custoProducaoEl = document.getElementById('custo-producao');
   const custosVariadosEl = document.getElementById('custos-variados');
   const precoEstimadoEl = document.getElementById('preco-estimado');
   
   if (custoProducaoEl && custosVariadosEl && precoEstimadoEl) {
       // Custo de produção
       custoProducaoEl.textContent = formatarMoeda(custoTotal);
       
       // Custos variados (10%)
       const custosVariados = custoTotal * 0.1;
       custosVariadosEl.textContent = formatarMoeda(custosVariados);
       
       // Preço estimado (custo total + custos variados + 150% markup)
       const precoEstimado = (custoTotal + custosVariados) * 2.5;
       precoEstimadoEl.textContent = formatarMoeda(precoEstimado);
       
       // Se existe um campo de preço de venda, sugerir o valor estimado
       const precoVendaInput = document.getElementById('preco-venda');
       if (precoVendaInput && precoVendaInput.value === '') {
           precoVendaInput.value = precoEstimado.toFixed(2);
       }
   }
}

// Função para editar receita
function editarReceita(index) {
   const receita = receitas[index];
   if (!receita) return;
   
   // Mudar para a aba de adicionar receita
   const tabButton = document.querySelector('[data-tab="adicionar-receita"]');
   if (tabButton) {
       tabButton.click();
   }
   
   // Preencher o formulário
   document.getElementById('nome-receita').value = receita.nome;
   document.getElementById('descricao-receita').value = receita.descricao || '';
   
   // Limpar os ingredientes existentes
   document.getElementById('lista-ingredientes').innerHTML = '';
   
   // Adicionar cada ingrediente
   receita.ingredientes.forEach(ingrediente => {
       adicionarCampoIngrediente(ingrediente);
   });
   
   // Preencher preço de venda
   document.getElementById('preco-venda').value = receita.precoVenda.toFixed(2);
   
   // Atualizar cálculos
   atualizarCalculosReceita();
   
   // Modificar o botão de submit
   const submitBtn = document.querySelector('#form-adicionar-receita button[type="submit"]');
   if (submitBtn) {
       submitBtn.textContent = 'Atualizar Receita';
       submitBtn.setAttribute('data-edicao', index);
   }
}

// Função para remover receita
function removerReceita(index) {
   if (confirm('Tem certeza que deseja remover esta receita?')) {
       receitas.splice(index, 1);
       atualizarLocalStorage();
       carregarReceitas();
       mostrarNotificacao('notification-estoque', 'Receita removida com sucesso!', 'success');
   }
}

// Função para carregar receitas
function carregarReceitas() {
   const container = document.getElementById('lista-receitas');
   if (!container) return;
   
   container.innerHTML = '';
   
   // Carregar no select da página de vendas
   const selectVenda = document.getElementById('selecionar-receita-venda');
   if (selectVenda) {
       selectVenda.innerHTML = '<option value="">Selecione uma receita...</option>';
   }
   
   // Carregar no select do filtro de vendas
   const selectFiltroVendas = document.getElementById('filtro-receita');
   if (selectFiltroVendas) {
       selectFiltroVendas.innerHTML = '<option value="">Todas as receitas</option>';
   }
   
   if (receitas.length === 0) {
       container.innerHTML = '<p>Nenhuma receita cadastrada.</p>';
       return;
   }
   
   receitas.forEach((receita, index) => {
       // Calcular o custo total da receita
       const custoProducao = calcularCustoReceita(receita);
       const custosVariados = custoProducao * 0.1;
       const precoEstimado = (custoProducao + custosVariados) * 2.5;
       
       // Adicionar ao container de lista
       const card = document.createElement('div');
       card.className = 'recipe-card';
       card.innerHTML = `
           <h3>${receita.nome}</h3>
           <p>${receita.descricao || 'Sem descrição'}</p>
           
           <div class="recipe-pricing">
               <div class="recipe-price-item">
                   <div class="recipe-price-label">Custo de Produção</div>
                   <div class="recipe-price-value">${formatarMoeda(custoProducao)}</div>
               </div>
               
               <div class="recipe-price-item">
                   <div class="recipe-price-label">Custos Variados</div>
                   <div class="recipe-price-value">${formatarMoeda(custosVariados)}</div>
               </div>
               
               <div class="recipe-price-item">
                   <div class="recipe-price-label">Preço Estimado</div>
                   <div class="recipe-price-value">${formatarMoeda(precoEstimado)}</div>
               </div>
               
               <div class="recipe-price-item">
                   <div class="recipe-price-label">Preço de Venda</div>
                   <div class="recipe-price-value highlight">${formatarMoeda(receita.precoVenda || 0)}</div>
               </div>
           </div>
           
           <div style="margin-top: 15px;">
               <button class="btn btn-primary btn-editar-receita" data-index="${index}">Editar</button>
               <button class="btn btn-danger btn-remover-receita" data-index="${index}">Remover</button>
               <button class="btn btn-success btn-produzir-receita" data-index="${index}">Produzir</button>
           </div>
       `;
       container.appendChild(card);
       
       // Adicionar ao select de vendas
       if (selectVenda) {
           const option = document.createElement('option');
           option.value = receita.id;
           option.textContent = receita.nome;
           selectVenda.appendChild(option);
       }
       
       // Adicionar ao select de filtro de vendas
       if (selectFiltroVendas) {
           const optionFiltro = document.createElement('option');
           optionFiltro.value = receita.id;
           optionFiltro.textContent = receita.nome;
           selectFiltroVendas.appendChild(optionFiltro);
       }
   });
   
   // Adicionar eventos aos botões
   addRecipeButtonEvents();
}

// Função para adicionar eventos aos botões das receitas
function addRecipeButtonEvents() {
   document.querySelectorAll('.btn-editar-receita').forEach(btn => {
       btn.addEventListener('click', function() {
           const index = this.getAttribute('data-index');
           editarReceita(index);
       });
   });
   
   document.querySelectorAll('.btn-remover-receita').forEach(btn => {
       btn.addEventListener('click', function() {
           const index = this.getAttribute('data-index');
           removerReceita(index);
       });
   });
   
   document.querySelectorAll('.btn-produzir-receita').forEach(btn => {
       btn.addEventListener('click', function() {
           const index = this.getAttribute('data-index');
           const receita = receitas[index];
           
           // Mudar para a página de vendas e aba de registrar venda
           const navLink = document.querySelector('[data-page="vendas"]');
           if (navLink) {
               navLink.click();
           }
           
           // Pequeno delay para garantir que a página foi carregada
           setTimeout(() => {
               const tabButton = document.querySelector('[data-tab="registrar-venda"]');
               if (tabButton) {
                   tabButton.click();
               }
               
               // Selecionar a receita
               const selectReceita = document.getElementById('selecionar-receita-venda');
               if (selectReceita) {
                   selectReceita.value = receita.id;
                   selectReceita.dispatchEvent(new Event('change'));
               }
           }, 100);
       });
   });
}

// FUNÇÕES PARA VENDAS

// Função para carregar detalhes da receita na tela de vendas - MODIFICADA
function carregarDetalhesReceitaVenda(receitaId) {
   const receita = receitas.find(r => r.id === receitaId);
   if (!receita) return;
   
   const detalhes = document.getElementById('detalhes-receita-venda');
   const nomeReceita = document.getElementById('nome-receita-selecionada-venda');
   const tbodyIngredientes = document.getElementById('ingredientes-venda-selecionada');
   const avisoEstoque = document.getElementById('aviso-estoque-venda');
   
   if (!detalhes || !nomeReceita || !tbodyIngredientes || !avisoEstoque) return;
   
   detalhes.classList.remove('hidden');
   nomeReceita.textContent = receita.nome;
   
   tbodyIngredientes.innerHTML = '';
       
   // Calcular custos da receita
   const custoProducao = calcularCustoReceita(receita);
   const custosVariados = custoProducao * 0.1;
   
   // Preencher informações de preço
   document.getElementById('custo-producao-venda').textContent = formatarMoeda(custoProducao);
   document.getElementById('custos-variados-venda').textContent = formatarMoeda(custosVariados);
   document.getElementById('preco-venda-venda').textContent = formatarMoeda(receita.precoVenda || 0);
   
   // Definir valor total
   const qtd = parseInt(document.getElementById('quantidade-venda').value) || 1;
   const frete = parseFloat(document.getElementById('custo-frete').value) || 0;
   const decoracao = parseFloat(document.getElementById('custo-decoracao').value) || 0;
   const despesasAdicionais = parseFloat(document.getElementById('despesas-adicionais').value) || 0;
   
   // Novo cálculo do valor total incluindo frete e decoração
   const valorTotal = (receita.precoVenda * qtd) + frete + decoracao;
   document.getElementById('valor-total-venda').value = valorTotal.toFixed(2);
   
   // NOVA SEÇÃO: Atualizar o resumo financeiro na tela de registro de venda
   atualizarResumoFinanceiroVenda(receita, qtd, custoProducao, custosVariados, frete, decoracao, despesasAdicionais, valorTotal);
   
   // Definir a data atual para o campo de data
   const dataVendaEl = document.getElementById('data-venda');
   if (dataVendaEl && !dataVendaEl.value) {
       const hoje = new Date();
       dataVendaEl.value = hoje.toISOString().split('T')[0];
   }
   
   let todosProdutosDisponiveis = true;
   
   // Listar ingredientes necessários
   receita.ingredientes.forEach(ingrediente => {
       const material = materiais.find(m => m.id === ingrediente.materialId);
       const itemEstoque = estoque.find(item => item.materialId === ingrediente.materialId);
       
       const quantidadeNecessaria = ingrediente.quantidade * qtd;
       let statusEstoque = 'Não disponível';
       let disponivel = false;
       
       if (itemEstoque) {
           // Converter unidades para checagem de disponibilidade
           let quantidadeNormalizada = quantidadeNecessaria;
           
           // Normalizar unidades
           if (ingrediente.unidadeMedida.toLowerCase() === 'kg' && itemEstoque.unidadeMedida.toLowerCase() === 'g') {
               quantidadeNormalizada *= 1000;
           } else if (ingrediente.unidadeMedida.toLowerCase() === 'l' && itemEstoque.unidadeMedida.toLowerCase() === 'ml') {
               quantidadeNormalizada *= 1000;
           } else if (ingrediente.unidadeMedida.toLowerCase() === 'g' && itemEstoque.unidadeMedida.toLowerCase() === 'kg') {
               quantidadeNormalizada /= 1000;
           } else if (ingrediente.unidadeMedida.toLowerCase() === 'ml' && itemEstoque.unidadeMedida.toLowerCase() === 'l') {
               quantidadeNormalizada /= 1000;
           }
           
           // Calcular quantidade em unidades
           const quantidadeEmUnidades = quantidadeNormalizada / itemEstoque.quantidadeMedida;
           disponivel = itemEstoque.quantidade >= quantidadeEmUnidades;
           statusEstoque = disponivel ? 'Disponível' : 'Insuficiente';
       }
       
       if (!disponivel) {
           todosProdutosDisponiveis = false;
       }
       
       const tr = document.createElement('tr');
       tr.innerHTML = `
           <td>${material ? material.nome : 'Desconhecido'}</td>
           <td>${quantidadeNecessaria} ${ingrediente.unidadeMedida}</td>
           <td>${itemEstoque ? itemEstoque.quantidade.toFixed(2) + ' ' + itemEstoque.unidade : 'N/A'}</td>
           <td style="color: ${disponivel ? 'green' : 'red'}">${statusEstoque}</td>
       `;
       
       tbodyIngredientes.appendChild(tr);
   });
   
   // Mostrar aviso de estoque
   avisoEstoque.classList.remove('hidden');
   if (!todosProdutosDisponiveis) {
       avisoEstoque.className = 'notification notification-error';
       avisoEstoque.textContent = 'Atenção: Alguns ingredientes não estão disponíveis em quantidade suficiente!';
       document.getElementById('confirmar-venda').disabled = true;
   } else {
       avisoEstoque.className = 'notification notification-success';
       avisoEstoque.textContent = 'Todos os ingredientes estão disponíveis. Você pode prosseguir com a venda.';
       document.getElementById('confirmar-venda').disabled = false;
   }
}

// NOVA função para atualizar o resumo financeiro na tela de registro de venda
function atualizarResumoFinanceiroVenda(receita, quantidade, custoProducao, custosVariados, frete, decoracao, despesasAdicionais, valorTotal) {
    if (!receita) return;
    
    // 1. Cálculos financeiros
    // Despesa (Custo Produção + Custo Variado)
    const despesa = custoProducao + custosVariados;
    
    // Reinvestir (igual à Despesa)
    const valorReinvestir = despesa;
    
    // Despesas Adicionais com acréscimo de 10%
    const despesasAdicionaisComAcrescimo = despesasAdicionais * 1.1;
    const totalDespesasAdicionais = despesasAdicionaisComAcrescimo + frete + decoracao;
    
    // Lucro (Valor Total - Despesa - Reinvestir - Despesas Adicionais)
    const lucro = valorTotal - despesa - valorReinvestir - totalDespesasAdicionais;
    
    // 2. Atualizar os elementos na interface
    document.getElementById('resumo-valor-total').textContent = formatarMoeda(valorTotal);
    document.getElementById('resumo-despesa').textContent = formatarMoeda(despesa);
    document.getElementById('resumo-reinvestir').textContent = formatarMoeda(valorReinvestir);
    document.getElementById('resumo-desp-adic').textContent = formatarMoeda(totalDespesasAdicionais);
    
    const resumoLucro = document.getElementById('resumo-lucro');
    resumoLucro.textContent = formatarMoeda(lucro);
    
    // Adicionar classe para colorir o lucro
    if (lucro >= 0) {
        resumoLucro.className = 'venda-resumo-valor lucro-positivo';
    } else {
        resumoLucro.className = 'venda-resumo-valor lucro-negativo';
    }
}
    // PARTE 6: JAVASCRIPT (TERCEIRA PARTE - VENDAS E INICIALIZAÇÃO)

// Função para registrar uma venda - MODIFICADA
function registrarVenda(receitaId, quantidade, clienteNome, clienteTelefone, 
                      clienteEndereco, custoFrete, custoDecoracao, despesasAdicionais, 
                      observacoes, dataVenda) {
  
  const receita = receitas.find(r => r.id === receitaId);
  if (!receita) return false;
  
  // Converter para números
  quantidade = parseInt(quantidade);
  custoFrete = parseFloat(custoFrete) || 0;
  custoDecoracao = parseFloat(custoDecoracao) || 0;
  despesasAdicionais = parseFloat(despesasAdicionais) || 0;
  
  // Verificar disponibilidade de ingredientes
  let todosProdutosDisponiveis = true;
  
  for (const ingrediente of receita.ingredientes) {
    const itemEstoque = estoque.find(item => item.materialId === ingrediente.materialId);
    
    if (!itemEstoque) {
      todosProdutosDisponiveis = false;
      break;
    }
    
    // Converter unidades para checagem de disponibilidade
    let quantidadeNecessaria = ingrediente.quantidade * quantidade;
    let quantidadeNormalizada = quantidadeNecessaria;
    
    // Normalizar unidades
    if (ingrediente.unidadeMedida.toLowerCase() === 'kg' && itemEstoque.unidadeMedida.toLowerCase() === 'g') {
      quantidadeNormalizada *= 1000;
    } else if (ingrediente.unidadeMedida.toLowerCase() === 'l' && itemEstoque.unidadeMedida.toLowerCase() === 'ml') {
      quantidadeNormalizada *= 1000;
    } else if (ingrediente.unidadeMedida.toLowerCase() === 'g' && itemEstoque.unidadeMedida.toLowerCase() === 'kg') {
      quantidadeNormalizada /= 1000;
    } else if (ingrediente.unidadeMedida.toLowerCase() === 'ml' && itemEstoque.unidadeMedida.toLowerCase() === 'l') {
      quantidadeNormalizada /= 1000;
    }
    
    // Calcular quantidade em unidades
    const quantidadeEmUnidades = quantidadeNormalizada / itemEstoque.quantidadeMedida;
    
    if (itemEstoque.quantidade < quantidadeEmUnidades) {
      todosProdutosDisponiveis = false;
      break;
    }
  }
  
  if (!todosProdutosDisponiveis) {
    return false;
  }
  
  // Remover ingredientes do estoque
  for (const ingrediente of receita.ingredientes) {
    removerItemEstoque(ingrediente.materialId, ingrediente.quantidade * quantidade, ingrediente.unidadeMedida);
  }
  
  // CÁLCULOS FINANCEIROS CORRIGIDOS
  // 1. Custo Produção e Variados
  const custoProducao = calcularCustoReceita(receita);
  const custosVariados = custoProducao * 0.1;
  
  // 2. Despesa (Custo Produção + Custo Variado)
  const despesa = custoProducao + custosVariados;
  
  // 3. Reinvestir (igual à Despesa)
  const valorReinvestir = despesa;
  
  // 4. Despesas Adicionais
  const despesasAdicionaisComAcrescimo = despesasAdicionais * 1.1;
  const totalDespesasAdicionais = despesasAdicionaisComAcrescimo + custoFrete + custoDecoracao;
  
  // 5. Valor total da venda (preço da receita * quantidade + frete + decoração)
  const valorTotal = (receita.precoVenda * quantidade) + custoFrete + custoDecoracao;
  
  // 6. Lucro (Valor Total - Despesa - Reinvestir - Despesas Adicionais)
  const lucro = valorTotal - despesa - valorReinvestir - totalDespesasAdicionais;
  
  // Criar registro de venda
  const novaVenda = {
    id: gerarId(),
    receitaId: receitaId,
    receitaNome: receita.nome,
    quantidade: quantidade,
    custoProducao: custoProducao,
    custosVariados: custosVariados,
    despesasAdicionaisOriginal: despesasAdicionais,
    despesasAdicionaisComAcrescimo: despesasAdicionaisComAcrescimo,
    custoFrete: custoFrete,
    custoDecoracao: custoDecoracao,
    totalDespesasAdicionais: totalDespesasAdicionais,
    valorReinvestir: valorReinvestir,
    despesa: despesa,
    lucro: lucro,
    precoVenda: receita.precoVenda,
    valorTotal: valorTotal,
    observacoes: observacoes || "",
    cliente: {
      nome: clienteNome,
      telefone: clienteTelefone,
      endereco: clienteEndereco
    },
    data: dataVenda || new Date().toISOString(),
    dataCriacao: new Date().toISOString()
  };
  
  vendas.push(novaVenda);
  atualizarLocalStorage();
  
  return true;
}

// Função para editar uma venda - MODIFICADA
function editarVenda(vendaId, quantidade, clienteNome, clienteTelefone, 
                   clienteEndereco, custoFrete, custoDecoracao, despesasAdicionais, 
                   observacoes, dataVenda, valorTotal) {
  
  const venda = vendas.find(v => v.id === vendaId);
  if (!venda) return false;
  
  // Salvar os dados originais para restaurar o estoque
  const vendaOriginal = JSON.parse(JSON.stringify(venda));
  
  // Converter valores
  quantidade = parseInt(quantidade) || venda.quantidade;
  custoFrete = parseFloat(custoFrete);
  custoDecoracao = parseFloat(custoDecoracao);
  despesasAdicionais = parseFloat(despesasAdicionais);
  valorTotal = parseFloat(valorTotal);
  
  // Checar se a quantidade mudou para atualizar o estoque
  if (quantidade !== venda.quantidade) {
    // Primeiro devolvemos os itens ao estoque
    const receita = receitas.find(r => r.id === venda.receitaId);
    if (receita) {
      // Devolver ao estoque a quantidade original
      receita.ingredientes.forEach(ingrediente => {
        adicionarEstoqueDeVolta(
          ingrediente.materialId, 
          ingrediente.quantidade * vendaOriginal.quantidade, 
          ingrediente.unidadeMedida
        );
      });
      
      // Agora removemos a nova quantidade
      let todosProdutosDisponiveis = true;
      
      // Verificar disponibilidade
      for (const ingrediente of receita.ingredientes) {
        const itemEstoque = estoque.find(item => item.materialId === ingrediente.materialId);
        if (!itemEstoque) {
          todosProdutosDisponiveis = false;
          break;
        }
        
        let quantidadeNecessaria = ingrediente.quantidade * quantidade;
        let quantidadeNormalizada = quantidadeNecessaria;
        
        // Normalizar unidades
        if (ingrediente.unidadeMedida.toLowerCase() === 'kg' && itemEstoque.unidadeMedida.toLowerCase() === 'g') {
          quantidadeNormalizada *= 1000;
        } else if (ingrediente.unidadeMedida.toLowerCase() === 'l' && itemEstoque.unidadeMedida.toLowerCase() === 'ml') {
          quantidadeNormalizada *= 1000;
        } else if (ingrediente.unidadeMedida.toLowerCase() === 'g' && itemEstoque.unidadeMedida.toLowerCase() === 'kg') {
          quantidadeNormalizada /= 1000;
        } else if (ingrediente.unidadeMedida.toLowerCase() === 'ml' && itemEstoque.unidadeMedida.toLowerCase() === 'l') {
          quantidadeNormalizada /= 1000;
        }
        
        const quantidadeEmUnidades = quantidadeNormalizada / itemEstoque.quantidadeMedida;
        
        if (itemEstoque.quantidade < quantidadeEmUnidades) {
          todosProdutosDisponiveis = false;
          break;
        }
      }
      
      if (!todosProdutosDisponiveis) {
        // Se não há produtos suficientes, restaurar estoque original e abortar
        receita.ingredientes.forEach(ingrediente => {
          removerItemEstoque(
            ingrediente.materialId, 
            ingrediente.quantidade * vendaOriginal.quantidade, 
            ingrediente.unidadeMedida
          );
        });
        return false;
      }
      
      // Se temos estoque suficiente, removemos a nova quantidade
      for (const ingrediente of receita.ingredientes) {
        removerItemEstoque(
          ingrediente.materialId, 
          ingrediente.quantidade * quantidade, 
          ingrediente.unidadeMedida
        );
      }
      
      // Recalcular custos baseados na nova quantidade
      const custoProducao = calcularCustoReceita(receita);
      const custosVariados = custoProducao * 0.1;
      venda.custoProducao = custoProducao;
      venda.custosVariados = custosVariados;
      venda.despesa = custoProducao + custosVariados;
      venda.valorReinvestir = venda.despesa;
    }
  }
  
  // Atualizar os dados da venda
  venda.quantidade = quantidade;
  venda.cliente.nome = clienteNome;
  venda.cliente.telefone = clienteTelefone;
  venda.cliente.endereco = clienteEndereco;
  venda.custoFrete = custoFrete;
  venda.custoDecoracao = custoDecoracao;
  venda.despesasAdicionaisOriginal = despesasAdicionais;
  venda.despesasAdicionaisComAcrescimo = despesasAdicionais * 1.1;
  venda.totalDespesasAdicionais = venda.despesasAdicionaisComAcrescimo + custoFrete + custoDecoracao;
  venda.observacoes = observacoes;
  
  if (dataVenda) {
    venda.data = new Date(dataVenda).toISOString();
  }
  
  // MODIFICAÇÃO: Atualizar valor total e recalcular lucro corretamente
  venda.valorTotal = valorTotal;
  // Lucro = Valor Total - Despesa - Reinvestir - Despesas Adicionais Total
  venda.lucro = valorTotal - venda.despesa - venda.valorReinvestir - venda.totalDespesasAdicionais;
  
  atualizarLocalStorage();
  return true;
}

// Função para excluir uma venda
function excluirVenda(vendaId) {
  const index = vendas.findIndex(v => v.id === vendaId);
  if (index === -1) return false;
  
  const venda = vendas[index];
  
  // Devolver itens ao estoque
  const receita = receitas.find(r => r.id === venda.receitaId);
  if (receita) {
    receita.ingredientes.forEach(ingrediente => {
      adicionarEstoqueDeVolta(
        ingrediente.materialId, 
        ingrediente.quantidade * venda.quantidade, 
        ingrediente.unidadeMedida
      );
    });
  }
  
  // Remover a venda
  vendas.splice(index, 1);
  atualizarLocalStorage();
  
  return true;
}

// Função para mostrar detalhes de uma venda - MODIFICADA
function mostrarDetalhesVenda(vendaId) {
  const venda = vendas.find(v => v.id === vendaId);
  if (!venda) return;
  
  const modal = document.getElementById('venda-details-modal');
  const content = document.getElementById('venda-details-content');
  
  if (!modal || !content) return;
  
  // MODIFICAÇÃO: Cálculos financeiros corrigidos
  const despesa = venda.despesa || (venda.custoProducao + venda.custosVariados);
  const valorReinvestir = despesa;
  
  // Verificar se despesasAdicionaisComAcrescimo existe
  // Para compatibilidade com vendas antigas
  const despesasAdicionaisComAcrescimo = venda.despesasAdicionaisComAcrescimo || 
                                         (venda.despesasAdicionaisOriginal || venda.despesasAdicionais || 0) * 1.1;
  const totalDespesasAdicionais = venda.totalDespesasAdicionais || 
                                 (despesasAdicionaisComAcrescimo + (venda.custoFrete || 0) + (venda.custoDecoracao || 0));
  
  // Recalcular lucro (Valor Total - Despesa - Reinvestir - Despesas Adicionais)
  const lucro = venda.valorTotal - despesa - valorReinvestir - totalDespesasAdicionais;
  
  content.innerHTML = `
    <div class="sale-details">
      <h4>${venda.receitaNome}</h4>
      <p><strong>Data:</strong> ${formatarData(venda.data)}</p>
      <p><strong>Cliente:</strong> ${venda.cliente.nome}</p>
      <p><strong>Telefone:</strong> ${venda.cliente.telefone || 'N/A'}</p>
      <p><strong>Endereço:</strong> ${venda.cliente.endereco || 'N/A'}</p>
      
      ${venda.observacoes ? `<p><strong>Observações:</strong> ${venda.observacoes}</p>` : ''}
      
      <div class="recipe-pricing" style="margin: 15px 0;">
        <div class="recipe-price-item">
          <div class="recipe-price-label">Custo de Produção</div>
          <div class="recipe-price-value">${formatarMoeda(venda.custoProducao)}</div>
        </div>
        
        <div class="recipe-price-item">
          <div class="recipe-price-label">Custos Variados</div>
          <div class="recipe-price-value">${formatarMoeda(venda.custosVariados)}</div>
        </div>
        
        <div class="recipe-price-item">
          <div class="recipe-price-label">Preço Unitário</div>
          <div class="recipe-price-value">${formatarMoeda(venda.precoVenda)}</div>
        </div>
        
        <div class="recipe-price-item">
          <div class="recipe-price-label">Quantidade</div>
          <div class="recipe-price-value">${venda.quantidade}</div>
        </div>
      </div>
      
      <div class="recipe-pricing" style="margin: 15px 0;">
        <div class="recipe-price-item">
          <div class="recipe-price-label">Frete</div>
          <div class="recipe-price-value">${formatarMoeda(venda.custoFrete || 0)}</div>
        </div>
        
        <div class="recipe-price-item">
          <div class="recipe-price-label">Decoração</div>
          <div class="recipe-price-value">${formatarMoeda(venda.custoDecoracao || 0)}</div>
        </div>
        
        <div class="recipe-price-item">
          <div class="recipe-price-label">Despesas Adicionais</div>
          <div class="recipe-price-value">${formatarMoeda(venda.despesasAdicionaisOriginal || venda.despesasAdicionais || 0)}</div>
        </div>
        
        <div class="recipe-price-item">
          <div class="recipe-price-label">Desp. Adic. + 10%</div>
          <div class="recipe-price-value">${formatarMoeda(despesasAdicionaisComAcrescimo)}</div>
        </div>
      </div>
      
      <div class="venda-resumo-financeiro">
        <div class="venda-resumo-grid">
          <div class="venda-resumo-item">
            <div class="venda-resumo-label">Valor Total</div>
            <div class="venda-resumo-valor">${formatarMoeda(venda.valorTotal)}</div>
          </div>
          
          <div class="venda-resumo-item">
            <div class="venda-resumo-label">Despesa</div>
            <div class="venda-resumo-valor">${formatarMoeda(despesa)}</div>
          </div>
          
          <div class="venda-resumo-item">
            <div class="venda-resumo-label">Reinvestir</div>
            <div class="venda-resumo-valor">${formatarMoeda(valorReinvestir)}</div>
          </div>
          
          <div class="venda-resumo-item">
            <div class="venda-resumo-label">Total Desp. Adic.</div>
            <div class="venda-resumo-valor">${formatarMoeda(totalDespesasAdicionais)}</div>
          </div>
          
          <div class="venda-resumo-item">
            <div class="venda-resumo-label">Lucro</div>
            <div class="venda-resumo-valor ${lucro >= 0 ? 'lucro-positivo' : 'lucro-negativo'}">${formatarMoeda(lucro)}</div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  modal.classList.remove('hidden');
}

// Configurar eventos adicionais para esta parte do código
function setupAdditionalEvents() {
  // Evento para adicionar receita
  const formAdicionarReceita = document.getElementById('form-adicionar-receita');
  if (formAdicionarReceita) {
    formAdicionarReceita.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const nome = document.getElementById('nome-receita').value;
      const descricao = document.getElementById('descricao-receita').value;
      const precoVenda = parseFloat(document.getElementById('preco-venda').value) || 0;
      
      // Validar preço de venda
      if (isNaN(precoVenda) || precoVenda <= 0) {
        alert('O preço de venda deve ser um número válido maior que zero.');
        return;
      }
      
      // Coletar ingredientes
      const ingredientes = [];
      document.querySelectorAll('.ingrediente-item').forEach(item => {
        const select = item.querySelector('.ingrediente-select');
        if (select.value) {
          const quantidade = parseFloat(item.querySelector('.ingrediente-quantidade').value);
          const unidadeMedidaSelect = item.querySelector('.ingrediente-unidade-medida');
          const material = materiais.find(m => m.id === select.value);
          
          // Validar quantidade
          if (isNaN(quantidade) || quantidade <= 0) {
            alert('A quantidade do ingrediente deve ser um número válido maior que zero.');
            return;
          }
          
          ingredientes.push({
            materialId: select.value,
            nome: material ? material.nome : select.options[select.selectedIndex].text,
            quantidade: quantidade,
            unidadeMedida: unidadeMedidaSelect.value
          });
        }
      });
      
      // Verificar se tem ingredientes
      if (ingredientes.length === 0) {
        alert('Adicione pelo menos um ingrediente à receita!');
        return;
      }
      
      // Verificar se é uma edição
      const submitBtn = document.querySelector('#form-adicionar-receita button[type="submit"]');
      const indexEdicao = submitBtn.getAttribute('data-edicao');
      
      if (indexEdicao !== null && indexEdicao !== undefined) {
        // Edição de receita existente
        receitas[indexEdicao].nome = nome;
        receitas[indexEdicao].descricao = descricao;
        receitas[indexEdicao].ingredientes = ingredientes;
        receitas[indexEdicao].precoVenda = precoVenda;
        
        // Resetar o botão
        submitBtn.textContent = 'Salvar Receita';
        submitBtn.removeAttribute('data-edicao');
        
        mostrarNotificacao('notification-estoque', 'Receita atualizada com sucesso!', 'success');
      } else {
        // Nova receita
        const novaReceita = {
          id: gerarId(),
          nome: nome,
          descricao: descricao,
          ingredientes: ingredientes,
          precoVenda: precoVenda,
          dataCriacao: new Date().toISOString()
        };
        
        receitas.push(novaReceita);
        mostrarNotificacao('notification-estoque', 'Receita adicionada com sucesso!', 'success');
      }
      
      // Atualizar localStorage e interface
      atualizarLocalStorage();
      carregarReceitas();
      
      // Limpar o formulário
      this.reset();
      document.getElementById('lista-ingredientes').innerHTML = '';
      document.getElementById('custo-producao').textContent = formatarMoeda(0);
      document.getElementById('custos-variados').textContent = formatarMoeda(0);
      document.getElementById('preco-estimado').textContent = formatarMoeda(0);
      
      // Adicionar um campo vazio de ingrediente
      adicionarCampoIngrediente();
      
      // Mudar para a aba de listar receitas
      const tabButton = document.querySelector('[data-tab="listar-receitas"]');
      if (tabButton) {
        tabButton.click();
      }
    });
  }
  
  // Evento para adicionar ingrediente à receita
  const btnAdicionarIngrediente = document.getElementById('adicionar-ingrediente');
  if (btnAdicionarIngrediente) {
    btnAdicionarIngrediente.addEventListener('click', function() {
      adicionarCampoIngrediente();
    });
  }
  
  // Evento para selecionar receita para venda
  const selecionarReceitaVenda = document.getElementById('selecionar-receita-venda');
  if (selecionarReceitaVenda) {
    selecionarReceitaVenda.addEventListener('change', function() {
      const receitaId = this.value;
      if (receitaId) {
        // Definir a data atual para o campo de data
        const dataVendaEl = document.getElementById('data-venda');
        if (dataVendaEl && !dataVendaEl.value) {
          const hoje = new Date();
          dataVendaEl.value = hoje.toISOString().split('T')[0];
        }
        
        carregarDetalhesReceitaVenda(receitaId);
      } else {
        document.getElementById('detalhes-receita-venda').classList.add('hidden');
      }
    });
  }

  // Evento para atualizar valor total quando quantidade ou custos adicionais mudam
  const qtdVenda = document.getElementById('quantidade-venda');
  const custoFrete = document.getElementById('custo-frete');
  const custoDecoracao = document.getElementById('custo-decoracao');
  const despesasAdicionais = document.getElementById('despesas-adicionais');
  
  [qtdVenda, custoFrete, custoDecoracao, despesasAdicionais].forEach(input => {
    if (input) {
      input.addEventListener('input', atualizarValorTotalVenda);
    }
  });
  
  // MODIFICADO: Atualização do valor total com resumo financeiro
  function atualizarValorTotalVenda() {
    const receitaId = document.getElementById('selecionar-receita-venda').value;
    if (!receitaId) return;
    
    const receita = receitas.find(r => r.id === receitaId);
    if (!receita) return;
    
    const qtd = parseInt(document.getElementById('quantidade-venda').value) || 1;
    const frete = parseFloat(document.getElementById('custo-frete').value) || 0;
    const decoracao = parseFloat(document.getElementById('custo-decoracao').value) || 0;
    const despesasAdicionais = parseFloat(document.getElementById('despesas-adicionais').value) || 0;
    
    // Cálculo do valor total - incluindo frete e decoração
    const valorTotal = (receita.precoVenda * qtd) + frete + decoracao;
    document.getElementById('valor-total-venda').value = valorTotal.toFixed(2);
    
    // Calcular custos da receita
    const custoProducao = calcularCustoReceita(receita);
    const custosVariados = custoProducao * 0.1;
    
    // Atualizar também o resumo financeiro
    atualizarResumoFinanceiroVenda(
      receita, 
      qtd, 
      custoProducao, 
      custosVariados, 
      frete, 
      decoracao, 
      despesasAdicionais, 
      valorTotal
    );
    
    // Atualizar a lista de ingredientes necessários com a nova quantidade
    carregarDetalhesReceitaVenda(receitaId);
  }
  
  // Evento para registrar venda
  const formRegistrarVenda = document.getElementById('form-registrar-venda');
  if (formRegistrarVenda) {
    formRegistrarVenda.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const receitaId = document.getElementById('selecionar-receita-venda').value;
      if (!receitaId) {
        alert('Selecione uma receita primeiro!');
        return;
      }
      
      const quantidade = parseInt(document.getElementById('quantidade-venda').value) || 1;
      
      // Validar quantidade
      if (isNaN(quantidade) || quantidade <= 0) {
        alert('A quantidade deve ser um número válido maior que zero.');
        return;
      }
      
      const clienteNome = document.getElementById('cliente-nome').value;
      
      // Validar nome do cliente
      if (!clienteNome.trim()) {
        alert('O nome do cliente é obrigatório.');
        return;
      }
      
      const clienteTelefone = document.getElementById('cliente-telefone').value;
      const clienteEndereco = document.getElementById('cliente-endereco').value;
      const observacoes = document.getElementById('observacoes-venda').value;
      const custoFrete = parseFloat(document.getElementById('custo-frete').value) || 0;
      const custoDecoracao = parseFloat(document.getElementById('custo-decoracao').value) || 0;
      const despesasAdicionais = parseFloat(document.getElementById('despesas-adicionais').value) || 0;
      
      // Data da venda
      let dataVenda = null;
      const dataVendaEl = document.getElementById('data-venda');
      if (dataVendaEl && dataVendaEl.value) {
        dataVenda = new Date(dataVendaEl.value).toISOString();
      } else {
        // Se não tem data definida, usar a data atual
        dataVenda = new Date().toISOString();
      }
      
      // Processar venda
      toggleModal(true, "Processando venda...", "Aguarde enquanto processamos a venda e atualizamos o estoque.");
      
      setTimeout(() => {
        const resultado = registrarVenda(
          receitaId, 
          quantidade, 
          clienteNome, 
          clienteTelefone, 
          clienteEndereco, 
          custoFrete, 
          custoDecoracao, 
          despesasAdicionais,
          observacoes,
          dataVenda
        );
        
        toggleModal(false);
        
        if (resultado) {
          mostrarNotificacao('notification-vendas', 'Venda registrada com sucesso!', 'success');
          
          // Atualizar interfaces
          carregarEstoque();
          carregarVendas();
          
          // Limpar formulário
          this.reset();
          document.getElementById('detalhes-receita-venda').classList.add('hidden');
          
          // Mudar para a aba de listar vendas
          const tabButton = document.querySelector('[data-tab="listar-vendas"]');
          if (tabButton) {
            tabButton.click();
          }
        } else {
          mostrarNotificacao('notification-vendas', 'Erro ao registrar venda. Verifique o estoque de ingredientes.', 'error');
        }
      }, 1000);
    });
  }
  
  // Eventos para os novos botões de edição e exclusão
  
  // Botão de fechar modal de edição
  const btnFecharEditarVenda = document.getElementById('fechar-editar-venda');
  if (btnFecharEditarVenda) {
    btnFecharEditarVenda.addEventListener('click', function() {
      document.getElementById('editar-venda-modal').classList.add('hidden');
    });
  }
  
  // Formulário de edição de venda
  const formEditarVenda = document.getElementById('form-editar-venda');
  if (formEditarVenda) {
    formEditarVenda.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const vendaId = document.getElementById('editar-venda-id').value;
      const quantidade = parseInt(document.getElementById('editar-quantidade-venda').value);
      const clienteNome = document.getElementById('editar-cliente-nome').value;
      const clienteTelefone = document.getElementById('editar-cliente-telefone').value;
      const clienteEndereco = document.getElementById('editar-cliente-endereco').value;
      const custoFrete = parseFloat(document.getElementById('editar-custo-frete').value);
      const custoDecoracao = parseFloat(document.getElementById('editar-custo-decoracao').value);
      const despesasAdicionais = parseFloat(document.getElementById('editar-despesas-adicionais').value);
      const observacoes = document.getElementById('editar-observacoes-venda').value;
      const dataVenda = document.getElementById('editar-data-venda').value;
      const valorTotal = parseFloat(document.getElementById('editar-valor-total-venda').value);
      
      // Validar campos obrigatórios
      if (!clienteNome.trim()) {
        alert('O nome do cliente é obrigatório.');
        return;
      }
      
      if (isNaN(quantidade) || quantidade <= 0) {
        alert('A quantidade deve ser um número válido maior que zero.');
        return;
      }
      
      if (isNaN(valorTotal) || valorTotal < 0) {
        alert('O valor total deve ser um número válido.');
        return;
      }
      
      // Processar a edição
      toggleModal(true, "Atualizando venda...", "Aguarde enquanto processamos as alterações.");
      
      setTimeout(() => {
        const resultado = editarVenda(
          vendaId,
          quantidade,
          clienteNome,
          clienteTelefone,
          clienteEndereco,
          custoFrete,
          custoDecoracao,
          despesasAdicionais,
          observacoes,
          dataVenda,
          valorTotal
        );
        
        toggleModal(false);
        
        if (resultado) {
          document.getElementById('editar-venda-modal').classList.add('hidden');
          mostrarNotificacao('notification-vendas', 'Venda atualizada com sucesso!', 'success');
          carregarEstoque();
          carregarVendas();
        } else {
          mostrarNotificacao('notification-vendas', 'Erro ao atualizar a venda. Verifique o estoque disponível.', 'error');
        }
      }, 1000);
    });
  }
  
  // Eventos para atualizar resumo financeiro ao editar
  const editarQtdVenda = document.getElementById('editar-quantidade-venda');
  const editarCustoFrete = document.getElementById('editar-custo-frete');
  const editarCustoDecoracao = document.getElementById('editar-custo-decoracao');
  const editarDespesasAdicionais = document.getElementById('editar-despesas-adicionais');
  const editarValorTotal = document.getElementById('editar-valor-total-venda');
  
  [editarQtdVenda, editarCustoFrete, editarCustoDecoracao, editarDespesasAdicionais, editarValorTotal].forEach(input => {
    if (input) {
      input.addEventListener('input', atualizarResumoFinanceiroEdicao);
    }
  });
  
  // NOVA função para atualizar o resumo financeiro na tela de edição
  function atualizarResumoFinanceiroEdicao() {
    const vendaId = document.getElementById('editar-venda-id').value;
    const venda = vendas.find(v => v.id === vendaId);
    if (!venda) return;
    
    const receita = receitas.find(r => r.id === venda.receitaId);
    if (!receita) return;
    
    const quantidade = parseInt(document.getElementById('editar-quantidade-venda').value) || venda.quantidade;
    const frete = parseFloat(document.getElementById('editar-custo-frete').value) || 0;
    const decoracao = parseFloat(document.getElementById('editar-custo-decoracao').value) || 0;
    const despesasAdicionais = parseFloat(document.getElementById('editar-despesas-adicionais').value) || 0;
    const valorTotal = parseFloat(document.getElementById('editar-valor-total-venda').value) || venda.valorTotal;
    
    // Cálculos financeiros
    let custoProducao = venda.custoProducao;
    let custosVariados = venda.custosVariados;
    
    // Se a quantidade mudou, recalcular os custos
    if (quantidade !== venda.quantidade) {
      // Proporcional à quantidade
      const fatorProporcional = quantidade / venda.quantidade;
      custoProducao = venda.custoProducao * fatorProporcional;
      custosVariados = venda.custosVariados * fatorProporcional;
    }
    
    // Despesa (Custo Produção + Custo Variado)
    const despesa = custoProducao + custosVariados;
    
    // Reinvestir (igual à Despesa)
    const valorReinvestir = despesa;
    
    // Despesas Adicionais com acréscimo de 10%
    const despesasAdicionaisComAcrescimo = despesasAdicionais * 1.1;
    const totalDespesasAdicionais = despesasAdicionaisComAcrescimo + frete + decoracao;
    
    // Lucro (Valor Total - Despesa - Reinvestir - Despesas Adicionais)
    const lucro = valorTotal - despesa - valorReinvestir - totalDespesasAdicionais;
    
    // Atualizar os elementos na interface
    document.getElementById('editar-resumo-valor-total').textContent = formatarMoeda(valorTotal);
    document.getElementById('editar-resumo-despesa').textContent = formatarMoeda(despesa);
    document.getElementById('editar-resumo-reinvestir').textContent = formatarMoeda(valorReinvestir);
    document.getElementById('editar-resumo-desp-adic').textContent = formatarMoeda(totalDespesasAdicionais);
    
    const resumoLucro = document.getElementById('editar-resumo-lucro');
    resumoLucro.textContent = formatarMoeda(lucro);
    
    // Adicionar classe para colorir o lucro
    if (lucro >= 0) {
      resumoLucro.className = 'venda-resumo-valor lucro-positivo';
    } else {
      resumoLucro.className = 'venda-resumo-valor lucro-negativo';
    }
  }
  
  // Função para preencher o formulário de edição de venda - MODIFICADA
  function mostrarFormEditarVenda(vendaId) {
    const venda = vendas.find(v => v.id === vendaId);
    if (!venda) return;
    
    // Preencher formulário de edição
    document.getElementById('editar-venda-id').value = venda.id;
    document.getElementById('editar-cliente-nome').value = venda.cliente.nome;
    document.getElementById('editar-cliente-telefone').value = venda.cliente.telefone || '';
    document.getElementById('editar-cliente-endereco').value = venda.cliente.endereco || '';
    document.getElementById('editar-observacoes-venda').value = venda.observacoes || '';
    document.getElementById('editar-custo-frete').value = venda.custoFrete || 0;
    document.getElementById('editar-custo-decoracao').value = venda.custoDecoracao || 0;
    document.getElementById('editar-despesas-adicionais').value = venda.despesasAdicionaisOriginal || 0;
    document.getElementById('editar-quantidade-venda').value = venda.quantidade;
    document.getElementById('editar-valor-total-venda').value = venda.valorTotal;
    
    // Data da venda
    const dataVendaEl = document.getElementById('editar-data-venda');
    if (dataVendaEl) {
      const data = new Date(venda.data);
      dataVendaEl.value = data.toISOString().split('T')[0];
    }
    
    // Atualizar resumo financeiro
    atualizarResumoFinanceiroEdicao();
    
    // Mostrar o modal
    document.getElementById('editar-venda-modal').classList.remove('hidden');
  }
  
  // Botões para confirmar/cancelar exclusão
  const btnCancelarExclusao = document.getElementById('cancelar-exclusao');
  if (btnCancelarExclusao) {
    btnCancelarExclusao.addEventListener('click', function() {
      document.getElementById('confirmar-exclusao-modal').classList.add('hidden');
    });
  }
  
  const btnConfirmarExclusao = document.getElementById('confirmar-exclusao');
  if (btnConfirmarExclusao) {
    btnConfirmarExclusao.addEventListener('click', function() {
      const vendaId = document.getElementById('excluir-venda-id').value;
      
      toggleModal(true, "Excluindo venda...", "Aguarde enquanto excluímos a venda e restauramos o estoque.");
      
      setTimeout(() => {
        const resultado = excluirVenda(vendaId);
        
        toggleModal(false);
        document.getElementById('confirmar-exclusao-modal').classList.add('hidden');
        
        if (resultado) {
          mostrarNotificacao('notification-vendas', 'Venda excluída com sucesso!', 'success');
          carregarEstoque();
          carregarVendas();
        } else {
          mostrarNotificacao('notification-vendas', 'Erro ao excluir a venda.', 'error');
        }
      }, 1000);
    });
  }
  
  // Evento para filtrar vendas
  const btnFiltrarVendas = document.getElementById('btn-filtrar-vendas');
  if (btnFiltrarVendas) {
    btnFiltrarVendas.addEventListener('click', filtrarVendas);
  }
  
  const btnLimparFiltros = document.getElementById('btn-limpar-filtros');
  if (btnLimparFiltros) {
    btnLimparFiltros.addEventListener('click', function() {
      document.getElementById('filtro-data-inicio').value = '';
      document.getElementById('filtro-data-fim').value = '';
      document.getElementById('filtro-receita').value = '';
      
      // Recarregar todas as vendas
      carregarVendas();
    });
  }
  
  // MODIFICADO: Função de filtrar vendas com novos cálculos
  function filtrarVendas() {
    const dataInicio = document.getElementById('filtro-data-inicio').value;
    const dataFim = document.getElementById('filtro-data-fim').value;
    const receitaId = document.getElementById('filtro-receita').value;
    
    const vendasFiltradas = vendas.filter(venda => {
      // Filtrar por data
      let passaFiltroData = true;
      if (dataInicio) {
        const dataVenda = new Date(venda.data);
        const dataInicioDate = new Date(dataInicio);
        passaFiltroData = passaFiltroData && dataVenda >= dataInicioDate;
      }
      
      if (dataFim) {
        const dataVenda = new Date(venda.data);
        const dataFimDate = new Date(dataFim);
        // Adicionar 1 dia para incluir o dia final completo
        dataFimDate.setDate(dataFimDate.getDate() + 1);
        passaFiltroData = passaFiltroData && dataVenda < dataFimDate;
      }
      
      // Filtrar por receita
      let passaFiltroReceita = true;
      if (receitaId) {
        passaFiltroReceita = venda.receitaId === receitaId;
      }
      
      return passaFiltroData && passaFiltroReceita;
    });
    
    // Renderizar vendas filtradas
    const container = document.getElementById('lista-vendas');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (vendasFiltradas.length === 0) {
      container.innerHTML = '<p>Nenhuma venda encontrada com os filtros selecionados.</p>';
      return;
    }
    
    // Ordenar vendas da mais recente para a mais antiga
    const vendasOrdenadas = [...vendasFiltradas].sort((a, b) => new Date(b.data) - new Date(a.data));
    
    vendasOrdenadas.forEach((venda) => {
      // MODIFICADO: Calcular valores financeiros com nova lógica
      const despesa = venda.despesa || (venda.custoProducao + venda.custosVariados);
      const valorReinvestir = despesa;
      
      // Compatibilidade com vendas antigas
      const despesasAdicionaisComAcrescimo = venda.despesasAdicionaisComAcrescimo || 
                                          ((venda.despesasAdicionaisOriginal || venda.despesasAdicionais || 0) * 1.1);
      const totalDespesasAdicionais = venda.totalDespesasAdicionais || 
                                    (despesasAdicionaisComAcrescimo + (venda.custoFrete || 0) + (venda.custoDecoracao || 0));
      
      // CORRIGIDO: Recalcular lucro corretamente
      const lucro = venda.valorTotal - despesa - valorReinvestir - totalDespesasAdicionais;
      
      const card = document.createElement('div');
      card.className = 'sale-card';
      card.innerHTML = `
        <div class="sale-header">
          <div class="sale-title">${venda.receitaNome}</div>
          <div class="sale-date">${formatarData(venda.data)}</div>
        </div>
        <div>Cliente: ${venda.cliente.nome}</div>
        <div>Quantidade: ${venda.quantidade}</div>
        <div>Valor Total: ${formatarMoeda(venda.valorTotal)}</div>
        
        <div class="venda-resumo-financeiro" style="margin-top: 10px;">
          <div class="venda-resumo-grid">
            <div class="venda-resumo-item">
              <div class="venda-resumo-label">Valor Total</div>
              <div class="venda-resumo-valor">${formatarMoeda(venda.valorTotal)}</div>
            </div>
            <div class="venda-resumo-item">
              <div class="venda-resumo-label">Despesa</div>
              <div class="venda-resumo-valor">${formatarMoeda(despesa)}</div>
            </div>
            <div class="venda-resumo-item">
              <div class="venda-resumo-label">Reinvestir</div>
              <div class="venda-resumo-valor">${formatarMoeda(valorReinvestir)}</div>
            </div>
            <div class="venda-resumo-item">
              <div class="venda-resumo-label">Total Desp. Adic.</div>
              <div class="venda-resumo-valor">${formatarMoeda(totalDespesasAdicionais)}</div>
            </div>
            <div class="venda-resumo-item">
              <div class="venda-resumo-label">Lucro</div>
              <div class="venda-resumo-valor ${lucro >= 0 ? 'lucro-positivo' : 'lucro-negativo'}">${formatarMoeda(lucro)}</div>
            </div>
          </div>
        </div>
        
        <div style="margin-top: 10px;">
          <button class="btn btn-secondary btn-detalhes-venda" data-id="${venda.id}">Ver Detalhes</button>
          <button class="btn btn-primary btn-editar-venda" data-id="${venda.id}">Editar</button>
          <button class="btn btn-danger btn-excluir-venda" data-id="${venda.id}">Excluir</button>
        </div>
      `;
      container.appendChild(card);
    });
    
    // Adicionar eventos aos botões
    document.querySelectorAll('.btn-detalhes-venda').forEach(btn => {
      btn.addEventListener('click', function() {
        const id = this.getAttribute('data-id');
        mostrarDetalhesVenda(id);
      });
    });
    
    document.querySelectorAll('.btn-editar-venda').forEach(btn => {
      btn.addEventListener('click', function() {
        const id = this.getAttribute('data-id');
        mostrarFormEditarVenda(id);
      });
    });
    
    document.querySelectorAll('.btn-excluir-venda').forEach(btn => {
      btn.addEventListener('click', function() {
        const id = this.getAttribute('data-id');
        confirmarExclusaoVenda(id);
      });
    });
  }
  
  // Evento para fechar o modal de detalhes de venda
  const btnFecharDetalhesVenda = document.getElementById('fechar-detalhes-venda');
  if (btnFecharDetalhesVenda) {
    btnFecharDetalhesVenda.addEventListener('click', function() {
      document.getElementById('venda-details-modal').classList.add('hidden');
    });
  }
  
  // Adicionar um campo de ingrediente inicial na tela de receitas
  if (document.getElementById('lista-ingredientes')) {
    adicionarCampoIngrediente();
  }
}

// MODIFICADO: Inicializar dados com nova lógica de cálculos
function inicializarDados() {
  // Garantir que o modal esteja oculto ao iniciar
  const modalElement = document.getElementById('processing-modal');
  if (modalElement) {
    modalElement.classList.add('hidden');
  }
  
  // Inicializar IDs para itens de estoque e materiais
  estoque.forEach((item) => {
    if (!item.id) {
      item.id = gerarId();
    }
    if (!item.materialId && item.codigo) {
      // Tentar encontrar material correspondente
      const material = materiais.find(m => m.codigo === item.codigo);
      if (material) {
        item.materialId = material.id;
      }
    }
  });
  
  materiais.forEach((material) => {
    if (!material.id) {
      material.id = gerarId();
    }
    
    // Garantir que o histórico de preços existe
    if (!material.historicoPrecos) {
      material.historicoPrecos = [{
        data: material.dataCadastro || new Date().toISOString(),
        preco: material.ultimoPreco || 0
      }];
    }
  });
  
  receitas.forEach(receita => {
    if (!receita.id) {
      receita.id = gerarId();
    }
    
    // Remover ingredientes que não têm materialId válido
    if (receita.ingredientes) {
      receita.ingredientes = receita.ingredientes.filter(ing => {
        return ing.materialId && materiais.some(m => m.id === ing.materialId);
      });
    } else {
      receita.ingredientes = [];
    }
    
    // Garantir que precoVenda existe
    if (!receita.precoVenda) {
      const custoProducao = calcularCustoReceita(receita);
      const custosVariados = custoProducao * 0.1;
      receita.precoVenda = (custoProducao + custosVariados) * 2.5;
    }
  });
  
  // MODIFICADO: Atualizar vendas antigas para o novo modelo de cálculo
  vendas.forEach(venda => {
    if (!venda.id) {
      venda.id = gerarId();
    }
    
    // Para compatibilidade com vendas antigas
    const custoProducao = venda.custoProducao || 0;
    const custosVariados = venda.custosVariados || 0;
    
    // Despesa = custo produção + custo variado
    const despesa = custoProducao + custosVariados;
    
    // Renomear campo de despesas adicionais para compatibilidade
    if (venda.despesasAdicionais !== undefined && venda.despesasAdicionaisOriginal === undefined) {
      venda.despesasAdicionaisOriginal = venda.despesasAdicionais;
      delete venda.despesasAdicionais; // Remover campo antigo
    }
    
    // Calcular despesas adicionais com acréscimo de 10%
    venda.despesasAdicionaisComAcrescimo = (venda.despesasAdicionaisOriginal || 0) * 1.1;
    
    // Total despesas adicionais (despesa adicional com acréscimo + frete + decoração)
    venda.totalDespesasAdicionais = venda.despesasAdicionaisComAcrescimo + (venda.custoFrete || 0) + (venda.custoDecoracao || 0);
    
    // Atualizar campos de cálculo financeiro
    venda.despesa = despesa;
    venda.valorReinvestir = despesa;
    
    // CORRIGIDO: Novo cálculo de lucro
    // Lucro = Valor Total - Despesa - Reinvestir - Despesas Adicionais Total
    venda.lucro = venda.valorTotal - despesa - despesa - venda.totalDespesasAdicionais;
  });
  
  atualizarLocalStorage();
}

function confirmarExclusaoVenda(vendaId) {
  document.getElementById('excluir-venda-id').value = vendaId;
  document.getElementById('confirmar-exclusao-modal').classList.remove('hidden');
}

// Carregar a lista de vendas - MODIFICADA
function carregarVendas() {
  const container = document.getElementById('lista-vendas');
  if (!container) return;
  
  container.innerHTML = '';
  
  if (vendas.length === 0) {
    container.innerHTML = '<p>Nenhuma venda registrada.</p>';
    return;
  }
  
  // Ordenar vendas da mais recente para a mais antiga
  const vendasOrdenadas = [...vendas].sort((a, b) => new Date(b.data) - new Date(a.data));
  
  vendasOrdenadas.forEach((venda) => {
    // Cálculo dos valores financeiros
    const despesa = venda.despesa || (venda.custoProducao + venda.custosVariados);
    const valorReinvestir = despesa;
    
    // Compatibilidade com vendas antigas
    const despesasAdicionaisComAcrescimo = venda.despesasAdicionaisComAcrescimo || 
                                      ((venda.despesasAdicionaisOriginal || venda.despesasAdicionais || 0) * 1.1);
    const totalDespesasAdicionais = venda.totalDespesasAdicionais || 
                                  (despesasAdicionaisComAcrescimo + (venda.custoFrete || 0) + (venda.custoDecoracao || 0));
    
    // Recalcular lucro corretamente
    const lucro = venda.valorTotal - despesa - valorReinvestir - totalDespesasAdicionais;
    
    const card = document.createElement('div');
    card.className = 'sale-card';
    card.innerHTML = `
      <div class="sale-header">
        <div class="sale-title">${venda.receitaNome}</div>
        <div class="sale-date">${formatarData(venda.data)}</div>
      </div>
      <div>Cliente: ${venda.cliente.nome}</div>
      <div>Quantidade: ${venda.quantidade}</div>
      
      <div class="venda-resumo-financeiro" style="margin-top: 10px;">
        <div class="venda-resumo-grid">
          <div class="venda-resumo-item">
            <div class="venda-resumo-label">Valor Total</div>
            <div class="venda-resumo-valor">${formatarMoeda(venda.valorTotal)}</div>
          </div>
          <div class="venda-resumo-item">
            <div class="venda-resumo-label">Despesa</div>
            <div class="venda-resumo-valor">${formatarMoeda(despesa)}</div>
          </div>
          <div class="venda-resumo-item">
            <div class="venda-resumo-label">Reinvestir</div>
            <div class="venda-resumo-valor">${formatarMoeda(valorReinvestir)}</div>
          </div>
          <div class="venda-resumo-item">
            <div class="venda-resumo-label">Total Desp. Adic.</div>
            <div class="venda-resumo-valor">${formatarMoeda(totalDespesasAdicionais)}</div>
          </div>
          <div class="venda-resumo-item">
            <div class="venda-resumo-label">Lucro</div>
            <div class="venda-resumo-valor ${lucro >= 0 ? 'lucro-positivo' : 'lucro-negativo'}">${formatarMoeda(lucro)}</div>
          </div>
        </div>
      </div>
      
      <div style="margin-top: 10px;">
        <button class="btn btn-secondary btn-detalhes-venda" data-id="${venda.id}">Ver Detalhes</button>
        <button class="btn btn-primary btn-editar-venda" data-id="${venda.id}">Editar</button>
        <button class="btn btn-danger btn-excluir-venda" data-id="${venda.id}">Excluir</button>
      </div>
    `;
    container.appendChild(card);
  });
  
  // Adicionar eventos aos botões
  document.querySelectorAll('.btn-detalhes-venda').forEach(btn => {
    btn.addEventListener('click', function() {
      const id = this.getAttribute('data-id');
      mostrarDetalhesVenda(id);
    });
  });
  
  document.querySelectorAll('.btn-editar-venda').forEach(btn => {
    btn.addEventListener('click', function() {
      const id = this.getAttribute('data-id');
      mostrarFormEditarVenda(id);
    });
  });
  
  document.querySelectorAll('.btn-excluir-venda').forEach(btn => {
    btn.addEventListener('click', function() {
      const id = this.getAttribute('data-id');
      confirmarExclusaoVenda(id);
    });
  });
}

// CORRIGIDO: Inicialização principal única do aplicativo
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM Carregado!');
  
  // Verificar autenticação do Firebase
  firebase.auth().onAuthStateChanged((user) => {
    if (user) {
      // Usuário está logado
      currentUser = user;
      
      // Mostrar email do usuário
      const userInfoEl = document.getElementById('user-info');
      if (userInfoEl) {
        userInfoEl.classList.remove('hidden');
        document.getElementById('user-email').textContent = user.email;
      }
      
      // Carregar dados e iniciar sincronização
      estoque = JSON.parse(localStorage.getItem('estoque')) || [];
      materiais = JSON.parse(localStorage.getItem('materiais')) || [];
      receitas = JSON.parse(localStorage.getItem('receitas')) || [];
      vendas = JSON.parse(localStorage.getItem('vendas')) || [];
      
      inicializarDados();
      iniciarSincronizacao();
      
      // Carregar interfaces
      carregarEstoque();
      carregarMateriais();
      carregarReceitas();
      carregarVendas();
      
      // Configurar eventos
      setupEventListeners();
      setupAdditionalEvents();
      
      // Iniciar relógio
      atualizarDataHora();
      setInterval(atualizarDataHora, 1000);
    } else {
      // Usuário não está logado, mostrar tela de login
      mostrarTelaLogin();
    }
  });
});
</script>
</body>
</html>

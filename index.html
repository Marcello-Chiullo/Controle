<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Sistema de Controle Gerencial para Confeitaria - Deia Cakes">
    <title>Deia Cakes - Controle Gerencial v2.0</title>
    
    <!-- Firebase SDK v9 (Compat para facilitar migra√ß√£o) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- Biblioteca para Scanner de C√≥digo de Barras -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.4/html5-qrcode.min.js"></script>
    
    <style>
        /* ====================================
           RESET E VARI√ÅVEIS GLOBAIS
           ==================================== */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            /* Cores principais */
            --cor-primaria: #ff85a2;
            --cor-primaria-escura: #ff6b8f;
            --cor-secundaria: #ffb5c8;
            --cor-secundaria-clara: #ffe0e8;
            
            /* Cores de status */
            --cor-sucesso: #28a745;
            --cor-sucesso-claro: #d4edda;
            --cor-erro: #dc3545;
            --cor-erro-claro: #f8d7da;
            --cor-aviso: #ffc107;
            --cor-aviso-claro: #fff3cd;
            --cor-info: #17a2b8;
            --cor-info-claro: #d1ecf1;
            
            /* Cores neutras */
            --cor-texto: #333333;
            --cor-texto-claro: #666666;
            --cor-borda: #dddddd;
            --cor-fundo: #f8f9fa;
            --cor-branco: #ffffff;
            
            /* Sombras */
            --sombra-leve: 0 2px 4px rgba(0, 0, 0, 0.1);
            --sombra-media: 0 4px 8px rgba(0, 0, 0, 0.1);
            --sombra-forte: 0 8px 16px rgba(0, 0, 0, 0.15);
            
            /* Transi√ß√µes */
            --transicao-rapida: 0.2s ease;
            --transicao-normal: 0.3s ease;
            
            /* Espa√ßamentos */
            --espacamento-xs: 5px;
            --espacamento-sm: 10px;
            --espacamento-md: 15px;
            --espacamento-lg: 20px;
            --espacamento-xl: 30px;
            
            /* Bordas */
            --borda-radius: 8px;
            --borda-radius-sm: 5px;
        }
        
        /* ====================================
           ESTILOS GERAIS
           ==================================== */
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--cor-texto);
            background-color: var(--cor-fundo);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--espacamento-lg);
        }
        
        /* ====================================
           HEADER
           ==================================== */
        
        header {
            background: linear-gradient(135deg, var(--cor-primaria) 0%, var(--cor-primaria-escura) 100%);
            color: var(--cor-branco);
            padding: var(--espacamento-md) 0;
            box-shadow: var(--sombra-media);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 var(--espacamento-lg);
        }
        
        .header-logo h1 {
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--espacamento-sm);
        }
        
        .header-logo h1::before {
            content: "üéÇ";
            font-size: 28px;
        }
        
        #user-info {
            display: flex;
            align-items: center;
            gap: var(--espacamento-md);
            font-size: 14px;
        }
        
        #user-email {
            background: rgba(255, 255, 255, 0.2);
            padding: var(--espacamento-xs) var(--espacamento-sm);
            border-radius: var(--borda-radius-sm);
            display: flex;
            align-items: center;
            gap: var(--espacamento-xs);
        }
        
        #user-email::before {
            content: "üë§";
        }
        
        #btn-logout,
        #btn-admin-nav {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: var(--cor-branco);
            padding: var(--espacamento-xs) var(--espacamento-md);
            border-radius: var(--borda-radius-sm);
            cursor: pointer;
            transition: var(--transicao-rapida);
            font-size: 13px;
        }
        
        #btn-logout:hover,
        #btn-admin-nav:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        
        #date-time {
            font-size: 13px;
            opacity: 0.9;
        }
        
        /* ====================================
           NAVEGA√á√ÉO PRINCIPAL
           ==================================== */
        
        nav {
            background-color: var(--cor-secundaria);
            box-shadow: var(--sombra-leve);
        }
        
        nav ul {
            display: flex;
            list-style: none;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 var(--espacamento-lg);
            gap: var(--espacamento-xs);
        }
        
        nav ul li a {
            display: block;
            color: var(--cor-texto);
            text-decoration: none;
            font-weight: 500;
            padding: var(--espacamento-md) var(--espacamento-lg);
            border-radius: var(--borda-radius-sm) var(--borda-radius-sm) 0 0;
            transition: var(--transicao-rapida);
            position: relative;
        }
        
        nav ul li a:hover {
            background-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }
        
        nav ul li a.active {
            background-color: var(--cor-primaria);
            color: var(--cor-branco);
        }
        
        nav ul li a.active::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background-color: var(--cor-branco);
        }
        
        /* ====================================
           CARDS E CONTAINERS
           ==================================== */
        
        .card {
            background-color: var(--cor-branco);
            border-radius: var(--borda-radius);
            box-shadow: var(--sombra-leve);
            padding: var(--espacamento-lg);
            margin-bottom: var(--espacamento-lg);
            transition: var(--transicao-normal);
        }
        
        .card:hover {
            box-shadow: var(--sombra-media);
        }
        
        .card h2,
        .card h3 {
            color: var(--cor-primaria);
            margin-bottom: var(--espacamento-md);
            display: flex;
            align-items: center;
            gap: var(--espacamento-sm);
        }
        
        .card h2 {
            font-size: 22px;
            border-bottom: 2px solid var(--cor-secundaria-clara);
            padding-bottom: var(--espacamento-sm);
        }
        
        .card h3 {
            font-size: 18px;
        }
        
        /* ====================================
           BOT√ïES
           ==================================== */
        
        .btn {
            padding: var(--espacamento-sm) var(--espacamento-lg);
            border: none;
            border-radius: var(--borda-radius-sm);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transicao-rapida);
            display: inline-flex;
            align-items: center;
            gap: var(--espacamento-xs);
            text-decoration: none;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--sombra-media);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-primary {
            background-color: var(--cor-primaria);
            color: var(--cor-branco);
        }
        
        .btn-primary:hover {
            background-color: var(--cor-primaria-escura);
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: var(--cor-branco);
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .btn-success {
            background-color: var(--cor-sucesso);
            color: var(--cor-branco);
        }
        
        .btn-success:hover {
            background-color: #218838;
        }
        
        .btn-danger {
            background-color: var(--cor-erro);
            color: var(--cor-branco);
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .btn-info {
            background-color: var(--cor-info);
            color: var(--cor-branco);
        }
        
        .btn-info:hover {
            background-color: #138496;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* ====================================
           FORMUL√ÅRIOS
           ==================================== */
        
        .form-group {
            margin-bottom: var(--espacamento-md);
        }
        
        .form-group label {
            display: block;
            margin-bottom: var(--espacamento-xs);
            font-weight: 500;
            color: var(--cor-texto);
            font-size: 14px;
        }
        
        .form-control {
            width: 100%;
            padding: var(--espacamento-sm);
            border: 1px solid var(--cor-borda);
            border-radius: var(--borda-radius-sm);
            font-size: 14px;
            font-family: inherit;
            transition: var(--transicao-rapida);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--cor-primaria);
            box-shadow: 0 0 0 3px rgba(255, 133, 162, 0.1);
        }
        
        .form-control:disabled {
            background-color: var(--cor-fundo);
            cursor: not-allowed;
        }
        
        .form-row {
            display: flex;
            gap: var(--espacamento-md);
            margin-bottom: var(--espacamento-md);
        }
        
        .form-col {
            flex: 1;
        }
        
        textarea.form-control {
            resize: vertical;
            min-height: 80px;
        }
        
        /* ====================================
           TABELAS
           ==================================== */
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: var(--espacamento-md);
        }
        
        table th,
        table td {
            padding: var(--espacamento-sm) var(--espacamento-md);
            text-align: left;
            border-bottom: 1px solid var(--cor-borda);
        }
        
        table th {
            background-color: var(--cor-fundo);
            font-weight: 600;
            color: var(--cor-texto);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        table tr:hover {
            background-color: var(--cor-secundaria-clara);
        }
        
        table td {
            font-size: 14px;
        }
        
        /* ====================================
           TABS (ABAS)
           ==================================== */
        
        .tab-buttons {
            display: flex;
            gap: var(--espacamento-xs);
            margin-bottom: var(--espacamento-lg);
            border-bottom: 2px solid var(--cor-borda);
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: var(--espacamento-sm) var(--espacamento-lg);
            border: none;
            background-color: transparent;
            cursor: pointer;
            transition: var(--transicao-rapida);
            border-radius: var(--borda-radius-sm) var(--borda-radius-sm) 0 0;
            font-weight: 500;
            color: var(--cor-texto-claro);
            position: relative;
        }
        
        .tab-button:hover {
            background-color: var(--cor-secundaria-clara);
            color: var(--cor-texto);
        }
        
        .tab-button.active {
            background-color: var(--cor-primaria);
            color: var(--cor-branco);
        }
        
        .tab-button.active::after {
            content: "";
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--cor-primaria);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* ====================================
           P√ÅGINAS
           ==================================== */
        
        .page-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .page-content.active {
            display: block;
        }
        
        /* ====================================
           MODAIS
           ==================================== */
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.2s ease-in-out;
        }
        
        .modal-content {
            background-color: var(--cor-branco);
            padding: var(--espacamento-xl);
            border-radius: var(--borda-radius);
            box-shadow: var(--sombra-forte);
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            width: 600px;
            animation: slideUp 0.3s ease-in-out;
        }
        
        .modal-content h3 {
            margin-bottom: var(--espacamento-lg);
            color: var(--cor-primaria);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--espacamento-lg);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--cor-texto-claro);
            transition: var(--transicao-rapida);
        }
        
        .modal-close:hover {
            color: var(--cor-erro);
            transform: scale(1.1);
        }
        
        /* ====================================
           NOTIFICA√á√ïES
           ==================================== */
        
        .notification {
            padding: var(--espacamento-md);
            border-radius: var(--borda-radius-sm);
            margin-bottom: var(--espacamento-md);
            animation: fadeIn 0.3s ease-in-out;
            display: flex;
            align-items: center;
            gap: var(--espacamento-sm);
        }
        
        .notification::before {
            font-size: 20px;
        }
        
        .notification-success {
            background-color: var(--cor-sucesso-claro);
            color: #155724;
            border-left: 4px solid var(--cor-sucesso);
        }
        
        .notification-success::before {
            content: "‚úì";
        }
        
        .notification-error {
            background-color: var(--cor-erro-claro);
            color: #721c24;
            border-left: 4px solid var(--cor-erro);
        }
        
        .notification-error::before {
            content: "‚úï";
        }
        
        .notification-warning {
            background-color: var(--cor-aviso-claro);
            color: #856404;
            border-left: 4px solid var(--cor-aviso);
        }
        
        .notification-warning::before {
            content: "‚ö†";
        }
        
        .notification-info {
            background-color: var(--cor-info-claro);
            color: #0c5460;
            border-left: 4px solid var(--cor-info);
        }
        
        .notification-info::before {
            content: "‚Ñπ";
        }
        
        /* Toast Notifications (canto inferior direito) */
        .toast-notification {
            position: fixed;
            bottom: var(--espacamento-lg);
            right: var(--espacamento-lg);
            background-color: var(--cor-sucesso);
            color: var(--cor-branco);
            padding: var(--espacamento-md) var(--espacamento-lg);
            border-radius: var(--borda-radius);
            box-shadow: var(--sombra-forte);
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: var(--espacamento-sm);
            min-width: 300px;
            animation: slideInRight 0.3s ease-in-out, slideOutRight 0.3s ease-in-out 2.7s;
        }
        
        .toast-notification.error {
            background-color: var(--cor-erro);
        }
        
        .toast-notification.warning {
            background-color: var(--cor-aviso);
            color: var(--cor-texto);
        }
        
        .toast-notification.info {
            background-color: var(--cor-info);
        }
        
        /* ====================================
           LOADER
           ==================================== */
        
        .loader {
            border: 4px solid var(--cor-secundaria-clara);
            border-top: 4px solid var(--cor-primaria);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: var(--espacamento-lg) auto;
        }
        
        /* ====================================
           UTILIT√ÅRIOS
           ==================================== */
        
        .hidden {
            display: none !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-right {
            text-align: right;
        }
        
        .mt-1 { margin-top: var(--espacamento-xs); }
        .mt-2 { margin-top: var(--espacamento-sm); }
        .mt-3 { margin-top: var(--espacamento-md); }
        .mt-4 { margin-top: var(--espacamento-lg); }
        
        .mb-1 { margin-bottom: var(--espacamento-xs); }
        .mb-2 { margin-bottom: var(--espacamento-sm); }
        .mb-3 { margin-bottom: var(--espacamento-md); }
        .mb-4 { margin-bottom: var(--espacamento-lg); }
        
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-success {
            background-color: var(--cor-sucesso-claro);
            color: var(--cor-sucesso);
        }
        
        .badge-warning {
            background-color: var(--cor-aviso-claro);
            color: #856404;
        }
        
        .badge-danger {
            background-color: var(--cor-erro-claro);
            color: var(--cor-erro);
        }
        
        .badge-info {
            background-color: var(--cor-info-claro);
            color: var(--cor-info);
        }
        
        /* ====================================
           ANIMA√á√ïES
           ==================================== */
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ====================================
           RESPONSIVIDADE
           ==================================== */
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: var(--espacamento-sm);
            }
            
            nav ul {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            nav ul li a {
                padding: var(--espacamento-sm) var(--espacamento-md);
                font-size: 13px;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .modal-content {
                width: 95%;
                padding: var(--espacamento-lg);
            }
            
            .toast-notification {
                left: var(--espacamento-sm);
                right: var(--espacamento-sm);
                bottom: var(--espacamento-sm);
            }
            
            table {
                font-size: 12px;
            }
            
            table th,
            table td {
                padding: var(--espacamento-xs) var(--espacamento-sm);
            }
        }
        
        /* ====================================
           CALEND√ÅRIO (Preview)
           ==================================== */
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: var(--espacamento-xs);
            margin-top: var(--espacamento-md);
        }
        
        .calendar-day {
            aspect-ratio: 1;
            border: 1px solid var(--cor-borda);
            border-radius: var(--borda-radius-sm);
            padding: var(--espacamento-xs);
            text-align: center;
            cursor: pointer;
            transition: var(--transicao-rapida);
            position: relative;
        }
        
        .calendar-day:hover {
            background-color: var(--cor-secundaria-clara);
            transform: scale(1.05);
        }
        
        .calendar-day.has-delivery {
            background-color: var(--cor-primaria);
            color: var(--cor-branco);
            font-weight: 600;
        }
        
        .calendar-day.selected {
            border: 2px solid var(--cor-primaria);
            box-shadow: var(--sombra-media);
        }
        
        .calendar-day-number {
            font-size: 14px;
            font-weight: 600;
        }
        
        .calendar-day-indicator {
            font-size: 10px;
            margin-top: 2px;
        }
    </style>
</head>
<body>
    
    <!-- ====================================
         HEADER
         ==================================== -->
    
    <header>
        <div class="header-content">
            <div class="header-logo">
                <h1>Deia Cakes Controle Gerencial</h1>
            </div>
            <div id="user-info" class="hidden">
                <span id="user-email"></span>
                <button id="btn-admin-nav" class="hidden">üë• Navegar Usu√°rios</button>
                <button id="btn-upload-firebase" class="hidden">‚¨ÜÔ∏è Enviar</button>
                <button id="btn-download-firebase" class="hidden">‚¨áÔ∏è Buscar</button>
                <button id="btn-logout">üö™ Sair</button>
            </div>
            <div>
                <span id="date-time"></span>
            </div>
        </div>
    </header>
    
    <!-- ====================================
         NAVEGA√á√ÉO PRINCIPAL
         ==================================== -->
    
    <nav>
        <ul>
            <li><a href="#estoque" class="nav-link active" data-page="estoque">üì¶ Estoque</a></li>
            <li><a href="#materiais" class="nav-link" data-page="materiais">üè∑Ô∏è Materiais</a></li>
            <li><a href="#sub-receitas" class="nav-link" data-page="sub-receitas">üß© Sub-Receitas</a></li>
            <li><a href="#produtos" class="nav-link" data-page="produtos">üéÇ Produtos</a></li>
            <li><a href="#vendas" class="nav-link" data-page="vendas">üí∞ Vendas</a></li>
            <li><a href="#clientes" class="nav-link" data-page="clientes">üë• Clientes</a></li>
            <li><a href="#revendedores" class="nav-link" data-page="revendedores">ü§ù Revendedores</a></li>
            <li><a href="#calendario" class="nav-link" data-page="calendario">üìÖ Calend√°rio</a></li>
            <li><a href="#configuracoes" class="nav-link" data-page="configuracoes">‚öôÔ∏è Configura√ß√µes</a></li>
        </ul>
    </nav>
    
    <!-- ====================================
         CONTAINER PRINCIPAL - P√ÅGINAS
         ==================================== -->
    
    <div class="container">
        
        <!-- P√ÅGINA: ESTOQUE -->
        <div id="estoque-page" class="page-content active">
            <h2>üì¶ Gest√£o de Estoque</h2>
            <div class="card">
                <h3>Itens em Estoque</h3>
                <p>Carregando...</p>
            </div>
        </div>
        
        <!-- P√ÅGINA: MATERIAIS -->
        <div id="materiais-page" class="page-content">
            <h2>üè∑Ô∏è Gest√£o de Materiais</h2>
            <div class="card">
                <p>Carregando...</p>
            </div>
        </div>
        
        <!-- P√ÅGINA: SUB-RECEITAS -->
        <div id="sub-receitas-page" class="page-content">
            <h2>üß© Gest√£o de Sub-Receitas</h2>
            <div class="card">
                <p>Carregando...</p>
            </div>
        </div>
        
        <!-- P√ÅGINA: PRODUTOS -->
        <div id="produtos-page" class="page-content">
            <h2>üéÇ Gest√£o de Produtos</h2>
            <div class="card">
                <p>Carregando...</p>
            </div>
        </div>
        
        <!-- P√ÅGINA: VENDAS -->
        <div id="vendas-page" class="page-content">
            <h2>üí∞ Gest√£o de Vendas</h2>
            <div class="card">
                <p>Carregando...</p>
            </div>
        </div>

        <!-- P√ÅGINA: CLIENTES -->
        <div id="clientes-page" class="page-content">
            <h2>üë• Gest√£o de Clientes (CRM)</h2>
            <div class="card">
                <p>Carregando...</p>
            </div>
        </div>

        <!-- P√ÅGINA: REVENDEDORES -->
        <div id="revendedores-page" class="page-content">
            <h2>ü§ù Gest√£o de Revendedores</h2>
            <div class="card">
                <p>Carregando...</p>
            </div>
        </div>
        
        <!-- P√ÅGINA: CALEND√ÅRIO -->
        <div id="calendario-page" class="page-content">
            <h2>üìÖ Calend√°rio de Entregas</h2>
            <div class="card">
                <p>Carregando...</p>
            </div>
        </div>

        <!-- P√ÅGINA: CONFIGURA√á√ïES -->
        <div id="configuracoes-page" class="page-content">
            <h2>‚öôÔ∏è Configura√ß√µes do Sistema</h2>
            <div class="card">
                <p>Carregando...</p>
            </div>
        </div>
        
    </div>
    
    <!-- ====================================
         MODAL: LOGIN
         ==================================== -->
    
    <div id="login-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>üîê Login - Deia Cakes</h3>
            <div id="login-notification"></div>
            
            <div class="form-group">
                <label for="login-email">Email:</label>
                <input type="email" id="login-email" class="form-control" placeholder="seu@email.com" required>
            </div>
            
            <div class="form-group">
                <label for="login-senha">Senha:</label>
                <input type="password" id="login-senha" class="form-control" placeholder="Sua senha" required>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button id="btn-login" class="btn btn-primary" style="flex: 1;">üîë Entrar</button>
                <button id="btn-cadastrar" class="btn btn-secondary" style="flex: 1;">‚ûï Cadastrar</button>
            </div>
        </div>
    </div>
    
    <!-- ====================================
         MODAL: PROCESSAMENTO
         ==================================== -->
    
    <div id="processing-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <h3 id="modal-title">Processando...</h3>
            <div class="loader"></div>
            <p id="modal-message">Aguarde enquanto processamos as informa√ß√µes.</p>
        </div>
    </div>
    
    <!-- ====================================
         JAVASCRIPT
         ==================================== -->
    
    <script>
        // ====================================
        // CONFIGURA√á√ÉO DO FIREBASE
        // ====================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyABzQdTgR9-Al-drNRMBcEb1dN76wUjqvY",
            authDomain: "deiacontrole-faabc.firebaseapp.com",
            databaseURL: "https://deiacontrole-faabc-default-rtdb.firebaseio.com",
            projectId: "deiacontrole-faabc",
            storageBucket: "deiacontrole-faabc.firebasestorage.app",
            messagingSenderId: "216368622292",
            appId: "1:216368622292:web:20522a4725c30907c92941",
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        
        // ====================================
        // VARI√ÅVEIS GLOBAIS
        // ====================================
        
        let currentUser = null;
        let isAdmin = false;
        let visualizandoUsuario = null; // Para quando ADM navega entre usu√°rios

        // Configura√ß√µes de custos e markup
        let configuracoesCustos = {
            fixos: {
                salarioDesejado: 0,
                luz: 0,
                agua: 0,
                internet: 0,
                gas: 0,
                aluguel: 0,
                outros: 0,
                total: 0
            },
            metaProducao: 50, // unidades/m√™s (padr√£o)
            margemLucroDesejada: 30, // % (padr√£o)
            custoFixoPorUnidade: 0,
            markupPercentual: 0,
            multiplicadorMarkup: 1
        };
        
        // Dados do sistema
        let materiais = [];
        let subReceitas = []; // üÜï Componentes reutiliz√°veis
        let produtosFinais = []; // üÜï Produtos que ser√£o vendidos
        let vendas = [];
        let clientes = []; // üÜï Sistema de CRM
        let revendedores = []; // üÜï Sistema de Revendedores
        let estoque = []; // Ser√° sempre calculado, n√£o armazenado
        
        // Arrays tempor√°rios para formul√°rios
        let produtosVendaTemp = []; // üÜï NOVO - substitui receitasVendaTemp
        
        // Scanner de QR Code
        let html5QrCode = null;
        
        // Constantes
        const EMAIL_ADMIN = "marcellochiullo@gmail.com";
        
        // ====================================
        // FUN√á√ïES UTILIT√ÅRIAS
        // ====================================
        
        /**
         * Gera ID √∫nico
         */
        function gerarId() {
            return 'id_' + Date.now().toString(36) + '_' + Math.random().toString(36).substring(2, 11);
        }
        
        /**
         * Formata data para exibi√ß√£o (CORRIGIDO - sem problema de fuso)
         */
        function formatarData(data) {
            if (!data) return 'Data inv√°lida';
            
            try {
                const d = new Date(data);
                
                // Usar UTC para evitar problema de fuso hor√°rio
                const dia = String(d.getUTCDate()).padStart(2, '0');
                const mes = String(d.getUTCMonth() + 1).padStart(2, '0');
                const ano = d.getUTCFullYear();
                
                return `${dia}/${mes}/${ano}`;
            } catch (e) {
                return 'Data inv√°lida';
            }
        }

        /**
         * Converte data do input (YYYY-MM-DD) para ISO sem problema de fuso hor√°rio
         */
        function dataInputParaISO(dataInput) {
            if (!dataInput) return new Date().toISOString();
            
            // Adicionar hor√°rio meio-dia para evitar problema de fuso
            return new Date(dataInput + 'T12:00:00').toISOString();
        }
        
        /**
         * Converte data ISO para formato do input (YYYY-MM-DD)
         */
        function dataISOParaInput(dataISO) {
            if (!dataISO) return '';
            
            try {
                const data = new Date(dataISO);
                // Usar toLocaleDateString para evitar problema de fuso
                const ano = data.getFullYear();
                const mes = String(data.getMonth() + 1).padStart(2, '0');
                const dia = String(data.getDate()).padStart(2, '0');
                return `${ano}-${mes}-${dia}`;
            } catch (e) {
                return '';
            }
        }

        /**
         * Formata quantidade grande em unidades maiores
         */
        function formatarQuantidadeGrande(quantidade, unidade) {
            if (unidade === 'ml' && quantidade >= 1000) {
                return `${(quantidade / 1000).toFixed(2)} L (${quantidade.toFixed(2)} ml)`;
            }
            if (unidade === 'g' && quantidade >= 1000) {
                return `${(quantidade / 1000).toFixed(2)} Kg (${quantidade.toFixed(2)} g)`;
            }
            return `${quantidade.toFixed(2)} ${unidade}`;
        }
        
        /**
         * Formata valor monet√°rio
         */
        function formatarMoeda(valor) {
            if (isNaN(valor)) valor = 0;
            return 'R$ ' + parseFloat(valor).toFixed(2).replace('.', ',');
        }
        
        /**
         * Normaliza nome para compara√ß√£o (remove acentos, lowercase, trim)
         */
        function normalizarNome(nome) {
            if (!nome) return '';
            return nome
                .toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .replace(/\s+/g, " ")
                .trim();
        }
        
        /**
         * Converte unidades (kg‚Üíg, l‚Üíml, etc)
         */
        function converterUnidade(quantidade, unidadeOrigem, unidadeDestino) {
            if (!unidadeOrigem || !unidadeDestino) return quantidade;
            
            const origem = unidadeOrigem.toLowerCase();
            const destino = unidadeDestino.toLowerCase();
            
            // Mesma unidade
            if (origem === destino) return quantidade;
            
            // kg ‚Üí g
            if (origem === 'kg' && destino === 'g') return quantidade * 1000;
            if (origem === 'g' && destino === 'kg') return quantidade / 1000;
            
            // l ‚Üí ml
            if (origem === 'l' && destino === 'ml') return quantidade * 1000;
            if (origem === 'ml' && destino === 'l') return quantidade / 1000;
            
            // Se n√£o houver convers√£o conhecida, retorna a quantidade original
            return quantidade;
        }
        
        /**
         * Mostra/esconde modal de processamento
         */
        function toggleModal(mostrar, titulo = "Processando...", mensagem = "Aguarde...") {
            const modal = document.getElementById('processing-modal');
            if (!modal) return;
            
            if (mostrar) {
                document.getElementById('modal-title').textContent = titulo;
                document.getElementById('modal-message').textContent = mensagem;
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }
        
        /**
         * Mostra notifica√ß√£o toast (canto inferior direito)
         */
        function mostrarToast(mensagem, tipo = 'success', duracao = 3000) {
            // Remove toast existente
            const toastExistente = document.querySelector('.toast-notification');
            if (toastExistente) {
                document.body.removeChild(toastExistente);
            }
            
            // Cria novo toast
            const toast = document.createElement('div');
            toast.className = `toast-notification ${tipo}`;
            toast.textContent = mensagem;
            
            document.body.appendChild(toast);
            
            // Remove ap√≥s dura√ß√£o especificada
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, duracao);
        }
        
        /**
         * Mostra notifica√ß√£o inline
         */
        function mostrarNotificacao(elementoId, mensagem, tipo = 'info', duracao = 5000) {
            const elemento = document.getElementById(elementoId);
            if (!elemento) return;
            
            elemento.className = `notification notification-${tipo}`;
            elemento.textContent = mensagem;
            elemento.classList.remove('hidden');
            
            if (duracao > 0) {
                setTimeout(() => {
                    elemento.classList.add('hidden');
                }, duracao);
            }
        }
        
        /**
         * Atualiza rel√≥gio no header
         */
        function atualizarDataHora() {
            const elemento = document.getElementById('date-time');
            if (!elemento) return;
            
            const agora = new Date();
            const opcoes = { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            elemento.textContent = agora.toLocaleString('pt-BR', opcoes);
        }
        
        // Atualiza rel√≥gio a cada segundo
        setInterval(atualizarDataHora, 1000);
        atualizarDataHora();
        
        /**
         * Salva dados no localStorage
         */
        function salvarLocalStorage() {
            try {
                localStorage.setItem('materiais', JSON.stringify(materiais));
                localStorage.setItem('subReceitas', JSON.stringify(subReceitas));
                localStorage.setItem('produtosFinais', JSON.stringify(produtosFinais));
                localStorage.setItem('vendas', JSON.stringify(vendas));
                localStorage.setItem('clientes', JSON.stringify(clientes));
                localStorage.setItem('revendedores', JSON.stringify(revendedores));
                localStorage.setItem('configuracoesCustos', JSON.stringify(configuracoesCustos));
                localStorage.setItem('ultimaAtualizacao', new Date().toISOString());
                return true;
            } catch (erro) {
                console.error('Erro ao salvar no localStorage:', erro);
                return false;
            }
        }
        
        /**
         * Carrega dados do localStorage
         */
        function carregarLocalStorage() {
            try {
                materiais = JSON.parse(localStorage.getItem('materiais')) || [];
                subReceitas = JSON.parse(localStorage.getItem('subReceitas')) || [];
                produtosFinais = JSON.parse(localStorage.getItem('produtosFinais')) || [];
                vendas = JSON.parse(localStorage.getItem('vendas')) || [];
                clientes = JSON.parse(localStorage.getItem('clientes')) || [];
                revendedores = JSON.parse(localStorage.getItem('revendedores')) || [];
                
                // Carregar configura√ß√µes de custos
                const configSalva = JSON.parse(localStorage.getItem('configuracoesCustos'));
                if (configSalva) {
                    configuracoesCustos = configSalva;
                }
                
                return true;
            } catch (erro) {
                console.error('Erro ao carregar do localStorage:', erro);
                materiais = [];
                subReceitas = [];
                produtosFinais = [];
                vendas = [];
                return false;
            }
        }

        /**
         * CALCULA MARKUP AUTOMATICAMENTE baseado nos custos fixos
         */
        function calcularMarkupAutomatico() {
            try {
                // 1. Calcular total de custos fixos
                const custos = configuracoesCustos.fixos;
                const totalFixo = parseFloat(custos.salarioDesejado) + 
                                 parseFloat(custos.luz) + 
                                 parseFloat(custos.agua) + 
                                 parseFloat(custos.internet) + 
                                 parseFloat(custos.gas) + 
                                 parseFloat(custos.aluguel) + 
                                 parseFloat(custos.outros);
                
                configuracoesCustos.fixos.total = totalFixo;
                
                // 2. Calcular custo fixo por unidade
                const metaProducao = parseFloat(configuracoesCustos.metaProducao) || 1;
                const custoFixoPorUnidade = totalFixo / metaProducao;
                configuracoesCustos.custoFixoPorUnidade = custoFixoPorUnidade;
                
                // 3. Calcular markup percentual
                // Markup = (Custo Fixo / Custo M√©dio Ingrediente) + Margem Lucro
                // Para simplificar, vamos usar um custo m√©dio de R$ 50 por produto
                const custoMedioIngrediente = 50; // Valor base para c√°lculo
                const margemLucro = parseFloat(configuracoesCustos.margemLucroDesejada) / 100;
                
                const markupPercentual = ((custoFixoPorUnidade / custoMedioIngrediente) + margemLucro) * 100;
                configuracoesCustos.markupPercentual = markupPercentual;
                
                // 4. Calcular multiplicador (para facilitar o uso)
                const multiplicador = 1 + (markupPercentual / 100);
                configuracoesCustos.multiplicadorMarkup = multiplicador;
                
                console.log('‚úÖ Markup calculado:', {
                    totalFixo: totalFixo,
                    custoFixoPorUnidade: custoFixoPorUnidade,
                    markupPercentual: markupPercentual.toFixed(2) + '%',
                    multiplicador: multiplicador.toFixed(2) + 'x'
                });
                
                return true;
            } catch (erro) {
                console.error('Erro ao calcular markup:', erro);
                return false;
            }
        }
        
        /**
         * SALVA CONFIGURA√á√ïES DE CUSTOS
         */
        function salvarConfiguracoesCustos(dados) {
            try {
                // Atualizar custos fixos
                configuracoesCustos.fixos = {
                    salarioDesejado: parseFloat(dados.salarioDesejado) || 0,
                    luz: parseFloat(dados.luz) || 0,
                    agua: parseFloat(dados.agua) || 0,
                    internet: parseFloat(dados.internet) || 0,
                    gas: parseFloat(dados.gas) || 0,
                    aluguel: parseFloat(dados.aluguel) || 0,
                    outros: parseFloat(dados.outros) || 0,
                    total: 0 // ser√° calculado
                };
                
                // Atualizar meta e margem
                configuracoesCustos.metaProducao = parseFloat(dados.metaProducao) || 50;
                configuracoesCustos.margemLucroDesejada = parseFloat(dados.margemLucroDesejada) || 30;
                
                // Recalcular markup
                calcularMarkupAutomatico();
                
                // Salvar
                salvarLocalStorage();
                sincronizarComNuvem();
                
                mostrarToast('Configura√ß√µes salvas! Markup recalculado automaticamente.', 'success');
                
                return true;
            } catch (erro) {
                console.error('Erro ao salvar configura√ß√µes:', erro);
                mostrarToast('Erro ao salvar configura√ß√µes: ' + erro.message, 'error');
                return false;
            }
        }

        // ====================================
        // SISTEMA DE CRM - N√çVEIS E CLIENTES
        // ====================================
        
        /**
         * DEFINI√á√ÉO DOS N√çVEIS DE CLIENTES
         */
        const NIVEIS_CLIENTE = {
            bronze: {
                nome: 'Bronze',
                icone: 'ü•â',
                minimo: 0,
                desconto: 0,
                beneficios: ['Nenhum benef√≠cio especial'],
                cor: '#cd7f32'
            },
            prata: {
                nome: 'Prata',
                icone: 'ü•à',
                minimo: 2500,
                desconto: 5,
                beneficios: ['5% de desconto', 'Brinde no anivers√°rio'],
                cor: '#c0c0c0'
            },
            ouro: {
                nome: 'Ouro',
                icone: 'ü•á',
                minimo: 5000,
                desconto: 10,
                beneficios: ['10% de desconto', 'Entrega gr√°tis', 'Brinde no anivers√°rio'],
                cor: '#ffd700'
            },
            diamante: {
                nome: 'Diamante',
                icone: 'üíé',
                minimo: 10000,
                desconto: 15,
                beneficios: ['15% de desconto', 'Entrega gr√°tis', 'Brinde especial', 'Atendimento priorit√°rio'],
                cor: '#b9f2ff'
            }
        };
        
        /**
         * CALCULA N√çVEL DO CLIENTE baseado no total gasto
         */
        function calcularNivelCliente(totalGasto) {
            if (totalGasto >= NIVEIS_CLIENTE.diamante.minimo) return 'diamante';
            if (totalGasto >= NIVEIS_CLIENTE.ouro.minimo) return 'ouro';
            if (totalGasto >= NIVEIS_CLIENTE.prata.minimo) return 'prata';
            return 'bronze';
        }
        
        /**
         * OBT√âM INFORMA√á√ïES DO N√çVEL
         */
        function getNivelInfo(nivelId) {
            return NIVEIS_CLIENTE[nivelId] || NIVEIS_CLIENTE.bronze;
        }
        
        /**
         * CALCULA PROGRESSO PARA PR√ìXIMO N√çVEL
         */
        function calcularProgressoNivel(totalGasto) {
            const nivelAtual = calcularNivelCliente(totalGasto);
            
            let proximoNivel = null;
            let faltaParaProximo = 0;
            let progresso = 0;
            
            if (nivelAtual === 'bronze') {
                proximoNivel = 'prata';
                faltaParaProximo = NIVEIS_CLIENTE.prata.minimo - totalGasto;
                progresso = (totalGasto / NIVEIS_CLIENTE.prata.minimo) * 100;
            } else if (nivelAtual === 'prata') {
                proximoNivel = 'ouro';
                faltaParaProximo = NIVEIS_CLIENTE.ouro.minimo - totalGasto;
                progresso = ((totalGasto - NIVEIS_CLIENTE.prata.minimo) / 
                            (NIVEIS_CLIENTE.ouro.minimo - NIVEIS_CLIENTE.prata.minimo)) * 100;
            } else if (nivelAtual === 'ouro') {
                proximoNivel = 'diamante';
                faltaParaProximo = NIVEIS_CLIENTE.diamante.minimo - totalGasto;
                progresso = ((totalGasto - NIVEIS_CLIENTE.ouro.minimo) / 
                            (NIVEIS_CLIENTE.diamante.minimo - NIVEIS_CLIENTE.ouro.minimo)) * 100;
            } else {
                proximoNivel = null;
                faltaParaProximo = 0;
                progresso = 100;
            }
            
            return {
                nivelAtual: nivelAtual,
                proximoNivel: proximoNivel,
                faltaParaProximo: Math.max(0, faltaParaProximo),
                progresso: Math.min(100, progresso)
            };
        }
        
        /**
         * BUSCA CLIENTE POR TELEFONE
         */
        function buscarClientePorTelefone(telefone) {
            if (!telefone) return null;
            
            // Normalizar telefone (remover formata√ß√£o)
            const telNormalizado = telefone.replace(/\D/g, '');
            
            return clientes.find(c => {
                const telCliente = (c.telefone || '').replace(/\D/g, '');
                return telCliente === telNormalizado && c.ativo;
            });
        }
        
        /**
         * BUSCA CLIENTE POR NOME
         */
        function buscarClientePorNome(nome) {
            if (!nome) return null;
            
            const nomeNorm = normalizarNome(nome);
            
            return clientes.find(c => 
                normalizarNome(c.nome) === nomeNorm && c.ativo
            );
        }
        
        /**
         * SALVA OU ATUALIZA CLIENTE
         */
        function salvarCliente(dados) {
            try {
                // Valida√ß√µes
                if (!dados.nome || dados.nome.trim() === '') {
                    throw new Error('Nome do cliente √© obrigat√≥rio');
                }
                
                const agora = new Date().toISOString();
                
                if (dados.id) {
                    // ATUALIZAR EXISTENTE
                    const index = clientes.findIndex(c => c.id === dados.id);
                    if (index === -1) throw new Error('Cliente n√£o encontrado');
                    
                    clientes[index] = {
                        ...clientes[index],
                        nome: dados.nome.trim(),
                        telefone: dados.telefone || '',
                        email: dados.email || '',
                        cpf: dados.cpf || '',
                        endereco: dados.endereco || '',
                        dataNascimento: dados.dataNascimento || null,
                        observacoes: dados.observacoes || '',
                        tags: dados.tags || [],
                        atualizadoEm: agora
                    };
                    
                    mostrarToast('Cliente atualizado com sucesso!', 'success');
                    
                } else {
                    // CRIAR NOVO
                    const novoCliente = {
                        id: gerarId(),
                        nome: dados.nome.trim(),
                        telefone: dados.telefone || '',
                        email: dados.email || '',
                        cpf: dados.cpf || '',
                        endereco: dados.endereco || '',
                        dataNascimento: dados.dataNascimento || null,
                        observacoes: dados.observacoes || '',
                        tags: dados.tags || [],
                        
                        // Estat√≠sticas
                        nivel: 'bronze',
                        totalGasto: 0,
                        totalPedidos: 0,
                        ticketMedio: 0,
                        ultimoPedido: null,
                        
                        // Controle
                        ativo: true,
                        criadoEm: agora,
                        atualizadoEm: agora
                    };
                    
                    clientes.push(novoCliente);
                    mostrarToast('Cliente cadastrado com sucesso!', 'success');
                }
                
                // Salvar
                salvarLocalStorage();
                sincronizarComNuvem();
                
                return true;
                
            } catch (erro) {
                console.error('Erro ao salvar cliente:', erro);
                mostrarToast(erro.message, 'error');
                return false;
            }
        }
        
        /**
         * ATUALIZA ESTAT√çSTICAS DO CLIENTE ap√≥s uma venda
         */
        function atualizarEstatisticasCliente(clienteId, valorVenda) {
            try {
                const cliente = clientes.find(c => c.id === clienteId);
                if (!cliente) return false;
                
                // Atualizar estat√≠sticas
                cliente.totalGasto += valorVenda;
                cliente.totalPedidos += 1;
                cliente.ticketMedio = cliente.totalGasto / cliente.totalPedidos;
                cliente.ultimoPedido = new Date().toISOString();
                
                // Recalcular n√≠vel
                const nivelAnterior = cliente.nivel;
                const nivelNovo = calcularNivelCliente(cliente.totalGasto);
                cliente.nivel = nivelNovo;
                
                // Se subiu de n√≠vel, mostrar notifica√ß√£o
                if (nivelNovo !== nivelAnterior) {
                    const infoNivel = getNivelInfo(nivelNovo);
                    mostrarToast(
                        `üéâ ${cliente.nome} subiu para ${infoNivel.icone} ${infoNivel.nome}!`, 
                        'success', 
                        5000
                    );
                }
                
                // Salvar
                salvarLocalStorage();
                
                return true;
                
            } catch (erro) {
                console.error('Erro ao atualizar estat√≠sticas do cliente:', erro);
                return false;
            }
        }
        
        /**
         * REMOVE CLIENTE (soft delete)
         */
        function removerCliente(clienteId) {
            try {
                const cliente = clientes.find(c => c.id === clienteId);
                if (!cliente) throw new Error('Cliente n√£o encontrado');
                
                // Verificar se tem vendas
                const vendasCliente = vendas.filter(v => 
                    v.cliente && (v.cliente.id === clienteId || v.cliente.telefone === cliente.telefone)
                );
                
                if (vendasCliente.length > 0) {
                    const confirma = confirm(
                        `O cliente "${cliente.nome}" tem ${vendasCliente.length} venda(s) registrada(s).\n\n` +
                        `Deseja realmente remover? O hist√≥rico de vendas ser√° mantido.`
                    );
                    
                    if (!confirma) return false;
                }
                
                // Soft delete
                cliente.ativo = false;
                cliente.removidoEm = new Date().toISOString();
                
                // Salvar
                salvarLocalStorage();
                sincronizarComNuvem();
                
                mostrarToast('Cliente removido com sucesso!', 'success');
                return true;
                
            } catch (erro) {
                console.error('Erro ao remover cliente:', erro);
                mostrarToast(erro.message, 'error');
                return false;
            }
        }
        
        /**
         * Obt√©m o usu√°rio atual (considerando navega√ß√£o ADM)
         */
        function getUsuarioAtual() {
            return visualizandoUsuario || currentUser.email;
        }
        
        /**
         * Navega entre p√°ginas
         */
        function navegarPagina(nomePagina) {
            // Esconde todas as p√°ginas
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
            });
            
            // Mostra p√°gina selecionada
            const pagina = document.getElementById(`${nomePagina}-page`);
            if (pagina) {
                pagina.classList.add('active');
            }
            
            // Atualiza navega√ß√£o
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            const linkAtivo = document.querySelector(`.nav-link[data-page="${nomePagina}"]`);
            if (linkAtivo) {
                linkAtivo.classList.add('active');
            }
            
            // Carrega dados da p√°gina se necess√°rio
            switch(nomePagina) {
                case 'estoque':
                    carregarPaginaEstoque();
                    break;
                case 'materiais':
                    carregarPaginaMateriais();
                    break;
                case 'sub-receitas':
                    carregarPaginaSubReceitas();
                    break;
                case 'produtos':
                    carregarPaginaProdutos();
                    break;  
                case 'vendas':
                    carregarPaginaVendas();
                    break;
                case 'clientes':
                    carregarPaginaClientes();
                    break;
                case 'revendedores':
                    carregarPaginaRevendedores();
                    break;
                case 'calendario':
                    carregarPaginaCalendario();
                    break;
                case 'configuracoes':
                    carregarPaginaConfiguracoes();
                    break;
            }
        }
        
        // ====================================
        // NAVEGA√á√ÉO - EVENT LISTENERS
        // ====================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Links de navega√ß√£o
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const pagina = this.getAttribute('data-page');
                    navegarPagina(pagina);
                });
            });
        });
        
        // ====================================
        // PLACEHOLDERS DE FUN√á√ïES
        // (Ser√£o implementadas nas pr√≥ximas partes)
        // ====================================
        
        function carregarPaginaEstoque() {
            console.log('Carregando p√°gina de estoque...');
        }
        
        function carregarPaginaMateriais() {
            console.log('Carregando p√°gina de materiais...');
        }
                
        function carregarPaginaVendas() {
            console.log('Carregando p√°gina de vendas...');
        }
        
        function carregarPaginaCalendario() {
            console.log('Carregando calend√°rio de entregas...');
        }
        
        // ====================================
        // INICIALIZA√á√ÉO
        // ====================================
        
        console.log('‚úÖ Sistema Deia Cakes v2.0 inicializado');
        console.log('üî• Firebase conectado');
        console.log('üì¶ Aguardando autentica√ß√£o...');
        // ====================================
        // PARTE 2: AUTENTICA√á√ÉO HIER√ÅRQUICA
        // ====================================
        
        /**
         * Verifica se o email √© do administrador
         */
        function isEmailAdmin(email) {
            return email && email.toLowerCase() === EMAIL_ADMIN.toLowerCase();
        }
        
        /**
         * Inicializa o sistema ap√≥s autentica√ß√£o
         */
        async function inicializarSistema(user) {
            try {
                currentUser = user;
                isAdmin = isEmailAdmin(user.email);
                
                console.log('üë§ Usu√°rio autenticado:', user.email);
                console.log('üîë √â administrador:', isAdmin);
                
                // Mostrar informa√ß√µes do usu√°rio
                document.getElementById('user-email').textContent = user.email;
                document.getElementById('user-info').classList.remove('hidden');
                
                // Mostrar bot√µes de admin
                if (isAdmin) {
                    document.getElementById('btn-admin-nav').classList.remove('hidden');
                }
                
                // Mostrar bot√µes de sincroniza√ß√£o para todos
                document.getElementById('btn-upload-firebase').classList.remove('hidden');
                document.getElementById('btn-download-firebase').classList.remove('hidden');
                
                // Esconder modal de login
                document.getElementById('login-modal').classList.add('hidden');
                
                // Carregar dados
                toggleModal(true, "Carregando dados...", "Buscando suas informa√ß√µes...");
                
                await carregarDadosUsuario();
                
                toggleModal(false);
                
                // Navegar para primeira p√°gina
                navegarPagina('estoque');
                
                mostrarToast('Bem-vindo(a) ao sistema!', 'success');
                
            } catch (erro) {
                console.error('Erro ao inicializar sistema:', erro);
                toggleModal(false);
                mostrarToast('Erro ao carregar dados do usu√°rio', 'error');
            }
        }
        
        /**
         * Carrega dados do usu√°rio (localStorage + Firebase)
         */
        async function carregarDadosUsuario() {
            const emailUsuario = getUsuarioAtual();
            
            try {
                // 1. Tentar carregar do localStorage primeiro
                carregarLocalStorage();
                
                // 2. Buscar dados do Firebase
                const snapshot = await database.ref(`usuarios/${emailUsuario.replace(/\./g, '_')}`).once('value');
                const dadosNuvem = snapshot.val();
                
                if (dadosNuvem) {
                    console.log('‚òÅÔ∏è Dados encontrados na nuvem');
                    
                    // Verificar se dados da nuvem s√£o mais recentes
                    const timestampLocal = localStorage.getItem('ultimaAtualizacao');
                    const timestampNuvem = dadosNuvem.ultimaAtualizacao;
                    
                    if (!timestampLocal || new Date(timestampNuvem) > new Date(timestampLocal)) {
                        console.log('üì• Usando dados da nuvem (mais recentes)');
                        materiais = dadosNuvem.materiais || [];
                        subReceitas = dadosNuvem.subReceitas || [];
                        produtosFinais = dadosNuvem.produtosFinais || [];
                        vendas = dadosNuvem.vendas || [];
                        clientes = dadosNuvem.clientes || [];
                        revendedores = dadosNuvem.revendedores || [];
                        
                        // Carregar configura√ß√µes de custos
                        if (dadosNuvem.configuracoesCustos) {
                            configuracoesCustos = dadosNuvem.configuracoesCustos;
                        }
                        
                        salvarLocalStorage();
                    } else {
                        console.log('üíæ Usando dados locais (mais recentes)');
                    }
                } else {
                    console.log('üì≠ Nenhum dado na nuvem, usando localStorage');
                }
                
                // 3. Calcular estoque
                estoque = calcularEstoqueCompleto();
                
                console.log('‚úÖ Dados carregados:', {
                    materiais: materiais.length,
                    subReceitas: subReceitas.length,
                    produtosFinais: produtosFinais.length,
                    vendas: vendas.length
                });
                
            } catch (erro) {
                console.error('Erro ao carregar dados do usu√°rio:', erro);
                throw erro;
            }
        }
        
        /**
         * Sincroniza dados com Firebase
         */
        async function sincronizarComNuvem() {
            const emailUsuario = getUsuarioAtual();
            
            try {
                toggleModal(true, "Sincronizando...", "Salvando dados na nuvem...");
                
                const dados = {
                    materiais: materiais,
                    subReceitas: subReceitas, // üÜï NOVO
                    produtosFinais: produtosFinais, // üÜï NOVO
                    vendas: vendas,
                    clientes: clientes,
                    revendedores: revendedores,
                    configuracoesCustos: configuracoesCustos,
                    ultimaAtualizacao: new Date().toISOString()
                };
                
                await database.ref(`usuarios/${emailUsuario.replace(/\./g, '_')}`).set(dados);
                
                salvarLocalStorage();
                
                toggleModal(false);
                mostrarToast('Dados sincronizados com sucesso!', 'success');
                
                return true;
            } catch (erro) {
                console.error('Erro ao sincronizar:', erro);
                toggleModal(false);
                mostrarToast('Erro ao sincronizar dados', 'error');
                return false;
            }
        }
        
        /**
         * For√ßa upload dos dados locais para o Firebase
         */
        async function forcarUploadFirebase() {
            const confirma = confirm(
                '‚¨ÜÔ∏è ENVIAR DADOS PARA NUVEM\n\n' +
                'Isso vai SOBRESCREVER os dados no Firebase\n' +
                'com os dados que est√£o no seu navegador.\n\n' +
                'Deseja continuar?'
            );
            
            if (!confirma) return;
            
            try {
                toggleModal(true, "Enviando para nuvem...", "Fazendo upload dos dados...");
                
                const emailUsuario = getUsuarioAtual();
                const dados = {
                    materiais: materiais,
                    subReceitas: subReceitas, // üÜï NOVO
                    produtosFinais: produtosFinais, // üÜï NOVO
                    vendas: vendas,
                    clientes: clientes,
                    revendedores: revendedores,
                    configuracoesCustos: configuracoesCustos,
                    ultimaAtualizacao: new Date().toISOString()
                };
                
                await database.ref(`usuarios/${emailUsuario.replace(/\./g, '_')}`).set(dados);
                
                // Atualizar localStorage tamb√©m
                salvarLocalStorage();
                
                toggleModal(false);
                mostrarToast('‚úÖ Dados enviados para nuvem com sucesso!', 'success');
                
            } catch (erro) {
                console.error('Erro ao enviar para nuvem:', erro);
                toggleModal(false);
                mostrarToast('‚ùå Erro ao enviar dados: ' + erro.message, 'error');
            }
        }

        /**
         * For√ßa download dos dados do Firebase para local
         */
        async function forcarDownloadFirebase() {
            const confirma = confirm(
                '‚¨áÔ∏è BUSCAR DADOS DA NUVEM\n\n' +
                'Isso vai SOBRESCREVER os dados no seu navegador\n' +
                'com os dados que est√£o no Firebase.\n\n' +
                'ATEN√á√ÉO: Voc√™ vai perder as altera√ß√µes\n' +
                'n√£o sincronizadas que est√£o no navegador!\n\n' +
                'Deseja continuar?'
            );
            
            if (!confirma) return;
            
            try {
                toggleModal(true, "Buscando da nuvem...", "Fazendo download dos dados...");
                
                const emailUsuario = getUsuarioAtual();
                const snapshot = await database.ref(`usuarios/${emailUsuario.replace(/\./g, '_')}`).once('value');
                const dadosNuvem = snapshot.val();
                
                if (!dadosNuvem) {
                    toggleModal(false);
                    mostrarToast('‚ö†Ô∏è Nenhum dado encontrado na nuvem', 'warning');
                    return;
                }
                
                // Substituir dados locais pelos da nuvem
                materiais = dadosNuvem.materiais || [];
                subReceitas = dadosNuvem.subReceitas || [];
                produtosFinais = dadosNuvem.produtosFinais || [];
                vendas = dadosNuvem.vendas || [];
                clientes = dadosNuvem.clientes || [];
                revendedores = dadosNuvem.revendedores || [];
                
                // Carregar configura√ß√µes de custos
                if (dadosNuvem.configuracoesCustos) {
                    configuracoesCustos = dadosNuvem.configuracoesCustos;
                } else {
                    // Se n√£o houver configura√ß√µes, usar padr√µes
                    configuracoesCustos = {
                        fixos: {
                            salarioDesejado: 0,
                            luz: 0,
                            agua: 0,
                            internet: 0,
                            gas: 0,
                            aluguel: 0,
                            outros: 0,
                            total: 0
                        },
                        metaProducao: 50,
                        margemLucroDesejada: 30,
                        custoFixoPorUnidade: 0,
                        markupPercentual: 0,
                        multiplicadorMarkup: 1
                    };
                }
                
                // Recalcular estoque
                estoque = calcularEstoqueCompleto();
                
                // Salvar no localStorage
                salvarLocalStorage();
                
                // Recarregar p√°gina atual
                const paginaAtual = document.querySelector('.page-content.active').id.replace('-page', '');
                navegarPagina(paginaAtual);
                
                toggleModal(false);
                mostrarToast('‚úÖ Dados baixados da nuvem com sucesso!', 'success');
                
            } catch (erro) {
                console.error('Erro ao baixar da nuvem:', erro);
                toggleModal(false);
                mostrarToast('‚ùå Erro ao baixar dados: ' + erro.message, 'error');
            }
        }
        
        /**
         * Placeholder para c√°lculo de estoque (ser√° implementado na Parte 3)
         */
        function calcularEstoqueCompleto() {
            // TODO: Implementar na Parte 3
            return [];
        }
        
        /**
         * Faz login do usu√°rio
         */
        async function fazerLogin() {
            const email = document.getElementById('login-email').value.trim();
            const senha = document.getElementById('login-senha').value;
            
            if (!email || !senha) {
                mostrarNotificacao('login-notification', 'Preencha todos os campos', 'error');
                return;
            }
            
            try {
                toggleModal(true, "Entrando...", "Autenticando credenciais...");
                
                const userCredential = await auth.signInWithEmailAndPassword(email, senha);
                
                toggleModal(false);
                
                // Sistema ser√° inicializado pelo onAuthStateChanged
                
            } catch (erro) {
                toggleModal(false);
                console.error('Erro ao fazer login:', erro);
                
                let mensagem = 'Erro ao fazer login';
                
                switch(erro.code) {
                    case 'auth/user-not-found':
                        mensagem = 'Usu√°rio n√£o encontrado';
                        break;
                    case 'auth/wrong-password':
                        mensagem = 'Senha incorreta';
                        break;
                    case 'auth/invalid-email':
                        mensagem = 'Email inv√°lido';
                        break;
                    case 'auth/too-many-requests':
                        mensagem = 'Muitas tentativas. Tente novamente mais tarde';
                        break;
                    default:
                        mensagem = erro.message;
                }
                
                mostrarNotificacao('login-notification', mensagem, 'error');
            }
        }
        
        /**
         * Cadastra novo usu√°rio
         */
        async function fazerCadastro() {
            const email = document.getElementById('login-email').value.trim();
            const senha = document.getElementById('login-senha').value;
            
            if (!email || !senha) {
                mostrarNotificacao('login-notification', 'Preencha todos os campos', 'error');
                return;
            }
            
            if (senha.length < 6) {
                mostrarNotificacao('login-notification', 'A senha deve ter pelo menos 6 caracteres', 'error');
                return;
            }
            
            // Verificar se √© o primeiro usu√°rio (ADM)
            const isFirstUser = !currentUser;
            
            // Se n√£o for o primeiro usu√°rio, precisa ser ADM para criar
            if (!isFirstUser && !isAdmin) {
                mostrarNotificacao('login-notification', 'Apenas administradores podem criar usu√°rios', 'error');
                return;
            }
            
            try {
                toggleModal(true, "Criando conta...", "Registrando novo usu√°rio...");
                
                const userCredential = await auth.createUserWithEmailAndPassword(email, senha);
                
                // Registrar informa√ß√µes do usu√°rio
                await database.ref(`usuarios/${email.replace(/\./g, '_')}/info`).set({
                    email: email,
                    criadoEm: new Date().toISOString(),
                    criadoPor: isFirstUser ? 'sistema' : currentUser.email,
                    role: isEmailAdmin(email) ? 'admin' : 'user'
                });
                
                toggleModal(false);
                
                mostrarNotificacao('login-notification', 'Conta criada com sucesso!', 'success', 3000);
                
                // Se n√£o for o primeiro usu√°rio (ADM criando outro), fazer logout autom√°tico
                // para o novo usu√°rio fazer login
                if (!isFirstUser) {
                    setTimeout(() => {
                        mostrarToast('Usu√°rio criado! Ele j√° pode fazer login.', 'success');
                    }, 500);
                }
                
            } catch (erro) {
                toggleModal(false);
                console.error('Erro ao criar conta:', erro);
                
                let mensagem = 'Erro ao criar conta';
                
                switch(erro.code) {
                    case 'auth/email-already-in-use':
                        mensagem = 'Este email j√° est√° em uso';
                        break;
                    case 'auth/invalid-email':
                        mensagem = 'Email inv√°lido';
                        break;
                    case 'auth/weak-password':
                        mensagem = 'Senha muito fraca';
                        break;
                    default:
                        mensagem = erro.message;
                }
                
                mostrarNotificacao('login-notification', mensagem, 'error');
            }
        }
        
        /**
         * Faz logout do usu√°rio
         */
        async function fazerLogout() {
            const confirma = confirm('Deseja realmente sair do sistema?');
            if (!confirma) return;
            
            try {
                // Sincronizar antes de sair
                await sincronizarComNuvem();
                
                await auth.signOut();
                
                // Limpar dados
                currentUser = null;
                isAdmin = false;
                visualizandoUsuario = null;
                materiais = [];
                receitas = [];
                vendas = [];
                estoque = [];
                
                // Esconder info do usu√°rio
                document.getElementById('user-info').classList.add('hidden');
                
                // Mostrar modal de login
                document.getElementById('login-modal').classList.remove('hidden');
                
                mostrarToast('Logout realizado com sucesso!', 'success');
                
            } catch (erro) {
                console.error('Erro ao fazer logout:', erro);
                mostrarToast('Erro ao fazer logout', 'error');
            }
        }
        
        /**
         * Abre modal para navega√ß√£o entre usu√°rios (ADM apenas)
         */
        async function abrirNavegacaoUsuarios() {
            if (!isAdmin) {
                mostrarToast('Apenas administradores podem acessar esta fun√ß√£o', 'error');
                return;
            }
            
            try {
                toggleModal(true, "Buscando usu√°rios...", "Carregando lista de usu√°rios...");
                
                // Buscar todos os usu√°rios
                const snapshot = await database.ref('usuarios').once('value');
                const usuarios = snapshot.val();
                
                // Se n√£o tiver usu√°rios, retornar
                if (!usuarios) {
                    toggleModal(false);
                    mostrarToast('Nenhum usu√°rio encontrado', 'info');
                    return;
                }
                
                // Filtrar apenas os usu√°rios que t√™m dados (n√£o apenas /info)
                const usuariosComDados = Object.keys(usuarios).filter(key => {
                    const usuario = usuarios[key];
                    return usuario && (usuario.materiais || usuario.receitas || usuario.vendas);
                });
                
                // Criar modal de sele√ß√£o
                const usuariosArray = usuariosComDados
                    .map(key => key.replace(/_/g, '.'))
                    .filter(email => email !== EMAIL_ADMIN); // Excluir o pr√≥prio ADM
                
                if (usuariosArray.length === 0) {
                    mostrarToast('Nenhum outro usu√°rio cadastrado', 'info');
                    return;
                }
                
                mostrarModalSelecaoUsuario(usuariosArray);
                
            } catch (erro) {
                console.error('Erro ao buscar usu√°rios:', erro);
                toggleModal(false);
                mostrarToast('Erro ao buscar usu√°rios', 'error');
            }
        }
        
        /**
         * Mostra modal de sele√ß√£o de usu√°rio
         */
        function mostrarModalSelecaoUsuario(usuarios) {
            // Criar modal dinamicamente
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>üë• Navegar como Usu√°rio</h3>
                        <button class="modal-close" onclick="this.parentElement.parentElement.parentElement.remove()">√ó</button>
                    </div>
                    <p style="margin-bottom: 15px;">Selecione um usu√°rio para visualizar seus dados:</p>
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${usuarios.map(email => `
                            <button class="btn btn-secondary" style="width: 100%; margin-bottom: 10px; justify-content: flex-start;"
                                onclick="navegarParaUsuario('${email}')">
                                üìß ${email}
                            </button>
                        `).join('')}
                    </div>
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--cor-borda);">
                        ${visualizandoUsuario ? `
                            <button class="btn btn-primary" style="width: 100%;" onclick="voltarParaAdmin()">
                                ‚Ü©Ô∏è Voltar para Conta Admin
                            </button>
                        ` : ''}
                        <button class="btn btn-secondary" style="width: 100%; margin-top: 10px;" 
                            onclick="this.parentElement.parentElement.parentElement.remove()">
                            ‚ùå Fechar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        /**
         * Navega para visualizar dados de outro usu√°rio (ADM apenas)
         */
        async function navegarParaUsuario(email) {
            if (!isAdmin) {
                mostrarToast('Apenas administradores podem acessar esta fun√ß√£o', 'error');
                return;
            }
            
            try {
                // Fechar modal
                const modal = document.querySelector('.modal-overlay:last-child');
                if (modal) modal.remove();
                
                toggleModal(true, "Carregando dados...", `Buscando dados de ${email}...`);
                
                // Salvar dados atuais se necess√°rio
                if (visualizandoUsuario) {
                    await sincronizarComNuvem();
                }
                
                // Definir usu√°rio sendo visualizado
                visualizandoUsuario = email;
                
                // Carregar dados do usu√°rio
                await carregarDadosUsuario();
                
                // Atualizar interface
                document.getElementById('user-email').innerHTML = `
                    üëÅÔ∏è Visualizando: <strong>${email}</strong>
                    <span class="badge badge-warning" style="margin-left: 10px;">Modo Admin</span>
                `;
                
                // Recarregar p√°gina atual
                const paginaAtual = document.querySelector('.page-content.active').id.replace('-page', '');
                navegarPagina(paginaAtual);
                
                toggleModal(false);
                mostrarToast(`Agora visualizando dados de: ${email}`, 'info');
                
            } catch (erro) {
                console.error('Erro ao navegar para usu√°rio:', erro);
                toggleModal(false);
                mostrarToast('Erro ao carregar dados do usu√°rio', 'error');
            }
        }
        
        /**
         * Volta para conta admin
         */
        async function voltarParaAdmin() {
            if (!isAdmin) return;
            
            try {
                // Fechar modal
                const modal = document.querySelector('.modal-overlay:last-child');
                if (modal) modal.remove();
                
                toggleModal(true, "Voltando...", "Retornando para conta admin...");
                
                // Salvar dados do usu√°rio atual
                await sincronizarComNuvem();
                
                // Limpar visualiza√ß√£o
                visualizandoUsuario = null;
                
                // Carregar dados do admin
                await carregarDadosUsuario();
                
                // Restaurar interface
                document.getElementById('user-email').textContent = currentUser.email;
                
                // Recarregar p√°gina atual
                const paginaAtual = document.querySelector('.page-content.active').id.replace('-page', '');
                navegarPagina(paginaAtual);
                
                toggleModal(false);
                mostrarToast('Voltou para conta admin', 'success');
                
            } catch (erro) {
                console.error('Erro ao voltar para admin:', erro);
                toggleModal(false);
                mostrarToast('Erro ao retornar para conta admin', 'error');
            }
        }
        
        // ====================================
        // EVENT LISTENERS - AUTENTICA√á√ÉO
        // ====================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Bot√£o de login
            const btnLogin = document.getElementById('btn-login');
            if (btnLogin) {
                btnLogin.addEventListener('click', fazerLogin);
            }
            
            // Bot√£o de cadastro
            const btnCadastrar = document.getElementById('btn-cadastrar');
            if (btnCadastrar) {
                btnCadastrar.addEventListener('click', fazerCadastro);
            }
            
            // Bot√£o de logout
            const btnLogout = document.getElementById('btn-logout');
            if (btnLogout) {
                btnLogout.addEventListener('click', fazerLogout);
            }
            
            // Bot√£o de navega√ß√£o admin
            const btnAdminNav = document.getElementById('btn-admin-nav');
            if (btnAdminNav) {
                btnAdminNav.addEventListener('click', abrirNavegacaoUsuarios);
            }

            // Bot√£o de upload for√ßado
            const btnUpload = document.getElementById('btn-upload-firebase');
            if (btnUpload) {
                btnUpload.addEventListener('click', forcarUploadFirebase);
            }
            
            // Bot√£o de download for√ßado
            const btnDownload = document.getElementById('btn-download-firebase');
            if (btnDownload) {
                btnDownload.addEventListener('click', forcarDownloadFirebase);
            }
            
            // Enter no campo de senha
            const senhaInput = document.getElementById('login-senha');
            if (senhaInput) {
                senhaInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        fazerLogin();
                    }
                });
            }
        });
        
        // ====================================
        // MONITORAMENTO DE AUTENTICA√á√ÉO
        // ====================================
        
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // Usu√°rio est√° logado
                await inicializarSistema(user);
            } else {
                // Usu√°rio n√£o est√° logado
                console.log('üîí Nenhum usu√°rio autenticado');
                
                // Esconder info do usu√°rio
                document.getElementById('user-info').classList.add('hidden');

                // Esconder bot√µes de sincroniza√ß√£o
                document.getElementById('btn-upload-firebase').classList.add('hidden');
                document.getElementById('btn-download-firebase').classList.add('hidden');
                document.getElementById('btn-admin-nav').classList.add('hidden');
                
                // Mostrar modal de login
                document.getElementById('login-modal').classList.remove('hidden');
            }
        });
        
        // ====================================
        // SINCRONIZA√á√ÉO AUTOM√ÅTICA
        // ====================================
        
        // Sincronizar a cada 5 minutos
        setInterval(() => {
            if (currentUser) {
                console.log('üîÑ Sincroniza√ß√£o autom√°tica...');
                sincronizarComNuvem();
            }
        }, 5 * 60 * 1000);
        
        // Sincronizar antes de fechar a p√°gina
        window.addEventListener('beforeunload', () => {
            if (currentUser) {
                sincronizarComNuvem();
            }
        });
        
        console.log('‚úÖ Sistema de autentica√ß√£o inicializado');
        // ====================================
        // PARTE 3: GEST√ÉO DE MATERIAIS + ESTOQUE
        // ====================================
        
        /**
         * C√ÅLCULO DE PRE√áO M√âDIO PONDERADO (CORRIGIDO)
         * Retorna o pre√ßo m√©dio POR UNIDADE de medida (por ml, por g, etc)
         */
        function calcularPrecoMedioPonderado(nomeMaterial) {
            const materiaisGrupo = materiais.filter(m => 
                normalizarNome(m.nome) === normalizarNome(nomeMaterial) &&
                !m.removed
            );
            
            if (materiaisGrupo.length === 0) return 0;
            
            let somaPrecosPonderados = 0;
            let somaQuantidadeTotal = 0;
            
            materiaisGrupo.forEach(material => {
                if (material.historicoCompras && material.historicoCompras.length > 0) {
                    material.historicoCompras.forEach(compra => {
                        if (!compra.removed) {
                            const valorTotal = parseFloat(compra.preco) || 0;
                            const quantidade = parseFloat(compra.quantidade) || 0;
                            
                            if (quantidade > 0) {
                                // Pre√ßo unit√°rio desta compra (por ml, por g, etc)
                                const precoUnitario = valorTotal / quantidade;
                                
                                // Ponderar pelo peso (quantidade)
                                somaPrecosPonderados += precoUnitario * quantidade;
                                somaQuantidadeTotal += quantidade;
                            }
                        }
                    });
                }
            });
            
            if (somaQuantidadeTotal === 0) return 0;
            
            // Retorna o pre√ßo m√©dio POR UNIDADE (ml, g, etc)
            return somaPrecosPonderados / somaQuantidadeTotal;
        }
        
        /**
         * CALCULA CUSTO DE UMA SUB-RECEITA
         * Retorna custo total e custo por kg/unidade
         */
        function calcularCustoSubReceita(subReceita) {
            if (!subReceita || !subReceita.ingredientes || subReceita.ingredientes.length === 0) {
                return {
                    custoIngredientes: 0,
                    custoTotal: 0,
                    custoPorKg: 0,
                    custoPorUnidade: 0
                };
            }
            
            let custoIngredientes = 0;
            
            // Calcular custo de cada ingrediente
            subReceita.ingredientes.forEach(ingrediente => {
                const material = materiais.find(m => m.id === ingrediente.materialId);
                if (!material) return;
                
                const precoMedio = calcularPrecoMedioPonderado(material.nome);
                const quantidade = parseFloat(ingrediente.quantidade) || 0;
                
                custoIngredientes += precoMedio * quantidade;
            });
            
            const custoTotal = custoIngredientes;
            const rendimento = parseFloat(subReceita.rendimento) || 1;
            const custoPorKg = custoTotal / rendimento;
            
            return {
                custoIngredientes: custoIngredientes,
                custoTotal: custoTotal,
                custoPorKg: custoPorKg,
                custoPorUnidade: custoPorKg
            };
        }

        /**
         * SALVA SUB-RECEITA (nova ou edi√ß√£o)
         */
        function salvarSubReceita(dados) {
            try {
                // Valida√ß√µes
                if (!dados.nome || dados.nome.trim() === '') {
                    throw new Error('Nome da sub-receita √© obrigat√≥rio');
                }
                
                if (!dados.tipo) {
                    throw new Error('Tipo da sub-receita √© obrigat√≥rio');
                }
                
                if (!dados.ingredientes || dados.ingredientes.length === 0) {
                    throw new Error('Adicione pelo menos um ingrediente');
                }
                
                const rendimento = parseFloat(dados.rendimento);
                if (isNaN(rendimento) || rendimento <= 0) {
                    throw new Error('Rendimento deve ser maior que zero');
                }
                
                // Calcular custos
                const custos = calcularCustoSubReceita(dados);
                
                if (dados.id) {
                    // EDITAR EXISTENTE
                    const index = subReceitas.findIndex(s => s.id === dados.id);
                    if (index === -1) throw new Error('Sub-receita n√£o encontrada');
                    
                    subReceitas[index] = {
                        ...subReceitas[index],
                        nome: dados.nome.trim(),
                        tipo: dados.tipo,
                        rendimento: rendimento,
                        unidadeRendimento: dados.unidadeRendimento || 'kg',
                        observacoes: dados.observacoes || '',
                        ingredientes: dados.ingredientes,
                        custoIngredientes: custos.custoIngredientes,
                        custoTotal: custos.custoTotal,
                        custoPorKg: custos.custoPorKg,
                        atualizadaEm: new Date().toISOString()
                    };
                    
                    mostrarToast('Sub-receita atualizada com sucesso!', 'success');
                    
                } else {
                    // CRIAR NOVA
                    const novaSubReceita = {
                        id: gerarId(),
                        nome: dados.nome.trim(),
                        tipo: dados.tipo,
                        rendimento: rendimento,
                        unidadeRendimento: dados.unidadeRendimento || 'kg',
                        observacoes: dados.observacoes || '',
                        ingredientes: dados.ingredientes,
                        custoIngredientes: custos.custoIngredientes,
                        custoTotal: custos.custoTotal,
                        custoPorKg: custos.custoPorKg,
                        ativa: true,
                        criadaEm: new Date().toISOString(),
                        atualizadaEm: new Date().toISOString()
                    };
                    
                    subReceitas.push(novaSubReceita);
                    mostrarToast('Sub-receita criada com sucesso!', 'success');
                }
                
                // Salvar
                salvarLocalStorage();
                sincronizarComNuvem();
                
                return true;
                
            } catch (erro) {
                console.error('Erro ao salvar sub-receita:', erro);
                mostrarToast(erro.message, 'error');
                return false;
            }
        }

        /**
         * REMOVE SUB-RECEITA
         */
        function removerSubReceita(subReceitaId) {
            try {
                const subReceita = subReceitas.find(s => s.id === subReceitaId);
                if (!subReceita) {
                    throw new Error('Sub-receita n√£o encontrada');
                }
                
                // Verificar se est√° sendo usada em algum produto
                const produtosUsando = produtosFinais.filter(p => 
                    p.ativa && p.componentes && p.componentes.some(c => 
                        c.tipo === 'subReceita' && c.subReceitaId === subReceitaId
                    )
                );
                
                if (produtosUsando.length > 0) {
                    const nomesProdutos = produtosUsando.map(p => p.nome).join(', ');
                    throw new Error(`Esta sub-receita est√° sendo usada nos produtos: ${nomesProdutos}`);
                }
                
                // Confirmar
                if (!confirm(`Tem certeza que deseja remover a sub-receita "${subReceita.nome}"?`)) {
                    return false;
                }
                
                // Marcar como inativa
                const index = subReceitas.findIndex(s => s.id === subReceitaId);
                if (index !== -1) {
                    subReceitas[index].ativa = false;
                    subReceitas[index].removidaEm = new Date().toISOString();
                }
                
                // Salvar
                salvarLocalStorage();
                sincronizarComNuvem();
                
                mostrarToast('Sub-receita removida com sucesso!', 'success');
                return true;
                
            } catch (erro) {
                console.error('Erro ao remover sub-receita:', erro);
                mostrarToast(erro.message, 'error');
                return false;
            }
        }

        /**
         * CARREGA P√ÅGINA DE SUB-RECEITAS
         */
        function carregarPaginaSubReceitas() {
            const page = document.getElementById('sub-receitas-page');
            if (!page) return;
            
            page.innerHTML = `
                <h2>üß© Gest√£o de Sub-Receitas</h2>
                
                <div class="tab-buttons">
                    <button class="tab-button active" data-tab="listar-sub">üìã Listar Sub-Receitas</button>
                    <button class="tab-button" data-tab="adicionar-sub">‚ûï Nova Sub-Receita</button>
                </div>
                
                <!-- TAB: Listar Sub-Receitas -->
                <div class="tab-content active" id="tab-listar-sub">
                    <div class="card">
                        <h3>Sub-Receitas Cadastradas</h3>
                        
                        <!-- Filtros -->
                        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                            <input type="text" id="pesquisar-sub-receitas" class="form-control" 
                                placeholder="üîç Pesquisar sub-receita..." style="flex: 1; min-width: 200px;">
                            
                            <select id="filtro-tipo-sub" class="form-control" style="width: 200px;">
                                <option value="">Todos os tipos</option>
                                <option value="massa">üç∞ Massas</option>
                                <option value="recheio">üç´ Recheios</option>
                                <option value="cobertura">üé® Coberturas</option>
                                <option value="base">üßÅ Bases</option>
                                <option value="outro">üì¶ Outros</option>
                            </select>
                        </div>
                        
                        <div id="lista-sub-receitas-cards">
                            ${renderizarSubReceitasCards()}
                        </div>
                    </div>
                </div>
                
                <!-- TAB: Adicionar Sub-Receita -->
                <div class="tab-content" id="tab-adicionar-sub">
                    <div class="card">
                        <h3 id="titulo-form-sub-receita">‚ûï Nova Sub-Receita</h3>
                        
                        <form id="form-sub-receita">
                            <input type="hidden" id="sub-receita-id" value="">
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="sub-receita-nome">Nome da Sub-Receita: *</label>
                                        <input type="text" id="sub-receita-nome" class="form-control" 
                                            placeholder="Ex: Massa de Chocolate" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="sub-receita-tipo">Tipo: *</label>
                                        <select id="sub-receita-tipo" class="form-control" required>
                                            <option value="">Selecione...</option>
                                            <option value="massa">üç∞ Massa</option>
                                            <option value="recheio">üç´ Recheio</option>
                                            <option value="cobertura">üé® Cobertura</option>
                                            <option value="base">üßÅ Base</option>
                                            <option value="outro">üì¶ Outro</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="sub-receita-rendimento">Rendimento: *</label>
                                        <input type="number" id="sub-receita-rendimento" class="form-control" 
                                            min="0.01" step="0.01" value="1" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="sub-receita-unidade-rendimento">Unidade:</label>
                                        <select id="sub-receita-unidade-rendimento" class="form-control">
                                            <option value="kg">kg</option>
                                            <option value="g">g</option>
                                            <option value="l">L</option>
                                            <option value="ml">ml</option>
                                            <option value="un">Unidade</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="sub-receita-observacoes">Observa√ß√µes:</label>
                                <textarea id="sub-receita-observacoes" class="form-control" rows="2" 
                                    placeholder="Ex: Tempo de forno 40min, temperatura 180¬∞C"></textarea>
                            </div>
                            
                            <h4 style="margin-top: 30px; margin-bottom: 15px; color: var(--cor-primaria);">
                                ü•Ñ Ingredientes
                            </h4>
                            
                            <div style="background: var(--cor-fundo); padding: 15px; border-radius: var(--borda-radius); margin-bottom: 15px;">
                                <div class="form-row">
                                    <div class="form-col" style="flex: 2;">
                                        <label for="sub-ingrediente-material">Material:</label>
                                        <select id="sub-ingrediente-material" class="form-control">
                                            <option value="">Selecione um material...</option>
                                            ${materiais
                                                .filter(m => !m.removed)
                                                .sort((a, b) => a.nome.localeCompare(b.nome))
                                                .map(m => {
                                                    const precoMedio = calcularPrecoMedioPonderado(m.nome);
                                                    const unidade = m.unidadeMedida || 'un';
                                                    return `<option value="${m.id}">${m.nome} (${formatarMoeda(precoMedio)}/${unidade})</option>`;
                                                }).join('')
                                            }
                                        </select>
                                    </div>
                                    <div class="form-col">
                                        <label for="sub-ingrediente-quantidade">Quantidade:</label>
                                        <input type="number" id="sub-ingrediente-quantidade" class="form-control" 
                                            min="0.01" step="0.01" placeholder="0">
                                    </div>
                                    <div class="form-col">
                                        <label for="sub-ingrediente-unidade">Unidade:</label>
                                        <input type="text" id="sub-ingrediente-unidade" class="form-control" 
                                            placeholder="g, ml, un" readonly>
                                    </div>
                                    <div class="form-col" style="flex: 0.5;">
                                        <label>&nbsp;</label>
                                        <button type="button" id="btn-add-sub-ingrediente" class="btn btn-success" 
                                            style="width: 100%;">‚ûï</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="lista-sub-ingredientes">
                                <!-- Ingredientes adicionados aparecer√£o aqui -->
                            </div>
                            
                            <h4 style="margin-top: 30px; margin-bottom: 15px; color: var(--cor-primaria);">
                                üí∞ Resumo de Custos
                            </h4>
                            
                            <div id="resumo-custos-sub-receita" style="background: var(--cor-info-claro); 
                                padding: 15px; border-radius: var(--borda-radius);">
                                <table style="width: 100%;">
                                    <tr>
                                        <td><strong>Custo Total:</strong></td>
                                        <td id="sub-resumo-custo-total" style="text-align: right; font-weight: bold;">R$ 0,00</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Custo por ${document.getElementById('sub-receita-unidade-rendimento')?.value || 'kg'}:</strong></td>
                                        <td id="sub-resumo-custo-unidade" style="text-align: right; font-weight: bold; color: var(--cor-primaria);">R$ 0,00</td>
                                    </tr>
                                </table>
                            </div>
                            
                            <div style="margin-top: 25px; display: flex; gap: 10px;">
                                <button type="submit" class="btn btn-primary">üíæ Salvar Sub-Receita</button>
                                <button type="button" class="btn btn-secondary" onclick="cancelarEdicaoSubReceita()">
                                    ‚ùå Cancelar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Configurar tabs
            configurarTabsSubReceitas();
            
            // Configurar formul√°rio
            configurarFormularioSubReceita();
            
            // Configurar pesquisa e filtros
            configurarPesquisaSubReceitas();
        }

        /**
         * RENDERIZA CARDS DE SUB-RECEITAS
         */
        function renderizarSubReceitasCards() {
            const subReceitasAtivas = subReceitas.filter(s => s.ativa);
            
            if (subReceitasAtivas.length === 0) {
                return '<p style="text-align: center; color: var(--cor-texto-claro);">Nenhuma sub-receita cadastrada.</p>';
            }
            
            // Agrupar por tipo
            const grupos = {
                massa: { nome: 'üç∞ Massas', itens: [] },
                recheio: { nome: 'üç´ Recheios', itens: [] },
                cobertura: { nome: 'üé® Coberturas', itens: [] },
                base: { nome: 'üßÅ Bases', itens: [] },
                outro: { nome: 'üì¶ Outros', itens: [] }
            };
            
            subReceitasAtivas.forEach(sub => {
                const tipo = sub.tipo || 'outro';
                if (grupos[tipo]) {
                    grupos[tipo].itens.push(sub);
                }
            });
            
            let html = '';
            
            Object.keys(grupos).forEach(tipo => {
                const grupo = grupos[tipo];
                if (grupo.itens.length === 0) return;
                
                html += `
                    <h4 style="margin-top: 20px; margin-bottom: 15px; color: var(--cor-primaria);">
                        ${grupo.nome} (${grupo.itens.length})
                    </h4>
                `;
                
                grupo.itens.forEach(sub => {
                    const custos = calcularCustoSubReceita(sub);
                    
                    html += `
                        <div class="card" style="margin-bottom: 15px; border-left: 4px solid var(--cor-primaria);">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <h4 style="margin: 0 0 5px 0;">${sub.nome}</h4>
                                    ${sub.observacoes ? `
                                        <p style="margin: 5px 0; color: var(--cor-texto-claro); font-size: 14px;">
                                            ${sub.observacoes}
                                        </p>
                                    ` : ''}
                                    <div style="margin-top: 10px;">
                                        <span class="badge badge-info">Rendimento: ${sub.rendimento} ${sub.unidadeRendimento}</span>
                                        <span class="badge badge-success">${sub.ingredientes.length} ingredientes</span>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 20px; font-weight: bold; color: var(--cor-primaria);">
                                        ${formatarMoeda(custos.custoPorKg)}/${sub.unidadeRendimento}
                                    </div>
                                    <div style="font-size: 14px; color: var(--cor-texto-claro);">
                                        Total: ${formatarMoeda(custos.custoTotal)}
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 15px; display: flex; gap: 5px; flex-wrap: wrap;">
                                <button class="btn btn-primary btn-sm" onclick="verDetalhesSubReceita('${sub.id}')">
                                    üëÅÔ∏è Ver Detalhes
                                </button>
                                <button class="btn btn-success btn-sm" onclick="editarSubReceita('${sub.id}')">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="if(removerSubReceita('${sub.id}')) carregarPaginaSubReceitas();">
                                    üóëÔ∏è Remover
                                </button>
                            </div>
                        </div>
                    `;
                });
            });
            
            return html;
        }

        /**
         * CONFIGURA TABS DE SUB-RECEITAS
         */
        function configurarTabsSubReceitas() {
            const tabButtons = document.querySelectorAll('#sub-receitas-page .tab-button');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    tabButtons.forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('#sub-receitas-page .tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    const tabContent = document.getElementById('tab-' + tabId);
                    if (tabContent) {
                        tabContent.classList.add('active');
                    }
                });
            });
        }
        
        /**
         * CONFIGURA FORMUL√ÅRIO DE SUB-RECEITA
         */
        function configurarFormularioSubReceita() {
            let ingredientesTemp = [];
            
            // Atualizar unidade quando selecionar material
            const selectMaterial = document.getElementById('sub-ingrediente-material');
            if (selectMaterial) {
                selectMaterial.addEventListener('change', function() {
                    const materialId = this.value;
                    const material = materiais.find(m => m.id === materialId);
                    const inputUnidade = document.getElementById('sub-ingrediente-unidade');
                    
                    if (material && inputUnidade) {
                        inputUnidade.value = material.unidadeMedida || 'un';
                    }
                });
            }
            
            // Bot√£o adicionar ingrediente
            const btnAdd = document.getElementById('btn-add-sub-ingrediente');
            if (btnAdd) {
                btnAdd.addEventListener('click', function() {
                    const materialId = document.getElementById('sub-ingrediente-material').value;
                    const quantidade = parseFloat(document.getElementById('sub-ingrediente-quantidade').value);
                    
                    if (!materialId) {
                        mostrarToast('Selecione um material', 'warning');
                        return;
                    }
                    
                    if (!quantidade || quantidade <= 0) {
                        mostrarToast('Informe a quantidade', 'warning');
                        return;
                    }
                    
                    const material = materiais.find(m => m.id === materialId);
                    if (!material) return;
                    
                    // Verificar se j√° foi adicionado
                    if (ingredientesTemp.some(i => i.materialId === materialId)) {
                        mostrarToast('Material j√° adicionado', 'warning');
                        return;
                    }
                    
                    ingredientesTemp.push({
                        materialId: materialId,
                        materialNome: material.nome,
                        quantidade: quantidade,
                        unidadeMedida: material.unidadeMedida || 'un'
                    });
                    
                    renderizarListaSubIngredientes();
                    atualizarResumoSubReceita();
                    
                    // Limpar campos
                    document.getElementById('sub-ingrediente-material').value = '';
                    document.getElementById('sub-ingrediente-quantidade').value = '';
                    document.getElementById('sub-ingrediente-unidade').value = '';
                });
            }
            
            // Fun√ß√£o para renderizar lista de ingredientes
            window.renderizarListaSubIngredientes = function() {
                const lista = document.getElementById('lista-sub-ingredientes');
                if (!lista) return;
                
                if (ingredientesTemp.length === 0) {
                    lista.innerHTML = '<p style="text-align: center; color: var(--cor-texto-claro);">Nenhum ingrediente adicionado.</p>';
                    return;
                }
                
                let html = '<table style="width: 100%;"><thead><tr><th>Material</th><th>Quantidade</th><th>Custo</th><th>A√ß√µes</th></tr></thead><tbody>';
                
                ingredientesTemp.forEach((ing, index) => {
                    const precoMedio = calcularPrecoMedioPonderado(ing.materialNome);
                    const custo = precoMedio * ing.quantidade;
                    
                    html += `
                        <tr>
                            <td>${ing.materialNome}</td>
                            <td>${ing.quantidade} ${ing.unidadeMedida}</td>
                            <td>${formatarMoeda(custo)}</td>
                            <td>
                                <button type="button" class="btn btn-danger btn-sm" onclick="removerSubIngrediente(${index})">
                                    üóëÔ∏è
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                lista.innerHTML = html;
            };
            
            // Fun√ß√£o para remover ingrediente
            window.removerSubIngrediente = function(index) {
                ingredientesTemp.splice(index, 1);
                renderizarListaSubIngredientes();
                atualizarResumoSubReceita();
            };
            
            // Fun√ß√£o para atualizar resumo
            window.atualizarResumoSubReceita = function() {
                const rendimento = parseFloat(document.getElementById('sub-receita-rendimento').value) || 1;
                const unidade = document.getElementById('sub-receita-unidade-rendimento').value;
                
                let custoTotal = 0;
                ingredientesTemp.forEach(ing => {
                    const precoMedio = calcularPrecoMedioPonderado(ing.materialNome);
                    custoTotal += precoMedio * ing.quantidade;
                });
                
                const custoPorUnidade = custoTotal / rendimento;
                
                document.getElementById('sub-resumo-custo-total').textContent = formatarMoeda(custoTotal);
                document.getElementById('sub-resumo-custo-unidade').textContent = formatarMoeda(custoPorUnidade);
            };
            
            // Atualizar resumo quando mudar rendimento
            const inputRendimento = document.getElementById('sub-receita-rendimento');
            if (inputRendimento) {
                inputRendimento.addEventListener('input', atualizarResumoSubReceita);
            }
            
            // Submit do formul√°rio
            const form = document.getElementById('form-sub-receita');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const dados = {
                        id: document.getElementById('sub-receita-id').value || null,
                        nome: document.getElementById('sub-receita-nome').value,
                        tipo: document.getElementById('sub-receita-tipo').value,
                        rendimento: parseFloat(document.getElementById('sub-receita-rendimento').value),
                        unidadeRendimento: document.getElementById('sub-receita-unidade-rendimento').value,
                        observacoes: document.getElementById('sub-receita-observacoes').value,
                        ingredientes: ingredientesTemp
                    };
                    
                    if (salvarSubReceita(dados)) {
                        // Limpar formul√°rio
                        form.reset();
                        ingredientesTemp = [];
                        renderizarListaSubIngredientes();
                        atualizarResumoSubReceita();
                        
                        // Voltar para aba de listagem
                        document.querySelector('#sub-receitas-page .tab-button[data-tab="listar-sub"]').click();
                        
                        // Recarregar lista
                        carregarPaginaSubReceitas();
                    }
                });
            }
            
            // Expor ingredientesTemp para fun√ß√µes de edi√ß√£o
            window.ingredientesTempSubReceita = ingredientesTemp;
        }
        
        /**
         * CONFIGURA PESQUISA E FILTROS DE SUB-RECEITAS
         */
        function configurarPesquisaSubReceitas() {
            const inputPesquisa = document.getElementById('pesquisar-sub-receitas');
            const selectTipo = document.getElementById('filtro-tipo-sub');
            
            function filtrar() {
                const termo = inputPesquisa?.value.toLowerCase() || '';
                const tipo = selectTipo?.value || '';
                
                const cards = document.querySelectorAll('#lista-sub-receitas-cards .card');
                cards.forEach(card => {
                    const texto = card.textContent.toLowerCase();
                    const matchTermo = texto.includes(termo);
                    const matchTipo = !tipo || card.getAttribute('data-tipo') === tipo;
                    
                    card.style.display = (matchTermo && matchTipo) ? 'block' : 'none';
                });
            }
            
            if (inputPesquisa) inputPesquisa.addEventListener('input', filtrar);
            if (selectTipo) selectTipo.addEventListener('change', filtrar);
        }
        
        /**
         * CANCELA EDI√á√ÉO DE SUB-RECEITA
         */
        function cancelarEdicaoSubReceita() {
            document.getElementById('form-sub-receita').reset();
            document.getElementById('sub-receita-id').value = '';
            document.getElementById('titulo-form-sub-receita').textContent = '‚ûï Nova Sub-Receita';
            
            if (window.ingredientesTempSubReceita) {
                window.ingredientesTempSubReceita.length = 0;
            }
            
            renderizarListaSubIngredientes();
            atualizarResumoSubReceita();
        }

        /**
         * CALCULA CUSTO DE UM PRODUTO FINAL
         * Retorna custo detalhado e ingredientes consolidados
         */
        function calcularCustoProdutoFinal(produto) {
            if (!produto || !produto.componentes || produto.componentes.length === 0) {
                return {
                    custoIngredientes: 0,
                    custoIndireto: 0,
                    custoTotal: 0,
                    custoPorKg: 0,
                    custoPorUnidade: 0,
                    custoFixoRateado: 0,
                    precoSugeridoComMarkup: 0,
                    ingredientesConsolidados: []
                };
            }
            
            let custoIngredientes = 0;
            const ingredientesConsolidados = [];
            
            // Processar cada componente
            produto.componentes.forEach(componente => {
                if (componente.tipo === 'subReceita') {
                    // Componente √© uma sub-receita
                    const subReceita = subReceitas.find(s => s.id === componente.subReceitaId);
                    if (!subReceita) return;
                    
                    const quantidadeUsada = parseFloat(componente.quantidade) || 0;
                    const rendimentoSub = parseFloat(subReceita.rendimento) || 1;
                    
                    // Custo proporcional da sub-receita
                    const custosSub = calcularCustoSubReceita(subReceita);
                    const custoPropor√ß√£o = (quantidadeUsada / rendimentoSub) * custosSub.custoTotal;
                    custoIngredientes += custoPropor√ß√£o;
                    
                    // Consolidar ingredientes da sub-receita
                    subReceita.ingredientes.forEach(ing => {
                        const quantidadeProporcional = (quantidadeUsada / rendimentoSub) * ing.quantidade;
                        
                        // Verificar se j√° existe no consolidado
                        const existente = ingredientesConsolidados.find(i => i.materialId === ing.materialId);
                        if (existente) {
                            existente.quantidade += quantidadeProporcional;
                        } else {
                            ingredientesConsolidados.push({
                                materialId: ing.materialId,
                                materialNome: ing.materialNome,
                                quantidade: quantidadeProporcional,
                                unidadeMedida: ing.unidadeMedida,
                                origem: `Sub-receita: ${subReceita.nome}`
                            });
                        }
                    });
                    
                } else if (componente.tipo === 'ingrediente') {
                    // Componente √© ingrediente direto
                    const material = materiais.find(m => m.id === componente.materialId);
                    if (!material) return;
                    
                    const precoMedio = calcularPrecoMedioPonderado(material.nome);
                    const quantidade = parseFloat(componente.quantidade) || 0;
                    
                    custoIngredientes += precoMedio * quantidade;
                    
                    // Adicionar ao consolidado
                    const existente = ingredientesConsolidados.find(i => i.materialId === componente.materialId);
                    if (existente) {
                        existente.quantidade += quantidade;
                    } else {
                        ingredientesConsolidados.push({
                            materialId: componente.materialId,
                            materialNome: material.nome,
                            quantidade: quantidade,
                            unidadeMedida: material.unidadeMedida || 'un',
                            origem: 'Ingrediente direto'
                        });
                    }
                }
            });
            
            // Calcular custo indireto
            const percentualIndireto = parseFloat(produto.percentualCustosIndiretos) || 0;
            const custoIndireto = custoIngredientes * percentualIndireto;
            const custoTotal = custoIngredientes + custoIndireto;
            
            // üÜï ADICIONAR CUSTO FIXO RATEADO (do markup)
            const custoFixoRateado = configuracoesCustos.custoFixoPorUnidade || 0;
            
            // üÜï CALCULAR PRE√áO SUGERIDO COM MARKUP
            // Pre√ßo = (Custo Ingredientes + Custo Indireto) √ó Multiplicador Markup
            const multiplicador = configuracoesCustos.multiplicadorMarkup || 1;
            const precoSugeridoComMarkup = (custoIngredientes + custoIndireto) * multiplicador;
            
            // Calcular custo por unidade/kg
            let custoPorKg = 0;
            let custoPorUnidade = 0;
            let precoSugeridoPorKg = 0;
            let precoSugeridoPorUnidade = 0;
            
            if (produto.tipoPrecificacao === 'peso') {
                const pesoBase = parseFloat(produto.pesoBase) || 1;
                custoPorKg = custoTotal / pesoBase;
                precoSugeridoPorKg = precoSugeridoComMarkup / pesoBase;
            } else if (produto.tipoPrecificacao === 'unidade') {
                custoPorUnidade = custoTotal;
                precoSugeridoPorUnidade = precoSugeridoComMarkup;
            }
            
            return {
                custoIngredientes: custoIngredientes,
                custoIndireto: custoIndireto,
                custoTotal: custoTotal,
                custoFixoRateado: custoFixoRateado,
                custoPorKg: custoPorKg,
                custoPorUnidade: custoPorUnidade,
                precoSugeridoComMarkup: precoSugeridoComMarkup,
                precoSugeridoPorKg: precoSugeridoPorKg,
                precoSugeridoPorUnidade: precoSugeridoPorUnidade,
                ingredientesConsolidados: ingredientesConsolidados
            };
        }

        /**
         * SALVA PRODUTO FINAL (novo ou edi√ß√£o)
         */
        function salvarProdutoFinal(dados) {
            try {
                // Valida√ß√µes
                if (!dados.nome || dados.nome.trim() === '') {
                    throw new Error('Nome do produto √© obrigat√≥rio');
                }
                
                if (!dados.tipoPrecificacao) {
                    throw new Error('Tipo de precifica√ß√£o √© obrigat√≥rio');
                }
                
                if (!dados.componentes || dados.componentes.length === 0) {
                    throw new Error('Adicione pelo menos um componente (sub-receita ou ingrediente)');
                }
                
                // Validar precifica√ß√£o
                if (dados.tipoPrecificacao === 'peso') {
                    const pesoBase = parseFloat(dados.pesoBase);
                    const precoVendaKg = parseFloat(dados.precoVendaKg);
                    
                    if (isNaN(pesoBase) || pesoBase <= 0) {
                        throw new Error('Peso base deve ser maior que zero');
                    }
                    if (isNaN(precoVendaKg) || precoVendaKg <= 0) {
                        throw new Error('Pre√ßo de venda por kg deve ser maior que zero');
                    }
                } else if (dados.tipoPrecificacao === 'unidade') {
                    const precoVendaUnidade = parseFloat(dados.precoVendaUnidade);
                    
                    if (isNaN(precoVendaUnidade) || precoVendaUnidade <= 0) {
                        throw new Error('Pre√ßo de venda por unidade deve ser maior que zero');
                    }
                }
                
                // Calcular custos
                const custos = calcularCustoProdutoFinal({
                    ...dados,
                    percentualCustosIndiretos: parseFloat(dados.percentualCustosIndiretos) || 0
                });
                
                if (dados.id) {
                    // EDITAR EXISTENTE
                    const index = produtosFinais.findIndex(p => p.id === dados.id);
                    if (index === -1) throw new Error('Produto n√£o encontrado');
                    
                    produtosFinais[index] = {
                        ...produtosFinais[index],
                        nome: dados.nome.trim(),
                        categoria: dados.categoria || 'Outros',
                        descricao: dados.descricao || '',
                        tipoPrecificacao: dados.tipoPrecificacao,
                        pesoBase: dados.tipoPrecificacao === 'peso' ? parseFloat(dados.pesoBase) : null,
                        precoVendaKg: dados.tipoPrecificacao === 'peso' ? parseFloat(dados.precoVendaKg) : null,
                        pesoUnidade: dados.tipoPrecificacao === 'unidade' ? parseFloat(dados.pesoUnidade) || null : null,
                        precoVendaUnidade: dados.tipoPrecificacao === 'unidade' ? parseFloat(dados.precoVendaUnidade) : null,
                        percentualCustosIndiretos: parseFloat(dados.percentualCustosIndiretos) || 0,
                        componentes: dados.componentes,
                        custoTotal: custos.custoTotal,
                        custoPorKg: custos.custoPorKg,
                        custoPorUnidade: custos.custoPorUnidade,
                        atualizadoEm: new Date().toISOString()
                    };
                    
                    mostrarToast('Produto atualizado com sucesso!', 'success');
                    
                } else {
                    // CRIAR NOVO
                    const novoProduto = {
                        id: gerarId(),
                        nome: dados.nome.trim(),
                        categoria: dados.categoria || 'Outros',
                        descricao: dados.descricao || '',
                        tipoPrecificacao: dados.tipoPrecificacao,
                        pesoBase: dados.tipoPrecificacao === 'peso' ? parseFloat(dados.pesoBase) : null,
                        precoVendaKg: dados.tipoPrecificacao === 'peso' ? parseFloat(dados.precoVendaKg) : null,
                        pesoUnidade: dados.tipoPrecificacao === 'unidade' ? parseFloat(dados.pesoUnidade) || null : null,
                        precoVendaUnidade: dados.tipoPrecificacao === 'unidade' ? parseFloat(dados.precoVendaUnidade) : null,
                        percentualCustosIndiretos: parseFloat(dados.percentualCustosIndiretos) || 0.10,
                        componentes: dados.componentes,
                        custoTotal: custos.custoTotal,
                        custoPorKg: custos.custoPorKg,
                        custoPorUnidade: custos.custoPorUnidade,
                        ativa: true,
                        criadoEm: new Date().toISOString(),
                        atualizadoEm: new Date().toISOString()
                    };
                    
                    produtosFinais.push(novoProduto);
                    mostrarToast('Produto criado com sucesso!', 'success');
                }
                
                // Salvar
                salvarLocalStorage();
                sincronizarComNuvem();
                
                return true;
                
            } catch (erro) {
                console.error('Erro ao salvar produto:', erro);
                mostrarToast(erro.message, 'error');
                return false;
            }
        }

        /**
         * REMOVE PRODUTO FINAL
         */
        function removerProdutoFinal(produtoId) {
            try {
                const produto = produtosFinais.find(p => p.id === produtoId);
                if (!produto) {
                    throw new Error('Produto n√£o encontrado');
                }
                
                // Verificar se tem vendas ativas
                const vendasAtivas = vendas.filter(v => 
                    !v.cancelada && 
                    (v.receitaId === produtoId || 
                     (v.produtos && v.produtos.some(p => p.produtoId === produtoId)))
                );
                
                if (vendasAtivas.length > 0) {
                    throw new Error(`Este produto tem ${vendasAtivas.length} vendas ativas. N√£o √© poss√≠vel remover.`);
                }
                
                // Confirmar
                if (!confirm(`Tem certeza que deseja remover o produto "${produto.nome}"?`)) {
                    return false;
                }
                
                // Marcar como inativo
                const index = produtosFinais.findIndex(p => p.id === produtoId);
                if (index !== -1) {
                    produtosFinais[index].ativa = false;
                    produtosFinais[index].removidoEm = new Date().toISOString();
                }
                
                // Salvar
                salvarLocalStorage();
                sincronizarComNuvem();
                
                mostrarToast('Produto removido com sucesso!', 'success');
                return true;
                
            } catch (erro) {
                console.error('Erro ao remover produto:', erro);
                mostrarToast(erro.message, 'error');
                return false;
            }
        }

        /**
         * VALIDA SE H√Å ESTOQUE SUFICIENTE PARA UM PRODUTO
         */
        function validarEstoqueProduto(produtoId, quantidade) {
            try {
                const produto = produtosFinais.find(p => p.id === produtoId);
                if (!produto) {
                    return { valido: false, mensagem: 'Produto n√£o encontrado', faltantes: [] };
                }
                
                // Calcular ingredientes necess√°rios
                const custos = calcularCustoProdutoFinal(produto);
                const ingredientesNecessarios = custos.ingredientesConsolidados.map(ing => ({
                    ...ing,
                    quantidadeNecessaria: ing.quantidade * quantidade
                }));
                
                // Calcular estoque atual
                const estoqueAtual = calcularEstoqueCompleto();
                
                // Verificar cada ingrediente
                const faltantes = [];
                
                ingredientesNecessarios.forEach(ing => {
                    const material = materiais.find(m => m.id === ing.materialId);
                    if (!material) return;
                    
                    const nomeNorm = normalizarNome(material.nome);
                    const itemEstoque = estoqueAtual.find(e => normalizarNome(e.nome) === nomeNorm);
                    
                    const disponivel = itemEstoque ? itemEstoque.disponivel : 0;
                    const necessario = ing.quantidadeNecessaria;
                    
                    if (disponivel < necessario) {
                        faltantes.push({
                            materialNome: material.nome,
                            disponivel: disponivel,
                            necessario: necessario,
                            faltam: necessario - disponivel,
                            unidade: material.unidadeMedida || 'un'
                        });
                    }
                });
                
                if (faltantes.length > 0) {
                    let mensagem = 'Estoque insuficiente:\n';
                    faltantes.forEach(f => {
                        mensagem += `‚Ä¢ ${f.materialNome}: faltam ${f.faltam.toFixed(2)} ${f.unidade}\n`;
                    });
                    
                    return {
                        valido: false,
                        mensagem: mensagem,
                        faltantes: faltantes
                    };
                }
                
                return {
                    valido: true,
                    mensagem: 'Estoque suficiente',
                    faltantes: []
                };
                
            } catch (erro) {
                console.error('Erro ao validar estoque:', erro);
                return {
                    valido: false,
                    mensagem: 'Erro ao validar estoque: ' + erro.message,
                    faltantes: []
                };
            }
        }

        /**
         * CARREGA P√ÅGINA DE PRODUTOS
         */
        function carregarPaginaProdutos() {
            const page = document.getElementById('produtos-page');
            if (!page) return;
            
            page.innerHTML = `
                <h2>üéÇ Gest√£o de Produtos</h2>
                
                <div class="tab-buttons">
                    <button class="tab-button active" data-tab="listar-produtos">üìã Listar Produtos</button>
                    <button class="tab-button" data-tab="adicionar-produto">‚ûï Novo Produto</button>
                </div>
                
                <!-- TAB: Listar Produtos -->
                <div class="tab-content active" id="tab-listar-produtos">
                    <div class="card">
                        <h3>Produtos Cadastrados</h3>
                        
                        <!-- Filtros -->
                        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                            <input type="text" id="pesquisar-produtos" class="form-control" 
                                placeholder="üîç Pesquisar produto..." style="flex: 1; min-width: 200px;">
                            
                            <select id="filtro-categoria-produto" class="form-control" style="width: 200px;">
                                <option value="">Todas as categorias</option>
                                <option value="Bolos">Bolos</option>
                                <option value="Cupcakes">Cupcakes</option>
                                <option value="Tortas">Tortas</option>
                                <option value="Doces">Doces</option>
                                <option value="Salgados">Salgados</option>
                                <option value="Outros">Outros</option>
                            </select>
                            
                            <select id="filtro-tipo-precificacao" class="form-control" style="width: 200px;">
                                <option value="">Todos os tipos</option>
                                <option value="peso">‚öñÔ∏è Por Peso</option>
                                <option value="unidade">üî¢ Por Unidade</option>
                            </select>
                        </div>
                        
                        <div id="lista-produtos-cards">
                            ${renderizarProdutosCards()}
                        </div>
                    </div>
                </div>
                
                <!-- TAB: Adicionar Produto -->
                <div class="tab-content" id="tab-adicionar-produto">
                    <div class="card">
                        <h3 id="titulo-form-produto">‚ûï Novo Produto</h3>
                        
                        <form id="form-produto">
                            <input type="hidden" id="produto-id" value="">
                            
                            <h4 style="margin-bottom: 15px; color: var(--cor-primaria);">üìã Informa√ß√µes B√°sicas</h4>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="produto-nome">Nome do Produto: *</label>
                                        <input type="text" id="produto-nome" class="form-control" 
                                            placeholder="Ex: Bolo de Chocolate 1kg" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="produto-categoria">Categoria:</label>
                                        <select id="produto-categoria" class="form-control">
                                            <option value="Bolos">Bolos</option>
                                            <option value="Cupcakes">Cupcakes</option>
                                            <option value="Tortas">Tortas</option>
                                            <option value="Doces">Doces</option>
                                            <option value="Salgados">Salgados</option>
                                            <option value="Outros">Outros</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="produto-descricao">Descri√ß√£o:</label>
                                <textarea id="produto-descricao" class="form-control" rows="2" 
                                    placeholder="Descri√ß√£o opcional do produto"></textarea>
                            </div>
                            
                            <h4 style="margin-top: 30px; margin-bottom: 15px; color: var(--cor-primaria);">
                                üí∞ Precifica√ß√£o
                            </h4>
                            
                            <div class="form-group">
                                <label>Tipo de Precifica√ß√£o: *</label>
                                <div style="display: flex; gap: 20px; margin-top: 10px;">
                                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                        <input type="radio" name="tipo-precificacao" value="peso" checked>
                                        <span>‚öñÔ∏è Por Peso (kg)</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                        <input type="radio" name="tipo-precificacao" value="unidade">
                                        <span>üî¢ Por Unidade</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Campos para PESO -->
                            <div id="campos-precificacao-peso" style="display: block;">
                                <div class="form-row">
                                    <div class="form-col">
                                        <div class="form-group">
                                            <label for="produto-peso-base">Peso Base (kg): *</label>
                                            <input type="number" id="produto-peso-base" class="form-control" 
                                                min="0.01" step="0.01" value="1" placeholder="1.0">
                                        </div>
                                    </div>
                                    <div class="form-col">
                                        <div class="form-group">
                                            <label for="produto-preco-kg">Pre√ßo de Venda (R$/kg): *</label>
                                            <input type="number" id="produto-preco-kg" class="form-control" 
                                                min="0.01" step="0.01" placeholder="80.00">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Campos para UNIDADE -->
                            <div id="campos-precificacao-unidade" style="display: none;">
                                <div class="form-row">
                                    <div class="form-col">
                                        <div class="form-group">
                                            <label for="produto-peso-unidade">
                                                Peso por Unidade (kg):
                                                <small style="color: var(--cor-texto-claro);">(opcional, para controle)</small>
                                            </label>
                                            <input type="number" id="produto-peso-unidade" class="form-control" 
                                                min="0.001" step="0.001" placeholder="0.025">
                                        </div>
                                    </div>
                                    <div class="form-col">
                                        <div class="form-group">
                                            <label for="produto-preco-unidade">Pre√ßo de Venda (R$/un): *</label>
                                            <input type="number" id="produto-preco-unidade" class="form-control" 
                                                min="0.01" step="0.01" placeholder="3.00">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="produto-custos-indiretos">
                                    Custos Indiretos (%):
                                    <small style="color: var(--cor-texto-claro);">
                                        (energia, g√°s, √°gua, embalagem)
                                    </small>
                                </label>
                                <input type="number" id="produto-custos-indiretos" class="form-control" 
                                    min="0" max="100" step="1" value="10">
                            </div>
                            
                            <!-- üÜï INFORMA√á√ïES DO MARKUP -->
                            ${configuracoesCustos.fixos.total > 0 ? `
                                <div style="background: var(--cor-secundaria-clara); padding: 15px; 
                                    border-radius: var(--borda-radius); margin-top: 20px; border-left: 4px solid var(--cor-primaria);">
                                    <h4 style="margin: 0 0 10px 0; color: var(--cor-primaria);">üéØ Markup Configurado</h4>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                                        <div>
                                            <small style="color: var(--cor-texto-claro);">Custo Fixo/Produto</small>
                                            <div style="font-weight: bold;">${formatarMoeda(configuracoesCustos.custoFixoPorUnidade)}</div>
                                        </div>
                                        <div>
                                            <small style="color: var(--cor-texto-claro);">Multiplicador</small>
                                            <div style="font-weight: bold; color: var(--cor-primaria);">
                                                ${configuracoesCustos.multiplicadorMarkup.toFixed(2)}x
                                            </div>
                                        </div>
                                        <div>
                                            <small style="color: var(--cor-texto-claro);">Margem Desejada</small>
                                            <div style="font-weight: bold; color: var(--cor-sucesso);">
                                                ${configuracoesCustos.margemLucroDesejada}%
                                            </div>
                                        </div>
                                    </div>
                                    <small style="color: var(--cor-texto-claro); display: block; margin-top: 10px;">
                                        üí° O pre√ßo ser√° calculado automaticamente aplicando este markup. 
                                        <a href="#" onclick="navegarPagina('configuracoes'); return false;" 
                                            style="color: var(--cor-primaria);">Ajustar markup</a>
                                    </small>
                                </div>
                            ` : `
                                <div class="notification notification-warning" style="margin-top: 20px;">
                                    ‚ö†Ô∏è <strong>Markup n√£o configurado!</strong> 
                                    <a href="#" onclick="navegarPagina('configuracoes'); return false;" 
                                        style="color: var(--cor-primaria); text-decoration: underline;">
                                        Clique aqui para configurar seus custos fixos
                                    </a> 
                                    e o sistema calcular√° o pre√ßo sugerido automaticamente.
                                </div>
                            `}
                            
                            <h4 style="margin-top: 30px; margin-bottom: 15px; color: var(--cor-primaria);">
                                üß© Composi√ß√£o
                            </h4>
                            
                            <div class="tab-buttons" style="margin-bottom: 15px;">
                                <button type="button" class="tab-button active" data-tab-comp="sub-receita">
                                    üß© Sub-Receita
                                </button>
                                <button type="button" class="tab-button" data-tab-comp="ingrediente">
                                    üè∑Ô∏è Ingrediente Direto
                                </button>
                            </div>
                            
                            <!-- Tab: Adicionar Sub-Receita -->
                            <div class="tab-content active" id="tab-comp-sub-receita">
                                <div style="background: var(--cor-fundo); padding: 15px; border-radius: var(--borda-radius); margin-bottom: 15px;">
                                    <div class="form-row">
                                        <div class="form-col" style="flex: 2;">
                                            <label for="comp-sub-receita">Sub-Receita:</label>
                                            <select id="comp-sub-receita" class="form-control">
                                                <option value="">Selecione uma sub-receita...</option>
                                                ${subReceitas
                                                    .filter(s => s.ativa)
                                                    .sort((a, b) => a.nome.localeCompare(b.nome))
                                                    .map(s => {
                                                        const custos = calcularCustoSubReceita(s);
                                                        return `<option value="${s.id}">${s.nome} (${formatarMoeda(custos.custoPorKg)}/${s.unidadeRendimento})</option>`;
                                                    }).join('')
                                                }
                                            </select>
                                        </div>
                                        <div class="form-col">
                                            <label for="comp-sub-quantidade">Quantidade:</label>
                                            <input type="number" id="comp-sub-quantidade" class="form-control" 
                                                min="0.01" step="0.01" placeholder="0">
                                        </div>
                                        <div class="form-col">
                                            <label for="comp-sub-unidade">Unidade:</label>
                                            <input type="text" id="comp-sub-unidade" class="form-control" 
                                                placeholder="kg, g" readonly>
                                        </div>
                                        <div class="form-col" style="flex: 0.5;">
                                            <label>&nbsp;</label>
                                            <button type="button" id="btn-add-comp-sub" class="btn btn-success" 
                                                style="width: 100%;">‚ûï</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tab: Adicionar Ingrediente Direto -->
                            <div class="tab-content" id="tab-comp-ingrediente">
                                <div style="background: var(--cor-fundo); padding: 15px; border-radius: var(--borda-radius); margin-bottom: 15px;">
                                    <div class="form-row">
                                        <div class="form-col" style="flex: 2;">
                                            <label for="comp-ingrediente-material">Material:</label>
                                            <select id="comp-ingrediente-material" class="form-control">
                                                <option value="">Selecione um material...</option>
                                                ${materiais
                                                    .filter(m => !m.removed)
                                                    .sort((a, b) => a.nome.localeCompare(b.nome))
                                                    .map(m => {
                                                        const precoMedio = calcularPrecoMedioPonderado(m.nome);
                                                        const unidade = m.unidadeMedida || 'un';
                                                        return `<option value="${m.id}">${m.nome} (${formatarMoeda(precoMedio)}/${unidade})</option>`;
                                                    }).join('')
                                                }
                                            </select>
                                        </div>
                                        <div class="form-col">
                                            <label for="comp-ingrediente-quantidade">Quantidade:</label>
                                            <input type="number" id="comp-ingrediente-quantidade" class="form-control" 
                                                min="0.01" step="0.01" placeholder="0">
                                        </div>
                                        <div class="form-col">
                                            <label for="comp-ingrediente-unidade">Unidade:</label>
                                            <input type="text" id="comp-ingrediente-unidade" class="form-control" 
                                                placeholder="g, ml, un" readonly>
                                        </div>
                                        <div class="form-col" style="flex: 0.5;">
                                            <label>&nbsp;</label>
                                            <button type="button" id="btn-add-comp-ingrediente" class="btn btn-success" 
                                                style="width: 100%;">‚ûï</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="lista-componentes-produto">
                                <!-- Componentes adicionados aparecer√£o aqui -->
                            </div>
                            
                            <h4 style="margin-top: 30px; margin-bottom: 15px; color: var(--cor-primaria);">
                                üí∞ Resumo Financeiro
                            </h4>
                            
                            <div id="resumo-financeiro-produto" style="background: var(--cor-info-claro); 
                                padding: 15px; border-radius: var(--borda-radius);">
                                <table style="width: 100%;">
                                    <tr>
                                        <td><strong>Custo Ingredientes:</strong></td>
                                        <td id="prod-resumo-custo-ingredientes" style="text-align: right;">R$ 0,00</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Custos Indiretos:</strong></td>
                                        <td id="prod-resumo-custos-indiretos" style="text-align: right;">R$ 0,00</td>
                                    </tr>
                                    <tr style="border-top: 2px solid var(--cor-borda);">
                                        <td><strong>Custo Total Direto:</strong></td>
                                        <td id="prod-resumo-custo-total" style="text-align: right; font-weight: bold;">R$ 0,00</td>
                                    </tr>
                                    
                                    <!-- üÜï SE√á√ÉO DE MARKUP -->
                                    <tr style="background: var(--cor-secundaria-clara);">
                                        <td colspan="2" style="padding-top: 10px;"><strong>üí∞ Com Markup Aplicado:</strong></td>
                                    </tr>
                                    <tr>
                                        <td>Custo Fixo Rateado:</td>
                                        <td id="prod-resumo-custo-fixo" style="text-align: right;">R$ 0,00</td>
                                    </tr>
                                    <tr style="background: var(--cor-primaria); color: white;">
                                        <td><strong>üí° Pre√ßo Sugerido (${configuracoesCustos.multiplicadorMarkup.toFixed(2)}x):</strong></td>
                                        <td id="prod-resumo-preco-sugerido" style="text-align: right; font-weight: bold; font-size: 18px;">
                                            R$ 0,00
                                        </td>
                                    </tr>
                                    
                                    <tr style="border-top: 2px solid var(--cor-borda);">
                                        <td colspan="2" style="padding-top: 10px;"><strong>üìä Seus Pre√ßos:</strong></td>
                                    </tr>
                                    <tr id="linha-custo-kg" style="display: table-row;">
                                        <td><strong>Custo/kg:</strong></td>
                                        <td id="prod-resumo-custo-kg" style="text-align: right;">R$ 0,00</td>
                                    </tr>
                                    <tr id="linha-custo-unidade" style="display: none;">
                                        <td><strong>Custo/unidade:</strong></td>
                                        <td id="prod-resumo-custo-unidade" style="text-align: right;">R$ 0,00</td>
                                    </tr>
                                    <tr id="linha-preco-kg" style="display: table-row;">
                                        <td><strong>Seu Pre√ßo/kg:</strong></td>
                                        <td id="prod-resumo-preco-kg" style="text-align: right; font-weight: bold;">R$ 0,00</td>
                                    </tr>
                                    <tr id="linha-preco-unidade" style="display: none;">
                                        <td><strong>Seu Pre√ßo/unidade:</strong></td>
                                        <td id="prod-resumo-preco-unidade" style="text-align: right; font-weight: bold;">R$ 0,00</td>
                                    </tr>
                                    <tr style="border-top: 2px solid var(--cor-borda);">
                                        <td><strong>Lucro:</strong></td>
                                        <td id="prod-resumo-lucro" style="text-align: right; font-weight: bold; color: var(--cor-sucesso);">R$ 0,00</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Margem Real:</strong></td>
                                        <td id="prod-resumo-margem" style="text-align: right; font-weight: bold; font-size: 18px; color: var(--cor-sucesso);">0%</td>
                                    </tr>
                                </table>
                            </div>
                            
                            <!-- Valida√ß√£o de Estoque -->
                            <div id="alerta-estoque-produto" style="display: none; background: var(--cor-aviso-claro); 
                                padding: 15px; border-radius: var(--borda-radius); margin-top: 15px; border-left: 4px solid var(--cor-aviso);">
                                <strong>‚ö†Ô∏è Aten√ß√£o:</strong>
                                <div id="alerta-estoque-conteudo"></div>
                            </div>
                            
                            <div style="margin-top: 25px; display: flex; gap: 10px;">
                                <button type="submit" class="btn btn-primary">üíæ Salvar Produto</button>
                                <button type="button" class="btn btn-secondary" onclick="cancelarEdicaoProduto()">
                                    ‚ùå Cancelar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Configurar tabs
            configurarTabsProdutos();
            
            // Configurar formul√°rio
            configurarFormularioProduto();
            
            // Configurar pesquisa e filtros
            configurarPesquisaProdutos();
        }

        /**
         * RENDERIZA CARDS DE PRODUTOS
         */
        function renderizarProdutosCards() {
            const produtosAtivos = produtosFinais.filter(p => p.ativa);
            
            if (produtosAtivos.length === 0) {
                return '<p style="text-align: center; color: var(--cor-texto-claro);">Nenhum produto cadastrado.</p>';
            }
            
            // Agrupar por categoria
            const grupos = {};
            produtosAtivos.forEach(produto => {
                const cat = produto.categoria || 'Outros';
                if (!grupos[cat]) grupos[cat] = [];
                grupos[cat].push(produto);
            });
            
            let html = '';
            
            Object.keys(grupos).sort().forEach(categoria => {
                const produtos = grupos[categoria];
                
                html += `
                    <h4 style="margin-top: 20px; margin-bottom: 15px; color: var(--cor-primaria);">
                        ${categoria} (${produtos.length})
                    </h4>
                `;
                
                produtos.forEach(produto => {
                    const custos = calcularCustoProdutoFinal(produto);
                    
                    let precoVenda = 0;
                    let precoTexto = '';
                    let margemLucro = 0;
                    
                    if (produto.tipoPrecificacao === 'peso') {
                        precoVenda = produto.precoVendaKg || 0;
                        precoTexto = `${formatarMoeda(precoVenda)}/kg`;
                        const lucro = (precoVenda * produto.pesoBase) - custos.custoTotal;
                        margemLucro = precoVenda > 0 ? (lucro / (precoVenda * produto.pesoBase)) * 100 : 0;
                    } else {
                        precoVenda = produto.precoVendaUnidade || 0;
                        precoTexto = `${formatarMoeda(precoVenda)}/un`;
                        const lucro = precoVenda - custos.custoTotal;
                        margemLucro = precoVenda > 0 ? (lucro / precoVenda) * 100 : 0;
                    }
                    
                    const corMargem = margemLucro >= 20 ? 'var(--cor-sucesso)' : 
                                     margemLucro >= 10 ? 'var(--cor-aviso)' : 'var(--cor-erro)';
                    
                    // Validar estoque
                    const validacao = validarEstoqueProduto(produto.id, 1);
                    
                    html += `
                        <div class="card" style="margin-bottom: 15px; border-left: 4px solid var(--cor-primaria);" 
                            data-categoria="${categoria}" data-tipo="${produto.tipoPrecificacao}">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <h4 style="margin: 0 0 5px 0;">${produto.nome}</h4>
                                    ${produto.descricao ? `
                                        <p style="margin: 5px 0; color: var(--cor-texto-claro); font-size: 14px;">
                                            ${produto.descricao}
                                        </p>
                                    ` : ''}
                                    <div style="margin-top: 10px;">
                                        <span class="badge badge-info">
                                            ${produto.tipoPrecificacao === 'peso' ? '‚öñÔ∏è Por Peso' : 'üî¢ Por Unidade'}
                                        </span>
                                        <span class="badge badge-success">${produto.componentes.length} componentes</span>
                                        ${!validacao.valido ? 
                                            '<span class="badge badge-danger">‚ö†Ô∏è Estoque Insuficiente</span>' : 
                                            '<span class="badge badge-success">‚úì Estoque OK</span>'
                                        }
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 24px; font-weight: bold; color: var(--cor-primaria);">
                                        ${precoTexto}
                                    </div>
                                    <div style="font-size: 14px; color: ${corMargem}; font-weight: 600;">
                                        Margem: ${margemLucro.toFixed(1)}%
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
                                gap: 15px; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--cor-borda);">
                                <div>
                                    <div style="font-size: 12px; color: var(--cor-texto-claro);">Custo Total</div>
                                    <div style="font-size: 16px; font-weight: 600;">
                                        ${formatarMoeda(custos.custoTotal)}
                                    </div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: var(--cor-texto-claro);">
                                        ${produto.tipoPrecificacao === 'peso' ? 'Custo/kg' : 'Custo/un'}
                                    </div>
                                    <div style="font-size: 16px; font-weight: 600;">
                                        ${formatarMoeda(produto.tipoPrecificacao === 'peso' ? custos.custoPorKg : custos.custoPorUnidade)}
                                    </div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: var(--cor-texto-claro);">
                                        ${produto.tipoPrecificacao === 'peso' ? `Peso Base: ${produto.pesoBase}kg` : 'Pre√ßo Unit√°rio'}
                                    </div>
                                    <div style="font-size: 16px; font-weight: 600;">
                                        ${produto.tipoPrecificacao === 'peso' ? 
                                            formatarMoeda(produto.precoVendaKg * produto.pesoBase) : 
                                            formatarMoeda(produto.precoVendaUnidade)
                                        }
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 15px; display: flex; gap: 5px; flex-wrap: wrap;">
                                <button class="btn btn-primary btn-sm" onclick="verDetalhesProduto('${produto.id}')">
                                    üëÅÔ∏è Ver Detalhes
                                </button>
                                <button class="btn btn-success btn-sm" onclick="editarProduto('${produto.id}')">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="if(removerProdutoFinal('${produto.id}')) carregarPaginaProdutos();">
                                    üóëÔ∏è Remover
                                </button>
                            </div>
                        </div>
                    `;
                });
            });
            
            return html;
        }

        /**
         * CONFIGURA TABS DE PRODUTOS
         */
        function configurarTabsProdutos() {
            const tabButtons = document.querySelectorAll('#produtos-page .tab-button');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const parent = this.closest('.tab-buttons');
                    parent.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                    
                    const container = this.closest('.card') || document.getElementById('produtos-page');
                    container.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab') || this.getAttribute('data-tab-comp');
                    
                    if (tabId) {
                        const tabContent = document.getElementById('tab-' + tabId) || 
                                           document.getElementById('tab-comp-' + tabId);
                        if (tabContent) {
                            tabContent.classList.add('active');
                        }
                    }
                });
            });
        }
        
        /**
         * CONFIGURA FORMUL√ÅRIO DE PRODUTO
         */
        function configurarFormularioProduto() {
            let componentesTemp = [];
            
            // Toggle entre tipo de precifica√ß√£o
            const radiosPrecificacao = document.querySelectorAll('input[name="tipo-precificacao"]');
            radiosPrecificacao.forEach(radio => {
                radio.addEventListener('change', function() {
                    const campoPeso = document.getElementById('campos-precificacao-peso');
                    const campoUnidade = document.getElementById('campos-precificacao-unidade');
                    const linhaCustoKg = document.getElementById('linha-custo-kg');
                    const linhaCustoUn = document.getElementById('linha-custo-unidade');
                    const linhaPrecoKg = document.getElementById('linha-preco-kg');
                    const linhaPrecoUn = document.getElementById('linha-preco-unidade');
                    
                    if (this.value === 'peso') {
                        campoPeso.style.display = 'block';
                        campoUnidade.style.display = 'none';
                        linhaCustoKg.style.display = 'table-row';
                        linhaCustoUn.style.display = 'none';
                        linhaPrecoKg.style.display = 'table-row';
                        linhaPrecoUn.style.display = 'none';
                    } else {
                        campoPeso.style.display = 'none';
                        campoUnidade.style.display = 'block';
                        linhaCustoKg.style.display = 'none';
                        linhaCustoUn.style.display = 'table-row';
                        linhaPrecoKg.style.display = 'none';
                        linhaPrecoUn.style.display = 'table-row';
                    }
                    
                    atualizarResumoProduto();
                });
            });
            
            // Atualizar unidade quando selecionar sub-receita
            const selectSubReceita = document.getElementById('comp-sub-receita');
            if (selectSubReceita) {
                selectSubReceita.addEventListener('change', function() {
                    const subReceitaId = this.value;
                    const subReceita = subReceitas.find(s => s.id === subReceitaId);
                    const inputUnidade = document.getElementById('comp-sub-unidade');
                    
                    if (subReceita && inputUnidade) {
                        inputUnidade.value = subReceita.unidadeRendimento || 'kg';
                    }
                });
            }
            
            // Atualizar unidade quando selecionar material
            const selectMaterial = document.getElementById('comp-ingrediente-material');
            if (selectMaterial) {
                selectMaterial.addEventListener('change', function() {
                    const materialId = this.value;
                    const material = materiais.find(m => m.id === materialId);
                    const inputUnidade = document.getElementById('comp-ingrediente-unidade');
                    
                    if (material && inputUnidade) {
                        inputUnidade.value = material.unidadeMedida || 'un';
                    }
                });
            }
            
            // Bot√£o adicionar sub-receita
            const btnAddSub = document.getElementById('btn-add-comp-sub');
            if (btnAddSub) {
                btnAddSub.addEventListener('click', function() {
                    const subReceitaId = document.getElementById('comp-sub-receita').value;
                    const quantidade = parseFloat(document.getElementById('comp-sub-quantidade').value);
                    
                    if (!subReceitaId) {
                        mostrarToast('Selecione uma sub-receita', 'warning');
                        return;
                    }
                    
                    if (!quantidade || quantidade <= 0) {
                        mostrarToast('Informe a quantidade', 'warning');
                        return;
                    }
                    
                    const subReceita = subReceitas.find(s => s.id === subReceitaId);
                    if (!subReceita) return;
                    
                    // Verificar se j√° foi adicionado
                    if (componentesTemp.some(c => c.tipo === 'subReceita' && c.subReceitaId === subReceitaId)) {
                        mostrarToast('Sub-receita j√° adicionada', 'warning');
                        return;
                    }
                    
                    componentesTemp.push({
                        tipo: 'subReceita',
                        subReceitaId: subReceitaId,
                        subReceitaNome: subReceita.nome,
                        quantidade: quantidade,
                        unidadeMedida: subReceita.unidadeRendimento || 'kg'
                    });
                    
                    renderizarListaComponentes();
                    atualizarResumoProduto();
                    validarEstoqueProdutoForm();
                    
                    // Limpar campos
                    document.getElementById('comp-sub-receita').value = '';
                    document.getElementById('comp-sub-quantidade').value = '';
                    document.getElementById('comp-sub-unidade').value = '';
                });
            }
            
            // Bot√£o adicionar ingrediente direto
            const btnAddIng = document.getElementById('btn-add-comp-ingrediente');
            if (btnAddIng) {
                btnAddIng.addEventListener('click', function() {
                    const materialId = document.getElementById('comp-ingrediente-material').value;
                    const quantidade = parseFloat(document.getElementById('comp-ingrediente-quantidade').value);
                    
                    if (!materialId) {
                        mostrarToast('Selecione um material', 'warning');
                        return;
                    }
                    
                    if (!quantidade || quantidade <= 0) {
                        mostrarToast('Informe a quantidade', 'warning');
                        return;
                    }
                    
                    const material = materiais.find(m => m.id === materialId);
                    if (!material) return;
                    
                    // Verificar se j√° foi adicionado
                    if (componentesTemp.some(c => c.tipo === 'ingrediente' && c.materialId === materialId)) {
                        mostrarToast('Material j√° adicionado', 'warning');
                        return;
                    }
                    
                    componentesTemp.push({
                        tipo: 'ingrediente',
                        materialId: materialId,
                        materialNome: material.nome,
                        quantidade: quantidade,
                        unidadeMedida: material.unidadeMedida || 'un'
                    });
                    
                    renderizarListaComponentes();
                    atualizarResumoProduto();
                    validarEstoqueProdutoForm();
                    
                    // Limpar campos
                    document.getElementById('comp-ingrediente-material').value = '';
                    document.getElementById('comp-ingrediente-quantidade').value = '';
                    document.getElementById('comp-ingrediente-unidade').value = '';
                });
            }
            
            // Fun√ß√£o para renderizar lista de componentes
            window.renderizarListaComponentes = function() {
                const lista = document.getElementById('lista-componentes-produto');
                if (!lista) return;
                
                if (componentesTemp.length === 0) {
                    lista.innerHTML = '<p style="text-align: center; color: var(--cor-texto-claro);">Nenhum componente adicionado.</p>';
                    return;
                }
                
                let html = '<table style="width: 100%;"><thead><tr><th>Tipo</th><th>Item</th><th>Quantidade</th><th>Custo</th><th>A√ß√µes</th></tr></thead><tbody>';
                
                componentesTemp.forEach((comp, index) => {
                    let custo = 0;
                    let nome = '';
                    let tipoTexto = '';
                    
                    if (comp.tipo === 'subReceita') {
                        const subReceita = subReceitas.find(s => s.id === comp.subReceitaId);
                        if (subReceita) {
                            const custosSub = calcularCustoSubReceita(subReceita);
                            const rendimento = parseFloat(subReceita.rendimento) || 1;
                            custo = (comp.quantidade / rendimento) * custosSub.custoTotal;
                            nome = comp.subReceitaNome;
                            tipoTexto = 'üß© Sub-Receita';
                        }
                    } else if (comp.tipo === 'ingrediente') {
                        const precoMedio = calcularPrecoMedioPonderado(comp.materialNome);
                        custo = precoMedio * comp.quantidade;
                        nome = comp.materialNome;
                        tipoTexto = 'üè∑Ô∏è Ingrediente';
                    }
                    
                    html += `
                        <tr>
                            <td>${tipoTexto}</td>
                            <td>${nome}</td>
                            <td>${comp.quantidade} ${comp.unidadeMedida}</td>
                            <td>${formatarMoeda(custo)}</td>
                            <td>
                                <button type="button" class="btn btn-danger btn-sm" onclick="removerComponenteProduto(${index})">
                                    üóëÔ∏è
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                lista.innerHTML = html;
            };
            
            // Fun√ß√£o para remover componente
            window.removerComponenteProduto = function(index) {
                componentesTemp.splice(index, 1);
                renderizarListaComponentes();
                atualizarResumoProduto();
                validarEstoqueProdutoForm();
            };
            
            // Fun√ß√£o para atualizar resumo financeiro
            window.atualizarResumoProduto = function() {
                // Criar produto tempor√°rio para c√°lculo
                const tipoPrecificacao = document.querySelector('input[name="tipo-precificacao"]:checked')?.value || 'peso';
                const pesoBase = parseFloat(document.getElementById('produto-peso-base')?.value) || 1;
                const precoKg = parseFloat(document.getElementById('produto-preco-kg')?.value) || 0;
                const precoUnidade = parseFloat(document.getElementById('produto-preco-unidade')?.value) || 0;
                const percentualIndiretos = parseFloat(document.getElementById('produto-custos-indiretos')?.value) || 0;
                
                const produtoTemp = {
                    tipoPrecificacao: tipoPrecificacao,
                    pesoBase: pesoBase,
                    precoVendaKg: precoKg,
                    precoVendaUnidade: precoUnidade,
                    percentualCustosIndiretos: percentualIndiretos / 100,
                    componentes: componentesTemp
                };
                
                const custos = calcularCustoProdutoFinal(produtoTemp);
                
                // Atualizar valores no resumo
                document.getElementById('prod-resumo-custo-ingredientes').textContent = formatarMoeda(custos.custoIngredientes);
                document.getElementById('prod-resumo-custos-indiretos').textContent = formatarMoeda(custos.custoIndireto);
                document.getElementById('prod-resumo-custo-total').textContent = formatarMoeda(custos.custoTotal);
                
                // üÜï ATUALIZAR CUSTO FIXO E PRE√áO SUGERIDO
                document.getElementById('prod-resumo-custo-fixo').textContent = formatarMoeda(custos.custoFixoRateado);
                
                if (tipoPrecificacao === 'peso') {
                    document.getElementById('prod-resumo-preco-sugerido').textContent = 
                        formatarMoeda(custos.precoSugeridoPorKg) + '/kg';
                } else {
                    document.getElementById('prod-resumo-preco-sugerido').textContent = 
                        formatarMoeda(custos.precoSugeridoPorUnidade) + '/un';
                }
                
                document.getElementById('prod-resumo-custo-kg').textContent = formatarMoeda(custos.custoPorKg);
                document.getElementById('prod-resumo-custo-unidade').textContent = formatarMoeda(custos.custoPorUnidade);
                
                // Calcular lucro e margem (com o pre√ßo que voc√™ definiu)
                let precoVenda = 0;
                let lucro = 0;
                let margem = 0;
                
                if (tipoPrecificacao === 'peso') {
                    precoVenda = precoKg * pesoBase;
                    lucro = precoVenda - custos.custoTotal;
                    margem = precoVenda > 0 ? (lucro / precoVenda) * 100 : 0;
                    document.getElementById('prod-resumo-preco-kg').textContent = formatarMoeda(precoVenda);
                } else {
                    precoVenda = precoUnidade;
                    lucro = precoVenda - custos.custoTotal;
                    margem = precoVenda > 0 ? (lucro / precoVenda) * 100 : 0;
                    document.getElementById('prod-resumo-preco-unidade').textContent = formatarMoeda(precoVenda);
                }
                
                const corMargem = margem >= 20 ? 'var(--cor-sucesso)' : 
                                 margem >= 10 ? 'var(--cor-aviso)' : 'var(--cor-erro)';
                
                document.getElementById('prod-resumo-lucro').textContent = formatarMoeda(lucro);
                document.getElementById('prod-resumo-margem').textContent = margem.toFixed(1) + '%';
                document.getElementById('prod-resumo-margem').style.color = corMargem;
            };
            
            // Fun√ß√£o para validar estoque no formul√°rio
            window.validarEstoqueProdutoForm = function() {
                const alertaDiv = document.getElementById('alerta-estoque-produto');
                const conteudoDiv = document.getElementById('alerta-estoque-conteudo');
                
                if (componentesTemp.length === 0) {
                    alertaDiv.style.display = 'none';
                    return;
                }
                
                // Criar produto tempor√°rio
                const produtoTemp = {
                    id: 'temp_' + Date.now(),
                    componentes: componentesTemp,
                    percentualCustosIndiretos: 0
                };
                
                const validacao = validarEstoqueProduto(produtoTemp.id, 1);
                
                // Temporariamente adicionar produto para valida√ß√£o
                const indexTemp = produtosFinais.findIndex(p => p.id === produtoTemp.id);
                if (indexTemp === -1) {
                    produtosFinais.push(produtoTemp);
                }
                
                const validacaoReal = validarEstoqueProduto(produtoTemp.id, 1);
                
                // Remover produto tempor√°rio
                const idx = produtosFinais.findIndex(p => p.id === produtoTemp.id);
                if (idx !== -1) {
                    produtosFinais.splice(idx, 1);
                }
                
                if (!validacaoReal.valido && validacaoReal.faltantes.length > 0) {
                    let html = '<ul style="margin: 5px 0; padding-left: 20px;">';
                    validacaoReal.faltantes.forEach(f => {
                        html += `<li>${f.materialNome}: dispon√≠vel ${f.disponivel.toFixed(2)} ${f.unidade}, necess√°rio ${f.necessario.toFixed(2)} ${f.unidade} (faltam ${f.faltam.toFixed(2)} ${f.unidade})</li>`;
                    });
                    html += '</ul>';
                    
                    conteudoDiv.innerHTML = html;
                    alertaDiv.style.display = 'block';
                } else {
                    alertaDiv.style.display = 'none';
                }
            };
            
            // Atualizar resumo quando mudar valores
            const inputsAtualizacao = [
                'produto-peso-base',
                'produto-preco-kg',
                'produto-preco-unidade',
                'produto-custos-indiretos'
            ];
            
            inputsAtualizacao.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', atualizarResumoProduto);
                }
            });
            
            // Submit do formul√°rio
            const form = document.getElementById('form-produto');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const tipoPrecificacao = document.querySelector('input[name="tipo-precificacao"]:checked')?.value;
                    
                    const dados = {
                        id: document.getElementById('produto-id').value || null,
                        nome: document.getElementById('produto-nome').value,
                        categoria: document.getElementById('produto-categoria').value,
                        descricao: document.getElementById('produto-descricao').value,
                        tipoPrecificacao: tipoPrecificacao,
                        percentualCustosIndiretos: parseFloat(document.getElementById('produto-custos-indiretos').value) / 100,
                        componentes: componentesTemp
                    };
                    
                    if (tipoPrecificacao === 'peso') {
                        dados.pesoBase = parseFloat(document.getElementById('produto-peso-base').value);
                        dados.precoVendaKg = parseFloat(document.getElementById('produto-preco-kg').value);
                    } else {
                        dados.pesoUnidade = parseFloat(document.getElementById('produto-peso-unidade').value) || null;
                        dados.precoVendaUnidade = parseFloat(document.getElementById('produto-preco-unidade').value);
                    }
                    
                    if (salvarProdutoFinal(dados)) {
                        // Limpar formul√°rio
                        form.reset();
                        componentesTemp = [];
                        renderizarListaComponentes();
                        atualizarResumoProduto();
                        
                        // Voltar para aba de listagem
                        document.querySelector('#produtos-page .tab-button[data-tab="listar-produtos"]').click();
                        
                        // Recarregar lista
                        carregarPaginaProdutos();
                    }
                });
            }
            
            // Expor componentesTemp para fun√ß√µes de edi√ß√£o
            window.componentesTempProduto = componentesTemp;
        }
        
        /**
         * CONFIGURA PESQUISA E FILTROS DE PRODUTOS
         */
        function configurarPesquisaProdutos() {
            const inputPesquisa = document.getElementById('pesquisar-produtos');
            const selectCategoria = document.getElementById('filtro-categoria-produto');
            const selectTipo = document.getElementById('filtro-tipo-precificacao');
            
            function filtrar() {
                const termo = inputPesquisa?.value.toLowerCase() || '';
                const categoria = selectCategoria?.value || '';
                const tipo = selectTipo?.value || '';
                
                const cards = document.querySelectorAll('#lista-produtos-cards .card');
                cards.forEach(card => {
                    const texto = card.textContent.toLowerCase();
                    const catCard = card.getAttribute('data-categoria');
                    const tipoCard = card.getAttribute('data-tipo');
                    
                    const matchTermo = texto.includes(termo);
                    const matchCategoria = !categoria || catCard === categoria;
                    const matchTipo = !tipo || tipoCard === tipo;
                    
                    card.style.display = (matchTermo && matchCategoria && matchTipo) ? 'block' : 'none';
                });
            }
            
            if (inputPesquisa) inputPesquisa.addEventListener('input', filtrar);
            if (selectCategoria) selectCategoria.addEventListener('change', filtrar);
            if (selectTipo) selectTipo.addEventListener('change', filtrar);
        }
        
        /**
         * CANCELA EDI√á√ÉO DE PRODUTO
         */
        function cancelarEdicaoProduto() {
            document.getElementById('form-produto').reset();
            document.getElementById('produto-id').value = '';
            document.getElementById('titulo-form-produto').textContent = '‚ûï Novo Produto';
            
            // Resetar tipo de precifica√ß√£o para peso
            document.querySelector('input[name="tipo-precificacao"][value="peso"]').checked = true;
            document.getElementById('campos-precificacao-peso').style.display = 'block';
            document.getElementById('campos-precificacao-unidade').style.display = 'none';
            
            if (window.componentesTempProduto) {
                window.componentesTempProduto.length = 0;
            }
            
            renderizarListaComponentes();
            atualizarResumoProduto();
            
            document.getElementById('alerta-estoque-produto').style.display = 'none';
        }

        /**
         * VER DETALHES DO PRODUTO
         */
        function verDetalhesProduto(produtoId) {
            const produto = produtosFinais.find(p => p.id === produtoId);
            if (!produto) {
                mostrarToast('Produto n√£o encontrado', 'error');
                return;
            }
            
            const custos = calcularCustoProdutoFinal(produto);
            
            let precoInfo = '';
            let lucroInfo = '';
            
            if (produto.tipoPrecificacao === 'peso') {
                const precoTotal = produto.precoVendaKg * produto.pesoBase;
                const lucro = precoTotal - custos.custoTotal;
                const margem = precoTotal > 0 ? (lucro / precoTotal) * 100 : 0;
                
                precoInfo = `
                    <tr>
                        <td><strong>Peso Base:</strong></td>
                        <td>${produto.pesoBase} kg</td>
                    </tr>
                    <tr>
                        <td><strong>Pre√ßo/kg:</strong></td>
                        <td>${formatarMoeda(produto.precoVendaKg)}</td>
                    </tr>
                    <tr>
                        <td><strong>Pre√ßo Total (${produto.pesoBase}kg):</strong></td>
                        <td style="font-weight: bold; color: var(--cor-primaria);">${formatarMoeda(precoTotal)}</td>
                    </tr>
                `;
                
                lucroInfo = `
                    <tr>
                        <td><strong>Lucro:</strong></td>
                        <td style="color: var(--cor-sucesso); font-weight: bold;">${formatarMoeda(lucro)}</td>
                    </tr>
                    <tr>
                        <td><strong>Margem:</strong></td>
                        <td style="font-weight: bold; font-size: 18px;">${margem.toFixed(1)}%</td>
                    </tr>
                `;
            } else {
                const lucro = produto.precoVendaUnidade - custos.custoTotal;
                const margem = produto.precoVendaUnidade > 0 ? (lucro / produto.precoVendaUnidade) * 100 : 0;
                
                precoInfo = `
                    ${produto.pesoUnidade ? `
                    <tr>
                        <td><strong>Peso/Unidade:</strong></td>
                        <td>${produto.pesoUnidade} kg</td>
                    </tr>
                    ` : ''}
                    <tr>
                        <td><strong>Pre√ßo/Unidade:</strong></td>
                        <td style="font-weight: bold; color: var(--cor-primaria);">${formatarMoeda(produto.precoVendaUnidade)}</td>
                    </tr>
                `;
                
                lucroInfo = `
                    <tr>
                        <td><strong>Lucro/Unidade:</strong></td>
                        <td style="color: var(--cor-sucesso); font-weight: bold;">${formatarMoeda(lucro)}</td>
                    </tr>
                    <tr>
                        <td><strong>Margem:</strong></td>
                        <td style="font-weight: bold; font-size: 18px;">${margem.toFixed(1)}%</td>
                    </tr>
                `;
            }
            
            // Renderizar componentes
            let componentesHtml = '<table style="width: 100%; margin-top: 10px;"><thead><tr><th>Tipo</th><th>Item</th><th>Quantidade</th><th>Custo</th></tr></thead><tbody>';
            
            produto.componentes.forEach(comp => {
                let custo = 0;
                let nome = '';
                let tipo = '';
                
                if (comp.tipo === 'subReceita') {
                    const subReceita = subReceitas.find(s => s.id === comp.subReceitaId);
                    if (subReceita) {
                        const custosSub = calcularCustoSubReceita(subReceita);
                        const rendimento = parseFloat(subReceita.rendimento) || 1;
                        custo = (comp.quantidade / rendimento) * custosSub.custoTotal;
                        nome = comp.subReceitaNome;
                        tipo = 'üß© Sub-Receita';
                    }
                } else if (comp.tipo === 'ingrediente') {
                    const precoMedio = calcularPrecoMedioPonderado(comp.materialNome);
                    custo = precoMedio * comp.quantidade;
                    nome = comp.materialNome;
                    tipo = 'üè∑Ô∏è Ingrediente';
                }
                
                componentesHtml += `
                    <tr>
                        <td>${tipo}</td>
                        <td>${nome}</td>
                        <td>${comp.quantidade} ${comp.unidadeMedida}</td>
                        <td>${formatarMoeda(custo)}</td>
                    </tr>
                `;
            });
            
            componentesHtml += '</tbody></table>';
            
            // Criar modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3>üéÇ Detalhes do Produto</h3>
                        <button class="modal-close" onclick="this.parentElement.parentElement.parentElement.remove()">√ó</button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin: 0; font-size: 20px;">${produto.nome}</h4>
                        ${produto.descricao ? `<p style="margin: 5px 0; color: var(--cor-texto-claro);">${produto.descricao}</p>` : ''}
                        <div style="margin-top: 10px;">
                            <span class="badge badge-info">${produto.categoria}</span>
                            <span class="badge badge-${produto.tipoPrecificacao === 'peso' ? 'success' : 'info'}">
                                ${produto.tipoPrecificacao === 'peso' ? '‚öñÔ∏è Por Peso' : 'üî¢ Por Unidade'}
                            </span>
                        </div>
                    </div>
                    
                    <h4 style="margin-top: 20px; margin-bottom: 10px; color: var(--cor-primaria);">üí∞ Informa√ß√µes Financeiras</h4>
                    <table style="width: 100%; margin-bottom: 20px;">
                        <tr>
                            <td><strong>Custo Ingredientes:</strong></td>
                            <td>${formatarMoeda(custos.custoIngredientes)}</td>
                        </tr>
                        <tr>
                            <td><strong>Custos Indiretos (${(produto.percentualCustosIndiretos * 100).toFixed(0)}%):</strong></td>
                            <td>${formatarMoeda(custos.custoIndireto)}</td>
                        </tr>
                        <tr style="border-top: 2px solid var(--cor-borda);">
                            <td><strong>Custo Total:</strong></td>
                            <td style="font-weight: bold;">${formatarMoeda(custos.custoTotal)}</td>
                        </tr>
                        ${precoInfo}
                        <tr style="border-top: 2px solid var(--cor-borda);">
                            ${lucroInfo}
                        </tr>
                    </table>
                    
                    <h4 style="margin-top: 20px; margin-bottom: 10px; color: var(--cor-primaria);">üß© Componentes</h4>
                    ${componentesHtml}
                    
                    <h4 style="margin-top: 20px; margin-bottom: 10px; color: var(--cor-primaria);">üì¶ Ingredientes Consolidados</h4>
                    <table style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Material</th>
                                <th>Quantidade Necess√°ria</th>
                                <th>Origem</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${custos.ingredientesConsolidados.map(ing => `
                                <tr>
                                    <td>${ing.materialNome}</td>
                                    <td>${ing.quantidade.toFixed(2)} ${ing.unidadeMedida}</td>
                                    <td style="font-size: 12px; color: var(--cor-texto-claro);">${ing.origem}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="editarProduto('${produto.id}'); this.closest('.modal-overlay').remove();">
                            ‚úèÔ∏è Editar Produto
                        </button>
                        <button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">
                            ‚ùå Fechar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        /**
         * EDITAR PRODUTO
         */
        function editarProduto(produtoId) {
            const produto = produtosFinais.find(p => p.id === produtoId);
            if (!produto) {
                mostrarToast('Produto n√£o encontrado', 'error');
                return;
            }
            
            // Ir para aba de edi√ß√£o
            const tabButton = document.querySelector('#produtos-page .tab-button[data-tab="adicionar-produto"]');
            if (tabButton) tabButton.click();
            
            // Preencher formul√°rio
            document.getElementById('produto-id').value = produto.id;
            document.getElementById('produto-nome').value = produto.nome;
            document.getElementById('produto-categoria').value = produto.categoria || 'Outros';
            document.getElementById('produto-descricao').value = produto.descricao || '';
            document.getElementById('produto-custos-indiretos').value = (produto.percentualCustosIndiretos * 100).toFixed(0);
            
            // Tipo de precifica√ß√£o
            if (produto.tipoPrecificacao === 'peso') {
                document.querySelector('input[name="tipo-precificacao"][value="peso"]').checked = true;
                document.getElementById('campos-precificacao-peso').style.display = 'block';
                document.getElementById('campos-precificacao-unidade').style.display = 'none';
                document.getElementById('produto-peso-base').value = produto.pesoBase;
                document.getElementById('produto-preco-kg').value = produto.precoVendaKg;
            } else {
                document.querySelector('input[name="tipo-precificacao"][value="unidade"]').checked = true;
                document.getElementById('campos-precificacao-peso').style.display = 'none';
                document.getElementById('campos-precificacao-unidade').style.display = 'block';
                document.getElementById('produto-peso-unidade').value = produto.pesoUnidade || '';
                document.getElementById('produto-preco-unidade').value = produto.precoVendaUnidade;
            }
            
            // Carregar componentes
            if (window.componentesTempProduto) {
                window.componentesTempProduto.length = 0;
                produto.componentes.forEach(comp => {
                    window.componentesTempProduto.push({...comp});
                });
            }
            
            // Atualizar t√≠tulo
            document.getElementById('titulo-form-produto').textContent = '‚úèÔ∏è Editar Produto';
            
            // Renderizar e atualizar
            renderizarListaComponentes();
            atualizarResumoProduto();
            validarEstoqueProdutoForm();
            
            // Scroll suave at√© o formul√°rio
            document.getElementById('tab-adicionar-produto').scrollIntoView({ behavior: 'smooth' });
        }
        
        /**
         * CALCULA ESTOQUE COMPLETO (CORRIGIDO)
         * Lan√ßado = soma de QUANTIDADES (em ml/g)
         * Estoque (Unidades) = quantidade de COMPRAS
         */
        function calcularEstoqueCompleto() {
            const estoqueCalculado = {};
            
            // 1. PROCESSAR LAN√áAMENTOS (de todos os materiais)
            materiais.forEach(material => {
                if (!material.nome) return;
                
                const nomeNorm = normalizarNome(material.nome);
                
                // Inicializar grupo se n√£o existe
                if (!estoqueCalculado[nomeNorm]) {
                    estoqueCalculado[nomeNorm] = {
                        nome: material.nome,
                        unidadePadrao: material.unidadeMedida || 'un',
                        totalLancado: 0,           // SOMA das QUANTIDADES (ml/g)
                        totalVendido: 0,           // SOMA do que foi vendido (ml/g)
                        totalRemovido: 0,          // SOMA do que foi removido (ml/g)
                        quantidadeCompras: 0,      // QUANTIDADE de COMPRAS (unidades)
                        disponivel: 0,
                        registros: []
                    };
                }
                
                // Somar lan√ßamentos do hist√≥rico de compras
                if (material.historicoCompras) {
                    material.historicoCompras.forEach(compra => {
                        // USAR quantidadeTotal (em ml/g) ao inv√©s de quantidade
                        const quantidadeTotal = parseFloat(compra.quantidadeTotal || compra.quantidade) || 0;
                        const quantidadeUnidades = parseFloat(compra.quantidadeUnidades || 1) || 1;
                        
                        if (compra.removed) {
                            estoqueCalculado[nomeNorm].totalRemovido += quantidadeTotal;
                        } else {
                            estoqueCalculado[nomeNorm].totalLancado += quantidadeTotal;
                            estoqueCalculado[nomeNorm].quantidadeCompras += quantidadeUnidades; // ‚Üê CORRIGIDO!
                            estoqueCalculado[nomeNorm].registros.push({
                                tipo: 'lancamento',
                                materialId: material.id,
                                quantidade: quantidadeTotal,
                                quantidadeUnidades: quantidadeUnidades,
                                data: compra.data,
                                preco: compra.precoTotal || compra.preco
                            });
                        }
                    });
                }
            });
            
            // 2. PROCESSAR VENDAS (subtrair do estoque em ml/g)
            vendas.forEach(venda => {
                if (venda.cancelada || !venda.ingredientesSnapshot) return;
                
                venda.ingredientesSnapshot.forEach(ingrediente => {
                    // Encontrar material pelo ID
                    const material = materiais.find(m => m.id === ingrediente.materialId);
                    if (!material || !material.nome) return;
                    
                    const nomeNorm = normalizarNome(material.nome);
                    
                    if (estoqueCalculado[nomeNorm]) {
                        const quantidade = parseFloat(ingrediente.quantidade) || 0;
                        estoqueCalculado[nomeNorm].totalVendido += quantidade;
                    }
                });
            });
            
            // 3. CALCULAR DISPON√çVEL para cada grupo
            Object.keys(estoqueCalculado).forEach(nomeNorm => {
                const grupo = estoqueCalculado[nomeNorm];
                grupo.disponivel = grupo.totalLancado - grupo.totalVendido - grupo.totalRemovido;
                
                // Garantir que n√£o fique negativo
                if (grupo.disponivel < 0) grupo.disponivel = 0;
            });
            
            // 4. Converter para array
            return Object.values(estoqueCalculado);
        }
        
        /**
         * Busca material por c√≥digo
         */
        function buscarMaterialPorCodigo(codigo) {
            if (!codigo) return null;
            return materiais.find(m => m.codigo === codigo && !m.removed);
        }
        
        /**
         * Busca materiais por nome (normalizado)
         */
        function buscarMateriaisPorNome(nome) {
            if (!nome) return [];
            const nomeNorm = normalizarNome(nome);
            return materiais.filter(m => 
                normalizarNome(m.nome) === nomeNorm && !m.removed
            );
        }
        
        /**
         * ADICIONA OU ATUALIZA MATERIAL (CORRIGIDO)
         */
        function adicionarMaterial(dados) {
            try {
                // Valida√ß√µes
                if (!dados.nome) throw new Error('Nome √© obrigat√≥rio');
                if (!dados.preco || dados.preco <= 0) throw new Error('Pre√ßo total inv√°lido');
                if (!dados.quantidade || dados.quantidade <= 0) throw new Error('Quantidade inv√°lida');
                if (!dados.quantidadePorUnidade || dados.quantidadePorUnidade <= 0) {
                    throw new Error('Quantidade por unidade inv√°lida');
                }
                
                // C√ÅLCULOS CORRETOS
                const precoTotal = parseFloat(dados.preco);           // Ex: R$ 50,00
                const quantidadeUnidades = parseFloat(dados.quantidade); // Ex: 5 caixas
                const quantidadePorUnidade = parseFloat(dados.quantidadePorUnidade); // Ex: 1000ml
                
                // Quantidade TOTAL em unidade de medida (ml, g, etc)
                const quantidadeTotalMedida = quantidadeUnidades * quantidadePorUnidade;
                // Ex: 5 caixas √ó 1000ml = 5000ml
                
                // Pre√ßo por unidade de medida (ml, g, etc)
                const precoPorMedida = precoTotal / quantidadeTotalMedida;
                // Ex: R$ 50,00 √∑ 5000ml = R$ 0,01/ml
                
                // Verificar se c√≥digo j√° existe com nome diferente
                if (dados.codigo) {
                    const materialComCodigo = buscarMaterialPorCodigo(dados.codigo);
                    if (materialComCodigo && normalizarNome(materialComCodigo.nome) !== normalizarNome(dados.nome)) {
                        throw new Error(`C√≥digo ${dados.codigo} j√° est√° cadastrado para "${materialComCodigo.nome}"`);
                    }
                }
                
                // Buscar material existente (mesmo c√≥digo ou mesmo nome)
                let materialExistente = null;
                
                if (dados.codigo) {
                    materialExistente = buscarMaterialPorCodigo(dados.codigo);
                }
                
                if (!materialExistente) {
                    const materiaisMesmoNome = buscarMateriaisPorNome(dados.nome);
                    if (materiaisMesmoNome.length > 0) {
                        materialExistente = materiaisMesmoNome[0];
                    }
                }
                
                const agora = new Date().toISOString();
                
                if (materialExistente) {
                    // ATUALIZAR material existente
                    
                    // Adicionar nova compra ao hist√≥rico
                    if (!materialExistente.historicoCompras) {
                        materialExistente.historicoCompras = [];
                    }
                    
                    materialExistente.historicoCompras.push({
                        id: gerarId(),
                        data: dados.dataCompra ? dataInputParaISO(dados.dataCompra) : agora,
                        precoTotal: precoTotal,                      // R$ 50,00
                        quantidadeUnidades: quantidadeUnidades,      // 5 caixas
                        quantidadePorUnidade: quantidadePorUnidade,  // 1000ml
                        quantidadeTotal: quantidadeTotalMedida,      // 5000ml
                        preco: precoTotal,                           // Manter compatibilidade
                        quantidade: quantidadeTotalMedida,           // Manter compatibilidade
                        fornecedor: dados.fornecedor || '',
                        notaFiscal: dados.notaFiscal || '',
                        removed: false
                    });
                    
                    // Atualizar informa√ß√µes
                    materialExistente.precoUltimaCompra = precoTotal;
                    materialExistente.dataUltimaCompra = dados.dataCompra || agora;
                    materialExistente.atualizadoEm = agora;
                    
                    // Recalcular pre√ßo m√©dio
                    materialExistente.precoMedio = calcularPrecoMedioPonderado(materialExistente.nome);
                    
                    console.log('‚úÖ Material atualizado:', materialExistente.nome);
                    
                } else {
                    // CRIAR novo material
                    
                    const novoMaterial = {
                        id: gerarId(),
                        codigo: dados.codigo || '',
                        nome: dados.nome,
                        marca: dados.marca || '',
                        
                        unidadeCompra: dados.unidadeCompra || 'un',
                        unidadeMedida: dados.unidadeMedida || 'un',
                        quantidadePorUnidade: quantidadePorUnidade,
                        
                        precoUltimaCompra: precoTotal,
                        dataUltimaCompra: dados.dataCompra || agora,
                        precoMedio: precoPorMedida,
                        
                        historicoCompras: [{
                            id: gerarId(),
                            data: dados.dataCompra ? dataInputParaISO(dados.dataCompra) : agora,
                            precoTotal: precoTotal,
                            quantidadeUnidades: quantidadeUnidades,
                            quantidadePorUnidade: quantidadePorUnidade,
                            quantidadeTotal: quantidadeTotalMedida,
                            preco: precoTotal,
                            quantidade: quantidadeTotalMedida,
                            fornecedor: dados.fornecedor || '',
                            notaFiscal: dados.notaFiscal || '',
                            removed: false
                        }],
                        
                        criadoEm: agora,
                        atualizadoEm: agora,
                        criadoPor: getUsuarioAtual(),
                        removed: false
                    };
                    
                    materiais.push(novoMaterial);
                    
                    console.log('‚úÖ Material criado:', novoMaterial.nome);
                }
                
                // Recalcular estoque
                estoque = calcularEstoqueCompleto();
                
                // Salvar
                salvarLocalStorage();
                sincronizarComNuvem();
                
                return true;
                
            } catch (erro) {
                console.error('Erro ao adicionar material:', erro);
                mostrarToast(erro.message, 'error');
                return false;
            }
        }
        
        /**
         * REMOVE MATERIAL (soft delete)
         */
        function removerMaterial(materialId) {
            try {
                const material = materiais.find(m => m.id === materialId);
                if (!material) throw new Error('Material n√£o encontrado');
                
                const confirma = confirm(
                    `Remover material "${material.nome}"?\n\n` +
                    `Isso marcar√° o material como removido.\n` +
                    `O estoque ser√° recalculado.`
                );
                
                if (!confirma) return false;
                
                // Marcar como removido
                material.removed = true;
                material.removidoEm = new Date().toISOString();
                material.removidoPor = getUsuarioAtual();
                
                // Recalcular estoque
                estoque = calcularEstoqueCompleto();
                
                // Salvar
                salvarLocalStorage();
                sincronizarComNuvem();
                
                mostrarToast('Material removido com sucesso!', 'success');
                
                return true;
                
            } catch (erro) {
                console.error('Erro ao remover material:', erro);
                mostrarToast(erro.message, 'error');
                return false;
            }
        }
        
        /**
         * REMOVE COMPRA DO HIST√ìRICO
         */
        function removerCompra(materialId, compraId, motivo) {
            try {
                const material = materiais.find(m => m.id === materialId);
                if (!material) throw new Error('Material n√£o encontrado');
                
                const compra = material.historicoCompras.find(c => c.id === compraId);
                if (!compra) throw new Error('Compra n√£o encontrada');
                
                const confirma = confirm(
                    `Remover compra de ${compra.quantidade} unidades?\n\n` +
                    `Pre√ßo: ${formatarMoeda(compra.preco)}\n` +
                    `Data: ${formatarData(compra.data)}\n\n` +
                    `O estoque ser√° recalculado.`
                );
                
                if (!confirma) return false;
                
                // Marcar compra como removida
                compra.removed = true;
                compra.removidoEm = new Date().toISOString();
                compra.removidoPor = getUsuarioAtual();
                compra.motivoRemocao = motivo || 'N√£o informado';
                
                // Recalcular pre√ßo m√©dio
                material.precoMedio = calcularPrecoMedioPonderado(material.nome);
                
                // Recalcular estoque
                estoque = calcularEstoqueCompleto();
                
                // Salvar
                salvarLocalStorage();
                sincronizarComNuvem();
                
                mostrarToast('Compra removida com sucesso!', 'success');
                
                return true;
                
            } catch (erro) {
                console.error('Erro ao remover compra:', erro);
                mostrarToast(erro.message, 'error');
                return false;
            }
        }
        
        // ====================================
        // INTERFACE - P√ÅGINA DE ESTOQUE
        // ====================================
        
        function carregarPaginaEstoque() {
            const page = document.getElementById('estoque-page');
            if (!page) return;
            
            // Recalcular estoque
            estoque = calcularEstoqueCompleto();
            
            page.innerHTML = `
                <h2>üì¶ Gest√£o de Estoque</h2>
                
                <div class="card">
                    <h3>Itens em Estoque</h3>
                    <p style="color: var(--cor-texto-claro); margin-bottom: 15px;">
                        ‚ÑπÔ∏è O estoque √© calculado automaticamente: <strong>Lan√ßamentos - Vendas - Remo√ß√µes</strong>
                    </p>
                    
                    <input type="text" id="pesquisar-estoque" class="form-control" 
                        placeholder="üîç Pesquisar material..." style="margin-bottom: 20px;">
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Material</th>
                                <th>Estoque (Unidades)</th>
                                <th>Lan√ßado</th>
                                <th>Vendido</th>
                                <th>Removido</th>
                                <th>Dispon√≠vel</th>
                                <th>Pre√ßo M√©dio</th>
                                <th>Valor Total</th>
                            </tr>
                        </thead>
                        <tbody id="lista-estoque">
                            ${estoque.length === 0 ? 
                                '<tr><td colspan="7" style="text-align: center;">Nenhum item no estoque</td></tr>' :
                                estoque.map(item => {
                                    const precoMedio = calcularPrecoMedioPonderado(item.nome);
                                    const valorTotal = item.disponivel * precoMedio;
                                    
                                    return `
                                        <tr>
                                            <td><strong>${item.nome}</strong></td>
                                            <td><strong>${item.quantidadeCompras}</strong> ${item.unidadePadrao === 'ml' || item.unidadePadrao === 'l' ? 'cx/pct' : item.unidadePadrao === 'g' || item.unidadePadrao === 'kg' ? 'cx/pct' : 'un'}</td>
                                            <td>${item.totalLancado.toFixed(2)} ${item.unidadePadrao}</td>
                                            <td>${item.totalVendido.toFixed(2)} ${item.unidadePadrao}</td>
                                            <td>${item.totalRemovido.toFixed(2)} ${item.unidadePadrao}</td>
                                            <td>
                                                <strong style="color: ${item.disponivel > 0 ? 'var(--cor-sucesso)' : 'var(--cor-erro)'}">
                                                    ${item.disponivel.toFixed(2)} ${item.unidadePadrao}
                                                </strong>
                                            </td>
                                            <td>${formatarMoeda(precoMedio)}/${item.unidadePadrao}</td>
                                            <td><strong>${formatarMoeda(valorTotal)}</strong></td>
                                        </tr>
                                    `;
                                }).join('')
                            }
                        </tbody>
                    </table>
                    
                    ${estoque.length > 0 ? `
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--cor-borda);">
                            <h4>üí∞ Resumo Financeiro</h4>
                            <p><strong>Valor Total em Estoque:</strong> ${formatarMoeda(
                                estoque.reduce((total, item) => {
                                    const precoMedio = calcularPrecoMedioPonderado(item.nome);
                                    return total + (item.disponivel * precoMedio);
                                }, 0)
                            )}</p>
                        </div>
                    ` : ''}
                </div>
            `;
            
            // Event listener para pesquisa
            const inputPesquisa = document.getElementById('pesquisar-estoque');
            if (inputPesquisa) {
                inputPesquisa.addEventListener('input', function() {
                    const termo = this.value.toLowerCase();
                    const linhas = document.querySelectorAll('#lista-estoque tr');
                    
                    linhas.forEach(linha => {
                        const texto = linha.textContent.toLowerCase();
                        linha.style.display = texto.includes(termo) ? '' : 'none';
                    });
                });
            }
        }
        
        // ====================================
        // INTERFACE - P√ÅGINA DE MATERIAIS
        // ====================================
        
        function carregarPaginaMateriais() {
            const page = document.getElementById('materiais-page');
            if (!page) return;
            
            page.innerHTML = `
                <h2>üè∑Ô∏è Gest√£o de Materiais</h2>
                
                <div class="tab-buttons">
                    <button class="tab-button active" data-tab="listar-materiais">üìã Listar Materiais</button>
                    <button class="tab-button" data-tab="adicionar-material">‚ûï Adicionar Material</button>
                </div>
                
                <!-- TAB: Listar Materiais -->
                <div class="tab-content active" id="tab-listar-materiais">
                    <div class="card">
                        <h3>Materiais Cadastrados</h3>
                        
                        <input type="text" id="pesquisar-materiais" class="form-control" 
                            placeholder="üîç Pesquisar material..." style="margin-bottom: 20px;">
                        
                        <div id="lista-materiais-cards">
                            ${renderizarListaMateriais()}
                        </div>
                    </div>
                </div>
                
                <!-- TAB: Adicionar Material -->
                <div class="tab-content" id="tab-adicionar-material">
                    <div class="card">
                        <h3>Adicionar Material ao Cat√°logo</h3>
                        
                        <form id="form-adicionar-material">
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="codigo-material">C√≥digo de Barras:</label>
                                        <input type="text" id="codigo-material" class="form-control" 
                                            placeholder="Digite ou escaneie o c√≥digo">
                                    </div>
                                </div>
                                <div class="form-col" style="flex: 0.5;">
                                    <div class="form-group">
                                        <label>&nbsp;</label>
                                        <button type="button" id="btn-scanner" class="btn btn-secondary" 
                                            style="width: 100%;">üì∑ Escanear</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="nome-material">Nome do Material: *</label>
                                <input type="text" id="nome-material" class="form-control" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="marca-material">Marca:</label>
                                        <input type="text" id="marca-material" class="form-control">
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="fornecedor-material">Fornecedor:</label>
                                        <input type="text" id="fornecedor-material" class="form-control">
                                    </div>
                                </div>
                            </div>
                            
                            <h4 style="margin-top: 25px; margin-bottom: 15px; color: var(--cor-primaria);">
                                üì¶ Informa√ß√µes da Compra
                            </h4>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="preco-material">Pre√ßo Total da Compra: *</label>
                                        <input type="number" id="preco-material" class="form-control" 
                                            min="0.01" step="0.01" required 
                                            placeholder="Ex: 50.00 (total pago)">
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="quantidade-material">Quantidade de Unidades: *</label>
                                        <input type="number" id="quantidade-material" class="form-control" 
                                            min="1" step="1" value="1" required
                                            placeholder="Ex: 5 (caixas/pacotes)">
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="unidade-compra-material">Tipo de Unidade:</label>
                                        <select id="unidade-compra-material" class="form-control">
                                            <option value="cx">Caixa</option>
                                            <option value="pct">Pacote</option>
                                            <option value="sc">Saco</option>
                                            <option value="un">Unidade</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <h4 style="margin-top: 25px; margin-bottom: 15px; color: var(--cor-primaria);">
                                üìè Como usar nas receitas
                            </h4>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="unidade-medida-material">Unidade de Medida:</label>
                                        <select id="unidade-medida-material" class="form-control">
                                            <option value="ml">Mililitros (ml)</option>
                                            <option value="l">Litros (L)</option>
                                            <option value="g">Gramas (g)</option>
                                            <option value="kg">Quilogramas (Kg)</option>
                                            <option value="un">Unidades (Un)</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="quantidade-por-unidade-material">Quantidade por Unidade Comprada:</label>
                                        <input type="number" id="quantidade-por-unidade-material" 
                                            class="form-control" min="0.01" step="0.01" value="1000" 
                                            placeholder="Ex: 1000 (cada caixa tem 1000ml)">
                                        <small style="color: var(--cor-texto-claro); font-size: 12px;">
                                            Ex: Se comprou 5 caixas de 1000ml cada, coloque 1000
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="data-compra-material">Data da Compra:</label>
                                        <input type="date" id="data-compra-material" class="form-control">
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="nota-fiscal-material">Nota Fiscal:</label>
                                        <input type="text" id="nota-fiscal-material" class="form-control" 
                                            placeholder="N√∫mero da NF">
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 25px; display: flex; gap: 10px;">
                                <button type="submit" class="btn btn-primary">üíæ Salvar Material</button>
                                <button type="button" class="btn btn-secondary" 
                                    onclick="document.getElementById('form-adicionar-material').reset()">
                                    üîÑ Limpar
                                </button>
                            </div>
                        </form>
                        
                        <!-- Scanner Container -->
                        <div id="scanner-container" class="hidden" style="margin-top: 30px;">
                            <h4>üì∑ Scanner de C√≥digo de Barras</h4>
                            <div id="reader" style="width: 100%; max-width: 500px; margin: 20px auto;"></div>
                            <button type="button" id="btn-stop-scanner" class="btn btn-danger">
                                ‚èπÔ∏è Parar Scanner
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Configurar tabs
            configurarTabsMateriais();
            
            // Configurar formul√°rio
            configurarFormularioMaterial();
            
            // Configurar scanner
            configurarScanner();
            
            // Configurar pesquisa
            configurarPesquisaMateriais();
            
            // Definir data atual
            const dataInput = document.getElementById('data-compra-material');
            if (dataInput) {
                const hoje = new Date();
                const ano = hoje.getFullYear();
                const mes = String(hoje.getMonth() + 1).padStart(2, '0');
                const dia = String(hoje.getDate()).padStart(2, '0');
                dataInput.value = `${ano}-${mes}-${dia}`;
            }
        }
        
        /**
         * Renderiza lista de materiais
         */
        function renderizarListaMateriais() {
            if (materiais.length === 0) {
                return '<p style="text-align: center; color: var(--cor-texto-claro);">Nenhum material cadastrado.</p>';
            }
            
            // Agrupar materiais por nome
            const grupos = {};
            materiais.forEach(m => {
                if (m.removed) return;
                const nomeNorm = normalizarNome(m.nome);
                if (!grupos[nomeNorm]) {
                    grupos[nomeNorm] = [];
                }
                grupos[nomeNorm].push(m);
            });
            
            let html = '';
            
            Object.keys(grupos).forEach(nomeNorm => {
                const grupo = grupos[nomeNorm];
                const primeiro = grupo[0];
                const precoMedio = calcularPrecoMedioPonderado(primeiro.nome);
                
                // Contar compras
                let totalCompras = 0;
                grupo.forEach(m => {
                    if (m.historicoCompras) {
                        totalCompras += m.historicoCompras.filter(c => !c.removed).length;
                    }
                });
                
                html += `
                    <div class="card" style="margin-bottom: 15px; border-left: 4px solid var(--cor-primaria);">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 10px 0;">${primeiro.nome}</h4>
                                ${primeiro.marca ? `<p style="margin: 0; color: var(--cor-texto-claro); font-size: 14px;">Marca: ${primeiro.marca}</p>` : ''}
                            </div>
                            <div style="text-align: right;">
                                <div class="badge badge-info">${primeiro.codigo || 'Sem c√≥digo'}</div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--cor-borda);">
                            <div>
                                <div style="font-size: 12px; color: var(--cor-texto-claro);">Pre√ßo M√©dio</div>
                                <div style="font-size: 18px; font-weight: 600; color: var(--cor-primaria);">
                                    ${formatarMoeda(precoMedio)}/${primeiro.unidadeMedida}
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--cor-texto-claro);">√öltima Compra</div>
                                <div style="font-size: 14px; font-weight: 600;">
                                    ${formatarMoeda(primeiro.precoUltimaCompra)}
                                </div>
                                <div style="font-size: 12px; color: var(--cor-texto-claro);">
                                    ${formatarData(primeiro.dataUltimaCompra)}
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--cor-texto-claro);">Hist√≥rico</div>
                                <div style="font-size: 14px; font-weight: 600;">
                                    ${totalCompras} compra(s)
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; display: flex; gap: 5px; flex-wrap: wrap;">
                            <button class="btn btn-primary btn-sm" onclick="verHistoricoMaterial('${primeiro.nome}')">
                                üìä Ver Hist√≥rico
                            </button>
                            <button class="btn btn-success btn-sm" onclick="adicionarCompraMaterial('${primeiro.nome}')">
                                ‚ûï Nova Compra
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="removerMaterial('${primeiro.id}')">
                                üóëÔ∏è Remover
                            </button>
                        </div>
                    </div>
                `;
            });
            
            return html;
        }
        
        /**
         * Configura tabs de materiais
         */
        function configurarTabsMateriais() {
            const tabButtons = document.querySelectorAll('#materiais-page .tab-button');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remover active de todos
                    tabButtons.forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('#materiais-page .tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Adicionar active no clicado
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    const tabContent = document.getElementById('tab-' + tabId);
                    if (tabContent) {
                        tabContent.classList.add('active');
                    }
                });
            });
        }
        
        /**
         * Configura formul√°rio de material
         */
        function configurarFormularioMaterial() {
            const form = document.getElementById('form-adicionar-material');
            if (!form) return;
            
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const dados = {
                    codigo: document.getElementById('codigo-material').value.trim(),
                    nome: document.getElementById('nome-material').value.trim(),
                    marca: document.getElementById('marca-material').value.trim(),
                    fornecedor: document.getElementById('fornecedor-material').value.trim(),
                    preco: document.getElementById('preco-material').value,
                    quantidade: document.getElementById('quantidade-material').value,
                    unidadeCompra: document.getElementById('unidade-compra-material').value,
                    unidadeMedida: document.getElementById('unidade-medida-material').value,
                    quantidadePorUnidade: document.getElementById('quantidade-por-unidade-material').value,
                    dataCompra: document.getElementById('data-compra-material').value,
                    notaFiscal: document.getElementById('nota-fiscal-material').value.trim()
                };
                
                if (adicionarMaterial(dados)) {
                    form.reset();
                    
                    // Voltar para lista
                    document.querySelector('.tab-button[data-tab="listar-materiais"]').click();
                    
                    // Recarregar lista
                    carregarPaginaMateriais();
                    carregarPaginaEstoque();
                    
                    mostrarToast('Material adicionado com sucesso!', 'success');
                }
            });
            
            // Buscar ao digitar c√≥digo
            const codigoInput = document.getElementById('codigo-material');
            if (codigoInput) {
                codigoInput.addEventListener('blur', function() {
                    const codigo = this.value.trim();
                    if (codigo) {
                        const material = buscarMaterialPorCodigo(codigo);
                        if (material) {
                            // Preencher campos
                            document.getElementById('nome-material').value = material.nome;
                            document.getElementById('marca-material').value = material.marca || '';
                            document.getElementById('unidade-compra-material').value = material.unidadeCompra || 'un';
                            document.getElementById('unidade-medida-material').value = material.unidadeMedida || 'g';
                            document.getElementById('quantidade-por-unidade-material').value = material.quantidadePorUnidade || 1000;
                            
                            mostrarToast('Material encontrado! Preencha apenas pre√ßo e quantidade.', 'info');
                        }
                    }
                });
            }
        }
        
        /**
         * Configura scanner de c√≥digo de barras
         */
        function configurarScanner() {
            const btnScanner = document.getElementById('btn-scanner');
            const btnStop = document.getElementById('btn-stop-scanner');
            const container = document.getElementById('scanner-container');
            
            if (btnScanner) {
                btnScanner.addEventListener('click', function() {
                    container.classList.remove('hidden');
                    iniciarScanner();
                });
            }
            
            if (btnStop) {
                btnStop.addEventListener('click', function() {
                    pararScanner();
                    container.classList.add('hidden');
                });
            }
        }
        
        /**
         * Inicia scanner de c√≥digo de barras
         */
        function iniciarScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                console.log('Scanner j√° est√° ativo');
                return;
            }
            
            html5QrCode = new Html5Qrcode("reader");
            
            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 }
            };
            
            html5QrCode.start(
                { facingMode: "environment" },
                config,
                (decodedText) => {
                    // C√≥digo escaneado com sucesso
                    document.getElementById('codigo-material').value = decodedText;
                    pararScanner();
                    document.getElementById('scanner-container').classList.add('hidden');
                    mostrarToast('C√≥digo escaneado: ' + decodedText, 'success');
                    
                    // Buscar material
                    const material = buscarMaterialPorCodigo(decodedText);
                    if (material) {
                        document.getElementById('nome-material').value = material.nome;
                        document.getElementById('marca-material').value = material.marca || '';
                    }
                },
                (errorMessage) => {
                    // Erro no scan (pode ignorar, √© normal)
                }
            ).catch(err => {
                console.error('Erro ao iniciar scanner:', err);
                mostrarToast('Erro ao acessar c√¢mera', 'error');
            });
        }
        
        /**
         * Para scanner
         */
        function pararScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => {
                    console.log('Scanner parado');
                }).catch(err => {
                    console.error('Erro ao parar scanner:', err);
                });
            }
        }
        
        /**
         * Configura pesquisa de materiais
         */
        function configurarPesquisaMateriais() {
            const inputPesquisa = document.getElementById('pesquisar-materiais');
            if (!inputPesquisa) return;
            
            inputPesquisa.addEventListener('input', function() {
                const termo = this.value.toLowerCase();
                const cards = document.querySelectorAll('#lista-materiais-cards .card');
                
                cards.forEach(card => {
                    const texto = card.textContent.toLowerCase();
                    card.style.display = texto.includes(termo) ? '' : 'none';
                });
            });
        }
        
        /**
         * Ver hist√≥rico de um material
         */
        function verHistoricoMaterial(nomeMaterial) {
            const materiaisGrupo = buscarMateriaisPorNome(nomeMaterial);
            if (materiaisGrupo.length === 0) {
                mostrarToast('Material n√£o encontrado', 'error');
                return;
            }
            
            // Coletar todas as compras
            let todasCompras = [];
            materiaisGrupo.forEach(material => {
                if (material.historicoCompras) {
                    material.historicoCompras.forEach(compra => {
                        todasCompras.push({
                            ...compra,
                            materialId: material.id,
                            materialNome: material.nome
                        });
                    });
                }
            });
            
            // Ordenar por data (mais recente primeiro)
            todasCompras.sort((a, b) => new Date(b.data) - new Date(a.data));
            
            const precoMedio = calcularPrecoMedioPonderado(nomeMaterial);
            
            // Criar modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3>üìä Hist√≥rico: ${nomeMaterial}</h3>
                        <button class="modal-close" onclick="this.parentElement.parentElement.parentElement.remove()">√ó</button>
                    </div>
                    
                    <div class="notification notification-info">
                        <strong>Pre√ßo M√©dio Ponderado:</strong> ${formatarMoeda(precoMedio)}
                        <br>
                        <small>Calculado com base em ${todasCompras.filter(c => !c.removed).length} compra(s)</small>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Qtd</th>
                                <th>Pre√ßo</th>
                                <th>Fornecedor</th>
                                <th>NF</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${todasCompras.map(compra => `
                                <tr style="${compra.removed ? 'opacity: 0.5; text-decoration: line-through;' : ''}">
                                    <td>${formatarData(compra.data)}</td>
                                    <td>${compra.quantidade}</td>
                                    <td>${formatarMoeda(compra.preco)}</td>
                                    <td>${compra.fornecedor || '-'}</td>
                                    <td>${compra.notaFiscal || '-'}</td>
                                    <td>
                                        ${compra.removed ? 
                                            '<span class="badge badge-danger">Removido</span>' : 
                                            '<span class="badge badge-success">Ativo</span>'
                                        }
                                    </td>
                                    <td>
                                        ${!compra.removed ? `
                                            <button class="btn btn-danger btn-sm" 
                                                onclick="removerCompraERecarregar('${compra.materialId}', '${compra.id}')">
                                                üóëÔ∏è
                                            </button>
                                        ` : ''}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">
                            ‚ùå Fechar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        /**
         * Adicionar nova compra a um material existente
         */
        function adicionarCompraMaterial(nomeMaterial) {
            // Ir para aba de adicionar e preencher nome
            document.querySelector('.tab-button[data-tab="adicionar-material"]').click();
            
            setTimeout(() => {
                document.getElementById('nome-material').value = nomeMaterial;
                document.getElementById('nome-material').focus();
                mostrarToast('Preencha os dados da nova compra', 'info');
            }, 100);
        }
        
        /**
         * Remove compra e recarrega p√°gina
         */
        function removerCompraERecarregar(materialId, compraId) {
            const motivo = prompt('Motivo da remo√ß√£o (opcional):') || 'N√£o informado';
            
            if (removerCompra(materialId, compraId, motivo)) {
                // Fechar modal
                const modal = document.querySelector('.modal-overlay:last-child');
                if (modal) modal.remove();
                
                // Recarregar p√°ginas
                carregarPaginaMateriais();
                carregarPaginaEstoque();
            }
        }
        
        console.log('‚úÖ M√≥dulo de Materiais e Estoque carregado');
        
        // ====================================
        // PARTE 5: GEST√ÉO DE VENDAS
        // ====================================
                
                
        /**
         * GERA N√öMERO DE VENDA SEQUENCIAL
         */
        function gerarNumeroVenda() {
            const ano = new Date().getFullYear();
            const vendasAno = vendas.filter(v => {
                const dataVenda = new Date(v.dataVenda);
                return dataVenda.getFullYear() === ano;
            });
            
            const proximoNumero = vendasAno.length + 1;
            return `VND-${ano}-${String(proximoNumero).padStart(3, '0')}`;
        }
        
        /**
         * REGISTRA NOVA VENDA (ATUALIZADO PARA M√öLTIPLOS PRODUTOS)
         */
        function registrarVenda(dados) {
            try {
                console.log('üìù Iniciando registro de venda...');
                
                // 1. VALIDA√á√ïES B√ÅSICAS
                if (!dados.produtos || dados.produtos.length === 0) {
                    throw new Error('Adicione pelo menos um produto √† venda');
                }
                
                if (!dados.cliente || !dados.cliente.nome) {
                    throw new Error('Informe o nome do cliente');
                }
                
                if (!dados.dataEntrega) {
                    throw new Error('Informe a data de entrega');
                }
                
                // 2. VALIDAR ESTOQUE DE TODOS OS PRODUTOS
                console.log('üîç Validando estoque...');
                const errosEstoque = [];
                
                dados.produtos.forEach(itemVenda => {
                    const validacao = validarEstoqueProduto(itemVenda.produtoId, itemVenda.quantidade);
                    if (!validacao.valido) {
                        errosEstoque.push(`${itemVenda.produtoNome}: ${validacao.mensagem}`);
                    }
                });
                
                if (errosEstoque.length > 0) {
                    throw new Error('Estoque insuficiente:\n' + errosEstoque.join('\n'));
                }
                
                // 3. CALCULAR CUSTOS E VALORES DE CADA PRODUTO
                console.log('üí∞ Calculando custos e valores...');
                const produtosProcessados = [];
                let custoTotalIngredientes = 0;
                const ingredientesConsolidados = [];
                
                dados.produtos.forEach(itemVenda => {
                    const produto = produtosFinais.find(p => p.id === itemVenda.produtoId);
                    if (!produto) {
                        throw new Error(`Produto ${itemVenda.produtoNome} n√£o encontrado`);
                    }
                    
                    const custos = calcularCustoProdutoFinal(produto);
                    const quantidade = parseFloat(itemVenda.quantidade);
                    
                    // Calcular valores baseado no tipo de precifica√ß√£o
                    let precoUnitario = 0;
                    let subtotal = 0;
                    let custoTotalProduto = 0;
                    let unidade = '';
                    
                    if (produto.tipoPrecificacao === 'peso') {
                        // Por peso (kg)
                        precoUnitario = itemVenda.precoCustomizado || produto.precoVendaKg;
                        subtotal = precoUnitario * quantidade;
                        custoTotalProduto = custos.custoPorKg * quantidade;
                        unidade = 'kg';
                    } else {
                        // Por unidade
                        precoUnitario = itemVenda.precoCustomizado || produto.precoVendaUnidade;
                        subtotal = precoUnitario * quantidade;
                        custoTotalProduto = custos.custoPorUnidade * quantidade;
                        unidade = 'un';
                    }
                    
                    const lucro = subtotal - custoTotalProduto;
                    const margemLucro = subtotal > 0 ? (lucro / subtotal) * 100 : 0;
                    
                    // Consolidar ingredientes deste produto
                    const ingredientesProduto = custos.ingredientesConsolidados.map(ing => ({
                        ...ing,
                        quantidade: ing.quantidade * quantidade
                    }));
                    
                    // Adicionar ao consolidado geral
                    ingredientesProduto.forEach(ing => {
                        const existente = ingredientesConsolidados.find(i => i.materialId === ing.materialId);
                        if (existente) {
                            existente.quantidade += ing.quantidade;
                        } else {
                            ingredientesConsolidados.push({...ing});
                        }
                    });
                    
                    custoTotalIngredientes += custoTotalProduto;
                    
                    produtosProcessados.push({
                        produtoId: produto.id,
                        produtoNome: produto.nome,
                        tipoPrecificacao: produto.tipoPrecificacao,
                        quantidade: quantidade,
                        unidade: unidade,
                        pesoBase: produto.pesoBase || null,
                        precoUnitario: precoUnitario,
                        precoCustomizado: itemVenda.precoCustomizado ? true : false,
                        subtotal: subtotal,
                        custoTotal: custoTotalProduto,
                        lucro: lucro,
                        margemLucro: margemLucro,
                        ingredientesSnapshot: ingredientesProduto
                    });
                });
                
                // 4. CALCULAR CUSTOS ADICIONAIS
                const frete = parseFloat(dados.frete) || 0;
                const decoracao = parseFloat(dados.decoracao) || 0;
                const brindes = parseFloat(dados.brindes) || 0;
                
                const custoDiretoExtra = frete + decoracao + brindes;
                const custoDiretoTotal = custoTotalIngredientes + custoDiretoExtra;
                
                // 5. CALCULAR CUSTOS INDIRETOS (10% sobre custo direto)
                const custoIndireto = custoDiretoTotal * 0.10;
                const custoTotal = custoDiretoTotal + custoIndireto;
                
                // 6. CALCULAR VALORES E LUCRO
                const valorProdutos = produtosProcessados.reduce((sum, p) => sum + p.subtotal, 0);
                const valorClientePaga = valorProdutos + frete + decoracao;
                const valorTotal = valorClientePaga;
                
                const lucroBruto = valorTotal - custoTotal;
                const margemLucroBruto = valorTotal > 0 ? (lucroBruto / valorTotal) * 100 : 0;
                
                // 7. DESTINA√á√ÉO DO LUCRO (50% reinvestimento, 50% l√≠quido)
                const valorReinvestimento = lucroBruto * 0.50;
                const lucroLiquido = lucroBruto * 0.50;
                const margemLiquida = valorTotal > 0 ? (lucroLiquido / valorTotal) * 100 : 0;
                
                // 8. GERAR N√öMERO DA VENDA
                const agora = new Date().toISOString();
                const ano = new Date().getFullYear();
                const vendasDoAno = vendas.filter(v => {
                    const anoVenda = new Date(v.criadaEm).getFullYear();
                    return anoVenda === ano;
                });
                const numeroSequencial = vendasDoAno.length + 1;
                const numeroVenda = `V-${ano}-${String(numeroSequencial).padStart(4, '0')}`;
                
                // 9. CRIAR OBJETO DA VENDA
                const novaVenda = {
                    id: gerarId(),
                    numero: numeroVenda,
                    
                    // PRODUTOS (array de produtos vendidos)
                    produtos: produtosProcessados,
                    
                    // COMPATIBILIDADE (mant√©m para vendas antigas)
                    receitaId: produtosProcessados[0].produtoId,
                    receitaNome: produtosProcessados[0].produtoNome,
                    quantidade: produtosProcessados.reduce((sum, p) => sum + p.quantidade, 0),
                    
                    // SNAPSHOT CONSOLIDADO de TODOS os ingredientes
                    ingredientesSnapshot: ingredientesConsolidados,
                    
                    // CUSTOS
                    custoDireto: {
                        ingredientes: custoTotalIngredientes,
                        frete: frete,
                        decoracao: decoracao,
                        brindes: brindes,
                        total: custoDiretoTotal
                    },
                    
                    custoIndireto: {
                        percentual: 0.10,
                        valor: custoIndireto,
                        descricao: 'Custos indiretos'
                    },
                    
                    custoTotal: custoTotal,
                    
                    // RECEITA
                    valorProdutos: valorProdutos,
                    valorClientePaga: valorClientePaga,
                    precoUnitario: valorProdutos / produtosProcessados.reduce((sum, p) => sum + p.quantidade, 0),
                    valorTotal: valorTotal,
                    
                    // LUCRO
                    lucroBruto: lucroBruto,
                    margemLucroBruto: margemLucroBruto,
                    
                    destinacaoLucro: {
                        percentualReinvestimento: 0.50,
                        valorReinvestimento: valorReinvestimento,
                        lucroLiquido: lucroLiquido,
                        margemLiquida: margemLiquida
                    },
                    
                    // CLIENTE
                    cliente: {
                        nome: dados.cliente.nome || '',
                        telefone: dados.cliente.telefone || '',
                        endereco: dados.cliente.endereco || '',
                        email: dados.cliente.email || '',
                        cpf: dados.cliente.cpf || ''
                    },
                    
                    // ENTREGA
                    dataVenda: agora,
                    dataEntrega: dados.dataEntrega ? dataInputParaISO(dados.dataEntrega) : agora,
                    horaEntrega: dados.horaEntrega || '',
                    statusEntrega: 'pendente',
                    
                    // PAGAMENTO
                    pagamento: {
                        formaPagamento: dados.formaPagamento || 'Dinheiro',
                        statusPagamento: dados.statusPagamento || 'pendente',
                        valorPago: dados.statusPagamento === 'pago' ? valorTotal : 0,
                        dataPagamento: dados.statusPagamento === 'pago' ? agora : null
                    },
                    
                    observacoes: dados.observacoes || '',
                    observacoesInternas: dados.observacoesInternas || '',
                    
                    // CONTROLE
                    ativa: true,
                    cancelada: false,
                    criadaEm: agora,
                    criadaPor: getUsuarioAtual(),
                    historicoEdicoes: []
                };

                // 9.1. GERENCIAR CLIENTE (CRIAR OU ATUALIZAR)
                let clienteVendaId = null;
                
                if (clienteAtualVenda) {
                    // Cliente existente - atualizar estat√≠sticas
                    clienteVendaId = clienteAtualVenda.id;
                    atualizarEstatisticasCliente(clienteVendaId, valorTotal);
                    
                } else {
                    // Cliente novo - criar automaticamente
                    const novoClienteId = gerarId();
                    
                    const novoCliente = {
                        id: novoClienteId,
                        nome: dados.cliente.nome,
                        telefone: dados.cliente.telefone,
                        email: dados.cliente.email || '',
                        cpf: dados.cliente.cpf || '',
                        endereco: dados.cliente.endereco || '',
                        dataNascimento: null,
                        observacoes: '',
                        tags: [],
                        
                        // Estat√≠sticas iniciais
                        nivel: 'bronze',
                        totalGasto: valorTotal,
                        totalPedidos: 1,
                        ticketMedio: valorTotal,
                        ultimoPedido: agora,
                        
                        // Controle
                        ativo: true,
                        criadoEm: agora,
                        atualizadoEm: agora
                    };
                    
                    clientes.push(novoCliente);
                    clienteVendaId = novoClienteId;
                    
                    console.log('‚úÖ Novo cliente cadastrado:', novoCliente.nome);
                }
                
                // Adicionar ID do cliente na venda
                novaVenda.clienteId = clienteVendaId;

                // 9.2. GERENCIAR REVENDEDOR (SE HOUVER)
                if (revendedorAtualVenda) {
                    novaVenda.revendedorId = revendedorAtualVenda.id;
                    novaVenda.revendedorNome = revendedorAtualVenda.nome;
                    novaVenda.revendedorComissaoPercent = revendedorAtualVenda.percentualComissao;
                    novaVenda.revendedorComissaoValor = valorTotal * (revendedorAtualVenda.percentualComissao / 100);
                    
                    // Atualizar estat√≠sticas do revendedor
                    atualizarEstatisticasRevendedor(revendedorAtualVenda.id, valorTotal);
                    
                    console.log(`‚úÖ Venda vinculada ao revendedor: ${revendedorAtualVenda.nome}`);
                    console.log(`üí∞ Comiss√£o gerada: ${formatarMoeda(novaVenda.revendedorComissaoValor)}`);
                }
                
                // 10. ADICIONAR VENDA
                vendas.push(novaVenda);
                
                // 11. RECALCULAR ESTOQUE (ir√° subtrair automaticamente)
                estoque = calcularEstoqueCompleto();
                
                // 12. SALVAR
                salvarLocalStorage();
                sincronizarComNuvem();
                
                console.log('‚úÖ Venda registrada:', novaVenda.numero);
                
                return novaVenda;
                
            } catch (erro) {
                console.error('Erro ao registrar venda:', erro);
                throw erro;
            }
        }
        
        /**
         * EDITA VENDA EXISTENTE
         */
        function editarVenda(vendaId, novosDados) {
            try {
                const venda = vendas.find(v => v.id === vendaId);
                if (!venda) throw new Error('Venda n√£o encontrada');
                
                if (venda.cancelada) {
                    throw new Error('N√£o √© poss√≠vel editar uma venda cancelada');
                }
                
                // 1. DEVOLVER ESTOQUE DA VENDA ORIGINAL
                // (O estoque ser√° recalculado automaticamente, ent√£o n√£o precisa fazer nada aqui)
                
                // 2. REGISTRAR NO HIST√ìRICO
                venda.historicoEdicoes.push({
                    data: new Date().toISOString(),
                    usuario: getUsuarioAtual(),
                    alteracoes: 'Venda editada',
                    dadosAnteriores: {
                        quantidade: venda.quantidade,
                        precoUnitario: venda.precoUnitario,
                        valorTotal: venda.valorTotal,
                        dataEntrega: venda.dataEntrega,
                        cliente: { ...venda.cliente }
                    }
                });
                
                // 3. ATUALIZAR DADOS PERMITIDOS
                if (novosDados.cliente) {
                    venda.cliente = {
                        ...venda.cliente,
                        ...novosDados.cliente
                    };
                }
                
                if (novosDados.dataEntrega) {
                    venda.dataEntrega = novosDados.dataEntrega;
                }
                
                if (novosDados.horaEntrega) {
                    venda.horaEntrega = novosDados.horaEntrega;
                }
                
                if (novosDados.observacoes !== undefined) {
                    venda.observacoes = novosDados.observacoes;
                }
                
                if (novosDados.observacoesInternas !== undefined) {
                    venda.observacoesInternas = novosDados.observacoesInternas;
                }
                
                if (novosDados.statusEntrega) {
                    venda.statusEntrega = novosDados.statusEntrega;
                    
                    if (novosDados.statusEntrega === 'entregue') {
                        venda.dataEntregaRealizada = new Date().toISOString();
                    }
                }
                
                if (novosDados.statusPagamento) {
                    venda.pagamento.statusPagamento = novosDados.statusPagamento;
                    
                    if (novosDados.statusPagamento === 'pago' && !venda.pagamento.dataPagamento) {
                        venda.pagamento.dataPagamento = new Date().toISOString();
                        venda.pagamento.valorPago = venda.valorTotal;
                    }
                }
                
                venda.atualizadaEm = new Date().toISOString();
                venda.atualizadaPor = getUsuarioAtual();
                
                // 4. RECALCULAR ESTOQUE
                estoque = calcularEstoqueCompleto();
                
                // 5. SALVAR
                salvarLocalStorage();
                sincronizarComNuvem();
                
                console.log('‚úÖ Venda editada:', venda.numero);
                
                return true;
                
            } catch (erro) {
                console.error('Erro ao editar venda:', erro);
                throw erro;
            }
        }
        
        /**
         * CANCELA VENDA (devolve estoque)
         */
        function cancelarVenda(vendaId, motivo) {
            try {
                const venda = vendas.find(v => v.id === vendaId);
                if (!venda) throw new Error('Venda n√£o encontrada');
                
                if (venda.cancelada) {
                    throw new Error('Esta venda j√° foi cancelada');
                }
                
                const confirma = confirm(
                    `Cancelar venda ${venda.numero}?\n\n` +
                    `Cliente: ${venda.cliente.nome}\n` +
                    `Produto: ${venda.quantidade}x ${venda.receitaNome}\n` +
                    `Valor: ${formatarMoeda(venda.valorTotal)}\n\n` +
                    `Os ingredientes ser√£o devolvidos ao estoque.\n` +
                    `Esta a√ß√£o N√ÉO pode ser desfeita.`
                );
                
                if (!confirma) return false;
                
                // Marcar como cancelada
                venda.cancelada = true;
                venda.canceladaEm = new Date().toISOString();
                venda.canceladaPor = getUsuarioAtual();
                venda.motivoCancelamento = motivo || 'N√£o informado';
                
                // Recalcular estoque (ir√° devolver automaticamente)
                estoque = calcularEstoqueCompleto();
                
                // Salvar
                salvarLocalStorage();
                sincronizarComNuvem();
                
                mostrarToast('Venda cancelada e estoque devolvido!', 'success');
                
                console.log('‚úÖ Venda cancelada:', venda.numero);
                
                return true;
                
            } catch (erro) {
                console.error('Erro ao cancelar venda:', erro);
                mostrarToast(erro.message, 'error');
                return false;
            }
        }
        
        /**
         * MARCA VENDA COMO ENTREGUE
         */
        function marcarComoEntregue(vendaId) {
            try {
                return editarVenda(vendaId, { statusEntrega: 'entregue' });
            } catch (erro) {
                mostrarToast(erro.message, 'error');
                return false;
            }
        }
        
        /**
         * CONFIRMA PAGAMENTO
         */
        function confirmarPagamento(vendaId) {
            try {
                return editarVenda(vendaId, { statusPagamento: 'pago' });
            } catch (erro) {
                mostrarToast(erro.message, 'error');
                return false;
            }
        }
        
        // ====================================
        // INTERFACE - P√ÅGINA DE VENDAS
        // ====================================
        
        function carregarPaginaVendas() {
            const page = document.getElementById('vendas-page');
            if (!page) return;

            // Limpar arrays tempor√°rios ao carregar p√°gina
            produtosVendaTemp = [];
            let clienteAtualVenda = null; // üÜï Cliente selecionado na venda
            
            page.innerHTML = `
                <h2>üí∞ Gest√£o de Vendas</h2>
                
                <div class="tab-buttons">
                    <button class="tab-button active" data-tab="listar-vendas">üìã Hist√≥rico</button>
                    <button class="tab-button" data-tab="nova-venda">‚ûï Nova Venda</button>
                    <button class="tab-button" data-tab="resumo-vendas">üìä Resumo</button>
                </div>
                
                <!-- TAB: Listar Vendas -->
                <div class="tab-content active" id="tab-listar-vendas">
                    <div class="card">
                        <h3>Hist√≥rico de Vendas</h3>
                        
                        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                            <input type="text" id="pesquisar-vendas" class="form-control" 
                                placeholder="üîç Pesquisar..." style="flex: 1; min-width: 200px;">
                            
                            <select id="filtro-status-venda" class="form-control" style="flex: 0.5; min-width: 150px;">
                                <option value="">Todos os status</option>
                                <option value="pendente">Pendente</option>
                                <option value="entregue">Entregue</option>
                                <option value="cancelada">Cancelada</option>
                            </select>
                            
                            <select id="filtro-produto-venda" class="form-control" style="flex: 0.5; min-width: 150px;">
                                <option value="">Todos os produtos</option>
                                ${produtosFinais.filter(p => p.ativa).map(p => `
                                    <option value="${p.id}">${p.nome}</option>
                                `).join('')}
                            </select>
                            
                            <button class="btn btn-secondary" onclick="aplicarFiltrosVendas()">
                                üîÑ Filtrar
                            </button>
                        </div>
                        
                        <div id="lista-vendas">
                            ${renderizarListaVendas()}
                        </div>
                    </div>
                </div>
                
                <!-- TAB: Nova Venda -->
                <div class="tab-content" id="tab-nova-venda">
                    <div class="card">
                        <h3>‚ûï Registrar Nova Venda</h3>
                        
                        <form id="form-nova-venda">
    
                            <h4 style="margin-top: 30px; margin-bottom: 15px; color: var(--cor-primaria);">
                                üéÇ Produtos
                            </h4>
                            
                            <!-- Selecionar Produto -->
                            <div style="background: var(--cor-fundo); padding: 15px; border-radius: var(--borda-radius); margin-bottom: 15px;">
                                <div class="form-row">
                                    <div class="form-col" style="flex: 2;">
                                        <label for="venda-produto-select">Produto: *</label>
                                        <select id="venda-produto-select" class="form-control" onchange="carregarDadosProdutoVenda()">
                                            <option value="">Selecione o produto...</option>
                                            ${produtosFinais
                                                .filter(p => p.ativa)
                                                .sort((a, b) => a.nome.localeCompare(b.nome))
                                                .map(p => {
                                                    const custos = calcularCustoProdutoFinal(p);
                                                    const preco = p.tipoPrecificacao === 'peso' ? 
                                                        `${formatarMoeda(p.precoVendaKg)}/kg` : 
                                                        `${formatarMoeda(p.precoVendaUnidade)}/un`;
                                                    return `<option value="${p.id}">${p.nome} - ${preco}</option>`;
                                                }).join('')
                                            }
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Campos din√¢micos baseado no tipo -->
                                <div id="campos-quantidade-produto" style="display: none; margin-top: 15px;">
                                    <div class="form-row">
                                        <div class="form-col">
                                            <label id="label-quantidade-produto">Quantidade:</label>
                                            <input type="number" id="venda-produto-quantidade" class="form-control" 
                                                min="0.01" step="0.01" placeholder="0" oninput="atualizarResumoVendaRapido()">
                                        </div>
                                        <div class="form-col">
                                            <label for="venda-preco-customizado">Pre√ßo Personalizado (opcional):</label>
                                            <input type="number" id="venda-preco-customizado" class="form-control" 
                                                min="0.01" step="0.01" placeholder="Deixe vazio para usar pre√ßo padr√£o" 
                                                oninput="atualizarResumoVendaRapido()">
                                        </div>
                                    </div>
                                    
                                    <!-- Resumo r√°pido -->
                                    <div id="resumo-venda-rapido" style="background: var(--cor-info-claro); padding: 10px; 
                                        border-radius: var(--borda-radius); margin-top: 10px; display: none;">
                                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 13px;">
                                            <div>
                                                <strong>Custo:</strong>
                                                <div id="resumo-rapido-custo" style="font-weight: bold;">R$ 0,00</div>
                                            </div>
                                            <div>
                                                <strong>Pre√ßo:</strong>
                                                <div id="resumo-rapido-preco" style="font-weight: bold; color: var(--cor-primaria);">R$ 0,00</div>
                                            </div>
                                            <div>
                                                <strong>Lucro:</strong>
                                                <div id="resumo-rapido-lucro" style="font-weight: bold; color: var(--cor-sucesso);">R$ 0,00</div>
                                            </div>
                                            <div>
                                                <strong>Margem:</strong>
                                                <div id="resumo-rapido-margem" style="font-weight: bold; font-size: 16px;">0%</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Alerta de estoque -->
                                    <div id="alerta-estoque-venda" style="display: none; background: var(--cor-erro-claro); 
                                        padding: 10px; border-radius: var(--borda-radius); margin-top: 10px; border-left: 4px solid var(--cor-erro);">
                                        <strong>‚ö†Ô∏è Estoque insuficiente!</strong>
                                        <div id="alerta-estoque-detalhes"></div>
                                    </div>
                                    
                                    <button type="button" class="btn btn-success" onclick="adicionarProdutoVenda()" 
                                        style="width: 100%; margin-top: 10px;">
                                        ‚ûï Adicionar Produto ao Pedido
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Lista de produtos adicionados -->
                            <div id="lista-produtos-venda" style="display: none; margin-bottom: 20px;">
                                <h5 style="margin-bottom: 10px;">Produtos no Pedido:</h5>
                                <table style="width: 100%; margin-bottom: 10px;">
                                    <thead>
                                        <tr>
                                            <th>Produto</th>
                                            <th>Quantidade</th>
                                            <th>Pre√ßo Unit.</th>
                                            <th>Subtotal</th>
                                            <th>Lucro</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody-produtos-venda">
                                        <!-- produtos adicionados -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Resumo do pedido -->
                            <div id="resumo-financeiro-venda" style="display: none; background: var(--cor-secundaria-clara); 
                                padding: 15px; border-radius: var(--borda-radius); margin-bottom: 20px;">
                                <h5 style="margin: 0 0 10px 0;">üí∞ Resumo Financeiro do Pedido</h5>
                                <table style="width: 100%;">
                                    <tr>
                                        <td><strong>Total de Itens:</strong></td>
                                        <td id="resumo-total-itens" style="text-align: right;">0</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Custo Total:</strong></td>
                                        <td id="resumo-custo-total-pedido" style="text-align: right;">R$ 0,00</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Valor Total:</strong></td>
                                        <td id="resumo-valor-total-pedido" style="text-align: right; font-weight: bold; font-size: 18px; color: var(--cor-primaria);">R$ 0,00</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Lucro Total:</strong></td>
                                        <td id="resumo-lucro-total-pedido" style="text-align: right; font-weight: bold; color: var(--cor-sucesso);">R$ 0,00</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Margem M√©dia:</strong></td>
                                        <td id="resumo-margem-pedido" style="text-align: right; font-weight: bold; font-size: 16px;">0%</td>
                                    </tr>
                                </table>
                            </div>
                            
                            <h4 style="margin-top: 25px; margin-bottom: 15px; color: var(--cor-primaria);">
                                üë§ Cliente
                            </h4>
                            
                            <!-- üÜï Sistema de Busca de Cliente -->
                            <div class="form-group">
                                <label for="venda-cliente-telefone">Telefone do Cliente: *</label>
                                <input type="tel" id="venda-cliente-telefone" class="form-control" 
                                    placeholder="(00) 00000-0000" required>
                                <small style="color: var(--cor-texto-claro);">
                                    üí° Digite o telefone para buscar o cliente automaticamente
                                </small>
                            </div>
                            
                            <!-- üÜï Informa√ß√µes do Cliente Encontrado -->
                            <div id="info-cliente-encontrado" style="display: none; background: var(--cor-sucesso-claro); 
                                padding: 15px; border-radius: var(--borda-radius); margin-bottom: 15px; 
                                border-left: 4px solid var(--cor-sucesso);">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <h4 style="margin: 0 0 10px 0; display: flex; align-items: center; gap: 10px;">
                                            <span id="cliente-nivel-icone"></span>
                                            <span id="cliente-nome-encontrado"></span>
                                        </h4>
                                        <div id="cliente-estatisticas" style="font-size: 14px;"></div>
                                    </div>
                                    <div id="cliente-desconto-badge" style="background: var(--cor-sucesso); color: white; 
                                        padding: 10px 15px; border-radius: var(--borda-radius); text-align: center; min-width: 100px;">
                                        <div style="font-size: 24px; font-weight: bold;" id="cliente-desconto-valor">0%</div>
                                        <div style="font-size: 12px;">DESCONTO</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- üÜï Alerta Cliente Novo -->
                            <div id="alerta-cliente-novo" style="display: none; background: var(--cor-info-claro); 
                                padding: 15px; border-radius: var(--borda-radius); margin-bottom: 15px; 
                                border-left: 4px solid var(--cor-info);">
                                <strong>üÜï Cliente Novo!</strong>
                                <p style="margin: 5px 0 0 0;">Este cliente ser√° cadastrado automaticamente ap√≥s a venda.</p>
                            </div>
                            
                            <div class="form-group">
                                <label for="venda-cliente-nome">Nome Completo: *</label>
                                <input type="text" id="venda-cliente-nome" class="form-control" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="venda-cliente-email">Email:</label>
                                        <input type="email" id="venda-cliente-email" class="form-control">
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="venda-cliente-cpf">CPF:</label>
                                        <input type="text" id="venda-cliente-cpf" class="form-control" 
                                            placeholder="000.000.000-00">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="venda-cliente-endereco">Endere√ßo de Entrega:</label>
                                <input type="text" id="venda-cliente-endereco" class="form-control">
                            </div>
                            
                            <!-- üÜï SE√á√ÉO DE REVENDEDOR -->
                            <h4 style="margin-top: 25px; margin-bottom: 15px; color: var(--cor-primaria);">
                                ü§ù Revendedor (Opcional)
                            </h4>
                            
                            <div class="form-group">
                                <label for="venda-revendedor">Esta venda √© de algum revendedor?</label>
                                <select id="venda-revendedor" class="form-control">
                                    <option value="">N√£o, √© venda direta</option>
                                    ${revendedores.filter(r => r.ativo).map(r => `
                                        <option value="${r.id}">
                                            ${r.nome} - ${r.percentualComissao}% comiss√£o
                                        </option>
                                    `).join('')}
                                </select>
                                <small style="color: var(--cor-texto-claro);">
                                    üí° Se esta venda for de um revendedor, selecione-o aqui para calcular a comiss√£o automaticamente
                                </small>
                            </div>
                            
                            <!-- üÜï Informa√ß√µes do Revendedor Selecionado -->
                            <div id="info-revendedor-selecionado" style="display: none; background: var(--cor-sucesso-claro); 
                                padding: 15px; border-radius: var(--borda-radius); margin-bottom: 15px; 
                                border-left: 4px solid var(--cor-sucesso);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h4 style="margin: 0 0 5px 0;" id="revendedor-nome-selecionado"></h4>
                                        <div style="font-size: 14px;" id="revendedor-stats"></div>
                                    </div>
                                    <div style="text-align: center; background: var(--cor-sucesso); color: white; 
                                        padding: 10px 15px; border-radius: var(--borda-radius); min-width: 100px;">
                                        <div style="font-size: 24px; font-weight: bold;" id="revendedor-comissao-percent">0%</div>
                                        <div style="font-size: 12px;">COMISS√ÉO</div>
                                    </div>
                                </div>
                                <div id="revendedor-comissao-preview" style="margin-top: 10px; padding-top: 10px; 
                                    border-top: 1px solid var(--cor-sucesso); font-size: 14px; font-weight: 600;">
                                    üí∞ Comiss√£o estimada desta venda: <span id="valor-comissao-preview">R$ 0,00</span>
                                </div>
                            </div>
                            
                            <h4 style="margin-top: 25px; margin-bottom: 15px; color: var(--cor-primaria);">
                                üìÖ Entrega e Pagamento
                            </h4>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="venda-data-entrega">Data de Entrega: *</label>
                                        <input type="date" id="venda-data-entrega" class="form-control" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="venda-hora-entrega">Hor√°rio:</label>
                                        <input type="time" id="venda-hora-entrega" class="form-control">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="venda-forma-pagamento">Forma de Pagamento:</label>
                                        <select id="venda-forma-pagamento" class="form-control">
                                            <option value="Dinheiro">Dinheiro</option>
                                            <option value="PIX">PIX</option>
                                            <option value="Cart√£o D√©bito">Cart√£o de D√©bito</option>
                                            <option value="Cart√£o Cr√©dito">Cart√£o de Cr√©dito</option>
                                            <option value="Transfer√™ncia">Transfer√™ncia Banc√°ria</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="venda-status-pagamento">Status do Pagamento:</label>
                                        <select id="venda-status-pagamento" class="form-control">
                                            <option value="pendente">Pendente</option>
                                            <option value="pago">Pago</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <h4 style="margin-top: 25px; margin-bottom: 15px; color: var(--cor-primaria);">
                                üíµ Valores Adicionais
                            </h4>
                            
                            <div class="notification notification-info" style="margin-bottom: 15px;">
                                ‚ÑπÔ∏è <strong>Importante:</strong> Frete e Decora√ß√£o s√£o cobrados do cliente. 
                                Brindes s√£o descontados do lucro (n√£o cobrados do cliente).
                            </div>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="venda-frete">Frete (cobrado do cliente):</label>
                                        <input type="number" id="venda-frete" class="form-control" 
                                            min="0" step="0.01" value="0">
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="venda-decoracao">Decora√ß√£o (cobrada do cliente):</label>
                                        <input type="number" id="venda-decoracao" class="form-control" 
                                            min="0" step="0.01" value="0">
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="venda-brindes">Brindes (descontado do lucro):</label>
                                        <input type="number" id="venda-brindes" class="form-control" 
                                            min="0" step="0.01" value="0">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="venda-observacoes">Observa√ß√µes do Cliente:</label>
                                <textarea id="venda-observacoes" class="form-control" rows="2" 
                                    placeholder="Ex: Embalagem rosa com la√ßo"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="venda-observacoes-internas">Observa√ß√µes Internas:</label>
                                <textarea id="venda-observacoes-internas" class="form-control" rows="2" 
                                    placeholder="Ex: Cliente √© al√©rgica a nozes"></textarea>
                            </div>
                            
                            <!-- Resumo Financeiro da Venda -->
                            <div id="resumo-financeiro-venda" style="display: none; background: var(--cor-info-claro); 
                                padding: 20px; border-radius: var(--borda-radius); margin-top: 25px;">
                                <h4 style="margin: 0 0 15px 0;">üí∞ Resumo Financeiro</h4>
                                <table style="width: 100%; font-size: 15px;">
                                    <tr>
                                        <td>Valor das Receitas:</td>
                                        <td id="resumo-valor-receitas" style="text-align: right;">R$ 0,00</td>
                                    </tr>
                                    <tr>
                                        <td>Frete:</td>
                                        <td id="resumo-frete-venda" style="text-align: right;">R$ 0,00</td>
                                    </tr>
                                    <tr>
                                        <td>Decora√ß√£o:</td>
                                        <td id="resumo-decoracao-venda" style="text-align: right;">R$ 0,00</td>
                                    </tr>
                                    <tr style="border-top: 2px solid var(--cor-borda); font-weight: bold;">
                                        <td><strong>VALOR QUE CLIENTE PAGA:</strong></td>
                                        <td id="resumo-valor-cliente-paga" style="text-align: right; font-size: 20px; color: var(--cor-primaria);">
                                            R$ 0,00
                                        </td>
                                    </tr>
                                    <tr style="border-top: 1px solid var(--cor-borda);">
                                        <td>Custo Total (inclui brindes):</td>
                                        <td id="resumo-custo-total-venda" style="text-align: right;">R$ 0,00</td>
                                    </tr>
                                    <tr>
                                        <td>Lucro Bruto:</td>
                                        <td id="resumo-lucro-bruto-venda" style="text-align: right; color: var(--cor-sucesso);">
                                            R$ 0,00
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Lucro L√≠quido (50%):</td>
                                        <td id="resumo-lucro-liquido-venda" style="text-align: right; font-weight: bold; color: var(--cor-sucesso);">
                                            R$ 0,00
                                        </td>
                                    </tr>
                                    <tr style="border-top: 2px solid var(--cor-borda);">
                                        <td><strong>Margem L√≠quida:</strong></td>
                                        <td id="resumo-margem-venda" style="text-align: right; font-size: 18px; font-weight: bold;">
                                            0%
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            
                            <div style="margin-top: 25px; display: flex; gap: 10px;">
                                <button type="submit" class="btn btn-primary">üíæ Registrar Venda</button>
                                <button type="button" class="btn btn-secondary" onclick="document.getElementById('form-nova-venda').reset()">
                                    üîÑ Limpar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- TAB: Resumo -->
                <div class="tab-content" id="tab-resumo-vendas">
                    <div class="card">
                        <h3>üìä Resumo de Vendas</h3>
                        ${renderizarResumoVendas()}
                    </div>
                </div>
            `;
            
            // Configurar tabs
            configurarTabsVendas();
            
            // Configurar formul√°rio
            configurarFormularioVenda();
            
            // Configurar pesquisa e filtros
            configurarPesquisaVendas();
            
            // Definir data atual
            const dataInput = document.getElementById('venda-data-entrega');
            if (dataInput) {
                const hoje = new Date();
                const ano = hoje.getFullYear();
                const mes = String(hoje.getMonth() + 1).padStart(2, '0');
                const dia = String(hoje.getDate()).padStart(2, '0');
                dataInput.value = `${ano}-${mes}-${dia}`;
            }
        }

        /**
         * CARREGA DADOS DO PRODUTO SELECIONADO NA VENDA
         */
        function carregarDadosProdutoVenda() {
            const select = document.getElementById('venda-produto-select');
            const produtoId = select.value;
            const camposDiv = document.getElementById('campos-quantidade-produto');
            const labelQuantidade = document.getElementById('label-quantidade-produto');
            const inputQuantidade = document.getElementById('venda-produto-quantidade');
            const inputPreco = document.getElementById('venda-preco-customizado');
            const resumoDiv = document.getElementById('resumo-venda-rapido');
            const alertaDiv = document.getElementById('alerta-estoque-venda');
            
            if (!produtoId) {
                camposDiv.style.display = 'none';
                resumoDiv.style.display = 'none';
                alertaDiv.style.display = 'none';
                return;
            }
            
            const produto = produtosFinais.find(p => p.id === produtoId);
            if (!produto) return;
            
            // Configurar campos baseado no tipo de precifica√ß√£o
            if (produto.tipoPrecificacao === 'peso') {
                labelQuantidade.textContent = 'Peso (kg): *';
                inputQuantidade.placeholder = 'Ex: 1.5';
                inputQuantidade.step = '0.01';
                inputPreco.placeholder = `Pre√ßo padr√£o: ${formatarMoeda(produto.precoVendaKg)}/kg`;
            } else {
                labelQuantidade.textContent = 'Quantidade (unidades): *';
                inputQuantidade.placeholder = 'Ex: 50';
                inputQuantidade.step = '1';
                inputPreco.placeholder = `Pre√ßo padr√£o: ${formatarMoeda(produto.precoVendaUnidade)}/un`;
            }
            
            // Limpar campos
            inputQuantidade.value = '';
            inputPreco.value = '';
            
            // Mostrar campos
            camposDiv.style.display = 'block';
            resumoDiv.style.display = 'none';
            alertaDiv.style.display = 'none';
        }
        
        /**
         * ATUALIZA RESUMO R√ÅPIDO DA VENDA
         */
        function atualizarResumoVendaRapido() {
            const produtoId = document.getElementById('venda-produto-select').value;
            const quantidade = parseFloat(document.getElementById('venda-produto-quantidade').value);
            const precoCustomizado = parseFloat(document.getElementById('venda-preco-customizado').value);
            
            const resumoDiv = document.getElementById('resumo-venda-rapido');
            const alertaDiv = document.getElementById('alerta-estoque-venda');
            const alertaDetalhes = document.getElementById('alerta-estoque-detalhes');
            
            if (!produtoId || !quantidade || quantidade <= 0) {
                resumoDiv.style.display = 'none';
                alertaDiv.style.display = 'none';
                return;
            }
            
            const produto = produtosFinais.find(p => p.id === produtoId);
            if (!produto) return;
            
            // Calcular valores
            const custos = calcularCustoProdutoFinal(produto);
            
            let precoUnitario = 0;
            let custoUnitario = 0;
            
            if (produto.tipoPrecificacao === 'peso') {
                precoUnitario = precoCustomizado || produto.precoVendaKg;
                custoUnitario = custos.custoPorKg;
            } else {
                precoUnitario = precoCustomizado || produto.precoVendaUnidade;
                custoUnitario = custos.custoPorUnidade;
            }
            
            const custoTotal = custoUnitario * quantidade;
            const precoTotal = precoUnitario * quantidade;
            const lucro = precoTotal - custoTotal;
            const margem = precoTotal > 0 ? (lucro / precoTotal) * 100 : 0;
            
            // Atualizar resumo
            document.getElementById('resumo-rapido-custo').textContent = formatarMoeda(custoTotal);
            document.getElementById('resumo-rapido-preco').textContent = formatarMoeda(precoTotal);
            document.getElementById('resumo-rapido-lucro').textContent = formatarMoeda(lucro);
            document.getElementById('resumo-rapido-margem').textContent = margem.toFixed(1) + '%';
            
            const corMargem = margem >= 20 ? 'var(--cor-sucesso)' : 
                             margem >= 10 ? 'var(--cor-aviso)' : 'var(--cor-erro)';
            document.getElementById('resumo-rapido-margem').style.color = corMargem;
            
            resumoDiv.style.display = 'block';
            
            // Validar estoque
            const validacao = validarEstoqueProduto(produtoId, quantidade);
            
            if (!validacao.valido && validacao.faltantes.length > 0) {
                let html = '<ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">';
                validacao.faltantes.forEach(f => {
                    html += `<li>${f.materialNome}: dispon√≠vel ${f.disponivel.toFixed(2)} ${f.unidade}, necess√°rio ${f.necessario.toFixed(2)} ${f.unidade}</li>`;
                });
                html += '</ul>';
                
                alertaDetalhes.innerHTML = html;
                alertaDiv.style.display = 'block';
            } else {
                alertaDiv.style.display = 'none';
            }
        }
        
        /**
         * ADICIONA PRODUTO √Ä VENDA TEMPOR√ÅRIA
         */
        function adicionarProdutoVenda() {
            const produtoId = document.getElementById('venda-produto-select').value;
            const quantidade = parseFloat(document.getElementById('venda-produto-quantidade').value);
            const precoCustomizado = parseFloat(document.getElementById('venda-preco-customizado').value) || null;
            
            if (!produtoId) {
                mostrarToast('Selecione um produto', 'warning');
                return;
            }
            
            if (!quantidade || quantidade <= 0) {
                mostrarToast('Informe a quantidade', 'warning');
                return;
            }
            
            const produto = produtosFinais.find(p => p.id === produtoId);
            if (!produto) {
                mostrarToast('Produto n√£o encontrado', 'error');
                return;
            }
            
            // Validar estoque
            const validacao = validarEstoqueProduto(produtoId, quantidade);
            if (!validacao.valido) {
                mostrarToast('Estoque insuficiente para este produto', 'error');
                return;
            }
            
            // Verificar se j√° foi adicionado
            if (produtosVendaTemp.some(p => p.produtoId === produtoId)) {
                mostrarToast('Produto j√° adicionado ao pedido', 'warning');
                return;
            }
            
            // Adicionar ao array tempor√°rio
            produtosVendaTemp.push({
                produtoId: produtoId,
                produtoNome: produto.nome,
                quantidade: quantidade,
                precoCustomizado: precoCustomizado
            });
            
            // Atualizar interface
            renderizarProdutosVendaTemp();
            atualizarResumoFinanceiroVenda();
            
            // Limpar campos
            document.getElementById('venda-produto-select').value = '';
            document.getElementById('venda-produto-quantidade').value = '';
            document.getElementById('venda-preco-customizado').value = '';
            document.getElementById('campos-quantidade-produto').style.display = 'none';
            document.getElementById('resumo-venda-rapido').style.display = 'none';
            document.getElementById('alerta-estoque-venda').style.display = 'none';
            
            mostrarToast('Produto adicionado ao pedido!', 'success');
        }
        
        /**
         * RENDERIZA LISTA DE PRODUTOS NA VENDA TEMPOR√ÅRIA
         */
        function renderizarProdutosVendaTemp() {
            const tbody = document.getElementById('tbody-produtos-venda');
            const listaDiv = document.getElementById('lista-produtos-venda');
            
            if (!tbody || !listaDiv) return;
            
            if (produtosVendaTemp.length === 0) {
                listaDiv.style.display = 'none';
                return;
            }
            
            let html = '';
            
            produtosVendaTemp.forEach((item, index) => {
                const produto = produtosFinais.find(p => p.id === item.produtoId);
                if (!produto) return;
                
                const custos = calcularCustoProdutoFinal(produto);
                
                let precoUnitario = 0;
                let custoUnitario = 0;
                let unidade = '';
                
                if (produto.tipoPrecificacao === 'peso') {
                    precoUnitario = item.precoCustomizado || produto.precoVendaKg;
                    custoUnitario = custos.custoPorKg;
                    unidade = 'kg';
                } else {
                    precoUnitario = item.precoCustomizado || produto.precoVendaUnidade;
                    custoUnitario = custos.custoPorUnidade;
                    unidade = 'un';
                }
                
                const subtotal = precoUnitario * item.quantidade;
                const custoTotal = custoUnitario * item.quantidade;
                const lucro = subtotal - custoTotal;
                const margem = subtotal > 0 ? (lucro / subtotal) * 100 : 0;
                
                const corMargem = margem >= 20 ? 'var(--cor-sucesso)' : 
                                 margem >= 10 ? 'var(--cor-aviso)' : 'var(--cor-erro)';
                
                html += `
                    <tr>
                        <td>
                            ${item.produtoNome}
                            ${item.precoCustomizado ? '<span class="badge badge-warning" style="margin-left: 5px;">Pre√ßo Custom</span>' : ''}
                        </td>
                        <td>${item.quantidade} ${unidade}</td>
                        <td>${formatarMoeda(precoUnitario)}/${unidade}</td>
                        <td style="font-weight: bold;">${formatarMoeda(subtotal)}</td>
                        <td style="color: ${corMargem}; font-weight: 600;">
                            ${formatarMoeda(lucro)} (${margem.toFixed(1)}%)
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm" onclick="removerProdutoVendaTemp(${index})">
                                üóëÔ∏è
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            listaDiv.style.display = 'block';
        }
        
        /**
         * REMOVE PRODUTO DA VENDA TEMPOR√ÅRIA
         */
        function removerProdutoVendaTemp(index) {
            produtosVendaTemp.splice(index, 1);
            renderizarProdutosVendaTemp();
            atualizarResumoFinanceiroVenda();
            
            if (produtosVendaTemp.length === 0) {
                document.getElementById('resumo-financeiro-venda').style.display = 'none';
            }
        }
        
        /**
         * ATUALIZA RESUMO FINANCEIRO DA VENDA
         */
        function atualizarResumoFinanceiroVenda() {
            const resumoDiv = document.getElementById('resumo-financeiro-venda');
            
            if (!resumoDiv) return;
            
            if (produtosVendaTemp.length === 0) {
                resumoDiv.style.display = 'none';
                return;
            }
            
            let totalItens = 0;
            let custoTotal = 0;
            let valorTotal = 0;
            let lucroTotal = 0;
            
            produtosVendaTemp.forEach(item => {
                const produto = produtosFinais.find(p => p.id === item.produtoId);
                if (!produto) return;
                
                const custos = calcularCustoProdutoFinal(produto);
                
                let precoUnitario = 0;
                let custoUnitario = 0;
                
                if (produto.tipoPrecificacao === 'peso') {
                    precoUnitario = item.precoCustomizado || produto.precoVendaKg;
                    custoUnitario = custos.custoPorKg;
                } else {
                    precoUnitario = item.precoCustomizado || produto.precoVendaUnidade;
                    custoUnitario = custos.custoPorUnidade;
                }
                
                const subtotal = precoUnitario * item.quantidade;
                const custoItem = custoUnitario * item.quantidade;
                
                totalItens += item.quantidade;
                custoTotal += custoItem;
                valorTotal += subtotal;
                lucroTotal += (subtotal - custoItem);
            });
            
            const margemMedia = valorTotal > 0 ? (lucroTotal / valorTotal) * 100 : 0;
            const corMargem = margemMedia >= 20 ? 'var(--cor-sucesso)' : 
                             margemMedia >= 10 ? 'var(--cor-aviso)' : 'var(--cor-erro)';
            
            // Atualizar valores
            document.getElementById('resumo-total-itens').textContent = totalItens.toFixed(2);
            document.getElementById('resumo-custo-total-pedido').textContent = formatarMoeda(custoTotal);
            document.getElementById('resumo-valor-total-pedido').textContent = formatarMoeda(valorTotal);
            document.getElementById('resumo-lucro-total-pedido').textContent = formatarMoeda(lucroTotal);
            document.getElementById('resumo-margem-pedido').textContent = margemMedia.toFixed(1) + '%';
            document.getElementById('resumo-margem-pedido').style.color = corMargem;

            // üÜï Atualizar preview de comiss√£o do revendedor
            atualizarPreviewComissaoRevendedor();
            
            resumoDiv.style.display = 'block';
        }
        
        /**
         * Renderiza lista de vendas
         */
        function renderizarListaVendas() {
            if (vendas.length === 0) {
                return '<p style="text-align: center; color: var(--cor-texto-claro); padding: 40px;">Nenhuma venda registrada.</p>';
            }
            
            // Ordenar por data (mais recente primeiro)
            const vendasOrdenadas = [...vendas].sort((a, b) => 
                new Date(b.dataVenda) - new Date(a.dataVenda)
            );
            
            let html = '';
            
            vendasOrdenadas.forEach(venda => {
                const statusEntregaClass = venda.cancelada ? 'danger' : 
                                          venda.statusEntrega === 'entregue' ? 'success' : 'warning';
                const statusPagClass = venda.pagamento.statusPagamento === 'pago' ? 'success' : 'warning';
                
                const corCard = venda.cancelada ? 'var(--cor-erro)' : 'var(--cor-primaria)';
                
                html += `
                    <div class="card" style="margin-bottom: 15px; border-left: 4px solid ${corCard}; 
                        ${venda.cancelada ? 'opacity: 0.7;' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div>
                                <h4 style="margin: 0 0 5px 0;">
                                    ${venda.numero}
                                    ${venda.cancelada ? ' <span style="color: var(--cor-erro);">üö´ CANCELADA</span>' : ''}
                                </h4>
                                <div style="font-size: 14px; color: var(--cor-texto-claro);">
                                    ${formatarData(venda.dataVenda)} √†s ${new Date(venda.dataVenda).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 24px; font-weight: bold; color: var(--cor-primaria);">
                                    ${formatarMoeda(venda.valorTotal)}
                                </div>
                                <div style="font-size: 13px; color: var(--cor-sucesso); font-weight: 600;">
                                    Lucro: ${formatarMoeda(venda.destinacaoLucro.lucroLiquido)} (${venda.destinacaoLucro.margemLiquida.toFixed(1)}%)
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; 
                            background: var(--cor-fundo); border-radius: var(--borda-radius);">
                            <div>
                                <div style="font-size: 12px; color: var(--cor-texto-claro);">Cliente</div>
                                <div style="font-weight: 600;">üë§ ${venda.cliente.nome}</div>
                                ${venda.cliente.telefone ? `<div style="font-size: 13px;">üìû ${venda.cliente.telefone}</div>` : ''}
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--cor-texto-claro);">Produto</div>
                                <div style="font-size: 14px; margin: 5px 0;">
                                    ${venda.produtos && venda.produtos.length > 0 ? 
                                        venda.produtos.map(p => 
                                            `üéÇ ${p.quantidade}${p.unidade} ${p.produtoNome}`
                                        ).join('<br>') 
                                        : 
                                        `üç∞ ${venda.quantidade}x ${venda.receitaNome}`
                                    }
                                </div>
                                <div style="font-size: 13px; color: var(--cor-texto-claro);">
                                    ${formatarMoeda(venda.precoUnitario)}/un
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--cor-texto-claro);">Entrega</div>
                                <div style="font-weight: 600;">üìÖ ${formatarData(venda.dataEntrega)}</div>
                                ${venda.horaEntrega ? `<div style="font-size: 13px;">üïê ${venda.horaEntrega}</div>` : ''}
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--cor-texto-claro);">Pagamento</div>
                                <div style="font-weight: 600;">üí≥ ${venda.pagamento.formaPagamento}</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                            <span class="badge badge-${statusEntregaClass}">
                                ${venda.cancelada ? 'üö´ Cancelada' : 
                                  venda.statusEntrega === 'entregue' ? '‚úÖ Entregue' : 'üü° Pendente'}
                            </span>
                            <span class="badge badge-${statusPagClass}">
                                ${venda.pagamento.statusPagamento === 'pago' ? 'üí∞ Pago' : '‚è≥ Pagamento Pendente'}
                            </span>
                            ${venda.clienteId ? (() => {
                                const cliente = clientes.find(c => c.id === venda.clienteId);
                                if (cliente) {
                                    const nivelInfo = getNivelInfo(cliente.nivel);
                                    return `<span class="badge" style="background: ${nivelInfo.cor}; color: white;">
                                        ${nivelInfo.icone} ${nivelInfo.nome} ‚Ä¢ ${nivelInfo.desconto}% OFF
                                    </span>`;
                                }
                                return '';
                            })() : ''}
                            ${venda.revendedorId ? (() => {
                                const revendedor = revendedores.find(r => r.id === venda.revendedorId);
                                if (revendedor) {
                                    return `<span class="badge" style="background: var(--cor-info); color: white;">
                                        ü§ù ${revendedor.nome} ‚Ä¢ Comiss√£o: ${formatarMoeda(venda.revendedorComissaoValor || 0)}
                                    </span>`;
                                }
                                return '';
                            })() : ''}
                        </div>
                        
                        <div style="margin-top: 15px; display: flex; gap: 5px; flex-wrap: wrap;">
                            <button class="btn btn-primary btn-sm" onclick="verDetalhesVenda('${venda.id}')">
                                üëÅÔ∏è Ver Detalhes
                            </button>
                            
                            ${!venda.cancelada ? `
                                ${venda.statusEntrega !== 'entregue' ? `
                                    <button class="btn btn-success btn-sm" onclick="marcarComoEntregueERecarregar('${venda.id}')">
                                        ‚úÖ Marcar Entregue
                                    </button>
                                ` : ''}
                                
                                ${venda.pagamento.statusPagamento !== 'pago' ? `
                                    <button class="btn btn-info btn-sm" onclick="confirmarPagamentoERecarregar('${venda.id}')">
                                        üí≥ Confirmar Pagamento
                                    </button>
                                ` : ''}
                                
                                <button class="btn btn-secondary btn-sm" onclick="abrirModalEditarVenda('${venda.id}')">
                                    ‚úèÔ∏è Editar
                                </button>
                                
                                <button class="btn btn-danger btn-sm" onclick="cancelarVendaERecarregar('${venda.id}')">
                                    üóëÔ∏è Cancelar
                                </button>
                            ` : `
                                ${venda.motivoCancelamento ? `
                                    <span style="font-size: 13px; color: var(--cor-texto-claro);">
                                        Motivo: ${venda.motivoCancelamento}
                                    </span>
                                ` : ''}
                            `}
                        </div>
                    </div>
                `;
            });
            
            return html;
        }
        
        /**
         * Renderiza resumo de vendas
         */
        function renderizarResumoVendas() {
            const vendasAtivas = vendas.filter(v => !v.cancelada);
            
            if (vendasAtivas.length === 0) {
                return '<p style="text-align: center; color: var(--cor-texto-claro);">Nenhuma venda para exibir.</p>';
            }
            
            // Calcular totais
            const totalVendas = vendasAtivas.length;
            const faturamentoTotal = vendasAtivas.reduce((sum, v) => sum + v.valorTotal, 0);
            const custoTotal = vendasAtivas.reduce((sum, v) => sum + v.custoTotal, 0);
            const lucroLiquido = vendasAtivas.reduce((sum, v) => sum + v.destinacaoLucro.lucroLiquido, 0);
            const margemMedia = (lucroLiquido / faturamentoTotal) * 100;
            const ticketMedio = faturamentoTotal / totalVendas;
            
            // Vendas por produto (com suporte para m√∫ltiplos produtos)
            const vendasPorReceita = {};
            vendasAtivas.forEach(v => {
                if (v.produtos && v.produtos.length > 0) {
                    // Venda nova (com m√∫ltiplos produtos)
                    v.produtos.forEach(p => {
                        if (!vendasPorReceita[p.produtoNome]) {
                            vendasPorReceita[p.produtoNome] = {
                                quantidade: 0,
                                faturamento: 0
                            };
                        }
                        vendasPorReceita[p.produtoNome].quantidade += p.quantidade;
                        vendasPorReceita[p.produtoNome].faturamento += p.subtotal;
                    });
                } else {
                    // Venda antiga (compatibilidade)
                    if (!vendasPorReceita[v.receitaNome]) {
                        vendasPorReceita[v.receitaNome] = {
                            quantidade: 0,
                            faturamento: 0
                        };
                    }
                    vendasPorReceita[v.receitaNome].quantidade += v.quantidade;
                    vendasPorReceita[v.receitaNome].faturamento += v.valorTotal;
                }
            });
            
            const receitasOrdenadas = Object.entries(vendasPorReceita)
                .sort((a, b) => b[1].faturamento - a[1].faturamento);
            
            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
                    gap: 20px; margin-bottom: 30px;">
                    <div style="background: var(--cor-fundo); padding: 20px; border-radius: var(--borda-radius); 
                        text-align: center;">
                        <div style="font-size: 14px; color: var(--cor-texto-claro); margin-bottom: 5px;">
                            Total de Vendas
                        </div>
                        <div style="font-size: 32px; font-weight: bold; color: var(--cor-primaria);">
                            ${totalVendas}
                        </div>
                    </div>
                    
                    <div style="background: var(--cor-fundo); padding: 20px; border-radius: var(--borda-radius); 
                        text-align: center;">
                        <div style="font-size: 14px; color: var(--cor-texto-claro); margin-bottom: 5px;">
                            Faturamento Total
                        </div>
                        <div style="font-size: 28px; font-weight: bold; color: var(--cor-primaria);">
                            ${formatarMoeda(faturamentoTotal)}
                        </div>
                    </div>
                    
                    <div style="background: var(--cor-fundo); padding: 20px; border-radius: var(--borda-radius); 
                        text-align: center;">
                        <div style="font-size: 14px; color: var(--cor-texto-claro); margin-bottom: 5px;">
                            Lucro L√≠quido
                        </div>
                        <div style="font-size: 28px; font-weight: bold; color: var(--cor-sucesso);">
                            ${formatarMoeda(lucroLiquido)}
                        </div>
                    </div>
                    
                    <div style="background: var(--cor-fundo); padding: 20px; border-radius: var(--borda-radius); 
                        text-align: center;">
                        <div style="font-size: 14px; color: var(--cor-texto-claro); margin-bottom: 5px;">
                            Margem M√©dia
                        </div>
                        <div style="font-size: 28px; font-weight: bold; color: var(--cor-info);">
                            ${margemMedia.toFixed(1)}%
                        </div>
                    </div>
                    
                    <div style="background: var(--cor-fundo); padding: 20px; border-radius: var(--borda-radius); 
                        text-align: center;">
                        <div style="font-size: 14px; color: var(--cor-texto-claro); margin-bottom: 5px;">
                            Ticket M√©dio
                        </div>
                        <div style="font-size: 28px; font-weight: bold; color: var(--cor-info);">
                            ${formatarMoeda(ticketMedio)}
                        </div>
                    </div>
                    
                    <div style="background: var(--cor-fundo); padding: 20px; border-radius: var(--borda-radius); 
                        text-align: center;">
                        <div style="font-size: 14px; color: var(--cor-texto-claro); margin-bottom: 5px;">
                            Custo Total
                        </div>
                        <div style="font-size: 28px; font-weight: bold; color: var(--cor-texto-claro);">
                            ${formatarMoeda(custoTotal)}
                        </div>
                    </div>
                </div>
                
                <h4 style="margin-top: 30px; margin-bottom: 15px;">üèÜ Produtos Mais Vendidos</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Produto</th>
                            <th>Quantidade</th>
                            <th>Faturamento</th>
                            <th>% do Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${receitasOrdenadas.map(([nome, dados]) => `
                            <tr>
                                <td><strong>${nome}</strong></td>
                                <td>${dados.quantidade} unidades</td>
                                <td>${formatarMoeda(dados.faturamento)}</td>
                                <td>${((dados.faturamento / faturamentoTotal) * 100).toFixed(1)}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        /**
         * Configura tabs de vendas
         */
        function configurarTabsVendas() {
            const tabButtons = document.querySelectorAll('#vendas-page .tab-button');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remover active de todos
                    tabButtons.forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('#vendas-page .tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Adicionar active no clicado
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    const tabContent = document.getElementById('tab-' + tabId);
                    if (tabContent) {
                        tabContent.classList.add('active');
                        
                        // Se for aba de resumo, recarregar
                        if (tabId === 'resumo-vendas') {
                            const resumoDiv = tabContent.querySelector('.card');
                            if (resumoDiv) {
                                resumoDiv.innerHTML = '<h3>üìä Resumo de Vendas</h3>' + renderizarResumoVendas();
                            }
                        }
                    }
                });
            });
        }
        
        /**
         * Configura formul√°rio de venda
         */
        function configurarFormularioVenda() {
            const form = document.getElementById('form-nova-venda');
            if (!form) return;
            
            // Limpar receitas tempor√°rias
            receitasVendaTemp = [];
            
            // Bot√£o adicionar receita
            const btnAddReceita = document.getElementById('btn-add-receita-venda');
            if (btnAddReceita) {
                btnAddReceita.addEventListener('click', adicionarReceitaVenda);
            }
            
            // Ao selecionar receita, preencher pre√ßo
            const selectReceita = document.getElementById('venda-receita-select');
            if (selectReceita) {
                selectReceita.addEventListener('change', function() {
                    const receitaId = this.value;
                    if (receitaId) {
                        const receita = receitas.find(r => r.id === receitaId);
                        if (receita) {
                            document.getElementById('venda-receita-preco').value = receita.precoVenda.toFixed(2);
                        }
                    }
                });
            }
            
            // Validar estoque ao mudar quantidade
            const inputQuantidade = document.getElementById('venda-quantidade');
            if (inputQuantidade) {
                inputQuantidade.addEventListener('input', function() {
                    validarEstoqueVenda();
                    atualizarResumoFinanceiroVenda();
                });
            }
            
            // Recalcular ao mudar despesas
            ['venda-frete', 'venda-decoracao', 'venda-brindes'].forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', atualizarResumoFinanceiroVenda);
                }
            });
            
            // Submit do formul√°rio
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                try {
                    // Validar se h√° produtos
                    if (produtosVendaTemp.length === 0) {
                        mostrarToast('Adicione pelo menos um produto √† venda', 'warning');
                        return;
                    }
                    
                    // Coletar dados do formul√°rio
                    const dados = {
                        produtos: produtosVendaTemp,
                        cliente: {
                            nome: document.getElementById('venda-cliente-nome').value,
                            telefone: document.getElementById('venda-cliente-telefone').value,
                            endereco: document.getElementById('venda-cliente-endereco').value,
                            email: document.getElementById('venda-cliente-email').value || '',
                            cpf: document.getElementById('venda-cliente-cpf').value || ''
                        },
                        dataEntrega: document.getElementById('venda-data-entrega').value,
                        horaEntrega: document.getElementById('venda-hora-entrega').value || '',
                        frete: document.getElementById('venda-frete').value || 0,
                        decoracao: document.getElementById('venda-decoracao').value || 0,
                        brindes: document.getElementById('venda-brindes').value || 0,
                        formaPagamento: document.getElementById('venda-forma-pagamento').value,
                        statusPagamento: document.getElementById('venda-status-pagamento').value,
                        observacoes: document.getElementById('venda-observacoes').value || '',
                        observacoesInternas: document.getElementById('venda-observacoes-internas').value || ''
                    };
                    
                    // Mostrar modal de processamento
                    toggleModal(true, "Registrando venda...", "Aguarde enquanto processamos a venda...");
                    
                    // Registrar venda
                    const novaVenda = registrarVenda(dados);
                    
                    // Limpar formul√°rio
                    form.reset();
                    produtosVendaTemp = [];
                    clienteAtualVenda = null;
                    revendedorAtualVenda = null;
                    
                    // Limpar displays
                    document.getElementById('info-cliente-encontrado').style.display = 'none';
                    document.getElementById('alerta-cliente-novo').style.display = 'none';
                    document.getElementById('info-revendedor-selecionado').style.display = 'none';
                    
                    renderizarProdutosVendaTemp();
                    atualizarResumoFinanceiroVenda();
                    
                    toggleModal(false);
                    
                    // Voltar para aba de listagem
                    document.querySelector('#vendas-page .tab-button[data-tab="listar-vendas"]').click();
                    
                    // Recarregar p√°gina de vendas
                    carregarPaginaVendas();
                    
                    mostrarToast(`Venda ${novaVenda.numero} registrada com sucesso!`, 'success');
                    
                } catch (erro) {
                    toggleModal(false);
                    console.error('Erro ao registrar venda:', erro);
                    mostrarToast('Erro ao registrar venda: ' + erro.message, 'error');
                }
            });
            // üÜï BUSCAR CLIENTE POR TELEFONE
            const inputTelefone = document.getElementById('venda-cliente-telefone');
            // clienteAtualVenda j√° est√° declarado no escopo da p√°gina
            
            if (inputTelefone) {
                inputTelefone.addEventListener('blur', function() {
                    buscarClientePorTelefoneVenda(this.value);
                });
                
                // Tamb√©m buscar ao pressionar Enter
                inputTelefone.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        buscarClientePorTelefoneVenda(this.value);
                    }
                });
            }
            
            /**
             * BUSCA CLIENTE E PREENCHE DADOS
             */
            function buscarClientePorTelefoneVenda(telefone) {
                const infoDiv = document.getElementById('info-cliente-encontrado');
                const alertaDiv = document.getElementById('alerta-cliente-novo');
                
                if (!telefone || telefone.trim() === '') {
                    infoDiv.style.display = 'none';
                    alertaDiv.style.display = 'none';
                    clienteAtualVenda = null;
                    return;
                }
                
                // Buscar cliente
                const cliente = buscarClientePorTelefone(telefone);
                
                if (cliente) {
                    // CLIENTE ENCONTRADO
                    clienteAtualVenda = cliente;
                    
                    // Preencher dados
                    document.getElementById('venda-cliente-nome').value = cliente.nome;
                    document.getElementById('venda-cliente-email').value = cliente.email || '';
                    document.getElementById('venda-cliente-cpf').value = cliente.cpf || '';
                    document.getElementById('venda-cliente-endereco').value = cliente.endereco || '';
                    
                    // Mostrar informa√ß√µes do cliente
                    const nivelInfo = getNivelInfo(cliente.nivel);
                    const progresso = calcularProgressoNivel(cliente.totalGasto);
                    
                    document.getElementById('cliente-nivel-icone').textContent = nivelInfo.icone;
                    document.getElementById('cliente-nome-encontrado').textContent = cliente.nome;
                    document.getElementById('cliente-desconto-valor').textContent = nivelInfo.desconto + '%';
                    
                    // Mudar cor do badge baseado no n√≠vel
                    const badge = document.getElementById('cliente-desconto-badge');
                    badge.style.background = nivelInfo.cor;
                    
                    document.getElementById('cliente-estatisticas').innerHTML = `
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <div>
                                <strong>Total Gasto:</strong> ${formatarMoeda(cliente.totalGasto)}
                            </div>
                            <div>
                                <strong>Pedidos:</strong> ${cliente.totalPedidos}
                            </div>
                            <div>
                                <strong>N√≠vel:</strong> ${nivelInfo.nome}
                            </div>
                            ${progresso.proximoNivel ? `
                                <div style="color: var(--cor-primaria);">
                                    <strong>Faltam ${formatarMoeda(progresso.faltaParaProximo)} para ${getNivelInfo(progresso.proximoNivel).nome}</strong>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    infoDiv.style.display = 'block';
                    alertaDiv.style.display = 'none';
                    
                    // Aplicar desconto automaticamente
                    aplicarDescontoClienteVenda(nivelInfo.desconto);
                    
                    mostrarToast(`Cliente encontrado! Aplicando ${nivelInfo.desconto}% de desconto ${nivelInfo.icone}`, 'success');
                    
                } else {
                    // CLIENTE NOVO
                    clienteAtualVenda = null;
                    
                    // Limpar campos (deixar apenas telefone)
                    document.getElementById('venda-cliente-nome').value = '';
                    document.getElementById('venda-cliente-email').value = '';
                    document.getElementById('venda-cliente-cpf').value = '';
                    document.getElementById('venda-cliente-endereco').value = '';
                    
                    infoDiv.style.display = 'none';
                    alertaDiv.style.display = 'block';
                    
                    // Remover desconto
                    aplicarDescontoClienteVenda(0);
                }
            }
            
            /**
             * APLICA DESCONTO DO CLIENTE NOS PRODUTOS
             */
            function aplicarDescontoClienteVenda(percentualDesconto) {
                // Atualizar cada produto na lista tempor√°ria
                produtosVendaTemp.forEach(item => {
                    const produto = produtosFinais.find(p => p.id === item.produtoId);
                    if (!produto) return;
                    
                    let precoOriginal = 0;
                    
                    if (produto.tipoPrecificacao === 'peso') {
                        precoOriginal = item.precoCustomizado || produto.precoVendaKg;
                    } else {
                        precoOriginal = item.precoCustomizado || produto.precoVendaUnidade;
                    }
                    
                    // Aplicar desconto
                    const precoComDesconto = precoOriginal * (1 - percentualDesconto / 100);
                    item.precoCustomizado = precoComDesconto;
                    item.descontoAplicado = percentualDesconto;
                });
                
                // Atualizar visualiza√ß√£o
                renderizarProdutosVendaTemp();
                atualizarResumoFinanceiroVenda();
            }

            // üÜï GERENCIAR SELE√á√ÉO DE REVENDEDOR
            const selectRevendedor = document.getElementById('venda-revendedor');
            let revendedorAtualVenda = null; // Armazena revendedor selecionado
            
            if (selectRevendedor) {
                selectRevendedor.addEventListener('change', function() {
                    const revendedorId = this.value;
                    const infoDiv = document.getElementById('info-revendedor-selecionado');
                    
                    if (revendedorId) {
                        // Revendedor selecionado
                        const revendedor = revendedores.find(r => r.id === revendedorId);
                        
                        if (revendedor) {
                            revendedorAtualVenda = revendedor;
                            
                            // Mostrar informa√ß√µes
                            document.getElementById('revendedor-nome-selecionado').textContent = revendedor.nome;
                            document.getElementById('revendedor-comissao-percent').textContent = revendedor.percentualComissao + '%';
                            
                            const ticketMedio = (revendedor.totalVendas > 0) ? (revendedor.faturamentoTotal / revendedor.totalVendas) : 0;
                            
                            document.getElementById('revendedor-stats').innerHTML = `
                                üìä ${revendedor.totalVendas} vendas ‚Ä¢ Ticket m√©dio: ${formatarMoeda(ticketMedio)}
                            `;
                            
                            infoDiv.style.display = 'block';
                            
                            // Atualizar preview de comiss√£o
                            atualizarPreviewComissaoRevendedor();
                            
                        }
                    } else {
                        // Nenhum revendedor
                        revendedorAtualVenda = null;
                        infoDiv.style.display = 'none';
                    }
                });
            }
            
            /**
             * ATUALIZA PREVIEW DA COMISS√ÉO DO REVENDEDOR
             */
            function atualizarPreviewComissaoRevendedor() {
                if (!revendedorAtualVenda) return;
                
                // Calcular valor total da venda atual
                const valorTotal = produtosVendaTemp.reduce((sum, item) => {
                    const preco = item.precoCustomizado || item.preco || 0;
                    return sum + (preco * item.quantidade);
                }, 0);
                
                // Calcular comiss√£o
                const comissao = valorTotal * (revendedorAtualVenda.percentualComissao / 100);
                
                // Atualizar preview
                const previewElement = document.getElementById('valor-comissao-preview');
                if (previewElement) {
                    previewElement.textContent = formatarMoeda(comissao);
                }
            }
        }
        
        /**
         * Valida estoque para a venda
         */
        function validarEstoqueVenda() {
            const receitaId = document.getElementById('venda-receita').value;
            const quantidade = parseFloat(document.getElementById('venda-quantidade').value) || 0;
            const alertaDiv = document.getElementById('alerta-estoque-venda');
            const mensagemSpan = document.getElementById('mensagem-estoque-venda');
            
            if (!receitaId || quantidade <= 0) {
                alertaDiv.classList.add('hidden');
                return true;
            }
            
            const receita = receitas.find(r => r.id === receitaId);
            if (!receita) return false;
            
            const validacao = validarEstoqueReceita(receita, quantidade);
            
            if (!validacao.valido) {
                alertaDiv.classList.remove('hidden');
                mensagemSpan.innerHTML = `<strong>Estoque insuficiente:</strong><br>${validacao.faltando.join('<br>')}`;
                return false;
            } else {
                alertaDiv.classList.add('hidden');
                return true;
            }
        }
        
        /**
         * Atualiza resumo financeiro da venda (CORRIGIDO)
         */
        function atualizarResumoFinanceiroVenda() {
            if (receitasVendaTemp.length === 0) {
                document.getElementById('resumo-financeiro-venda').style.display = 'none';
                return;
            }
            
            // 1. VALOR DAS RECEITAS
            const valorReceitas = receitasVendaTemp.reduce((sum, item) => sum + item.subtotal, 0);
            
            // 2. VALORES ADICIONAIS
            const frete = parseFloat(document.getElementById('venda-frete').value) || 0;
            const decoracao = parseFloat(document.getElementById('venda-decoracao').value) || 0;
            const brindes = parseFloat(document.getElementById('venda-brindes').value) || 0;
            
            // 3. VALOR QUE CLIENTE PAGA (receitas + frete + decoracao)
            const valorClientePaga = valorReceitas + frete + decoracao;
            
            // 4. CUSTO TOTAL
            // Custo das receitas
            const custoReceitas = receitasVendaTemp.reduce((sum, item) => {
                const custoIngredientes = item.custos.custoIngredientes * item.quantidade;
                const custosVariados = custoIngredientes * 0.10;
                return sum + custoIngredientes + custosVariados;
            }, 0);
            
            // Custo total (inclui brindes, frete e decora√ß√£o)
            const custoTotal = custoReceitas + brindes + frete + decoracao;
            
            // 5. LUCRO
            const lucroBruto = valorClientePaga - custoTotal;
            const lucroLiquido = lucroBruto * 0.50;
            const margemLiquida = valorClientePaga > 0 ? (lucroLiquido / valorClientePaga) * 100 : 0;
            
            const corMargem = margemLiquida >= 15 ? 'var(--cor-sucesso)' : 
                             margemLiquida >= 10 ? 'var(--cor-aviso)' : 'var(--cor-erro)';
            
            // Atualizar campos
            document.getElementById('resumo-valor-receitas').textContent = formatarMoeda(valorReceitas);
            document.getElementById('resumo-frete-venda').textContent = formatarMoeda(frete);
            document.getElementById('resumo-decoracao-venda').textContent = formatarMoeda(decoracao);
            document.getElementById('resumo-valor-cliente-paga').textContent = formatarMoeda(valorClientePaga);
            document.getElementById('resumo-custo-total-venda').textContent = formatarMoeda(custoTotal);
            document.getElementById('resumo-lucro-bruto-venda').textContent = formatarMoeda(lucroBruto);
            document.getElementById('resumo-lucro-liquido-venda').textContent = formatarMoeda(lucroLiquido);
            document.getElementById('resumo-margem-venda').textContent = margemLiquida.toFixed(1) + '%';
            document.getElementById('resumo-margem-venda').style.color = corMargem;
            
            // Mostrar resumo
            document.getElementById('resumo-financeiro-venda').style.display = 'block';
        }
        
        /**
         * Configura pesquisa e filtros de vendas
         */
        function configurarPesquisaVendas() {
            const inputPesquisa = document.getElementById('pesquisar-vendas');
            if (inputPesquisa) {
                inputPesquisa.addEventListener('input', aplicarFiltrosVendas);
            }
        }
        
        /**
         * Aplica filtros na lista de vendas
         */
        function aplicarFiltrosVendas() {
            const termo = document.getElementById('pesquisar-vendas').value.toLowerCase();
            const filtroStatus = document.getElementById('filtro-status-venda').value;
            const filtroProduto = document.getElementById('filtro-produto-venda').value;
            
            const cards = document.querySelectorAll('#lista-vendas .card');
            
            cards.forEach(card => {
                const texto = card.textContent.toLowerCase();
                let mostrar = texto.includes(termo);
                
                // Aplicar filtro de status
                if (mostrar && filtroStatus) {
                    if (filtroStatus === 'cancelada') {
                        mostrar = card.innerHTML.includes('CANCELADA');
                    } else if (filtroStatus === 'entregue') {
                        mostrar = card.innerHTML.includes('Entregue') && !card.innerHTML.includes('CANCELADA');
                    } else if (filtroStatus === 'pendente') {
                        mostrar = card.innerHTML.includes('Pendente') && !card.innerHTML.includes('CANCELADA');
                    }
                }
                
                // Aplicar filtro de produto
                if (mostrar && filtroProduto) {
                    const produto = produtosFinais.find(p => p.id === filtroProduto);
                    if (produto) {
                        mostrar = texto.includes(produto.nome.toLowerCase());
                    }
                }
                
                card.style.display = mostrar ? '' : 'none';
            });
        }
        
        /**
         * Ver detalhes completos da venda
         */
        function verDetalhesVenda(vendaId) {
            const venda = vendas.find(v => v.id === vendaId);
            if (!venda) {
                mostrarToast('Venda n√£o encontrada', 'error');
                return;
            }
            
            // Criar modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>üìã Venda ${venda.numero}</h3>
                        <button class="modal-close" onclick="this.parentElement.parentElement.parentElement.remove()">√ó</button>
                    </div>
                    
                    ${venda.cancelada ? `
                        <div class="notification notification-error">
                            <strong>üö´ VENDA CANCELADA</strong><br>
                            Cancelada em: ${formatarData(venda.canceladaEm)}<br>
                            Por: ${venda.canceladaPor}<br>
                            Motivo: ${venda.motivoCancelamento}
                        </div>
                    ` : ''}
                    
                    <h4 style="margin-top: 20px; color: var(--cor-primaria);">üë§ Cliente</h4>
                    <table style="font-size: 15px;">
                        <tr><td><strong>Nome:</strong></td><td>${venda.cliente.nome}</td></tr>
                        ${venda.cliente.telefone ? `<tr><td><strong>Telefone:</strong></td><td>${venda.cliente.telefone}</td></tr>` : ''}
                        ${venda.cliente.email ? `<tr><td><strong>Email:</strong></td><td>${venda.cliente.email}</td></tr>` : ''}
                        ${venda.cliente.cpf ? `<tr><td><strong>CPF:</strong></td><td>${venda.cliente.cpf}</td></tr>` : ''}
                        ${venda.cliente.endereco ? `<tr><td><strong>Endere√ßo:</strong></td><td>${venda.cliente.endereco}</td></tr>` : ''}
                    </table>

                    <!-- üÜï ADICIONE ESTE BLOCO AQUI -->
                    ${venda.revendedorId ? (() => {
                        const revendedor = revendedores.find(r => r.id === venda.revendedorId);
                        if (revendedor) {
                            return `
                                <h4 style="margin-top: 20px; margin-bottom: 10px;">ü§ù Revendedor</h4>
                                <div style="background: var(--cor-info-claro); padding: 15px; border-radius: var(--borda-radius); 
                                    margin-bottom: 20px; border-left: 4px solid var(--cor-info);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                                        <div>
                                            <h4 style="margin: 0 0 5px 0;">${revendedor.nome}</h4>
                                            <div style="font-size: 14px; color: var(--cor-texto-claro);">
                                                ${revendedor.telefone || ''} ${revendedor.email ? '‚Ä¢ ' + revendedor.email : ''}
                                            </div>
                                        </div>
                                        <div style="text-align: center; background: var(--cor-info); color: white; 
                                            padding: 10px 15px; border-radius: var(--borda-radius);">
                                            <div style="font-size: 20px; font-weight: bold;">
                                                ${venda.revendedorComissaoPercent || revendedor.percentualComissao}%
                                            </div>
                                            <div style="font-size: 11px;">COMISS√ÉO</div>
                                        </div>
                                    </div>
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--cor-info);">
                                        <strong>üí∞ Comiss√£o desta venda:</strong>
                                        <span style="font-size: 20px; font-weight: bold; color: var(--cor-info); margin-left: 10px;">
                                            ${formatarMoeda(venda.revendedorComissaoValor || 0)}
                                        </span>
                                    </div>
                                </div>
                            `;
                        }
                        return '';
                    })() : ''}
                    
                    <!-- PRODUTOS -->
                    <h4 style="margin-top: 20px; margin-bottom: 10px; color: var(--cor-primaria);">üéÇ Produtos</h4>
                    <table style="width: 100%; margin-bottom: 20px;">
                        <thead>
                            <tr>
                                <th>Produto</th>
                                <th>Quantidade</th>
                                <th>Pre√ßo Unit.</th>
                                <th>Subtotal</th>
                                <th>Lucro</th>
                                <th>Margem</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${venda.produtos && venda.produtos.length > 0 ? 
                                venda.produtos.map(p => {
                                    const margem = p.subtotal > 0 ? ((p.lucro / p.subtotal) * 100).toFixed(1) : 0;
                                    const corMargem = margem >= 20 ? 'var(--cor-sucesso)' : 
                                                     margem >= 10 ? 'var(--cor-aviso)' : 'var(--cor-erro)';
                                    return `
                                        <tr>
                                            <td>${p.produtoNome}</td>
                                            <td>${p.quantidade} ${p.unidade}</td>
                                            <td>${formatarMoeda(p.precoUnitario)}/${p.unidade}</td>
                                            <td style="font-weight: bold;">${formatarMoeda(p.subtotal)}</td>
                                            <td style="color: var(--cor-sucesso);">${formatarMoeda(p.lucro)}</td>
                                            <td style="color: ${corMargem}; font-weight: 600;">${margem}%</td>
                                        </tr>
                                    `;
                                }).join('')
                                : 
                                `<tr>
                                    <td colspan="6" style="text-align: center; color: var(--cor-texto-claro);">
                                        ${venda.quantidade}x ${venda.receitaNome} (venda antiga - formato anterior)
                                    </td>
                                </tr>`
                            }
                        </tbody>
                        <tfoot style="border-top: 2px solid var(--cor-borda);">
                            <tr>
                                <td colspan="3"><strong>TOTAL:</strong></td>
                                <td style="font-weight: bold; font-size: 16px;">${formatarMoeda(venda.valorTotal)}</td>
                                <td style="font-weight: bold; color: var(--cor-sucesso);">${formatarMoeda(venda.lucroBruto)}</td>
                                <td style="font-weight: bold;">${venda.margemLucroBruto ? venda.margemLucroBruto.toFixed(1) : '0.0'}%</td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <h4 style="margin-top: 20px; color: var(--cor-primaria);">ü•Ñ Ingredientes Utilizados</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Ingrediente</th>
                                <th>Quantidade</th>
                                <th>Pre√ßo M√©dio</th>
                                <th>Custo</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${venda.ingredientesSnapshot.map(ing => `
                                <tr>
                                    <td>${ing.materialNome}</td>
                                    <td>${ing.quantidade.toFixed(2)} ${ing.unidadeMedida}</td>
                                    <td>${formatarMoeda(ing.precoMedioMomento)}/${ing.unidadeMedida}</td>
                                    <td>${formatarMoeda(ing.custoTotal)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <h4 style="margin-top: 20px; color: var(--cor-primaria);">üí∞ An√°lise Financeira Detalhada</h4>
                    <table style="font-size: 15px;">
                        <tr style="background: var(--cor-fundo);">
                            <td colspan="2"><strong>CUSTOS DIRETOS</strong></td>
                        </tr>
                        <tr>
                            <td>Ingredientes:</td>
                            <td style="text-align: right;">${formatarMoeda(venda.custoDireto.ingredientes)}</td>
                        </tr>
                        ${venda.custoDireto.frete > 0 ? `
                            <tr>
                                <td>Frete:</td>
                                <td style="text-align: right;">${formatarMoeda(venda.custoDireto.frete)}</td>
                            </tr>
                        ` : ''}
                        ${venda.custoDireto.decoracao > 0 ? `
                            <tr>
                                <td>Decora√ß√£o:</td>
                                <td style="text-align: right;">${formatarMoeda(venda.custoDireto.decoracao)}</td>
                            </tr>
                        ` : ''}
                        ${venda.custoDireto.brindes > 0 ? `
                            <tr>
                                <td>Brindes (+ 10% acr√©scimo):</td>
                                <td style="text-align: right;">
                                    ${formatarMoeda(venda.custoDireto.brindes)} ‚Üí ${formatarMoeda(venda.custoDireto.brindesComAcrescimo)}
                                </td>
                            </tr>
                        ` : ''}
                        <tr style="font-weight: bold; border-top: 1px solid var(--cor-borda);">
                            <td>SUBTOTAL DIRETO:</td>
                            <td style="text-align: right;">${formatarMoeda(venda.custoDireto.total)}</td>
                        </tr>
                        
                        <tr style="background: var(--cor-fundo);">
                            <td colspan="2"><strong>CUSTOS INDIRETOS</strong></td>
                        </tr>
                        <tr>
                            <td>${venda.custoIndireto.descricao} (${(venda.custoIndireto.percentual * 100).toFixed(0)}%):</td>
                            <td style="text-align: right;">${formatarMoeda(venda.custoIndireto.valor)}</td>
                        </tr>
                        
                        <tr style="font-weight: bold; border-top: 2px solid var(--cor-borda); background: var(--cor-aviso-claro);">
                            <td>CUSTO TOTAL:</td>
                            <td style="text-align: right; font-size: 18px;">${formatarMoeda(venda.custoTotal)}</td>
                        </tr>
                        
                        <tr style="border-top: 2px solid var(--cor-borda);">
                            <td><strong>RECEITA TOTAL:</strong></td>
                            <td style="text-align: right; font-size: 18px;">${formatarMoeda(venda.valorTotal)}</td>
                        </tr>
                        
                        <tr style="background: var(--cor-sucesso-claro);">
                            <td><strong>LUCRO BRUTO:</strong></td>
                            <td style="text-align: right; font-weight: bold; color: var(--cor-sucesso);">
                                ${formatarMoeda(venda.lucroBruto)} (${venda.margemLucroBruto.toFixed(1)}%)
                            </td>
                        </tr>
                        
                        <tr>
                            <td>Reinvestimento (50%):</td>
                            <td style="text-align: right;">${formatarMoeda(venda.destinacaoLucro.valorReinvestimento)}</td>
                        </tr>
                        
                        <tr style="font-weight: bold; background: var(--cor-sucesso-claro); border-top: 2px solid var(--cor-sucesso);">
                            <td><strong>LUCRO L√çQUIDO (50%):</strong></td>
                            <td style="text-align: right; font-size: 20px; color: var(--cor-sucesso);">
                                ${formatarMoeda(venda.destinacaoLucro.lucroLiquido)}
                            </td>
                        </tr>
                        
                        <tr style="border-top: 2px solid var(--cor-borda);">
                            <td><strong>MARGEM L√çQUIDA:</strong></td>
                            <td style="text-align: right; font-size: 22px; font-weight: bold; 
                                color: ${venda.destinacaoLucro.margemLiquida >= 15 ? 'var(--cor-sucesso)' : 
                                        venda.destinacaoLucro.margemLiquida >= 10 ? 'var(--cor-aviso)' : 'var(--cor-erro)'};">
                                ${venda.destinacaoLucro.margemLiquida.toFixed(1)}%
                            </td>
                        </tr>
                    </table>
                    
                    <h4 style="margin-top: 20px; color: var(--cor-primaria);">üìÖ Entrega e Pagamento</h4>
                    <table style="font-size: 15px;">
                        <tr>
                            <td><strong>Data da Venda:</strong></td>
                            <td>${formatarData(venda.dataVenda)} √†s ${new Date(venda.dataVenda).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}</td>
                        </tr>
                        <tr>
                            <td><strong>Data de Entrega:</strong></td>
                            <td>${formatarData(venda.dataEntrega)} ${venda.horaEntrega ? `√†s ${venda.horaEntrega}` : ''}</td>
                        </tr>
                        <tr>
                            <td><strong>Status Entrega:</strong></td>
                            <td>
                                <span class="badge badge-${venda.cancelada ? 'danger' : venda.statusEntrega === 'entregue' ? 'success' : 'warning'}">
                                    ${venda.cancelada ? 'üö´ Cancelada' : venda.statusEntrega === 'entregue' ? '‚úÖ Entregue' : 'üü° Pendente'}
                                </span>
                            </td>
                        </tr>
                        ${venda.statusEntrega === 'entregue' && venda.dataEntregaRealizada ? `
                            <tr>
                                <td><strong>Entregue em:</strong></td>
                                <td>${formatarData(venda.dataEntregaRealizada)}</td>
                            </tr>
                        ` : ''}
                        <tr style="border-top: 1px solid var(--cor-borda);">
                            <td><strong>Forma de Pagamento:</strong></td>
                            <td>${venda.pagamento.formaPagamento}</td>
                        </tr>
                        <tr>
                            <td><strong>Status Pagamento:</strong></td>
                            <td>
                                <span class="badge badge-${venda.pagamento.statusPagamento === 'pago' ? 'success' : 'warning'}">
                                    ${venda.pagamento.statusPagamento === 'pago' ? 'üí∞ Pago' : '‚è≥ Pendente'}
                                </span>
                            </td>
                        </tr>
                        ${venda.pagamento.statusPagamento === 'pago' && venda.pagamento.dataPagamento ? `
                            <tr>
                                <td><strong>Pago em:</strong></td>
                                <td>${formatarData(venda.pagamento.dataPagamento)}</td>
                            </tr>
                        ` : ''}
                    </table>
                    
                    ${venda.observacoes || venda.observacoesInternas ? `
                        <h4 style="margin-top: 20px; color: var(--cor-primaria);">üìù Observa√ß√µes</h4>
                        ${venda.observacoes ? `
                            <div style="background: var(--cor-info-claro); padding: 10px; border-radius: var(--borda-radius); margin-bottom: 10px;">
                                <strong>Cliente:</strong><br>${venda.observacoes}
                            </div>
                        ` : ''}
                        ${venda.observacoesInternas ? `
                            <div style="background: var(--cor-aviso-claro); padding: 10px; border-radius: var(--borda-radius);">
                                <strong>Internas:</strong><br>${venda.observacoesInternas}
                            </div>
                        ` : ''}
                    ` : ''}
                    
                    ${venda.historicoEdicoes && venda.historicoEdicoes.length > 0 ? `
                        <h4 style="margin-top: 20px; color: var(--cor-primaria);">üìú Hist√≥rico de Edi√ß√µes</h4>
                        <table style="font-size: 14px;">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Usu√°rio</th>
                                    <th>Altera√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${venda.historicoEdicoes.map(edit => `
                                    <tr>
                                        <td>${formatarData(edit.data)}</td>
                                        <td>${edit.usuario}</td>
                                        <td>${edit.alteracoes}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : ''}
                    
                    <div style="margin-top: 25px; display: flex; gap: 10px; flex-wrap: wrap;">
                        ${!venda.cancelada ? `
                            <button class="btn btn-secondary" onclick="abrirModalEditarVenda('${venda.id}'); this.parentElement.parentElement.parentElement.remove();">
                                ‚úèÔ∏è Editar Venda
                            </button>
                            <button class="btn btn-danger" onclick="cancelarVendaERecarregar('${venda.id}'); this.parentElement.parentElement.parentElement.remove();">
                                üóëÔ∏è Cancelar Venda
                            </button>
                        ` : ''}
                        <button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">
                            ‚ùå Fechar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        /**
         * Abre modal para editar venda
         */
        function abrirModalEditarVenda(vendaId) {
            const venda = vendas.find(v => v.id === vendaId);
            if (!venda) {
                mostrarToast('Venda n√£o encontrada', 'error');
                return;
            }
            
            if (venda.cancelada) {
                mostrarToast('N√£o √© poss√≠vel editar uma venda cancelada', 'error');
                return;
            }
            
            // Criar modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h3>‚úèÔ∏è Editar Venda ${venda.numero}</h3>
                        <button class="modal-close" onclick="this.parentElement.parentElement.parentElement.remove()">√ó</button>
                    </div>
                    
                    <div class="notification notification-warning">
                        ‚ö†Ô∏è <strong>Aten√ß√£o:</strong> Voc√™ pode editar apenas informa√ß√µes do cliente, datas e status. 
                        Produtos e valores n√£o podem ser alterados ap√≥s a venda.
                    </div>
                    
                    <h4 style="margin-top: 20px; color: var(--cor-primaria);">üéÇ Produtos da Venda</h4>
                    
                    <div class="form-group">
                        <div style="background: var(--cor-fundo); padding: 15px; border-radius: var(--borda-radius); max-height: 200px; overflow-y: auto;">
                            ${venda.produtos && venda.produtos.length > 0 ? 
                                venda.produtos.map(p => 
                                    `<div style="padding: 8px 0; border-bottom: 1px solid var(--cor-borda);">
                                        üéÇ <strong>${p.quantidade}${p.unidade}</strong> ${p.produtoNome} - ${formatarMoeda(p.subtotal)}
                                    </div>`
                                ).join('')
                                : 
                                `<div style="padding: 8px 0;">
                                    üç∞ <strong>${venda.quantidade}x</strong> ${venda.receitaNome} - ${formatarMoeda(venda.valorTotal)}
                                </div>`
                            }
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 2px solid var(--cor-borda); font-weight: bold;">
                                <strong>Total:</strong> ${formatarMoeda(venda.valorTotal)}
                            </div>
                        </div>
                        <small style="color: var(--cor-texto-claro); display: block; margin-top: 5px;">
                            ‚ö†Ô∏è Produtos n√£o podem ser alterados ap√≥s a venda. Para mudar produtos, cancele esta venda e crie uma nova.
                        </small>
                    </div>
                    
                    <form id="form-editar-venda">
                        <h4 style="margin-top: 20px; color: var(--cor-primaria);">üë§ Cliente</h4>
                        
                        <div class="form-group">
                            <label>Nome: *</label>
                            <input type="text" id="edit-cliente-nome" class="form-control" 
                                value="${venda.cliente.nome}" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label>Telefone:</label>
                                    <input type="tel" id="edit-cliente-telefone" class="form-control" 
                                        value="${venda.cliente.telefone || ''}">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label>Email:</label>
                                    <input type="email" id="edit-cliente-email" class="form-control" 
                                        value="${venda.cliente.email || ''}">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Endere√ßo:</label>
                            <input type="text" id="edit-cliente-endereco" class="form-control" 
                                value="${venda.cliente.endereco || ''}">
                        </div>
                        
                        <h4 style="margin-top: 20px; color: var(--cor-primaria);">üìÖ Entrega</h4>
                        
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label>Data de Entrega: *</label>
                                    <input type="date" id="edit-data-entrega" class="form-control" 
                                        value="${dataISOParaInput(venda.dataEntrega)}" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label>Hor√°rio:</label>
                                    <input type="time" id="edit-hora-entrega" class="form-control" 
                                        value="${venda.horaEntrega || ''}">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Status da Entrega:</label>
                            <select id="edit-status-entrega" class="form-control">
                                <option value="pendente" ${venda.statusEntrega === 'pendente' ? 'selected' : ''}>Pendente</option>
                                <option value="entregue" ${venda.statusEntrega === 'entregue' ? 'selected' : ''}>Entregue</option>
                            </select>
                        </div>
                        
                        <h4 style="margin-top: 20px; color: var(--cor-primaria);">üí≥ Pagamento</h4>
                        
                        <div class="form-group">
                            <label>Status do Pagamento:</label>
                            <select id="edit-status-pagamento" class="form-control">
                                <option value="pendente" ${venda.pagamento.statusPagamento === 'pendente' ? 'selected' : ''}>Pendente</option>
                                <option value="pago" ${venda.pagamento.statusPagamento === 'pago' ? 'selected' : ''}>Pago</option>
                            </select>
                        </div>
                        
                        <h4 style="margin-top: 20px; color: var(--cor-primaria);">üìù Observa√ß√µes</h4>
                        
                        <div class="form-group">
                            <label>Observa√ß√µes do Cliente:</label>
                            <textarea id="edit-observacoes" class="form-control" rows="2">${venda.observacoes || ''}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Observa√ß√µes Internas:</label>
                            <textarea id="edit-observacoes-internas" class="form-control" rows="2">${venda.observacoesInternas || ''}</textarea>
                        </div>
                        
                        <div style="margin-top: 25px; display: flex; gap: 10px;">
                            <button type="submit" class="btn btn-primary">üíæ Salvar Altera√ß√µes</button>
                            <button type="button" class="btn btn-secondary" 
                                onclick="this.parentElement.parentElement.parentElement.parentElement.remove()">
                                ‚ùå Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Configurar submit
            const form = document.getElementById('form-editar-venda');
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                try {
                    const novosDados = {
                        cliente: {
                            nome: document.getElementById('edit-cliente-nome').value.trim(),
                            telefone: document.getElementById('edit-cliente-telefone').value.trim(),
                            email: document.getElementById('edit-cliente-email').value.trim(),
                            endereco: document.getElementById('edit-cliente-endereco').value.trim()
                        },
                        dataEntrega: dataInputParaISO(document.getElementById('edit-data-entrega').value),
                        horaEntrega: document.getElementById('edit-hora-entrega').value,
                        statusEntrega: document.getElementById('edit-status-entrega').value,
                        statusPagamento: document.getElementById('edit-status-pagamento').value,
                        observacoes: document.getElementById('edit-observacoes').value.trim(),
                        observacoesInternas: document.getElementById('edit-observacoes-internas').value.trim()
                    };
                    
                    if (editarVenda(vendaId, novosDados)) {
                        // Fechar modal
                        modal.remove();
                        
                        // Recarregar p√°gina
                        carregarPaginaVendas();
                        
                        mostrarToast('Venda atualizada com sucesso!', 'success');
                    }
                    
                } catch (erro) {
                    mostrarToast(erro.message, 'error');
                }
            });
        }
        
        /**
         * Fun√ß√µes auxiliares para recarregar ap√≥s a√ß√µes
         */
        function marcarComoEntregueERecarregar(vendaId) {
            if (marcarComoEntregue(vendaId)) {
                carregarPaginaVendas();
                mostrarToast('Venda marcada como entregue!', 'success');
            }
        }
        
        function confirmarPagamentoERecarregar(vendaId) {
            if (confirmarPagamento(vendaId)) {
                carregarPaginaVendas();
                mostrarToast('Pagamento confirmado!', 'success');
            }
        }
        
        function cancelarVendaERecarregar(vendaId) {
            const motivo = prompt('Informe o motivo do cancelamento (opcional):');
            if (motivo !== null) { // null = cancelou o prompt
                if (cancelarVenda(vendaId, motivo || 'N√£o informado')) {
                    carregarPaginaVendas();
                    carregarPaginaEstoque();
                }
            }
        }
        
        console.log('‚úÖ M√≥dulo de Vendas carregado');
        // ====================================
        // PARTE 6: CALEND√ÅRIO DE ENTREGAS
        // ====================================
        
        let mesAtualCalendario = new Date().getMonth();
        let anoAtualCalendario = new Date().getFullYear();
        let diaSelecionado = null;
        
        /**
         * Retorna nome do m√™s
         */
        function getNomeMes(mes) {
            const meses = [
                'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];
            return meses[mes];
        }
        
        /**
         * Retorna nome do dia da semana
         */
        function getNomeDiaSemana(dia) {
            const dias = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            return dias[dia];
        }
        
        /**
         * Busca entregas de um dia espec√≠fico (CORRIGIDO)
         */
        function getEntregasDoDia(ano, mes, dia) {
            return vendas.filter(v => {
                if (v.cancelada) return false;
                
                const dataEntrega = new Date(v.dataEntrega);
                
                // Usar UTC para evitar problema de fuso
                return dataEntrega.getUTCFullYear() === ano &&
                       dataEntrega.getUTCMonth() === mes &&
                       dataEntrega.getUTCDate() === dia;
            }).sort((a, b) => {
                // Ordenar por hor√°rio
                if (a.horaEntrega && b.horaEntrega) {
                    return a.horaEntrega.localeCompare(b.horaEntrega);
                }
                return 0;
            });
        }
        
        /**
         * Conta entregas do m√™s (CORRIGIDO)
         */
        function getEntregasDoMes(ano, mes) {
            return vendas.filter(v => {
                if (v.cancelada) return false;
                
                const dataEntrega = new Date(v.dataEntrega);
                
                // Usar UTC para evitar problema de fuso
                return dataEntrega.getUTCFullYear() === ano &&
                       dataEntrega.getUTCMonth() === mes;
            });
        }
        
        /**
         * Retorna emoji baseado no nome do produto
         */
        function getEmojiProduto(nome) {
            const nomeNorm = normalizarNome(nome);
            
            if (nomeNorm.includes('bolo')) return 'üéÇ';
            if (nomeNorm.includes('cupcake')) return 'üßÅ';
            if (nomeNorm.includes('torta')) return 'ü•ß';
            if (nomeNorm.includes('trufa')) return 'üç´';
            if (nomeNorm.includes('doce')) return 'üç¨';
            if (nomeNorm.includes('brigadeiro')) return 'üç´';
            if (nomeNorm.includes('beijinho')) return 'ü••';
            if (nomeNorm.includes('brownie')) return 'üç´';
            if (nomeNorm.includes('cookie')) return 'üç™';
            if (nomeNorm.includes('salgado')) return 'ü•ü';
            
            return 'üéÇ'; // Default
        }
        
        // ====================================
        // INTERFACE - P√ÅGINA DO CALEND√ÅRIO
        // ====================================
        
        function carregarPaginaCalendario() {
            const page = document.getElementById('calendario-page');
            if (!page) return;
            
            page.innerHTML = `
                <h2>üìÖ Calend√°rio de Entregas</h2>
                
                <div class="card">
                    <!-- Controles do Calend√°rio -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <button class="btn btn-secondary" onclick="navegarMesCalendario(-1)">
                            ‚óÄ ${getNomeMes((mesAtualCalendario - 1 + 12) % 12)}
                        </button>
                        
                        <h3 style="margin: 0;">${getNomeMes(mesAtualCalendario)} ${anoAtualCalendario}</h3>
                        
                        <button class="btn btn-secondary" onclick="navegarMesCalendario(1)">
                            ${getNomeMes((mesAtualCalendario + 1) % 12)} ‚ñ∂
                        </button>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="btn btn-info btn-sm" onclick="irParaHoje()">
                            üìç Hoje
                        </button>
                        <span class="badge badge-info">üéÇ Bolos</span>
                        <span class="badge badge-info">üßÅ Cupcakes</span>
                        <span class="badge badge-info">üç∞ Tortas</span>
                        <span style="flex: 1;"></span>
                        <span class="badge badge-success">‚úÖ Entregue</span>
                        <span class="badge badge-warning">üü° Pendente</span>
                    </div>
                    
                    <!-- Grid do Calend√°rio -->
                    <div id="calendario-grid">
                        ${renderizarCalendario()}
                    </div>
                </div>
                
                <!-- Entregas do Dia Selecionado -->
                <div class="card" id="entregas-dia-card" style="display: none;">
                    <h3 id="titulo-entregas-dia">Entregas do Dia</h3>
                    <div id="lista-entregas-dia"></div>
                </div>
                
                <!-- Resumo do M√™s -->
                <div class="card">
                    <h3>üìä Resumo do M√™s</h3>
                    <div id="resumo-mes-calendario">
                        ${renderizarResumoMes()}
                    </div>
                </div>
            `;
        }
        
        /**
         * Renderiza o calend√°rio
         */
        function renderizarCalendario() {
            const primeiroDia = new Date(anoAtualCalendario, mesAtualCalendario, 1);
            const ultimoDia = new Date(anoAtualCalendario, mesAtualCalendario + 1, 0);
            const diasNoMes = ultimoDia.getDate();
            const diaSemanaInicio = primeiroDia.getDay(); // 0 = Domingo
            
            const hoje = new Date();
            const ehMesAtual = hoje.getMonth() === mesAtualCalendario && 
                              hoje.getFullYear() === anoAtualCalendario;
            const diaHoje = ehMesAtual ? hoje.getDate() : -1;
            
            let html = `
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px;">
                    <!-- Cabe√ßalho com dias da semana -->
                    ${['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'].map(dia => `
                        <div style="text-align: center; font-weight: bold; padding: 10px; 
                            background: var(--cor-fundo); border-radius: var(--borda-radius-sm);">
                            ${dia}
                        </div>
                    `).join('')}
            `;
            
            // Espa√ßos em branco antes do primeiro dia
            for (let i = 0; i < diaSemanaInicio; i++) {
                html += '<div style="aspect-ratio: 1; border: 1px solid transparent;"></div>';
            }
            
            // Dias do m√™s
            for (let dia = 1; dia <= diasNoMes; dia++) {
                const entregas = getEntregasDoDia(anoAtualCalendario, mesAtualCalendario, dia);
                const temEntregas = entregas.length > 0;
                
                // Contar por tipo
                const contagemPorProduto = {};
                entregas.forEach(venda => {
                    const emoji = getEmojiProduto(venda.receitaNome);
                    contagemPorProduto[emoji] = (contagemPorProduto[emoji] || 0) + 1;
                });
                
                // Verificar se todas foram entregues
                const todasEntregues = entregas.every(v => v.statusEntrega === 'entregue');
                const ehHoje = dia === diaHoje;
                const ehSelecionado = diaSelecionado === dia;
                
                let corFundo = 'var(--cor-branco)';
                let corBorda = 'var(--cor-borda)';
                
                if (ehHoje) {
                    corFundo = 'var(--cor-secundaria-clara)';
                    corBorda = 'var(--cor-primaria)';
                }
                
                if (temEntregas) {
                    if (todasEntregues) {
                        corFundo = 'var(--cor-sucesso-claro)';
                        corBorda = 'var(--cor-sucesso)';
                    } else {
                        corFundo = 'var(--cor-aviso-claro)';
                        corBorda = 'var(--cor-aviso)';
                    }
                }
                
                if (ehSelecionado) {
                    corBorda = 'var(--cor-primaria)';
                }
                
                html += `
                    <div class="calendar-day ${temEntregas ? 'has-delivery' : ''} ${ehSelecionado ? 'selected' : ''}" 
                        style="aspect-ratio: 1; border: 2px solid ${corBorda}; 
                            background: ${corFundo}; border-radius: var(--borda-radius-sm); 
                            padding: 5px; cursor: pointer; transition: var(--transicao-rapida);
                            display: flex; flex-direction: column; position: relative;"
                        onclick="selecionarDia(${dia})"
                        onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='var(--sombra-media)';"
                        onmouseout="this.style.transform=''; this.style.boxShadow='';">
                        
                        <div style="font-weight: ${ehHoje ? 'bold' : '600'}; 
                            color: ${ehHoje ? 'var(--cor-primaria)' : 'var(--cor-texto)'}; 
                            font-size: ${ehHoje ? '18px' : '16px'};">
                            ${dia}
                            ${ehHoje ? ' üìç' : ''}
                        </div>
                        
                        ${temEntregas ? `
                            <div style="flex: 1; display: flex; flex-direction: column; 
                                justify-content: center; align-items: center; gap: 2px; margin-top: 5px;">
                                ${Object.entries(contagemPorProduto).slice(0, 3).map(([emoji, qtd]) => `
                                    <div style="font-size: 14px; white-space: nowrap;">
                                        ${emoji}${qtd > 1 ? `√ó${qtd}` : ''}
                                    </div>
                                `).join('')}
                                ${Object.keys(contagemPorProduto).length > 3 ? `
                                    <div style="font-size: 11px; color: var(--cor-texto-claro);">
                                        +${Object.keys(contagemPorProduto).length - 3}
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div style="font-size: 10px; text-align: center; margin-top: auto; font-weight: 600;
                                color: ${todasEntregues ? 'var(--cor-sucesso)' : 'var(--cor-aviso)'};">
                                ${todasEntregues ? '‚úÖ' : 'üü°'}
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            html += '</div>';
            
            return html;
        }
        
        /**
         * Renderiza resumo do m√™s
         */
        function renderizarResumoMes() {
            const entregasMes = getEntregasDoMes(anoAtualCalendario, mesAtualCalendario);
            
            if (entregasMes.length === 0) {
                return '<p style="text-align: center; color: var(--cor-texto-claro);">Nenhuma entrega agendada para este m√™s.</p>';
            }
            
            const totalEntregas = entregasMes.length;
            const entregasConcluidas = entregasMes.filter(v => v.statusEntrega === 'entregue').length;
            const entregasPendentes = totalEntregas - entregasConcluidas;
            const faturamentoMes = entregasMes.reduce((sum, v) => sum + v.valorTotal, 0);
            const lucroMes = entregasMes.reduce((sum, v) => sum + v.destinacaoLucro.lucroLiquido, 0);
            
            // Agrupar por produto (com suporte para m√∫ltiplos produtos)
            const porReceita = {};
            entregasMes.forEach(v => {
                if (v.produtos && v.produtos.length > 0) {
                    // Venda nova (com m√∫ltiplos produtos)
                    v.produtos.forEach(p => {
                        if (!porReceita[p.produtoNome]) {
                            porReceita[p.produtoNome] = {
                                quantidade: 0,
                                faturamento: 0,
                                emoji: getEmojiProduto(p.produtoNome)
                            };
                        }
                        porReceita[p.produtoNome].quantidade += p.quantidade;
                        porReceita[p.produtoNome].faturamento += p.subtotal;
                    });
                } else {
                    // Venda antiga (compatibilidade)
                    if (!porReceita[v.receitaNome]) {
                        porReceita[v.receitaNome] = {
                            quantidade: 0,
                            faturamento: 0,
                            emoji: getEmojiProduto(v.receitaNome)
                        };
                    }
                    porReceita[v.receitaNome].quantidade += v.quantidade;
                    porReceita[v.receitaNome].faturamento += v.valorTotal;
                }
            });
            
            const receitasOrdenadas = Object.entries(porReceita)
                .sort((a, b) => b[1].quantidade - a[1].quantidade);
            
            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
                    gap: 15px; margin-bottom: 20px;">
                    <div style="background: var(--cor-fundo); padding: 15px; border-radius: var(--borda-radius); text-align: center;">
                        <div style="font-size: 12px; color: var(--cor-texto-claro);">Total</div>
                        <div style="font-size: 28px; font-weight: bold; color: var(--cor-primaria);">${totalEntregas}</div>
                        <div style="font-size: 12px;">entregas</div>
                    </div>
                    
                    <div style="background: var(--cor-sucesso-claro); padding: 15px; border-radius: var(--borda-radius); text-align: center;">
                        <div style="font-size: 12px; color: var(--cor-texto-claro);">Conclu√≠das</div>
                        <div style="font-size: 28px; font-weight: bold; color: var(--cor-sucesso);">${entregasConcluidas}</div>
                        <div style="font-size: 12px;">${((entregasConcluidas / totalEntregas) * 100).toFixed(0)}%</div>
                    </div>
                    
                    <div style="background: var(--cor-aviso-claro); padding: 15px; border-radius: var(--borda-radius); text-align: center;">
                        <div style="font-size: 12px; color: var(--cor-texto-claro);">Pendentes</div>
                        <div style="font-size: 28px; font-weight: bold; color: var(--cor-aviso);">${entregasPendentes}</div>
                        <div style="font-size: 12px;">${((entregasPendentes / totalEntregas) * 100).toFixed(0)}%</div>
                    </div>
                    
                    <div style="background: var(--cor-fundo); padding: 15px; border-radius: var(--borda-radius); text-align: center;">
                        <div style="font-size: 12px; color: var(--cor-texto-claro);">Faturamento</div>
                        <div style="font-size: 20px; font-weight: bold; color: var(--cor-primaria);">
                            ${formatarMoeda(faturamentoMes)}
                        </div>
                    </div>
                    
                    <div style="background: var(--cor-fundo); padding: 15px; border-radius: var(--borda-radius); text-align: center;">
                        <div style="font-size: 12px; color: var(--cor-texto-claro);">Lucro L√≠quido</div>
                        <div style="font-size: 20px; font-weight: bold; color: var(--cor-sucesso);">
                            ${formatarMoeda(lucroMes)}
                        </div>
                    </div>
                </div>
                
                <h4 style="margin-top: 20px; margin-bottom: 10px;">üèÜ Produtos Mais Agendados</h4>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    ${receitasOrdenadas.map(([nome, dados]) => {
                        const percentual = (dados.quantidade / entregasMes.reduce((sum, v) => sum + v.quantidade, 0)) * 100;
                        return `
                            <div style="display: flex; align-items: center; gap: 10px; 
                                background: var(--cor-fundo); padding: 10px; border-radius: var(--borda-radius);">
                                <div style="font-size: 24px;">${dados.emoji}</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600;">${nome}</div>
                                    <div style="font-size: 13px; color: var(--cor-texto-claro);">
                                        ${dados.quantidade} unidades (${percentual.toFixed(0)}%)
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: bold; color: var(--cor-primaria);">
                                        ${formatarMoeda(dados.faturamento)}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        /**
         * Navega para m√™s anterior/pr√≥ximo
         */
        function navegarMesCalendario(direcao) {
            mesAtualCalendario += direcao;
            
            if (mesAtualCalendario > 11) {
                mesAtualCalendario = 0;
                anoAtualCalendario++;
            } else if (mesAtualCalendario < 0) {
                mesAtualCalendario = 11;
                anoAtualCalendario--;
            }
            
            diaSelecionado = null;
            carregarPaginaCalendario();
        }
        
        /**
         * Volta para o m√™s atual
         */
        function irParaHoje() {
            const hoje = new Date();
            mesAtualCalendario = hoje.getMonth();
            anoAtualCalendario = hoje.getFullYear();
            diaSelecionado = hoje.getDate();
            
            carregarPaginaCalendario();
            
            // Auto-selecionar o dia
            setTimeout(() => {
                selecionarDia(diaSelecionado);
            }, 100);
        }
        
        /**
         * Seleciona um dia e mostra suas entregas
         */
        function selecionarDia(dia) {
            diaSelecionado = dia;
            
            const entregas = getEntregasDoDia(anoAtualCalendario, mesAtualCalendario, dia);
            
            // Atualizar calend√°rio
            const calendarioGrid = document.getElementById('calendario-grid');
            if (calendarioGrid) {
                calendarioGrid.innerHTML = renderizarCalendario();
            }
            
            // Mostrar/esconder card de entregas
            const card = document.getElementById('entregas-dia-card');
            const titulo = document.getElementById('titulo-entregas-dia');
            const lista = document.getElementById('lista-entregas-dia');
            
            if (entregas.length === 0) {
                card.style.display = 'none';
                return;
            }
            
            const data = new Date(anoAtualCalendario, mesAtualCalendario, dia);
            const nomeDia = getNomeDiaSemana(data.getDay());
            
            titulo.textContent = `Entregas de ${nomeDia}, ${dia} de ${getNomeMes(mesAtualCalendario)} de ${anoAtualCalendario}`;
            lista.innerHTML = renderizarEntregasDoDia(entregas);
            card.style.display = 'block';
            
            // Scroll suave at√© o card
            card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        /**
         * Renderiza lista de entregas do dia
         */
        function renderizarEntregasDoDia(entregas) {
            if (entregas.length === 0) {
                return '<p style="text-align: center; color: var(--cor-texto-claro);">Nenhuma entrega agendada para este dia.</p>';
            }
            
            let html = '';
            
            entregas.forEach(venda => {
                const statusClass = venda.statusEntrega === 'entregue' ? 'success' : 'warning';
                const statusPagClass = venda.pagamento.statusPagamento === 'pago' ? 'success' : 'warning';
                const emoji = getEmojiProduto(venda.receitaNome);
                
                html += `
                    <div class="card" style="margin-bottom: 15px; border-left: 4px solid ${
                        venda.statusEntrega === 'entregue' ? 'var(--cor-sucesso)' : 'var(--cor-aviso)'
                    };">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                    <span style="font-size: 24px;">${emoji}</span>
                                    <div>
                                        <div style="font-weight: 600; font-size: 16px;">
                                            ${venda.horaEntrega || '‚è∞'} - ${venda.cliente.nome}
                                        </div>
                                        <div style="font-size: 14px; color: var(--cor-texto-claro);">
                                            ${venda.numero}
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-top: 10px;">
                                    <span class="badge badge-${statusClass}">
                                        ${venda.statusEntrega === 'entregue' ? '‚úÖ Entregue' : 'üü° Pendente'}
                                    </span>
                                    <span class="badge badge-${statusPagClass}">
                                        ${venda.pagamento.statusPagamento === 'pago' ? 'üí∞ Pago' : '‚è≥ Pag. Pendente'}
                                    </span>
                                </div>
                            </div>
                            
                            <div style="text-align: right;">
                                <div style="font-size: 18px; font-weight: bold; color: var(--cor-primaria);">
                                    ${formatarMoeda(venda.valorTotal)}
                                </div>
                                <div style="font-size: 13px; color: var(--cor-texto-claro);">
                                    ${venda.produtos && venda.produtos.length > 0 ? 
                                        venda.produtos.map(p => 
                                            `${p.quantidade}${p.unidade} ${p.produtoNome}`
                                        ).join(', ')
                                        : 
                                        `${venda.quantidade}x ${venda.receitaNome}`
                                    }
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: var(--cor-fundo); padding: 10px; border-radius: var(--borda-radius-sm); 
                            font-size: 14px; margin-bottom: 10px;">
                            ${venda.cliente.telefone ? `<div>üìû ${venda.cliente.telefone}</div>` : ''}
                            ${venda.cliente.endereco ? `<div>üìç ${venda.cliente.endereco}</div>` : ''}
                            ${venda.observacoes ? `<div style="margin-top: 5px; color: var(--cor-texto-claro);">üí¨ ${venda.observacoes}</div>` : ''}
                        </div>
                        
                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                            <button class="btn btn-primary btn-sm" onclick="verDetalhesVenda('${venda.id}')">
                                üëÅÔ∏è Ver Detalhes
                            </button>
                            
                            ${venda.statusEntrega !== 'entregue' ? `
                                <button class="btn btn-success btn-sm" onclick="marcarEntregueCalendario('${venda.id}')">
                                    ‚úÖ Marcar Entregue
                                </button>
                            ` : ''}
                            
                            ${venda.pagamento.statusPagamento !== 'pago' ? `
                                <button class="btn btn-info btn-sm" onclick="confirmarPagamentoCalendario('${venda.id}')">
                                    üí≥ Confirmar Pagamento
                                </button>
                            ` : ''}
                            
                            <button class="btn btn-secondary btn-sm" onclick="abrirModalEditarVenda('${venda.id}')">
                                ‚úèÔ∏è Editar
                            </button>
                        </div>
                    </div>
                `;
            });
            
            return html;
        }
        
        /**
         * Marca entrega como conclu√≠da (no calend√°rio)
         */
        function marcarEntregueCalendario(vendaId) {
            if (marcarComoEntregue(vendaId)) {
                // Recarregar apenas o dia selecionado
                if (diaSelecionado) {
                    const entregas = getEntregasDoDia(anoAtualCalendario, mesAtualCalendario, diaSelecionado);
                    const lista = document.getElementById('lista-entregas-dia');
                    if (lista) {
                        lista.innerHTML = renderizarEntregasDoDia(entregas);
                    }
                }
                
                // Recarregar calend√°rio
                const calendarioGrid = document.getElementById('calendario-grid');
                if (calendarioGrid) {
                    calendarioGrid.innerHTML = renderizarCalendario();
                }
                
                // Recarregar resumo
                const resumo = document.getElementById('resumo-mes-calendario');
                if (resumo) {
                    resumo.innerHTML = renderizarResumoMes();
                }
                
                mostrarToast('Entrega marcada como conclu√≠da!', 'success');
            }
        }
        
        /**
         * Confirma pagamento (no calend√°rio)
         */
        function confirmarPagamentoCalendario(vendaId) {
            if (confirmarPagamento(vendaId)) {
                // Recarregar apenas o dia selecionado
                if (diaSelecionado) {
                    const entregas = getEntregasDoDia(anoAtualCalendario, mesAtualCalendario, diaSelecionado);
                    const lista = document.getElementById('lista-entregas-dia');
                    if (lista) {
                        lista.innerHTML = renderizarEntregasDoDia(entregas);
                    }
                }
                
                mostrarToast('Pagamento confirmado!', 'success');
            }
        }
        
        console.log('‚úÖ M√≥dulo de Calend√°rio carregado');

        // ====================================
        // P√ÅGINA DE CONFIGURA√á√ïES
        // ====================================
        
        /**
         * CARREGA P√ÅGINA DE CONFIGURA√á√ïES
         */
        function carregarPaginaConfiguracoes() {
            const page = document.getElementById('configuracoes-page');
            if (!page) return;
            
            // Garantir que configura√ß√µes estejam carregadas
            if (!configuracoesCustos.fixos) {
                configuracoesCustos = {
                    fixos: {
                        salarioDesejado: 0,
                        luz: 0,
                        agua: 0,
                        internet: 0,
                        gas: 0,
                        aluguel: 0,
                        outros: 0,
                        total: 0
                    },
                    metaProducao: 50,
                    margemLucroDesejada: 30,
                    custoFixoPorUnidade: 0,
                    markupPercentual: 0,
                    multiplicadorMarkup: 1
                };
            }
            
            page.innerHTML = `
                <h2>‚öôÔ∏è Configura√ß√µes do Sistema</h2>
                
                <div class="tab-buttons">
                    <button class="tab-button active" data-tab="custos-fixos">üí∞ Custos Fixos</button>
                    <button class="tab-button" data-tab="meta-producao">üéØ Meta de Produ√ß√£o</button>
                    <button class="tab-button" data-tab="resumo-markup">üìä Resumo do Markup</button>
                </div>
                
                <!-- TAB: Custos Fixos -->
                <div class="tab-content active" id="tab-custos-fixos">
                    <div class="card">
                        <h3>üí∞ Custos Fixos Mensais</h3>
                        <p style="color: var(--cor-texto-claro); margin-bottom: 20px;">
                            ‚ÑπÔ∏è Cadastre todos os custos fixos do seu neg√≥cio. O sistema calcular√° automaticamente 
                            o markup necess√°rio para cobrir esses custos e atingir sua margem de lucro desejada.
                        </p>
                        
                        <form id="form-custos-fixos">
                            <h4 style="margin-bottom: 15px; color: var(--cor-primaria);">üíº Custos de Pessoal</h4>
                            
                            <div class="form-group">
                                <label for="config-salario">Sal√°rio/Pr√≥-labore Desejado (R$/m√™s): *</label>
                                <input type="number" id="config-salario" class="form-control" 
                                    min="0" step="0.01" value="${configuracoesCustos.fixos.salarioDesejado}" required>
                                <small style="color: var(--cor-texto-claro);">
                                    Quanto voc√™ deseja receber mensalmente do neg√≥cio
                                </small>
                            </div>
                            
                            <h4 style="margin-top: 25px; margin-bottom: 15px; color: var(--cor-primaria);">üè† Custos de Espa√ßo</h4>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="config-aluguel">Aluguel (R$/m√™s):</label>
                                        <input type="number" id="config-aluguel" class="form-control" 
                                            min="0" step="0.01" value="${configuracoesCustos.fixos.aluguel}">
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="config-luz">Energia El√©trica (R$/m√™s):</label>
                                        <input type="number" id="config-luz" class="form-control" 
                                            min="0" step="0.01" value="${configuracoesCustos.fixos.luz}">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="config-agua">√Ågua (R$/m√™s):</label>
                                        <input type="number" id="config-agua" class="form-control" 
                                            min="0" step="0.01" value="${configuracoesCustos.fixos.agua}">
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="config-gas">G√°s (R$/m√™s):</label>
                                        <input type="number" id="config-gas" class="form-control" 
                                            min="0" step="0.01" value="${configuracoesCustos.fixos.gas}">
                                    </div>
                                </div>
                            </div>
                            
                            <h4 style="margin-top: 25px; margin-bottom: 15px; color: var(--cor-primaria);">üì° Outros Custos</h4>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="config-internet">Internet/Telefone (R$/m√™s):</label>
                                        <input type="number" id="config-internet" class="form-control" 
                                            min="0" step="0.01" value="${configuracoesCustos.fixos.internet}">
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="config-outros">Outros Custos (R$/m√™s):</label>
                                        <input type="number" id="config-outros" class="form-control" 
                                            min="0" step="0.01" value="${configuracoesCustos.fixos.outros}">
                                        <small style="color: var(--cor-texto-claro);">
                                            Ex: contador, marketing, materiais de escrit√≥rio, etc.
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: var(--cor-info-claro); padding: 15px; border-radius: var(--borda-radius); 
                                margin-top: 25px; border-left: 4px solid var(--cor-info);">
                                <h4 style="margin: 0 0 10px 0;">üí∞ Total de Custos Fixos Mensais</h4>
                                <div style="font-size: 32px; font-weight: bold; color: var(--cor-primaria);" 
                                    id="preview-total-fixos">
                                    ${formatarMoeda(configuracoesCustos.fixos.total)}
                                </div>
                            </div>
                            
                            <div style="margin-top: 25px; display: flex; gap: 10px;">
                                <button type="submit" class="btn btn-primary">üíæ Salvar Custos Fixos</button>
                                <button type="button" class="btn btn-secondary" onclick="carregarPaginaConfiguracoes()">
                                    üîÑ Resetar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- TAB: Meta de Produ√ß√£o -->
                <div class="tab-content" id="tab-meta-producao">
                    <div class="card">
                        <h3>üéØ Meta de Produ√ß√£o e Margem</h3>
                        <p style="color: var(--cor-texto-claro); margin-bottom: 20px;">
                            ‚ÑπÔ∏è Defina quantos produtos voc√™ pretende fazer por m√™s e qual margem de lucro deseja. 
                            O sistema calcular√° automaticamente o markup necess√°rio.
                        </p>
                        
                        <form id="form-meta-producao">
                            <div class="form-group">
                                <label for="config-meta">Meta de Produ√ß√£o Mensal (unidades): *</label>
                                <input type="number" id="config-meta" class="form-control" 
                                    min="1" step="1" value="${configuracoesCustos.metaProducao}" required>
                                <small style="color: var(--cor-texto-claro);">
                                    Quantos produtos (bolos, doces, etc) voc√™ pretende fazer por m√™s?
                                </small>
                            </div>
                            
                            <div class="form-group">
                                <label for="config-margem">Margem de Lucro Desejada (%):</label>
                                <input type="number" id="config-margem" class="form-control" 
                                    min="0" max="100" step="1" value="${configuracoesCustos.margemLucroDesejada}" required>
                                <small style="color: var(--cor-texto-claro);">
                                    Recomendado: 30% a 50%
                                </small>
                            </div>
                            
                            <div style="background: var(--cor-aviso-claro); padding: 15px; border-radius: var(--borda-radius); 
                                margin-top: 20px; border-left: 4px solid var(--cor-aviso);">
                                <h4 style="margin: 0 0 10px 0;">üí° Simula√ß√£o de Impacto</h4>
                                <table style="width: 100%; font-size: 15px;">
                                    <tr>
                                        <td><strong>Custo Fixo por Produto:</strong></td>
                                        <td style="text-align: right; font-weight: bold;" id="preview-custo-por-unidade">
                                            ${formatarMoeda(configuracoesCustos.custoFixoPorUnidade)}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td colspan="2" style="padding-top: 10px;">
                                            <small style="color: var(--cor-texto-claro);">
                                                üí° Dica: Quanto mais voc√™ produzir, menor ser√° o custo fixo por produto!
                                            </small>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            
                            <div style="margin-top: 25px;">
                                <button type="submit" class="btn btn-primary">üíæ Salvar e Recalcular Markup</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- TAB: Resumo do Markup -->
                <div class="tab-content" id="tab-resumo-markup">
                    <div class="card">
                        <h3>üìä Resumo do Markup Calculado</h3>
                        
                        ${configuracoesCustos.fixos.total === 0 ? `
                            <div class="notification notification-warning">
                                ‚ö†Ô∏è <strong>Aten√ß√£o!</strong> Voc√™ ainda n√£o cadastrou seus custos fixos. 
                                V√° para a aba "üí∞ Custos Fixos" para come√ßar.
                            </div>
                        ` : `
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
                                gap: 20px; margin-bottom: 30px;">
                                
                                <div style="background: var(--cor-fundo); padding: 20px; border-radius: var(--borda-radius); text-align: center;">
                                    <div style="font-size: 14px; color: var(--cor-texto-claro); margin-bottom: 5px;">
                                        Total Custos Fixos
                                    </div>
                                    <div style="font-size: 28px; font-weight: bold; color: var(--cor-primaria);">
                                        ${formatarMoeda(configuracoesCustos.fixos.total)}
                                    </div>
                                    <div style="font-size: 12px; color: var(--cor-texto-claro);">por m√™s</div>
                                </div>
                                
                                <div style="background: var(--cor-fundo); padding: 20px; border-radius: var(--borda-radius); text-align: center;">
                                    <div style="font-size: 14px; color: var(--cor-texto-claro); margin-bottom: 5px;">
                                        Meta de Produ√ß√£o
                                    </div>
                                    <div style="font-size: 28px; font-weight: bold; color: var(--cor-info);">
                                        ${configuracoesCustos.metaProducao}
                                    </div>
                                    <div style="font-size: 12px; color: var(--cor-texto-claro);">unidades/m√™s</div>
                                </div>
                                
                                <div style="background: var(--cor-aviso-claro); padding: 20px; border-radius: var(--borda-radius); text-align: center;">
                                    <div style="font-size: 14px; color: var(--cor-texto-claro); margin-bottom: 5px;">
                                        Custo Fixo/Produto
                                    </div>
                                    <div style="font-size: 28px; font-weight: bold; color: var(--cor-aviso);">
                                        ${formatarMoeda(configuracoesCustos.custoFixoPorUnidade)}
                                    </div>
                                    <div style="font-size: 12px; color: var(--cor-texto-claro);">por unidade</div>
                                </div>
                                
                                <div style="background: var(--cor-sucesso-claro); padding: 20px; border-radius: var(--borda-radius); text-align: center;">
                                    <div style="font-size: 14px; color: var(--cor-texto-claro); margin-bottom: 5px;">
                                        Margem Desejada
                                    </div>
                                    <div style="font-size: 28px; font-weight: bold; color: var(--cor-sucesso);">
                                        ${configuracoesCustos.margemLucroDesejada}%
                                    </div>
                                    <div style="font-size: 12px; color: var(--cor-texto-claro);">de lucro</div>
                                </div>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, var(--cor-primaria) 0%, var(--cor-primaria-escura) 100%); 
                                padding: 30px; border-radius: var(--borda-radius); text-align: center; color: white; margin-bottom: 30px;">
                                <div style="font-size: 18px; margin-bottom: 10px; opacity: 0.9;">
                                    üéØ MARKUP CALCULADO
                                </div>
                                <div style="font-size: 48px; font-weight: bold; margin-bottom: 10px;">
                                    ${configuracoesCustos.multiplicadorMarkup.toFixed(2)}x
                                </div>
                                <div style="font-size: 16px; opacity: 0.9;">
                                    (${configuracoesCustos.markupPercentual.toFixed(1)}%)
                                </div>
                            </div>
                            
                            <h4 style="margin-bottom: 15px;">üí° Como usar o Markup:</h4>
                            
                            <div style="background: var(--cor-info-claro); padding: 20px; border-radius: var(--borda-radius); 
                                border-left: 4px solid var(--cor-info); margin-bottom: 20px;">
                                <p style="margin: 0 0 15px 0; font-size: 15px;">
                                    <strong>Exemplo Pr√°tico:</strong>
                                </p>
                                <table style="width: 100%; font-size: 15px;">
                                    <tr>
                                        <td>Custo dos Ingredientes:</td>
                                        <td style="text-align: right;">R$ 50,00</td>
                                    </tr>
                                    <tr>
                                        <td><strong>√ó Multiplicador (${configuracoesCustos.multiplicadorMarkup.toFixed(2)}x):</strong></td>
                                        <td style="text-align: right;"><strong>${formatarMoeda(50 * configuracoesCustos.multiplicadorMarkup)}</strong></td>
                                    </tr>
                                    <tr style="border-top: 2px solid var(--cor-borda);">
                                        <td><strong>= Pre√ßo Sugerido:</strong></td>
                                        <td style="text-align: right; font-size: 20px; color: var(--cor-primaria); font-weight: bold;">
                                            ${formatarMoeda(50 * configuracoesCustos.multiplicadorMarkup)}
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            
                            <div class="notification notification-info">
                                ‚ÑπÔ∏è O markup ser√° aplicado automaticamente nos seus produtos. Voc√™ sempre 
                                poder√° ajustar manualmente o pre√ßo final se necess√°rio.
                            </div>
                        `}
                    </div>
                </div>
            `;
            
            // Configurar tabs
            configurarTabsConfiguracoes();
            
            // Configurar formul√°rios
            configurarFormularioCustos();
            configurarFormularioMeta();
            
            // Atualizar preview ao digitar
            atualizarPreviewCustos();
        }
        
        /**
         * CONFIGURA TABS DE CONFIGURA√á√ïES
         */
        function configurarTabsConfiguracoes() {
            const tabButtons = document.querySelectorAll('#configuracoes-page .tab-button');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    tabButtons.forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('#configuracoes-page .tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    const tabContent = document.getElementById('tab-' + tabId);
                    if (tabContent) {
                        tabContent.classList.add('active');
                    }
                });
            });
        }
        
        /**
         * CONFIGURA FORMUL√ÅRIO DE CUSTOS FIXOS
         */
        function configurarFormularioCustos() {
            const form = document.getElementById('form-custos-fixos');
            if (!form) return;
            
            // Inputs para atualizar preview
            const inputs = [
                'config-salario',
                'config-aluguel',
                'config-luz',
                'config-agua',
                'config-gas',
                'config-internet',
                'config-outros'
            ];
            
            inputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', atualizarPreviewCustos);
                }
            });
            
            // Submit do formul√°rio
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const dados = {
                    salarioDesejado: document.getElementById('config-salario').value,
                    aluguel: document.getElementById('config-aluguel').value,
                    luz: document.getElementById('config-luz').value,
                    agua: document.getElementById('config-agua').value,
                    gas: document.getElementById('config-gas').value,
                    internet: document.getElementById('config-internet').value,
                    outros: document.getElementById('config-outros').value,
                    metaProducao: configuracoesCustos.metaProducao,
                    margemLucroDesejada: configuracoesCustos.margemLucroDesejada
                };
                
                if (salvarConfiguracoesCustos(dados)) {
                    // Recarregar p√°gina para mostrar novo markup
                    carregarPaginaConfiguracoes();
                    
                    // Ir para aba de resumo
                    setTimeout(() => {
                        document.querySelector('#configuracoes-page .tab-button[data-tab="resumo-markup"]').click();
                    }, 100);
                }
            });
        }
        
        /**
         * CONFIGURA FORMUL√ÅRIO DE META
         */
        function configurarFormularioMeta() {
            const form = document.getElementById('form-meta-producao');
            if (!form) return;
            
            // Atualizar preview ao mudar meta
            const inputMeta = document.getElementById('config-meta');
            if (inputMeta) {
                inputMeta.addEventListener('input', function() {
                    const meta = parseFloat(this.value) || 1;
                    const total = configuracoesCustos.fixos.total;
                    const custoUnidade = total / meta;
                    
                    const preview = document.getElementById('preview-custo-por-unidade');
                    if (preview) {
                        preview.textContent = formatarMoeda(custoUnidade);
                    }
                });
            }
            
            // Submit
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const dados = {
                    ...configuracoesCustos.fixos,
                    metaProducao: document.getElementById('config-meta').value,
                    margemLucroDesejada: document.getElementById('config-margem').value
                };
                
                if (salvarConfiguracoesCustos(dados)) {
                    // Recarregar p√°gina
                    carregarPaginaConfiguracoes();
                    
                    // Ir para aba de resumo
                    setTimeout(() => {
                        document.querySelector('#configuracoes-page .tab-button[data-tab="resumo-markup"]').click();
                    }, 100);
                }
            });
        }
        
        /**
         * ATUALIZA PREVIEW DE CUSTOS
         */
        function atualizarPreviewCustos() {
            const salario = parseFloat(document.getElementById('config-salario')?.value) || 0;
            const aluguel = parseFloat(document.getElementById('config-aluguel')?.value) || 0;
            const luz = parseFloat(document.getElementById('config-luz')?.value) || 0;
            const agua = parseFloat(document.getElementById('config-agua')?.value) || 0;
            const gas = parseFloat(document.getElementById('config-gas')?.value) || 0;
            const internet = parseFloat(document.getElementById('config-internet')?.value) || 0;
            const outros = parseFloat(document.getElementById('config-outros')?.value) || 0;
            
            const total = salario + aluguel + luz + agua + gas + internet + outros;
            
            const previewElement = document.getElementById('preview-total-fixos');
            if (previewElement) {
                previewElement.textContent = formatarMoeda(total);
            }
        }
        
        console.log('‚úÖ M√≥dulo de Configura√ß√µes carregado');

        // ====================================
        // P√ÅGINA DE CLIENTES (CRM)
        // ====================================
        
        /**
         * CARREGA P√ÅGINA DE CLIENTES
         */
        function carregarPaginaClientes() {
            const page = document.getElementById('clientes-page');
            if (!page) return;
            
            page.innerHTML = `
                <h2>üë• Gest√£o de Clientes (CRM)</h2>
                
                <div class="tab-buttons">
                    <button class="tab-button active" data-tab="lista-clientes">üìã Lista de Clientes</button>
                    <button class="tab-button" data-tab="novo-cliente">‚ûï Novo Cliente</button>
                    <button class="tab-button" data-tab="estatisticas-clientes">üìä Estat√≠sticas</button>
                </div>
                
                <!-- TAB: Lista de Clientes -->
                <div class="tab-content active" id="tab-lista-clientes">
                    <div class="card">
                        <h3>Lista de Clientes</h3>
                        
                        <!-- Filtros -->
                        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                            <input type="text" id="pesquisar-clientes" class="form-control" 
                                placeholder="üîç Pesquisar por nome, telefone..." style="flex: 1; min-width: 200px;">
                            
                            <select id="filtro-nivel-cliente" class="form-control" style="width: 180px;">
                                <option value="">Todos os n√≠veis</option>
                                <option value="bronze">ü•â Bronze</option>
                                <option value="prata">ü•à Prata</option>
                                <option value="ouro">ü•á Ouro</option>
                                <option value="diamante">üíé Diamante</option>
                            </select>
                            
                            <select id="ordenar-clientes" class="form-control" style="width: 180px;">
                                <option value="nome">Nome (A-Z)</option>
                                <option value="totalGasto">Maior Gasto</option>
                                <option value="totalPedidos">Mais Pedidos</option>
                                <option value="recente">Mais Recente</option>
                            </select>
                        </div>
                        
                        <div id="lista-clientes-cards">
                            ${renderizarListaClientes()}
                        </div>
                    </div>
                </div>
                
                <!-- TAB: Novo Cliente -->
                <div class="tab-content" id="tab-novo-cliente">
                    <div class="card">
                        <h3 id="titulo-form-cliente">‚ûï Cadastrar Novo Cliente</h3>
                        
                        <form id="form-cliente">
                            <input type="hidden" id="cliente-id" value="">
                            
                            <h4 style="margin-bottom: 15px; color: var(--cor-primaria);">üìã Dados B√°sicos</h4>
                            
                            <div class="form-group">
                                <label for="cliente-nome">Nome Completo: *</label>
                                <input type="text" id="cliente-nome" class="form-control" 
                                    placeholder="Ex: Maria Silva" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="cliente-telefone">Telefone: *</label>
                                        <input type="tel" id="cliente-telefone" class="form-control" 
                                            placeholder="(00) 00000-0000" required>
                                        <small style="color: var(--cor-texto-claro);">
                                            Ser√° usado para identificar o cliente nas vendas
                                        </small>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="cliente-email">Email:</label>
                                        <input type="email" id="cliente-email" class="form-control" 
                                            placeholder="cliente@email.com">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="cliente-cpf">CPF:</label>
                                        <input type="text" id="cliente-cpf" class="form-control" 
                                            placeholder="000.000.000-00">
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="cliente-data-nascimento">Data de Nascimento:</label>
                                        <input type="date" id="cliente-data-nascimento" class="form-control">
                                        <small style="color: var(--cor-texto-claro);">
                                            Para enviar felicita√ß√µes
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="cliente-endereco">Endere√ßo Completo:</label>
                                <input type="text" id="cliente-endereco" class="form-control" 
                                    placeholder="Rua, n√∫mero, bairro, cidade">
                            </div>
                            
                            <h4 style="margin-top: 25px; margin-bottom: 15px; color: var(--cor-primaria);">
                                üè∑Ô∏è Informa√ß√µes Adicionais
                            </h4>
                            
                            <div class="form-group">
                                <label for="cliente-tags">Tags:</label>
                                <input type="text" id="cliente-tags" class="form-control" 
                                    placeholder="Ex: VIP, Corporativo, Eventos (separar por v√≠rgula)">
                                <small style="color: var(--cor-texto-claro);">
                                    Use tags para organizar seus clientes
                                </small>
                            </div>
                            
                            <div class="form-group">
                                <label for="cliente-observacoes">Observa√ß√µes:</label>
                                <textarea id="cliente-observacoes" class="form-control" rows="3" 
                                    placeholder="Ex: Al√©rgica a nozes, prefere chocolate meio amargo"></textarea>
                            </div>
                            
                            <div style="margin-top: 25px; display: flex; gap: 10px;">
                                <button type="submit" class="btn btn-primary">üíæ Salvar Cliente</button>
                                <button type="button" class="btn btn-secondary" onclick="cancelarEdicaoCliente()">
                                    ‚ùå Cancelar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- TAB: Estat√≠sticas -->
                <div class="tab-content" id="tab-estatisticas-clientes">
                    <div class="card">
                        <h3>üìä Estat√≠sticas de Clientes</h3>
                        ${renderizarEstatisticasClientes()}
                    </div>
                </div>
            `;
            
            // Configurar tabs
            configurarTabsClientes();
            
            // Configurar formul√°rio
            configurarFormularioCliente();
            
            // Configurar filtros
            configurarFiltrosClientes();
        }
        
        /**
         * RENDERIZA LISTA DE CLIENTES
         */
        function renderizarListaClientes() {
            const clientesAtivos = clientes.filter(c => c.ativo);
            
            if (clientesAtivos.length === 0) {
                return `
                    <div style="text-align: center; padding: 40px; color: var(--cor-texto-claro);">
                        <div style="font-size: 48px; margin-bottom: 10px;">üë•</div>
                        <p>Nenhum cliente cadastrado ainda.</p>
                        <button class="btn btn-primary" onclick="document.querySelector('.tab-button[data-tab=\\'novo-cliente\\']').click()">
                            ‚ûï Cadastrar Primeiro Cliente
                        </button>
                    </div>
                `;
            }
            
            let html = '';
            
            // Agrupar por n√≠vel
            const porNivel = {
                diamante: [],
                ouro: [],
                prata: [],
                bronze: []
            };
            
            clientesAtivos.forEach(cliente => {
                porNivel[cliente.nivel].push(cliente);
            });
            
            // Renderizar cada grupo
            Object.keys(porNivel).forEach(nivelId => {
                const clientesNivel = porNivel[nivelId];
                if (clientesNivel.length === 0) return;
                
                const nivelInfo = getNivelInfo(nivelId);
                
                html += `
                    <h4 style="margin: 20px 0 15px 0; color: var(--cor-primaria);">
                        ${nivelInfo.icone} ${nivelInfo.nome} (${clientesNivel.length})
                    </h4>
                `;
                
                clientesNivel.forEach(cliente => {
                    const progresso = calcularProgressoNivel(cliente.totalGasto);
                    const diasDesdeUltimoPedido = cliente.ultimoPedido ? 
                        Math.floor((new Date() - new Date(cliente.ultimoPedido)) / (1000 * 60 * 60 * 24)) : null;
                    
                    html += `
                        <div class="card" style="margin-bottom: 15px; border-left: 4px solid ${nivelInfo.cor};">
                            <div style="display: flex; justify-content: space-between; align-items: start; gap: 20px;">
                                <!-- Informa√ß√µes Principais -->
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                        <div style="font-size: 32px;">${nivelInfo.icone}</div>
                                        <div>
                                            <h4 style="margin: 0;">${cliente.nome}</h4>
                                            <div style="font-size: 13px; color: var(--cor-texto-claro);">
                                                ${cliente.telefone ? `üìû ${cliente.telefone}` : ''}
                                                ${cliente.email ? ` ‚Ä¢ üìß ${cliente.email}` : ''}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    ${cliente.tags && cliente.tags.length > 0 ? `
                                        <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px;">
                                            ${cliente.tags.map(tag => `
                                                <span class="badge badge-info">${tag}</span>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                    
                                    <!-- Estat√≠sticas -->
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
                                        gap: 15px; margin-top: 15px; padding: 15px; background: var(--cor-fundo); 
                                        border-radius: var(--borda-radius);">
                                        <div>
                                            <div style="font-size: 12px; color: var(--cor-texto-claro);">Total Gasto</div>
                                            <div style="font-size: 18px; font-weight: bold; color: var(--cor-primaria);">
                                                ${formatarMoeda(cliente.totalGasto)}
                                            </div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: var(--cor-texto-claro);">Pedidos</div>
                                            <div style="font-size: 18px; font-weight: bold;">
                                                ${cliente.totalPedidos}
                                            </div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: var(--cor-texto-claro);">Ticket M√©dio</div>
                                            <div style="font-size: 18px; font-weight: bold;">
                                                ${formatarMoeda(cliente.ticketMedio)}
                                            </div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: var(--cor-texto-claro);">√öltimo Pedido</div>
                                            <div style="font-size: 14px; font-weight: 600;">
                                                ${diasDesdeUltimoPedido !== null ? 
                                                    diasDesdeUltimoPedido === 0 ? 'Hoje' :
                                                    diasDesdeUltimoPedido === 1 ? 'Ontem' :
                                                    `H√° ${diasDesdeUltimoPedido} dias` 
                                                    : 'Nunca'}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Progresso para Pr√≥ximo N√≠vel -->
                                    ${progresso.proximoNivel ? `
                                        <div style="margin-top: 15px; padding: 10px; background: var(--cor-secundaria-clara); 
                                            border-radius: var(--borda-radius);">
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                                <small style="font-weight: 600;">
                                                    Progresso para ${getNivelInfo(progresso.proximoNivel).icone} ${getNivelInfo(progresso.proximoNivel).nome}
                                                </small>
                                                <small style="font-weight: 600; color: var(--cor-primaria);">
                                                    Faltam ${formatarMoeda(progresso.faltaParaProximo)}
                                                </small>
                                            </div>
                                            <div style="width: 100%; height: 8px; background: var(--cor-borda); 
                                                border-radius: 4px; overflow: hidden;">
                                                <div style="width: ${progresso.progresso}%; height: 100%; 
                                                    background: var(--cor-primaria); transition: width 0.3s;"></div>
                                            </div>
                                        </div>
                                    ` : `
                                        <div style="margin-top: 15px; padding: 10px; background: var(--cor-sucesso-claro); 
                                            border-radius: var(--borda-radius); text-align: center;">
                                            <strong style="color: var(--cor-sucesso);">
                                                ‚ú® N√≠vel m√°ximo alcan√ßado!
                                            </strong>
                                        </div>
                                    `}
                                </div>
                                
                                <!-- Benef√≠cios -->
                                <div style="min-width: 200px;">
                                    <div style="background: ${nivelInfo.cor}22; padding: 15px; 
                                        border-radius: var(--borda-radius); border: 2px solid ${nivelInfo.cor};">
                                        <div style="font-weight: bold; margin-bottom: 10px; color: ${nivelInfo.cor};">
                                            üéÅ Benef√≠cios
                                        </div>
                                        <ul style="margin: 0; padding-left: 20px; font-size: 13px;">
                                            ${nivelInfo.beneficios.map(b => `<li>${b}</li>`).join('')}
                                        </ul>
                                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid ${nivelInfo.cor};">
                                            <strong style="font-size: 20px; color: ${nivelInfo.cor};">
                                                ${nivelInfo.desconto}% OFF
                                            </strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- A√ß√µes -->
                            <div style="margin-top: 15px; display: flex; gap: 5px; flex-wrap: wrap;">
                                <button class="btn btn-primary btn-sm" onclick="verDetalhesCliente('${cliente.id}')">
                                    üëÅÔ∏è Ver Hist√≥rico
                                </button>
                                <button class="btn btn-success btn-sm" onclick="editarCliente('${cliente.id}')">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="if(removerCliente('${cliente.id}')) carregarPaginaClientes();">
                                    üóëÔ∏è Remover
                                </button>
                            </div>
                        </div>
                    `;
                });
            });
            
            return html;
        }
        
        /**
         * RENDERIZA ESTAT√çSTICAS GERAIS
         */
        function renderizarEstatisticasClientes() {
            const clientesAtivos = clientes.filter(c => c.ativo);
            
            if (clientesAtivos.length === 0) {
                return '<p style="text-align: center; color: var(--cor-texto-claro);">Nenhum cliente para exibir estat√≠sticas.</p>';
            }
            
            // Calcular estat√≠sticas
            const totalClientes = clientesAtivos.length;
            const faturamentoTotal = clientesAtivos.reduce((sum, c) => sum + c.totalGasto, 0);
            const ticketMedioGeral = faturamentoTotal / totalClientes;
            
            // Contar por n√≠vel
            const porNivel = {
                bronze: clientesAtivos.filter(c => c.nivel === 'bronze').length,
                prata: clientesAtivos.filter(c => c.nivel === 'prata').length,
                ouro: clientesAtivos.filter(c => c.nivel === 'ouro').length,
                diamante: clientesAtivos.filter(c => c.nivel === 'diamante').length
            };
            
            // Top 5 clientes
            const top5 = [...clientesAtivos]
                .sort((a, b) => b.totalGasto - a.totalGasto)
                .slice(0, 5);
            
            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
                    gap: 20px; margin-bottom: 30px;">
                    
                    <div style="background: var(--cor-fundo); padding: 20px; border-radius: var(--borda-radius); text-align: center;">
                        <div style="font-size: 14px; color: var(--cor-texto-claro);">Total de Clientes</div>
                        <div style="font-size: 32px; font-weight: bold; color: var(--cor-primaria);">
                            ${totalClientes}
                        </div>
                    </div>
                    
                    <div style="background: var(--cor-fundo); padding: 20px; border-radius: var(--borda-radius); text-align: center;">
                        <div style="font-size: 14px; color: var(--cor-texto-claro);">Faturamento Total</div>
                        <div style="font-size: 28px; font-weight: bold; color: var(--cor-sucesso);">
                            ${formatarMoeda(faturamentoTotal)}
                        </div>
                    </div>
                    
                    <div style="background: var(--cor-fundo); padding: 20px; border-radius: var(--borda-radius); text-align: center;">
                        <div style="font-size: 14px; color: var(--cor-texto-claro);">Ticket M√©dio</div>
                        <div style="font-size: 28px; font-weight: bold; color: var(--cor-info);">
                            ${formatarMoeda(ticketMedioGeral)}
                        </div>
                    </div>
                </div>
                
                <h4 style="margin-bottom: 15px;">üìä Distribui√ß√£o por N√≠vel</h4>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
                    gap: 15px; margin-bottom: 30px;">
                    
                    ${Object.keys(porNivel).map(nivelId => {
                        const info = getNivelInfo(nivelId);
                        const qtd = porNivel[nivelId];
                        const percentual = (qtd / totalClientes) * 100;
                        
                        return `
                            <div style="background: ${info.cor}22; padding: 15px; border-radius: var(--borda-radius); 
                                border-left: 4px solid ${info.cor}; text-align: center;">
                                <div style="font-size: 32px;">${info.icone}</div>
                                <div style="font-weight: bold; margin: 5px 0;">${info.nome}</div>
                                <div style="font-size: 24px; font-weight: bold; color: ${info.cor};">
                                    ${qtd}
                                </div>
                                <div style="font-size: 13px; color: var(--cor-texto-claro);">
                                    ${percentual.toFixed(1)}%
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <h4 style="margin-bottom: 15px;">üèÜ Top 5 Clientes</h4>
                
                <table>
                    <thead>
                        <tr>
                            <th>Posi√ß√£o</th>
                            <th>Cliente</th>
                            <th>N√≠vel</th>
                            <th>Total Gasto</th>
                            <th>Pedidos</th>
                            <th>Ticket M√©dio</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${top5.map((cliente, index) => {
                            const info = getNivelInfo(cliente.nivel);
                            const medalhas = ['ü•á', 'ü•à', 'ü•â', '4Ô∏è‚É£', '5Ô∏è‚É£'];
                            
                            return `
                                <tr>
                                    <td style="font-size: 24px; text-align: center;">${medalhas[index]}</td>
                                    <td><strong>${cliente.nome}</strong></td>
                                    <td>${info.icone} ${info.nome}</td>
                                    <td style="font-weight: bold; color: var(--cor-primaria);">
                                        ${formatarMoeda(cliente.totalGasto)}
                                    </td>
                                    <td>${cliente.totalPedidos}</td>
                                    <td>${formatarMoeda(cliente.ticketMedio)}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }
        
        console.log('‚úÖ M√≥dulo de CRM carregado');

        /**
         * CONFIGURA TABS DE CLIENTES
         */
        function configurarTabsClientes() {
            const tabButtons = document.querySelectorAll('#clientes-page .tab-button');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    tabButtons.forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('#clientes-page .tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    const tabContent = document.getElementById('tab-' + tabId);
                    if (tabContent) {
                        tabContent.classList.add('active');
                    }
                });
            });
        }
        
        /**
         * CONFIGURA FORMUL√ÅRIO DE CLIENTE
         */
        function configurarFormularioCliente() {
            const form = document.getElementById('form-cliente');
            if (!form) return;
            
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const dados = {
                    id: document.getElementById('cliente-id').value || null,
                    nome: document.getElementById('cliente-nome').value,
                    telefone: document.getElementById('cliente-telefone').value,
                    email: document.getElementById('cliente-email').value,
                    cpf: document.getElementById('cliente-cpf').value,
                    endereco: document.getElementById('cliente-endereco').value,
                    dataNascimento: document.getElementById('cliente-data-nascimento').value || null,
                    observacoes: document.getElementById('cliente-observacoes').value,
                    tags: document.getElementById('cliente-tags').value
                        .split(',')
                        .map(t => t.trim())
                        .filter(t => t.length > 0)
                };
                
                if (salvarCliente(dados)) {
                    // Limpar formul√°rio
                    form.reset();
                    document.getElementById('cliente-id').value = '';
                    document.getElementById('titulo-form-cliente').textContent = '‚ûï Cadastrar Novo Cliente';
                    
                    // Voltar para lista
                    document.querySelector('#clientes-page .tab-button[data-tab="lista-clientes"]').click();
                    
                    // Recarregar p√°gina
                    carregarPaginaClientes();
                }
            });
        }
        
        /**
         * CONFIGURA FILTROS DE CLIENTES
         */
        function configurarFiltrosClientes() {
            const inputPesquisa = document.getElementById('pesquisar-clientes');
            const selectNivel = document.getElementById('filtro-nivel-cliente');
            const selectOrdem = document.getElementById('ordenar-clientes');
            
            function aplicarFiltros() {
                const termo = inputPesquisa?.value.toLowerCase() || '';
                const nivelFiltro = selectNivel?.value || '';
                const ordem = selectOrdem?.value || 'nome';
                
                let clientesFiltrados = clientes.filter(c => c.ativo);
                
                // Filtrar por termo de busca
                if (termo) {
                    clientesFiltrados = clientesFiltrados.filter(c => {
                        const nome = c.nome.toLowerCase();
                        const telefone = (c.telefone || '').toLowerCase();
                        const email = (c.email || '').toLowerCase();
                        return nome.includes(termo) || telefone.includes(termo) || email.includes(termo);
                    });
                }
                
                // Filtrar por n√≠vel
                if (nivelFiltro) {
                    clientesFiltrados = clientesFiltrados.filter(c => c.nivel === nivelFiltro);
                }
                
                // Ordenar
                clientesFiltrados.sort((a, b) => {
                    switch(ordem) {
                        case 'nome':
                            return a.nome.localeCompare(b.nome);
                        case 'totalGasto':
                            return b.totalGasto - a.totalGasto;
                        case 'totalPedidos':
                            return b.totalPedidos - a.totalPedidos;
                        case 'recente':
                            return new Date(b.atualizadoEm) - new Date(a.atualizadoEm);
                        default:
                            return 0;
                    }
                });
                
                // Atualizar visualiza√ß√£o
                const container = document.getElementById('lista-clientes-cards');
                if (container) {
                    if (clientesFiltrados.length === 0) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: var(--cor-texto-claro);">
                                <p>Nenhum cliente encontrado com os filtros aplicados.</p>
                            </div>
                        `;
                    } else {
                        // Renderizar clientes filtrados
                        let html = '';
                        
                        // Agrupar por n√≠vel
                        const porNivel = {
                            diamante: [],
                            ouro: [],
                            prata: [],
                            bronze: []
                        };
                        
                        clientesFiltrados.forEach(cliente => {
                            porNivel[cliente.nivel].push(cliente);
                        });
                        
                        // Renderizar cada grupo
                        Object.keys(porNivel).forEach(nivelId => {
                            const clientesNivel = porNivel[nivelId];
                            if (clientesNivel.length === 0) return;
                            
                            const nivelInfo = getNivelInfo(nivelId);
                            
                            html += `
                                <h4 style="margin: 20px 0 15px 0; color: var(--cor-primaria);">
                                    ${nivelInfo.icone} ${nivelInfo.nome} (${clientesNivel.length})
                                </h4>
                            `;
                            
                            clientesNivel.forEach(cliente => {
                                const progresso = calcularProgressoNivel(cliente.totalGasto);
                                const diasDesdeUltimoPedido = cliente.ultimoPedido ? 
                                    Math.floor((new Date() - new Date(cliente.ultimoPedido)) / (1000 * 60 * 60 * 24)) : null;
                                
                                html += `
                                    <div class="card" style="margin-bottom: 15px; border-left: 4px solid ${nivelInfo.cor};">
                                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 20px;">
                                            <div style="flex: 1;">
                                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                                    <div style="font-size: 32px;">${nivelInfo.icone}</div>
                                                    <div>
                                                        <h4 style="margin: 0;">${cliente.nome}</h4>
                                                        <div style="font-size: 13px; color: var(--cor-texto-claro);">
                                                            ${cliente.telefone ? `üìû ${cliente.telefone}` : ''}
                                                            ${cliente.email ? ` ‚Ä¢ üìß ${cliente.email}` : ''}
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                ${cliente.tags && cliente.tags.length > 0 ? `
                                                    <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px;">
                                                        ${cliente.tags.map(tag => `
                                                            <span class="badge badge-info">${tag}</span>
                                                        `).join('')}
                                                    </div>
                                                ` : ''}
                                                
                                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
                                                    gap: 15px; margin-top: 15px; padding: 15px; background: var(--cor-fundo); 
                                                    border-radius: var(--borda-radius);">
                                                    <div>
                                                        <div style="font-size: 12px; color: var(--cor-texto-claro);">Total Gasto</div>
                                                        <div style="font-size: 18px; font-weight: bold; color: var(--cor-primaria);">
                                                            ${formatarMoeda(cliente.totalGasto)}
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <div style="font-size: 12px; color: var(--cor-texto-claro);">Pedidos</div>
                                                        <div style="font-size: 18px; font-weight: bold;">
                                                            ${cliente.totalPedidos}
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <div style="font-size: 12px; color: var(--cor-texto-claro);">Ticket M√©dio</div>
                                                        <div style="font-size: 18px; font-weight: bold;">
                                                            ${formatarMoeda(cliente.ticketMedio)}
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <div style="font-size: 12px; color: var(--cor-texto-claro);">√öltimo Pedido</div>
                                                        <div style="font-size: 14px; font-weight: 600;">
                                                            ${diasDesdeUltimoPedido !== null ? 
                                                                diasDesdeUltimoPedido === 0 ? 'Hoje' :
                                                                diasDesdeUltimoPedido === 1 ? 'Ontem' :
                                                                `H√° ${diasDesdeUltimoPedido} dias` 
                                                                : 'Nunca'}
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                ${progresso.proximoNivel ? `
                                                    <div style="margin-top: 15px; padding: 10px; background: var(--cor-secundaria-clara); 
                                                        border-radius: var(--borda-radius);">
                                                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                                            <small style="font-weight: 600;">
                                                                Progresso para ${getNivelInfo(progresso.proximoNivel).icone} ${getNivelInfo(progresso.proximoNivel).nome}
                                                            </small>
                                                            <small style="font-weight: 600; color: var(--cor-primaria);">
                                                                Faltam ${formatarMoeda(progresso.faltaParaProximo)}
                                                            </small>
                                                        </div>
                                                        <div style="width: 100%; height: 8px; background: var(--cor-borda); 
                                                            border-radius: 4px; overflow: hidden;">
                                                            <div style="width: ${progresso.progresso}%; height: 100%; 
                                                                background: var(--cor-primaria); transition: width 0.3s;"></div>
                                                        </div>
                                                    </div>
                                                ` : `
                                                    <div style="margin-top: 15px; padding: 10px; background: var(--cor-sucesso-claro); 
                                                        border-radius: var(--borda-radius); text-align: center;">
                                                        <strong style="color: var(--cor-sucesso);">
                                                            ‚ú® N√≠vel m√°ximo alcan√ßado!
                                                        </strong>
                                                    </div>
                                                `}
                                            </div>
                                            
                                            <div style="min-width: 200px;">
                                                <div style="background: ${nivelInfo.cor}22; padding: 15px; 
                                                    border-radius: var(--borda-radius); border: 2px solid ${nivelInfo.cor};">
                                                    <div style="font-weight: bold; margin-bottom: 10px; color: ${nivelInfo.cor};">
                                                        üéÅ Benef√≠cios
                                                    </div>
                                                    <ul style="margin: 0; padding-left: 20px; font-size: 13px;">
                                                        ${nivelInfo.beneficios.map(b => `<li>${b}</li>`).join('')}
                                                    </ul>
                                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid ${nivelInfo.cor};">
                                                        <strong style="font-size: 20px; color: ${nivelInfo.cor};">
                                                            ${nivelInfo.desconto}% OFF
                                                        </strong>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div style="margin-top: 15px; display: flex; gap: 5px; flex-wrap: wrap;">
                                            <button class="btn btn-primary btn-sm" onclick="verDetalhesCliente('${cliente.id}')">
                                                üëÅÔ∏è Ver Hist√≥rico
                                            </button>
                                            <button class="btn btn-success btn-sm" onclick="editarCliente('${cliente.id}')">
                                                ‚úèÔ∏è Editar
                                            </button>
                                            <button class="btn btn-danger btn-sm" onclick="if(removerCliente('${cliente.id}')) carregarPaginaClientes();">
                                                üóëÔ∏è Remover
                                            </button>
                                        </div>
                                    </div>
                                `;
                            });
                        });
                        
                        container.innerHTML = html;
                    }
                }
            }
            
            if (inputPesquisa) inputPesquisa.addEventListener('input', aplicarFiltros);
            if (selectNivel) selectNivel.addEventListener('change', aplicarFiltros);
            if (selectOrdem) selectOrdem.addEventListener('change', aplicarFiltros);
        }
        
        /**
         * EDITAR CLIENTE
         */
        function editarCliente(clienteId) {
            const cliente = clientes.find(c => c.id === clienteId);
            if (!cliente) {
                mostrarToast('Cliente n√£o encontrado', 'error');
                return;
            }
            
            // Ir para aba de edi√ß√£o
            document.querySelector('#clientes-page .tab-button[data-tab="novo-cliente"]').click();
            
            // Preencher formul√°rio
            document.getElementById('cliente-id').value = cliente.id;
            document.getElementById('cliente-nome').value = cliente.nome;
            document.getElementById('cliente-telefone').value = cliente.telefone || '';
            document.getElementById('cliente-email').value = cliente.email || '';
            document.getElementById('cliente-cpf').value = cliente.cpf || '';
            document.getElementById('cliente-endereco').value = cliente.endereco || '';
            document.getElementById('cliente-data-nascimento').value = cliente.dataNascimento || '';
            document.getElementById('cliente-observacoes').value = cliente.observacoes || '';
            document.getElementById('cliente-tags').value = (cliente.tags || []).join(', ');
            
            // Atualizar t√≠tulo
            document.getElementById('titulo-form-cliente').textContent = '‚úèÔ∏è Editar Cliente';
            
            // Scroll
            document.getElementById('tab-novo-cliente').scrollIntoView({ behavior: 'smooth' });
        }
        
        /**
         * CANCELAR EDI√á√ÉO DE CLIENTE
         */
        function cancelarEdicaoCliente() {
            document.getElementById('form-cliente').reset();
            document.getElementById('cliente-id').value = '';
            document.getElementById('titulo-form-cliente').textContent = '‚ûï Cadastrar Novo Cliente';
        }
        
        /**
         * VER DETALHES DO CLIENTE
         */
        function verDetalhesCliente(clienteId) {
            const cliente = clientes.find(c => c.id === clienteId);
            if (!cliente) {
                mostrarToast('Cliente n√£o encontrado', 'error');
                return;
            }
            
            const nivelInfo = getNivelInfo(cliente.nivel);
            const progresso = calcularProgressoNivel(cliente.totalGasto);
            
            // Buscar vendas do cliente
            const vendasCliente = vendas.filter(v => {
                if (v.cancelada) return false;
                
                // Verificar por ID ou telefone
                if (v.cliente) {
                    return v.cliente.id === clienteId || 
                           (v.cliente.telefone && cliente.telefone && 
                            v.cliente.telefone.replace(/\D/g, '') === cliente.telefone.replace(/\D/g, ''));
                }
                return false;
            }).sort((a, b) => new Date(b.dataVenda) - new Date(a.dataVenda));
            
            // Criar modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>üë§ ${cliente.nome}</h3>
                        <button class="modal-close" onclick="this.parentElement.parentElement.parentElement.remove()">√ó</button>
                    </div>
                    
                    <!-- Informa√ß√µes do Cliente -->
                    <div style="background: ${nivelInfo.cor}22; padding: 20px; border-radius: var(--borda-radius); 
                        border-left: 4px solid ${nivelInfo.cor}; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                            <div style="font-size: 48px;">${nivelInfo.icone}</div>
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 5px 0;">${nivelInfo.nome}</h4>
                                <div style="font-weight: bold; font-size: 20px; color: ${nivelInfo.cor};">
                                    ${nivelInfo.desconto}% de desconto
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div>
                                <small style="color: var(--cor-texto-claro);">Total Gasto</small>
                                <div style="font-size: 20px; font-weight: bold; color: var(--cor-primaria);">
                                    ${formatarMoeda(cliente.totalGasto)}
                                </div>
                            </div>
                            <div>
                                <small style="color: var(--cor-texto-claro);">Total de Pedidos</small>
                                <div style="font-size: 20px; font-weight: bold;">
                                    ${cliente.totalPedidos}
                                </div>
                            </div>
                            <div>
                                <small style="color: var(--cor-texto-claro);">Ticket M√©dio</small>
                                <div style="font-size: 20px; font-weight: bold;">
                                    ${formatarMoeda(cliente.ticketMedio)}
                                </div>
                            </div>
                        </div>
                        
                        ${progresso.proximoNivel ? `
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid ${nivelInfo.cor};">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <small style="font-weight: 600;">
                                        Progresso para ${getNivelInfo(progresso.proximoNivel).icone} ${getNivelInfo(progresso.proximoNivel).nome}
                                    </small>
                                    <small style="font-weight: 600; color: var(--cor-primaria);">
                                        Faltam ${formatarMoeda(progresso.faltaParaProximo)}
                                    </small>
                                </div>
                                <div style="width: 100%; height: 10px; background: var(--cor-borda); 
                                    border-radius: 5px; overflow: hidden;">
                                    <div style="width: ${progresso.progresso}%; height: 100%; 
                                        background: var(--cor-primaria); transition: width 0.3s;"></div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Dados de Contato -->
                    <h4 style="margin-bottom: 10px;">üìû Dados de Contato</h4>
                    <table style="width: 100%; margin-bottom: 20px; font-size: 15px;">
                        ${cliente.telefone ? `<tr><td><strong>Telefone:</strong></td><td>${cliente.telefone}</td></tr>` : ''}
                        ${cliente.email ? `<tr><td><strong>Email:</strong></td><td>${cliente.email}</td></tr>` : ''}
                        ${cliente.cpf ? `<tr><td><strong>CPF:</strong></td><td>${cliente.cpf}</td></tr>` : ''}
                        ${cliente.endereco ? `<tr><td><strong>Endere√ßo:</strong></td><td>${cliente.endereco}</td></tr>` : ''}
                        ${cliente.dataNascimento ? `<tr><td><strong>Anivers√°rio:</strong></td><td>${formatarData(cliente.dataNascimento)}</td></tr>` : ''}
                    </table>
                    
                    ${cliente.observacoes ? `
                        <h4 style="margin-bottom: 10px;">üìù Observa√ß√µes</h4>
                        <div style="background: var(--cor-aviso-claro); padding: 15px; border-radius: var(--borda-radius); 
                            margin-bottom: 20px; border-left: 4px solid var(--cor-aviso);">
                            ${cliente.observacoes}
                        </div>
                    ` : ''}
                    
                    <!-- Hist√≥rico de Compras -->
                    <h4 style="margin-bottom: 10px;">üõçÔ∏è Hist√≥rico de Compras (${vendasCliente.length})</h4>
                    
                    ${vendasCliente.length === 0 ? `
                        <p style="text-align: center; color: var(--cor-texto-claro); padding: 20px;">
                            Nenhuma compra registrada ainda.
                        </p>
                    ` : `
                        <table>
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Produtos</th>
                                    <th>Valor</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${vendasCliente.map(venda => `
                                    <tr>
                                        <td>${formatarData(venda.dataVenda)}</td>
                                        <td>
                                            ${venda.produtos && venda.produtos.length > 0 ? 
                                                venda.produtos.map(p => `${p.quantidade}${p.unidade} ${p.produtoNome}`).join('<br>') 
                                                : 
                                                `${venda.quantidade}x ${venda.receitaNome}`
                                            }
                                        </td>
                                        <td style="font-weight: bold;">${formatarMoeda(venda.valorTotal)}</td>
                                        <td>
                                            <span class="badge badge-${venda.statusEntrega === 'entregue' ? 'success' : 'warning'}">
                                                ${venda.statusEntrega === 'entregue' ? '‚úÖ Entregue' : 'üü° Pendente'}
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `}
                    
                    <div style="margin-top: 25px; display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="editarCliente('${cliente.id}'); this.parentElement.parentElement.parentElement.remove();">
                            ‚úèÔ∏è Editar Cliente
                        </button>
                        <button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">
                            ‚ùå Fechar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // ====================================
        // SISTEMA DE REVENDEDORES
        // ====================================
        
        /**
         * SALVA OU ATUALIZA REVENDEDOR
         */
        function salvarRevendedor(dados) {
            try {
                // Valida√ß√µes
                if (!dados.nome || dados.nome.trim() === '') {
                    throw new Error('Nome do revendedor √© obrigat√≥rio');
                }
                
                if (!dados.telefone || dados.telefone.trim() === '') {
                    throw new Error('Telefone √© obrigat√≥rio');
                }
                
                const percentualComissao = parseFloat(dados.percentualComissao);
                if (isNaN(percentualComissao) || percentualComissao < 0 || percentualComissao > 100) {
                    throw new Error('Percentual de comiss√£o deve estar entre 0 e 100');
                }
                
                const agora = new Date().toISOString();
                
                if (dados.id) {
                    // ATUALIZAR EXISTENTE
                    const index = revendedores.findIndex(r => r.id === dados.id);
                    if (index === -1) throw new Error('Revendedor n√£o encontrado');
                    
                    revendedores[index] = {
                        ...revendedores[index],
                        nome: dados.nome.trim(),
                        telefone: dados.telefone.trim(),
                        email: dados.email || '',
                        cpf: dados.cpf || '',
                        endereco: dados.endereco || '',
                        percentualComissao: percentualComissao,
                        pix: dados.pix || '',
                        observacoes: dados.observacoes || '',
                        atualizadoEm: agora
                    };
                    
                    mostrarToast('Revendedor atualizado com sucesso!', 'success');
                    
                } else {
                    // CRIAR NOVO
                    const novoRevendedor = {
                        id: gerarId(),
                        nome: dados.nome.trim(),
                        telefone: dados.telefone.trim(),
                        email: dados.email || '',
                        cpf: dados.cpf || '',
                        endereco: dados.endereco || '',
                        percentualComissao: percentualComissao,
                        pix: dados.pix || '',
                        observacoes: dados.observacoes || '',
                        
                        // Estat√≠sticas
                        totalVendas: 0,
                        faturamentoTotal: 0,
                        comissaoTotal: 0,
                        comissaoPaga: 0,
                        comissaoPendente: 0,
                        ultimaVenda: null,
                        
                        // Controle
                        ativo: true,
                        criadoEm: agora,
                        atualizadoEm: agora
                    };
                    
                    revendedores.push(novoRevendedor);
                    mostrarToast('Revendedor cadastrado com sucesso!', 'success');
                }
                
                // Salvar
                salvarLocalStorage();
                sincronizarComNuvem();
                
                return true;
                
            } catch (erro) {
                console.error('Erro ao salvar revendedor:', erro);
                mostrarToast(erro.message, 'error');
                return false;
            }
        }
        
        /**
         * ATUALIZA ESTAT√çSTICAS DO REVENDEDOR ap√≥s uma venda
         */
        function atualizarEstatisticasRevendedor(revendedorId, valorVenda) {
            try {
                const revendedor = revendedores.find(r => r.id === revendedorId);
                if (!revendedor) return false;
                
                // Calcular comiss√£o
                const comissao = valorVenda * (revendedor.percentualComissao / 100);
                
                // Atualizar estat√≠sticas
                revendedor.totalVendas += 1;
                revendedor.faturamentoTotal += valorVenda;
                revendedor.comissaoTotal += comissao;
                revendedor.comissaoPendente += comissao;
                revendedor.ultimaVenda = new Date().toISOString();
                
                // Salvar
                salvarLocalStorage();
                
                console.log('‚úÖ Estat√≠sticas do revendedor atualizadas:', revendedor.nome);
                
                return true;
                
            } catch (erro) {
                console.error('Erro ao atualizar estat√≠sticas do revendedor:', erro);
                return false;
            }
        }
        
        /**
         * REGISTRA PAGAMENTO DE COMISS√ÉO
         */
        function registrarPagamentoComissao(revendedorId, valor, observacao) {
            try {
                const revendedor = revendedores.find(r => r.id === revendedorId);
                if (!revendedor) throw new Error('Revendedor n√£o encontrado');
                
                if (valor <= 0) throw new Error('Valor deve ser maior que zero');
                if (valor > revendedor.comissaoPendente) {
                    throw new Error('Valor maior que comiss√£o pendente');
                }
                
                // Criar hist√≥rico de pagamentos se n√£o existir
                if (!revendedor.pagamentos) {
                    revendedor.pagamentos = [];
                }
                
                // Registrar pagamento
                const pagamento = {
                    id: gerarId(),
                    valor: valor,
                    data: new Date().toISOString(),
                    observacao: observacao || '',
                    registradoPor: getUsuarioAtual()
                };
                
                revendedor.pagamentos.push(pagamento);
                
                // Atualizar saldos
                revendedor.comissaoPaga += valor;
                revendedor.comissaoPendente -= valor;
                
                // Salvar
                salvarLocalStorage();
                sincronizarComNuvem();
                
                mostrarToast(`Pagamento de ${formatarMoeda(valor)} registrado!`, 'success');
                
                return true;
                
            } catch (erro) {
                console.error('Erro ao registrar pagamento:', erro);
                mostrarToast(erro.message, 'error');
                return false;
            }
        }
        
        /**
         * BUSCA REVENDEDOR POR TELEFONE
         */
        function buscarRevendedorPorTelefone(telefone) {
            if (!telefone) return null;
            
            const telNormalizado = telefone.replace(/\D/g, '');
            
            return revendedores.find(r => {
                const telRevendedor = (r.telefone || '').replace(/\D/g, '');
                return telRevendedor === telNormalizado && r.ativo;
            });
        }
        
        /**
         * REMOVE REVENDEDOR (soft delete)
         */
        function removerRevendedor(revendedorId) {
            try {
                const revendedor = revendedores.find(r => r.id === revendedorId);
                if (!revendedor) throw new Error('Revendedor n√£o encontrado');
                
                // Verificar se tem vendas
                const vendasRevendedor = vendas.filter(v => v.revendedorId === revendedorId);
                
                if (vendasRevendedor.length > 0) {
                    const confirma = confirm(
                        `O revendedor "${revendedor.nome}" tem ${vendasRevendedor.length} venda(s) registrada(s).\n\n` +
                        `Deseja realmente remover? O hist√≥rico de vendas ser√° mantido.`
                    );
                    
                    if (!confirma) return false;
                }
                
                // Verificar comiss√£o pendente
                if (revendedor.comissaoPendente > 0) {
                    const confirma = confirm(
                        `ATEN√á√ÉO: O revendedor tem ${formatarMoeda(revendedor.comissaoPendente)} em comiss√µes pendentes!\n\n` +
                        `Deseja realmente remover?`
                    );
                    
                    if (!confirma) return false;
                }
                
                // Soft delete
                revendedor.ativo = false;
                revendedor.removidoEm = new Date().toISOString();
                
                // Salvar
                salvarLocalStorage();
                sincronizarComNuvem();
                
                mostrarToast('Revendedor removido com sucesso!', 'success');
                return true;
                
            } catch (erro) {
                console.error('Erro ao remover revendedor:', erro);
                mostrarToast(erro.message, 'error');
                return false;
            }
        }

        /**
         * CARREGA P√ÅGINA DE REVENDEDORES
         */
        function carregarPaginaRevendedores() {
            const page = document.getElementById('revendedores-page');
            if (!page) return;
            
            page.innerHTML = `
                <h2>ü§ù Gest√£o de Revendedores</h2>
                
                <div class="tab-buttons">
                    <button class="tab-button active" data-tab="lista-revendedores">üìã Lista</button>
                    <button class="tab-button" data-tab="novo-revendedor">‚ûï Novo Revendedor</button>
                    <button class="tab-button" data-tab="comissoes">üí∞ Comiss√µes</button>
                    <button class="tab-button" data-tab="estatisticas-rev">üìä Estat√≠sticas</button>
                </div>
                
                <!-- TAB: Lista de Revendedores -->
                <div class="tab-content active" id="tab-lista-revendedores">
                    <div class="card">
                        <h3>Lista de Revendedores</h3>
                        
                        <!-- Filtros -->
                        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                            <input type="text" id="pesquisar-revendedores" class="form-control" 
                                placeholder="üîç Pesquisar por nome, telefone..." style="flex: 1; min-width: 200px;">
                            
                            <select id="ordenar-revendedores" class="form-control" style="width: 200px;">
                                <option value="nome">Nome (A-Z)</option>
                                <option value="totalVendas">Mais Vendas</option>
                                <option value="faturamento">Maior Faturamento</option>
                                <option value="comissaoPendente">Comiss√£o Pendente</option>
                                <option value="recente">Mais Recente</option>
                            </select>
                        </div>
                        
                        <div id="lista-revendedores-cards">
                            ${renderizarListaRevendedores()}
                        </div>
                    </div>
                </div>
                
                <!-- TAB: Novo Revendedor -->
                <div class="tab-content" id="tab-novo-revendedor">
                    <div class="card">
                        <h3 id="titulo-form-revendedor">‚ûï Cadastrar Novo Revendedor</h3>
                        
                        <form id="form-revendedor">
                            <input type="hidden" id="revendedor-id" value="">
                            
                            <h4 style="margin-bottom: 15px; color: var(--cor-primaria);">üìã Dados B√°sicos</h4>
                            
                            <div class="form-group">
                                <label for="revendedor-nome">Nome Completo: *</label>
                                <input type="text" id="revendedor-nome" class="form-control" 
                                    placeholder="Ex: Jo√£o Silva" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="revendedor-telefone">Telefone: *</label>
                                        <input type="tel" id="revendedor-telefone" class="form-control" 
                                            placeholder="(00) 00000-0000" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="revendedor-email">Email:</label>
                                        <input type="email" id="revendedor-email" class="form-control" 
                                            placeholder="revendedor@email.com">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="revendedor-cpf">CPF:</label>
                                        <input type="text" id="revendedor-cpf" class="form-control" 
                                            placeholder="000.000.000-00">
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="revendedor-pix">Chave PIX:</label>
                                        <input type="text" id="revendedor-pix" class="form-control" 
                                            placeholder="CPF, telefone ou email">
                                        <small style="color: var(--cor-texto-claro);">
                                            Para pagamento de comiss√µes
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="revendedor-endereco">Endere√ßo Completo:</label>
                                <input type="text" id="revendedor-endereco" class="form-control" 
                                    placeholder="Rua, n√∫mero, bairro, cidade">
                            </div>
                            
                            <h4 style="margin-top: 25px; margin-bottom: 15px; color: var(--cor-primaria);">
                                üí∞ Comiss√£o
                            </h4>
                            
                            <div class="form-group">
                                <label for="revendedor-comissao">Percentual de Comiss√£o (%): *</label>
                                <input type="number" id="revendedor-comissao" class="form-control" 
                                    min="0" max="100" step="0.1" value="10" required>
                                <small style="color: var(--cor-texto-claro);">
                                    üí° Ex: 10% significa que a cada R$ 100 em vendas, o revendedor recebe R$ 10
                                </small>
                            </div>
                            
                            <div id="simulacao-comissao" style="background: var(--cor-info-claro); padding: 15px; 
                                border-radius: var(--borda-radius); margin-top: 10px;">
                                <h4 style="margin: 0 0 10px 0;">üí° Simula√ß√£o</h4>
                                <table style="width: 100%; font-size: 15px;">
                                    <tr>
                                        <td>Venda de R$ 100,00</td>
                                        <td style="text-align: right; font-weight: bold;" id="sim-100">R$ 10,00</td>
                                    </tr>
                                    <tr>
                                        <td>Venda de R$ 500,00</td>
                                        <td style="text-align: right; font-weight: bold;" id="sim-500">R$ 50,00</td>
                                    </tr>
                                    <tr>
                                        <td>Venda de R$ 1.000,00</td>
                                        <td style="text-align: right; font-weight: bold;" id="sim-1000">R$ 100,00</td>
                                    </tr>
                                </table>
                            </div>
                            
                            <h4 style="margin-top: 25px; margin-bottom: 15px; color: var(--cor-primaria);">
                                üìù Observa√ß√µes
                            </h4>
                            
                            <div class="form-group">
                                <label for="revendedor-observacoes">Observa√ß√µes:</label>
                                <textarea id="revendedor-observacoes" class="form-control" rows="3" 
                                    placeholder="Ex: Atende regi√£o norte, foco em festas corporativas"></textarea>
                            </div>
                            
                            <div style="margin-top: 25px; display: flex; gap: 10px;">
                                <button type="submit" class="btn btn-primary">üíæ Salvar Revendedor</button>
                                <button type="button" class="btn btn-secondary" onclick="cancelarEdicaoRevendedor()">
                                    ‚ùå Cancelar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- TAB: Comiss√µes -->
                <div class="tab-content" id="tab-comissoes">
                    <div class="card">
                        <h3>üí∞ Controle de Comiss√µes</h3>
                        ${renderizarControleComissoes()}
                    </div>
                </div>
                
                <!-- TAB: Estat√≠sticas -->
                <div class="tab-content" id="tab-estatisticas-rev">
                    <div class="card">
                        <h3>üìä Estat√≠sticas de Revendedores</h3>
                        ${renderizarEstatisticasRevendedores()}
                    </div>
                </div>
            `;
            
            // Configurar tabs
            configurarTabsRevendedores();
            
            // Configurar formul√°rio
            configurarFormularioRevendedor();
            
            // Configurar filtros
            configurarFiltrosRevendedores();
        }
        
        /**
         * RENDERIZA LISTA DE REVENDEDORES
         */
        function renderizarListaRevendedores() {
            const revendedoresAtivos = revendedores.filter(r => r.ativo);
            
            if (revendedoresAtivos.length === 0) {
                return `
                    <div style="text-align: center; padding: 40px; color: var(--cor-texto-claro);">
                        <div style="font-size: 48px; margin-bottom: 10px;">ü§ù</div>
                        <p>Nenhum revendedor cadastrado ainda.</p>
                        <button class="btn btn-primary" onclick="document.querySelector('.tab-button[data-tab=\\'novo-revendedor\\']').click()">
                            ‚ûï Cadastrar Primeiro Revendedor
                        </button>
                    </div>
                `;
            }
            
            let html = '';
            
            revendedoresAtivos.forEach(revendedor => {
                const ticketMedio = (revendedor.totalVendas > 0) ? (revendedor.faturamentoTotal / revendedor.totalVendas) : 0;
                
                const diasDesdeUltimaVenda = revendedor.ultimaVenda ? 
                    Math.floor((new Date() - new Date(revendedor.ultimaVenda)) / (1000 * 60 * 60 * 24)) : null;
                
                html += `
                    <div class="card" style="margin-bottom: 15px; border-left: 4px solid var(--cor-primaria);">
                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 20px; flex-wrap: wrap;">
                            <!-- Informa√ß√µes Principais -->
                            <div style="flex: 1; min-width: 250px;">
                                <h4 style="margin: 0 0 5px 0;">${revendedor.nome}</h4>
                                <div style="font-size: 13px; color: var(--cor-texto-claro); margin-bottom: 15px;">
                                    ${revendedor.telefone ? `üìû ${revendedor.telefone}` : ''}
                                    ${revendedor.email ? ` ‚Ä¢ üìß ${revendedor.email}` : ''}
                                </div>
                                
                                <!-- Estat√≠sticas -->
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
                                    gap: 15px; padding: 15px; background: var(--cor-fundo); border-radius: var(--borda-radius);">
                                    <div>
                                        <div style="font-size: 12px; color: var(--cor-texto-claro);">Total Vendas</div>
                                        <div style="font-size: 18px; font-weight: bold;">
                                            ${revendedor.totalVendas}
                                        </div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: var(--cor-texto-claro);">Faturamento</div>
                                        <div style="font-size: 18px; font-weight: bold; color: var(--cor-primaria);">
                                            ${formatarMoeda(revendedor.faturamentoTotal)}
                                        </div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: var(--cor-texto-claro);">Ticket M√©dio</div>
                                        <div style="font-size: 18px; font-weight: bold;">
                                            ${formatarMoeda(ticketMedio)}
                                        </div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: var(--cor-texto-claro);">√öltima Venda</div>
                                        <div style="font-size: 14px; font-weight: 600;">
                                            ${diasDesdeUltimaVenda !== null ? 
                                                diasDesdeUltimaVenda === 0 ? 'Hoje' :
                                                diasDesdeUltimaVenda === 1 ? 'Ontem' :
                                                `H√° ${diasDesdeUltimaVenda} dias` 
                                                : 'Nunca'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Comiss√µes -->
                            <div style="min-width: 220px;">
                                <div style="background: var(--cor-sucesso-claro); padding: 15px; 
                                    border-radius: var(--borda-radius); border: 2px solid var(--cor-sucesso);">
                                    <div style="text-align: center; margin-bottom: 10px;">
                                        <div style="font-size: 32px; font-weight: bold; color: var(--cor-sucesso);">
                                            ${revendedor.percentualComissao}%
                                        </div>
                                        <div style="font-size: 12px; color: var(--cor-texto-claro);">
                                            de comiss√£o
                                        </div>
                                    </div>
                                    
                                    <table style="width: 100%; font-size: 13px;">
                                        <tr>
                                            <td>Total:</td>
                                            <td style="text-align: right; font-weight: bold;">
                                                ${formatarMoeda(revendedor.comissaoTotal)}
                                            </td>
                                        </tr>
                                        <tr style="color: var(--cor-sucesso);">
                                            <td>Pago:</td>
                                            <td style="text-align: right; font-weight: bold;">
                                                ${formatarMoeda(revendedor.comissaoPaga)}
                                            </td>
                                        </tr>
                                        <tr style="color: var(--cor-aviso);">
                                            <td><strong>Pendente:</strong></td>
                                            <td style="text-align: right; font-weight: bold; font-size: 16px;">
                                                ${formatarMoeda(revendedor.comissaoPendente)}
                                            </td>
                                        </tr>
                                    </table>
                                    
                                    ${revendedor.comissaoPendente > 0 ? `
                                        <button class="btn btn-success btn-sm" style="width: 100%; margin-top: 10px;" 
                                            onclick="abrirModalPagamentoComissao('${revendedor.id}')">
                                            üí∞ Registrar Pagamento
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <!-- A√ß√µes -->
                        <div style="margin-top: 15px; display: flex; gap: 5px; flex-wrap: wrap;">
                            <button class="btn btn-primary btn-sm" onclick="verDetalhesRevendedor('${revendedor.id}')">
                                üëÅÔ∏è Ver Hist√≥rico
                            </button>
                            <button class="btn btn-success btn-sm" onclick="editarRevendedor('${revendedor.id}')">
                                ‚úèÔ∏è Editar
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="if(removerRevendedor('${revendedor.id}')) carregarPaginaRevendedores();">
                                üóëÔ∏è Remover
                            </button>
                        </div>
                    </div>
                `;
            });
            
            return html;
        }
        
        /**
         * RENDERIZA CONTROLE DE COMISS√ïES
         */
        function renderizarControleComissoes() {
            const revendedoresAtivos = revendedores.filter(r => r.ativo);
            
            if (revendedoresAtivos.length === 0) {
                return '<p style="text-align: center; color: var(--cor-texto-claro);">Nenhum revendedor cadastrado.</p>';
            }
            
            // Calcular totais
            const totalComissoes = revendedoresAtivos.reduce((sum, r) => sum + r.comissaoTotal, 0);
            const totalPago = revendedoresAtivos.reduce((sum, r) => sum + r.comissaoPaga, 0);
            const totalPendente = revendedoresAtivos.reduce((sum, r) => sum + r.comissaoPendente, 0);
            
            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
                    gap: 20px; margin-bottom: 30px;">
                    
                    <div style="background: var(--cor-fundo); padding: 20px; border-radius: var(--borda-radius); text-align: center;">
                        <div style="font-size: 14px; color: var(--cor-texto-claro);">Total em Comiss√µes</div>
                        <div style="font-size: 28px; font-weight: bold; color: var(--cor-primaria);">
                            ${formatarMoeda(totalComissoes)}
                        </div>
                    </div>
                    
                    <div style="background: var(--cor-sucesso-claro); padding: 20px; border-radius: var(--borda-radius); text-align: center;">
                        <div style="font-size: 14px; color: var(--cor-texto-claro);">Total Pago</div>
                        <div style="font-size: 28px; font-weight: bold; color: var(--cor-sucesso);">
                            ${formatarMoeda(totalPago)}
                        </div>
                    </div>
                    
                    <div style="background: var(--cor-aviso-claro); padding: 20px; border-radius: var(--borda-radius); text-align: center;">
                        <div style="font-size: 14px; color: var(--cor-texto-claro);">Total Pendente</div>
                        <div style="font-size: 28px; font-weight: bold; color: var(--cor-aviso);">
                            ${formatarMoeda(totalPendente)}
                        </div>
                    </div>
                </div>
                
                <h4 style="margin-bottom: 15px;">üí∞ Comiss√µes Pendentes por Revendedor</h4>
                
                <table>
                    <thead>
                        <tr>
                            <th>Revendedor</th>
                            <th>Comiss√£o %</th>
                            <th>Total Comiss√µes</th>
                            <th>Pago</th>
                            <th>Pendente</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Ordenar por comiss√£o pendente (maior primeiro)
            const ordenados = [...revendedoresAtivos].sort((a, b) => b.comissaoPendente - a.comissaoPendente);
            
            ordenados.forEach(revendedor => {
                html += `
                    <tr>
                        <td><strong>${revendedor.nome}</strong></td>
                        <td>${revendedor.percentualComissao}%</td>
                        <td>${formatarMoeda(revendedor.comissaoTotal)}</td>
                        <td style="color: var(--cor-sucesso);">${formatarMoeda(revendedor.comissaoPaga)}</td>
                        <td style="color: var(--cor-aviso); font-weight: bold;">
                            ${formatarMoeda(revendedor.comissaoPendente)}
                        </td>
                        <td>
                            ${revendedor.comissaoPendente > 0 ? `
                                <button class="btn btn-success btn-sm" 
                                    onclick="abrirModalPagamentoComissao('${revendedor.id}')">
                                    üí∞ Pagar
                                </button>
                            ` : `
                                <span style="color: var(--cor-sucesso);">‚úÖ Em dia</span>
                            `}
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            return html;
        }
        
        /**
         * RENDERIZA ESTAT√çSTICAS GERAIS
         */
        function renderizarEstatisticasRevendedores() {
            const revendedoresAtivos = revendedores.filter(r => r.ativo);
            
            if (revendedoresAtivos.length === 0) {
                return '<p style="text-align: center; color: var(--cor-texto-claro);">Nenhum revendedor para exibir estat√≠sticas.</p>';
            }
            
            // Calcular estat√≠sticas
            const totalRevendedores = revendedoresAtivos.length;
            const totalVendas = revendedoresAtivos.reduce((sum, r) => sum + r.totalVendas, 0);
            const faturamentoTotal = revendedoresAtivos.reduce((sum, r) => sum + r.faturamentoTotal, 0);
            const comissaoMedia = totalRevendedores > 0 ? 
                revendedoresAtivos.reduce((sum, r) => sum + r.percentualComissao, 0) / totalRevendedores : 0;
            
            // Top 5 revendedores
            const top5 = [...revendedoresAtivos]
                .sort((a, b) => b.faturamentoTotal - a.faturamentoTotal)
                .slice(0, 5);
            
            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
                    gap: 20px; margin-bottom: 30px;">
                    
                    <div style="background: var(--cor-fundo); padding: 20px; border-radius: var(--borda-radius); text-align: center;">
                        <div style="font-size: 14px; color: var(--cor-texto-claro);">Total Revendedores</div>
                        <div style="font-size: 32px; font-weight: bold; color: var(--cor-primaria);">
                            ${totalRevendedores}
                        </div>
                    </div>
                    
                    <div style="background: var(--cor-fundo); padding: 20px; border-radius: var(--borda-radius); text-align: center;">
                        <div style="font-size: 14px; color: var(--cor-texto-claro);">Total Vendas</div>
                        <div style="font-size: 32px; font-weight: bold; color: var(--cor-info);">
                            ${totalVendas}
                        </div>
                    </div>
                    
                    <div style="background: var(--cor-fundo); padding: 20px; border-radius: var(--borda-radius); text-align: center;">
                        <div style="font-size: 14px; color: var(--cor-texto-claro);">Faturamento Total</div>
                        <div style="font-size: 28px; font-weight: bold; color: var(--cor-sucesso);">
                            ${formatarMoeda(faturamentoTotal)}
                        </div>
                    </div>
                    
                    <div style="background: var(--cor-fundo); padding: 20px; border-radius: var(--borda-radius); text-align: center;">
                        <div style="font-size: 14px; color: var(--cor-texto-claro);">Comiss√£o M√©dia</div>
                        <div style="font-size: 32px; font-weight: bold; color: var(--cor-aviso);">
                            ${comissaoMedia.toFixed(1)}%
                        </div>
                    </div>
                </div>
                
                <h4 style="margin-bottom: 15px;">üèÜ Top 5 Revendedores</h4>
                
                <table>
                    <thead>
                        <tr>
                            <th>Posi√ß√£o</th>
                            <th>Revendedor</th>
                            <th>Vendas</th>
                            <th>Faturamento</th>
                            <th>Comiss√£o Total</th>
                            <th>Comiss√£o %</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${top5.map((revendedor, index) => {
                            const medalhas = ['ü•á', 'ü•à', 'ü•â', '4Ô∏è‚É£', '5Ô∏è‚É£'];
                            
                            return `
                                <tr>
                                    <td style="font-size: 24px; text-align: center;">${medalhas[index]}</td>
                                    <td><strong>${revendedor.nome}</strong></td>
                                    <td>${revendedor.totalVendas}</td>
                                    <td style="font-weight: bold; color: var(--cor-primaria);">
                                        ${formatarMoeda(revendedor.faturamentoTotal)}
                                    </td>
                                    <td style="font-weight: bold; color: var(--cor-sucesso);">
                                        ${formatarMoeda(revendedor.comissaoTotal)}
                                    </td>
                                    <td>${revendedor.percentualComissao}%</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }
        
        console.log('‚úÖ M√≥dulo de Revendedores carregado');

        /**
         * CONFIGURA TABS DE REVENDEDORES
         */
        function configurarTabsRevendedores() {
            const tabButtons = document.querySelectorAll('#revendedores-page .tab-button');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    tabButtons.forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('#revendedores-page .tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    const tabContent = document.getElementById('tab-' + tabId);
                    if (tabContent) {
                        tabContent.classList.add('active');
                    }
                });
            });
        }
        
        /**
         * CONFIGURA FORMUL√ÅRIO DE REVENDEDOR
         */
        function configurarFormularioRevendedor() {
            const form = document.getElementById('form-revendedor');
            if (!form) return;
            
            // Atualizar simula√ß√£o ao mudar comiss√£o
            const inputComissao = document.getElementById('revendedor-comissao');
            if (inputComissao) {
                inputComissao.addEventListener('input', function() {
                    const percentual = parseFloat(this.value) || 0;
                    
                    document.getElementById('sim-100').textContent = formatarMoeda(100 * percentual / 100);
                    document.getElementById('sim-500').textContent = formatarMoeda(500 * percentual / 100);
                    document.getElementById('sim-1000').textContent = formatarMoeda(1000 * percentual / 100);
                });
            }
            
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const dados = {
                    id: document.getElementById('revendedor-id').value || null,
                    nome: document.getElementById('revendedor-nome').value,
                    telefone: document.getElementById('revendedor-telefone').value,
                    email: document.getElementById('revendedor-email').value,
                    cpf: document.getElementById('revendedor-cpf').value,
                    endereco: document.getElementById('revendedor-endereco').value,
                    percentualComissao: document.getElementById('revendedor-comissao').value,
                    pix: document.getElementById('revendedor-pix').value,
                    observacoes: document.getElementById('revendedor-observacoes').value
                };
                
                if (salvarRevendedor(dados)) {
                    // Limpar formul√°rio
                    form.reset();
                    document.getElementById('revendedor-id').value = '';
                    document.getElementById('titulo-form-revendedor').textContent = '‚ûï Cadastrar Novo Revendedor';
                    
                    // Voltar para lista
                    document.querySelector('#revendedores-page .tab-button[data-tab="lista-revendedores"]').click();
                    
                    // Recarregar p√°gina
                    carregarPaginaRevendedores();
                }
            });
        }
        
        /**
         * CONFIGURA FILTROS DE REVENDEDORES
         */
        function configurarFiltrosRevendedores() {
            const inputPesquisa = document.getElementById('pesquisar-revendedores');
            const selectOrdem = document.getElementById('ordenar-revendedores');
            
            function aplicarFiltros() {
                const termo = inputPesquisa?.value.toLowerCase() || '';
                const ordem = selectOrdem?.value || 'nome';
                
                let revendedoresFiltrados = revendedores.filter(r => r.ativo);
                
                // Filtrar por termo de busca
                if (termo) {
                    revendedoresFiltrados = revendedoresFiltrados.filter(r => {
                        const nome = r.nome.toLowerCase();
                        const telefone = (r.telefone || '').toLowerCase();
                        const email = (r.email || '').toLowerCase();
                        return nome.includes(termo) || telefone.includes(termo) || email.includes(termo);
                    });
                }
                
                // Ordenar
                revendedoresFiltrados.sort((a, b) => {
                    switch(ordem) {
                        case 'nome':
                            return a.nome.localeCompare(b.nome);
                        case 'totalVendas':
                            return b.totalVendas - a.totalVendas;
                        case 'faturamento':
                            return b.faturamentoTotal - a.faturamentoTotal;
                        case 'comissaoPendente':
                            return b.comissaoPendente - a.comissaoPendente;
                        case 'recente':
                            return new Date(b.atualizadoEm) - new Date(a.atualizadoEm);
                        default:
                            return 0;
                    }
                });
                
                // Atualizar visualiza√ß√£o
                const container = document.getElementById('lista-revendedores-cards');
                if (container) {
                    if (revendedoresFiltrados.length === 0) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: var(--cor-texto-claro);">
                                <p>Nenhum revendedor encontrado com os filtros aplicados.</p>
                            </div>
                        `;
                    } else {
                        let html = '';
                        
                        revendedoresFiltrados.forEach(revendedor => {
                            const ticketMedio = (revendedor.totalVendas > 0) ? (revendedor.faturamentoTotal / revendedor.totalVendas) : 0;
                            
                            const diasDesdeUltimaVenda = revendedor.ultimaVenda ? 
                                Math.floor((new Date() - new Date(revendedor.ultimaVenda)) / (1000 * 60 * 60 * 24)) : null;
                            
                            html += `
                                <div class="card" style="margin-bottom: 15px; border-left: 4px solid var(--cor-primaria);">
                                    <div style="display: flex; justify-content: space-between; align-items: start; gap: 20px; flex-wrap: wrap;">
                                        <div style="flex: 1; min-width: 250px;">
                                            <h4 style="margin: 0 0 5px 0;">${revendedor.nome}</h4>
                                            <div style="font-size: 13px; color: var(--cor-texto-claro); margin-bottom: 15px;">
                                                ${revendedor.telefone ? `üìû ${revendedor.telefone}` : ''}
                                                ${revendedor.email ? ` ‚Ä¢ üìß ${revendedor.email}` : ''}
                                            </div>
                                            
                                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
                                                gap: 15px; padding: 15px; background: var(--cor-fundo); border-radius: var(--borda-radius);">
                                                <div>
                                                    <div style="font-size: 12px; color: var(--cor-texto-claro);">Total Vendas</div>
                                                    <div style="font-size: 18px; font-weight: bold;">
                                                        ${revendedor.totalVendas}
                                                    </div>
                                                </div>
                                                <div>
                                                    <div style="font-size: 12px; color: var(--cor-texto-claro);">Faturamento</div>
                                                    <div style="font-size: 18px; font-weight: bold; color: var(--cor-primaria);">
                                                        ${formatarMoeda(revendedor.faturamentoTotal)}
                                                    </div>
                                                </div>
                                                <div>
                                                    <div style="font-size: 12px; color: var(--cor-texto-claro);">Ticket M√©dio</div>
                                                    <div style="font-size: 18px; font-weight: bold;">
                                                        ${formatarMoeda(ticketMedio)}
                                                    </div>
                                                </div>
                                                <div>
                                                    <div style="font-size: 12px; color: var(--cor-texto-claro);">√öltima Venda</div>
                                                    <div style="font-size: 14px; font-weight: 600;">
                                                        ${diasDesdeUltimaVenda !== null ? 
                                                            diasDesdeUltimaVenda === 0 ? 'Hoje' :
                                                            diasDesdeUltimaVenda === 1 ? 'Ontem' :
                                                            \`H√° \${diasDesdeUltimaVenda} dias\` 
                                                            : 'Nunca'}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div style="min-width: 220px;">
                                            <div style="background: var(--cor-sucesso-claro); padding: 15px; 
                                                border-radius: var(--borda-radius); border: 2px solid var(--cor-sucesso);">
                                                <div style="text-align: center; margin-bottom: 10px;">
                                                    <div style="font-size: 32px; font-weight: bold; color: var(--cor-sucesso);">
                                                        ${revendedor.percentualComissao}%
                                                    </div>
                                                    <div style="font-size: 12px; color: var(--cor-texto-claro);">
                                                        de comiss√£o
                                                    </div>
                                                </div>
                                                
                                                <table style="width: 100%; font-size: 13px;">
                                                    <tr>
                                                        <td>Total:</td>
                                                        <td style="text-align: right; font-weight: bold;">
                                                            ${formatarMoeda(revendedor.comissaoTotal)}
                                                        </td>
                                                    </tr>
                                                    <tr style="color: var(--cor-sucesso);">
                                                        <td>Pago:</td>
                                                        <td style="text-align: right; font-weight: bold;">
                                                            ${formatarMoeda(revendedor.comissaoPaga)}
                                                        </td>
                                                    </tr>
                                                    <tr style="color: var(--cor-aviso);">
                                                        <td><strong>Pendente:</strong></td>
                                                        <td style="text-align: right; font-weight: bold; font-size: 16px;">
                                                            ${formatarMoeda(revendedor.comissaoPendente)}
                                                        </td>
                                                    </tr>
                                                </table>
                                                
                                                ${revendedor.comissaoPendente > 0 ? \`
                                                    <button class="btn btn-success btn-sm" style="width: 100%; margin-top: 10px;" 
                                                        onclick="abrirModalPagamentoComissao('\${revendedor.id}')">
                                                        üí∞ Registrar Pagamento
                                                    </button>
                                                \` : ''}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-top: 15px; display: flex; gap: 5px; flex-wrap: wrap;">
                                        <button class="btn btn-primary btn-sm" onclick="verDetalhesRevendedor('${revendedor.id}')">
                                            üëÅÔ∏è Ver Hist√≥rico
                                        </button>
                                        <button class="btn btn-success btn-sm" onclick="editarRevendedor('${revendedor.id}')">
                                            ‚úèÔ∏è Editar
                                        </button>
                                        <button class="btn btn-danger btn-sm" onclick="if(removerRevendedor('${revendedor.id}')) carregarPaginaRevendedores();">
                                            üóëÔ∏è Remover
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                        
                        container.innerHTML = html;
                    }
                }
            }
            
            if (inputPesquisa) inputPesquisa.addEventListener('input', aplicarFiltros);
            if (selectOrdem) selectOrdem.addEventListener('change', aplicarFiltros);
        }
        
        /**
         * EDITAR REVENDEDOR
         */
        function editarRevendedor(revendedorId) {
            const revendedor = revendedores.find(r => r.id === revendedorId);
            if (!revendedor) {
                mostrarToast('Revendedor n√£o encontrado', 'error');
                return;
            }
            
            // Ir para aba de edi√ß√£o
            document.querySelector('#revendedores-page .tab-button[data-tab="novo-revendedor"]').click();
            
            // Preencher formul√°rio
            document.getElementById('revendedor-id').value = revendedor.id;
            document.getElementById('revendedor-nome').value = revendedor.nome;
            document.getElementById('revendedor-telefone').value = revendedor.telefone || '';
            document.getElementById('revendedor-email').value = revendedor.email || '';
            document.getElementById('revendedor-cpf').value = revendedor.cpf || '';
            document.getElementById('revendedor-endereco').value = revendedor.endereco || '';
            document.getElementById('revendedor-comissao').value = revendedor.percentualComissao;
            document.getElementById('revendedor-pix').value = revendedor.pix || '';
            document.getElementById('revendedor-observacoes').value = revendedor.observacoes || '';
            
            // Atualizar simula√ß√£o
            document.getElementById('sim-100').textContent = formatarMoeda(100 * revendedor.percentualComissao / 100);
            document.getElementById('sim-500').textContent = formatarMoeda(500 * revendedor.percentualComissao / 100);
            document.getElementById('sim-1000').textContent = formatarMoeda(1000 * revendedor.percentualComissao / 100);
            
            // Atualizar t√≠tulo
            document.getElementById('titulo-form-revendedor').textContent = '‚úèÔ∏è Editar Revendedor';
            
            // Scroll
            document.getElementById('tab-novo-revendedor').scrollIntoView({ behavior: 'smooth' });
        }
        
        /**
         * CANCELAR EDI√á√ÉO DE REVENDEDOR
         */
        function cancelarEdicaoRevendedor() {
            document.getElementById('form-revendedor').reset();
            document.getElementById('revendedor-id').value = '';
            document.getElementById('titulo-form-revendedor').textContent = '‚ûï Cadastrar Novo Revendedor';
            
            // Resetar simula√ß√£o
            document.getElementById('sim-100').textContent = formatarMoeda(10);
            document.getElementById('sim-500').textContent = formatarMoeda(50);
            document.getElementById('sim-1000').textContent = formatarMoeda(100);
        }
        
        /**
         * ABRIR MODAL DE PAGAMENTO DE COMISS√ÉO
         */
        function abrirModalPagamentoComissao(revendedorId) {
            const revendedor = revendedores.find(r => r.id === revendedorId);
            if (!revendedor) {
                mostrarToast('Revendedor n√£o encontrado', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>üí∞ Registrar Pagamento de Comiss√£o</h3>
                        <button class="modal-close" onclick="this.parentElement.parentElement.parentElement.remove()">√ó</button>
                    </div>
                    
                    <div style="background: var(--cor-info-claro); padding: 15px; border-radius: var(--borda-radius); 
                        margin-bottom: 20px; border-left: 4px solid var(--cor-info);">
                        <h4 style="margin: 0 0 10px 0;">${revendedor.nome}</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                            <div>
                                <strong>Comiss√£o Total:</strong><br>
                                ${formatarMoeda(revendedor.comissaoTotal)}
                            </div>
                            <div>
                                <strong>J√° Pago:</strong><br>
                                <span style="color: var(--cor-sucesso);">${formatarMoeda(revendedor.comissaoPaga)}</span>
                            </div>
                        </div>
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--cor-info);">
                            <strong>Pendente:</strong>
                            <div style="font-size: 24px; font-weight: bold; color: var(--cor-aviso);">
                                ${formatarMoeda(revendedor.comissaoPendente)}
                            </div>
                        </div>
                    </div>
                    
                    ${revendedor.pix ? `
                        <div style="background: var(--cor-sucesso-claro); padding: 15px; border-radius: var(--borda-radius); 
                            margin-bottom: 20px; border-left: 4px solid var(--cor-sucesso);">
                            <strong>üí≥ Chave PIX:</strong><br>
                            <span style="font-size: 18px; font-family: monospace;">${revendedor.pix}</span>
                            <button class="btn btn-secondary btn-sm" style="margin-left: 10px;" 
                                onclick="navigator.clipboard.writeText('${revendedor.pix}'); mostrarToast('PIX copiado!', 'success')">
                                üìã Copiar
                            </button>
                        </div>
                    ` : ''}
                    
                    <form id="form-pagamento-comissao">
                        <div class="form-group">
                            <label for="valor-pagamento">Valor do Pagamento: *</label>
                            <input type="number" id="valor-pagamento" class="form-control" 
                                min="0.01" max="${revendedor.comissaoPendente}" step="0.01" 
                                value="${revendedor.comissaoPendente}" required>
                            <small style="color: var(--cor-texto-claro);">
                                M√°ximo: ${formatarMoeda(revendedor.comissaoPendente)}
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label for="obs-pagamento">Observa√ß√£o:</label>
                            <textarea id="obs-pagamento" class="form-control" rows="2" 
                                placeholder="Ex: Pagamento via PIX, comprovante #123"></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="submit" class="btn btn-success">üí∞ Confirmar Pagamento</button>
                            <button type="button" class="btn btn-secondary" 
                                onclick="this.closest('.modal-overlay').remove()">‚ùå Cancelar</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Configurar formul√°rio
            const form = modal.querySelector('#form-pagamento-comissao');
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const valor = parseFloat(document.getElementById('valor-pagamento').value);
                const obs = document.getElementById('obs-pagamento').value;
                
                if (registrarPagamentoComissao(revendedorId, valor, obs)) {
                    modal.remove();
                    carregarPaginaRevendedores();
                    
                    // Ir para aba de comiss√µes
                    setTimeout(() => {
                        document.querySelector('#revendedores-page .tab-button[data-tab="comissoes"]')?.click();
                    }, 100);
                }
            });
        }
        
        /**
         * VER DETALHES DO REVENDEDOR
         */
        function verDetalhesRevendedor(revendedorId) {
            const revendedor = revendedores.find(r => r.id === revendedorId);
            if (!revendedor) {
                mostrarToast('Revendedor n√£o encontrado', 'error');
                return;
            }
            
            // Buscar vendas do revendedor
            const vendasRevendedor = vendas.filter(v => 
                !v.cancelada && v.revendedorId === revendedorId
            ).sort((a, b) => new Date(b.dataVenda) - new Date(a.dataVenda));
            
            const ticketMedio = (revendedor.totalVendas > 0) ? (revendedor.faturamentoTotal / revendedor.totalVendas) : 0;
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>ü§ù ${revendedor.nome}</h3>
                        <button class="modal-close" onclick="this.parentElement.parentElement.parentElement.remove()">√ó</button>
                    </div>
                    
                    <!-- Estat√≠sticas -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
                        gap: 15px; margin-bottom: 20px;">
                        <div style="background: var(--cor-fundo); padding: 15px; border-radius: var(--borda-radius); text-align: center;">
                            <small style="color: var(--cor-texto-claro);">Comiss√£o</small>
                            <div style="font-size: 24px; font-weight: bold; color: var(--cor-sucesso);">
                                ${revendedor.percentualComissao}%
                            </div>
                        </div>
                        <div style="background: var(--cor-fundo); padding: 15px; border-radius: var(--borda-radius); text-align: center;">
                            <small style="color: var(--cor-texto-claro);">Total Vendas</small>
                            <div style="font-size: 24px; font-weight: bold;">
                                ${revendedor.totalVendas}
                            </div>
                        </div>
                        <div style="background: var(--cor-fundo); padding: 15px; border-radius: var(--borda-radius); text-align: center;">
                            <small style="color: var(--cor-texto-claro);">Faturamento</small>
                            <div style="font-size: 20px; font-weight: bold; color: var(--cor-primaria);">
                                ${formatarMoeda(revendedor.faturamentoTotal)}
                            </div>
                        </div>
                        <div style="background: var(--cor-fundo); padding: 15px; border-radius: var(--borda-radius); text-align: center;">
                            <small style="color: var(--cor-texto-claro);">Ticket M√©dio</small>
                            <div style="font-size: 20px; font-weight: bold;">
                                ${formatarMoeda(ticketMedio)}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Comiss√µes -->
                    <div style="background: var(--cor-sucesso-claro); padding: 20px; border-radius: var(--borda-radius); 
                        margin-bottom: 20px; border-left: 4px solid var(--cor-sucesso);">
                        <h4 style="margin: 0 0 15px 0;">üí∞ Comiss√µes</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                            <div>
                                <strong>Total:</strong><br>
                                ${formatarMoeda(revendedor.comissaoTotal)}
                            </div>
                            <div>
                                <strong style="color: var(--cor-sucesso);">Pago:</strong><br>
                                ${formatarMoeda(revendedor.comissaoPaga)}
                            </div>
                            <div>
                                <strong style="color: var(--cor-aviso);">Pendente:</strong><br>
                                <span style="font-size: 20px;">${formatarMoeda(revendedor.comissaoPendente)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dados de Contato -->
                    <h4 style="margin-bottom: 10px;">üìû Dados de Contato</h4>
                    <table style="width: 100%; margin-bottom: 20px; font-size: 15px;">
                        ${revendedor.telefone ? `<tr><td><strong>Telefone:</strong></td><td>${revendedor.telefone}</td></tr>` : ''}
                        ${revendedor.email ? `<tr><td><strong>Email:</strong></td><td>${revendedor.email}</td></tr>` : ''}
                        ${revendedor.cpf ? `<tr><td><strong>CPF:</strong></td><td>${revendedor.cpf}</td></tr>` : ''}
                        ${revendedor.pix ? `<tr><td><strong>PIX:</strong></td><td>${revendedor.pix}</td></tr>` : ''}
                        ${revendedor.endereco ? `<tr><td><strong>Endere√ßo:</strong></td><td>${revendedor.endereco}</td></tr>` : ''}
                    </table>
                    
                    ${revendedor.observacoes ? `
                        <h4 style="margin-bottom: 10px;">üìù Observa√ß√µes</h4>
                        <div style="background: var(--cor-aviso-claro); padding: 15px; border-radius: var(--borda-radius); 
                            margin-bottom: 20px; border-left: 4px solid var(--cor-aviso);">
                            ${revendedor.observacoes}
                        </div>
                    ` : ''}
                    
                    <!-- Hist√≥rico de Vendas -->
                    <h4 style="margin-bottom: 10px;">üõçÔ∏è Hist√≥rico de Vendas (${vendasRevendedor.length})</h4>
                    
                    ${vendasRevendedor.length === 0 ? `
                        <p style="text-align: center; color: var(--cor-texto-claro); padding: 20px;">
                            Nenhuma venda registrada ainda.
                        </p>
                    ` : `
                        <table>
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Cliente</th>
                                    <th>Valor Venda</th>
                                    <th>Comiss√£o</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${vendasRevendedor.map(venda => {
                                    const comissao = venda.valorTotal * (revendedor.percentualComissao / 100);
                                    return `
                                        <tr>
                                            <td>${formatarData(venda.dataVenda)}</td>
                                            <td>${venda.cliente?.nome || 'N/A'}</td>
                                            <td style="font-weight: bold;">${formatarMoeda(venda.valorTotal)}</td>
                                            <td style="font-weight: bold; color: var(--cor-sucesso);">
                                                ${formatarMoeda(comissao)}
                                            </td>
                                            <td>
                                                <span class="badge badge-${venda.statusEntrega === 'entregue' ? 'success' : 'warning'}">
                                                    ${venda.statusEntrega === 'entregue' ? '‚úÖ Entregue' : 'üü° Pendente'}
                                                </span>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `}
                    
                    <div style="margin-top: 25px; display: flex; gap: 10px;">
                        ${revendedor.comissaoPendente > 0 ? `
                            <button class="btn btn-success" onclick="abrirModalPagamentoComissao('${revendedor.id}'); this.closest('.modal-overlay').remove();">
                                üí∞ Registrar Pagamento
                            </button>
                        ` : ''}
                        <button class="btn btn-primary" onclick="editarRevendedor('${revendedor.id}'); this.closest('.modal-overlay').remove();">
                            ‚úèÔ∏è Editar Revendedor
                        </button>
                        <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">
                            ‚ùå Fechar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // ====================================
        // INICIALIZA√á√ÉO FINAL DO SISTEMA
        // ====================================
        
        console.log('');
        console.log('üéÇ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('   SISTEMA DEIA CAKES v2.0 - TOTALMENTE CARREGADO');
        console.log('üéÇ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('');
        console.log('‚úÖ M√≥dulos carregados:');
        console.log('   1. Base + Firebase');
        console.log('   2. Autentica√ß√£o Hier√°rquica');
        console.log('   3. Materiais + Estoque');
        console.log('   4. Sub-Receitas üÜï'); // NOVO
        console.log('   5. Produtos Finais üÜï'); // NOVO
        console.log('   6. Vendas (M√∫ltiplos Produtos) üÜï'); // ATUALIZADO
        console.log('   7. Calend√°rio de Entregas');
        console.log('');
        console.log('üì¶ Funcionalidades dispon√≠veis:');
        console.log('   ‚Ä¢ Sistema ADM/Usu√°rio');
        console.log('   ‚Ä¢ Pre√ßo m√©dio ponderado correto');
        console.log('   ‚Ä¢ Estoque calculado em tempo real');
        console.log('   ‚Ä¢ Sub-receitas reutiliz√°veis üÜï'); // NOVO
        console.log('   ‚Ä¢ Produtos com precifica√ß√£o flex√≠vel (peso/unidade) üÜï'); // NOVO
        console.log('   ‚Ä¢ Vendas com m√∫ltiplos produtos üÜï'); // NOVO
        console.log('   ‚Ä¢ Custos vol√°teis ‚Üí congelados na venda');
        console.log('   ‚Ä¢ Scanner de c√≥digo de barras');
        console.log('   ‚Ä¢ Valida√ß√£o de estoque antes de vender');
        console.log('   ‚Ä¢ Sincroniza√ß√£o inteligente');
        console.log('   ‚Ä¢ Calend√°rio visual de entregas');
        console.log('');
        console.log('üöÄ Sistema pronto para uso!');
        console.log('');
    </script>
</body>
</html>

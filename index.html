<!-- PARTE 1 HTML-->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deia Cakes Controle Gerencial</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- Bibliotecas originais -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.4/html5-qrcode.min.js"></script>
    <style>
        /* Estilos Gerais */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #ff85a2;
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .header-logo {
            display: flex;
            align-items: center;
        }
        
        .header-logo img {
            height: 60px;
            margin-left: 15px;
        }
        
        nav {
            background-color: #ffb5c8;
            padding: 10px 0;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        nav ul li {
            margin-right: 20px;
        }
        
        nav ul li a {
            color: #333;
            text-decoration: none;
            font-weight: 500;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        
        nav ul li a:hover, nav ul li a.active {
            background-color: #ff85a2;
            color: white;
        }
        
        h1, h2, h3 {
            margin-top: 0;
            color: #333;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            padding: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 2px;
        }
        
        .btn-primary {
            background-color: #ff85a2;
            color: white;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        table th, table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        table th {
            background-color: #f4f4f4;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Estilos de Página */
        .page-content {
            display: none;
        }
        
        .page-content.active {
            display: block;
        }
        
        /* Estilos do Scanner */
        #reader {
            width: 100%;
            height: 300px;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .scanner-container {
            margin-top: 20px;
        }
        
        /* Estilos de Formulários */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .form-row {
            display: flex;
            margin: 0 -10px;
        }
        
        .form-col {
            flex: 1;
            padding: 0 10px;
        }
        
        /* Animações */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        /* Notificações */
        .notification {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .notification-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .notification-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .notification-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        .notification-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* Estilos para Receitas */
        .recipe-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        
        .recipe-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        
        .ingredients-table {
            margin-top: 10px;
        }
        
        .tab-buttons {
            display: flex;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: 10px 20px;
            border: none;
            background-color: #f1f1f1;
            cursor: pointer;
            transition: background-color 0.3s;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        .tab-button.active {
            background-color: #ff85a2;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        /* Modal para carregamento e feedback */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            max-width: 80%;
            width: 500px;
            text-align: center;
        }
        
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #ff85a2;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Estilos para área de vendas */
        .sale-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .sale-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .sale-title {
            font-weight: bold;
            font-size: 18px;
        }
        
        .sale-date {
            color: #666;
        }
        
        .sale-details {
            margin-top: 10px;
        }
        
        /* Novas classes para preços de receitas */
        .recipe-pricing {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        
        .recipe-price-item {
            text-align: center;
            flex: 1;
        }
        
        .recipe-price-label {
            font-size: 12px;
            color: #666;
        }
        
        .recipe-price-value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        
        .recipe-price-value.highlight {
            color: #ff85a2;
        }
        
        /* Estilos para tela de login */
        #user-info {
            position: absolute;
            top: 10px;
            right: 20px;
            color: white;
            font-size: 14px;
        }
        
        #btn-logout {
            margin-left: 10px;
            background: transparent;
            border: 1px solid white;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            cursor: pointer;
        }
        
        #login-form {
            max-width: 400px;
            margin: 50px auto;
        }
        
        /* Novo estilo para resumo de vendas */
        .venda-resumo-financeiro {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            border: 1px solid #ddd;
        }
        
        .venda-resumo-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .venda-resumo-item {
            text-align: center;
        }
        
        .venda-resumo-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .venda-resumo-valor {
            font-size: 18px;
            font-weight: bold;
        }
        
        .venda-resumo-valor.lucro-positivo {
            color: #28a745;
        }
        
        .venda-resumo-valor.lucro-negativo {
            color: #dc3545;
        }
        
        /* Estilos para histórico de materiais */
        .material-historico-toggle {
            margin-left: 10px;
            font-size: 12px;
            cursor: pointer;
            color: #6c757d;
            text-decoration: underline;
        }
        
        .material-historico-container {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        /* NOVOS ESTILOS ADICIONADOS */
        .preco-medio-badge {
            background-color: #e0f7fa;
            color: #0277bd;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 5px;
        }
        
        .material-detalhes {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .estoque-unificado {
            background-color: #f0f8ff;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        .ingrediente-preco-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 3px;
            font-size: 12px;
            color: #666;
        }
        
        /* Estilo para notificações tipo toast */
        .toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #28a745;
            color: white;
            padding: 12px 24px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 9999;
            opacity: 0;
            transform: translateY(20px);
            animation: toastIn 0.3s forwards, toastOut 0.3s forwards 2.7s;
        }
        
        @keyframes toastIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes toastOut {
            to {
                opacity: 0;
                transform: translateY(20px);
            }
        }
    </style>
</head>
<body>
    <header>
       <div class="header-content">
           <h1>Deia Cakes Controle Gerencial</h1>
           <div id="user-info" class="hidden">
               <span id="user-email"></span>
               <button id="btn-logout">Sair</button>
           </div>
           <div>
               <span id="date-time"></span>
           </div>
       </div>
    </header>
    <nav>
        <ul>
            <li><a href="#estoque" class="nav-link active" data-page="estoque">Estoque</a></li>
            <li><a href="#materiais" class="nav-link" data-page="materiais">Materiais</a></li>
            <li><a href="#receitas" class="nav-link" data-page="receitas">Receitas</a></li>
            <li><a href="#vendas" class="nav-link" data-page="vendas">Vendas</a></li>
        </ul>
    </nav>
<!-- PARTE 2: PÁGINA DOS APP-->
<!-- Página de Estoque -->
<div class="page-content" id="estoque-page">
    <h2>Gestão de Estoque</h2>
    <div class="card">
        <h3>Itens em Estoque</h3>
        <input type="text" id="pesquisar-estoque" class="form-control" placeholder="Pesquisar estoque..." style="margin-bottom: 20px;">
        <table id="tabela-estoque">
            <thead>
                <tr>
                    <th>Código</th>
                    <th>Nome</th>
                    <th>Quantidade</th>
                    <th>Unidade</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody id="itens-estoque">
                <!-- Os itens serão adicionados aqui dinamicamente -->
            </tbody>
        </table>
    </div>
</div>

<!-- Página de Materiais -->
<div class="page-content" id="materiais-page">
    <h2>Gestão de Materiais</h2>
    
    <div class="tab-buttons">
        <button class="tab-button active" data-tab="listar-materiais">Listar Materiais</button>
        <button class="tab-button" data-tab="adicionar-item">Adicionar Item</button>
    </div>
    
    <!-- Tab: Listar Materiais -->
    <div class="tab-content active" id="listar-materiais">
        <div class="card">
            <h3>Materiais Cadastrados</h3>
            <input type="text" id="pesquisar-materiais" class="form-control" placeholder="Pesquisar material..." style="margin-bottom: 20px;">
            
            <table id="tabela-materiais">
                <thead>
                    <tr>
                        <th>Código</th>
                        <th>Nome</th>
                        <th>Unidade</th>
                        <th>Un. Medida</th>
                        <th>Qtd/Unidade</th>
                        <th>Última Compra</th>
                        <th>Último Preço</th>
                        <th>Preço Médio</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="itens-materiais">
                    <!-- Os itens serão adicionados aqui dinamicamente -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Tab: Adicionar Item -->
    <div class="tab-content" id="adicionar-item">
        <div class="card">
            <h3>Adicionar Item ao Catálogo</h3>
            
            <form id="form-adicionar-material">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="codigo-material">Código:</label>
                            <input type="text" id="codigo-material" class="form-control" placeholder="Código do produto">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="scanner-btn">&nbsp;</label>
                            <button type="button" id="scanner-btn" class="btn btn-secondary form-control">Escanear Código</button>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="nome-material">Nome do Material:</label>
                    <input type="text" id="nome-material" class="form-control" required>
                </div>
                
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="quantidade-material">Quantidade:</label>
                            <input type="number" id="quantidade-material" class="form-control" min="0.01" step="0.01" value="1" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="unidade-material">Unidade:</label>
                            <select id="unidade-material" class="form-control" required>
                                <option value="Pct">Pacote</option>
                                <option value="Cx">Caixa</option>
                                <option value="Un">Unidade</option>
                                <option value="Kg">Quilograma</option>
                                <option value="L">Litro</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="unidade-medida-material">Unidade de Medida:</label>
                            <select id="unidade-medida-material" class="form-control" required>
                                <option value="g">Gramas (g)</option>
                                <option value="kg">Quilogramas (kg)</option>
                                <option value="ml">Mililitros (ml)</option>
                                <option value="l">Litros (l)</option>
                                <option value="un">Unidades</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="quantidade-medida-material">Quantidade por Unidade:</label>
                            <input type="number" id="quantidade-medida-material" class="form-control" min="0.01" step="0.01" required>
                        </div>
                    </div>
                </div>
                
                <div id="info-preco-medio" class="notification notification-info hidden">
                    <p>Preço médio atual: <span id="valor-preco-medio">R$ 0,00</span> (com base em <span id="num-registros">0</span> registros)</p>
                </div>
                
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="preco-material">Preço (R$):</label>
                            <input type="number" id="preco-material" class="form-control" min="0.01" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="data-compra-material">Data da Compra:</label>
                            <input type="date" id="data-compra-material" class="form-control">
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Adicionar ao Estoque</button>
                </div>
            </form>
            
            <div class="scanner-container hidden" id="scanner-container">
                <h3>Escanear Código</h3>
                <div id="reader"></div>
                <div id="scanner-result"></div>
                <button type="button" id="stop-scanner" class="btn btn-danger">Parar Scanner</button>
            </div>
        </div>
    </div>
</div>
<div class="page-content" id="receitas-page">
    <h2>Gestão de Receitas</h2>
    
    <div class="tab-buttons">
        <button class="tab-button active" data-tab="listar-receitas">Listar Receitas</button>
        <button class="tab-button" data-tab="adicionar-receita">Adicionar Receita</button>
    </div>
    
    <!-- Tab: Listar Receitas -->
    <div class="tab-content active" id="listar-receitas">
        <div class="card">
            <h3>Receitas Cadastradas</h3>
            <input type="text" id="pesquisar-receita" class="form-control" placeholder="Pesquisar receita..." style="margin-bottom: 20px;">
            
            <div id="lista-receitas">
                <!-- As receitas serão adicionadas aqui dinamicamente -->
            </div>
        </div>
    </div>
    
    <!-- Tab: Adicionar Receita -->
    <div class="tab-content" id="adicionar-receita">
        <div class="card">
            <h3>Adicionar Nova Receita</h3>
            
            <form id="form-adicionar-receita">
                <div class="form-group">
                    <label for="nome-receita">Nome da Receita:</label>
                    <input type="text" id="nome-receita" class="form-control" placeholder="Ex: Bolo de Chocolate" required>
                </div>
                
                <div class="form-group">
                    <label for="descricao-receita">Descrição:</label>
                    <textarea id="descricao-receita" class="form-control" rows="3" placeholder="Descreva brevemente a receita..."></textarea>
                </div>
                
                <h4>Ingredientes</h4>
                <div id="lista-ingredientes">
                    <!-- Os ingredientes serão adicionados aqui dinamicamente -->
                </div>
                
                <button type="button" id="adicionar-ingrediente" class="btn btn-secondary">+ Adicionar Ingrediente</button>
                
                <div class="recipe-pricing" style="margin-top: 20px;">
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Custo de Produção</div>
                        <div id="custo-producao" class="recipe-price-value">R$ 0,00</div>
                    </div>
                    
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Custos Variados (10%)</div>
                        <div id="custos-variados" class="recipe-price-value">R$ 0,00</div>
                    </div>
                    
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Preço Estimado (150%)</div>
                        <div id="preco-estimado" class="recipe-price-value">R$ 0,00</div>
                    </div>
                    
                    <div class="recipe-price-item">
                        <div class="form-group">
                            <label for="preco-venda" class="recipe-price-label">Preço de Venda Final</label>
                            <input type="number" id="preco-venda" class="form-control" min="0" step="0.01" placeholder="0.00" required>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Salvar Receita</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- PÁGINA DE VENDAS E MODAIS -->
<div class="page-content" id="vendas-page">
    <h2>Histórico de Vendas</h2>
    
    <div class="tab-buttons">
        <button class="tab-button active" data-tab="listar-vendas">Histórico de Vendas</button>
        <button class="tab-button" data-tab="registrar-venda">Registrar Venda</button>
    </div>
    
    <!-- Tab: Listar Vendas -->
    <div class="tab-content active" id="listar-vendas">
        <div class="card">
            <h3>Registro de Vendas</h3>
            <div id="notification-vendas"></div>
            <input type="text" id="pesquisar-vendas" class="form-control" placeholder="Pesquisar vendas..." style="margin-bottom: 20px;">
            
            <div class="form-row" style="margin-bottom: 20px;">
                <div class="form-col">
                    <div class="form-group">
                        <label for="filtro-data-inicio">Data Inicial:</label>
                        <input type="date" id="filtro-data-inicio" class="form-control">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="filtro-data-fim">Data Final:</label>
                        <input type="date" id="filtro-data-fim" class="form-control">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="filtro-receita">Receita:</label>
                        <select id="filtro-receita" class="form-control">
                            <option value="">Todas as receitas</option>
                            <!-- As receitas serão adicionadas aqui dinamicamente -->
                        </select>
                    </div>
                </div>
                <div class="form-col" style="display: flex; align-items: flex-end;">
                    <button id="btn-filtrar-vendas" class="btn btn-primary">Filtrar</button>
                    <button id="btn-limpar-filtros" class="btn btn-secondary" style="margin-left: 10px;">Limpar</button>
                </div>
            </div>
            
            <div id="lista-vendas">
                <!-- As vendas serão adicionadas aqui dinamicamente -->
            </div>
        </div>
    </div>
    
    <!-- Tab: Registrar Venda -->
    <div class="tab-content" id="registrar-venda">
        <div class="card">
            <h3>Registrar Nova Venda</h3>
            
            <div class="form-group">
                <label for="selecionar-receita-venda">Selecione uma Receita:</label>
                <select id="selecionar-receita-venda" class="form-control">
                    <option value="">Selecione uma receita...</option>
                    <!-- As receitas serão adicionadas aqui dinamicamente -->
                </select>
            </div>
            
            <div id="detalhes-receita-venda" class="hidden">
                <h4>Detalhes da Receita: <span id="nome-receita-selecionada-venda"></span></h4>
                
                <div class="recipe-pricing" style="margin: 15px 0;">
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Custo de Produção</div>
                        <div id="custo-producao-venda" class="recipe-price-value">R$ 0,00</div>
                        <div class="material-detalhes">(baseado em preço médio)</div>
                    </div>
                    
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Custos Variados</div>
                        <div id="custos-variados-venda" class="recipe-price-value">R$ 0,00</div>
                    </div>
                    
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Preço de Venda</div>
                        <div id="preco-venda-venda" class="recipe-price-value highlight">R$ 0,00</div>
                    </div>
                </div>
                
                <form id="form-registrar-venda">
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="cliente-nome">Nome do Cliente:</label>
                                <input type="text" id="cliente-nome" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="cliente-telefone">Telefone:</label>
                                <input type="tel" id="cliente-telefone" class="form-control" placeholder="(00) 00000-0000">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="cliente-endereco">Endereço:</label>
                        <textarea id="cliente-endereco" class="form-control" rows="2"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="observacoes-venda">Observações:</label>
                        <textarea id="observacoes-venda" class="form-control" rows="2" placeholder="Motivo da compra, brindes, informações adicionais..."></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="custo-frete">Custo de Frete (R$):</label>
                                <input type="number" id="custo-frete" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="custo-decoracao">Custo de Decoração (R$):</label>
                                <input type="number" id="custo-decoracao" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="despesas-adicionais" title="Despesas que reduzirão o lucro, como brindes">Despesas Adicionais (R$):</label>
                                <input type="number" id="despesas-adicionais" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="quantidade-venda">Quantidade:</label>
                                <input type="number" id="quantidade-venda" class="form-control" min="1" value="1">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="data-venda">Data da Venda:</label>
                                <input type="date" id="data-venda" class="form-control">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="valor-total-venda">Valor Total (R$):</label>
                                <input type="number" id="valor-total-venda" class="form-control" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <table id="tabela-ingredientes-venda">
                        <thead>
                            <tr>
                                <th>Ingrediente</th>
                                <th>Quantidade Necessária</th>
                                <th>Estoque Atual</th>
                                <th>Status</th>
                                <th>Preço Médio (R$)</th>
                            </tr>
                        </thead>
                        <tbody id="ingredientes-venda-selecionada">
                            <!-- Os ingredientes da receita serão adicionados aqui dinamicamente -->
                        </tbody>
                    </table>
                    
                    <div id="aviso-estoque-venda" class="notification hidden"></div>
                    
                    <!-- Adicionado: Resumo financeiro da venda -->
                    <div class="venda-resumo-financeiro">
                        <h4>Resumo Financeiro</h4>
                        <div class="venda-resumo-grid">
                            <div class="venda-resumo-item">
                                <div class="venda-resumo-label">Valor Total</div>
                                <div id="resumo-valor-total" class="venda-resumo-valor">R$ 0,00</div>
                            </div>
                            <div class="venda-resumo-item">
                                <div class="venda-resumo-label">Despesa</div>
                                <div id="resumo-despesa" class="venda-resumo-valor">R$ 0,00</div>
                                <div class="material-detalhes">(preço médio)</div>
                            </div>
                            <div class="venda-resumo-item">
                                <div class="venda-resumo-label">Reinvestir</div>
                                <div id="resumo-reinvestir" class="venda-resumo-valor">R$ 0,00</div>
                            </div>
                            <div class="venda-resumo-item">
                                <div class="venda-resumo-label">Total Desp. Adic.</div>
                                <div id="resumo-desp-adic" class="venda-resumo-valor">R$ 0,00</div>
                            </div>
                            <div class="venda-resumo-item">
                                <div class="venda-resumo-label">Lucro</div>
                                <div id="resumo-lucro" class="venda-resumo-valor">R$ 0,00</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: right;">
                        <button type="submit" id="confirmar-venda" class="btn btn-success">Confirmar Venda</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal para processamento de dados -->
<div id="processing-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h3 id="modal-title">Processando...</h3>
        <div class="loader"></div>
        <p id="modal-message">Aguarde enquanto processamos as informações.</p>
    </div>
</div>

<!-- Modal para visualização de detalhes da venda -->
<div id="venda-details-modal" class="modal-overlay hidden">
    <div class="modal-content" style="width: 700px; max-width: 90%;">
        <div style="text-align: right;">
            <button id="fechar-detalhes-venda" class="btn btn-secondary">X</button>
        </div>
        <h3>Detalhes da Venda</h3>
        <div id="venda-details-content">
            <!-- Conteúdo dos detalhes da venda -->
        </div>
    </div>
</div>

<!-- Modal para editar venda -->
<div id="editar-venda-modal" class="modal-overlay hidden">
    <div class="modal-content" style="width: 700px; max-width: 90%;">
        <div style="text-align: right;">
            <button id="fechar-editar-venda" class="btn btn-secondary">X</button>
        </div>
        <h3>Editar Venda</h3>
        <form id="form-editar-venda">
            <input type="hidden" id="editar-venda-id">
            <input type="hidden" id="editar-venda-receita-id">
            
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="editar-cliente-nome">Nome do Cliente:</label>
                        <input type="text" id="editar-cliente-nome" class="form-control" required>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="editar-cliente-telefone">Telefone:</label>
                        <input type="tel" id="editar-cliente-telefone" class="form-control" placeholder="(00) 00000-0000">
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="editar-cliente-endereco">Endereço:</label>
                <textarea id="editar-cliente-endereco" class="form-control" rows="2"></textarea>
            </div>
            
            <div class="form-group">
                <label for="editar-observacoes-venda">Observações:</label>
                <textarea id="editar-observacoes-venda" class="form-control" rows="2"></textarea>
            </div>
            
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="editar-custo-frete">Custo de Frete (R$):</label>
                        <input type="number" id="editar-custo-frete" class="form-control" min="0" step="0.01">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="editar-custo-decoracao">Custo de Decoração (R$):</label>
                        <input type="number" id="editar-custo-decoracao" class="form-control" min="0" step="0.01">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="editar-despesas-adicionais">Despesas Adicionais (R$):</label>
                        <input type="number" id="editar-despesas-adicionais" class="form-control" min="0" step="0.01">
                    </div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="editar-quantidade-venda">Quantidade:</label>
                        <input type="number" id="editar-quantidade-venda" class="form-control" min="1">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="editar-data-venda">Data da Venda:</label>
                        <input type="date" id="editar-data-venda" class="form-control">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="editar-valor-total-venda">Valor Total (R$):</label>
                        <input type="number" id="editar-valor-total-venda" class="form-control">
                    </div>
                </div>
            </div>
            
            <!-- Tabela de ingredientes na edição -->
            <div id="editar-tabela-ingredientes-container" class="hidden" style="margin-top: 20px;">
                <h4>Ingredientes Necessários</h4>
                <table id="editar-tabela-ingredientes">
                    <thead>
                        <tr>
                            <th>Ingrediente</th>
                            <th>Quantidade Necessária</th>
                            <th>Estoque Atual</th>
                            <th>Status</th>
                            <th>Preço Médio (R$)</th>
                        </tr>
                    </thead>
                    <tbody id="editar-ingredientes-lista">
                        <!-- Ingredientes serão adicionados aqui -->
                    </tbody>
                </table>
                <div id="editar-aviso-estoque" class="notification hidden"></div>
            </div>
            
            <!-- Adicionado: Resumo financeiro da venda para edição -->
            <div class="venda-resumo-financeiro">
                <h4>Resumo Financeiro</h4>
                <div class="venda-resumo-grid">
                    <div class="venda-resumo-item">
                        <div class="venda-resumo-label">Valor Total</div>
                        <div id="editar-resumo-valor-total" class="venda-resumo-valor">R$ 0,00</div>
                    </div>
                    <div class="venda-resumo-item">
                        <div class="venda-resumo-label">Despesa</div>
                        <div id="editar-resumo-despesa" class="venda-resumo-valor">R$ 0,00</div>
                        <div class="material-detalhes">(preço médio)</div>
                    </div>
                    <div class="venda-resumo-item">
                        <div class="venda-resumo-label">Reinvestir</div>
                        <div id="editar-resumo-reinvestir" class="venda-resumo-valor">R$ 0,00</div>
                    </div>
                    <div class="venda-resumo-item">
                        <div class="venda-resumo-label">Total Desp. Adic.</div>
                        <div id="editar-resumo-desp-adic" class="venda-resumo-valor">R$ 0,00</div>
                    </div>
                    <div class="venda-resumo-item">
                        <div class="venda-resumo-label">Lucro</div>
                        <div id="editar-resumo-lucro" class="venda-resumo-valor">R$ 0,00</div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px; text-align: right;">
                <button type="submit" class="btn btn-primary">Salvar Alterações</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de confirmação para exclusão -->
<div id="confirmar-exclusao-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h3>Confirmar Exclusão</h3>
        <p>Tem certeza que deseja excluir esta venda? Esta ação não pode ser desfeita.</p>
        <input type="hidden" id="excluir-venda-id">
        <div style="margin-top: 20px; text-align: right;">
            <button id="cancelar-exclusao" class="btn btn-secondary">Cancelar</button>
            <button id="confirmar-exclusao" class="btn btn-danger">Excluir</button>
        </div>
    </div>
</div>

<!-- Modal de login -->
<div id="login-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h3>Login</h3>
        <div id="login-notification" class="notification hidden"></div>
        
        <div class="form-group">
            <label for="login-email">Email:</label>
            <input type="email" id="login-email" class="form-control" placeholder="email@exemplo.com" required>
        </div>
        
        <div class="form-group">
            <label for="login-senha">Senha:</label>
            <input type="password" id="login-senha" class="form-control" placeholder="Sua senha" required>
        </div>
        
        <div style="margin-top: 20px; display: flex; justify-content: space-between;">
            <button id="btn-login" class="btn btn-primary">Entrar</button>
            <button id="btn-cadastrar" class="btn btn-secondary">Cadastrar</button>
        </div>
    </div>
</div>
<script>
// PARTE 3: JAVASCRIPT (FIREBASE E FUNÇÕES GLOBAIS - OTIMIZADAS)

// Sistema de gerenciamento de eventos - novo
const EventManager = {
    // Adiciona um evento e evita duplicações
    addEvent(element, eventType, handler, options = {}) {
        if (!element) return false;
        
        // Remover handler existente para evitar duplicação
        element.removeEventListener(eventType, handler);
        
        // Adicionar novo handler
        element.addEventListener(eventType, handler, options);
        return true;
    },
    
    // Remove um evento específico
    removeEvent(element, eventType, handler) {
        if (!element) return false;
        element.removeEventListener(eventType, handler);
        return true;
    },
    
    // Delegação de eventos - mais eficiente para listas
    delegateEvent(parentElement, selector, eventType, handler) {
        if (!parentElement) return false;
        
        const delegationHandler = function(e) {
            const targetElement = e.target.closest(selector);
            if (targetElement && parentElement.contains(targetElement)) {
                handler.call(targetElement, e);
            }
        };
        
        // Armazenar a referência para poder remover depois
        parentElement._delegationHandlers = parentElement._delegationHandlers || {};
        if (parentElement._delegationHandlers[eventType]) {
            parentElement.removeEventListener(eventType, parentElement._delegationHandlers[eventType]);
        }
        
        parentElement._delegationHandlers[eventType] = delegationHandler;
        parentElement.addEventListener(eventType, delegationHandler);
        return true;
    }
};

// Cache de elementos DOM frequentemente utilizados
const DOMCache = {
    elements: {},
    
    // Obtém elemento e armazena em cache
    get(selector) {
        if (!this.elements[selector]) {
            this.elements[selector] = document.querySelector(selector);
        }
        return this.elements[selector];
    },
    
    // Obtém múltiplos elementos
    getAll(selector) {
        if (!this.elements[selector + '_all']) {
            this.elements[selector + '_all'] = document.querySelectorAll(selector);
        }
        return this.elements[selector + '_all'];
    },
    
    // Limpa o cache
    clear() {
        this.elements = {};
    }
};

// Funções utilitárias simplificadas
function $(selector) {
    return DOMCache.get(selector);
}

function $$(selector) {
    return DOMCache.getAll(selector);
}

// Nova função para notificações toast
function mostrarToast(mensagem, tipo = 'success') {
    // Remover toast existente
    const toastExistente = document.querySelector('.toast-notification');
    if (toastExistente) {
        document.body.removeChild(toastExistente);
    }
    
    // Criar novo toast
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.textContent = mensagem;
    
    // Aplicar estilo conforme tipo
    if (tipo === 'error') {
        toast.style.backgroundColor = '#dc3545';
    } else if (tipo === 'warning') {
        toast.style.backgroundColor = '#ffc107';
        toast.style.color = '#333';
    } else {
        toast.style.backgroundColor = '#28a745';
    }
    
    document.body.appendChild(toast);
    
    // Remover após 3 segundos
    setTimeout(() => {
        if (document.body.contains(toast)) {
            document.body.removeChild(toast);
        }
    }, 3000);
}

// Substituir função problemática que causava erros nos botões
function limparNotificacoes() {
    // Esconder todos os modais
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.classList.add('hidden');
    });
    
    // Esconder todas as notificações
    document.querySelectorAll('.notification').forEach(notif => {
        notif.classList.add('hidden');
    });
    
    // NÃO substituir alerts e confirms nativos
    console.log("Notificações foram ocultadas");
}

// Configuração do Firebase
const firebaseConfig = {
    apiKey: "AIzaSyABzQdTgR9-Al-drNRMBcEb1dN76wUjqvY",
    authDomain: "deiacontrole-faabc.firebaseapp.com",
    databaseURL: "https://deiacontrole-faabc-default-rtdb.firebaseio.com",
    projectId: "deiacontrole-faabc",
    storageBucket: "deiacontrole-faabc.firebasestorage.app",
    messagingSenderId: "216368622292",
    appId: "1:216368622292:web:20522a4725c30907c92941",
};

// Inicializar Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
let currentUser = null;

// Variáveis globais
let estoque = [];
let materiais = [];
let receitas = [];
let vendas = [];
let html5QrCode;

// Função para mostrar a tela de login
function mostrarTelaLogin() {
    const loginModal = document.getElementById('login-modal');
    if (loginModal) {
        loginModal.classList.remove('hidden');
    }
}

// Função para fazer login
function fazerLogin() {
    const email = document.getElementById('login-email').value;
    const senha = document.getElementById('login-senha').value;
    
    if (!email || !senha) {
        mostrarNotificacaoLogin('Preencha todos os campos', 'error');
        return;
    }
    
    toggleModal(true, "Fazendo login...", "Verificando credenciais...");
    
    firebase.auth().signInWithEmailAndPassword(email, senha)
        .then(() => {
            toggleModal(false);
            document.getElementById('login-modal').classList.add('hidden');
        })
        .catch((error) => {
            toggleModal(false);
            mostrarNotificacaoLogin('Erro: ' + error.message, 'error');
        });
}

// Função para criar cadastro
function fazerCadastro() {
    const email = document.getElementById('login-email').value;
    const senha = document.getElementById('login-senha').value;
    
    if (!email || !senha) {
        mostrarNotificacaoLogin('Preencha todos os campos', 'error');
        return;
    }
    
    toggleModal(true, "Criando conta...", "Aguarde...");
    
    firebase.auth().createUserWithEmailAndPassword(email, senha)
        .then(() => {
            toggleModal(false);
            document.getElementById('login-modal').classList.add('hidden');
            mostrarToast('Conta criada com sucesso!', 'success');
        })
        .catch((error) => {
            toggleModal(false);
            mostrarNotificacaoLogin('Erro: ' + error.message, 'error');
        });
}

// Função para mostrar notificações no login
function mostrarNotificacaoLogin(mensagem, tipo) {
    const notificacao = document.getElementById('login-notification');
    if (notificacao) {
        notificacao.textContent = mensagem;
        notificacao.className = `notification notification-${tipo}`;
        notificacao.classList.remove('hidden');
    }
}

// Função para adicionar botão de sincronização
function adicionarBotaoSincronizacao() {
    // Evitar duplicação
    if (document.getElementById('btn-sync')) return;
    
    const btnSync = document.createElement('button');
    btnSync.id = 'btn-sync';
    btnSync.className = 'btn btn-primary';
    btnSync.textContent = 'Sincronizar';
    btnSync.style.position = 'fixed';
    btnSync.style.bottom = '20px';
    btnSync.style.right = '20px';
    btnSync.style.zIndex = '999';
    
    btnSync.addEventListener('click', sincronizarComNuvem);
    document.body.appendChild(btnSync);
}

// Função para logout
function fazerLogout() {
    firebase.auth().signOut()
        .then(() => {
            mostrarToast('Logout realizado com sucesso', 'success');
            currentUser = null;
            document.getElementById('user-info').classList.add('hidden');
            
            // Remover botão de sincronização
            const btnSync = document.getElementById('btn-sync');
            if (btnSync) document.body.removeChild(btnSync);
            
            mostrarTelaLogin();
        })
        .catch((error) => {
            mostrarToast('Erro ao fazer logout: ' + error.message, 'error');
        });
}

// Função para atualizar o localStorage
function atualizarLocalStorage() {
    try {
        localStorage.setItem('estoque', JSON.stringify(estoque));
        localStorage.setItem('materiais', JSON.stringify(materiais));
        localStorage.setItem('receitas', JSON.stringify(receitas));
        localStorage.setItem('vendas', JSON.stringify(vendas));
        localStorage.setItem('ultimaAtualizacao', new Date().toISOString());
        
        // Sincronizar com nuvem se o usuário estiver logado
        if (currentUser) {
            sincronizarComNuvem();
        }
        return true;
    } catch (error) {
        console.error("Erro ao atualizar localStorage:", error);
        return false;
    }
}

// Função para sincronizar com o Firebase - otimizada
function sincronizarComNuvem() {
    if (!currentUser) return Promise.reject('Usuário não autenticado');
    
    // Impedir envio de dados vazios
    if (estoque.length === 0 && materiais.length === 0 && 
        receitas.length === 0 && vendas.length === 0) {
        console.log("Evitando sincronizar arrays vazios");
        return Promise.resolve(false);
    }
    
    const userId = currentUser.uid;
    console.log("Enviando dados para o Firebase");
    
    // Mostrar modal de sincronização
    toggleModal(true, "Sincronizando dados...", "Enviando informações para a nuvem.");
    
    return database.ref('usuarios/' + userId).set({
        estoque: estoque,
        materiais: materiais,
        receitas: receitas,
        vendas: vendas,
        ultimaAtualizacao: new Date().toISOString()
    }).then(() => {
        toggleModal(false);
        mostrarToast('Dados sincronizados com sucesso!');
        return true;
    }).catch(error => {
        toggleModal(false);
        mostrarToast('Erro ao sincronizar: ' + error.message, 'error');
        console.error('Erro na sincronização:', error);
        return false;
    });
}

// Função para mostrar/esconder o modal de processamento - simplificada
function toggleModal(show, title = "Processando...", message = "Aguarde enquanto processamos as informações.") {
    const modal = document.getElementById('processing-modal');
    if (!modal) return false;
    
    if (show) {
        // Configurar textos
        const titleEl = document.getElementById('modal-title');
        const messageEl = document.getElementById('modal-message');
        
        if (titleEl) titleEl.textContent = title;
        if (messageEl) messageEl.textContent = message;
        
        // Mostrar modal
        modal.classList.remove('hidden');
        
        // Configurar timer de segurança para fechar o modal após 10 segundos
        if (window.modalSafetyTimer) {
            clearTimeout(window.modalSafetyTimer);
        }
        window.modalSafetyTimer = setTimeout(() => {
            modal.classList.add('hidden');
        }, 10000);
    } else {
        // Esconder modal
        modal.classList.add('hidden');
        
        // Limpar timer
        if (window.modalSafetyTimer) {
            clearTimeout(window.modalSafetyTimer);
        }
    }
    
    return true;
}

// Função para formatar data
function formatarData(data) {
    try {
        const d = new Date(data);
        return `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getFullYear()}`;
    } catch (e) {
        return 'Data inválida';
    }
}

// Função para formatar valor monetário
function formatarMoeda(valor) {
    if (isNaN(valor)) valor = 0;
    return 'R$ ' + parseFloat(valor).toFixed(2).replace('.', ',');
}

// Função para gerar ID único mais curta e eficiente
function gerarId() {
    return 'id_' + Date.now().toString(36) + '_' + Math.random().toString(36).substring(2, 9);
}

// Função para atualizar data/hora atual
function atualizarDataHora() {
    const elemento = document.getElementById('date-time');
    if (!elemento) return;
    
    const agora = new Date();
    const dataFormatada = agora.toLocaleDateString('pt-BR');
    const horaFormatada = agora.toLocaleTimeString('pt-BR');
    elemento.textContent = `${dataFormatada} ${horaFormatada}`;
}

// Handler global para tratamento de erros
window.onerror = function(msg, url, lineNo, columnNo, error) {
    console.error('Erro capturado globalmente:', error);
    mostrarToast('Ocorreu um erro no sistema. Veja o console para mais detalhes.', 'error');
    return false;
};

// Função para iniciar sincronização - otimizada
function iniciarSincronizacao(skipSync = false) {
    if (!currentUser) return Promise.reject('Usuário não autenticado');
    
    const userId = currentUser.uid;
    
    toggleModal(true, "Verificando dados...", "Buscando informações na nuvem.");
    
    return database.ref('usuarios/' + userId).once('value').then((snapshot) => {
        const dados = snapshot.val();
        toggleModal(false);
        
        if (dados) {
            console.log('Dados encontrados na nuvem');
            
            // Verificar se tem dados válidos
            if (dados.estoque || dados.materiais || dados.receitas || dados.vendas) {
                // Atualizar dados locais com dados da nuvem
                estoque = dados.estoque || [];
                materiais = dados.materiais || [];
                receitas = dados.receitas || [];
                vendas = dados.vendas || [];
                
                // Salvar no localStorage sem acionar sincronização
                localStorage.setItem('estoque', JSON.stringify(estoque));
                localStorage.setItem('materiais', JSON.stringify(materiais));
                localStorage.setItem('receitas', JSON.stringify(receitas));
                localStorage.setItem('vendas', JSON.stringify(vendas));
                localStorage.setItem('ultimaAtualizacao', dados.ultimaAtualizacao);
                
                mostrarToast('Dados carregados da nuvem!');
            } else if (!skipSync) {
                // Dados vazios na nuvem, mas temos dados locais para enviar
                if (estoque.length > 0 || materiais.length > 0 || receitas.length > 0 || vendas.length > 0) {
                    sincronizarComNuvem();
                }
            }
        } else if (!skipSync) {
            // Não há dados na nuvem, talvez temos dados locais para enviar
            if (estoque.length > 0 || materiais.length > 0 || receitas.length > 0 || vendas.length > 0) {
                sincronizarComNuvem();
            }
        }
        
        // Recarregar interfaces
        carregarEstoque();
        carregarMateriais();
        carregarReceitas();
        carregarVendas();
        
        // Configurar listener para atualizações futuras (de outros dispositivos)
        configurarListenerAtualizacoes(userId);
        
        return dados;
    }).catch(error => {
        toggleModal(false);
        console.error('Erro ao verificar dados na nuvem:', error);
        mostrarToast('Erro ao verificar dados na nuvem', 'error');
        return null;
    });
}

// Nova função para configurar listener de atualizações
function configurarListenerAtualizacoes(userId) {
    // Remover listener existente se houver
    if (window.atualizacoesRef) {
        window.atualizacoesRef.off();
    }
    
    // Configurar novo listener
    window.atualizacoesRef = database.ref('usuarios/' + userId);
    window.atualizacoesRef.on('value', (snapshot) => {
        const dadosNovos = snapshot.val();
        if (dadosNovos && dadosNovos.ultimaAtualizacao) {
            const ultimaAtualizacaoLocal = localStorage.getItem('ultimaAtualizacao');
            
            // Só atualizar se os dados da nuvem forem mais recentes e não forem os que acabamos de enviar
            if (ultimaAtualizacaoLocal && 
                new Date(dadosNovos.ultimaAtualizacao) > new Date(ultimaAtualizacaoLocal) && 
                dadosNovos.ultimaAtualizacao !== new Date(ultimaAtualizacaoLocal).toISOString()) {
                
                console.log('Recebendo atualização da nuvem...');
                
                // Atualizar dados locais
                estoque = dadosNovos.estoque || [];
                materiais = dadosNovos.materiais || [];
                receitas = dadosNovos.receitas || [];
                vendas = dadosNovos.vendas || [];
                
                // Salvar no localStorage sem acionar nova sincronização
                localStorage.setItem('estoque', JSON.stringify(estoque));
                localStorage.setItem('materiais', JSON.stringify(materiais));
                localStorage.setItem('receitas', JSON.stringify(receitas));
                localStorage.setItem('vendas', JSON.stringify(vendas));
                localStorage.setItem('ultimaAtualizacao', dadosNovos.ultimaAtualizacao);
                
                // Recarregar interfaces
                carregarEstoque();
                carregarMateriais();
                carregarReceitas();
                carregarVendas();
                
                mostrarToast('Dados atualizados da nuvem!');
            }
        }
    });
}

// Inicializar componentes DOM quando o documento estiver pronto
document.addEventListener('DOMContentLoaded', function() {
    limparNotificacoes();
    
    // Carregar dados do localStorage
    try {
        estoque = JSON.parse(localStorage.getItem('estoque')) || [];
        materiais = JSON.parse(localStorage.getItem('materiais')) || [];
        receitas = JSON.parse(localStorage.getItem('receitas')) || [];
        vendas = JSON.parse(localStorage.getItem('vendas')) || [];
    } catch (e) {
        console.error('Erro ao carregar dados do localStorage:', e);
        estoque = [];
        materiais = [];
        receitas = [];
        vendas = [];
    }
    
    // Verificar autenticação do Firebase ao iniciar
    firebase.auth().onAuthStateChanged((user) => {
        if (user) {
            // Usuário está logado
            currentUser = user;
            
            // Mostrar email do usuário
            const userInfoEl = document.getElementById('user-info');
            if (userInfoEl) {
                userInfoEl.classList.remove('hidden');
                document.getElementById('user-email').textContent = user.email;
            }
            
            // MODIFICAÇÃO: Sequência correta para inicialização
            setupEventListeners();  // Configurar eventos principais
            setupAllEvents();       // Configurar todos os eventos
            inicializarApp();       // Inicializar aplicação (já ativa a página)
            iniciarSincronizacao(); // Sincronizar com Firebase
            adicionarBotaoSincronizacao();
            
            // Verificação adicional após 500ms
            setTimeout(() => {
                const paginasAtivas = document.querySelectorAll('.page-content.active');
                if (paginasAtivas.length === 0) {
                    console.log("Nenhuma página ativa, ativando estoque");
                    const navEstoque = document.querySelector('.nav-link[data-page="estoque"]');
                    if (navEstoque) navEstoque.click();
                }
            }, 500);
        } else {
            // Usuário não está logado, mostrar tela de login
            mostrarTelaLogin();
        }
    });
});
// PARTE 4: JAVASCRIPT - NAVEGAÇÃO E FUNÇÕES UTILITÁRIAS

// Função para navegação principal - OTIMIZADA
function navegarParaPagina(e) {
    try {
        e.preventDefault();
        
        const pagina = this.getAttribute('data-page');
        console.log("Navegando para a página:", pagina);
        
        // Atualizar navegação
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        this.classList.add('active');
        
        // Mostrar página correspondente
        document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
        const pageElement = document.getElementById(`${pagina}-page`);
        if (pageElement) {
            pageElement.classList.add('active');
            
            // Atualizar interfaces específicas para cada página
            switch(pagina) {
                case 'estoque':
                    carregarEstoque();
                    break;
                case 'materiais':
                    carregarMateriais();
                    break;
                case 'receitas':
                    carregarReceitas();
                    break;
                case 'vendas':
                    carregarVendas();
                    break;
            }
        } else {
            console.error("Página não encontrada:", pagina + "-page");
            mostrarToast("Erro ao navegar para a página", "error");
        }
    } catch (error) {
        console.error("Erro durante navegação:", error);
        mostrarToast("Erro ao navegar para a página", "error");
    }
}

// Função para alternar abas - OTIMIZADA
function alternarAba(e) {
    try {
        if (e) e.preventDefault();
        
        const tabId = this.getAttribute('data-tab');
        console.log("Alterando para a aba:", tabId);
        
        // Atualizar botões de abas
        const parentTab = this.parentElement;
        parentTab.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        // Mostrar conteúdo da aba
        const parentContent = parentTab.parentElement;
        parentContent.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        const contentTab = document.getElementById(tabId);
        if (contentTab) {
            contentTab.classList.add('active');
            
            // Ações especiais para certas abas
            if (tabId === 'listar-materiais') {
                carregarMateriais();
            } else if (tabId === 'listar-receitas') {
                carregarReceitas();
            } else if (tabId === 'listar-vendas') {
                carregarVendas();
            }
        } else {
            console.error("Conteúdo da aba não encontrado:", tabId);
        }
    } catch (error) {
        console.error("Erro ao alternar aba:", error);
    }
}

// Sistema de tratamento de erros global
window.addEventListener('error', function(e) {
    console.error("Erro global capturado:", e.error || e.message);
    mostrarToast("Ocorreu um erro no sistema", "error");
    return false;
});

// Função para verificar o status dos botões e corrigir se necessário
function verificarBotoesFuncionando() {
    try {
        console.log("Verificando funcionamento dos botões...");
        
        // Verificar botões de materiais
        const btnRemoverMateriais = document.querySelectorAll('.btn-remover-material');
        if (btnRemoverMateriais.length > 0) {
            console.log(`Encontrados ${btnRemoverMateriais.length} botões de remoção de materiais`);
            setupMaterialButtonEvents();
        }
        
        // Verificar botões de receitas
        const btnEditarReceitas = document.querySelectorAll('.btn-editar-receita');
        const btnRemoverReceitas = document.querySelectorAll('.btn-remover-receita');
        
        if (btnEditarReceitas.length > 0 || btnRemoverReceitas.length > 0) {
            console.log(`Encontrados ${btnEditarReceitas.length} botões de edição e ${btnRemoverReceitas.length} de remoção para receitas`);
            setupReceitaEvents();
        }
        
        // Verificar botões de vendas
        const btnEditarVendas = document.querySelectorAll('.btn-editar-venda');
        const btnExcluirVendas = document.querySelectorAll('.btn-excluir-venda');
        
        if (btnEditarVendas.length > 0 || btnExcluirVendas.length > 0) {
            console.log(`Encontrados ${btnEditarVendas.length} botões de edição e ${btnExcluirVendas.length} de exclusão para vendas`);
            setupVendasEvents();
        }
        
        // Verificar modais
        const modais = document.querySelectorAll('.modal-overlay');
        modais.forEach(modal => {
            if (!modal.classList.contains('hidden')) {
                console.log("Modal visível encontrado:", modal.id);
                // Tentar fechar automaticamente se for um modal de processamento
                if (modal.id === 'processing-modal') {
                    modal.classList.add('hidden');
                }
            }
        });
        
        return true;
    } catch (error) {
        console.error("Erro ao verificar botões:", error);
        return false;
    }
}

// Função para recuperação de erros
function recuperarSistema() {
    try {
        console.log("Iniciando recuperação do sistema...");
        
        // 1. Esconder todos os modais
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.classList.add('hidden');
        });
        
        // 2. Recarregar dados do localStorage
        try {
            const estoqueLocal = JSON.parse(localStorage.getItem('estoque'));
            const materiaisLocal = JSON.parse(localStorage.getItem('materiais'));
            const receitasLocal = JSON.parse(localStorage.getItem('receitas'));
            const vendasLocal = JSON.parse(localStorage.getItem('vendas'));
            
            // Só atualizar se os dados forem válidos
            if (estoqueLocal && Array.isArray(estoqueLocal)) estoque = estoqueLocal;
            if (materiaisLocal && Array.isArray(materiaisLocal)) materiais = materiaisLocal;
            if (receitasLocal && Array.isArray(receitasLocal)) receitas = receitasLocal;
            if (vendasLocal && Array.isArray(vendasLocal)) vendas = vendasLocal;
        } catch (e) {
            console.error("Erro ao recuperar dados do localStorage:", e);
        }
        
        // 3. Recarregar interfaces
        carregarEstoque();
        carregarMateriais();
        carregarReceitas();
        carregarVendas();
        
        // 4. Verificar e corrigir botões
        verificarBotoesFuncionando();
        
        mostrarToast("Sistema recuperado", "success");
        return true;
    } catch (error) {
        console.error("Falha na recuperação do sistema:", error);
        // Como último recurso, recarregar a página
        setTimeout(() => {
            location.reload();
        }, 2000);
        return false;
    }
}

// Monitoramento automático de saúde do sistema
const sistemaMonitor = {
    intervaloChecagem: null,
    ultimoEstado: {
        numMateriais: 0,
        numReceitas: 0,
        numVendas: 0,
        paginaAtiva: null
    },
    
    iniciar() {
        if (this.intervaloChecagem) clearInterval(this.intervaloChecagem);
        
        // Verificar o sistema a cada 30 segundos
        this.intervaloChecagem = setInterval(() => {
            this.verificarSaude();
        }, 30000);
        
        // Verificação inicial
        this.verificarSaude();
        console.log("Monitor de sistema iniciado");
    },
    
    verificarSaude() {
        // 1. Verificar se dados estão coerentes
        const dadosCoerentes = materiais && receitas && vendas && 
                              Array.isArray(materiais) && 
                              Array.isArray(receitas) && 
                              Array.isArray(vendas);
        
        if (!dadosCoerentes) {
            console.warn("Dados inconsistentes detectados, tentando recuperar...");
            recuperarSistema();
            return;
        }
        
        // 2. Verificar se há alguma página ativa
        const paginasAtivas = document.querySelectorAll('.page-content.active');
        if (paginasAtivas.length === 0) {
            console.warn("Nenhuma página ativa, corrigindo navegação...");
            const primeiraAba = document.querySelector('.nav-link');
            if (primeiraAba) primeiraAba.click();
        }
        
        // 3. Verifique se há modais travados abertos
        const modaisAbertos = document.querySelectorAll('.modal-overlay:not(.hidden)');
        if (modaisAbertos.length > 0) {
            // Verificar se o modal está aberto há muito tempo
            const processingModal = document.getElementById('processing-modal');
            if (processingModal && !processingModal.classList.contains('hidden')) {
                console.warn("Modal de processamento travado detectado");
                processingModal.classList.add('hidden');
            }
        }
        
        // 4. Atualizar estado
        this.ultimoEstado = {
            numMateriais: materiais.length,
            numReceitas: receitas.length,
            numVendas: vendas.length,
            paginaAtiva: paginasAtivas.length > 0 ? paginasAtivas[0].id : null
        };
    }
};

// Configuração para dispositivos móveis
function otimizarParaDispositivos() {
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    if (isMobile) {
        console.log("Dispositivo móvel detectado, aplicando otimizações");
        
        // 1. Ajustar estilos para melhor visualização móvel
        const styleSheet = document.createElement('style');
        styleSheet.type = 'text/css';
        styleSheet.innerHTML = `
            @media (max-width: 768px) {
                .form-row { flex-direction: column; }
                .form-col { margin-bottom: 10px; }
                .btn { display: block; width: 100%; margin-bottom: 5px; }
                .venda-resumo-grid { grid-template-columns: 1fr 1fr; }
                table { font-size: 14px; }
                .modal-content { width: 95% !important; max-width: 95% !important; }
            }
        `;
        document.head.appendChild(styleSheet);
        
        // 2. Simplificar tabelas para melhor visualização
        document.querySelectorAll('table').forEach(table => {
            table.classList.add('mobile-optimized');
        });
        
        // 3. Configurar eventos de toque para navegação
        document.querySelectorAll('.nav-link, .tab-button, button').forEach(el => {
            el.style.padding = '12px'; // Aumentar área de toque
        });
    }
}

// Inicializar o sistema de eventos personalizados
const EventosSistema = {
    listeners: {},
    
    on(evento, callback) {
        if (!this.listeners[evento]) {
            this.listeners[evento] = [];
        }
        this.listeners[evento].push(callback);
    },
    
    off(evento, callback) {
        if (!this.listeners[evento]) return;
        this.listeners[evento] = this.listeners[evento].filter(cb => cb !== callback);
    },
    
    trigger(evento, data) {
        if (!this.listeners[evento]) return;
        this.listeners[evento].forEach(callback => {
            try {
                callback(data);
            } catch (error) {
                console.error(`Erro ao executar callback para evento ${evento}:`, error);
            }
        });
    }
};

// Verificação periódica do estado dos botões
setInterval(verificarBotoesFuncionando, 10000);

// Inicializar o monitoramento do sistema quando a aplicação estiver pronta
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        sistemaMonitor.iniciar();
        otimizarParaDispositivos();
    }, 1000);
});

// Iniciar o controle de foco nos elementos
document.addEventListener('focusin', function(e) {
    const target = e.target;
    if (target.tagName === 'INPUT' || target.tagName === 'SELECT' || target.tagName === 'TEXTAREA') {
        target.dataset.lastValue = target.value;
    }
});

document.addEventListener('focusout', function(e) {
    const target = e.target;
    if ((target.tagName === 'INPUT' || target.tagName === 'SELECT' || target.tagName === 'TEXTAREA') && 
        target.dataset.lastValue !== target.value) {
        console.log(`Valor alterado em ${target.id || target.name}`);
        EventosSistema.trigger('campo-alterado', { 
            elemento: target, 
            valorAntigo: target.dataset.lastValue, 
            valorNovo: target.value 
        });
    }
});

// Capturar erros em APIs assíncronas
window.addEventListener('unhandledrejection', function(event) {
    console.error('Promessa rejeitada não tratada:', event.reason);
    mostrarToast("Erro na comunicação com o servidor", "error");
});

// Inicialização final com verificação de segurança
window.addEventListener('load', function() {
    // Verificação final para garantir que tudo está funcionando
    setTimeout(() => {
        verificarBotoesFuncionando();
        
        // Verificar navegação
        const paginasAtivas = document.querySelectorAll('.page-content.active');
        if (paginasAtivas.length === 0 && currentUser) {
            console.warn("Página não inicializada corretamente, forçando navegação para estoque");
            const navEstoque = document.querySelector('.nav-link[data-page="estoque"]');
            if (navEstoque) navEstoque.click();
        }
    }, 500);
});

// Garantir que todas as funções críticas estão definidas
function verificarFuncoesNecessarias() {
    const funcoesEssenciais = [
        'removerMaterial',
        'editarReceita', 
        'removerReceita',
        'registrarVenda',
        'editarVenda',
        'excluirVenda',
        'carregarEstoque',
        'carregarMateriais',
        'carregarReceitas',
        'carregarVendas'
    ];
    
    let todasDefinidas = true;
    
    funcoesEssenciais.forEach(funcao => {
        if (typeof window[funcao] !== 'function') {
            console.error(`Função necessária não definida: ${funcao}`);
            todasDefinidas = false;
        }
    });
    
    if (!todasDefinidas) {
        console.error("ALERTA: Algumas funções críticas não estão definidas. O sistema pode não funcionar corretamente.");
        mostrarToast("Algumas funções do sistema não estão disponíveis", "error");
    }
    
    return todasDefinidas;
}
    // Função de emergência para forçar a exibição das páginas
function corrigirExibicaoPaginas() {
    console.log("Aplicando correção de emergência para exibir as páginas");
    
    // Garantir que todos os elementos page-content existam com display block
    const paginas = ["estoque-page", "materiais-page", "receitas-page", "vendas-page"];
    
    paginas.forEach(pagina => {
        const elemento = document.getElementById(pagina);
        if (elemento) {
            // Forçar a exibição via estilo inline
            elemento.style.display = "block";
            console.log(`Página ${pagina} forçada a exibir`);
        } else {
            console.error(`Elemento ${pagina} não encontrado`);
        }
    });
    
    // Ativar a página de estoque por padrão
    const estoquePage = document.getElementById("estoque-page");
    if (estoquePage) {
        estoquePage.classList.add("active");
        carregarEstoque();
    }
}

// Executar verificação após carregamento completo
window.addEventListener('load', verificarFuncoesNecessarias);
    
// PARTE 5: JAVASCRIPT (FIREBASE E FUNÇÕES PARA ESTOQUE/MATERIAIS)

// Funções para Estoque e Materiais - Otimizadas

// Função para calcular o preço médio de um material
function calcularPrecoMedio(material) {
    if (!material || !material.historicoPrecos || material.historicoPrecos.length === 0) {
        return 0;
    }
    
    const totalPrecos = material.historicoPrecos.reduce((total, registro) => total + (parseFloat(registro.preco) || 0), 0);
    return totalPrecos / material.historicoPrecos.length;
}

// Função para obter o preço médio de um material pelo código
function obterPrecoMedioPorCodigo(codigo) {
    if (!codigo) return 0;
    
    // Encontrar todos os materiais com esse código
    const materiaisComCodigo = materiais.filter(m => m.codigo === codigo);
    if (materiaisComCodigo.length === 0) return 0;
    
    // Calcular preço médio geral considerando todos os registros de preço
    let todosPrecos = [];
    materiaisComCodigo.forEach(material => {
        if (material.historicoPrecos && material.historicoPrecos.length > 0) {
            todosPrecos = todosPrecos.concat(material.historicoPrecos);
        }
    });
    
    if (todosPrecos.length === 0) return 0;
    
    const totalPrecos = todosPrecos.reduce((total, registro) => total + (parseFloat(registro.preco) || 0), 0);
    return totalPrecos / todosPrecos.length;
}

// Função para encontrar um material pelo código - OTIMIZADA
function encontrarMaterialPorCodigo(codigo) {
    if (!codigo) return null;
    
    // Encontra o material mais recente com o código informado
    const materiaisComCodigo = materiais.filter(m => m.codigo === codigo);
    if (materiaisComCodigo.length === 0) return null;
    
    // Ordena por data de cadastro decrescente (mais recente primeiro)
    materiaisComCodigo.sort((a, b) => new Date(b.dataCadastro || 0) - new Date(a.dataCadastro || 0));
    
    // Retorna o material mais recente
    const materialMaisRecente = materiaisComCodigo[0];
    
    // Calcular e atualizar o preço médio
    materialMaisRecente.precoMedio = obterPrecoMedioPorCodigo(codigo);
    
    return materialMaisRecente;
}

// Função para encontrar um material pelo nome - OTIMIZADA
function encontrarMaterialPorNome(nome) {
    if (!nome) return null;
    
    // Normalizar o nome para comparação (minúsculas, sem acentos)
    const nomeLimpo = nome.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    
    // Encontrar materiais com nomes similares
    const materiaisComNome = materiais.filter(m => {
        if (!m.nome) return false;
        const materialNomeLimpo = m.nome.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        return materialNomeLimpo === nomeLimpo || materialNomeLimpo.includes(nomeLimpo) || nomeLimpo.includes(materialNomeLimpo);
    });
    
    if (materiaisComNome.length === 0) return null;
    
    // Ordena por data de cadastro decrescente (mais recente primeiro)
    materiaisComNome.sort((a, b) => new Date(b.dataCadastro || 0) - new Date(a.dataCadastro || 0));
    
    // Retorna o material mais recente
    return materiaisComNome[0];
}

// Função para adicionar ou atualizar um material no catálogo - OTIMIZADA
function adicionarOuAtualizarMaterial(codigoMaterial, nomeMaterial, unidadeMaterial, unidadeMedidaMaterial, quantidadeMedidaMaterial, precoMaterial, dataCompra = null) {
    try {
        // Converter valores para números
        quantidadeMedidaMaterial = parseFloat(quantidadeMedidaMaterial);
        precoMaterial = parseFloat(precoMaterial);
        
        // Verificar se valores são válidos
        if (isNaN(quantidadeMedidaMaterial) || quantidadeMedidaMaterial <= 0) {
            mostrarToast('A quantidade por unidade deve ser um número válido maior que zero.', 'error');
            return null;
        }
        
        if (isNaN(precoMaterial) || precoMaterial <= 0) {
            mostrarToast('O preço deve ser um número válido maior que zero.', 'error');
            return null;
        }
        
        // MODIFICADO: Criar sempre um novo registro, mas manter referência do material existente
        const materialExistente = encontrarMaterialPorCodigo(codigoMaterial);
        
        // Se não encontrou por código, tentar encontrar por nome para manter consistência
        const materialPorNome = !materialExistente && nomeMaterial ? encontrarMaterialPorNome(nomeMaterial) : null;
        
        // Definir código correto caso encontrado pelo nome
        if (!codigoMaterial && materialPorNome) {
            codigoMaterial = materialPorNome.codigo;
        }
        
        // Calcular preço médio atualizado
        let historicoPrecos = [];
        let precoMedio = precoMaterial;
        
        if (materialExistente && materialExistente.historicoPrecos) {
            historicoPrecos = [...materialExistente.historicoPrecos];
            // Adicionar novo preço ao histórico
            historicoPrecos.push({
                data: dataCompra || new Date().toISOString(),
                preco: precoMaterial
            });
            
            // Recalcular preço médio
            precoMedio = historicoPrecos.reduce((total, item) => total + (parseFloat(item.preco) || 0), 0) / historicoPrecos.length;
        } else if (materialPorNome && materialPorNome.historicoPrecos) {
            historicoPrecos = [...materialPorNome.historicoPrecos];
            // Adicionar novo preço ao histórico
            historicoPrecos.push({
                data: dataCompra || new Date().toISOString(),
                preco: precoMaterial
            });
            
            // Recalcular preço médio
            precoMedio = historicoPrecos.reduce((total, item) => total + (parseFloat(item.preco) || 0), 0) / historicoPrecos.length;
        } else {
            // Primeiro registro deste material
            historicoPrecos = [{
                data: dataCompra || new Date().toISOString(),
                preco: precoMaterial
            }];
        }
        
        // Criar novo material
        const novoMaterial = {
            id: gerarId(),
            codigo: codigoMaterial || gerarId().substring(0, 8), // Gerar código se não fornecido
            nome: nomeMaterial,
            unidade: unidadeMaterial,
            unidadeMedida: unidadeMedidaMaterial,
            quantidadeMedida: quantidadeMedidaMaterial,
            ultimoPreco: precoMaterial,
            precoMedio: precoMedio,
            ultimaCompra: dataCompra || new Date().toISOString(),
            dataCadastro: new Date().toISOString(),
            historicoPrecos: historicoPrecos
        };
        
        materiais.push(novoMaterial);
        return novoMaterial.id;
    } catch (error) {
        console.error("Erro ao adicionar material:", error);
        mostrarToast("Ocorreu um erro ao adicionar o material", "error");
        return null;
    }
}

// Função para adicionar item ao estoque - OTIMIZADA
function adicionarItemEstoque(materialId, quantidade, preco = null) {
    try {
        const material = materiais.find(m => m.id === materialId);
        if (!material) return false;
        
        // Verificar se a quantidade é válida
        quantidade = parseFloat(quantidade);
        if (isNaN(quantidade) || quantidade <= 0) {
            mostrarToast('A quantidade deve ser um número válido maior que zero.', 'error');
            return false;
        }
        
        // Verificar se existe um item com o mesmo código ou nome no estoque
        const itemPorCodigo = estoque.find(i => {
            const materialItem = materiais.find(m => m.id === i.materialId);
            return materialItem && materialItem.codigo === material.codigo;
        });
        
        const itemPorNome = estoque.find(i => {
            const materialItem = materiais.find(m => m.id === i.materialId);
            return materialItem && materialItem.nome.toLowerCase() === material.nome.toLowerCase();
        });
        
        const itemExistente = itemPorCodigo || itemPorNome;
        
        if (itemExistente) {
            // Atualizar item existente - somar quantidade
            itemExistente.quantidade += quantidade;
            
            // Atualizar com o código do material atual se não tiver
            if (!itemExistente.codigo && material.codigo) {
                itemExistente.codigo = material.codigo;
            }
            
            // Usar preço médio do material para consistência
            itemExistente.preco = material.precoMedio;
            
            return true;
        } else {
            // Criar novo item
            const novoItem = {
                id: gerarId(),
                materialId: materialId,
                codigo: material.codigo,
                nome: material.nome,
                quantidade: quantidade,
                unidade: material.unidade,
                unidadeMedida: material.unidadeMedida,
                quantidadeMedida: material.quantidadeMedida,
                preco: material.precoMedio, // Usar preço médio em vez do preço atual
                dataAdicao: new Date().toISOString()
            };
            
            estoque.push(novoItem);
            return true;
        }
    } catch (error) {
        console.error("Erro ao adicionar item ao estoque:", error);
        mostrarToast("Ocorreu um erro ao adicionar item ao estoque", "error");
        return false;
    }
}

// Função para remover item do estoque - OTIMIZADA
function removerItemEstoque(materialId, quantidade, unidadeMedida) {
    try {
        // Tenta encontrar o material específico
        const material = materiais.find(m => m.id === materialId);
        if (!material) return false;
        
        // Procurar por itens no estoque com mesmo código ou nome
        const itensPossiveis = estoque.filter(i => {
            const materialItem = materiais.find(m => m.id === i.materialId);
            return materialItem && 
                   (materialItem.codigo === material.codigo || 
                    materialItem.nome.toLowerCase() === material.nome.toLowerCase());
        });
        
        if (itensPossiveis.length === 0) return false;
        
        // Normalizar unidades para a menor unidade (g ou ml)
        let quantidadeNormalizada = quantidade;
        
        // Se a unidade de medida for passada, converter conforme necessário
        if (unidadeMedida) {
            // Pegar a unidade do primeiro item encontrado para conversão
            const item = itensPossiveis[0];
            
            // Converter KG para g, L para ml
            if (unidadeMedida.toLowerCase() === 'kg' && item.unidadeMedida.toLowerCase() === 'g') {
                quantidadeNormalizada *= 1000;
            } else if (unidadeMedida.toLowerCase() === 'l' && item.unidadeMedida.toLowerCase() === 'ml') {
                quantidadeNormalizada *= 1000;
            }
            // Converter g para kg, ml para l se necessário
            else if (unidadeMedida.toLowerCase() === 'g' && item.unidadeMedida.toLowerCase() === 'kg') {
                quantidadeNormalizada /= 1000;
            } else if (unidadeMedida.toLowerCase() === 'ml' && item.unidadeMedida.toLowerCase() === 'l') {
                quantidadeNormalizada /= 1000;
            }
        }
        
        // Converter a quantidade solicitada para unidades do estoque
        let quantidadeRestanteRemover = quantidadeNormalizada;
        let removidoComSucesso = false;
        
        // Ordenar os itens do mais antigo para o mais recente para consumir primeiro os mais antigos
        itensPossiveis.sort((a, b) => new Date(a.dataAdicao || 0) - new Date(b.dataAdicao || 0));
        
        // Remover de cada item até completar a quantidade necessária
        for (const item of itensPossiveis) {
            if (quantidadeRestanteRemover <= 0) break;
            
            // Converter para unidades do item atual
            const quantidadeEmUnidades = quantidadeRestanteRemover / (item.quantidadeMedida || 1);
            
            if (item.quantidade >= quantidadeEmUnidades) {
                // Este item tem quantidade suficiente
                item.quantidade -= quantidadeEmUnidades;
                quantidadeRestanteRemover = 0;
                removidoComSucesso = true;
                break;
            } else {
                // Este item não tem quantidade suficiente, remover o que puder
                quantidadeRestanteRemover -= (item.quantidade * (item.quantidadeMedida || 1));
                item.quantidade = 0;
                removidoComSucesso = true;
            }
        }
        
        // Remover itens com quantidade zero
        estoque = estoque.filter(item => item.quantidade > 0);
        
        return removidoComSucesso;
    } catch (error) {
        console.error("Erro ao remover item do estoque:", error);
        mostrarToast("Ocorreu um erro ao remover item do estoque", "error");
        return false;
    }
}

// Função para adicionar estoque de volta (quando cancela uma venda) - OTIMIZADA
function adicionarEstoqueDeVolta(materialId, quantidade, unidadeMedida) {
    try {
        // Essa função é o inverso de removerItemEstoque
        const material = materiais.find(m => m.id === materialId);
        if (!material) return false;
        
        // Verificar se já existe um item deste material no estoque
        const itensPossiveis = estoque.filter(i => {
            const materialItem = materiais.find(m => m.id === i.materialId);
            return materialItem && 
                   (materialItem.codigo === material.codigo || 
                    materialItem.nome.toLowerCase() === material.nome.toLowerCase());
        });
        
        // Normalizar unidades
        let quantidadeNormalizada = quantidade;
        
        if (unidadeMedida && itensPossiveis.length > 0) {
            const item = itensPossiveis[0];
            
            // Converter KG para g, L para ml
            if (unidadeMedida.toLowerCase() === 'kg' && item.unidadeMedida.toLowerCase() === 'g') {
                quantidadeNormalizada *= 1000;
            } else if (unidadeMedida.toLowerCase() === 'l' && item.unidadeMedida.toLowerCase() === 'ml') {
                quantidadeNormalizada *= 1000;
            }
            // Converter g para kg, ml para l se necessário
            else if (unidadeMedida.toLowerCase() === 'g' && item.unidadeMedida.toLowerCase() === 'kg') {
                quantidadeNormalizada /= 1000;
            } else if (unidadeMedida.toLowerCase() === 'ml' && item.unidadeMedida.toLowerCase() === 'l') {
                quantidadeNormalizada /= 1000;
            }
        }
        
        if (itensPossiveis.length > 0) {
            // Adicionar ao primeiro item encontrado
            const itemEstoque = itensPossiveis[0];
            const quantidadeEmUnidades = quantidadeNormalizada / (itemEstoque.quantidadeMedida || 1);
            itemEstoque.quantidade += quantidadeEmUnidades;
        } else {
            // Criar novo item no estoque
            const novoItem = {
                id: gerarId(),
                materialId: materialId,
                codigo: material.codigo,
                nome: material.nome,
                quantidade: quantidade / (material.quantidadeMedida || 1), // Converter para unidades
                unidade: material.unidade,
                unidadeMedida: material.unidadeMedida,
                quantidadeMedida: material.quantidadeMedida,
                preco: material.precoMedio, // Usar preço médio
                dataAdicao: new Date().toISOString()
            };
            
            estoque.push(novoItem);
        }
        
        return true;
    } catch (error) {
        console.error("Erro ao adicionar estoque de volta:", error);
        mostrarToast("Ocorreu um erro ao adicionar estoque de volta", "error");
        return false;
    }
}

// Função para unificar itens de estoque - OTIMIZADA (CORRIGIDA)
function unificarEstoque() {
    try {
        // Cria um novo array para armazenar o estoque unificado
        const estoqueUnificado = [];
        const itensPorCodigo = {};
        const itensPorNome = {};
        
        // Verifica se há itens no estoque
        if (!estoque || estoque.length === 0) {
            return estoqueUnificado;
        }
        
        // Primeiro agrupamos por código
        for (const item of estoque) {
            try {
                if (!item || !item.materialId) continue;
                
                // Encontrar o material associado
                const material = materiais.find(m => m.id === item.materialId);
                if (!material) continue;
                
                const codigo = material.codigo;
                if (codigo) {
                    if (!itensPorCodigo[codigo]) {
                        itensPorCodigo[codigo] = {
                            id: gerarId(),
                            materialId: material.id,
                            codigo: codigo,
                            nome: material.nome,
                            quantidade: 0,
                            unidade: material.unidade,
                            unidadeMedida: material.unidadeMedida,
                            quantidadeMedida: material.quantidadeMedida,
                            preco: material.precoMedio || 0,
                            dataAdicao: new Date().toISOString()
                        };
                    }
                    
                    // Somar quantidade normalizada
                    itensPorCodigo[codigo].quantidade += (parseFloat(item.quantidade) || 0);
                }
            } catch (err) {
                console.error("Erro ao processar item para unificação por código:", err);
                continue;
            }
        }
        
        // Depois agrupamos os que não têm código por nome
        for (const item of estoque) {
            try {
                if (!item || !item.materialId) continue;
                
                const material = materiais.find(m => m.id === item.materialId);
                if (!material || material.codigo) continue; // Ignorar se tem código ou sem material
                
                const nome = material.nome ? material.nome.toLowerCase() : "";
                if (!nome) continue;
                
                if (!itensPorNome[nome]) {
                    itensPorNome[nome] = {
                        id: gerarId(),
                        materialId: material.id,
                        codigo: "",
                        nome: material.nome,
                        quantidade: 0,
                        unidade: material.unidade,
                        unidadeMedida: material.unidadeMedida,
                        quantidadeMedida: material.quantidadeMedida,
                        preco: material.precoMedio || 0,
                        dataAdicao: new Date().toISOString()
                    };
                }
                
                // Somar quantidade normalizada
                itensPorNome[nome].quantidade += (parseFloat(item.quantidade) || 0);
            } catch (err) {
                console.error("Erro ao processar item para unificação por nome:", err);
                continue;
            }
        }
        
        // Combinar os resultados
        for (const codigo in itensPorCodigo) {
            if (itensPorCodigo[codigo].quantidade > 0) {
                estoqueUnificado.push(itensPorCodigo[codigo]);
            }
        }
        
        for (const nome in itensPorNome) {
            // Verificar se já não foi adicionado por código
            const jaAdicionado = estoqueUnificado.some(item => 
                item.nome && nome && item.nome.toLowerCase() === nome);
            
            if (!jaAdicionado && itensPorNome[nome].quantidade > 0) {
                estoqueUnificado.push(itensPorNome[nome]);
            }
        }
        
        // Não substituir o estoque original pelo unificado, apenas retornar o unificado
        return estoqueUnificado;
    } catch (error) {
        console.error("Erro ao unificar estoque:", error);
        return []; // Retornar array vazio em caso de erro
    }
}

// Função para remover um material e todas suas referências - OTIMIZADA (CORRIGIDA)
function removerMaterial(id) {
    try {
        // Encontrar o material a ser removido
        const material = materiais.find(m => m.id === id);
        if (!material) {
            mostrarToast("Material não encontrado", "error");
            return false;
        }
        
        const codigo = material.codigo;
        const nome = material.nome;
        
        // Remover o material da lista de materiais
        const indexMaterial = materiais.findIndex(m => m.id === id);
        if (indexMaterial !== -1) {
            materiais.splice(indexMaterial, 1);
        }
        
        // Atualizar localStorage e recarregar interfaces
        atualizarLocalStorage();
        
        // Recarregar interfaces
        carregarMateriais();
        carregarEstoque();
        
        mostrarToast("Material removido com sucesso!", "success");
        return true;
    } catch (error) {
        console.error("Erro ao remover material:", error);
        mostrarToast("Erro ao remover material", "error");
        return false;
    }
}

// Função para carregar materiais na tabela - OTIMIZADA
function carregarMateriais() {
    try {
        const tbody = document.getElementById('itens-materiais');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (materiais.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="9" style="text-align: center;">Nenhum material cadastrado.</td>';
            tbody.appendChild(tr);
            return;
        }
        
        // Ordenar materiais pelo mais recente primeiro
        const materiaisOrdenados = [...materiais].sort((a, b) => new Date(b.dataCadastro || 0) - new Date(a.dataCadastro || 0));
        
        materiaisOrdenados.forEach(material => {
            // Calcular o preço médio para este código
            let precoMedio = 0;
            if (material.codigo) {
                precoMedio = obterPrecoMedioPorCodigo(material.codigo);
            } else {
                // Se não tem código, calcular pelo nome
                const materiaisMesmoNome = materiais.filter(m => 
                    m.nome && m.nome.toLowerCase() === material.nome.toLowerCase());
                
                if (materiaisMesmoNome.length > 0) {
                    let todosPrecos = [];
                    materiaisMesmoNome.forEach(m => {
                        if (m.historicoPrecos && m.historicoPrecos.length > 0) {
                            todosPrecos = todosPrecos.concat(m.historicoPrecos);
                        }
                    });
                    
                    if (todosPrecos.length > 0) {
                        precoMedio = todosPrecos.reduce((total, item) => total + (parseFloat(item.preco) || 0), 0) / todosPrecos.length;
                    } else {
                        precoMedio = material.ultimoPreco || 0;
                    }
                } else {
                    precoMedio = material.ultimoPreco || 0;
                }
            }
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${material.codigo || 'N/A'}</td>
                <td>${material.nome}</td>
                <td>${material.unidade}</td>
                <td>${material.unidadeMedida}</td>
                <td>${material.quantidadeMedida}</td>
                <td>${formatarData(material.ultimaCompra)}</td>
                <td>${formatarMoeda(material.ultimoPreco)}</td>
                <td>${formatarMoeda(precoMedio)}</td>
                <td>
                    <button class="btn btn-primary btn-editar-material" data-id="${material.id}">Editar</button>
                    <button class="btn btn-success btn-adicionar-estoque" data-id="${material.id}">+ Estoque</button>
                    <button class="btn btn-danger btn-remover-material" data-id="${material.id}">Excluir</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        // Configurar eventos para os botões usando delegação
        const tabelaMateriais = document.getElementById('itens-materiais');
        if (tabelaMateriais) {
            // Remover eventos existentes antes de adicionar novos
            EventManager.delegateEvent(tabelaMateriais, '.btn-editar-material', 'click', function() {
                const id = this.getAttribute('data-id');
                const material = materiais.find(m => m.id === id);
                const index = materiais.indexOf(material);
                if (index !== -1) {
                    editarMaterial(index);
                }
            });
            
            EventManager.delegateEvent(tabelaMateriais, '.btn-adicionar-estoque', 'click', function() {
                const id = this.getAttribute('data-id');
                adicionarAoEstoque(id);
            });
            
            EventManager.delegateEvent(tabelaMateriais, '.btn-remover-material', 'click', function() {
                const id = this.getAttribute('data-id');
                removerMaterial(id);
            });
        }
    } catch (error) {
        console.error("Erro ao carregar materiais:", error);
        mostrarToast("Erro ao carregar materiais", "error");
    }
}

// Função para editar um material - OTIMIZADA
function editarMaterial(index) {
    try {
        const material = materiais[index];
        if(!material) return;
        
        // Mudar para a aba de adicionar item
        const tabButton = document.querySelector('.tab-button[data-tab="adicionar-item"]');
        if (tabButton) {
            tabButton.click();
        }
        
        // Preencher o formulário
        document.getElementById('codigo-material').value = material.codigo || '';
        document.getElementById('nome-material').value = material.nome;
        document.getElementById('unidade-material').value = material.unidade;
        document.getElementById('unidade-medida-material').value = material.unidadeMedida;
        document.getElementById('quantidade-medida-material').value = material.quantidadeMedida;
        document.getElementById('preco-material').value = material.ultimoPreco;
        
        // Quantidade para estoque
        document.getElementById('quantidade-material').value = 1;
        
        // Data de compra
        const dataCompra = document.getElementById('data-compra-material');
        if (dataCompra) {
            const data = new Date(material.ultimaCompra);
            dataCompra.value = data.toISOString().split('T')[0];
        }
        
        // Mostrar informações de preço médio
        const infoPrecoMedio = document.getElementById('info-preco-medio');
        if (infoPrecoMedio) {
            // Contar todos os registros de preço para este material (por código)
            let todosPrecos = [];
            const materialCodigoIgual = materiais.filter(m => m.codigo === material.codigo);
            
            materialCodigoIgual.forEach(m => {
                if (m.historicoPrecos && m.historicoPrecos.length > 0) {
                    todosPrecos = todosPrecos.concat(m.historicoPrecos);
                }
            });
            
            if (todosPrecos.length > 0) {
                const precoMedio = todosPrecos.reduce((total, item) => total + (parseFloat(item.preco) || 0), 0) / todosPrecos.length;
                document.getElementById('valor-preco-medio').textContent = formatarMoeda(precoMedio);
                document.getElementById('num-registros').textContent = todosPrecos.length;
                infoPrecoMedio.classList.remove('hidden');
            } else {
                infoPrecoMedio.classList.add('hidden');
            }
        }
        
        // Modificar o botão de submit
        const submitBtn = document.querySelector('#form-adicionar-material button[type="submit"]');
        if (submitBtn) {
            submitBtn.textContent = 'Atualizar Material';
            submitBtn.setAttribute('data-edicao', index);
        }
    } catch (error) {
        console.error("Erro ao editar material:", error);
        mostrarToast("Erro ao editar material", "error");
    }
}

// Função para adicionar um material ao estoque - OTIMIZADA (CORRIGIDA)
function adicionarAoEstoque(materialId) {
    try {
        const material = materiais.find(m => m.id === materialId);
        if (!material) {
            mostrarToast("Material não encontrado", "error");
            return;
        }
        
        // Mudar para a aba de adicionar item
        const tabButton = document.querySelector('.tab-button[data-tab="adicionar-item"]');
        if (tabButton) {
            tabButton.click();
            
            // Limpar o formulário antes de preenchê-lo
            document.getElementById('form-adicionar-material').reset();
        }
        
        // Preencher o formulário com os dados do material
        document.getElementById('codigo-material').value = material.codigo || '';
        document.getElementById('nome-material').value = material.nome;
        document.getElementById('quantidade-material').value = 1;
        document.getElementById('unidade-material').value = material.unidade;
        document.getElementById('unidade-medida-material').value = material.unidadeMedida;
        document.getElementById('quantidade-medida-material').value = material.quantidadeMedida;
        document.getElementById('preco-material').value = material.ultimoPreco;
        
        // Mostrar informações de preço médio
        const infoPrecoMedio = document.getElementById('info-preco-medio');
        if (infoPrecoMedio) {
            // Calcular preço médio do material
            const precoMedio = obterPrecoMedioPorCodigo(material.codigo);
            if (precoMedio > 0) {
                document.getElementById('valor-preco-medio').textContent = formatarMoeda(precoMedio);
                
                // Contar registros
                let numRegistros = 0;
                const materiaisComCodigo = materiais.filter(m => m.codigo === material.codigo);
                materiaisComCodigo.forEach(m => {
                    if (m.historicoPrecos) numRegistros += m.historicoPrecos.length;
                });
                
                document.getElementById('num-registros').textContent = numRegistros;
                infoPrecoMedio.classList.remove('hidden');
            } else {
                infoPrecoMedio.classList.add('hidden');
            }
        }
        
        // Data atual para compra
        const dataCompra = document.getElementById('data-compra-material');
        if (dataCompra) {
            const hoje = new Date();
            dataCompra.value = hoje.toISOString().split('T')[0];
        }
        
        mostrarToast("Material carregado para adicionar ao estoque", "success");
    } catch (error) {
        console.error("Erro ao adicionar ao estoque:", error);
        mostrarToast("Erro ao adicionar ao estoque", "error");
    }
}

// Função para carregar o estoque na tabela - OTIMIZADA (CORRIGIDA)
function carregarEstoque() {
    try {
        const tbody = document.getElementById('itens-estoque');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (estoque.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="5" style="text-align: center;">Nenhum item no estoque.</td>';
            tbody.appendChild(tr);
            return;
        }
        
        // Unificar estoque antes de exibir
        const estoqueUnificado = unificarEstoque();
        
        if (estoqueUnificado.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="5" style="text-align: center;">Nenhum item no estoque após unificação.</td>';
            tbody.appendChild(tr);
            return;
        }
        
        estoqueUnificado.forEach((item) => {
            try {
                // Calcular a quantidade em unidade de medida (ex: ml restantes)
                const quantidadeTotalMedida = (parseFloat(item.quantidade) || 0) * (parseFloat(item.quantidadeMedida) || 1);
                // Verificar se é um número fracionário
                const quantidadeFracionada = (parseFloat(item.quantidade) || 0) % 1 !== 0;
                
                const tr = document.createElement('tr');
                tr.className = 'estoque-unificado';
                tr.innerHTML = `
                    <td>${item.codigo || 'N/A'}</td>
                    <td>${item.nome || 'Sem nome'}</td>
                    <td>${(parseFloat(item.quantidade) || 0).toFixed(2)} ${quantidadeFracionada ? `(${Math.floor(item.quantidade)} + ${((item.quantidade % 1) * 100).toFixed(0)}%)` : ''}</td>
                    <td>${item.unidade || 'N/A'}</td>
                    <td>${quantidadeTotalMedida.toFixed(0)} ${item.unidadeMedida || 'N/A'}</td>
                `;
                tbody.appendChild(tr);
            } catch (err) {
                console.error("Erro ao renderizar item do estoque:", err);
            }
        });
    } catch (error) {
        console.error("Erro ao carregar estoque:", error);
        mostrarToast("Erro ao carregar estoque", "error");
    }
}

// Função aprimorada para tratar eventos de busca pelo código do material
function adicionarEventoCodigoMaterial() {
    const codigoInput = document.getElementById('codigo-material');
    if (!codigoInput) return;
    
    // Remover eventos anteriores
    codigoInput.removeEventListener('keypress', handleCodigoKeyPress);
    codigoInput.removeEventListener('blur', handleCodigoBlur);
    
    // Adicionar eventos
    codigoInput.addEventListener('keypress', handleCodigoKeyPress);
    codigoInput.addEventListener('blur', handleCodigoBlur);
    
    // Adicionar evento para o botão scanner
    const scannerBtn = document.getElementById('scanner-btn');
    if (scannerBtn) {
        scannerBtn.removeEventListener('click', iniciarScanner);
        scannerBtn.addEventListener('click', iniciarScanner);
    }
    
    // Adicionar evento para parar o scanner
    const stopScannerBtn = document.getElementById('stop-scanner');
    if (stopScannerBtn) {
        stopScannerBtn.removeEventListener('click', pararScanner);
        stopScannerBtn.addEventListener('click', pararScanner);
    }
}

// Handler para keypress no campo de código
function handleCodigoKeyPress(e) {
    // Verificar se a tecla pressionada foi Enter
    if (e.key === 'Enter') {
        e.preventDefault(); // Impedir o envio do formulário
        
        const codigo = this.value.trim();
        if (codigo) {
            buscarInformacoesProduto(codigo);
        }
    }
}

// Handler para blur no campo de código
function handleCodigoBlur(e) {
    const codigo = this.value.trim();
    if (codigo) {
        buscarInformacoesProduto(codigo);
    }
}

// Função para buscar informações do produto - OTIMIZADA
function buscarInformacoesProduto(codigo) {
    try {
        // Verificar se o código já existe no catálogo
        const materialExistente = encontrarMaterialPorCodigo(codigo);
        
        if (materialExistente) {
            // Preencher formulário com dados existentes
            document.getElementById('nome-material').value = materialExistente.nome;
            document.getElementById('unidade-material').value = materialExistente.unidade;
            document.getElementById('unidade-medida-material').value = materialExistente.unidadeMedida;
            document.getElementById('quantidade-medida-material').value = materialExistente.quantidadeMedida;
            document.getElementById('preco-material').value = materialExistente.ultimoPreco;
            
            // Mostrar informações de preço médio
            const infoPrecoMedio = document.getElementById('info-preco-medio');
            if (infoPrecoMedio) {
                const precoMedio = obterPrecoMedioPorCodigo(codigo);
                if (precoMedio > 0) {
                    document.getElementById('valor-preco-medio').textContent = formatarMoeda(precoMedio);
                    
                    // Contar registros
                    let numRegistros = 0;
                    const materiaisComCodigo = materiais.filter(m => m.codigo === codigo);
                    materiaisComCodigo.forEach(m => {
                        if (m.historicoPrecos) numRegistros += m.historicoPrecos.length;
                    });
                    
                    document.getElementById('num-registros').textContent = numRegistros;
                    infoPrecoMedio.classList.remove('hidden');
                } else {
                    infoPrecoMedio.classList.add('hidden');
                }
            }
            
            mostrarToast('Produto encontrado no catálogo!', 'success');
        } else {
            // Verificar se há um produto com nome similar
            const query = document.getElementById('nome-material').value;
            if (query && query.length > 2) {
                const materialPorNome = encontrarMaterialPorNome(query);
                if (materialPorNome) {
                    if (confirm(`Encontramos um material similar: "${materialPorNome.nome}". Deseja usar suas informações?`)) {
                        document.getElementById('unidade-material').value = materialPorNome.unidade;
                        document.getElementById('unidade-medida-material').value = materialPorNome.unidadeMedida;
                        document.getElementById('quantidade-medida-material').value = materialPorNome.quantidadeMedida;
                        document.getElementById('preco-material').value = materialPorNome.ultimoPreco;
                        
                        // Se não tem código, sugerir usar o mesmo código
                        if (!codigo && materialPorNome.codigo) {
                            document.getElementById('codigo-material').value = materialPorNome.codigo;
                        }
                        
                        mostrarToast('Informações preenchidas com base no material similar', 'success');
                        return;
                    }
                }
            }
            
            mostrarToast('Produto não encontrado. Preencha manualmente.', 'info');
        }
    } catch (error) {
        console.error("Erro ao buscar informações do produto:", error);
        mostrarToast("Erro ao buscar informações", "error");
    }
}

// FUNÇÕES PARA SCANNER DE QR CODE/CÓDIGO DE BARRAS
function iniciarScanner() {
    try {
        const scannerContainer = document.getElementById('scanner-container');
        if (!scannerContainer) {
            mostrarToast("Container do scanner não encontrado", "error");
            return;
        }
        
        scannerContainer.classList.remove('hidden');
        
        // Se já existe um scanner em execução, para-lo
        if (html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop().catch(err => console.error('Erro ao parar scanner:', err));
        }
        
        html5QrCode = new Html5Qrcode("reader");
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        
        html5QrCode.start(
            { facingMode: "environment" }, 
            config, 
            onScanSuccess, 
            onScanFailure
        ).catch(error => {
            console.error("Erro ao iniciar scanner:", error);
            mostrarToast("Erro ao iniciar scanner: " + error.message, "error");
        });
        
        mostrarToast("Scanner iniciado", "success");
    } catch (error) {
        console.error("Erro ao iniciar scanner:", error);
        mostrarToast("Erro ao iniciar scanner", "error");
    }
}

function pararScanner() {
    if (html5QrCode && html5QrCode.isScanning) {
        html5QrCode.stop().then(() => {
            console.log('Scanner parado.');
            document.getElementById('scanner-container').classList.add('hidden');
            mostrarToast("Scanner parado", "success");
        }).catch(err => {
            console.error('Erro ao parar o scanner:', err);
            mostrarToast("Erro ao parar scanner", "error");
        });
    } else {
        document.getElementById('scanner-container').classList.add('hidden');
    }
}

function onScanSuccess(decodedText, decodedResult) {
    console.log(`Código escaneado: ${decodedText}`);
    
    // Preencher o campo de código
    document.getElementById('codigo-material').value = decodedText;
    
    // Mostrar resultado
    const scannerResult = document.getElementById('scanner-result');
    if (scannerResult) {
        scannerResult.innerHTML = `
            <div class="notification notification-success">
                Código detectado: ${decodedText}
            </div>
        `;
    }
    
    // Parar o scanner
    pararScanner();
    
    // Buscar informações do produto
    buscarInformacoesProduto(decodedText);
}

function onScanFailure(error) {
    // Silenciar erro para não encher o console
    // console.error('Falha no scanner:', error);
}
// PARTE 6: JAVASCRIPT - FUNÇÕES DE CÁLCULO PARA RECEITAS

// Função para calcular o custo de uma receita - OTIMIZADA
function calcularCustoReceita(receita) {
    try {
        if (!receita || !receita.ingredientes || receita.ingredientes.length === 0) return 0;
        
        let custoTotal = 0;
        
        for (const ingrediente of receita.ingredientes) {
            // Encontrar o material com base no materialId do ingrediente
            const material = materiais.find(m => m.id === ingrediente.materialId);
            if (!material) continue;
            
            // Obter o preço médio para o código ou nome do material
            let precoMedio = 0;
            
            if (material.codigo) {
                // Primeiro tenta pelo código
                precoMedio = obterPrecoMedioPorCodigo(material.codigo);
            }
            
            if (precoMedio === 0 && material.nome) {
                // Se não encontrou pelo código ou preço é zero, tenta pelo nome
                const materiaisMesmoNome = materiais.filter(m => 
                    m.nome && m.nome.toLowerCase() === material.nome.toLowerCase());
                
                if (materiaisMesmoNome.length > 0) {
                    // Calcular preço médio de todos os registros com mesmo nome
                    let todosPrecos = [];
                    materiaisMesmoNome.forEach(m => {
                        if (m.historicoPrecos && m.historicoPrecos.length > 0) {
                            todosPrecos = todosPrecos.concat(m.historicoPrecos);
                        }
                    });
                    
                    if (todosPrecos.length > 0) {
                        precoMedio = todosPrecos.reduce((total, registro) => total + (parseFloat(registro.preco) || 0), 0) / todosPrecos.length;
                    } else {
                        // Se não tem histórico, usar o preço atual do material
                        precoMedio = material.ultimoPreco || 0;
                    }
                } else {
                    // Se não encontrou materiais com mesmo nome, usar o preço do material atual
                    precoMedio = material.ultimoPreco || 0;
                }
            }
            
            // Se ainda não temos preço, usar o último preço do material
            if (precoMedio === 0) {
                precoMedio = material.ultimoPreco || 0;
            }
            
            // Calculamos o custo com base na quantidade especificada
            const quantidadeMedida = parseFloat(material.quantidadeMedida) || 1;
            custoTotal += precoMedio * parseFloat(ingrediente.quantidade) / quantidadeMedida;
        }
        
        return custoTotal;
    } catch (error) {
        console.error("Erro ao calcular custo da receita:", error);
        return 0;
    }
}

// Função para adicionar campo de ingrediente - OTIMIZADA
function adicionarCampoIngrediente(ingredienteData = null) {
    try {
        const container = document.getElementById('lista-ingredientes');
        if (!container) return;
        
        // Verificar se existem materiais
        if (materiais.length === 0) {
            container.innerHTML = `
                <div class="notification notification-warning">
                    Nenhum material cadastrado. Adicione materiais antes de criar receitas.
                </div>
            `;
            return;
        }
        
        // Criar elemento div para o ingrediente
        const div = document.createElement('div');
        div.className = 'ingrediente-item';
        div.innerHTML = `
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label>Ingrediente:</label>
                        <select class="form-control ingrediente-select" required>
                            <option value="">Selecione um ingrediente...</option>
                            ${obterOpcoesIngredientes()}
                        </select>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label>Quantidade:</label>
                        <input type="number" class="form-control ingrediente-quantidade" min="0.01" step="0.01" required>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label>Unidade de Medida:</label>
                        <select class="form-control ingrediente-unidade-medida" required>
                            <option value="kg">Quilogramas (kg)</option>
                            <option value="g">Gramas (g)</option>
                            <option value="l">Litros (l)</option>
                            <option value="ml">Mililitros (ml)</option>
                        </select>
                    </div>
                </div>
                <div class="form-col" style="flex: 0.5;">
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" class="btn btn-danger remover-ingrediente" style="display: block;">X</button>
                    </div>
                </div>
            </div>
            <div class="ingrediente-preco-info">
                <span>Preço médio: <span class="ingrediente-preco-medio">R$ 0,00</span></span>
                <span>Custo: <span class="ingrediente-custo">R$ 0,00</span></span>
            </div>
        `;
        container.appendChild(div);
        
        // Configurar o novo campo
        const select = div.querySelector('.ingrediente-select');
        const quantidadeInput = div.querySelector('.ingrediente-quantidade');
        const unidadeMedidaSelect = div.querySelector('.ingrediente-unidade-medida');
        const removerBtn = div.querySelector('.remover-ingrediente');
        const precoMedioSpan = div.querySelector('.ingrediente-preco-medio');
        const custoSpan = div.querySelector('.ingrediente-custo');
        
        // Preencher com dados se fornecidos
        if (ingredienteData) {
            select.value = ingredienteData.materialId;
            quantidadeInput.value = ingredienteData.quantidade;
            unidadeMedidaSelect.value = ingredienteData.unidadeMedida || 'g';
            
            // Atualizar preço médio e custo
            atualizarPrecoMedioIngrediente(select, quantidadeInput, unidadeMedidaSelect, precoMedioSpan, custoSpan);
        }
        
        // Adicionar eventos
        select.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.value) {
                const unidadeMedida = selectedOption.getAttribute('data-unidade-medida');
                if (unidadeMedida) {
                    unidadeMedidaSelect.value = unidadeMedida;
                }
                
                // Atualizar preço médio e custo
                atualizarPrecoMedioIngrediente(select, quantidadeInput, unidadeMedidaSelect, precoMedioSpan, custoSpan);
                
                // Atualizar cálculos da receita
                atualizarCalculosReceita();
            }
        });
        
        quantidadeInput.addEventListener('input', function() {
            // Atualizar preço médio e custo
            atualizarPrecoMedioIngrediente(select, quantidadeInput, unidadeMedidaSelect, precoMedioSpan, custoSpan);
            atualizarCalculosReceita();
        });
        
        unidadeMedidaSelect.addEventListener('change', function() {
            // Atualizar preço médio e custo
            atualizarPrecoMedioIngrediente(select, quantidadeInput, unidadeMedidaSelect, precoMedioSpan, custoSpan);
            atualizarCalculosReceita();
        });
        
        removerBtn.addEventListener('click', function() {
            container.removeChild(div);
            atualizarCalculosReceita();
        });
    } catch (error) {
        console.error("Erro ao adicionar campo de ingrediente:", error);
    }
}

// Função para atualizar o preço médio e custo do ingrediente - OTIMIZADA
function atualizarPrecoMedioIngrediente(select, quantidadeInput, unidadeMedidaSelect, precoMedioSpan, custoSpan) {
    try {
        const materialId = select.value;
        if (!materialId) {
            precoMedioSpan.textContent = 'R$ 0,00';
            custoSpan.textContent = 'R$ 0,00';
            return;
        }
        
        const material = materiais.find(m => m.id === materialId);
        if (!material) {
            precoMedioSpan.textContent = 'R$ 0,00';
            custoSpan.textContent = 'R$ 0,00';
            return;
        }
        
        // Obter preço médio
        let precoMedio = 0;
        
        if (material.codigo) {
            precoMedio = obterPrecoMedioPorCodigo(material.codigo);
        }
        
        if (precoMedio === 0) {
            // Tentar pelo nome
            const materiaisMesmoNome = materiais.filter(m => 
                m.nome && m.nome.toLowerCase() === material.nome.toLowerCase());
            
            if (materiaisMesmoNome.length > 0) {
                let todosPrecos = [];
                materiaisMesmoNome.forEach(m => {
                    if (m.historicoPrecos && m.historicoPrecos.length > 0) {
                        todosPrecos = todosPrecos.concat(m.historicoPrecos);
                    }
                });
                
                if (todosPrecos.length > 0) {
                    precoMedio = todosPrecos.reduce((total, registro) => total + (parseFloat(registro.preco) || 0), 0) / todosPrecos.length;
                }
            }
        }
        
        // Se ainda não tem preço, usar o último preço do material
        if (precoMedio === 0) {
            precoMedio = material.ultimoPreco || 0;
        }
        
        // Calcular o custo baseado na quantidade e unidade
        const quantidade = parseFloat(quantidadeInput.value) || 0;
        const unidadeMedida = unidadeMedidaSelect.value;
        
        // Normalizar unidades para calcular o custo
        let quantidadeNormalizada = quantidade;
        let materialUnidadeMedida = material.unidadeMedida ? material.unidadeMedida.toLowerCase() : '';
        
        // Converter KG para g, L para ml se necessário
        if (unidadeMedida.toLowerCase() === 'kg' && materialUnidadeMedida === 'g') {
            quantidadeNormalizada *= 1000;
        } else if (unidadeMedida.toLowerCase() === 'l' && materialUnidadeMedida === 'ml') {
            quantidadeNormalizada *= 1000;
        }
        // Converter g para kg, ml para l se necessário
        else if (unidadeMedida.toLowerCase() === 'g' && materialUnidadeMedida === 'kg') {
            quantidadeNormalizada /= 1000;
        } else if (unidadeMedida.toLowerCase() === 'ml' && materialUnidadeMedida === 'l') {
            quantidadeNormalizada /= 1000;
        }
        
        // Calcular o custo em R$ por unidade de medida
        const precoUnitarioMedida = precoMedio / (parseFloat(material.quantidadeMedida) || 1);
        const custo = precoUnitarioMedida * quantidadeNormalizada;
        
        // Atualizar os textos
        precoMedioSpan.textContent = formatarMoeda(precoMedio);
        custoSpan.textContent = formatarMoeda(custo);
    } catch (error) {
        console.error("Erro ao atualizar preço médio do ingrediente:", error);
        precoMedioSpan.textContent = 'R$ 0,00';
        custoSpan.textContent = 'R$ 0,00';
    }
}

// Função para obter opções de ingredientes - OTIMIZADA
function obterOpcoesIngredientes() {
    try {
        // Função para simplificar nome de materiais (remover acentos, minúsculas)
        const simplificarNome = (nome) => {
            if (!nome) return '';
            return nome.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        };
        
        // Agrupar materiais por nome simplificado
        const materiaisPorNome = {};
        
        // Primeiro adicionar todos os materiais (inclusive os que não estão no estoque)
        materiais.forEach(material => {
            if (!material || !material.nome) return;
            
            const nomeSimplificado = simplificarNome(material.nome);
            
            // Calcular preço médio
            let precoMedio = 0;
            if (material.codigo) {
                precoMedio = obterPrecoMedioPorCodigo(material.codigo);
            } else {
                const materiaisMesmoNome = materiais.filter(m => 
                    m.nome && simplificarNome(m.nome) === nomeSimplificado);
                
                if (materiaisMesmoNome.length > 0) {
                    let todosPrecos = [];
                    materiaisMesmoNome.forEach(m => {
                        if (m.historicoPrecos && m.historicoPrecos.length > 0) {
                            todosPrecos = todosPrecos.concat(m.historicoPrecos);
                        }
                    });
                    
                    if (todosPrecos.length > 0) {
                        precoMedio = todosPrecos.reduce((total, registro) => total + (parseFloat(registro.preco) || 0), 0) / todosPrecos.length;
                    } else {
                        precoMedio = material.ultimoPreco || 0;
                    }
                } else {
                    precoMedio = material.ultimoPreco || 0;
                }
            }
            
            // Verificar se está em estoque
            const emEstoque = estoque.some(item => {
                const materialItem = materiais.find(m => m.id === item.materialId);
                return materialItem && 
                       (materialItem.codigo === material.codigo || 
                        simplificarNome(materialItem.nome) === nomeSimplificado);
            });
            
            // Se ainda não foi adicionado ou este material está em estoque (priorizar os em estoque)
            if (!materiaisPorNome[nomeSimplificado] || emEstoque) {
                materiaisPorNome[nomeSimplificado] = {
                    id: material.id,
                    nome: material.nome,
                    unidade: material.unidade || '',
                    unidadeMedida: material.unidadeMedida || '',
                    quantidadeMedida: material.quantidadeMedida || 1,
                    preco: precoMedio || material.ultimoPreco || 0,
                    existe_estoque: emEstoque
                };
            }
        });
        
        // Converter para array e ordenar por nome
        const materiaisUnicos = Object.values(materiaisPorNome).sort((a, b) => a.nome.localeCompare(b.nome));
        
        // Gerar as opções HTML
        return materiaisUnicos.map(material => {
            return `
                <option value="${material.id}" 
                    data-unidade="${material.unidade}" 
                    data-preco="${material.preco || 0}"
                    data-unidade-medida="${material.unidadeMedida || ''}"
                    data-quantidade-medida="${material.quantidadeMedida || 0}"
                    data-estoque="${material.existe_estoque ? '1' : '0'}">
                    ${material.nome} ${material.existe_estoque ? '(Em estoque)' : ''}
                </option>
            `;
        }).join('');
    } catch (error) {
        console.error("Erro ao obter opções de ingredientes:", error);
        return '<option value="">Erro ao carregar ingredientes</option>';
    }
}

// Função para atualizar os cálculos de preço da receita - OTIMIZADA
function atualizarCalculosReceita() {
    try {
        let custoTotal = 0;
        
        // Coletar dados de ingredientes
        document.querySelectorAll('.ingrediente-item').forEach(item => {
            const select = item.querySelector('.ingrediente-select');
            if (select && select.value) {
                const materialId = select.value;
                const quantidade = parseFloat(item.querySelector('.ingrediente-quantidade').value) || 0;
                const unidadeMedida = item.querySelector('.ingrediente-unidade-medida').value;
                
                // Encontrar o material
                const material = materiais.find(m => m.id === materialId);
                if (!material) return;
                
                // Obter o preço médio
                let precoMedio = 0;
                
                if (material.codigo) {
                    precoMedio = obterPrecoMedioPorCodigo(material.codigo);
                }
                
                if (precoMedio === 0) {
                    // Tentar pelo nome
                    const materiaisMesmoNome = materiais.filter(m => 
                        m.nome && m.nome.toLowerCase() === material.nome.toLowerCase());
                    
                    if (materiaisMesmoNome.length > 0) {
                        let todosPrecos = [];
                        materiaisMesmoNome.forEach(m => {
                            if (m.historicoPrecos && m.historicoPrecos.length > 0) {
                                todosPrecos = todosPrecos.concat(m.historicoPrecos);
                            }
                        });
                        
                        if (todosPrecos.length > 0) {
                            precoMedio = todosPrecos.reduce((total, registro) => total + (parseFloat(registro.preco) || 0), 0) / todosPrecos.length;
                        }
                    }
                }
                
                // Se ainda não tem preço, usar o último preço do material
                if (precoMedio === 0) {
                    precoMedio = material.ultimoPreco || 0;
                }
                
                // Normalizar unidades para calcular o custo
                let quantidadeNormalizada = quantidade;
                let materialUnidadeMedida = material.unidadeMedida ? material.unidadeMedida.toLowerCase() : '';
                
                // Converter KG para g, L para ml se necessário
                if (unidadeMedida.toLowerCase() === 'kg' && materialUnidadeMedida === 'g') {
                    quantidadeNormalizada *= 1000;
                } else if (unidadeMedida.toLowerCase() === 'l' && materialUnidadeMedida === 'ml') {
                    quantidadeNormalizada *= 1000;
                }
                // Converter g para kg, ml para l se necessário
                else if (unidadeMedida.toLowerCase() === 'g' && materialUnidadeMedida === 'kg') {
                    quantidadeNormalizada /= 1000;
                } else if (unidadeMedida.toLowerCase() === 'ml' && materialUnidadeMedida === 'l') {
                    quantidadeNormalizada /= 1000;
                }
                
                // Calcular custo proporcional
                const precoUnitarioMedida = precoMedio / (parseFloat(material.quantidadeMedida) || 1);
                custoTotal += precoUnitarioMedida * quantidadeNormalizada;
            }
        });
        
        // Atualizar elementos de preço
        const custoProducaoEl = document.getElementById('custo-producao');
        const custosVariadosEl = document.getElementById('custos-variados');
        const precoEstimadoEl = document.getElementById('preco-estimado');
        
        if (custoProducaoEl && custosVariadosEl && precoEstimadoEl) {
            // Custo de produção
            custoProducaoEl.textContent = formatarMoeda(custoTotal);
            
            // Custos variados (10%)
            const custosVariados = custoTotal * 0.1;
            custosVariadosEl.textContent = formatarMoeda(custosVariados);
            
            // Preço estimado (custo total + custos variados + 150% markup)
            const precoEstimado = (custoTotal + custosVariados) * 2.5;
            precoEstimadoEl.textContent = formatarMoeda(precoEstimado);
            
            // Se existe um campo de preço de venda, sugerir o valor estimado
            const precoVendaInput = document.getElementById('preco-venda');
            if (precoVendaInput && precoVendaInput.value === '') {
                precoVendaInput.value = precoEstimado.toFixed(2);
            }
        }
    } catch (error) {
        console.error("Erro ao atualizar cálculos da receita:", error);
    }
}

// PARTE 7: JAVASCRIPT - FUNÇÕES DE GERENCIAMENTO DE RECEITAS

// Função para editar receita - OTIMIZADA
function editarReceita(index) {
    try {
        const receita = receitas[index];
        if (!receita) return;
        
        // Mudar para a aba de adicionar receita
        const tabButton = document.querySelector('[data-tab="adicionar-receita"]');
        if (tabButton) {
            tabButton.click();
        }
        
        // Preencher o formulário
        document.getElementById('nome-receita').value = receita.nome;
        document.getElementById('descricao-receita').value = receita.descricao || '';
        
        // Limpar os ingredientes existentes
        document.getElementById('lista-ingredientes').innerHTML = '';
        
        // Adicionar cada ingrediente
        if (receita.ingredientes && receita.ingredientes.length) {
            receita.ingredientes.forEach(ingrediente => {
                adicionarCampoIngrediente(ingrediente);
            });
        }
        
        // Preencher preço de venda
        document.getElementById('preco-venda').value = parseFloat(receita.precoVenda).toFixed(2);
        
        // Atualizar cálculos
        atualizarCalculosReceita();
        
        // Modificar o botão de submit
        const submitBtn = document.querySelector('#form-adicionar-receita button[type="submit"]');
        if (submitBtn) {
            submitBtn.textContent = 'Atualizar Receita';
            submitBtn.setAttribute('data-edicao', index);
        }
    } catch (error) {
        console.error("Erro ao editar receita:", error);
        mostrarToast("Erro ao editar receita", "error");
    }
}

// Função para remover receita - OTIMIZADA
// Função para remover receita - CORRIGIDA
// Função para remover receita - CORRIGIDA
function removerReceita(index) {
    try {
        // Verificar se o índice é válido
        if (index < 0 || index >= receitas.length || !receitas[index]) {
            console.error("Índice de receita inválido:", index);
            mostrarToast("Receita não encontrada", "error");
            return false;
        }
        
        // Armazenar ID da receita para verificação
        const receitaId = receitas[index].id;
        
        // Remover a receita pelo índice
        receitas.splice(index, 1);
        
        // Verificar se a remoção foi bem-sucedida
        if (receitas.findIndex(r => r.id === receitaId) !== -1) {
            console.error("Falha ao remover receita");
            mostrarToast("Erro ao remover receita", "error");
            return false;
        }
        
        // Atualizar localStorage e recarregar interface
        try {
            atualizarLocalStorage();
        } catch (storageError) {
            console.error("Erro ao salvar no localStorage:", storageError);
            // Continuar mesmo com erro no localStorage
        }
        
        carregarReceitas();
        mostrarToast('Receita removida com sucesso!', 'success');
        return true;
    } catch (error) {
        console.error("Erro ao remover receita:", error);
        mostrarToast("Erro ao remover receita", "error");
        return false;
    }
}        
        // Atualizar localStorage e recarregar interface
        try {
            atualizarLocalStorage();
        } catch (storageError) {
            console.error("Erro ao salvar no localStorage:", storageError);
            // Continuar mesmo com erro no localStorage
        }
        
        carregarReceitas();
        mostrarToast('Receita removida com sucesso!', 'success');
        return true;
    } catch (error) {
        console.error("Erro ao remover receita:", error);
        mostrarToast("Erro ao remover receita", "error");
        return false;
    }
}
// Função para carregar receitas - OTIMIZADA
function carregarReceitas() {
    try {
        const container = document.getElementById('lista-receitas');
        if (!container) return;
        
        container.innerHTML = '';
        
        // Carregar no select da página de vendas
        const selectVenda = document.getElementById('selecionar-receita-venda');
        if (selectVenda) {
            selectVenda.innerHTML = '<option value="">Selecione uma receita...</option>';
        }
        
        // Carregar no select do filtro de vendas
        const selectFiltroVendas = document.getElementById('filtro-receita');
        if (selectFiltroVendas) {
            selectFiltroVendas.innerHTML = '<option value="">Todas as receitas</option>';
        }
        
        if (!receitas || receitas.length === 0) {
            container.innerHTML = '<p>Nenhuma receita cadastrada.</p>';
            return;
        }
        
        receitas.forEach((receita, index) => {
            if (!receita) return;
            
            // Calcular o custo total da receita usando preço médio
            const custoProducao = calcularCustoReceita(receita);
            const custosVariados = custoProducao * 0.1;
            const precoEstimado = (custoProducao + custosVariados) * 2.5;
            
            // Adicionar ao container de lista
            const card = document.createElement('div');
            card.className = 'recipe-card';
            card.innerHTML = `
                <h3>${receita.nome}</h3>
                <p>${receita.descricao || 'Sem descrição'}</p>
                
                <div class="recipe-pricing">
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Custo de Produção</div>
                        <div class="recipe-price-value">${formatarMoeda(custoProducao)}</div>
                        <div class="material-detalhes">(preço médio)</div>
                    </div>
                    
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Custos Variados</div>
                        <div class="recipe-price-value">${formatarMoeda(custosVariados)}</div>
                    </div>
                    
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Preço Estimado</div>
                        <div class="recipe-price-value">${formatarMoeda(precoEstimado)}</div>
                    </div>
                    
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Preço de Venda</div>
                        <div class="recipe-price-value highlight">${formatarMoeda(receita.precoVenda || 0)}</div>
                    </div>
                </div>
                
                <div class="recipe-ingredients" style="margin-top: 15px;">
                    <h4>Ingredientes:</h4>
                    <ul>
                        ${receita.ingredientes && receita.ingredientes.map(ing => {
                            const material = materiais.find(m => m.id === ing.materialId);
                            return material ? 
                                `<li>${ing.quantidade} ${ing.unidadeMedida} de ${material.nome}</li>` : 
                                '';
                        }).join('')}
                    </ul>
                </div>
                
                <div style="margin-top: 15px;">
                    <button class="btn btn-primary btn-editar-receita" data-index="${index}">Editar</button>
                    <button class="btn btn-danger btn-remover-receita" data-index="${index}">Remover</button>
                    <button class="btn btn-success btn-produzir-receita" data-index="${index}">Produzir</button>
                </div>
            `;
            container.appendChild(card);
            
            // Adicionar ao select de vendas
            if (selectVenda && receita.id) {
                const option = document.createElement('option');
                option.value = receita.id;
                option.textContent = receita.nome;
                selectVenda.appendChild(option);
            }
            
            // Adicionar ao select de filtro de vendas
            if (selectFiltroVendas && receita.id) {
                const optionFiltro = document.createElement('option');
                optionFiltro.value = receita.id;
                optionFiltro.textContent = receita.nome;
                selectFiltroVendas.appendChild(optionFiltro);
            }
        });
        
        // Configurar eventos para os botões usando delegação
        const listaReceitas = document.getElementById('lista-receitas');
        if (listaReceitas) {
            // Remover eventos anteriores
            if (listaReceitas._delegationHandlers) {
                for (const eventType in listaReceitas._delegationHandlers) {
                    listaReceitas.removeEventListener(eventType, listaReceitas._delegationHandlers[eventType]);
                }
            }
            
            // Adicionar novos eventos
            EventManager.delegateEvent(listaReceitas, '.btn-editar-receita', 'click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                if (!isNaN(index)) {
                    editarReceita(index);
                }
            });
            
            EventManager.delegateEvent(listaReceitas, '.btn-remover-receita', 'click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                if (!isNaN(index)) {
                    removerReceita(index);
                }
            });
            
            EventManager.delegateEvent(listaReceitas, '.btn-produzir-receita', 'click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                if (!isNaN(index)) {
                    produzirReceita(index);
                }
            });
        }
    } catch (error) {
        console.error("Erro ao carregar receitas:", error);
        mostrarToast("Erro ao carregar receitas", "error");
    }
}

// Função para produzir receita - OTIMIZADA
function produzirReceita(index) {
    try {
        const receita = receitas[index];
        if (!receita) return;
        
        // Navegar para a página de vendas
        const navLink = document.querySelector('[data-page="vendas"]');
        if (navLink) {
            navLink.click();
        }
        
        setTimeout(() => {
            const tabButton = document.querySelector('[data-tab="registrar-venda"]');
            if (tabButton) {
                tabButton.click();
            }
            
            // Selecionar a receita
            const selectReceita = document.getElementById('selecionar-receita-venda');
            if (selectReceita && receita.id) {
                selectReceita.value = receita.id;
                // Disparar um evento de change para carregar os detalhes
                selectReceita.dispatchEvent(new Event('change'));
            }
        }, 100);
    } catch (error) {
        console.error("Erro ao produzir receita:", error);
        mostrarToast("Erro ao navegar para produção", "error");
    }
}

// Função para adicionar função de configuração para botão de adicionar ingrediente
function setupReceitaEvents() {
    try {
        // Evento para adicionar ingrediente
        const btnAdicionarIngrediente = document.getElementById('adicionar-ingrediente');
        if (btnAdicionarIngrediente) {
            btnAdicionarIngrediente.removeEventListener('click', handleAdicionarIngrediente);
            btnAdicionarIngrediente.addEventListener('click', handleAdicionarIngrediente);
        }
        
        // Configurar o formulário de adicionar receita
        setupFormAddReceitaEvent();
    } catch (error) {
        console.error("Erro ao configurar eventos de receita:", error);
    }
}

// Handler para adicionar ingrediente
function handleAdicionarIngrediente() {
    adicionarCampoIngrediente();
}

// Adicione esta nova função para configurar o formulário de adicionar receita separadamente
function setupFormAddReceitaEvent() {
    try {
        const formAdicionarReceita = document.getElementById('form-adicionar-receita');
        if (!formAdicionarReceita) return;
        
        // Remover evento anterior para evitar duplicação
        formAdicionarReceita.removeEventListener('submit', handleFormAddReceita);
        // Adicionar novo evento
        formAdicionarReceita.addEventListener('submit', handleFormAddReceita);
    } catch (error) {
        console.error("Erro ao configurar formulário de receita:", error);
    }
}

// Função handler para o formulário de adicionar receita
function handleFormAddReceita(e) {
    e.preventDefault();
    
    try {
        const nome = document.getElementById('nome-receita').value;
        const descricao = document.getElementById('descricao-receita').value;
        const precoVenda = parseFloat(document.getElementById('preco-venda').value);
        
        if (!nome || isNaN(precoVenda) || precoVenda <= 0) {
            mostrarToast('Preencha o nome e o preço de venda corretamente.', 'error');
            return;
        }
        
        // Coletar ingredientes
        const ingredientes = [];
        let ingredientesValidos = true;
        
        document.querySelectorAll('.ingrediente-item').forEach(item => {
            const select = item.querySelector('.ingrediente-select');
            if (!select || !select.value) {
                ingredientesValidos = false;
                return;
            }
            
            const materialId = select.value;
            const quantidade = parseFloat(item.querySelector('.ingrediente-quantidade').value);
            const unidadeMedida = item.querySelector('.ingrediente-unidade-medida').value;
            
            if (!materialId || isNaN(quantidade) || quantidade <= 0) {
                ingredientesValidos = false;
                return;
            }
            
            ingredientes.push({
                materialId: materialId,
                quantidade: quantidade,
                unidadeMedida: unidadeMedida
            });
        });
        
        if (!ingredientesValidos || ingredientes.length === 0) {
            mostrarToast('Adicione pelo menos um ingrediente com quantidade válida.', 'error');
            return;
        }
        
        // Verificar se é edição ou nova receita
        const submitBtn = document.querySelector('#form-adicionar-receita button[type="submit"]');
        const indexEdicao = submitBtn.getAttribute('data-edicao');
        
        if (indexEdicao !== null && indexEdicao !== undefined) {
            // Edição de receita existente
            const receitaIndex = parseInt(indexEdicao);
            if (!isNaN(receitaIndex) && receitas[receitaIndex]) {
                receitas[receitaIndex].nome = nome;
                receitas[receitaIndex].descricao = descricao;
                receitas[receitaIndex].ingredientes = ingredientes;
                receitas[receitaIndex].precoVenda = precoVenda;
                
                // Resetar o botão
                submitBtn.textContent = 'Salvar Receita';
                submitBtn.removeAttribute('data-edicao');
                
                mostrarToast('Receita atualizada com sucesso!', 'success');
            }
        } else {
            // Nova receita
            const novaReceita = {
                id: gerarId(),
                nome: nome,
                descricao: descricao,
                ingredientes: ingredientes,
                precoVenda: precoVenda,
                dataCriacao: new Date().toISOString()
            };
            
            receitas.push(novaReceita);
            mostrarToast('Receita adicionada com sucesso!', 'success');
        }
        
        // Limpar o formulário
        this.reset();
        document.getElementById('lista-ingredientes').innerHTML = '';
        
        // Atualizar o localStorage e a interface
        atualizarLocalStorage();
        carregarReceitas();
        
        // Mudar para a aba de listar receitas
        const tabButton = document.querySelector('[data-tab="listar-receitas"]');
        if (tabButton) {
            tabButton.click();
        }
    } catch (error) {
        console.error("Erro ao processar formulário de receita:", error);
        mostrarToast("Erro ao salvar receita", "error");
    }
}
// PARTE 8: JAVASCRIPT - FUNÇÕES PARA VENDAS

// Função para carregar detalhes da receita na tela de vendas - OTIMIZADA
function carregarDetalhesReceitaVenda(receitaId) {
    try {
        const receita = receitas.find(r => r.id === receitaId);
        if (!receita) return;
        
        const detalhes = document.getElementById('detalhes-receita-venda');
        const nomeReceita = document.getElementById('nome-receita-selecionada-venda');
        const tbodyIngredientes = document.getElementById('ingredientes-venda-selecionada');
        const avisoEstoque = document.getElementById('aviso-estoque-venda');
        
        if (!detalhes || !nomeReceita || !tbodyIngredientes || !avisoEstoque) return;
        
        detalhes.classList.remove('hidden');
        nomeReceita.textContent = receita.nome;
        
        tbodyIngredientes.innerHTML = '';
        
        // Calcular custos da receita usando preço médio
        const custoProducao = calcularCustoReceita(receita);
        const custosVariados = custoProducao * 0.1;
        
        // Preencher informações de preço
        document.getElementById('custo-producao-venda').textContent = formatarMoeda(custoProducao);
        document.getElementById('custos-variados-venda').textContent = formatarMoeda(custosVariados);
        document.getElementById('preco-venda-venda').textContent = formatarMoeda(receita.precoVenda || 0);
        
        // Definir valor total
        const qtd = parseInt(document.getElementById('quantidade-venda').value) || 1;
        const frete = parseFloat(document.getElementById('custo-frete').value) || 0;
        const decoracao = parseFloat(document.getElementById('custo-decoracao').value) || 0;
        const despesasAdicionais = parseFloat(document.getElementById('despesas-adicionais').value) || 0;
        
        // Novo cálculo do valor total incluindo frete e decoração
        const valorTotal = (receita.precoVenda * qtd) + frete + decoracao;
        document.getElementById('valor-total-venda').value = valorTotal.toFixed(2);
        
        // Atualizar o resumo financeiro na tela de registro de venda
        atualizarResumoFinanceiroVenda(receita, qtd, custoProducao, custosVariados, frete, decoracao, despesasAdicionais, valorTotal);
        
        // Definir a data atual para o campo de data
        const dataVendaEl = document.getElementById('data-venda');
        if (dataVendaEl && !dataVendaEl.value) {
            const hoje = new Date();
            dataVendaEl.value = hoje.toISOString().split('T')[0];
        }
        
        let todosProdutosDisponiveis = true;
        
        // Unificar estoque antes de verificar disponibilidade
        const estoqueUnificado = unificarEstoque();
        
        // Listar ingredientes necessários
        if (receita.ingredientes) {
            receita.ingredientes.forEach(ingrediente => {
                const material = materiais.find(m => m.id === ingrediente.materialId);
                if (!material) return;
                
                const quantidadeNecessaria = ingrediente.quantidade * qtd;
                let statusEstoque = 'Não disponível';
                let disponivel = false;
                
                // Encontrar o material apropriado no estoque unificado
                let materialEstoque = null;
                
                // Procurar primeiro por código
                if (material.codigo) {
                    materialEstoque = estoqueUnificado.find(item => {
                        const itemMaterial = materiais.find(m => m.id === item.materialId);
                        return itemMaterial && itemMaterial.codigo === material.codigo;
                    });
                }
                
                // Se não encontrou por código, tenta por nome
                if (!materialEstoque) {
                    materialEstoque = estoqueUnificado.find(item => {
                        return item.nome && item.nome.toLowerCase() === material.nome.toLowerCase();
                    });
                }
                
                // Calcular preço médio do material
                let precoMedio = 0;
                if (material.codigo) {
                    precoMedio = obterPrecoMedioPorCodigo(material.codigo);
                } else {
                    // Calcular pelo nome
                    const materiaisMesmoNome = materiais.filter(m => 
                        m.nome && m.nome.toLowerCase() === material.nome.toLowerCase());
                    
                    if (materiaisMesmoNome.length > 0) {
                        let todosPrecos = [];
                        materiaisMesmoNome.forEach(m => {
                            if (m.historicoPrecos && m.historicoPrecos.length > 0) {
                                todosPrecos = todosPrecos.concat(m.historicoPrecos);
                            }
                        });
                        
                        if (todosPrecos.length > 0) {
                            precoMedio = todosPrecos.reduce((total, registro) => total + (parseFloat(registro.preco) || 0), 0) / todosPrecos.length;
                        } else {
                            precoMedio = material.ultimoPreco || 0;
                        }
                    } else {
                        precoMedio = material.ultimoPreco || 0;
                    }
                }
                
                if (materialEstoque) {
                    // Converter unidades para checagem de disponibilidade
                    let quantidadeNormalizada = quantidadeNecessaria;
                    
                    // Normalizar unidades
                    if (ingrediente.unidadeMedida.toLowerCase() === 'kg' && materialEstoque.unidadeMedida.toLowerCase() === 'g') {
                        quantidadeNormalizada *= 1000;
                    } else if (ingrediente.unidadeMedida.toLowerCase() === 'l' && materialEstoque.unidadeMedida.toLowerCase() === 'ml') {
                        quantidadeNormalizada *= 1000;
                    } else if (ingrediente.unidadeMedida.toLowerCase() === 'g' && materialEstoque.unidadeMedida.toLowerCase() === 'kg') {
                        quantidadeNormalizada /= 1000;
                    } else if (ingrediente.unidadeMedida.toLowerCase() === 'ml' && materialEstoque.unidadeMedida.toLowerCase() === 'l') {
                        quantidadeNormalizada /= 1000;
                    }
                    
                    // Calcular quantidade em unidades
                    const quantidadeEmUnidades = quantidadeNormalizada / (materialEstoque.quantidadeMedida || 1);
                    disponivel = materialEstoque.quantidade >= quantidadeEmUnidades;
                    statusEstoque = disponivel ? 'Disponível' : 'Insuficiente';
                }
                
                if (!disponivel) {
                    todosProdutosDisponiveis = false;
                }
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${material ? material.nome : 'Desconhecido'}</td>
                    <td>${quantidadeNecessaria} ${ingrediente.unidadeMedida}</td>
                    <td>${materialEstoque ? materialEstoque.quantidade.toFixed(2) + ' ' + materialEstoque.unidade : 'N/A'}</td>
                    <td style="color: ${disponivel ? 'green' : 'red'}">${statusEstoque}</td>
                    <td>${formatarMoeda(precoMedio)}</td>
                `;
                
                tbodyIngredientes.appendChild(tr);
            });
        }
        
        // Mostrar aviso de estoque
        avisoEstoque.classList.remove('hidden');
        if (!todosProdutosDisponiveis) {
            avisoEstoque.className = 'notification notification-error';
            avisoEstoque.textContent = 'Atenção: Alguns ingredientes não estão disponíveis em quantidade suficiente!';
            document.getElementById('confirmar-venda').disabled = true;
        } else {
            avisoEstoque.className = 'notification notification-success';
            avisoEstoque.textContent = 'Todos os ingredientes estão disponíveis. Você pode prosseguir com a venda.';
            document.getElementById('confirmar-venda').disabled = false;
        }
    } catch (error) {
        console.error("Erro ao carregar detalhes da receita para venda:", error);
        mostrarToast("Erro ao carregar detalhes da receita", "error");
    }
}

// Função para atualizar o resumo financeiro na tela de registro de venda - OTIMIZADA
function atualizarResumoFinanceiroVenda(receita, quantidade, custoProducao, custosVariados, frete, decoracao, despesasAdicionais, valorTotal) {
    try {
        if (!receita) return;
        
        // 1. Cálculos financeiros
        // Despesa (Custo Produção + Custo Variado)
        const despesa = custoProducao + custosVariados;
        
        // Reinvestir (igual à Despesa)
        const valorReinvestir = despesa;
        
        // Despesas Adicionais com acréscimo de 10%
        const despesasAdicionaisComAcrescimo = despesasAdicionais * 1.1;
        const totalDespesasAdicionais = despesasAdicionaisComAcrescimo + frete + decoracao;
        
        // Lucro (Valor Total - Despesa - Reinvestir - Despesas Adicionais)
        const lucro = valorTotal - despesa - valorReinvestir - totalDespesasAdicionais;
        
        // 2. Atualizar os elementos na interface
        document.getElementById('resumo-valor-total').textContent = formatarMoeda(valorTotal);
        document.getElementById('resumo-despesa').textContent = formatarMoeda(despesa);
        document.getElementById('resumo-reinvestir').textContent = formatarMoeda(valorReinvestir);
        document.getElementById('resumo-desp-adic').textContent = formatarMoeda(totalDespesasAdicionais);
        
        const resumoLucro = document.getElementById('resumo-lucro');
        if (resumoLucro) {
            resumoLucro.textContent = formatarMoeda(lucro);
            
            // Adicionar classe para colorir o lucro
            if (lucro >= 0) {
                resumoLucro.className = 'venda-resumo-valor lucro-positivo';
            } else {
                resumoLucro.className = 'venda-resumo-valor lucro-negativo';
            }
        }
    } catch (error) {
        console.error("Erro ao atualizar resumo financeiro da venda:", error);
    }
}

// Função para registrar uma venda - OTIMIZADA
function registrarVenda(receitaId, quantidade, clienteNome, clienteTelefone, 
                      clienteEndereco, custoFrete, custoDecoracao, despesasAdicionais, 
                      observacoes, dataVenda) {
    try {
        const receita = receitas.find(r => r.id === receitaId);
        if (!receita) {
            mostrarToast("Receita não encontrada", "error");
            return false;
        }
        
        // Converter para números
        quantidade = parseInt(quantidade) || 1;
        custoFrete = parseFloat(custoFrete) || 0;
        custoDecoracao = parseFloat(custoDecoracao) || 0;
        despesasAdicionais = parseFloat(despesasAdicionais) || 0;
        
        // Unificar estoque antes de validar disponibilidade
        unificarEstoque();
        
        // Verificar disponibilidade de ingredientes
        let todosProdutosDisponiveis = true;
        
        if (receita.ingredientes) {
            for (const ingrediente of receita.ingredientes) {
                const material = materiais.find(m => m.id === ingrediente.materialId);
                if (!material) {
                    todosProdutosDisponiveis = false;
                    break;
                }
                
                // Encontrar o material apropriado no estoque unificado
                let materialEstoque = null;
                
                // Procurar primeiro por código
                if (material.codigo) {
                    materialEstoque = estoque.find(item => {
                        const itemMaterial = materiais.find(m => m.id === item.materialId);
                        return itemMaterial && itemMaterial.codigo === material.codigo;
                    });
                }
                
                // Se não encontrou por código, tenta por nome
                if (!materialEstoque) {
                    materialEstoque = estoque.find(item => {
                        return item.nome && item.nome.toLowerCase() === material.nome.toLowerCase();
                    });
                }
                
                if (!materialEstoque) {
                    todosProdutosDisponiveis = false;
                    break;
                }
                
                // Converter unidades para checagem de disponibilidade
                let quantidadeNecessaria = ingrediente.quantidade * quantidade;
                let quantidadeNormalizada = quantidadeNecessaria;
                
                // Normalizar unidades
                if (ingrediente.unidadeMedida.toLowerCase() === 'kg' && materialEstoque.unidadeMedida.toLowerCase() === 'g') {
                    quantidadeNormalizada *= 1000;
                } else if (ingrediente.unidadeMedida.toLowerCase() === 'l' && materialEstoque.unidadeMedida.toLowerCase() === 'ml') {
                    quantidadeNormalizada *= 1000;
                } else if (ingrediente.unidadeMedida.toLowerCase() === 'g' && materialEstoque.unidadeMedida.toLowerCase() === 'kg') {
                    quantidadeNormalizada /= 1000;
                } else if (ingrediente.unidadeMedida.toLowerCase() === 'ml' && materialEstoque.unidadeMedida.toLowerCase() === 'l') {
                    quantidadeNormalizada /= 1000;
                }
                
                // Calcular quantidade em unidades
                const quantidadeEmUnidades = quantidadeNormalizada / (materialEstoque.quantidadeMedida || 1);
                
                if (materialEstoque.quantidade < quantidadeEmUnidades) {
                    todosProdutosDisponiveis = false;
                    break;
                }
            }
        }
        
        if (!todosProdutosDisponiveis) {
            mostrarToast("Estoque insuficiente para registrar a venda", "error");
            return false;
        }
        
        // Remover ingredientes do estoque
        if (receita.ingredientes) {
            for (const ingrediente of receita.ingredientes) {
                removerItemEstoque(ingrediente.materialId, ingrediente.quantidade * quantidade, ingrediente.unidadeMedida);
            }
        }
        
        // CÁLCULOS FINANCEIROS USANDO PREÇO MÉDIO
        // 1. Custo Produção e Variados (usando preço médio)
        const custoProducao = calcularCustoReceita(receita);
        const custosVariados = custoProducao * 0.1;
        
        // 2. Despesa (Custo Produção + Custo Variado)
        const despesa = custoProducao + custosVariados;
        
        // 3. Reinvestir (igual à Despesa)
        const valorReinvestir = despesa;
        
        // 4. Despesas Adicionais
        const despesasAdicionaisComAcrescimo = despesasAdicionais * 1.1;
        const totalDespesasAdicionais = despesasAdicionaisComAcrescimo + custoFrete + custoDecoracao;
        
        // 5. Valor total da venda (preço da receita * quantidade + frete + decoração)
        const valorTotal = (receita.precoVenda * quantidade) + custoFrete + custoDecoracao;
        
        // 6. Lucro (Valor Total - Despesa - Reinvestir - Despesas Adicionais)
        const lucro = valorTotal - despesa - valorReinvestir - totalDespesasAdicionais;
        
        // Criar registro de venda com um ID único para evitar duplicação
        const novaVenda = {
            id: gerarId(),
            receitaId: receitaId,
            receitaNome: receita.nome,
            quantidade: quantidade,
            custoProducao: custoProducao,
            custosVariados: custosVariados,
            despesasAdicionaisOriginal: despesasAdicionais,
            despesasAdicionaisComAcrescimo: despesasAdicionaisComAcrescimo,
            custoFrete: custoFrete,
            custoDecoracao: custoDecoracao,
            totalDespesasAdicionais: totalDespesasAdicionais,
            valorReinvestir: valorReinvestir,
            despesa: despesa,
            lucro: lucro,
            precoVenda: receita.precoVenda,
            valorTotal: valorTotal,
            observacoes: observacoes || "",
            cliente: {
                nome: clienteNome,
                telefone: clienteTelefone,
                endereco: clienteEndereco
            },
            data: dataVenda || new Date().toISOString(),
            dataCriacao: new Date().toISOString()
        };
        
        // Verificar se já existe venda com o mesmo ID para evitar duplicação
        const vendaExistente = vendas.find(v => v.id === novaVenda.id);
        if (!vendaExistente) {
            vendas.push(novaVenda);
            atualizarLocalStorage();
            mostrarToast("Venda registrada com sucesso!", "success");
        } else {
            console.warn("Tentativa de criar venda duplicada evitada:", novaVenda.id);
        }
        
        return true;
    } catch (error) {
        console.error("Erro ao registrar venda:", error);
        mostrarToast("Erro ao registrar venda", "error");
        return false;
    }
}

// Função para editar uma venda - OTIMIZADA
function editarVenda(vendaId, quantidade, clienteNome, clienteTelefone, 
                   clienteEndereco, custoFrete, custoDecoracao, despesasAdicionais, 
                   observacoes, dataVenda, valorTotal) {
    try {
        const venda = vendas.find(v => v.id === vendaId);
        if (!venda) {
            mostrarToast("Venda não encontrada", "error");
            return false;
        }
        
        // Salvar os dados originais para restaurar o estoque
        const vendaOriginal = JSON.parse(JSON.stringify(venda));
        
        // Converter valores
        quantidade = parseInt(quantidade) || venda.quantidade;
        custoFrete = parseFloat(custoFrete) || 0;
        custoDecoracao = parseFloat(custoDecoracao) || 0;
        despesasAdicionais = parseFloat(despesasAdicionais) || 0;
        valorTotal = parseFloat(valorTotal) || venda.valorTotal;
        
        // Checar se a quantidade mudou para atualizar o estoque
        if (quantidade !== venda.quantidade) {
            // Primeiro devolvemos os itens ao estoque
            const receita = receitas.find(r => r.id === venda.receitaId);
            if (receita && receita.ingredientes) {
                // Devolver ao estoque a quantidade original
                receita.ingredientes.forEach(ingrediente => {
                    adicionarEstoqueDeVolta(
                        ingrediente.materialId, 
                        ingrediente.quantidade * vendaOriginal.quantidade, 
                        ingrediente.unidadeMedida
                    );
                });
                
                // Agora verificamos disponibilidade da nova quantidade
                // usando estoque unificado
                unificarEstoque();
                let todosProdutosDisponiveis = true;
                
                for (const ingrediente of receita.ingredientes) {
                    const material = materiais.find(m => m.id === ingrediente.materialId);
                    if (!material) {
                        todosProdutosDisponiveis = false;
                        break;
                    }
                    
                    // Encontrar o material apropriado no estoque unificado
                    let materialEstoque = null;
                    
                    // Procurar primeiro por código
                    if (material.codigo) {
                        materialEstoque = estoque.find(item => {
                            const itemMaterial = materiais.find(m => m.id === item.materialId);
                            return itemMaterial && itemMaterial.codigo === material.codigo;
                        });
                    }
                    
                    // Se não encontrou por código, tenta por nome
                    if (!materialEstoque) {
                        materialEstoque = estoque.find(item => {
                            return item.nome && item.nome.toLowerCase() === material.nome.toLowerCase();
                        });
                    }
                    
                    if (!materialEstoque) {
                        todosProdutosDisponiveis = false;
                        break;
                    }
                    
                    let quantidadeNecessaria = ingrediente.quantidade * quantidade;
                    let quantidadeNormalizada = quantidadeNecessaria;
                    
                    // Normalizar unidades
                    if (ingrediente.unidadeMedida.toLowerCase() === 'kg' && materialEstoque.unidadeMedida.toLowerCase() === 'g') {
                        quantidadeNormalizada *= 1000;
                    } else if (ingrediente.unidadeMedida.toLowerCase() === 'l' && materialEstoque.unidadeMedida.toLowerCase() === 'ml') {
                        quantidadeNormalizada *= 1000;
                    } else if (ingrediente.unidadeMedida.toLowerCase() === 'g' && materialEstoque.unidadeMedida.toLowerCase() === 'kg') {
                        quantidadeNormalizada /= 1000;
                    } else if (ingrediente.unidadeMedida.toLowerCase() === 'ml' && materialEstoque.unidadeMedida.toLowerCase() === 'l') {
                        quantidadeNormalizada /= 1000;
                    }
                    
                    const quantidadeEmUnidades = quantidadeNormalizada / (materialEstoque.quantidadeMedida || 1);
                    
                    if (materialEstoque.quantidade < quantidadeEmUnidades) {
                        todosProdutosDisponiveis = false;
                        break;
                    }
                }
                
                if (!todosProdutosDisponiveis) {
                    // Se não há produtos suficientes, restaurar estoque original e abortar
                    receita.ingredientes.forEach(ingrediente => {
                        removerItemEstoque(
                            ingrediente.materialId, 
                            ingrediente.quantidade * vendaOriginal.quantidade, 
                            ingrediente.unidadeMedida
                        );
                    });
                    mostrarToast("Estoque insuficiente para a nova quantidade", "error");
                    return false;
                }
                
                // Se temos estoque suficiente, removemos a nova quantidade
                for (const ingrediente of receita.ingredientes) {
                    removerItemEstoque(
                        ingrediente.materialId, 
                        ingrediente.quantidade * quantidade, 
                        ingrediente.unidadeMedida
                    );
                }
                
                // Recalcular custos baseados na nova quantidade usando preço médio
                const custoProducao = calcularCustoReceita(receita);
                const custosVariados = custoProducao * 0.1;
                venda.custoProducao = custoProducao;
                venda.custosVariados = custosVariados;
                venda.despesa = custoProducao + custosVariados;
                venda.valorReinvestir = venda.despesa;
            }
        }
        
        // Atualizar os dados da venda
        venda.quantidade = quantidade;
        venda.cliente.nome = clienteNome;
        venda.cliente.telefone = clienteTelefone;
        venda.cliente.endereco = clienteEndereco;
        venda.custoFrete = custoFrete;
        venda.custoDecoracao = custoDecoracao;
        venda.despesasAdicionaisOriginal = despesasAdicionais;
        venda.despesasAdicionaisComAcrescimo = despesasAdicionais * 1.1;
        venda.totalDespesasAdicionais = venda.despesasAdicionaisComAcrescimo + custoFrete + custoDecoracao;
        venda.observacoes = observacoes;
        
        if (dataVenda) {
            venda.data = new Date(dataVenda).toISOString();
        }
        
        // Atualizar valor total e recalcular lucro corretamente
        venda.valorTotal = valorTotal;
        // Lucro = Valor Total - Despesa - Reinvestir - Despesas Adicionais Total
        venda.lucro = valorTotal - venda.despesa - venda.valorReinvestir - venda.totalDespesasAdicionais;
        
        atualizarLocalStorage();
        mostrarToast("Venda atualizada com sucesso!", "success");
        return true;
    } catch (error) {
        console.error("Erro ao editar venda:", error);
        mostrarToast("Erro ao editar venda", "error");
        return false;
    }
}

// Função para excluir uma venda - OTIMIZADA
function excluirVenda(vendaId) {
    try {
        const index = vendas.findIndex(v => v.id === vendaId);
        if (index === -1) {
            mostrarToast("Venda não encontrada", "error");
            return false;
        }
        
        const venda = vendas[index];
        
        // Devolver itens ao estoque
        const receita = receitas.find(r => r.id === venda.receitaId);
        if (receita && receita.ingredientes) {
            receita.ingredientes.forEach(ingrediente => {
                adicionarEstoqueDeVolta(
                    ingrediente.materialId, 
                    ingrediente.quantidade * venda.quantidade, 
                    ingrediente.unidadeMedida
                );
            });
        }
        
        // Remover a venda
        vendas.splice(index, 1);
        atualizarLocalStorage();
        
        mostrarToast("Venda excluída com sucesso!", "success");
        return true;
    } catch (error) {
        console.error("Erro ao excluir venda:", error);
        mostrarToast("Erro ao excluir venda", "error");
        return false;
    }
}

// PARTE 9: JAVASCRIPT - REGISTRAR VENDA (EVENT HANDLERS)

// Função para configurar eventos de vendas
function setupVendasEvents() {
    try {
        // Evento para selecionar receita na tela de vendas
        const selectReceitaVenda = document.getElementById('selecionar-receita-venda');
        if (selectReceitaVenda) {
            selectReceitaVenda.removeEventListener('change', handleSelectReceitaVenda);
            selectReceitaVenda.addEventListener('change', handleSelectReceitaVenda);
        }
        
        // Eventos para atualizar o valor total na tela de vendas
        ['quantidade-venda', 'custo-frete', 'custo-decoracao', 'despesas-adicionais'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.removeEventListener('input', handleInputVendaChange);
                el.addEventListener('input', handleInputVendaChange);
            }
        });
        
        // Evento para o formulário de registrar venda
        const formRegistrarVenda = document.getElementById('form-registrar-venda');
        if (formRegistrarVenda) {
            formRegistrarVenda.removeEventListener('submit', handleRegistrarVenda);
            formRegistrarVenda.addEventListener('submit', handleRegistrarVenda);
        }
        
        // Evento para o formulário de editar venda
        const formEditarVenda = document.getElementById('form-editar-venda');
        if (formEditarVenda) {
            formEditarVenda.removeEventListener('submit', handleEditarVenda);
            formEditarVenda.addEventListener('submit', handleEditarVenda);
        }
        
        // Evento para inputs do formulário de editar venda
        ['editar-quantidade-venda', 'editar-custo-frete', 'editar-custo-decoracao', 
         'editar-despesas-adicionais', 'editar-valor-total-venda'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.removeEventListener('input', atualizarResumoFinanceiroEdicao);
                el.addEventListener('input', atualizarResumoFinanceiroEdicao);
            }
        });
        
        // Configurar eventos para os botões de fechar modais
        const botaoFecharDetalhes = document.getElementById('fechar-detalhes-venda');
        if (botaoFecharDetalhes) {
            botaoFecharDetalhes.removeEventListener('click', fecharModalDetalhesVenda);
            botaoFecharDetalhes.addEventListener('click', fecharModalDetalhesVenda);
        }
        
        const botaoFecharEditar = document.getElementById('fechar-editar-venda');
        if (botaoFecharEditar) {
            botaoFecharEditar.removeEventListener('click', fecharModalEditarVenda);
            botaoFecharEditar.addEventListener('click', fecharModalEditarVenda);
        }
        
        // Evento para confirmar exclusão
        const btnConfirmarExclusao = document.getElementById('confirmar-exclusao');
        if (btnConfirmarExclusao) {
            btnConfirmarExclusao.removeEventListener('click', handleConfirmarExclusao);
            btnConfirmarExclusao.addEventListener('click', handleConfirmarExclusao);
        }
        
        // Evento para cancelar exclusão
        const btnCancelarExclusao = document.getElementById('cancelar-exclusao');
        if (btnCancelarExclusao) {
            btnCancelarExclusao.removeEventListener('click', fecharModalConfirmacaoExclusao);
            btnCancelarExclusao.addEventListener('click', fecharModalConfirmacaoExclusao);
        }
        
        // Eventos para os botões de filtrar vendas
        const btnFiltrarVendas = document.getElementById('btn-filtrar-vendas');
        if (btnFiltrarVendas) {
            btnFiltrarVendas.removeEventListener('click', filtrarVendas);
            btnFiltrarVendas.addEventListener('click', filtrarVendas);
        }
        
        const btnLimparFiltros = document.getElementById('btn-limpar-filtros');
        if (btnLimparFiltros) {
            btnLimparFiltros.removeEventListener('click', limparFiltrosVendas);
            btnLimparFiltros.addEventListener('click', limparFiltrosVendas);
        }
        
        // Configurar delegação de eventos para os botões de vendas
        const listaVendas = document.getElementById('lista-vendas');
        if (listaVendas) {
            EventManager.delegateEvent(listaVendas, '.btn-detalhes-venda', 'click', function() {
                const id = this.getAttribute('data-id');
                if (id) mostrarDetalhesVenda(id);
            });
            
            EventManager.delegateEvent(listaVendas, '.btn-editar-venda', 'click', function() {
                const id = this.getAttribute('data-id');
                if (id) mostrarFormEditarVenda(id);
            });
            
            EventManager.delegateEvent(listaVendas, '.btn-excluir-venda', 'click', function() {
                const id = this.getAttribute('data-id');
                if (id) confirmarExclusaoVenda(id);
            });
        }
    } catch (error) {
        console.error("Erro ao configurar eventos de vendas:", error);
    }
}

// Handlers para os eventos de vendas
function handleSelectReceitaVenda() {
    const receitaId = this.value;
    if (receitaId) {
        carregarDetalhesReceitaVenda(receitaId);
    } else {
        document.getElementById('detalhes-receita-venda').classList.add('hidden');
    }
}

function handleInputVendaChange() {
    const receitaId = document.getElementById('selecionar-receita-venda').value;
    if (!receitaId) return;
    
    const receita = receitas.find(r => r.id === receitaId);
    if (!receita) return;
    
    // Recalcular valor total
    const qtd = parseInt(document.getElementById('quantidade-venda').value) || 1;
    const frete = parseFloat(document.getElementById('custo-frete').value) || 0;
    const decoracao = parseFloat(document.getElementById('custo-decoracao').value) || 0;
    const despesasAdicionais = parseFloat(document.getElementById('despesas-adicionais').value) || 0;
    
    // Cálculo do valor total
    const valorTotal = (receita.precoVenda * qtd) + frete + decoracao;
    document.getElementById('valor-total-venda').value = valorTotal.toFixed(2);
    
    // Calcular custos da receita
    const custoProducao = calcularCustoReceita(receita);
    const custosVariados = custoProducao * 0.1;
    
    // Atualizar resumo financeiro
    atualizarResumoFinanceiroVenda(receita, qtd, custoProducao, custosVariados, frete, decoracao, despesasAdicionais, valorTotal);
    
    // Verificar disponibilidade dos ingredientes
    carregarDetalhesReceitaVenda(receitaId);
}

function handleRegistrarVenda(e) {
    e.preventDefault();
    
    try {
        const receitaId = document.getElementById('selecionar-receita-venda').value;
        
        if (!receitaId) {
            mostrarToast('Selecione uma receita para continuar.', 'error');
            return;
        }
        
        // Coletar dados do formulário
        const quantidade = document.getElementById('quantidade-venda').value;
        const clienteNome = document.getElementById('cliente-nome').value;
        const clienteTelefone = document.getElementById('cliente-telefone').value;
        const clienteEndereco = document.getElementById('cliente-endereco').value;
        const custoFrete = document.getElementById('custo-frete').value;
        const custoDecoracao = document.getElementById('custo-decoracao').value;
        const despesasAdicionais = document.getElementById('despesas-adicionais').value;
        const observacoes = document.getElementById('observacoes-venda').value;
        const dataVenda = document.getElementById('data-venda').value;
        
        // Mostrar modal de processamento
        toggleModal(true, "Registrando venda...", "Aguarde enquanto processamos a venda.");
        
        // Registrar a venda
        const resultado = registrarVenda(
            receitaId, quantidade, clienteNome, clienteTelefone, 
            clienteEndereco, custoFrete, custoDecoracao, despesasAdicionais, 
            observacoes, dataVenda
        );
        
        // Fechar modal
        toggleModal(false);
        
        if (resultado) {
            // Limpar o formulário
            this.reset();
            document.getElementById('detalhes-receita-venda').classList.add('hidden');
            
            // Recarregar listas
            carregarVendas();
            carregarEstoque();
            
            // Mudar para a aba de listar vendas
            const tabButton = document.querySelector('[data-tab="listar-vendas"]');
            if (tabButton) {
                tabButton.click();
            }
        }
    } catch (error) {
        toggleModal(false);
        console.error("Erro ao registrar venda:", error);
        mostrarToast("Erro ao registrar venda", "error");
    }
}

function handleEditarVenda(e) {
    e.preventDefault();
    
    try {
        // Coletar dados do formulário
        const vendaId = document.getElementById('editar-venda-id').value;
        const quantidade = document.getElementById('editar-quantidade-venda').value;
        const clienteNome = document.getElementById('editar-cliente-nome').value;
        const clienteTelefone = document.getElementById('editar-cliente-telefone').value;
        const clienteEndereco = document.getElementById('editar-cliente-endereco').value;
        const custoFrete = document.getElementById('editar-custo-frete').value;
        const custoDecoracao = document.getElementById('editar-custo-decoracao').value;
        const despesasAdicionais = document.getElementById('editar-despesas-adicionais').value;
        const observacoes = document.getElementById('editar-observacoes-venda').value;
        const dataVenda = document.getElementById('editar-data-venda').value;
        const valorTotal = document.getElementById('editar-valor-total-venda').value;
        
        // Mostrar modal de processamento
        toggleModal(true, "Atualizando venda...", "Aguarde enquanto atualizamos a venda.");
        
        // Editar a venda
        const resultado = editarVenda(
            vendaId, quantidade, clienteNome, clienteTelefone, 
            clienteEndereco, custoFrete, custoDecoracao, despesasAdicionais, 
            observacoes, dataVenda, valorTotal
        );
        
        // Fechar modal
        toggleModal(false);
        
        if (resultado) {
            // Fechar o modal de edição
            document.getElementById('editar-venda-modal').classList.add('hidden');
            
            // Recarregar listas
            carregarVendas();
            carregarEstoque();
        }
    } catch (error) {
        toggleModal(false);
        console.error("Erro ao editar venda:", error);
        mostrarToast("Erro ao editar venda", "error");
    }
}

function handleConfirmarExclusao() {
    try {
        const vendaId = document.getElementById('excluir-venda-id').value;
        
        if (!vendaId) {
            document.getElementById('confirmar-exclusao-modal').classList.add('hidden');
            return;
        }
        
        // Não mostrar modal de loading para não bloquear a interface
        // toggleModal(true, "Excluindo venda...", "Aguarde enquanto excluímos a venda.");
        
        // Excluir a venda
        const resultado = excluirVenda(vendaId);
        
        // Fechar modal de confirmação
        document.getElementById('confirmar-exclusao-modal').classList.add('hidden');
        
        // Recarregar listas
        carregarVendas();
        carregarEstoque();
        
        return true;
    } catch (error) {
        console.error("Erro ao excluir venda:", error);
        document.getElementById('confirmar-exclusao-modal').classList.add('hidden');
        mostrarToast("Erro ao excluir venda", "error");
        return true; // Retornar true mesmo com erro para evitar travamentos
    }
}

// Funções auxiliares para modais
function fecharModalDetalhesVenda() {
    document.getElementById('venda-details-modal').classList.add('hidden');
}

function fecharModalEditarVenda() {
    document.getElementById('editar-venda-modal').classList.add('hidden');
}

function fecharModalConfirmacaoExclusao() {
    document.getElementById('confirmar-exclusao-modal').classList.add('hidden');
}

function limparFiltrosVendas() {
    document.getElementById('filtro-data-inicio').value = '';
    document.getElementById('filtro-data-fim').value = '';
    document.getElementById('filtro-receita').value = '';
    
    carregarVendas();
}

// Função para atualizar o resumo financeiro na tela de edição
function atualizarResumoFinanceiroEdicao() {
    try {
        const vendaId = document.getElementById('editar-venda-id').value;
        const venda = vendas.find(v => v.id === vendaId);
        if (!venda) return;
        
        const receitaId = document.getElementById('editar-venda-receita-id').value;
        const receita = receitas.find(r => r.id === receitaId);
        if (!receita) return;
        
        const quantidade = parseInt(document.getElementById('editar-quantidade-venda').value) || venda.quantidade;
        const frete = parseFloat(document.getElementById('editar-custo-frete').value) || 0;
        const decoracao = parseFloat(document.getElementById('editar-custo-decoracao').value) || 0;
        const despesasAdicionais = parseFloat(document.getElementById('editar-despesas-adicionais').value) || 0;
        const valorTotal = parseFloat(document.getElementById('editar-valor-total-venda').value) || venda.valorTotal;
        
        // Recalcular custos usando preço médio se a quantidade mudou
        let custoProducao = venda.custoProducao;
        let custosVariados = venda.custosVariados;
        
        if (quantidade !== venda.quantidade) {
            // Recalcular custos baseado na nova quantidade
            const fatorProporcional = quantidade / venda.quantidade;
            custoProducao = calcularCustoReceita(receita); // Usar preço médio atual
            custosVariados = custoProducao * 0.1;
        }
        
        // Despesa (Custo Produção + Custo Variado)
        const despesa = custoProducao + custosVariados;
        
        // Reinvestir (igual à Despesa)
        const valorReinvestir = despesa;
        
        // Despesas Adicionais com acréscimo de 10%
        const despesasAdicionaisComAcrescimo = despesasAdicionais * 1.1;
        const totalDespesasAdicionais = despesasAdicionaisComAcrescimo + frete + decoracao;
        
        // Lucro (Valor Total - Despesa - Reinvestir - Despesas Adicionais)
        const lucro = valorTotal - despesa - valorReinvestir - totalDespesasAdicionais;
        
        // Atualizar os elementos na interface
        document.getElementById('editar-resumo-valor-total').textContent = formatarMoeda(valorTotal);
        document.getElementById('editar-resumo-despesa').textContent = formatarMoeda(despesa);
        document.getElementById('editar-resumo-reinvestir').textContent = formatarMoeda(valorReinvestir);
        document.getElementById('editar-resumo-desp-adic').textContent = formatarMoeda(totalDespesasAdicionais);
        
        const resumoLucro = document.getElementById('editar-resumo-lucro');
        if (resumoLucro) {
            resumoLucro.textContent = formatarMoeda(lucro);
            
            // Adicionar classe para colorir o lucro
            resumoLucro.className = lucro >= 0 ? 'venda-resumo-valor lucro-positivo' : 'venda-resumo-valor lucro-negativo';
        }
    } catch (error) {
        console.error("Erro ao atualizar resumo financeiro de edição:", error);
    }
}

// Função para mostrar detalhes de uma venda - OTIMIZADA
function mostrarDetalhesVenda(vendaId) {
    try {
        const venda = vendas.find(v => v.id === vendaId);
        if (!venda) return;
        
        const modal = document.getElementById('venda-details-modal');
        const content = document.getElementById('venda-details-content');
        
        if (!modal || !content) return;
        
        // Cálculos financeiros usando preço médio
        const despesa = venda.despesa || (venda.custoProducao + venda.custosVariados);
        const valorReinvestir = despesa;
        
        // Verificar se despesasAdicionaisComAcrescimo existe (para compatibilidade com vendas antigas)
        const despesasAdicionaisComAcrescimo = venda.despesasAdicionaisComAcrescimo || 
                                             (venda.despesasAdicionaisOriginal || venda.despesasAdicionais || 0) * 1.1;
        const totalDespesasAdicionais = venda.totalDespesasAdicionais || 
                                       (despesasAdicionaisComAcrescimo + (venda.custoFrete || 0) + (venda.custoDecoracao || 0));
        
        // Recalcular lucro (Valor Total - Despesa - Reinvestir - Despesas Adicionais)
        const lucro = venda.valorTotal - despesa - valorReinvestir - totalDespesasAdicionais;
        
        content.innerHTML = `
            <div class="sale-details">
                <h4>${venda.receitaNome}</h4>
                <p><strong>Data:</strong> ${formatarData(venda.data)}</p>
                <p><strong>Cliente:</strong> ${venda.cliente.nome}</p>
                <p><strong>Telefone:</strong> ${venda.cliente.telefone || 'N/A'}</p>
                <p><strong>Endereço:</strong> ${venda.cliente.endereco || 'N/A'}</p>
                
                ${venda.observacoes ? `<p><strong>Observações:</strong> ${venda.observacoes}</p>` : ''}
                
                <div class="recipe-pricing" style="margin: 15px 0;">
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Custo de Produção</div>
                        <div class="recipe-price-value">${formatarMoeda(venda.custoProducao)}</div>
                        <div class="material-detalhes">(preço médio)</div>
                    </div>
                    
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Custos Variados</div>
                        <div class="recipe-price-value">${formatarMoeda(venda.custosVariados)}</div>
                    </div>
                    
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Preço Unitário</div>
                        <div class="recipe-price-value">${formatarMoeda(venda.precoVenda)}</div>
                    </div>
                    
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Quantidade</div>
                        <div class="recipe-price-value">${venda.quantidade}</div>
                    </div>
                </div>
                
                <div class="recipe-pricing" style="margin: 15px 0;">
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Frete</div>
                        <div class="recipe-price-value">${formatarMoeda(venda.custoFrete || 0)}</div>
                    </div>
                    
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Decoração</div>
                        <div class="recipe-price-value">${formatarMoeda(venda.custoDecoracao || 0)}</div>
                    </div>
                    
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Despesas Adicionais</div>
                        <div class="recipe-price-value">${formatarMoeda(venda.despesasAdicionaisOriginal || venda.despesasAdicionais || 0)}</div>
                    </div>
                    
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Desp. Adic. + 10%</div>
                        <div class="recipe-price-value">${formatarMoeda(despesasAdicionaisComAcrescimo)}</div>
                    </div>
                </div>
                
                <div class="venda-resumo-financeiro">
                    <div class="venda-resumo-grid">
                        <div class="venda-resumo-item">
                            <div class="venda-resumo-label">Valor Total</div>
                            <div class="venda-resumo-valor">${formatarMoeda(venda.valorTotal)}</div>
                        </div>
                        
                        <div class="venda-resumo-item">
                            <div class="venda-resumo-label">Despesa</div>
                            <div class="venda-resumo-valor">${formatarMoeda(despesa)}</div>
                            <div class="material-detalhes">(preço médio)</div>
                        </div>
                        
                        <div class="venda-resumo-item">
                            <div class="venda-resumo-label">Reinvestir</div>
                            <div class="venda-resumo-valor">${formatarMoeda(valorReinvestir)}</div>
                        </div>
                        
                        <div class="venda-resumo-item">
                            <div class="venda-resumo-label">Total Desp. Adic.</div>
                            <div class="venda-resumo-valor">${formatarMoeda(totalDespesasAdicionais)}</div>
                        </div>
                        
                        <div class="venda-resumo-item">
                            <div class="venda-resumo-label">Lucro</div>
                            <div class="venda-resumo-valor ${lucro >= 0 ? 'lucro-positivo' : 'lucro-negativo'}">${formatarMoeda(lucro)}</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        modal.classList.remove('hidden');
    } catch (error) {
        console.error("Erro ao mostrar detalhes da venda:", error);
        mostrarToast("Erro ao mostrar detalhes", "error");
    }
}

// Função para mostrar o formulário de edição de venda - OTIMIZADA
function mostrarFormEditarVenda(vendaId) {
    try {
        const venda = vendas.find(v => v.id === vendaId);
        if (!venda) return;
        
        // Preencher formulário de edição
        document.getElementById('editar-venda-id').value = venda.id;
        document.getElementById('editar-venda-receita-id').value = venda.receitaId;
        document.getElementById('editar-cliente-nome').value = venda.cliente.nome;
        document.getElementById('editar-cliente-telefone').value = venda.cliente.telefone || '';
        document.getElementById('editar-cliente-endereco').value = venda.cliente.endereco || '';
        document.getElementById('editar-observacoes-venda').value = venda.observacoes || '';
        document.getElementById('editar-custo-frete').value = venda.custoFrete || 0;
        document.getElementById('editar-custo-decoracao').value = venda.custoDecoracao || 0;
        document.getElementById('editar-despesas-adicionais').value = venda.despesasAdicionaisOriginal || venda.despesasAdicionais || 0;
        document.getElementById('editar-quantidade-venda').value = venda.quantidade;
        document.getElementById('editar-valor-total-venda').value = venda.valorTotal;
        
        // Data da venda
        const dataVendaEl = document.getElementById('editar-data-venda');
        if (dataVendaEl) {
            const data = new Date(venda.data);
            dataVendaEl.value = data.toISOString().split('T')[0];
        }
        
        // Buscar a receita para mostrar ingredientes
        const receita = receitas.find(r => r.id === venda.receitaId);
        if (receita) {
            const ingredientesContainer = document.getElementById('editar-tabela-ingredientes-container');
            const ingredientesLista = document.getElementById('editar-ingredientes-lista');
            const avisoEstoque = document.getElementById('editar-aviso-estoque');
            
            if (ingredientesContainer && ingredientesLista && avisoEstoque) {
                ingredientesContainer.classList.remove('hidden');
                ingredientesLista.innerHTML = '';
                
                // Unificar estoque para verificar disponibilidade
                const estoqueUnificado = unificarEstoque();
                let todosProdutosDisponiveis = true;
                
                // Listar ingredientes
                if (receita.ingredientes) {
                    receita.ingredientes.forEach(ingrediente => {
                        const material = materiais.find(m => m.id === ingrediente.materialId);
                        if (!material) return;
                        
                        const quantidadeNecessaria = ingrediente.quantidade * venda.quantidade;
                        let statusEstoque = 'Não disponível';
                        let disponivel = false;
                        
                        // Calcular preço médio do material
                        let precoMedio = 0;
                        if (material.codigo) {
                            precoMedio = obterPrecoMedioPorCodigo(material.codigo);
                        } else {
                            // Calcular pelo nome
                            const materiaisMesmoNome = materiais.filter(m => 
                                m.nome && m.nome.toLowerCase() === material.nome.toLowerCase());
                            
                            if (materiaisMesmoNome.length > 0) {
                                let todosPrecos = [];
                                materiaisMesmoNome.forEach(m => {
                                    if (m.historicoPrecos && m.historicoPrecos.length > 0) {
                                        todosPrecos = todosPrecos.concat(m.historicoPrecos);
                                    }
                                });
                                
                                if (todosPrecos.length > 0) {
                                    precoMedio = todosPrecos.reduce((total, registro) => total + (parseFloat(registro.preco) || 0), 0) / todosPrecos.length;
                                } else {
                                    precoMedio = material.ultimoPreco || 0;
                                }
                            } else {
                                precoMedio = material.ultimoPreco || 0;
                            }
                        }
                        
                        // Encontrar o material no estoque unificado
                        let materialEstoque = null;
                        
                        // Procurar primeiro por código
                        if (material.codigo) {
                            materialEstoque = estoqueUnificado.find(item => {
                                const itemMaterial = materiais.find(m => m.id === item.materialId);
                                return itemMaterial && itemMaterial.codigo === material.codigo;
                            });
                        }
                        
                        // Se não encontrou por código, tenta por nome
                        if (!materialEstoque) {
                            materialEstoque = estoqueUnificado.find(item => 
                                item.nome && item.nome.toLowerCase() === material.nome.toLowerCase());
                        }
                        
                        if (materialEstoque) {
                            // Converter unidades para checagem de disponibilidade
                            let quantidadeNormalizada = quantidadeNecessaria;
                            
                            // Normalizar unidades
                            if (ingrediente.unidadeMedida.toLowerCase() === 'kg' && materialEstoque.unidadeMedida.toLowerCase() === 'g') {
                                quantidadeNormalizada *= 1000;
                            } else if (ingrediente.unidadeMedida.toLowerCase() === 'l' && materialEstoque.unidadeMedida.toLowerCase() === 'ml') {
                                quantidadeNormalizada *= 1000;
                            } else if (ingrediente.unidadeMedida.toLowerCase() === 'g' && materialEstoque.unidadeMedida.toLowerCase() === 'kg') {
                                quantidadeNormalizada /= 1000;
                            } else if (ingrediente.unidadeMedida.toLowerCase() === 'ml' && materialEstoque.unidadeMedida.toLowerCase() === 'l') {
                                quantidadeNormalizada /= 1000;
                            }
                            
                            // Calcular quantidade em unidades
                            const quantidadeEmUnidades = quantidadeNormalizada / (materialEstoque.quantidadeMedida || 1);
                            disponivel = materialEstoque.quantidade >= quantidadeEmUnidades;
                            statusEstoque = disponivel ? 'Disponível' : 'Insuficiente';
                        }
                        
                        if (!disponivel) {
                            todosProdutosDisponiveis = false;
                        }
                        
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${material ? material.nome : 'Desconhecido'}</td>
                            <td>${quantidadeNecessaria} ${ingrediente.unidadeMedida}</td>
                            <td>${materialEstoque ? materialEstoque.quantidade.toFixed(2) + ' ' + materialEstoque.unidade : 'N/A'}</td>
                            <td style="color: ${disponivel ? 'green' : 'red'}">${statusEstoque}</td>
                            <td>${formatarMoeda(precoMedio)}</td>
                        `;
                        
                        ingredientesLista.appendChild(tr);
                    });
                }
                
                // Mostrar aviso de estoque
                if (!todosProdutosDisponiveis) {
                    avisoEstoque.className = 'notification notification-warning';
                    avisoEstoque.textContent = 'Atenção: Alguns ingredientes não estão disponíveis em quantidade suficiente caso precise aumentar a quantidade.';
                    avisoEstoque.classList.remove('hidden');
                } else {
                    avisoEstoque.className = 'notification notification-success';
                    avisoEstoque.textContent = 'Todos os ingredientes estão disponíveis.';
                    avisoEstoque.classList.remove('hidden');
                }
            }
        }
        
        // Atualizar resumo financeiro
        atualizarResumoFinanceiroEdicao();
        
        // Mostrar o modal
        document.getElementById('editar-venda-modal').classList.remove('hidden');
    } catch (error) {
        console.error("Erro ao mostrar formulário de edição:", error);
        mostrarToast("Erro ao editar venda", "error");
    }
}

// Função para confirmar exclusão de venda - OTIMIZADA
function confirmarExclusaoVenda(vendaId) {
    try {
        // Configurar o ID da venda para exclusão
        document.getElementById('excluir-venda-id').value = vendaId;
        
        // Mostrar modal de confirmação
        document.getElementById('confirmar-exclusao-modal').classList.remove('hidden');
    } catch (error) {
        console.error("Erro ao confirmar exclusão:", error);
        mostrarToast("Erro ao confirmar exclusão", "error");
    }
}
// PARTE 10: JAVASCRIPT - FILTRAR VENDAS E RESUMO

// Função para filtrar vendas - OTIMIZADA
function filtrarVendas() {
    try {
        const dataInicio = document.getElementById('filtro-data-inicio').value;
        const dataFim = document.getElementById('filtro-data-fim').value;
        const receitaId = document.getElementById('filtro-receita').value;
        
        const vendasFiltradas = vendas.filter(venda => {
            // Filtrar por data
            let passaFiltroData = true;
            if (dataInicio) {
                const dataVenda = new Date(venda.data);
                const dataInicioDate = new Date(dataInicio);
                passaFiltroData = passaFiltroData && dataVenda >= dataInicioDate;
            }
            
            if (dataFim) {
                const dataVenda = new Date(venda.data);
                const dataFimDate = new Date(dataFim);
                // Adicionar 1 dia para incluir o dia final completo
                dataFimDate.setDate(dataFimDate.getDate() + 1);
                passaFiltroData = passaFiltroData && dataVenda < dataFimDate;
            }
            
            // Filtrar por receita
            let passaFiltroReceita = true;
            if (receitaId) {
                passaFiltroReceita = venda.receitaId === receitaId;
            }
            
            return passaFiltroData && passaFiltroReceita;
        });
        
        // Renderizar vendas filtradas
        renderizarVendas(vendasFiltradas);
        
        // Adicionar o resumo financeiro para as vendas filtradas
        adicionarResumoFinanceiroVendas(vendasFiltradas);
    } catch (error) {
        console.error("Erro ao filtrar vendas:", error);
        mostrarToast("Erro ao filtrar vendas", "error");
    }
}

// Nova função para renderizar vendas (extraída para evitar duplicação)
function renderizarVendas(vendasLista) {
    try {
        const container = document.getElementById('lista-vendas');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (!vendasLista || vendasLista.length === 0) {
            container.innerHTML = '<p>Nenhuma venda encontrada com os filtros selecionados.</p>';
            return;
        }
        
        // Ordenar vendas da mais recente para a mais antiga e remover duplicatas
        const vendasOrdenadas = [...vendasLista].sort((a, b) => new Date(b.data) - new Date(a.data));
        const vendasUnicas = [];
        const vendasIds = new Set();
        
        for (const venda of vendasOrdenadas) {
            // Criar uma chave única baseada em dados críticos
            const vendaKey = `${venda.receitaId}_${venda.cliente.nome}_${venda.data}_${venda.quantidade}`;
            if (!vendasIds.has(vendaKey)) {
                vendasIds.add(vendaKey);
                vendasUnicas.push(venda);
            }
        }
        
        vendasUnicas.forEach((venda) => {
            // Calcular valores financeiros
            const despesa = venda.despesa || (venda.custoProducao + venda.custosVariados);
            const valorReinvestir = despesa;
            
            // Compatibilidade com vendas antigas
            const despesasAdicionaisComAcrescimo = venda.despesasAdicionaisComAcrescimo || 
                                                ((venda.despesasAdicionaisOriginal || venda.despesasAdicionais || 0) * 1.1);
            const totalDespesasAdicionais = venda.totalDespesasAdicionais || 
                                          (despesasAdicionaisComAcrescimo + (venda.custoFrete || 0) + (venda.custoDecoracao || 0));
            
            // Recalcular lucro corretamente
            const lucro = venda.valorTotal - despesa - valorReinvestir - totalDespesasAdicionais;
            
            const card = document.createElement('div');
            card.className = 'sale-card';
            card.innerHTML = `
                <div class="sale-header">
                    <div class="sale-title">${venda.receitaNome}</div>
                    <div class="sale-date">${formatarData(venda.data)}</div>
                </div>
                <div>Cliente: ${venda.cliente.nome}</div>
                <div>Quantidade: ${venda.quantidade}</div>
                
                <div class="venda-resumo-financeiro" style="margin-top: 10px;">
                    <div class="venda-resumo-grid">
                        <div class="venda-resumo-item">
                            <div class="venda-resumo-label">Valor Total</div>
                            <div class="venda-resumo-valor">${formatarMoeda(venda.valorTotal)}</div>
                        </div>
                        <div class="venda-resumo-item">
                            <div class="venda-resumo-label">Despesa</div>
                            <div class="venda-resumo-valor">${formatarMoeda(despesa)}</div>
                            <div class="material-detalhes">(preço médio)</div>
                        </div>
                        <div class="venda-resumo-item">
                            <div class="venda-resumo-label">Reinvestir</div>
                            <div class="venda-resumo-valor">${formatarMoeda(valorReinvestir)}</div>
                        </div>
                        <div class="venda-resumo-item">
                            <div class="venda-resumo-label">Total Desp. Adic.</div>
                            <div class="venda-resumo-valor">${formatarMoeda(totalDespesasAdicionais)}</div>
                        </div>
                        <div class="venda-resumo-item">
                            <div class="venda-resumo-label">Lucro</div>
                            <div class="venda-resumo-valor ${lucro >= 0 ? 'lucro-positivo' : 'lucro-negativo'}">${formatarMoeda(lucro)}</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 10px;">
                    <button class="btn btn-secondary btn-detalhes-venda" data-id="${venda.id}">Ver Detalhes</button>
                    <button class="btn btn-primary btn-editar-venda" data-id="${venda.id}">Editar</button>
                    <button class="btn btn-danger btn-excluir-venda" data-id="${venda.id}">Excluir</button>
                </div>
            `;
            container.appendChild(card);
        });
    } catch (error) {
        console.error("Erro ao renderizar vendas:", error);
    }
}

// NOVA FUNÇÃO: Adiciona um resumo financeiro para as vendas filtradas
function adicionarResumoFinanceiroVendas(vendasLista) {
    try {
        // Verificar se estamos na página de vendas
        const vendasPage = document.getElementById('vendas-page');
        if (!vendasPage || !vendasPage.classList.contains('active')) {
            return; // Não adicionar resumo se não estivermos na página de vendas
        }
        
        // Verificar se o container de filtros existe
        const filtroContainer = document.querySelector('#vendas-page .form-row');
        if (!filtroContainer) return;
        
        // Verificar se o resumo já existe e removê-lo
        let resumoExistente = document.getElementById('resumo-vendas-filtradas');
        if (resumoExistente) {
            resumoExistente.remove();
        }
        
        // Calcular totais
        let totalValorTotal = 0;
        let totalDespesa = 0;
        let totalReinvestir = 0;
        let totalDespesasAdicionais = 0;
        let totalLucro = 0;
        
        vendasLista.forEach(venda => {
            const despesa = venda.despesa || (venda.custoProducao + venda.custosVariados);
            const valorReinvestir = despesa;
            
            const despesasAdicionaisComAcrescimo = venda.despesasAdicionaisComAcrescimo || 
                                              ((venda.despesasAdicionaisOriginal || venda.despesasAdicionais || 0) * 1.1);
            const totalDespAdicionais = venda.totalDespesasAdicionais || 
                                     (despesasAdicionaisComAcrescimo + (venda.custoFrete || 0) + (venda.custoDecoracao || 0));
            
            const lucro = venda.valorTotal - despesa - valorReinvestir - totalDespAdicionais;
            
            totalValorTotal += venda.valorTotal;
            totalDespesa += despesa;
            totalReinvestir += valorReinvestir;
            totalDespesasAdicionais += totalDespAdicionais;
            totalLucro += lucro;
        });
        
        // Criar o elemento de resumo
        const resumoDiv = document.createElement('div');
        resumoDiv.id = 'resumo-vendas-filtradas';
        resumoDiv.className = 'venda-resumo-financeiro';
        resumoDiv.style.marginTop = '20px';
        resumoDiv.style.marginBottom = '20px';
        
        resumoDiv.innerHTML = `
            <h4>Resumo das Vendas (${vendasLista.length} ${vendasLista.length === 1 ? 'venda' : 'vendas'})</h4>
            <div class="venda-resumo-grid">
                <div class="venda-resumo-item">
                    <div class="venda-resumo-label">Valor Total</div>
                    <div class="venda-resumo-valor">${formatarMoeda(totalValorTotal)}</div>
                </div>
                <div class="venda-resumo-item">
                    <div class="venda-resumo-label">Despesa</div>
                    <div class="venda-resumo-valor">${formatarMoeda(totalDespesa)}</div>
                </div>
                <div class="venda-resumo-item">
                    <div class="venda-resumo-label">Reinvestir</div>
                    <div class="venda-resumo-valor">${formatarMoeda(totalReinvestir)}</div>
                </div>
                <div class="venda-resumo-item">
                    <div class="venda-resumo-label">Total Desp. Adic.</div>
                    <div class="venda-resumo-valor">${formatarMoeda(totalDespesasAdicionais)}</div>
                </div>
                <div class="venda-resumo-item">
                    <div class="venda-resumo-label">Lucro</div>
                    <div class="venda-resumo-valor ${totalLucro >= 0 ? 'lucro-positivo' : 'lucro-negativo'}">${formatarMoeda(totalLucro)}</div>
                </div>
            </div>
        `;
        
        // Inserir após o container de filtros
        filtroContainer.parentNode.insertBefore(resumoDiv, filtroContainer.nextSibling);
    } catch (error) {
        console.error("Erro ao adicionar resumo financeiro:", error);
    }
}

// Função para inicializar eventos dos modais de venda
function inicializarEventosModaisVenda() {
    try {
        // Modal de detalhes de venda
        const btnFecharDetalhes = document.getElementById('fechar-detalhes-venda');
        if (btnFecharDetalhes) {
            btnFecharDetalhes.removeEventListener('click', fecharModalDetalhesVenda);
            btnFecharDetalhes.addEventListener('click', fecharModalDetalhesVenda);
        }
        
        // Modal de edição de venda
        const btnFecharEditar = document.getElementById('fechar-editar-venda');
        if (btnFecharEditar) {
            btnFecharEditar.removeEventListener('click', fecharModalEditarVenda);
            btnFecharEditar.addEventListener('click', fecharModalEditarVenda);
        }
        
        // Modal de confirmação de exclusão
        const btnConfirmarExclusao = document.getElementById('confirmar-exclusao');
        if (btnConfirmarExclusao) {
            btnConfirmarExclusao.removeEventListener('click', handleConfirmarExclusao);
            btnConfirmarExclusao.addEventListener('click', handleConfirmarExclusao);
        }
        
        const btnCancelarExclusao = document.getElementById('cancelar-exclusao');
        if (btnCancelarExclusao) {
            btnCancelarExclusao.removeEventListener('click', fecharModalConfirmacaoExclusao);
            btnCancelarExclusao.addEventListener('click', fecharModalConfirmacaoExclusao);
        }
    } catch (error) {
        console.error("Erro ao inicializar eventos dos modais:", error);
    }
}

// PARTE 11: JAVASCRIPT - CARREGAR VENDAS E SETUP (FUNÇÕES PRINCIPAIS)
// Função para carregar a lista de vendas - OTIMIZADA
function carregarVendas() {
    try {
        // Chamar a função de renderizar com todas as vendas
        renderizarVendas(vendas);
        
        // Adicionar resumo financeiro para todas as vendas
        adicionarResumoFinanceiroVendas(vendas);
        
        // Configurar delegação de eventos para os botões de vendas
        const listaVendas = document.getElementById('lista-vendas');
        if (listaVendas) {
            // Remover eventos anteriores se existirem
            if (listaVendas._delegationHandlers) {
                for (const eventType in listaVendas._delegationHandlers) {
                    listaVendas.removeEventListener(eventType, listaVendas._delegationHandlers[eventType]);
                }
            }
            
            // Adicionar eventos de delegação para os botões
            EventManager.delegateEvent(listaVendas, '.btn-detalhes-venda', 'click', function() {
                const id = this.getAttribute('data-id');
                if (id) mostrarDetalhesVenda(id);
            });
            
            EventManager.delegateEvent(listaVendas, '.btn-editar-venda', 'click', function() {
                const id = this.getAttribute('data-id');
                if (id) mostrarFormEditarVenda(id);
            });
            
            EventManager.delegateEvent(listaVendas, '.btn-excluir-venda', 'click', function() {
                const id = this.getAttribute('data-id');
                if (id) {
                    confirmarExclusaoVenda(id); // Alterado para usar confirmação
                }
            });
        }
    } catch (error) {
        console.error("Erro ao carregar vendas:", error);
        mostrarToast("Erro ao carregar vendas", "error");
    }
}

// CORRIGIDO: Função para configurar eventos de navegação
function setupEventListeners() {
    try {
        console.log("Configurando eventos de navegação");
        
        // Garantir que o modal esteja oculto ao iniciar
        const modalElement = document.getElementById('processing-modal');
        if (modalElement) {
            modalElement.classList.add('hidden');
        }
        
        // Eventos de navegação - CORRIGIDOS
        const navLinks = document.querySelectorAll('.nav-link');
        console.log("Encontrados " + navLinks.length + " links de navegação");
        
        if (navLinks.length > 0) {
            navLinks.forEach(link => {
                // Remover evento anterior para evitar duplicação
                link.removeEventListener('click', navegarParaPagina);
                // Adicionar evento de navegação
                link.addEventListener('click', navegarParaPagina);
            });
        } else {
            console.error("Nenhum link de navegação encontrado");
        }
        
        // Eventos das abas - CORRIGIDOS
        const tabButtons = document.querySelectorAll('.tab-button');
        console.log("Encontrados " + tabButtons.length + " botões de abas");
        
        if (tabButtons.length > 0) {
            tabButtons.forEach(button => {
                // Remover evento anterior
                button.removeEventListener('click', alternarAba);
                // Adicionar evento para alternar abas
                button.addEventListener('click', alternarAba);
            });
        }
        
        // Eventos de pesquisa
        ['pesquisar-estoque', 'pesquisar-materiais', 'pesquisar-receita', 'pesquisar-vendas'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.removeEventListener('input', handlePesquisaInput);
                el.addEventListener('input', handlePesquisaInput);
            }
        });
        
        // NOVA ADIÇÃO: Configurar o evento para o botão de scanner
        const scannerBtn = document.getElementById('scanner-btn');
        if (scannerBtn) {
            scannerBtn.removeEventListener('click', iniciarScanner);
            scannerBtn.addEventListener('click', iniciarScanner);
        }
        
        // NOVA ADIÇÃO: Configurar o evento para o botão de parar scanner
        const stopScannerBtn = document.getElementById('stop-scanner');
        if (stopScannerBtn) {
            stopScannerBtn.removeEventListener('click', pararScanner);
            stopScannerBtn.addEventListener('click', pararScanner);
        }
        const btnLogout = document.getElementById('btn-logout');
        if (btnLogout) {
            btnLogout.removeEventListener('click', fazerLogout);
            btnLogout.addEventListener('click', fazerLogout);
        }
    } catch (error) {
        console.error("Erro ao configurar eventos de navegação:", error);
    }
}

// Função centralizada para tratar eventos de pesquisa
function handlePesquisaInput() {
    try {
        const termo = this.value.toLowerCase();
        const id = this.id;
        let itens;
        
        switch(id) {
            case 'pesquisar-estoque':
                itens = document.querySelectorAll('#tabela-estoque tbody tr');
                itens.forEach(tr => {
                    const nome = tr.children[1]?.textContent.toLowerCase() || '';
                    const codigo = tr.children[0]?.textContent.toLowerCase() || '';
                    tr.style.display = (nome.includes(termo) || codigo.includes(termo)) ? '' : 'none';
                });
                break;
            case 'pesquisar-materiais':
                itens = document.querySelectorAll('#tabela-materiais tbody tr');
                itens.forEach(tr => {
                    const nome = tr.children[1]?.textContent.toLowerCase() || '';
                    const codigo = tr.children[0]?.textContent.toLowerCase() || '';
                    tr.style.display = (nome.includes(termo) || codigo.includes(termo)) ? '' : 'none';
                });
                break;
            case 'pesquisar-receita':
                itens = document.querySelectorAll('.recipe-card');
                itens.forEach(card => {
                    const nome = card.querySelector('h3')?.textContent.toLowerCase() || '';
                    card.style.display = nome.includes(termo) ? '' : 'none';
                });
                break;
            case 'pesquisar-vendas':
                itens = document.querySelectorAll('.sale-card');
                itens.forEach(card => {
                    const nome = card.querySelector('.sale-title')?.textContent.toLowerCase() || '';
                    const cliente = card.querySelector('div:nth-child(2)')?.textContent.toLowerCase() || '';
                    card.style.display = (nome.includes(termo) || cliente.includes(termo)) ? '' : 'none';
                });
                break;
        }
    } catch (error) {
        console.error("Erro ao pesquisar:", error);
    }
}

// MODIFICADO: Inicializar dados com nova lógica de cálculos
function inicializarDados() {
    try {
        console.log("Inicializando dados...");
        
        // Garantir que arrays existam
        estoque = estoque || [];
        materiais = materiais || [];
        receitas = receitas || [];
        vendas = vendas || [];
        
        // Inicializar IDs para itens de estoque e materiais
        estoque.forEach((item) => {
            if (!item.id) {
                item.id = gerarId();
            }
            if (!item.materialId && item.codigo) {
                // Tentar encontrar material correspondente
                const material = materiais.find(m => m.codigo === item.codigo);
                if (material) {
                    item.materialId = material.id;
                }
            }
        });
        
        materiais.forEach((material) => {
            if (!material.id) {
                material.id = gerarId();
            }
            
            // Garantir que o histórico de preços existe
            if (!material.historicoPrecos) {
                material.historicoPrecos = [{
                    data: material.dataCadastro || new Date().toISOString(),
                    preco: material.ultimoPreco || 0
                }];
            }
            
            // Calcular preço médio
            material.precoMedio = calcularPrecoMedio(material);
        });
        
        receitas.forEach(receita => {
            if (!receita.id) {
                receita.id = gerarId();
            }
            
            // Inicializar array de ingredientes se não existir
            if (!receita.ingredientes) {
                receita.ingredientes = [];
            }
            
            // Remover ingredientes que não têm materialId válido
            receita.ingredientes = receita.ingredientes.filter(ing => {
                return ing.materialId && materiais.some(m => m.id === ing.materialId);
            });
            
            // Garantir que precoVenda existe
            if (!receita.precoVenda) {
                const custoProducao = calcularCustoReceita(receita);
                const custosVariados = custoProducao * 0.1;
                receita.precoVenda = (custoProducao + custosVariados) * 2.5;
            }
        });
        
        // Unificar estoque - agrupar itens similares
        unificarEstoque();
        
        // Atualizar vendas antigas para o novo modelo de cálculo
        // e eliminar possíveis duplicatas
        const vendasUnicas = [];
        const vendasProcessadas = new Set();
        
        vendas.forEach(venda => {
            if (!venda.id) {
                venda.id = gerarId();
            }
            
            // Verificar se é uma venda duplicada
            const vendaKey = `${venda.receitaId}_${venda.cliente.nome}_${venda.data}_${venda.quantidade}`;
            if (vendasProcessadas.has(vendaKey)) {
                return; // Pular esta venda
            }
            
            vendasProcessadas.add(vendaKey);
            
            // Para compatibilidade com vendas antigas
            const custoProducao = venda.custoProducao || 0;
            const custosVariados = venda.custosVariados || 0;
            
            // Despesa = custo produção + custo variado
            const despesa = custoProducao + custosVariados;
            
            // Renomear campo de despesas adicionais para compatibilidade
            if (venda.despesasAdicionais !== undefined && venda.despesasAdicionaisOriginal === undefined) {
                venda.despesasAdicionaisOriginal = venda.despesasAdicionais;
                delete venda.despesasAdicionais; // Remover campo antigo
            }
            
            // Calcular despesas adicionais com acréscimo de 10%
            venda.despesasAdicionaisComAcrescimo = (venda.despesasAdicionaisOriginal || 0) * 1.1;
            
            // Total despesas adicionais (despesa adicional com acréscimo + frete + decoração)
            venda.totalDespesasAdicionais = venda.despesasAdicionaisComAcrescimo + (venda.custoFrete || 0) + (venda.custoDecoracao || 0);
            
            // Atualizar campos de cálculo financeiro
            venda.despesa = despesa;
            venda.valorReinvestir = despesa;
            
            // Novo cálculo de lucro
            // Lucro = Valor Total - Despesa - Reinvestir - Despesas Adicionais Total
            venda.lucro = venda.valorTotal - despesa - despesa - venda.totalDespesasAdicionais;
            
            vendasUnicas.push(venda);
        });
        
        // Substituir o array de vendas pelo array unificado
        vendas = vendasUnicas;
        
        atualizarLocalStorage();
        console.log("Dados inicializados com sucesso!");
    } catch (error) {
        console.error("Erro ao inicializar dados:", error);
        mostrarToast("Erro ao inicializar dados", "error");
    }
}

// Função unificada para configurar todos os eventos
function setupAllEvents() {
    try {
        // Limpar o DOM Cache para garantir elementos atualizados
        DOMCache.clear();
        
        // Configurar eventos principais de navegação
        setupEventListeners();
        
        // Configurar eventos específicos
        setupMaterialButtonEvents();
        setupReceitaEvents();
        setupVendasEvents();
        inicializarEventosModaisVenda();
        
        // Iniciar scanner de código de barras
        adicionarEventoCodigoMaterial();
        
        console.log("Todos os eventos configurados com sucesso");
    } catch (error) {
        console.error("Erro ao configurar eventos:", error);
    }
}

// Função para inicializar a aplicação
function inicializarApp() {
    try {
        // 1. Inicializar dados
        inicializarDados();
        
        // 2. Configurar eventos
        setupAllEvents();
        
        // 3. Carregar interfaces
        carregarEstoque();
        carregarMateriais();
        carregarReceitas();
        carregarVendas();
        
        // 4. Iniciar relógio
        atualizarDataHora();
        setInterval(atualizarDataHora, 1000);
        
        // 5. Correção para navegação em dispositivos móveis
        corrigirNavegacaoMovel();

        // ADICIONAR ESTA LINHA:
        corrigirExibicaoPaginas(); // Força a exibição das páginas

        // Ativar a página de estoque por padrão
        const estoqueLink = document.querySelector('.nav-link[data-page="estoque"]');
        if (estoqueLink) {
            estoqueLink.click();
        } else {
            // Ativação manual se o click não funcionar
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            const estoquePage = document.getElementById('estoque-page');
            if (estoquePage) {
                estoquePage.classList.add('active');
                carregarEstoque();
            }
        }
        console.log("Aplicação inicializada com sucesso");
    } catch (error) {
        console.error("Erro ao inicializar aplicação:", error);
        mostrarToast("Erro ao inicializar aplicação", "error");
    }
}

// Corrigir navegação em dispositivos móveis
function corrigirNavegacaoMovel() {
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    if (isMobile) {
        console.log("Dispositivo móvel detectado, ajustando navegação");
        
        // Adicionar eventos de toque para navegação
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('touchstart', function(e) {
                e.preventDefault();
                
                // Obter a página de destino e navegar para ela
                const pagina = this.getAttribute('data-page');
                
                // Simular um clique normal para reutilizar a lógica existente
                navegarParaPagina.call(this, e);
            });
        });
        
        // Ajustar botões de abas para toque
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('touchstart', function(e) {
                e.preventDefault();
                
                // Simular clique normal
                alternarAba.call(this, e);
            });
        });
    }
}

// Garantir que pelo menos uma página esteja visível
setInterval(function() {
    if (currentUser) {
        const paginasAtivas = document.querySelectorAll('.page-content.active');
        if (paginasAtivas.length === 0) {
            console.log("Nenhuma página ativa, ativando página de estoque");
            
            const navLink = document.querySelector('.nav-link[data-page="estoque"]');
            if (navLink) {
                navLink.click();
            }
        }
    }
}, 2000);

// MODIFICADO: Configurar eventos para materiais
function setupMaterialButtonEvents() {
    try {
        const materiaisTable = document.getElementById('itens-materiais');
        if (materiaisTable) {
            // Limpar eventos existentes
            if (materiaisTable._delegationHandlers) {
                for (const eventType in materiaisTable._delegationHandlers) {
                    materiaisTable.removeEventListener(eventType, materiaisTable._delegationHandlers[eventType]);
                }
            }
            
            // Usar delegação de eventos para os botões
            EventManager.delegateEvent(materiaisTable, '.btn-remover-material', 'click', function() {
                const id = this.getAttribute('data-id');
                if (id) {
                    // Confirmação antes de remover
                    if (confirm("Tem certeza que deseja remover este material?")) {
                        removerMaterial(id);
                    }
                }
            });
            
            EventManager.delegateEvent(materiaisTable, '.btn-editar-material', 'click', function() {
                const id = this.getAttribute('data-id');
                const material = materiais.find(m => m.id === id);
                const index = materiais.indexOf(material);
                if (index !== -1) {
                    editarMaterial(index);
                }
            });
            
            EventManager.delegateEvent(materiaisTable, '.btn-adicionar-estoque', 'click', function() {
                const id = this.getAttribute('data-id');
                adicionarAoEstoque(id);
            });
        }
        
        // Configurar evento para formulário de adicionar material
        const formAdicionarMaterial = document.getElementById('form-adicionar-material');
        if (formAdicionarMaterial) {
            formAdicionarMaterial.removeEventListener('submit', handleFormAddMaterial);
            formAdicionarMaterial.addEventListener('submit', handleFormAddMaterial);
        }
    } catch (error) {
        console.error("Erro ao configurar eventos de materiais:", error);
    }
}

// NOVA FUNÇÃO: Handler para o formulário de adicionar material
function handleFormAddMaterial(e) {
    e.preventDefault();
    try {
        const codigoMaterial = document.getElementById('codigo-material').value;
        const nomeMaterial = document.getElementById('nome-material').value;
        const quantidadeMaterial = document.getElementById('quantidade-material').value;
        const unidadeMaterial = document.getElementById('unidade-material').value;
        const unidadeMedidaMaterial = document.getElementById('unidade-medida-material').value;
        const quantidadeMedidaMaterial = document.getElementById('quantidade-medida-material').value;
        const precoMaterial = document.getElementById('preco-material').value;
        const dataCompra = document.getElementById('data-compra-material').value;
        
        if (!nomeMaterial || !quantidadeMaterial || !unidadeMaterial || !unidadeMedidaMaterial || 
            !quantidadeMedidaMaterial || !precoMaterial) {
            mostrarToast('Preencha todos os campos obrigatórios.', 'error');
            return;
        }
        
        // Verificar botão submit para saber se é edição
        const submitBtn = this.querySelector('button[type="submit"]');
        const indexEdicao = submitBtn ? submitBtn.getAttribute('data-edicao') : null;
        
        // Criar ou atualizar material
        const materialId = adicionarOuAtualizarMaterial(
            codigoMaterial,
            nomeMaterial,
            unidadeMaterial,
            unidadeMedidaMaterial,
            quantidadeMedidaMaterial,
            precoMaterial,
            dataCompra ? new Date(dataCompra).toISOString() : null
        );
        
        if (materialId) {
            // Adicionar ao estoque
            if (adicionarItemEstoque(materialId, quantidadeMaterial)) {
                atualizarLocalStorage();
                this.reset();
                
                // Resetar o botão de edição se necessário
                if (indexEdicao) {
                    submitBtn.textContent = 'Adicionar ao Estoque';
                    submitBtn.removeAttribute('data-edicao');
                }
                
                carregarMateriais();
                carregarEstoque();
                
                mostrarToast('Material adicionado com sucesso!', 'success');
                
                // Voltar para a primeira aba
                const tabButton = document.querySelector('[data-tab="listar-materiais"]');
                if (tabButton) tabButton.click();
            }
        }
    } catch (error) {
        console.error("Erro ao processar formulário de material:", error);
        mostrarToast("Erro ao processar formulário", "error");
    }
}

// MODIFICADO: Função para configurar eventos de receitas
function setupReceitaEvents() {
    try {
        // Evento para adicionar ingrediente
        const btnAdicionarIngrediente = document.getElementById('adicionar-ingrediente');
        if (btnAdicionarIngrediente) {
            btnAdicionarIngrediente.removeEventListener('click', handleAdicionarIngrediente);
            btnAdicionarIngrediente.addEventListener('click', handleAdicionarIngrediente);
        }
        
        // Configurar o formulário de adicionar receita
        setupFormAddReceitaEvent();
        
        // NOVA ADIÇÃO: Configurar delegação de eventos para os botões de receitas
        const listaReceitas = document.getElementById('lista-receitas');
        if (listaReceitas) {
            // Remover eventos anteriores
            if (listaReceitas._delegationHandlers) {
                for (const eventType in listaReceitas._delegationHandlers) {
                    listaReceitas.removeEventListener(eventType, listaReceitas._delegationHandlers[eventType]);
                }
            }
            
            EventManager.delegateEvent(listaReceitas, '.btn-editar-receita', 'click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                if (!isNaN(index)) {
                    editarReceita(index);
                }
            });
            
            EventManager.delegateEvent(listaReceitas, '.btn-remover-receita', 'click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                if (!isNaN(index)) {
                    if (confirm("Tem certeza que deseja remover esta receita?")) {
                        removerReceita(index);
                    }
                }
            });
            
            EventManager.delegateEvent(listaReceitas, '.btn-produzir-receita', 'click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                if (!isNaN(index)) {
                    produzirReceita(index);
                }
            });
        }
    } catch (error) {
        console.error("Erro ao configurar eventos de receita:", error);
    }
}
</script>
</body>
</html>

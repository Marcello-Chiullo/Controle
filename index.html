<!-- PARTE 1 HTML-->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deia Cakes Controle Gerencial</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- Bibliotecas originais -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.4/html5-qrcode.min.js"></script>
    <style>
        /* Estilos Gerais */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #ff85a2;
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .header-logo {
            display: flex;
            align-items: center;
        }
        
        .header-logo img {
            height: 60px;
            margin-left: 15px;
        }
        
        nav {
            background-color: #ffb5c8;
            padding: 10px 0;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        nav ul li {
            margin-right: 20px;
        }
        
        nav ul li a {
            color: #333;
            text-decoration: none;
            font-weight: 500;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        
        nav ul li a:hover, nav ul li a.active {
            background-color: #ff85a2;
            color: white;
        }
        
        h1, h2, h3 {
            margin-top: 0;
            color: #333;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            padding: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 2px;
        }
        
        .btn-primary {
            background-color: #ff85a2;
            color: white;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        table th, table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        table th {
            background-color: #f4f4f4;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Estilos de Página */
        .page-content {
            display: none;
        }
        
        .page-content.active {
            display: block;
        }
        
        /* Estilos do Scanner */
        #reader {
            width: 100%;
            height: 300px;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .scanner-container {
            margin-top: 20px;
        }
        
        /* Estilos de Formulários */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .form-row {
            display: flex;
            margin: 0 -10px;
        }
        
        .form-col {
            flex: 1;
            padding: 0 10px;
        }
        
        /* Animações */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        /* Notificações */
        .notification {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .notification-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .notification-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .notification-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        .notification-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* Estilos para Receitas */
        .recipe-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        
        .recipe-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        
        .ingredients-table {
            margin-top: 10px;
        }
        
        .tab-buttons {
            display: flex;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: 10px 20px;
            border: none;
            background-color: #f1f1f1;
            cursor: pointer;
            transition: background-color 0.3s;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        .tab-button.active {
            background-color: #ff85a2;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        /* Modal para carregamento e feedback */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            max-width: 80%;
            width: 500px;
            text-align: center;
        }
        
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #ff85a2;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Estilos para área de vendas */
        .sale-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .sale-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .sale-title {
            font-weight: bold;
            font-size: 18px;
        }
        
        .sale-date {
            color: #666;
        }
        
        .sale-details {
            margin-top: 10px;
        }
        
        /* Novas classes para preços de receitas */
        .recipe-pricing {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        
        .recipe-price-item {
            text-align: center;
            flex: 1;
        }
        
        .recipe-price-label {
            font-size: 12px;
            color: #666;
        }
        
        .recipe-price-value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        
        .recipe-price-value.highlight {
            color: #ff85a2;
        }
        
        /* Estilos para tela de login */
        #user-info {
            position: absolute;
            top: 10px;
            right: 20px;
            color: white;
            font-size: 14px;
            display: flex;
            align-items: center;
        }
        
        #btn-logout {
            margin-left: 10px;
            background: transparent;
            border: 1px solid white;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            cursor: pointer;
        }
        
        #login-form {
            max-width: 400px;
            margin: 50px auto;
        }
        
        /* Novo estilo para resumo de vendas */
        .venda-resumo-financeiro {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            border: 1px solid #ddd;
        }
        
        .venda-resumo-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .venda-resumo-item {
            text-align: center;
        }
        
        .venda-resumo-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .venda-resumo-valor {
            font-size: 18px;
            font-weight: bold;
        }
        
        .venda-resumo-valor.lucro-positivo {
            color: #28a745;
        }
        
        .venda-resumo-valor.lucro-negativo {
            color: #dc3545;
        }
        
        /* Estilos para histórico de materiais */
        .material-historico-toggle {
            margin-left: 10px;
            font-size: 12px;
            cursor: pointer;
            color: #6c757d;
            text-decoration: underline;
        }
        
        .material-historico-container {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        /* NOVOS ESTILOS ADICIONADOS */
        .preco-medio-badge {
            background-color: #e0f7fa;
            color: #0277bd;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 5px;
        }
        
        .material-detalhes {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .estoque-unificado {
            background-color: #f0f8ff;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        .ingrediente-preco-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 3px;
            font-size: 12px;
            color: #666;
        }
        
        /* Estilo para notificações tipo toast */
        .toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #28a745;
            color: white;
            padding: 12px 24px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 9999;
            opacity: 0;
            transform: translateY(20px);
            animation: toastIn 0.3s forwards, toastOut 0.3s forwards 2.7s;
        }
        
        @keyframes toastIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes toastOut {
            to {
                opacity: 0;
                transform: translateY(20px);
            }
        }
        
        /* Estilos para múltiplas receitas na venda */
        .receitas-lista {
            margin-top: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
        }
        
        .receita-item {
            border-bottom: 1px solid #eee;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .receita-item:last-child {
            border-bottom: none;
        }
        
        .receita-info {
            flex: 1;
        }
        
        .receita-toggle {
            margin-right: 10px;
        }
        
        .btn-adicionar-receita {
            margin-top: 10px;
        }
        
        .receita-acoes {
            display: flex;
            gap: 5px;
        }
    </style>
</head>
<body>
    <header>
       <div class="header-content">
           <h1>Deia Cakes Controle Gerencial</h1>
           <div id="user-info" class="hidden">
               <span id="user-email"></span>
               <button id="btn-logout" type="button">Sair</button>
           </div>
           <div>
               <span id="date-time"></span>
           </div>
       </div>
    </header>
    <nav>
        <ul>
            <li><a href="#estoque" class="nav-link active" data-page="estoque">Estoque</a></li>
            <li><a href="#materiais" class="nav-link" data-page="materiais">Materiais</a></li>
            <li><a href="#receitas" class="nav-link" data-page="receitas">Receitas</a></li>
            <li><a href="#vendas" class="nav-link" data-page="vendas">Vendas</a></li>
        </ul>
    </nav>
</body>
<!-- Parte 2: Página dos APP (com modificações)L-->
<!-- Página de Estoque -->
<div class="page-content" id="estoque-page">
    <h2>Gestão de Estoque</h2>
    <div class="card">
        <h3>Itens em Estoque</h3>
        <input type="text" id="pesquisar-estoque" class="form-control" placeholder="Pesquisar estoque..." style="margin-bottom: 20px;">
        <table id="tabela-estoque">
            <thead>
                <tr>
                    <th>Código</th>
                    <th>Nome</th>
                    <th>Quantidade</th>
                    <th>Unidade</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody id="itens-estoque">
                <!-- Os itens serão adicionados aqui dinamicamente -->
            </tbody>
        </table>
    </div>
</div>

<!-- Página de Materiais -->
<div class="page-content" id="materiais-page">
    <h2>Gestão de Materiais</h2>
    
    <div class="tab-buttons">
        <button class="tab-button active" data-tab="listar-materiais">Listar Materiais</button>
        <button class="tab-button" data-tab="adicionar-item">Adicionar Item</button>
    </div>
    
    <!-- Tab: Listar Materiais -->
    <div class="tab-content active" id="listar-materiais">
        <div class="card">
            <h3>Materiais Cadastrados</h3>
            <input type="text" id="pesquisar-materiais" class="form-control" placeholder="Pesquisar material..." style="margin-bottom: 20px;">
            
            <table id="tabela-materiais">
                <thead>
                    <tr>
                        <th>Código</th>
                        <th>Nome</th>
                        <th>Unidade</th>
                        <th>Un. Medida</th>
                        <th>Qtd/Unidade</th>
                        <th>Última Compra</th>
                        <th>Último Preço</th>
                        <th>Preço Médio/Un</th>
                        <th>Preço Médio/g-ml</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="itens-materiais">
                    <!-- Os itens serão adicionados aqui dinamicamente -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Tab: Adicionar Item -->
    <div class="tab-content" id="adicionar-item">
        <div class="card">
            <h3>Adicionar Item ao Catálogo</h3>
            
            <form id="form-adicionar-material">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="codigo-material">Código:</label>
                            <input type="text" id="codigo-material" class="form-control" placeholder="Código do produto">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="scanner-btn">&nbsp;</label>
                            <button type="button" id="scanner-btn" class="btn btn-secondary form-control">Escanear Código</button>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="nome-material">Nome do Material:</label>
                    <input type="text" id="nome-material" class="form-control" required>
                </div>
                
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="quantidade-material">Quantidade:</label>
                            <input type="number" id="quantidade-material" class="form-control" min="0.01" step="0.01" value="1" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="unidade-material">Unidade:</label>
                            <select id="unidade-material" class="form-control" required>
                                <option value="Pct">Pacote</option>
                                <option value="Cx">Caixa</option>
                                <option value="Un">Unidade</option>
                                <option value="Kg">Quilograma</option>
                                <option value="L">Litro</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="unidade-medida-material">Unidade de Medida:</label>
                            <select id="unidade-medida-material" class="form-control" required>
                                <option value="g">Gramas (g)</option>
                                <option value="kg">Quilogramas (kg)</option>
                                <option value="ml">Mililitros (ml)</option>
                                <option value="l">Litros (l)</option>
                                <option value="un">Unidades</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="quantidade-medida-material">Quantidade por Unidade:</label>
                            <input type="number" id="quantidade-medida-material" class="form-control" min="0.01" step="0.01" required>
                        </div>
                    </div>
                </div>
                
                <div id="info-preco-medio" class="notification notification-info hidden">
                    <p>Preço médio atual: <span id="valor-preco-medio">R$ 0,00</span> (com base em <span id="num-registros">0</span> registros)</p>
                    <p>Preço médio por g/ml: <span id="valor-preco-medio-grama">R$ 0,00</span> por g/ml</p>
                </div>
                
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="preco-material">Preço (R$):</label>
                            <input type="number" id="preco-material" class="form-control" min="0.01" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="data-compra-material">Data da Compra:</label>
                            <input type="date" id="data-compra-material" class="form-control">
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Adicionar ao Estoque</button>
                </div>
            </form>
            
            <div class="scanner-container hidden" id="scanner-container">
                <h3>Escanear Código</h3>
                <div id="reader"></div>
                <div id="scanner-result"></div>
                <button type="button" id="stop-scanner" class="btn btn-danger">Parar Scanner</button>
            </div>
        </div>
    </div>
</div>
<div class="page-content" id="receitas-page">
    <h2>Gestão de Receitas</h2>
    
    <div class="tab-buttons">
        <button class="tab-button active" data-tab="listar-receitas">Listar Receitas</button>
        <button class="tab-button" data-tab="adicionar-receita">Adicionar Receita</button>
    </div>
    
    <!-- Tab: Listar Receitas -->
    <div class="tab-content active" id="listar-receitas">
        <div class="card">
            <h3>Receitas Cadastradas</h3>
            <input type="text" id="pesquisar-receita" class="form-control" placeholder="Pesquisar receita..." style="margin-bottom: 20px;">
            
            <div id="lista-receitas">
                <!-- As receitas serão adicionadas aqui dinamicamente -->
            </div>
        </div>
    </div>
    
    <!-- Tab: Adicionar Receita -->
    <div class="tab-content" id="adicionar-receita">
        <div class="card">
            <h3>Adicionar Nova Receita</h3>
            
            <form id="form-adicionar-receita">
                <div class="form-group">
                    <label for="nome-receita">Nome da Receita:</label>
                    <input type="text" id="nome-receita" class="form-control" placeholder="Ex: Bolo de Chocolate" required>
                </div>
                
                <div class="form-group">
                    <label for="descricao-receita">Descrição:</label>
                    <textarea id="descricao-receita" class="form-control" rows="3" placeholder="Descreva brevemente a receita..."></textarea>
                </div>
                
                <h4>Ingredientes</h4>
                <div id="lista-ingredientes">
                    <!-- Os ingredientes serão adicionados aqui dinamicamente -->
                </div>
                
                <button type="button" id="adicionar-ingrediente" class="btn btn-secondary">+ Adicionar Ingrediente</button>
                
                <div class="recipe-pricing" style="margin-top: 20px;">
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Custo de Produção</div>
                        <div id="custo-producao" class="recipe-price-value">R$ 0,00</div>
                    </div>
                    
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Custos Variados (10%)</div>
                        <div id="custos-variados" class="recipe-price-value">R$ 0,00</div>
                    </div>
                    
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Preço Estimado (150%)</div>
                        <div id="preco-estimado" class="recipe-price-value">R$ 0,00</div>
                    </div>
                    
                    <div class="recipe-price-item">
                        <div class="form-group">
                            <label for="preco-venda" class="recipe-price-label">Preço de Venda Final</label>
                            <input type="number" id="preco-venda" class="form-control" min="0" step="0.01" placeholder="0.00" required>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Salvar Receita</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- PÁGINA DE VENDAS -->
<div class="page-content" id="vendas-page">
    <h2>Histórico de Vendas</h2>
    
    <div class="tab-buttons">
        <button class="tab-button active" data-tab="listar-vendas">Histórico de Vendas</button>
        <button class="tab-button" data-tab="registrar-venda">Registrar Venda</button>
    </div>
    
    <!-- Tab: Listar Vendas -->
    <div class="tab-content active" id="listar-vendas">
        <div class="card">
            <h3>Registro de Vendas</h3>
            <div id="notification-vendas"></div>
            <input type="text" id="pesquisar-vendas" class="form-control" placeholder="Pesquisar vendas..." style="margin-bottom: 20px;">
            
            <div class="form-row" style="margin-bottom: 20px;">
                <div class="form-col">
                    <div class="form-group">
                        <label for="filtro-data-inicio">Data Inicial:</label>
                        <input type="date" id="filtro-data-inicio" class="form-control">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="filtro-data-fim">Data Final:</label>
                        <input type="date" id="filtro-data-fim" class="form-control">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="filtro-receita">Receita:</label>
                        <select id="filtro-receita" class="form-control">
                            <option value="">Todas as receitas</option>
                            <!-- As receitas serão adicionadas aqui dinamicamente -->
                        </select>
                    </div>
                </div>
                <div class="form-col" style="display: flex; align-items: flex-end;">
                    <button id="btn-filtrar-vendas" class="btn btn-primary">Filtrar</button>
                    <button id="btn-limpar-filtros" class="btn btn-secondary" style="margin-left: 10px;">Limpar</button>
                </div>
            </div>
            
            <div id="lista-vendas">
                <!-- As vendas serão adicionadas aqui dinamicamente -->
            </div>
        </div>
    </div>
    
    <!-- Tab: Registrar Venda (REESTRUTURADA PARA MÚLTIPLAS RECEITAS) -->
    <div class="tab-content" id="registrar-venda">
        <div class="card">
            <h3>Registrar Nova Venda</h3>
            
            <div class="form-group">
                <label for="cliente-nome">Nome do Cliente:</label>
                <input type="text" id="cliente-nome" class="form-control" required>
            </div>
            
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="cliente-telefone">Telefone:</label>
                        <input type="tel" id="cliente-telefone" class="form-control" placeholder="(00) 00000-0000">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="data-venda">Data da Venda:</label>
                        <input type="date" id="data-venda" class="form-control">
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="cliente-endereco">Endereço:</label>
                <textarea id="cliente-endereco" class="form-control" rows="2"></textarea>
            </div>
            
            <div class="form-group">
                <label for="observacoes-venda">Observações:</label>
                <textarea id="observacoes-venda" class="form-control" rows="2" placeholder="Motivo da compra, brindes, informações adicionais..."></textarea>
            </div>
            
            <h4>Receitas</h4>
            <div id="receitas-venda-container" class="receitas-lista">
                <!-- Aqui serão adicionadas as receitas selecionadas -->
                <div class="notification notification-info">
                    Adicione receitas para registrar a venda.
                </div>
            </div>
            
            <button type="button" id="btn-adicionar-receita-venda" class="btn btn-secondary btn-adicionar-receita">+ Adicionar Receita</button>
            
            <div class="form-row" style="margin-top: 20px;">
                <div class="form-col">
                    <div class="form-group">
                        <label for="custo-frete">Custo de Frete (R$):</label>
                        <input type="number" id="custo-frete" class="form-control" min="0" step="0.01" value="0">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="custo-decoracao">Custo de Decoração (R$):</label>
                        <input type="number" id="custo-decoracao" class="form-control" min="0" step="0.01" value="0">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="despesas-adicionais" title="Despesas que reduzirão o lucro, como brindes">Despesas Adicionais (R$):</label>
                        <input type="number" id="despesas-adicionais" class="form-control" min="0" step="0.01" value="0">
                    </div>
                </div>
            </div>
            
            <div id="aviso-estoque-venda" class="notification hidden"></div>
            
            <!-- Resumo financeiro da venda -->
            <div class="venda-resumo-financeiro">
                <h4>Resumo Financeiro</h4>
                <div class="venda-resumo-grid">
                    <div class="venda-resumo-item">
                        <div class="venda-resumo-label">Valor Total</div>
                        <div id="resumo-valor-total" class="venda-resumo-valor">R$ 0,00</div>
                    </div>
                    <div class="venda-resumo-item">
                        <div class="venda-resumo-label">Despesa</div>
                        <div id="resumo-despesa" class="venda-resumo-valor">R$ 0,00</div>
                        <div class="material-detalhes">(preço médio por g/ml)</div>
                    </div>
                    <div class="venda-resumo-item">
                        <div class="venda-resumo-label">Reinvestir</div>
                        <div id="resumo-reinvestir" class="venda-resumo-valor">R$ 0,00</div>
                    </div>
                    <div class="venda-resumo-item">
                        <div class="venda-resumo-label">Total Desp. Adic.</div>
                        <div id="resumo-desp-adic" class="venda-resumo-valor">R$ 0,00</div>
                    </div>
                    <div class="venda-resumo-item">
                        <div class="venda-resumo-label">Lucro</div>
                        <div id="resumo-lucro" class="venda-resumo-valor">R$ 0,00</div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px; text-align: right;">
                <button type="button" id="confirmar-venda" class="btn btn-success">Confirmar Venda</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAIS -->
<!-- Modal para processamento de dados -->
<div id="processing-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h3 id="modal-title">Processando...</h3>
        <div class="loader"></div>
        <p id="modal-message">Aguarde enquanto processamos as informações.</p>
    </div>
</div>

<!-- Modal para visualização de detalhes da venda -->
<div id="venda-details-modal" class="modal-overlay hidden">
    <div class="modal-content" style="width: 700px; max-width: 90%;">
        <div style="text-align: right;">
            <button id="fechar-detalhes-venda" class="btn btn-secondary">X</button>
        </div>
        <h3>Detalhes da Venda</h3>
        <div id="venda-details-content">
            <!-- Conteúdo dos detalhes da venda -->
        </div>
    </div>
</div>

<!-- Modal para editar venda -->
<div id="editar-venda-modal" class="modal-overlay hidden">
    <div class="modal-content" style="width: 700px; max-width: 90%;">
        <div style="text-align: right;">
            <button id="fechar-editar-venda" class="btn btn-secondary">X</button>
        </div>
        <h3>Editar Venda</h3>
        <form id="form-editar-venda">
            <input type="hidden" id="editar-venda-id">
            
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="editar-cliente-nome">Nome do Cliente:</label>
                        <input type="text" id="editar-cliente-nome" class="form-control" required>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="editar-cliente-telefone">Telefone:</label>
                        <input type="tel" id="editar-cliente-telefone" class="form-control" placeholder="(00) 00000-0000">
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="editar-cliente-endereco">Endereço:</label>
                <textarea id="editar-cliente-endereco" class="form-control" rows="2"></textarea>
            </div>
            
            <div class="form-group">
                <label for="editar-observacoes-venda">Observações:</label>
                <textarea id="editar-observacoes-venda" class="form-control" rows="2"></textarea>
            </div>
            
            <!-- Receitas da venda (para edição) -->
            <h4>Receitas</h4>
            <div id="editar-receitas-container" class="receitas-lista">
                <!-- Receitas da venda serão adicionadas aqui -->
            </div>
            
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="editar-custo-frete">Custo de Frete (R$):</label>
                        <input type="number" id="editar-custo-frete" class="form-control" min="0" step="0.01">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="editar-custo-decoracao">Custo de Decoração (R$):</label>
                        <input type="number" id="editar-custo-decoracao" class="form-control" min="0" step="0.01">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="editar-despesas-adicionais">Despesas Adicionais (R$):</label>
                        <input type="number" id="editar-despesas-adicionais" class="form-control" min="0" step="0.01">
                    </div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="editar-data-venda">Data da Venda:</label>
                        <input type="date" id="editar-data-venda" class="form-control">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="editar-valor-total-venda">Valor Total (R$):</label>
                        <input type="number" id="editar-valor-total-venda" class="form-control">
                    </div>
                </div>
            </div>
            
            <!-- Tabela de ingredientes na edição -->
            <div id="editar-tabela-ingredientes-container" class="hidden" style="margin-top: 20px;">
                <h4>Ingredientes Necessários</h4>
                <table id="editar-tabela-ingredientes">
                    <thead>
                        <tr>
                            <th>Ingrediente</th>
                            <th>Quantidade Necessária</th>
                            <th>Estoque Atual</th>
                            <th>Status</th>
                            <th>Preço Médio (R$)</th>
                        </tr>
                    </thead>
                    <tbody id="editar-ingredientes-lista">
                        <!-- Ingredientes serão adicionados aqui -->
                    </tbody>
                </table>
                <div id="editar-aviso-estoque" class="notification hidden"></div>
            </div>
            
            <!-- Adicionado: Resumo financeiro da venda para edição -->
            <div class="venda-resumo-financeiro">
                <h4>Resumo Financeiro</h4>
                <div class="venda-resumo-grid">
                    <div class="venda-resumo-item">
                        <div class="venda-resumo-label">Valor Total</div>
                        <div id="editar-resumo-valor-total" class="venda-resumo-valor">R$ 0,00</div>
                    </div>
                    <div class="venda-resumo-item">
                        <div class="venda-resumo-label">Despesa</div>
                        <div id="editar-resumo-despesa" class="venda-resumo-valor">R$ 0,00</div>
                        <div class="material-detalhes">(preço médio por g/ml)</div>
                    </div>
                    <div class="venda-resumo-item">
                        <div class="venda-resumo-label">Reinvestir</div>
                        <div id="editar-resumo-reinvestir" class="venda-resumo-valor">R$ 0,00</div>
                    </div>
                    <div class="venda-resumo-item">
                        <div class="venda-resumo-label">Total Desp. Adic.</div>
                        <div id="editar-resumo-desp-adic" class="venda-resumo-valor">R$ 0,00</div>
                    </div>
                    <div class="venda-resumo-item">
                        <div class="venda-resumo-label">Lucro</div>
                        <div id="editar-resumo-lucro" class="venda-resumo-valor">R$ 0,00</div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px; text-align: right;">
                <button type="submit" class="btn btn-primary">Salvar Alterações</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal para adicionar receita à venda -->
<div id="adicionar-receita-venda-modal" class="modal-overlay hidden">
    <div class="modal-content" style="width: 500px;">
        <div style="text-align: right;">
            <button id="fechar-adicionar-receita-modal" class="btn btn-secondary">X</button>
        </div>
        <h3>Adicionar Receita</h3>
        
        <div class="form-group">
            <label for="selecionar-receita-modal">Selecione uma Receita:</label>
            <select id="selecionar-receita-modal" class="form-control">
                <option value="">Selecione uma receita...</option>
                <!-- As receitas serão adicionadas aqui dinamicamente -->
            </select>
        </div>
        
        <div id="detalhes-receita-modal" class="hidden">
            <h4>Detalhes da Receita: <span id="nome-receita-selecionada-modal"></span></h4>
            
            <div class="recipe-pricing" style="margin: 15px 0;">
                <div class="recipe-price-item">
                    <div class="recipe-price-label">Custo de Produção</div>
                    <div id="custo-producao-modal" class="recipe-price-value">R$ 0,00</div>
                    <div class="material-detalhes">(preço médio por g/ml)</div>
                </div>
                
                <div class="recipe-price-item">
                    <div class="recipe-price-label">Preço de Venda</div>
                    <div id="preco-venda-modal" class="recipe-price-value highlight">R$ 0,00</div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="quantidade-receita-modal">Quantidade:</label>
                        <input type="number" id="quantidade-receita-modal" class="form-control" min="1" value="1">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="calcular-preco-modal" checked>
                            Calcular preço desta receita
                        </label>
                    </div>
                </div>
            </div>
            
            <div id="aviso-estoque-modal" class="notification hidden"></div>
            
            <div style="margin-top: 20px; text-align: right;">
                <button type="button" id="confirmar-adicionar-receita" class="btn btn-primary">Adicionar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmação para exclusão -->
<div id="confirmar-exclusao-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h3>Confirmar Exclusão</h3>
        <p>Tem certeza que deseja excluir esta venda? Esta ação não pode ser desfeita.</p>
        <input type="hidden" id="excluir-venda-id">
        <div style="margin-top: 20px; text-align: right;">
            <button id="cancelar-exclusao" class="btn btn-secondary">Cancelar</button>
            <button id="confirmar-exclusao" class="btn btn-danger">Excluir</button>
        </div>
    </div>
</div>

<!-- Modal de login -->
<div id="login-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h3>Login</h3>
        <div id="login-notification" class="notification hidden"></div>
        
        <div class="form-group">
            <label for="login-email">Email:</label>
            <input type="email" id="login-email" class="form-control" placeholder="email@exemplo.com" required>
        </div>
        
        <div class="form-group">
            <label for="login-senha">Senha:</label>
            <input type="password" id="login-senha" class="form-control" placeholder="Sua senha" required>
        </div>
        
        <div style="margin-top: 20px; display: flex; justify-content: space-between;">
            <button id="btn-login" type="button" class="btn btn-primary">Entrar</button>
            <button id="btn-cadastrar" type="button" class="btn btn-secondary">Cadastrar</button>
        </div>
    </div>
</div>
</html>
<script>
//Parte 3: JavaScript (Firebase e Funções Globais - Otimizadas)
// Sistema de gerenciamento de eventos - novo
const EventManager = {
    // Adiciona um evento e evita duplicações
    addEvent(element, eventType, handler, options = {}) {
        if (!element) return false;
        
        // Remover handler existente para evitar duplicação
        element.removeEventListener(eventType, handler);
        
        // Adicionar novo handler
        element.addEventListener(eventType, handler, options);
        return true;
    },
    
    // Remove um evento específico
    removeEvent(element, eventType, handler) {
        if (!element) return false;
        element.removeEventListener(eventType, handler);
        return true;
    },
    
    // Delegação de eventos - mais eficiente para listas
    delegateEvent(parentElement, selector, eventType, handler) {
        if (!parentElement) return false;
        
        const delegationHandler = function(e) {
            const targetElement = e.target.closest(selector);
            if (targetElement && parentElement.contains(targetElement)) {
                handler.call(targetElement, e);
            }
        };
        
        // Armazenar a referência para poder remover depois
        parentElement._delegationHandlers = parentElement._delegationHandlers || {};
        if (parentElement._delegationHandlers[eventType]) {
            parentElement.removeEventListener(eventType, parentElement._delegationHandlers[eventType]);
        }
        
        parentElement._delegationHandlers[eventType] = delegationHandler;
        parentElement.addEventListener(eventType, delegationHandler);
        return true;
    }
};

// Cache de elementos DOM frequentemente utilizados
const DOMCache = {
    elements: {},
    
    // Obtém elemento e armazena em cache
    get(selector) {
        if (!this.elements[selector]) {
            this.elements[selector] = document.querySelector(selector);
        }
        return this.elements[selector];
    },
    
    // Obtém múltiplos elementos
    getAll(selector) {
        if (!this.elements[selector + '_all']) {
            this.elements[selector + '_all'] = document.querySelectorAll(selector);
        }
        return this.elements[selector + '_all'];
    },
    
    // Limpa o cache
    clear() {
        this.elements = {};
    }
};

// Funções utilitárias simplificadas
function $(selector) {
    return DOMCache.get(selector);
}

function $$(selector) {
    return DOMCache.getAll(selector);
}

// Nova função para notificações toast - MODIFICADA para apenas mostrar sincronização
function mostrarToast(mensagem, tipo = 'success') {
    // Verificar se é uma notificação de sincronização
    const ehSincronizacao = mensagem.includes('sincronizado') || 
                           mensagem.includes('sincronizando') || 
                           mensagem.includes('sincronização');
    
    // Se não for sincronização, verificar se é um erro de sistema crítico
    const ehErroCritico = tipo === 'error' && 
                         (mensagem.includes('sistema') || 
                          mensagem.includes('aplicação') || 
                          mensagem.includes('banco de dados'));
    
    // Somente mostrar toast para sincronização ou erros críticos
    if (ehSincronizacao || ehErroCritico) {
        // Remover toast existente
        const toastExistente = document.querySelector('.toast-notification');
        if (toastExistente) {
            document.body.removeChild(toastExistente);
        }
        
        // Criar novo toast
        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        toast.textContent = mensagem;
        
        // Aplicar estilo conforme tipo
        if (tipo === 'error') {
            toast.style.backgroundColor = '#dc3545';
        } else if (tipo === 'warning') {
            toast.style.backgroundColor = '#ffc107';
            toast.style.color = '#333';
        } else {
            toast.style.backgroundColor = '#28a745';
        }
        
        document.body.appendChild(toast);
        
        // Remover após 3 segundos
        setTimeout(() => {
            if (document.body.contains(toast)) {
                document.body.removeChild(toast);
            }
        }, 3000);
    }
}

// Substituir função problemática que causava erros nos botões
function limparNotificacoes() {
    // Esconder todos os modais
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.classList.add('hidden');
    });
    
    // Esconder todas as notificações
    document.querySelectorAll('.notification').forEach(notif => {
        notif.classList.add('hidden');
    });
    
    // NÃO substituir alerts e confirms nativos
    console.log("Notificações foram ocultadas");
}

// Configuração do Firebase
const firebaseConfig = {
    apiKey: "AIzaSyABzQdTgR9-Al-drNRMBcEb1dN76wUjqvY",
    authDomain: "deiacontrole-faabc.firebaseapp.com",
    databaseURL: "https://deiacontrole-faabc-default-rtdb.firebaseio.com",
    projectId: "deiacontrole-faabc",
    storageBucket: "deiacontrole-faabc.firebasestorage.app",
    messagingSenderId: "216368622292",
    appId: "1:216368622292:web:20522a4725c30907c92941",
};

// Inicializar Firebase
if (typeof firebase !== 'undefined' && !firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const database = firebase.database();
let currentUser = null;

// Variáveis globais
let estoque = [];
let materiais = [];
let receitas = [];
let vendas = [];
let html5QrCode;

// Função para atualizar o localStorage
function atualizarLocalStorage() {
    try {
        localStorage.setItem('estoque', JSON.stringify(estoque));
        localStorage.setItem('materiais', JSON.stringify(materiais));
        localStorage.setItem('receitas', JSON.stringify(receitas));
        localStorage.setItem('vendas', JSON.stringify(vendas));
        localStorage.setItem('ultimaAtualizacao', new Date().toISOString());
        
        // Sincronizar com nuvem se o usuário estiver logado
        if (currentUser) {
            sincronizarComNuvem();
        }
        return true;
    } catch (error) {
        console.error("Erro ao atualizar localStorage:", error);
        return false;
    }
}

// Função para sincronizar com o Firebase - otimizada
function sincronizarComNuvem() {
    if (!currentUser) return Promise.reject('Usuário não autenticado');
    
    // Impedir envio de dados vazios
    if (estoque.length === 0 && materiais.length === 0 && 
        receitas.length === 0 && vendas.length === 0) {
        console.log("Evitando sincronizar arrays vazios");
        return Promise.resolve(false);
    }
    
    const userId = currentUser.uid;
    console.log("Enviando dados para o Firebase");
    
    // Mostrar modal de sincronização
    toggleModal(true, "Sincronizando dados...", "Enviando informações para a nuvem.");
    
    return database.ref('usuarios/' + userId).set({
        estoque: estoque,
        materiais: materiais,
        receitas: receitas,
        vendas: vendas,
        ultimaAtualizacao: new Date().toISOString()
    }).then(() => {
        toggleModal(false);
        mostrarToast('Dados sincronizados com sucesso!');
        return true;
    }).catch(error => {
        toggleModal(false);
        mostrarToast('Erro ao sincronizar: ' + error.message, 'error');
        console.error('Erro na sincronização:', error);
        return false;
    });
}

// Função para mostrar/esconder o modal de processamento - simplificada
function toggleModal(show, title = "Processando...", message = "Aguarde enquanto processamos as informações.") {
    const modal = document.getElementById('processing-modal');
    if (!modal) return false;
    
    if (show) {
        // Configurar textos
        const titleEl = document.getElementById('modal-title');
        const messageEl = document.getElementById('modal-message');
        
        if (titleEl) titleEl.textContent = title;
        if (messageEl) messageEl.textContent = message;
        
        // Mostrar modal
        modal.classList.remove('hidden');
        
        // Configurar timer de segurança para fechar o modal após 10 segundos
        if (window.modalSafetyTimer) {
            clearTimeout(window.modalSafetyTimer);
        }
        window.modalSafetyTimer = setTimeout(() => {
            modal.classList.add('hidden');
        }, 10000);
    } else {
        // Esconder modal
        modal.classList.add('hidden');
        
        // Limpar timer
        if (window.modalSafetyTimer) {
            clearTimeout(window.modalSafetyTimer);
        }
    }
    
    return true;
}

// Função para formatar data - CORRIGIDA para exibir data correta
function formatarData(data) {
    try {
        const d = new Date(data);
        // Ajuste para fuso horário - para evitar problema de data incorreta
        const localDate = new Date(d.getTime() + d.getTimezoneOffset() * 60000);
        return `${localDate.getDate().toString().padStart(2, '0')}/${(localDate.getMonth() + 1).toString().padStart(2, '0')}/${localDate.getFullYear()}`;
    } catch (e) {
        return 'Data inválida';
    }
}

// Função para formatar valor monetário
function formatarMoeda(valor) {
    if (isNaN(valor)) valor = 0;
    return 'R$ ' + parseFloat(valor).toFixed(2).replace('.', ',');
}

// Função para gerar ID único mais curta e eficiente
function gerarId() {
    return 'id_' + Date.now().toString(36) + '_' + Math.random().toString(36).substring(2, 9);
}

// Função para atualizar data/hora atual
function atualizarDataHora() {
    const elemento = document.getElementById('date-time');
    if (!elemento) return;
    
    const agora = new Date();
    const dataFormatada = agora.toLocaleDateString('pt-BR');
    const horaFormatada = agora.toLocaleTimeString('pt-BR');
    elemento.textContent = `${dataFormatada} ${horaFormatada}`;
}

// Handler global para tratamento de erros
window.onerror = function(msg, url, lineNo, columnNo, error) {
    console.error('Erro capturado globalmente:', error);
    mostrarToast('Ocorreu um erro no sistema. Veja o console para mais detalhes.', 'error');
    return false;
};

// Função para iniciar sincronização - otimizada
function iniciarSincronizacao(skipSync = false) {
    if (!currentUser) return Promise.reject('Usuário não autenticado');
    
    const userId = currentUser.uid;
    
    toggleModal(true, "Verificando dados...", "Buscando informações na nuvem.");
    
    return database.ref('usuarios/' + userId).once('value').then((snapshot) => {
        const dados = snapshot.val();
        toggleModal(false);
        
        if (dados) {
            console.log('Dados encontrados na nuvem');
            
            // Verificar se tem dados válidos
            if (dados.estoque || dados.materiais || dados.receitas || dados.vendas) {
                // Atualizar dados locais com dados da nuvem
                estoque = dados.estoque || [];
                materiais = dados.materiais || [];
                receitas = dados.receitas || [];
                vendas = dados.vendas || [];
                
                // Salvar no localStorage sem acionar sincronização
                localStorage.setItem('estoque', JSON.stringify(estoque));
                localStorage.setItem('materiais', JSON.stringify(materiais));
                localStorage.setItem('receitas', JSON.stringify(receitas));
                localStorage.setItem('vendas', JSON.stringify(vendas));
                localStorage.setItem('ultimaAtualizacao', dados.ultimaAtualizacao);
                
                mostrarToast('Dados carregados da nuvem!');
            } else if (!skipSync) {
                // Dados vazios na nuvem, mas temos dados locais para enviar
                if (estoque.length > 0 || materiais.length > 0 || receitas.length > 0 || vendas.length > 0) {
                    sincronizarComNuvem();
                }
            }
        } else if (!skipSync) {
            // Não há dados na nuvem, talvez temos dados locais para enviar
            if (estoque.length > 0 || materiais.length > 0 || receitas.length > 0 || vendas.length > 0) {
                sincronizarComNuvem();
            }
        }
        
        // Recarregar interfaces
        carregarEstoque();
        carregarMateriais();
        carregarReceitas();
        carregarVendas();
        
        // Configurar listener para atualizações futuras (de outros dispositivos)
        configurarListenerAtualizacoes(userId);
        
        return dados;
    }).catch(error => {
        toggleModal(false);
        console.error('Erro ao verificar dados na nuvem:', error);
        mostrarToast('Erro ao verificar dados na nuvem', 'error');
        return null;
    });
}

// Nova função para configurar listener de atualizações
function configurarListenerAtualizacoes(userId) {
    // Remover listener existente se houver
    if (window.atualizacoesRef) {
        window.atualizacoesRef.off();
    }
    
    // Configurar novo listener
    window.atualizacoesRef = database.ref('usuarios/' + userId);
    window.atualizacoesRef.on('value', (snapshot) => {
        const dadosNovos = snapshot.val();
        if (dadosNovos && dadosNovos.ultimaAtualizacao) {
            const ultimaAtualizacaoLocal = localStorage.getItem('ultimaAtualizacao');
            
            // Só atualizar se os dados da nuvem forem mais recentes e não forem os que acabamos de enviar
            if (ultimaAtualizacaoLocal && 
                new Date(dadosNovos.ultimaAtualizacao) > new Date(ultimaAtualizacaoLocal) && 
                dadosNovos.ultimaAtualizacao !== new Date(ultimaAtualizacaoLocal).toISOString()) {
                
                console.log('Recebendo atualização da nuvem...');
                
                // Atualizar dados locais
                estoque = dadosNovos.estoque || [];
                materiais = dadosNovos.materiais || [];
                receitas = dadosNovos.receitas || [];
                vendas = dadosNovos.vendas || [];
                
                // Salvar no localStorage sem acionar nova sincronização
                localStorage.setItem('estoque', JSON.stringify(estoque));
                localStorage.setItem('materiais', JSON.stringify(materiais));
                localStorage.setItem('receitas', JSON.stringify(receitas));
                localStorage.setItem('vendas', JSON.stringify(vendas));
                localStorage.setItem('ultimaAtualizacao', dadosNovos.ultimaAtualizacao);
                
                // Recarregar interfaces
                carregarEstoque();
                carregarMateriais();
                carregarReceitas();
                carregarVendas();
                
                mostrarToast('Dados atualizados da nuvem!');
            }
        }
    });
}

// Inicializar componentes DOM quando o documento estiver pronto
document.addEventListener('DOMContentLoaded', function() {
    limparNotificacoes();
    
    // Carregar dados do localStorage
    try {
        estoque = JSON.parse(localStorage.getItem('estoque')) || [];
        materiais = JSON.parse(localStorage.getItem('materiais')) || [];
        receitas = JSON.parse(localStorage.getItem('receitas')) || [];
        vendas = JSON.parse(localStorage.getItem('vendas')) || [];
    } catch (e) {
        console.error('Erro ao carregar dados do localStorage:', e);
        estoque = [];
        materiais = [];
        receitas = [];
        vendas = [];
    }
    
    // Verificar autenticação do Firebase ao iniciar
    firebase.auth().onAuthStateChanged((user) => {
        if (user) {
            // Usuário está logado
            currentUser = user;
            
            // Mostrar email do usuário
            const userInfoEl = document.getElementById('user-info');
            if (userInfoEl) {
                userInfoEl.classList.remove('hidden');
                document.getElementById('user-email').textContent = user.email;
            }
            
            // Configurar eventos ANTES da sincronização
            setupEventListeners();
            
            // Iniciar sincronização
            iniciarSincronizacao();
            
            // Adicionar botão de sincronização
            adicionarBotaoSincronizacao();
        } else {
            // Usuário não está logado, mostrar tela de login
            mostrarTelaLogin();
        }
    });
});

// Função para logout - CORRIGIDA para funcionar corretamente
function fazerLogout() {
    firebase.auth().signOut().then(() => {
        console.log("Logout realizado com sucesso");
        currentUser = null;
        
        // Limpar dados locais
        localStorage.removeItem('estoque');
        localStorage.removeItem('materiais');
        localStorage.removeItem('receitas');
        localStorage.removeItem('vendas');
        localStorage.removeItem('ultimaAtualizacao');
        
        estoque = [];
        materiais = [];
        receitas = [];
        vendas = [];
        
        // Mostrar tela de login
        mostrarTelaLogin();
    }).catch((error) => {
        console.error("Erro ao fazer logout:", error);
    });
}

// Função para mostrar tela de login - CORRIGIDA
function mostrarTelaLogin() {
    // Esconder todas as páginas
    document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
    
    // Esconder informações do usuário
    const userInfoEl = document.getElementById('user-info');
    if (userInfoEl) {
        userInfoEl.classList.add('hidden');
    }
    
    // Mostrar modal de login
    const loginModal = document.getElementById('login-modal');
    if (loginModal) {
        loginModal.classList.remove('hidden');
        
        // Limpar campos
        document.getElementById('login-email').value = '';
        document.getElementById('login-senha').value = '';
        
        // Adicionar eventos aos botões
        const btnLogin = document.getElementById('btn-login');
        if (btnLogin) {
            btnLogin.removeEventListener('click', fazerLogin);
            btnLogin.addEventListener('click', fazerLogin);
        }
        
        const btnCadastrar = document.getElementById('btn-cadastrar');
        if (btnCadastrar) {
            btnCadastrar.removeEventListener('click', fazerCadastro);
            btnCadastrar.addEventListener('click', fazerCadastro);
        }
    }
}

// Função para login - CORRIGIDA
function fazerLogin(e) {
    if (e) e.preventDefault();
    
    const email = document.getElementById('login-email').value;
    const senha = document.getElementById('login-senha').value;
    
    if (!email || !senha) {
        const loginNotification = document.getElementById('login-notification');
        if (loginNotification) {
            loginNotification.textContent = 'Preencha todos os campos!';
            loginNotification.className = 'notification notification-error';
            loginNotification.classList.remove('hidden');
        }
        return;
    }
    
    toggleModal(true, "Fazendo login...", "Autenticando usuário.");
    
    firebase.auth().signInWithEmailAndPassword(email, senha)
        .then((userCredential) => {
            // Login bem-sucedido
            toggleModal(false);
            document.getElementById('login-modal').classList.add('hidden');
            
            // Atualizar usuário atual
            currentUser = userCredential.user;
            
            // Mostrar informações do usuário
            const userInfoEl = document.getElementById('user-info');
            if (userInfoEl) {
                userInfoEl.classList.remove('hidden');
                document.getElementById('user-email').textContent = currentUser.email;
            }
            
            // Iniciar sincronização
            iniciarSincronizacao();
            
            // Navegar para a primeira página
            const firstNavLink = document.querySelector('.nav-link');
            if (firstNavLink) firstNavLink.click();
            
            console.log("Login realizado com sucesso");
        })
        .catch((error) => {
            toggleModal(false);
            console.error("Erro no login:", error);
            
            // Mostrar mensagem de erro
            const loginNotification = document.getElementById('login-notification');
            if (loginNotification) {
                let mensagemErro;
                
                switch (error.code) {
                    case 'auth/user-not-found':
                        mensagemErro = 'Usuário não encontrado!';
                        break;
                    case 'auth/wrong-password':
                        mensagemErro = 'Senha incorreta!';
                        break;
                    case 'auth/invalid-email':
                        mensagemErro = 'Email inválido!';
                        break;
                    default:
                        mensagemErro = 'Erro ao fazer login: ' + error.message;
                }
                
                loginNotification.textContent = mensagemErro;
                loginNotification.className = 'notification notification-error';
                loginNotification.classList.remove('hidden');
            }
        });
}

// Função para cadastro - CORRIGIDA
function fazerCadastro(e) {
    if (e) e.preventDefault();
    
    const email = document.getElementById('login-email').value;
    const senha = document.getElementById('login-senha').value;
    
    if (!email || !senha) {
        const loginNotification = document.getElementById('login-notification');
        if (loginNotification) {
            loginNotification.textContent = 'Preencha todos os campos!';
            loginNotification.className = 'notification notification-error';
            loginNotification.classList.remove('hidden');
        }
        return;
    }
    
    toggleModal(true, "Criando conta...", "Registrando usuário.");
    
    firebase.auth().createUserWithEmailAndPassword(email, senha)
        .then((userCredential) => {
            // Cadastro bem-sucedido
            toggleModal(false);
            document.getElementById('login-modal').classList.add('hidden');
            
            // Atualizar usuário atual
            currentUser = userCredential.user;
            
            // Mostrar informações do usuário
            const userInfoEl = document.getElementById('user-info');
            if (userInfoEl) {
                userInfoEl.classList.remove('hidden');
                document.getElementById('user-email').textContent = currentUser.email;
            }
            
            // Iniciar sincronização
            iniciarSincronizacao();
            
            // Navegar para a primeira página
            const firstNavLink = document.querySelector('.nav-link');
            if (firstNavLink) firstNavLink.click();
            
            console.log("Cadastro realizado com sucesso");
        })
        .catch((error) => {
            toggleModal(false);
            console.error("Erro no cadastro:", error);
            
            // Mostrar mensagem de erro
            const loginNotification = document.getElementById('login-notification');
            if (loginNotification) {
                let mensagemErro;
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        mensagemErro = 'Este email já está em uso!';
                        break;
                    case 'auth/invalid-email':
                        mensagemErro = 'Email inválido!';
                        break;
                    case 'auth/weak-password':
                        mensagemErro = 'Senha muito fraca!';
                        break;
                    default:
                        mensagemErro = 'Erro ao criar conta: ' + error.message;
                }
                
                loginNotification.textContent = mensagemErro;
                loginNotification.className = 'notification notification-error';
                loginNotification.classList.remove('hidden');
            }
        });
}

// Função para adicionar botão de sincronização
function adicionarBotaoSincronizacao() {
    // Verificar se já existe o botão
    if (document.getElementById('btn-sync')) return;
    
    // Criar botão de sincronização
    const btnSync = document.createElement('button');
    btnSync.id = 'btn-sync';
    btnSync.className = 'btn btn-primary';
    btnSync.innerHTML = '<i class="fa fa-sync"></i> Sincronizar';
    btnSync.style.position = 'fixed';
    btnSync.style.bottom = '20px';
    btnSync.style.right = '20px';
    btnSync.style.zIndex = '999';
    btnSync.style.borderRadius = '50%';
    btnSync.style.width = '60px';
    btnSync.style.height = '60px';
    btnSync.style.fontSize = '20px';
    btnSync.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
    
    // Adicionar evento
    btnSync.addEventListener('click', function() {
        sincronizarComNuvem();
    });
    
    // Adicionar ao corpo do documento
    document.body.appendChild(btnSync);
    
    // Adicionar evento de logout ao botão de sair
    const btnLogout = document.getElementById('btn-logout');
    if (btnLogout) {
        btnLogout.removeEventListener('click', fazerLogout);
        btnLogout.addEventListener('click', fazerLogout);
    }
}
//Parte 4: JavaScript - Navegação e Funções Utilitárias
// Função para navegação principal - OTIMIZADA
function navegarParaPagina(e) {
    try {
        e.preventDefault();
        
        const pagina = this.getAttribute('data-page');
        console.log("Navegando para a página:", pagina);
        
        // Atualizar navegação
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        this.classList.add('active');
        
        // Mostrar página correspondente
        document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
        const pageElement = document.getElementById(`${pagina}-page`);
        if (pageElement) {
            pageElement.classList.add('active');
            
            // Atualizar interfaces específicas para cada página
            switch(pagina) {
                case 'estoque':
                    carregarEstoque();
                    break;
                case 'materiais':
                    carregarMateriais();
                    break;
                case 'receitas':
                    carregarReceitas();
                    break;
                case 'vendas':
                    carregarVendas();
                    break;
            }
        } else {
            console.error("Página não encontrada:", pagina + "-page");
            // Removida notificação
        }
    } catch (error) {
        console.error("Erro durante navegação:", error);
        // Removida notificação
    }
}

// Função para alternar abas - OTIMIZADA
function alternarAba(e) {
    try {
        if (e) e.preventDefault();
        
        const tabId = this.getAttribute('data-tab');
        console.log("Alterando para a aba:", tabId);
        
        // Atualizar botões de abas
        const parentTab = this.parentElement;
        parentTab.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        // Mostrar conteúdo da aba
        const parentContent = parentTab.parentElement;
        parentContent.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        const contentTab = document.getElementById(tabId);
        if (contentTab) {
            contentTab.classList.add('active');
            
            // Ações especiais para certas abas
            if (tabId === 'listar-materiais') {
                carregarMateriais();
            } else if (tabId === 'listar-receitas') {
                carregarReceitas();
            } else if (tabId === 'listar-vendas') {
                carregarVendas();
            } else if (tabId === 'registrar-venda') {
                // Limpar container de receitas
                const receitasContainer = document.getElementById('receitas-venda-container');
                if (receitasContainer) {
                    receitasContainer.innerHTML = `
                        <div class="notification notification-info">
                            Adicione receitas para registrar a venda.
                        </div>
                    `;
                }
                
                // Resetar campos de venda
                document.getElementById('cliente-nome').value = '';
                document.getElementById('cliente-telefone').value = '';
                document.getElementById('cliente-endereco').value = '';
                document.getElementById('observacoes-venda').value = '';
                document.getElementById('custo-frete').value = '0';
                document.getElementById('custo-decoracao').value = '0';
                document.getElementById('despesas-adicionais').value = '0';
                
                // Limpar resumo financeiro
                document.getElementById('resumo-valor-total').textContent = 'R$ 0,00';
                document.getElementById('resumo-despesa').textContent = 'R$ 0,00';
                document.getElementById('resumo-reinvestir').textContent = 'R$ 0,00';
                document.getElementById('resumo-desp-adic').textContent = 'R$ 0,00';
                document.getElementById('resumo-lucro').textContent = 'R$ 0,00';
                
                // Configurar data atual
                const hoje = new Date();
                const dataFormatada = hoje.toISOString().split('T')[0];
                document.getElementById('data-venda').value = dataFormatada;
            }
        } else {
            console.error("Conteúdo da aba não encontrado:", tabId);
        }
    } catch (error) {
        console.error("Erro ao alternar aba:", error);
    }
}

// Sistema de tratamento de erros global
window.addEventListener('error', function(e) {
    console.error("Erro global capturado:", e.error || e.message);
    // Removida notificação
    return false;
});

// Função para verificar o status dos botões e corrigir se necessário
function verificarBotoesFuncionando() {
    try {
        console.log("Verificando funcionamento dos botões...");
        
        // Verificar botões de materiais
        const btnRemoverMateriais = document.querySelectorAll('.btn-remover-material');
        if (btnRemoverMateriais.length > 0) {
            console.log(`Encontrados ${btnRemoverMateriais.length} botões de remoção de materiais`);
            setupMaterialButtonEvents();
        }
        
        // Verificar botões de receitas
        const btnEditarReceitas = document.querySelectorAll('.btn-editar-receita');
        const btnRemoverReceitas = document.querySelectorAll('.btn-remover-receita');
        
        if (btnEditarReceitas.length > 0 || btnRemoverReceitas.length > 0) {
            console.log(`Encontrados ${btnEditarReceitas.length} botões de edição e ${btnRemoverReceitas.length} de remoção para receitas`);
            setupReceitaEvents();
        }
        
        // Verificar botões de vendas
        const btnEditarVendas = document.querySelectorAll('.btn-editar-venda');
        const btnExcluirVendas = document.querySelectorAll('.btn-excluir-venda');
        
        if (btnEditarVendas.length > 0 || btnExcluirVendas.length > 0) {
            console.log(`Encontrados ${btnEditarVendas.length} botões de edição e ${btnExcluirVendas.length} de exclusão para vendas`);
            setupVendasEvents();
        }
        
        // Verificar modais
        const modais = document.querySelectorAll('.modal-overlay');
        modais.forEach(modal => {
            if (!modal.classList.contains('hidden')) {
                console.log("Modal visível encontrado:", modal.id);
                // Tentar fechar automaticamente se for um modal de processamento
                if (modal.id === 'processing-modal') {
                    modal.classList.add('hidden');
                }
            }
        });
        
        return true;
    } catch (error) {
        console.error("Erro ao verificar botões:", error);
        return false;
    }
}

// Função para recuperação de erros
function recuperarSistema() {
    try {
        console.log("Iniciando recuperação do sistema...");
        
        // 1. Esconder todos os modais
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.classList.add('hidden');
        });
        
        // 2. Recarregar dados do localStorage
        try {
            const estoqueLocal = JSON.parse(localStorage.getItem('estoque'));
            const materiaisLocal = JSON.parse(localStorage.getItem('materiais'));
            const receitasLocal = JSON.parse(localStorage.getItem('receitas'));
            const vendasLocal = JSON.parse(localStorage.getItem('vendas'));
            
            // Só atualizar se os dados forem válidos
            if (estoqueLocal && Array.isArray(estoqueLocal)) estoque = estoqueLocal;
            if (materiaisLocal && Array.isArray(materiaisLocal)) materiais = materiaisLocal;
            if (receitasLocal && Array.isArray(receitasLocal)) receitas = receitasLocal;
            if (vendasLocal && Array.isArray(vendasLocal)) vendas = vendasLocal;
        } catch (e) {
            console.error("Erro ao recuperar dados do localStorage:", e);
        }
        
        // 3. Recarregar interfaces
        carregarEstoque();
        carregarMateriais();
        carregarReceitas();
        carregarVendas();
        
        // 4. Verificar e corrigir botões
        verificarBotoesFuncionando();
        
        // Removida notificação
        return true;
    } catch (error) {
        console.error("Falha na recuperação do sistema:", error);
        // Como último recurso, recarregar a página
        setTimeout(() => {
            location.reload();
        }, 2000);
        return false;
    }
}

// Monitoramento automático de saúde do sistema
const sistemaMonitor = {
    intervaloChecagem: null,
    ultimoEstado: {
        numMateriais: 0,
        numReceitas: 0,
        numVendas: 0,
        paginaAtiva: null
    },
    
    iniciar() {
        if (this.intervaloChecagem) clearInterval(this.intervaloChecagem);
        
        // Verificar o sistema a cada 30 segundos
        this.intervaloChecagem = setInterval(() => {
            this.verificarSaude();
        }, 30000);
        
        // Verificação inicial
        this.verificarSaude();
        console.log("Monitor de sistema iniciado");
    },
    
    verificarSaude() {
        // 1. Verificar se dados estão coerentes
        const dadosCoerentes = materiais && receitas && vendas && 
                              Array.isArray(materiais) && 
                              Array.isArray(receitas) && 
                              Array.isArray(vendas);
        
        if (!dadosCoerentes) {
            console.warn("Dados inconsistentes detectados, tentando recuperar...");
            recuperarSistema();
            return;
        }
        
        // 2. Verificar se há alguma página ativa
        const paginasAtivas = document.querySelectorAll('.page-content.active');
        if (paginasAtivas.length === 0) {
            console.warn("Nenhuma página ativa, corrigindo navegação...");
            const primeiraAba = document.querySelector('.nav-link');
            if (primeiraAba) primeiraAba.click();
        }
        
        // 3. Verifique se há modais travados abertos
        const modaisAbertos = document.querySelectorAll('.modal-overlay:not(.hidden)');
        if (modaisAbertos.length > 0) {
            // Verificar se o modal está aberto há muito tempo
            const processingModal = document.getElementById('processing-modal');
            if (processingModal && !processingModal.classList.contains('hidden')) {
                console.warn("Modal de processamento travado detectado");
                processingModal.classList.add('hidden');
            }
        }
        
        // 4. Atualizar estado
        this.ultimoEstado = {
            numMateriais: materiais.length,
            numReceitas: receitas.length,
            numVendas: vendas.length,
            paginaAtiva: paginasAtivas.length > 0 ? paginasAtivas[0].id : null
        };
    }
};

// Configuração para dispositivos móveis
function otimizarParaDispositivos() {
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    if (isMobile) {
        console.log("Dispositivo móvel detectado, aplicando otimizações");
        
        // 1. Ajustar estilos para melhor visualização móvel
        const styleSheet = document.createElement('style');
        styleSheet.type = 'text/css';
        styleSheet.innerHTML = `
            @media (max-width: 768px) {
                .form-row { flex-direction: column; }
                .form-col { margin-bottom: 10px; }
                .btn { display: block; width: 100%; margin-bottom: 5px; }
                .venda-resumo-grid { grid-template-columns: 1fr 1fr; }
                table { font-size: 14px; }
                .modal-content { width: 95% !important; max-width: 95% !important; }
                #receitas-venda-container, .receita-item { flex-direction: column; }
                .receita-acoes { margin-top: 10px; }
            }
        `;
        document.head.appendChild(styleSheet);
        
        // 2. Simplificar tabelas para melhor visualização
        document.querySelectorAll('table').forEach(table => {
            table.classList.add('mobile-optimized');
        });
        
        // 3. Configurar eventos de toque para navegação
        document.querySelectorAll('.nav-link, .tab-button, button').forEach(el => {
            el.style.padding = '12px'; // Aumentar área de toque
        });
    }
}

// Inicializar o sistema de eventos personalizados
const EventosSistema = {
    listeners: {},
    
    on(evento, callback) {
        if (!this.listeners[evento]) {
            this.listeners[evento] = [];
        }
        this.listeners[evento].push(callback);
    },
    
    off(evento, callback) {
        if (!this.listeners[evento]) return;
        this.listeners[evento] = this.listeners[evento].filter(cb => cb !== callback);
    },
    
    trigger(evento, data) {
        if (!this.listeners[evento]) return;
        this.listeners[evento].forEach(callback => {
            try {
                callback(data);
            } catch (error) {
                console.error(`Erro ao executar callback para evento ${evento}:`, error);
            }
        });
    }
};

// Verificação periódica do estado dos botões
setInterval(verificarBotoesFuncionando, 10000);

// Inicializar o monitoramento do sistema quando a aplicação estiver pronta
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        sistemaMonitor.iniciar();
        otimizarParaDispositivos();
    }, 1000);
});

// Iniciar o controle de foco nos elementos
document.addEventListener('focusin', function(e) {
    const target = e.target;
    if (target.tagName === 'INPUT' || target.tagName === 'SELECT' || target.tagName === 'TEXTAREA') {
        target.dataset.lastValue = target.value;
    }
});

document.addEventListener('focusout', function(e) {
    const target = e.target;
    if ((target.tagName === 'INPUT' || target.tagName === 'SELECT' || target.tagName === 'TEXTAREA') && 
        target.dataset.lastValue !== target.value) {
        console.log(`Valor alterado em ${target.id || target.name}`);
        EventosSistema.trigger('campo-alterado', { 
            elemento: target, 
            valorAntigo: target.dataset.lastValue, 
            valorNovo: target.value 
        });
    }
});

// Capturar erros em APIs assíncronas
window.addEventListener('unhandledrejection', function(event) {
    console.error('Promessa rejeitada não tratada:', event.reason);
    // Removida notificação
});

// Inicialização final com verificação de segurança
window.addEventListener('load', function() {
    // Verificação final para garantir que tudo está funcionando
    setTimeout(() => {
        verificarBotoesFuncionando();
        
        // Verificar navegação
        const paginasAtivas = document.querySelectorAll('.page-content.active');
        if (paginasAtivas.length === 0 && currentUser) {
            console.warn("Página não inicializada corretamente, forçando navegação para estoque");
            const navEstoque = document.querySelector('.nav-link[data-page="estoque"]');
            if (navEstoque) navEstoque.click();
        }
    }, 500);
});

// Garantir que todas as funções críticas estão definidas
function verificarFuncoesNecessarias() {
    const funcoesEssenciais = [
        'removerMaterial',
        'editarReceita', 
        'removerReceita',
        'registrarVenda',
        'editarVenda',
        'excluirVenda',
        'carregarEstoque',
        'carregarMateriais',
        'carregarReceitas',
        'carregarVendas'
    ];
    
    let todasDefinidas = true;
    
    funcoesEssenciais.forEach(funcao => {
        if (typeof window[funcao] !== 'function') {
            console.error(`Função necessária não definida: ${funcao}`);
            todasDefinidas = false;
        }
    });
    
    if (!todasDefinidas) {
        console.error("ALERTA: Algumas funções críticas não estão definidas. O sistema pode não funcionar corretamente.");
        // Removida notificação
    }
    
    return todasDefinidas;
}

// Executar verificação após carregamento completo
window.addEventListener('load', verificarFuncoesNecessarias);

// Função para lidar com a adição de múltiplas receitas na venda - NOVA
function inicializarGerenciadorReceitasVenda() {
    // Configurar botão de adicionar receita
    const btnAdicionarReceita = document.getElementById('btn-adicionar-receita-venda');
    if (btnAdicionarReceita) {
        btnAdicionarReceita.removeEventListener('click', abrirModalAdicionarReceita);
        btnAdicionarReceita.addEventListener('click', abrirModalAdicionarReceita);
    }
    
    // Configurar modal de adicionar receita
    const btnFecharModal = document.getElementById('fechar-adicionar-receita-modal');
    if (btnFecharModal) {
        btnFecharModal.removeEventListener('click', fecharModalAdicionarReceita);
        btnFecharModal.addEventListener('click', fecharModalAdicionarReceita);
    }
    
    // Configurar select de receitas
    const selectReceita = document.getElementById('selecionar-receita-modal');
    if (selectReceita) {
        selectReceita.removeEventListener('change', carregarDetalhesReceitaModal);
        selectReceita.addEventListener('change', carregarDetalhesReceitaModal);
    }
    
    // Configurar botão de confirmar adição
    const btnConfirmarReceita = document.getElementById('confirmar-adicionar-receita');
    if (btnConfirmarReceita) {
        btnConfirmarReceita.removeEventListener('click', adicionarReceitaAVenda);
        btnConfirmarReceita.addEventListener('click', adicionarReceitaAVenda);
    }
    
    // Configurar botão de confirmar venda
    const btnConfirmarVenda = document.getElementById('confirmar-venda');
    if (btnConfirmarVenda) {
        btnConfirmarVenda.removeEventListener('click', confirmarVendaMultiplasReceitas);
        btnConfirmarVenda.addEventListener('click', confirmarVendaMultiplasReceitas);
    }
    
    // Configurar campos para atualização de resumo
    ['custo-frete', 'custo-decoracao', 'despesas-adicionais'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.removeEventListener('input', atualizarResumoFinanceiroVendaMultipla);
            el.addEventListener('input', atualizarResumoFinanceiroVendaMultipla);
        }
    });
}

// Função para abrir modal de adicionar receita - NOVA
function abrirModalAdicionarReceita() {
    const modal = document.getElementById('adicionar-receita-venda-modal');
    if (!modal) return;
    
    // Limpar seleção anterior
    const selectReceita = document.getElementById('selecionar-receita-modal');
    if (selectReceita) {
        selectReceita.value = '';
        
        // Carregar opções de receitas
        selectReceita.innerHTML = '<option value="">Selecione uma receita...</option>';
        
        receitas.forEach(receita => {
            const option = document.createElement('option');
            option.value = receita.id;
            option.textContent = receita.nome;
            selectReceita.appendChild(option);
        });
    }
    
    // Esconder detalhes
    const detalhesReceita = document.getElementById('detalhes-receita-modal');
    if (detalhesReceita) {
        detalhesReceita.classList.add('hidden');
    }
    
    // Exibir modal
    modal.classList.remove('hidden');
}

// Função para fechar modal de adicionar receita - NOVA
function fecharModalAdicionarReceita() {
    const modal = document.getElementById('adicionar-receita-venda-modal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

// Função para atualizar resumo financeiro de múltiplas receitas - NOVA
function atualizarResumoFinanceiroVendaMultipla() {
    const receitasContainer = document.getElementById('receitas-venda-container');
    if (!receitasContainer) return;
    
    // Obter todas as receitas adicionadas
    const receitasItems = receitasContainer.querySelectorAll('.receita-item');
    if (receitasItems.length === 0) return;
    
    let custoProducaoTotal = 0;
    let valorVendaTotal = 0;
    
    // Somar custos e valores de todas as receitas
    receitasItems.forEach(item => {
        // Verificar se a receita está calculando preço
        const calcularPreco = item.querySelector('.receita-calcular-preco').checked;
        if (!calcularPreco) return;
        
        const receitaId = item.getAttribute('data-id');
        const quantidade = parseInt(item.querySelector('.receita-quantidade').textContent) || 1;
        
        // Encontrar a receita
        const receita = receitas.find(r => r.id === receitaId);
        if (!receita) return;
        
        // Calcular custo de produção com base no preço médio por g/ml
        const custoProducao = calcularCustoReceita(receita);
        const custosVariados = custoProducao * 0.1;
        
        // Adicionar ao total
        custoProducaoTotal += (custoProducao + custosVariados) * quantidade;
        valorVendaTotal += receita.precoVenda * quantidade;
    });
    
    // Obter valores adicionais
    const frete = parseFloat(document.getElementById('custo-frete').value) || 0;
    const decoracao = parseFloat(document.getElementById('custo-decoracao').value) || 0;
    const despesasAdicionais = parseFloat(document.getElementById('despesas-adicionais').value) || 0;
    
    // Calcular finais
    const valorTotal = valorVendaTotal + frete + decoracao;
    const despesa = custoProducaoTotal;
    const reinvestir = despesa;
    const despesasAdicionaisComAcrescimo = despesasAdicionais * 1.1;
    const totalDespesasAdicionais = despesasAdicionaisComAcrescimo + frete + decoracao;
    const lucro = valorTotal - despesa - reinvestir - despesasAdicionais;
    
    // Atualizar interface
    document.getElementById('resumo-valor-total').textContent = formatarMoeda(valorTotal);
    document.getElementById('resumo-despesa').textContent = formatarMoeda(despesa);
    document.getElementById('resumo-reinvestir').textContent = formatarMoeda(reinvestir);
    document.getElementById('resumo-desp-adic').textContent = formatarMoeda(totalDespesasAdicionais);
    
    const resumoLucro = document.getElementById('resumo-lucro');
    if (resumoLucro) {
        resumoLucro.textContent = formatarMoeda(lucro);
        resumoLucro.className = 'venda-resumo-valor ' + (lucro >= 0 ? 'lucro-positivo' : 'lucro-negativo');
    }
}
// Parte 5: JavaScript - Funções para Estoque/Materiais
// Função para calcular o preço médio por unidade de um material - ATUALIZADA
function calcularPrecoMedio(material) {
    if (!material || !material.historicoPrecos || material.historicoPrecos.length === 0) {
        return 0;
    }
    
    const totalPrecos = material.historicoPrecos.reduce((total, registro) => total + (parseFloat(registro.preco) || 0), 0);
    return totalPrecos / material.historicoPrecos.length;
}

// Função para calcular o preço médio por grama/ml - NOVA
function calcularPrecoMedioPorGramaMl(material) {
    if (!material || !material.historicoPrecos || material.historicoPrecos.length === 0) {
        return 0;
    }
    
    // Calcular o preço por unidade de medida (g/ml)
    let totalPrecoPorGramaMl = 0;
    let numRegistros = 0;
    
    material.historicoPrecos.forEach(registro => {
        const preco = parseFloat(registro.preco) || 0;
        const quantidadeMedida = parseFloat(material.quantidadeMedida) || 1;
        
        if (preco > 0 && quantidadeMedida > 0) {
            totalPrecoPorGramaMl += preco / quantidadeMedida;
            numRegistros++;
        }
    });
    
    return numRegistros > 0 ? totalPrecoPorGramaMl / numRegistros : 0;
}

// Função para obter o preço médio por unidade de um material pelo código - ATUALIZADA
function obterPrecoMedioPorCodigo(codigo) {
    if (!codigo) return 0;
    
    // Encontrar todos os materiais com esse código
    const materiaisComCodigo = materiais.filter(m => m.codigo === codigo);
    if (materiaisComCodigo.length === 0) return 0;
    
    // Calcular preço médio geral considerando todos os registros de preço
    let todosPrecos = [];
    materiaisComCodigo.forEach(material => {
        if (material.historicoPrecos && material.historicoPrecos.length > 0) {
            todosPrecos = todosPrecos.concat(material.historicoPrecos);
        }
    });
    
    if (todosPrecos.length === 0) return 0;
    
    const totalPrecos = todosPrecos.reduce((total, registro) => total + (parseFloat(registro.preco) || 0), 0);
    return totalPrecos / todosPrecos.length;
}

// Função para obter o preço médio por grama/ml pelo código - NOVA
function obterPrecoMedioPorGramaMlPorCodigo(codigo) {
    if (!codigo) return 0;
    
    // Encontrar todos os materiais com esse código
    const materiaisComCodigo = materiais.filter(m => m.codigo === codigo);
    if (materiaisComCodigo.length === 0) return 0;
    
    let totalPrecoPorGramaMl = 0;
    let numRegistros = 0;
    
    // Para cada material, calcular o preço por grama/ml para cada registro de preço
    materiaisComCodigo.forEach(material => {
        if (material.historicoPrecos && material.historicoPrecos.length > 0) {
            material.historicoPrecos.forEach(registro => {
                const preco = parseFloat(registro.preco) || 0;
                const quantidadeMedida = parseFloat(material.quantidadeMedida) || 1;
                
                if (preco > 0 && quantidadeMedida > 0) {
                    totalPrecoPorGramaMl += preco / quantidadeMedida;
                    numRegistros++;
                }
            });
        }
    });
    
    return numRegistros > 0 ? totalPrecoPorGramaMl / numRegistros : 0;
}

// Função para obter o preço médio por grama/ml pelo nome - NOVA
function obterPrecoMedioPorGramaMlPorNome(nome) {
    if (!nome) return 0;
    
    // Normalizar o nome para comparação
    const nomeLimpo = nome.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    
    // Encontrar todos os materiais com esse nome
    const materiaisComNome = materiais.filter(m => {
        if (!m.nome) return false;
        const materialNomeLimpo = m.nome.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        return materialNomeLimpo === nomeLimpo || materialNomeLimpo.includes(nomeLimpo) || nomeLimpo.includes(materialNomeLimpo);
    });
    
    if (materiaisComNome.length === 0) return 0;
    
    let totalPrecoPorGramaMl = 0;
    let numRegistros = 0;
    
    // Para cada material, calcular o preço por grama/ml para cada registro de preço
    materiaisComNome.forEach(material => {
        if (material.historicoPrecos && material.historicoPrecos.length > 0) {
            material.historicoPrecos.forEach(registro => {
                const preco = parseFloat(registro.preco) || 0;
                const quantidadeMedida = parseFloat(material.quantidadeMedida) || 1;
                
                if (preco > 0 && quantidadeMedida > 0) {
                    totalPrecoPorGramaMl += preco / quantidadeMedida;
                    numRegistros++;
                }
            });
        }
    });
    
    return numRegistros > 0 ? totalPrecoPorGramaMl / numRegistros : 0;
}

// Função para encontrar um material pelo código - OTIMIZADA
function encontrarMaterialPorCodigo(codigo) {
    if (!codigo) return null;
    
    // Encontra o material mais recente com o código informado
    const materiaisComCodigo = materiais.filter(m => m.codigo === codigo);
    if (materiaisComCodigo.length === 0) return null;
    
    // Ordena por data de cadastro decrescente (mais recente primeiro)
    materiaisComCodigo.sort((a, b) => new Date(b.dataCadastro || 0) - new Date(a.dataCadastro || 0));
    
    // Retorna o material mais recente
    const materialMaisRecente = materiaisComCodigo[0];
    
    // Calcular e atualizar o preço médio por unidade
    materialMaisRecente.precoMedio = obterPrecoMedioPorCodigo(codigo);
    
    // Calcular e atualizar o preço médio por grama/ml
    materialMaisRecente.precoMedioPorGramaMl = obterPrecoMedioPorGramaMlPorCodigo(codigo);
    
    return materialMaisRecente;
}

// Função para encontrar um material pelo nome - OTIMIZADA
function encontrarMaterialPorNome(nome) {
    if (!nome) return null;
    
    // Normalizar o nome para comparação (minúsculas, sem acentos)
    const nomeLimpo = nome.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    
    // Encontrar materiais com nomes similares
    const materiaisComNome = materiais.filter(m => {
        if (!m.nome) return false;
        const materialNomeLimpo = m.nome.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        return materialNomeLimpo === nomeLimpo || materialNomeLimpo.includes(nomeLimpo) || nomeLimpo.includes(materialNomeLimpo);
    });
    
    if (materiaisComNome.length === 0) return null;
    
    // Ordena por data de cadastro decrescente (mais recente primeiro)
    materiaisComNome.sort((a, b) => new Date(b.dataCadastro || 0) - new Date(a.dataCadastro || 0));
    
    // Retorna o material mais recente
    const materialMaisRecente = materiaisComNome[0];
    
    // Calcular e atualizar o preço médio por unidade
    if (materialMaisRecente.codigo) {
        materialMaisRecente.precoMedio = obterPrecoMedioPorCodigo(materialMaisRecente.codigo);
    } else {
        // Calcular preço médio baseado no nome
        materialMaisRecente.precoMedio = calcularPrecoMedio(materialMaisRecente);
    }
    
    // Calcular e atualizar o preço médio por grama/ml
    materialMaisRecente.precoMedioPorGramaMl = obterPrecoMedioPorGramaMlPorNome(nome);
    
    return materialMaisRecente;
}

// Função para adicionar ou atualizar um material no catálogo - OTIMIZADA
function adicionarOuAtualizarMaterial(codigoMaterial, nomeMaterial, unidadeMaterial, unidadeMedidaMaterial, quantidadeMedidaMaterial, precoMaterial, dataCompra = null) {
    try {
        // Converter valores para números
        quantidadeMedidaMaterial = parseFloat(quantidadeMedidaMaterial);
        precoMaterial = parseFloat(precoMaterial);
        
        // Verificar se valores são válidos
        if (isNaN(quantidadeMedidaMaterial) || quantidadeMedidaMaterial <= 0) {
            console.error('A quantidade por unidade deve ser um número válido maior que zero.');
            return null;
        }
        
        if (isNaN(precoMaterial) || precoMaterial <= 0) {
            console.error('O preço deve ser um número válido maior que zero.');
            return null;
        }
        
        // MODIFICADO: Criar sempre um novo registro, mas manter referência do material existente
        const materialExistente = encontrarMaterialPorCodigo(codigoMaterial);
        
        // Se não encontrou por código, tentar encontrar por nome para manter consistência
        const materialPorNome = !materialExistente && nomeMaterial ? encontrarMaterialPorNome(nomeMaterial) : null;
        
        // Definir código correto caso encontrado pelo nome
        if (!codigoMaterial && materialPorNome) {
            codigoMaterial = materialPorNome.codigo;
        }
        
        // Calcular preço médio atualizado
        let historicoPrecos = [];
        let precoMedio = precoMaterial;
        let precoMedioPorGramaMl = precoMaterial / quantidadeMedidaMaterial;
        
        if (materialExistente && materialExistente.historicoPrecos) {
            historicoPrecos = [...materialExistente.historicoPrecos];
            // Adicionar novo preço ao histórico
            historicoPrecos.push({
                data: dataCompra || new Date().toISOString(),
                preco: precoMaterial
            });
            
            // Recalcular preço médio por unidade
            precoMedio = historicoPrecos.reduce((total, item) => total + (parseFloat(item.preco) || 0), 0) / historicoPrecos.length;
            
            // Recalcular preço médio por grama/ml
            let totalPrecoPorGramaMl = 0;
            historicoPrecos.forEach(item => {
                totalPrecoPorGramaMl += (parseFloat(item.preco) || 0) / quantidadeMedidaMaterial;
            });
            precoMedioPorGramaMl = totalPrecoPorGramaMl / historicoPrecos.length;
            
        } else if (materialPorNome && materialPorNome.historicoPrecos) {
            historicoPrecos = [...materialPorNome.historicoPrecos];
            // Adicionar novo preço ao histórico
            historicoPrecos.push({
                data: dataCompra || new Date().toISOString(),
                preco: precoMaterial
            });
            
            // Recalcular preço médio por unidade
            precoMedio = historicoPrecos.reduce((total, item) => total + (parseFloat(item.preco) || 0), 0) / historicoPrecos.length;
            
            // Recalcular preço médio por grama/ml
            let totalPrecoPorGramaMl = 0;
            historicoPrecos.forEach(item => {
                totalPrecoPorGramaMl += (parseFloat(item.preco) || 0) / quantidadeMedidaMaterial;
            });
            precoMedioPorGramaMl = totalPrecoPorGramaMl / historicoPrecos.length;
            
        } else {
            // Primeiro registro deste material
            historicoPrecos = [{
                data: dataCompra || new Date().toISOString(),
                preco: precoMaterial
            }];
            
            // Preço médio por grama/ml para o primeiro registro
            precoMedioPorGramaMl = precoMaterial / quantidadeMedidaMaterial;
        }
        
        // Criar novo material
        const novoMaterial = {
            id: gerarId(),
            codigo: codigoMaterial || gerarId().substring(0, 8), // Gerar código se não fornecido
            nome: nomeMaterial,
            unidade: unidadeMaterial,
            unidadeMedida: unidadeMedidaMaterial,
            quantidadeMedida: quantidadeMedidaMaterial,
            ultimoPreco: precoMaterial,
            precoMedio: precoMedio,
            precoMedioPorGramaMl: precoMedioPorGramaMl,
            ultimaCompra: dataCompra || new Date().toISOString(),
            dataCadastro: new Date().toISOString(),
            historicoPrecos: historicoPrecos
        };
        
        materiais.push(novoMaterial);
        return novoMaterial.id;
    } catch (error) {
        console.error("Erro ao adicionar material:", error);
        return null;
    }
}

// Função para adicionar item ao estoque - OTIMIZADA
function adicionarItemEstoque(materialId, quantidade, preco = null) {
    try {
        const material = materiais.find(m => m.id === materialId);
        if (!material) return false;
        
        // Verificar se a quantidade é válida
        quantidade = parseFloat(quantidade);
        if (isNaN(quantidade) || quantidade <= 0) {
            console.error('A quantidade deve ser um número válido maior que zero.');
            return false;
        }
        
        // Verificar se existe um item com o mesmo código ou nome no estoque
        const itemPorCodigo = estoque.find(i => {
            const materialItem = materiais.find(m => m.id === i.materialId);
            return materialItem && materialItem.codigo === material.codigo;
        });
        
        const itemPorNome = estoque.find(i => {
            const materialItem = materiais.find(m => m.id === i.materialId);
            return materialItem && materialItem.nome.toLowerCase() === material.nome.toLowerCase();
        });
        
        const itemExistente = itemPorCodigo || itemPorNome;
        
        if (itemExistente) {
            // Atualizar item existente - somar quantidade
            itemExistente.quantidade += quantidade;
            
            // Atualizar com o código do material atual se não tiver
            if (!itemExistente.codigo && material.codigo) {
                itemExistente.codigo = material.codigo;
            }
            
            // Usar preço médio do material para consistência
            itemExistente.preco = material.precoMedio;
            itemExistente.precoPorGramaMl = material.precoMedioPorGramaMl;
            
            return true;
        } else {
            // Criar novo item
            const novoItem = {
                id: gerarId(),
                materialId: materialId,
                codigo: material.codigo,
                nome: material.nome,
                quantidade: quantidade,
                unidade: material.unidade,
                unidadeMedida: material.unidadeMedida,
                quantidadeMedida: material.quantidadeMedida,
                preco: material.precoMedio, // Usar preço médio em vez do preço atual
                precoPorGramaMl: material.precoMedioPorGramaMl, // Adicionar preço médio por g/ml
                dataAdicao: new Date().toISOString()
            };
            
            estoque.push(novoItem);
            return true;
        }
    } catch (error) {
        console.error("Erro ao adicionar item ao estoque:", error);
        return false;
    }
}

// Função para remover item do estoque - OTIMIZADA
function removerItemEstoque(materialId, quantidade, unidadeMedida) {
    try {
        // Tenta encontrar o material específico
        const material = materiais.find(m => m.id === materialId);
        if (!material) return false;
        
        // Procurar por itens no estoque com mesmo código ou nome
        const itensPossiveis = estoque.filter(i => {
            const materialItem = materiais.find(m => m.id === i.materialId);
            return materialItem && 
                   (materialItem.codigo === material.codigo || 
                    materialItem.nome.toLowerCase() === material.nome.toLowerCase());
        });
        
        if (itensPossiveis.length === 0) return false;
        
        // Normalizar unidades para a menor unidade (g ou ml)
        let quantidadeNormalizada = quantidade;
        
        // Se a unidade de medida for passada, converter conforme necessário
        if (unidadeMedida) {
            // Pegar a unidade do primeiro item encontrado para conversão
            const item = itensPossiveis[0];
            
            // Converter KG para g, L para ml
            if (unidadeMedida.toLowerCase() === 'kg' && item.unidadeMedida.toLowerCase() === 'g') {
                quantidadeNormalizada *= 1000;
            } else if (unidadeMedida.toLowerCase() === 'l' && item.unidadeMedida.toLowerCase() === 'ml') {
                quantidadeNormalizada *= 1000;
            }
            // Converter g para kg, ml para l se necessário
            else if (unidadeMedida.toLowerCase() === 'g' && item.unidadeMedida.toLowerCase() === 'kg') {
                quantidadeNormalizada /= 1000;
            } else if (unidadeMedida.toLowerCase() === 'ml' && item.unidadeMedida.toLowerCase() === 'l') {
                quantidadeNormalizada /= 1000;
            }
        }
        
        // Converter a quantidade solicitada para unidades do estoque
        let quantidadeRestanteRemover = quantidadeNormalizada;
        let removidoComSucesso = false;
        
        // Ordenar os itens do mais antigo para o mais recente para consumir primeiro os mais antigos
        itensPossiveis.sort((a, b) => new Date(a.dataAdicao || 0) - new Date(b.dataAdicao || 0));
        
        // Remover de cada item até completar a quantidade necessária
        for (const item of itensPossiveis) {
            if (quantidadeRestanteRemover <= 0) break;
            
            // Converter para unidades do item atual
            const quantidadeEmUnidades = quantidadeRestanteRemover / (item.quantidadeMedida || 1);
            
            if (item.quantidade >= quantidadeEmUnidades) {
                // Este item tem quantidade suficiente
                item.quantidade -= quantidadeEmUnidades;
                quantidadeRestanteRemover = 0;
                removidoComSucesso = true;
                break;
            } else {
                // Este item não tem quantidade suficiente, remover o que puder
                quantidadeRestanteRemover -= (item.quantidade * (item.quantidadeMedida || 1));
                item.quantidade = 0;
                removidoComSucesso = true;
            }
        }
        
        // Remover itens com quantidade zero
        estoque = estoque.filter(item => item.quantidade > 0);
        
        return removidoComSucesso;
    } catch (error) {
        console.error("Erro ao remover item do estoque:", error);
        return false;
    }
}

// Função para adicionar estoque de volta (quando cancela uma venda) - OTIMIZADA
function adicionarEstoqueDeVolta(materialId, quantidade, unidadeMedida) {
    try {
        // Essa função é o inverso de removerItemEstoque
        const material = materiais.find(m => m.id === materialId);
        if (!material) return false;
        
        // Verificar se já existe um item deste material no estoque
        const itensPossiveis = estoque.filter(i => {
            const materialItem = materiais.find(m => m.id === i.materialId);
            return materialItem && 
                   (materialItem.codigo === material.codigo || 
                    materialItem.nome.toLowerCase() === material.nome.toLowerCase());
        });
        
        // Normalizar unidades
        let quantidadeNormalizada = quantidade;
        
        if (unidadeMedida && itensPossiveis.length > 0) {
            const item = itensPossiveis[0];
            
            // Converter KG para g, L para ml
            if (unidadeMedida.toLowerCase() === 'kg' && item.unidadeMedida.toLowerCase() === 'g') {
                quantidadeNormalizada *= 1000;
            } else if (unidadeMedida.toLowerCase() === 'l' && item.unidadeMedida.toLowerCase() === 'ml') {
                quantidadeNormalizada *= 1000;
            }
            // Converter g para kg, ml para l se necessário
            else if (unidadeMedida.toLowerCase() === 'g' && item.unidadeMedida.toLowerCase() === 'kg') {
                quantidadeNormalizada /= 1000;
            } else if (unidadeMedida.toLowerCase() === 'ml' && item.unidadeMedida.toLowerCase() === 'l') {
                quantidadeNormalizada /= 1000;
            }
        }
        
        if (itensPossiveis.length > 0) {
            // Adicionar ao primeiro item encontrado
            const itemEstoque = itensPossiveis[0];
            const quantidadeEmUnidades = quantidadeNormalizada / (itemEstoque.quantidadeMedida || 1);
            itemEstoque.quantidade += quantidadeEmUnidades;
        } else {
            // Criar novo item no estoque
            const novoItem = {
                id: gerarId(),
                materialId: materialId,
                codigo: material.codigo,
                nome: material.nome,
                quantidade: quantidade / (material.quantidadeMedida || 1), // Converter para unidades
                unidade: material.unidade,
                unidadeMedida: material.unidadeMedida,
                quantidadeMedida: material.quantidadeMedida,
                preco: material.precoMedio, // Usar preço médio
                precoPorGramaMl: material.precoMedioPorGramaMl, // Adicionar preço médio por g/ml
                dataAdicao: new Date().toISOString()
            };
            
            estoque.push(novoItem);
        }
        
        return true;
    } catch (error) {
        console.error("Erro ao adicionar estoque de volta:", error);
        return false;
    }
}

// Função para unificar itens de estoque - OTIMIZADA (CORRIGIDA)
function unificarEstoque() {
    try {
        // Cria um novo array para armazenar o estoque unificado
        const estoqueUnificado = [];
        const itensPorCodigo = {};
        const itensPorNome = {};
        
        // Verifica se há itens no estoque
        if (!estoque || estoque.length === 0) {
            return estoqueUnificado;
        }
        
        // Primeiro agrupamos por código
        for (const item of estoque) {
            try {
                if (!item || !item.materialId) continue;
                
                // Encontrar o material associado
                const material = materiais.find(m => m.id === item.materialId);
                if (!material) continue;
                
                const codigo = material.codigo;
                if (codigo) {
                    if (!itensPorCodigo[codigo]) {
                        itensPorCodigo[codigo] = {
                            id: gerarId(),
                            materialId: material.id,
                            codigo: codigo,
                            nome: material.nome,
                            quantidade: 0,
                            unidade: material.unidade,
                            unidadeMedida: material.unidadeMedida,
                            quantidadeMedida: material.quantidadeMedida,
                            preco: material.precoMedio || 0,
                            precoPorGramaMl: material.precoMedioPorGramaMl || 0,
                            dataAdicao: new Date().toISOString()
                        };
                    }
                    
                    // Somar quantidade normalizada
                    itensPorCodigo[codigo].quantidade += (parseFloat(item.quantidade) || 0);
                }
            } catch (err) {
                console.error("Erro ao processar item para unificação por código:", err);
                continue;
            }
        }
        
        // Depois agrupamos os que não têm código por nome
        for (const item of estoque) {
            try {
                if (!item || !item.materialId) continue;
                
                const material = materiais.find(m => m.id === item.materialId);
                if (!material || material.codigo) continue; // Ignorar se tem código ou sem material
                
                const nome = material.nome ? material.nome.toLowerCase() : "";
                if (!nome) continue;
                
                if (!itensPorNome[nome]) {
                    itensPorNome[nome] = {
                        id: gerarId(),
                        materialId: material.id,
                        codigo: "",
                        nome: material.nome,
                        quantidade: 0,
                        unidade: material.unidade,
                        unidadeMedida: material.unidadeMedida,
                        quantidadeMedida: material.quantidadeMedida,
                        preco: material.precoMedio || 0,
                        precoPorGramaMl: material.precoMedioPorGramaMl || 0,
                        dataAdicao: new Date().toISOString()
                    };
                }
                
                // Somar quantidade normalizada
                itensPorNome[nome].quantidade += (parseFloat(item.quantidade) || 0);
            } catch (err) {
                console.error("Erro ao processar item para unificação por nome:", err);
                continue;
            }
        }
        
        // Combinar os resultados
        for (const codigo in itensPorCodigo) {
            if (itensPorCodigo[codigo].quantidade > 0) {
                estoqueUnificado.push(itensPorCodigo[codigo]);
            }
        }
        
        for (const nome in itensPorNome) {
            // Verificar se já não foi adicionado por código
            const jaAdicionado = estoqueUnificado.some(item => 
                item.nome && nome && item.nome.toLowerCase() === nome);
            
            if (!jaAdicionado && itensPorNome[nome].quantidade > 0) {
                estoqueUnificado.push(itensPorNome[nome]);
            }
        }
        
        // Não substituir o estoque original pelo unificado, apenas retornar o unificado
        return estoqueUnificado;
    } catch (error) {
        console.error("Erro ao unificar estoque:", error);
        return []; // Retornar array vazio em caso de erro
    }
}

// Função para remover um material e todas suas referências - OTIMIZADA (CORRIGIDA)
function removerMaterial(id) {
    try {
        // Encontrar o material a ser removido
        const material = materiais.find(m => m.id === id);
        if (!material) {
            console.error("Material não encontrado");
            return false;
        }
        
        const codigo = material.codigo;
        const nome = material.nome;
        
        // Remover o material da lista de materiais
        const indexMaterial = materiais.findIndex(m => m.id === id);
        if (indexMaterial !== -1) {
            materiais.splice(indexMaterial, 1);
        }
        
        // Atualizar localStorage e recarregar interfaces
        atualizarLocalStorage();
        
        // Recarregar interfaces
        carregarMateriais();
        carregarEstoque();
        
        console.log("Material removido com sucesso!");
        return true;
    } catch (error) {
        console.error("Erro ao remover material:", error);
        return false;
    }
}

// Função para carregar materiais na tabela - OTIMIZADA
function carregarMateriais() {
    try {
        const tbody = document.getElementById('itens-materiais');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (materiais.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="10" style="text-align: center;">Nenhum material cadastrado.</td>';
            tbody.appendChild(tr);
            return;
        }
        
        // Ordenar materiais pelo mais recente primeiro
        const materiaisOrdenados = [...materiais].sort((a, b) => new Date(b.dataCadastro || 0) - new Date(a.dataCadastro || 0));
        
        materiaisOrdenados.forEach(material => {
            // Calcular o preço médio por unidade para este código
            let precoMedio = 0;
            let precoMedioPorGramaMl = 0;
            
            if (material.codigo) {
                precoMedio = obterPrecoMedioPorCodigo(material.codigo);
                precoMedioPorGramaMl = obterPrecoMedioPorGramaMlPorCodigo(material.codigo);
            } else {
                // Se não tem código, calcular pelo nome
                const materiaisMesmoNome = materiais.filter(m => 
                    m.nome && m.nome.toLowerCase() === material.nome.toLowerCase());
                
                if (materiaisMesmoNome.length > 0) {
                    let todosPrecos = [];
                    materiaisMesmoNome.forEach(m => {
                        if (m.historicoPrecos && m.historicoPrecos.length > 0) {
                            todosPrecos = todosPrecos.concat(m.historicoPrecos);
                        }
                    });
                    
                    if (todosPrecos.length > 0) {
                        precoMedio = todosPrecos.reduce((total, item) => total + (parseFloat(item.preco) || 0), 0) / todosPrecos.length;
                        
                        // Calcular preço médio por g/ml
                        let totalPrecoPorGramaMl = 0;
                        let registrosValidos = 0;
                        
                        materiaisMesmoNome.forEach(m => {
                            if (m.historicoPrecos) {
                                m.historicoPrecos.forEach(registro => {
                                    const preco = parseFloat(registro.preco) || 0;
                                    const quantidadeMedida = parseFloat(m.quantidadeMedida) || 1;
                                    
                                    if (preco > 0 && quantidadeMedida > 0) {
                                        totalPrecoPorGramaMl += preco / quantidadeMedida;
                                        registrosValidos++;
                                    }
                                });
                            }
                        });
                        
                        if (registrosValidos > 0) {
                            precoMedioPorGramaMl = totalPrecoPorGramaMl / registrosValidos;
                        }
                    } else {
                        precoMedio = material.ultimoPreco || 0;
                        precoMedioPorGramaMl = material.ultimoPreco / (material.quantidadeMedida || 1);
                    }
                } else {
                    precoMedio = material.ultimoPreco || 0;
                    precoMedioPorGramaMl = material.ultimoPreco / (material.quantidadeMedida || 1);
                }
            }
            
            // Formatar preço médio por g/ml para exibição
            const precoMedioPorGramaMlFormatado = formatarMoeda(precoMedioPorGramaMl) + '/' + material.unidadeMedida;
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${material.codigo || 'N/A'}</td>
                <td>${material.nome}</td>
                <td>${material.unidade}</td>
                <td>${material.unidadeMedida}</td>
                <td>${material.quantidadeMedida}</td>
                <td>${formatarData(material.ultimaCompra)}</td>
                <td>${formatarMoeda(material.ultimoPreco)}</td>
                <td>${formatarMoeda(precoMedio)}</td>
                <td>${precoMedioPorGramaMlFormatado}</td>
                <td>
                    <button class="btn btn-primary btn-editar-material" data-id="${material.id}">Editar</button>
                    <button class="btn btn-success btn-adicionar-estoque" data-id="${material.id}">+ Estoque</button>
                    <button class="btn btn-danger btn-remover-material" data-id="${material.id}">Excluir</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        // Configurar eventos para os botões usando delegação
        const tabelaMateriais = document.getElementById('itens-materiais');
        if (tabelaMateriais) {
            // Remover eventos existentes antes de adicionar novos
            EventManager.delegateEvent(tabelaMateriais, '.btn-editar-material', 'click', function() {
                const id = this.getAttribute('data-id');
                const material = materiais.find(m => m.id === id);
                const index = materiais.indexOf(material);
                if (index !== -1) {
                    editarMaterial(index);
                }
            });
            
            EventManager.delegateEvent(tabelaMateriais, '.btn-adicionar-estoque', 'click', function() {
                const id = this.getAttribute('data-id');
                adicionarAoEstoque(id);
            });
            
            EventManager.delegateEvent(tabelaMateriais, '.btn-remover-material', 'click', function() {
                const id = this.getAttribute('data-id');
                removerMaterial(id);
            });
        }
    } catch (error) {
        console.error("Erro ao carregar materiais:", error);
    }
}

// Função para editar um material - OTIMIZADA
function editarMaterial(index) {
    try {
        const material = materiais[index];
        if(!material) return;
        
        // Mudar para a aba de adicionar item
        const tabButton = document.querySelector('.tab-button[data-tab="adicionar-item"]');
        if (tabButton) {
            tabButton.click();
        }
        
        // Preencher o formulário
        document.getElementById('codigo-material').value = material.codigo || '';
        document.getElementById('nome-material').value = material.nome;
        document.getElementById('unidade-material').value = material.unidade;
        document.getElementById('unidade-medida-material').value = material.unidadeMedida;
        document.getElementById('quantidade-medida-material').value = material.quantidadeMedida;
        document.getElementById('preco-material').value = material.ultimoPreco;
        
        // Quantidade para estoque
        document.getElementById('quantidade-material').value = 1;
        
        // Data de compra
        const dataCompra = document.getElementById('data-compra-material');
        if (dataCompra) {
            const data = new Date(material.ultimaCompra);
            dataCompra.value = data.toISOString().split('T')[0];
        }
        
        // Mostrar informações de preço médio
        const infoPrecoMedio = document.getElementById('info-preco-medio');
        if (infoPrecoMedio) {
            // Contar todos os registros de preço para este material (por código)
            let todosPrecos = [];
            const materialCodigoIgual = materiais.filter(m => m.codigo === material.codigo);
            
            materialCodigoIgual.forEach(m => {
                if (m.historicoPrecos && m.historicoPrecos.length > 0) {
                    todosPrecos = todosPrecos.concat(m.historicoPrecos);
                }
            });
            
            if (todosPrecos.length > 0) {
                const precoMedio = todosPrecos.reduce((total, item) => total + (parseFloat(item.preco) || 0), 0) / todosPrecos.length;
                
                // Calcular preço médio por g/ml
                let totalPrecoPorGramaMl = 0;
                let registrosValidos = 0;
                
                materialCodigoIgual.forEach(m => {
                    if (m.historicoPrecos) {
                        m.historicoPrecos.forEach(registro => {
                            const preco = parseFloat(registro.preco) || 0;
                            const quantidadeMedida = parseFloat(m.quantidadeMedida) || 1;
                            
                            if (preco > 0 && quantidadeMedida > 0) {
                                totalPrecoPorGramaMl += preco / quantidadeMedida;
                                registrosValidos++;
                            }
                        });
                    }
                });
                
                const precoMedioPorGramaMl = registrosValidos > 0 ? totalPrecoPorGramaMl / registrosValidos : 0;
                
                document.getElementById('valor-preco-medio').textContent = formatarMoeda(precoMedio);
                document.getElementById('valor-preco-medio-grama').textContent = formatarMoeda(precoMedioPorGramaMl);
                document.getElementById('num-registros').textContent = todosPrecos.length;
                infoPrecoMedio.classList.remove('hidden');
            } else {
                infoPrecoMedio.classList.add('hidden');
            }
        }
        
        // Modificar o botão de submit
        const submitBtn = document.querySelector('#form-adicionar-material button[type="submit"]');
        if (submitBtn) {
            submitBtn.textContent = 'Atualizar Material';
            submitBtn.setAttribute('data-edicao', index);
        }
    } catch (error) {
        console.error("Erro ao editar material:", error);
    }
}

// Função para adicionar um material ao estoque - OTIMIZADA (CORRIGIDA)
function adicionarAoEstoque(materialId) {
    try {
        const material = materiais.find(m => m.id === materialId);
        if (!material) {
            console.error("Material não encontrado");
            return;
        }
        
        // Mudar para a aba de adicionar item
        const tabButton = document.querySelector('.tab-button[data-tab="adicionar-item"]');
        if (tabButton) {
            tabButton.click();
            
            // Limpar o formulário antes de preenchê-lo
            document.getElementById('form-adicionar-material').reset();
        }
        
        // Preencher o formulário com os dados do material
        document.getElementById('codigo-material').value = material.codigo || '';
        document.getElementById('nome-material').value = material.nome;
        document.getElementById('quantidade-material').value = 1;
        document.getElementById('unidade-material').value = material.unidade;
        document.getElementById('unidade-medida-material').value = material.unidadeMedida;
        document.getElementById('quantidade-medida-material').value = material.quantidadeMedida;
        document.getElementById('preco-material').value = material.ultimoPreco;
        
        // Mostrar informações de preço médio
        const infoPrecoMedio = document.getElementById('info-preco-medio');
        if (infoPrecoMedio) {
            // Calcular preço médio do material por unidade
            const precoMedio = obterPrecoMedioPorCodigo(material.codigo);
            
            // Calcular preço médio por g/ml
            const precoMedioPorGramaMl = obterPrecoMedioPorGramaMlPorCodigo(material.codigo);
            
            if (precoMedio > 0) {
                document.getElementById('valor-preco-medio').textContent = formatarMoeda(precoMedio);
                document.getElementById('valor-preco-medio-grama').textContent = formatarMoeda(precoMedioPorGramaMl);
                
                // Contar registros
                let numRegistros = 0;
                const materiaisComCodigo = materiais.filter(m => m.codigo === material.codigo);
                materiaisComCodigo.forEach(m => {
                    if (m.historicoPrecos) numRegistros += m.historicoPrecos.length;
                });
                
                document.getElementById('num-registros').textContent = numRegistros;
                infoPrecoMedio.classList.remove('hidden');
            } else {
                infoPrecoMedio.classList.add('hidden');
            }
        }
        
        // Data atual para compra
        const dataCompra = document.getElementById('data-compra-material');
        if (dataCompra) {
            const hoje = new Date();
            dataCompra.value = hoje.toISOString().split('T')[0];
        }
        
        console.log("Material carregado para adicionar ao estoque");
    } catch (error) {
        console.error("Erro ao adicionar ao estoque:", error);
    }
}

// Função para carregar o estoque na tabela - OTIMIZADA (CORRIGIDA)
function carregarEstoque() {
    try {
        const tbody = document.getElementById('itens-estoque');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (estoque.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="5" style="text-align: center;">Nenhum item no estoque.</td>';
            tbody.appendChild(tr);
            return;
        }
        
        // Unificar estoque antes de exibir
        const estoqueUnificado = unificarEstoque();
        
        if (estoqueUnificado.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="5" style="text-align: center;">Nenhum item no estoque após unificação.</td>';
            tbody.appendChild(tr);
            return;
        }
        
        estoqueUnificado.forEach((item) => {
            try {
                // Calcular a quantidade em unidade de medida (ex: ml restantes)
                const quantidadeTotalMedida = (parseFloat(item.quantidade) || 0) * (parseFloat(item.quantidadeMedida) || 1);
                // Verificar se é um número fracionário
                const quantidadeFracionada = (parseFloat(item.quantidade) || 0) % 1 !== 0;
                
                const tr = document.createElement('tr');
                tr.className = 'estoque-unificado';
                tr.innerHTML = `
                    <td>${item.codigo || 'N/A'}</td>
                    <td>${item.nome || 'Sem nome'}</td>
                    <td>${(parseFloat(item.quantidade) || 0).toFixed(2)} ${quantidadeFracionada ? `(${Math.floor(item.quantidade)} + ${((item.quantidade % 1) * 100).toFixed(0)}%)` : ''}</td>
                    <td>${item.unidade || 'N/A'}</td>
                    <td>${quantidadeTotalMedida.toFixed(0)} ${item.unidadeMedida || 'N/A'}</td>
                `;
                tbody.appendChild(tr);
            } catch (err) {
                console.error("Erro ao renderizar item do estoque:", err);
            }
        });
    } catch (error) {
        console.error("Erro ao carregar estoque:", error);
    }
}
//Parte 6: JavaScript - Funções de Cálculo para Receitas
// Função para calcular o custo de uma receita - OTIMIZADA para usar preço por g/ml
function calcularCustoReceita(receita) {
    try {
        if (!receita || !receita.ingredientes || receita.ingredientes.length === 0) return 0;
        
        let custoTotal = 0;
        
        for (const ingrediente of receita.ingredientes) {
            // Encontrar o material com base no materialId do ingrediente
            const material = materiais.find(m => m.id === ingrediente.materialId);
            if (!material) continue;
            
            // Obter o preço médio por g/ml para o material
            let precoMedioPorGramaMl = 0;
            
            if (material.codigo) {
                // Primeiro tenta pelo código
                precoMedioPorGramaMl = obterPrecoMedioPorGramaMlPorCodigo(material.codigo);
            }
            
            if (precoMedioPorGramaMl === 0 && material.nome) {
                // Se não encontrou pelo código ou preço é zero, tenta pelo nome
                precoMedioPorGramaMl = obterPrecoMedioPorGramaMlPorNome(material.nome);
            }
            
            // Se ainda não temos preço, calcular do material atual
            if (precoMedioPorGramaMl === 0 && material.ultimoPreco > 0 && material.quantidadeMedida > 0) {
                precoMedioPorGramaMl = material.ultimoPreco / material.quantidadeMedida;
            }
            
            // Calculamos o custo com base na quantidade em g/ml
            const quantidadeNormalizada = parseFloat(ingrediente.quantidade) || 0;
            custoTotal += precoMedioPorGramaMl * quantidadeNormalizada;
        }
        
        return custoTotal;
    } catch (error) {
        console.error("Erro ao calcular custo da receita:", error);
        return 0;
    }
}

// Função para adicionar campo de ingrediente - OTIMIZADA
function adicionarCampoIngrediente(ingredienteData = null) {
    try {
        const container = document.getElementById('lista-ingredientes');
        if (!container) return;
        
        // Verificar se existem materiais
        if (materiais.length === 0) {
            container.innerHTML = `
                <div class="notification notification-warning">
                    Nenhum material cadastrado. Adicione materiais antes de criar receitas.
                </div>
            `;
            return;
        }
        
        // Criar elemento div para o ingrediente
        const div = document.createElement('div');
        div.className = 'ingrediente-item';
        div.innerHTML = `
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label>Ingrediente:</label>
                        <select class="form-control ingrediente-select" required>
                            <option value="">Selecione um ingrediente...</option>
                            ${obterOpcoesIngredientes()}
                        </select>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label>Quantidade:</label>
                        <input type="number" class="form-control ingrediente-quantidade" min="0.01" step="0.01" required>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label>Unidade de Medida:</label>
                        <select class="form-control ingrediente-unidade-medida" required>
                            <option value="kg">Quilogramas (kg)</option>
                            <option value="g">Gramas (g)</option>
                            <option value="l">Litros (l)</option>
                            <option value="ml">Mililitros (ml)</option>
                        </select>
                    </div>
                </div>
                <div class="form-col" style="flex: 0.5;">
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" class="btn btn-danger remover-ingrediente" style="display: block;">X</button>
                    </div>
                </div>
            </div>
            <div class="ingrediente-preco-info">
                <span>Preço médio/g-ml: <span class="ingrediente-preco-medio">R$ 0,00</span></span>
                <span>Custo: <span class="ingrediente-custo">R$ 0,00</span></span>
            </div>
        `;
        container.appendChild(div);
        
        // Configurar o novo campo
        const select = div.querySelector('.ingrediente-select');
        const quantidadeInput = div.querySelector('.ingrediente-quantidade');
        const unidadeMedidaSelect = div.querySelector('.ingrediente-unidade-medida');
        const removerBtn = div.querySelector('.remover-ingrediente');
        const precoMedioSpan = div.querySelector('.ingrediente-preco-medio');
        const custoSpan = div.querySelector('.ingrediente-custo');
        
        // Preencher com dados se fornecidos
        if (ingredienteData) {
            select.value = ingredienteData.materialId;
            quantidadeInput.value = ingredienteData.quantidade;
            unidadeMedidaSelect.value = ingredienteData.unidadeMedida || 'g';
            
            // Atualizar preço médio e custo
            atualizarPrecoMedioIngrediente(select, quantidadeInput, unidadeMedidaSelect, precoMedioSpan, custoSpan);
        }
        
        // Adicionar eventos
        select.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.value) {
                const unidadeMedida = selectedOption.getAttribute('data-unidade-medida');
                if (unidadeMedida) {
                    unidadeMedidaSelect.value = unidadeMedida;
                }
                
                // Atualizar preço médio e custo
                atualizarPrecoMedioIngrediente(select, quantidadeInput, unidadeMedidaSelect, precoMedioSpan, custoSpan);
                
                // Atualizar cálculos da receita
                atualizarCalculosReceita();
            }
        });
        
        quantidadeInput.addEventListener('input', function() {
            // Atualizar preço médio e custo
            atualizarPrecoMedioIngrediente(select, quantidadeInput, unidadeMedidaSelect, precoMedioSpan, custoSpan);
            atualizarCalculosReceita();
        });
        
        unidadeMedidaSelect.addEventListener('change', function() {
            // Atualizar preço médio e custo
            atualizarPrecoMedioIngrediente(select, quantidadeInput, unidadeMedidaSelect, precoMedioSpan, custoSpan);
            atualizarCalculosReceita();
        });
        
        removerBtn.addEventListener('click', function() {
            container.removeChild(div);
            atualizarCalculosReceita();
        });
    } catch (error) {
        console.error("Erro ao adicionar campo de ingrediente:", error);
    }
}

// Função para atualizar o preço médio e custo do ingrediente - ATUALIZADA para g/ml
function atualizarPrecoMedioIngrediente(select, quantidadeInput, unidadeMedidaSelect, precoMedioSpan, custoSpan) {
    try {
        const materialId = select.value;
        if (!materialId) {
            precoMedioSpan.textContent = 'R$ 0,00';
            custoSpan.textContent = 'R$ 0,00';
            return;
        }
        
        const material = materiais.find(m => m.id === materialId);
        if (!material) {
            precoMedioSpan.textContent = 'R$ 0,00';
            custoSpan.textContent = 'R$ 0,00';
            return;
        }
        
        // Obter preço médio por g/ml
        let precoMedioPorGramaMl = 0;
        
        if (material.codigo) {
            precoMedioPorGramaMl = obterPrecoMedioPorGramaMlPorCodigo(material.codigo);
        }
        
        if (precoMedioPorGramaMl === 0) {
            // Tentar pelo nome
            precoMedioPorGramaMl = obterPrecoMedioPorGramaMlPorNome(material.nome);
        }
        
        // Se ainda não tem preço, calcular do material atual
        if (precoMedioPorGramaMl === 0 && material.ultimoPreco > 0 && material.quantidadeMedida > 0) {
            precoMedioPorGramaMl = material.ultimoPreco / material.quantidadeMedida;
        }
        
        // Calcular o custo baseado na quantidade e unidade
        const quantidade = parseFloat(quantidadeInput.value) || 0;
        const unidadeMedida = unidadeMedidaSelect.value;
        
        // Normalizar unidades para calcular o custo
        let quantidadeNormalizada = quantidade;
        
        // Converter KG para g, L para ml se necessário
        if (unidadeMedida.toLowerCase() === 'kg') {
            quantidadeNormalizada *= 1000; // kg para g
        } else if (unidadeMedida.toLowerCase() === 'l') {
            quantidadeNormalizada *= 1000; // l para ml
        }
        
        // Calcular o custo total baseado no preço por g/ml
        const custo = precoMedioPorGramaMl * quantidadeNormalizada;
        
        // Atualizar os textos
        precoMedioSpan.textContent = formatarMoeda(precoMedioPorGramaMl);
        custoSpan.textContent = formatarMoeda(custo);
    } catch (error) {
        console.error("Erro ao atualizar preço médio do ingrediente:", error);
        precoMedioSpan.textContent = 'R$ 0,00';
        custoSpan.textContent = 'R$ 0,00';
    }
}

// Função para obter opções de ingredientes - OTIMIZADA
function obterOpcoesIngredientes() {
    try {
        // Função para simplificar nome de materiais (remover acentos, minúsculas)
        const simplificarNome = (nome) => {
            if (!nome) return '';
            return nome.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        };
        
        // Agrupar materiais por nome simplificado
        const materiaisPorNome = {};
        
        // Primeiro adicionar todos os materiais (inclusive os que não estão no estoque)
        materiais.forEach(material => {
            if (!material || !material.nome) return;
            
            const nomeSimplificado = simplificarNome(material.nome);
            
            // Calcular preço médio por g/ml
            let precoMedioPorGramaMl = 0;
            if (material.codigo) {
                precoMedioPorGramaMl = obterPrecoMedioPorGramaMlPorCodigo(material.codigo);
            } else {
                precoMedioPorGramaMl = obterPrecoMedioPorGramaMlPorNome(material.nome);
            }
            
            // Se ainda não tem preço, calcular do material atual
            if (precoMedioPorGramaMl === 0 && material.ultimoPreco > 0 && material.quantidadeMedida > 0) {
                precoMedioPorGramaMl = material.ultimoPreco / material.quantidadeMedida;
            }
            
            // Verificar se está em estoque
            const emEstoque = estoque.some(item => {
                const materialItem = materiais.find(m => m.id === item.materialId);
                return materialItem && 
                       (materialItem.codigo === material.codigo || 
                        simplificarNome(materialItem.nome) === nomeSimplificado);
            });
            
            // Se ainda não foi adicionado ou este material está em estoque (priorizar os em estoque)
            if (!materiaisPorNome[nomeSimplificado] || emEstoque) {
                materiaisPorNome[nomeSimplificado] = {
                    id: material.id,
                    nome: material.nome,
                    unidade: material.unidade || '',
                    unidadeMedida: material.unidadeMedida || '',
                    quantidadeMedida: material.quantidadeMedida || 1,
                    preco: material.ultimoPreco || 0,
                    precoMedioPorGramaMl: precoMedioPorGramaMl,
                    existe_estoque: emEstoque
                };
            }
        });
        
        // Converter para array e ordenar por nome
        const materiaisUnicos = Object.values(materiaisPorNome).sort((a, b) => a.nome.localeCompare(b.nome));
        
        // Gerar as opções HTML
        return materiaisUnicos.map(material => {
            return `
                <option value="${material.id}" 
                    data-unidade="${material.unidade}" 
                    data-preco="${material.preco || 0}"
                    data-unidade-medida="${material.unidadeMedida || ''}"
                    data-quantidade-medida="${material.quantidadeMedida || 0}"
                    data-preco-medio-grama="${material.precoMedioPorGramaMl || 0}"
                    data-estoque="${material.existe_estoque ? '1' : '0'}">
                    ${material.nome} ${material.existe_estoque ? '(Em estoque)' : ''}
                </option>
            `;
        }).join('');
    } catch (error) {
        console.error("Erro ao obter opções de ingredientes:", error);
        return '<option value="">Erro ao carregar ingredientes</option>';
    }
}

// Função para atualizar os cálculos de preço da receita - OTIMIZADA para g/ml
function atualizarCalculosReceita() {
    try {
        let custoTotal = 0;
        
        // Coletar dados de ingredientes
        document.querySelectorAll('.ingrediente-item').forEach(item => {
            const select = item.querySelector('.ingrediente-select');
            if (select && select.value) {
                const materialId = select.value;
                const quantidade = parseFloat(item.querySelector('.ingrediente-quantidade').value) || 0;
                const unidadeMedida = item.querySelector('.ingrediente-unidade-medida').value;
                
                // Encontrar o material
                const material = materiais.find(m => m.id === materialId);
                if (!material) return;
                
                // Obter o preço médio por g/ml
                let precoMedioPorGramaMl = 0;
                
                if (material.codigo) {
                    precoMedioPorGramaMl = obterPrecoMedioPorGramaMlPorCodigo(material.codigo);
                } else {
                    precoMedioPorGramaMl = obterPrecoMedioPorGramaMlPorNome(material.nome);
                }
                
                // Se ainda não tem preço, calcular do material atual
                if (precoMedioPorGramaMl === 0 && material.ultimoPreco > 0 && material.quantidadeMedida > 0) {
                    precoMedioPorGramaMl = material.ultimoPreco / material.quantidadeMedida;
                }
                
                // Normalizar unidades para calcular o custo (tudo em g ou ml)
                let quantidadeNormalizada = quantidade;
                
                // Converter KG para g, L para ml se necessário
                if (unidadeMedida.toLowerCase() === 'kg') {
                    quantidadeNormalizada *= 1000; // kg para g
                } else if (unidadeMedida.toLowerCase() === 'l') {
                    quantidadeNormalizada *= 1000; // l para ml
                }
                
                // Calcular custo proporcional baseado no preço por g/ml
                custoTotal += precoMedioPorGramaMl * quantidadeNormalizada;
            }
        });
        
        // Atualizar elementos de preço
        const custoProducaoEl = document.getElementById('custo-producao');
        const custosVariadosEl = document.getElementById('custos-variados');
        const precoEstimadoEl = document.getElementById('preco-estimado');
        
        if (custoProducaoEl && custosVariadosEl && precoEstimadoEl) {
            // Custo de produção
            custoProducaoEl.textContent = formatarMoeda(custoTotal);
            
            // Custos variados (10%)
            const custosVariados = custoTotal * 0.1;
            custosVariadosEl.textContent = formatarMoeda(custosVariados);
            
            // Preço estimado (custo total + custos variados + 150% markup)
            const precoEstimado = (custoTotal + custosVariados) * 2.5;
            precoEstimadoEl.textContent = formatarMoeda(precoEstimado);
            
            // Se existe um campo de preço de venda, sugerir o valor estimado
            const precoVendaInput = document.getElementById('preco-venda');
            if (precoVendaInput && precoVendaInput.value === '') {
                precoVendaInput.value = precoEstimado.toFixed(2);
            }
        }
    } catch (error) {
        console.error("Erro ao atualizar cálculos da receita:", error);
    }
}

// Função para carregar detalhes da receita no modal de adicionar receita à venda - NOVA
function carregarDetalhesReceitaModal() {
    const receitaId = document.getElementById('selecionar-receita-modal').value;
    if (!receitaId) {
        document.getElementById('detalhes-receita-modal').classList.add('hidden');
        return;
    }
    
    const receita = receitas.find(r => r.id === receitaId);
    if (!receita) return;
    
    // Mostrar detalhes
    document.getElementById('detalhes-receita-modal').classList.remove('hidden');
    document.getElementById('nome-receita-selecionada-modal').textContent = receita.nome;
    
    // Calcular custo usando preço médio por g/ml
    const custoProducao = calcularCustoReceita(receita);
    const custosVariados = custoProducao * 0.1;
    
    // Atualizar valores
    document.getElementById('custo-producao-modal').textContent = formatarMoeda(custoProducao);
    document.getElementById('preco-venda-modal').textContent = formatarMoeda(receita.precoVenda || 0);
    
    // Verificar disponibilidade de estoque
    const qtyInput = document.getElementById('quantidade-receita-modal');
    const quantidade = parseInt(qtyInput.value) || 1;
    
    verificarDisponibilidadeEstoqueReceita(receita, quantidade);
}

// Função para verificar disponibilidade de estoque para uma receita - NOVA
function verificarDisponibilidadeEstoqueReceita(receita, quantidade) {
    if (!receita || !receita.ingredientes || !quantidade) return;
    
    const avisoEstoque = document.getElementById('aviso-estoque-modal');
    if (!avisoEstoque) return;
    
    // Verificar estoque
    const estoqueUnificado = unificarEstoque();
    let disponibilidadeOk = true;
    
    for (const ingrediente of receita.ingredientes) {
        const material = materiais.find(m => m.id === ingrediente.materialId);
        if (!material) continue;
        
        // Quantidade necessária
        const quantidadeNecessaria = ingrediente.quantidade * quantidade;
        
        // Encontrar o material no estoque
        let materialEstoque = null;
        
        // Procurar primeiro por código
        if (material.codigo) {
            materialEstoque = estoqueUnificado.find(item => {
                const itemMaterial = materiais.find(m => m.id === item.materialId);
                return itemMaterial && itemMaterial.codigo === material.codigo;
            });
        }
        
        // Se não encontrou por código, tenta por nome
        if (!materialEstoque) {
            materialEstoque = estoqueUnificado.find(item => 
                item.nome && item.nome.toLowerCase() === material.nome.toLowerCase());
        }
        
        if (!materialEstoque) {
            disponibilidadeOk = false;
            break;
        }
        
        // Verificar quantidade
        let quantidadeNormalizada = quantidadeNecessaria;
        
        // Converter KG para g, L para ml se necessário
        if (ingrediente.unidadeMedida.toLowerCase() === 'kg' && materialEstoque.unidadeMedida.toLowerCase() === 'g') {
            quantidadeNormalizada *= 1000;
        } else if (ingrediente.unidadeMedida.toLowerCase() === 'l' && materialEstoque.unidadeMedida.toLowerCase() === 'ml') {
            quantidadeNormalizada *= 1000;
        } else if (ingrediente.unidadeMedida.toLowerCase() === 'g' && materialEstoque.unidadeMedida.toLowerCase() === 'kg') {
            quantidadeNormalizada /= 1000;
        } else if (ingrediente.unidadeMedida.toLowerCase() === 'ml' && materialEstoque.unidadeMedida.toLowerCase() === 'l') {
            quantidadeNormalizada /= 1000;
        }
        
        // Converter para unidades do estoque
        const quantidadeEmUnidades = quantidadeNormalizada / (materialEstoque.quantidadeMedida || 1);
        
        if (materialEstoque.quantidade < quantidadeEmUnidades) {
            disponibilidadeOk = false;
            break;
        }
    }
    
    // Atualizar aviso
    if (disponibilidadeOk) {
        avisoEstoque.className = 'notification notification-success';
        avisoEstoque.textContent = 'Todos os ingredientes estão disponíveis em estoque.';
    } else {
        avisoEstoque.className = 'notification notification-error';
        avisoEstoque.textContent = 'Atenção: Alguns ingredientes não estão disponíveis em quantidade suficiente!';
    }
    
    avisoEstoque.classList.remove('hidden');
}

// Função para adicionar receita à venda - NOVA
function adicionarReceitaAVenda() {
    const receitaId = document.getElementById('selecionar-receita-modal').value;
    if (!receitaId) {
        return;
    }
    
    const receita = receitas.find(r => r.id === receitaId);
    if (!receita) return;
    
    const quantidade = parseInt(document.getElementById('quantidade-receita-modal').value) || 1;
    const calcularPreco = document.getElementById('calcular-preco-modal').checked;
    
    // Adicionar à lista de receitas na venda
    const receitasContainer = document.getElementById('receitas-venda-container');
    if (!receitasContainer) return;
    
    // Remover notificação inicial se existir
    const notificacao = receitasContainer.querySelector('.notification');
    if (notificacao) {
        receitasContainer.removeChild(notificacao);
    }
    
    // Verificar se a receita já foi adicionada
    const receitaExistente = receitasContainer.querySelector(`.receita-item[data-id="${receitaId}"]`);
    if (receitaExistente) {
        // Atualizar quantidade
        const qtySpan = receitaExistente.querySelector('.receita-quantidade');
        if (qtySpan) {
            qtySpan.textContent = parseInt(qtySpan.textContent) + quantidade;
        }
    } else {
        // Adicionar nova receita
        const receitaItem = document.createElement('div');
        receitaItem.className = 'receita-item';
        receitaItem.setAttribute('data-id', receitaId);
        
        receitaItem.innerHTML = `
            <div class="receita-info">
                <strong>${receita.nome}</strong> - 
                <span class="receita-quantidade">${quantidade}</span> unidade(s)
                <span style="margin-left: 10px; font-size: 0.9em;">
                    (${formatarMoeda(receita.precoVenda)}/un)
                </span>
            </div>
            <div class="receita-acoes">
                <label class="receita-toggle">
                    <input type="checkbox" class="receita-calcular-preco" ${calcularPreco ? 'checked' : ''}>
                    Calcular preço
                </label>
                <button type="button" class="btn btn-danger btn-remover-receita-venda">X</button>
            </div>
        `;
        
        receitasContainer.appendChild(receitaItem);
        
        // Adicionar evento para remover
        const btnRemover = receitaItem.querySelector('.btn-remover-receita-venda');
        if (btnRemover) {
            btnRemover.addEventListener('click', function() {
                receitasContainer.removeChild(receitaItem);
                atualizarResumoFinanceiroVendaMultipla();
                
                // Se não houver mais receitas, mostrar notificação
                if (receitasContainer.querySelectorAll('.receita-item').length === 0) {
                    receitasContainer.innerHTML = `
                        <div class="notification notification-info">
                            Adicione receitas para registrar a venda.
                        </div>
                    `;
                }
            });
        }
        
        // Adicionar evento para o checkbox
        const checkbox = receitaItem.querySelector('.receita-calcular-preco');
        if (checkbox) {
            checkbox.addEventListener('change', atualizarResumoFinanceiroVendaMultipla);
        }
    }
    
    // Fechar modal
    fecharModalAdicionarReceita();
    
    // Atualizar resumo financeiro
    atualizarResumoFinanceiroVendaMultipla();
}
//Parte 7: JavaScript - Funções de Gerenciamento de Receitas
// Função para editar receita - OTIMIZADA
function editarReceita(index) {
    try {
        const receita = receitas[index];
        if (!receita) return;
        
        // Mudar para a aba de adicionar receita
        const tabButton = document.querySelector('[data-tab="adicionar-receita"]');
        if (tabButton) {
            tabButton.click();
        }
        
        // Preencher o formulário
        document.getElementById('nome-receita').value = receita.nome;
        document.getElementById('descricao-receita').value = receita.descricao || '';
        
        // Limpar os ingredientes existentes
        document.getElementById('lista-ingredientes').innerHTML = '';
        
        // Adicionar cada ingrediente
        if (receita.ingredientes && receita.ingredientes.length) {
            receita.ingredientes.forEach(ingrediente => {
                adicionarCampoIngrediente(ingrediente);
            });
        }
        
        // Preencher preço de venda
        document.getElementById('preco-venda').value = parseFloat(receita.precoVenda).toFixed(2);
        
        // Atualizar cálculos
        atualizarCalculosReceita();
        
        // Modificar o botão de submit
        const submitBtn = document.querySelector('#form-adicionar-receita button[type="submit"]');
        if (submitBtn) {
            submitBtn.textContent = 'Atualizar Receita';
            submitBtn.setAttribute('data-edicao', index);
        }
    } catch (error) {
        console.error("Erro ao editar receita:", error);
    }
}

// Função para remover receita - CORRIGIDA
function removerReceita(index) {
    try {
        // Verificar se o índice é válido
        if (index < 0 || index >= receitas.length || !receitas[index]) {
            console.error("Índice de receita inválido:", index);
            return false;
        }
        
        // Armazenar ID da receita para verificação
        const receitaId = receitas[index].id;
        
        // Remover a receita pelo índice
        receitas.splice(index, 1);
        
        // Verificar se a remoção foi bem-sucedida
        if (receitas.findIndex(r => r.id === receitaId) !== -1) {
            console.error("Falha ao remover receita");
            return false;
        }
        
        // Atualizar localStorage e recarregar interface
        try {
            atualizarLocalStorage();
        } catch (storageError) {
            console.error("Erro ao salvar no localStorage:", storageError);
            // Continuar mesmo com erro no localStorage
        }
        
        carregarReceitas();
        console.log('Receita removida com sucesso!');
        return true;
    } catch (error) {
        console.error("Erro ao remover receita:", error);
        return false;
    }
}

// Função para carregar receitas - OTIMIZADA
function carregarReceitas() {
    try {
        const container = document.getElementById('lista-receitas');
        if (!container) return;
        
        container.innerHTML = '';
        
        // Carregar no select da página de vendas
        const selectVenda = document.getElementById('selecionar-receita-modal');
        if (selectVenda) {
            selectVenda.innerHTML = '<option value="">Selecione uma receita...</option>';
        }
        
        // Carregar no select do filtro de vendas
        const selectFiltroVendas = document.getElementById('filtro-receita');
        if (selectFiltroVendas) {
            selectFiltroVendas.innerHTML = '<option value="">Todas as receitas</option>';
        }
        
        if (!receitas || receitas.length === 0) {
            container.innerHTML = '<p>Nenhuma receita cadastrada.</p>';
            return;
        }
        
        receitas.forEach((receita, index) => {
            if (!receita) return;
            
            // Calcular o custo total da receita usando preço médio por g/ml
            const custoProducao = calcularCustoReceita(receita);
            const custosVariados = custoProducao * 0.1;
            const precoEstimado = (custoProducao + custosVariados) * 2.5;
            
            // Adicionar ao container de lista
            const card = document.createElement('div');
            card.className = 'recipe-card';
            card.innerHTML = `
                <h3>${receita.nome}</h3>
                <p>${receita.descricao || 'Sem descrição'}</p>
                
                <div class="recipe-pricing">
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Custo de Produção</div>
                        <div class="recipe-price-value">${formatarMoeda(custoProducao)}</div>
                        <div class="material-detalhes">(preço médio por g/ml)</div>
                    </div>
                    
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Custos Variados</div>
                        <div class="recipe-price-value">${formatarMoeda(custosVariados)}</div>
                    </div>
                    
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Preço Estimado</div>
                        <div class="recipe-price-value">${formatarMoeda(precoEstimado)}</div>
                    </div>
                    
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Preço de Venda</div>
                        <div class="recipe-price-value highlight">${formatarMoeda(receita.precoVenda || 0)}</div>
                    </div>
                </div>
                
                <div class="recipe-ingredients" style="margin-top: 15px;">
                    <h4>Ingredientes:</h4>
                    <ul>
                        ${receita.ingredientes && receita.ingredientes.map(ing => {
                            const material = materiais.find(m => m.id === ing.materialId);
                            return material ? 
                                `<li>${ing.quantidade} ${ing.unidadeMedida} de ${material.nome}</li>` : 
                                '';
                        }).join('')}
                    </ul>
                </div>
                
                <div style="margin-top: 15px;">
                    <button class="btn btn-primary btn-editar-receita" data-index="${index}">Editar</button>
                    <button class="btn btn-danger btn-remover-receita" data-index="${index}">Remover</button>
                    <button class="btn btn-success btn-produzir-receita" data-index="${index}">Produzir</button>
                </div>
            `;
            container.appendChild(card);
            
            // Adicionar ao select de vendas
            if (selectVenda && receita.id) {
                const option = document.createElement('option');
                option.value = receita.id;
                option.textContent = receita.nome;
                selectVenda.appendChild(option);
            }
            
            // Adicionar ao select de filtro de vendas
            if (selectFiltroVendas && receita.id) {
                const optionFiltro = document.createElement('option');
                optionFiltro.value = receita.id;
                optionFiltro.textContent = receita.nome;
                selectFiltroVendas.appendChild(optionFiltro);
            }
        });
        
        // Configurar eventos para os botões usando delegação
        const listaReceitas = document.getElementById('lista-receitas');
        if (listaReceitas) {
            // Remover eventos anteriores
            if (listaReceitas._delegationHandlers) {
                for (const eventType in listaReceitas._delegationHandlers) {
                    listaReceitas.removeEventListener(eventType, listaReceitas._delegationHandlers[eventType]);
                }
            }
            
            // Adicionar novos eventos
            EventManager.delegateEvent(listaReceitas, '.btn-editar-receita', 'click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                if (!isNaN(index)) {
                    editarReceita(index);
                }
            });
            
            EventManager.delegateEvent(listaReceitas, '.btn-remover-receita', 'click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                if (!isNaN(index)) {
                    if (confirm("Tem certeza que deseja remover esta receita?")) {
                        removerReceita(index);
                    }
                }
            });
            
            EventManager.delegateEvent(listaReceitas, '.btn-produzir-receita', 'click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                if (!isNaN(index)) {
                    produzirReceita(index);
                }
            });
        }
        
        // Chamar a função de correção para garantir que os botões funcionem
        setTimeout(corrigirBotoesReceita, 100);
    } catch (error) {
        console.error("Erro ao carregar receitas:", error);
    }
}

// Função para produzir receita - ATUALIZADA para o novo sistema de vendas
function produzirReceita(index) {
    try {
        const receita = receitas[index];
        if (!receita) return;
        
        // Navegar para a página de vendas
        const navLink = document.querySelector('[data-page="vendas"]');
        if (navLink) {
            navLink.click();
        }
        
        setTimeout(() => {
            const tabButton = document.querySelector('[data-tab="registrar-venda"]');
            if (tabButton) {
                tabButton.click();
            }
            
            // Adicionar a receita à venda usando o novo sistema
            const receitasContainer = document.getElementById('receitas-venda-container');
            if (receitasContainer) {
                // Remover notificação inicial
                const notificacao = receitasContainer.querySelector('.notification');
                if (notificacao) {
                    receitasContainer.removeChild(notificacao);
                }
                
                // Adicionar receita
                const receitaItem = document.createElement('div');
                receitaItem.className = 'receita-item';
                receitaItem.setAttribute('data-id', receita.id);
                
                receitaItem.innerHTML = `
                    <div class="receita-info">
                        <strong>${receita.nome}</strong> - 
                        <span class="receita-quantidade">1</span> unidade(s)
                        <span style="margin-left: 10px; font-size: 0.9em;">
                            (${formatarMoeda(receita.precoVenda)}/un)
                        </span>
                    </div>
                    <div class="receita-acoes">
                        <label class="receita-toggle">
                            <input type="checkbox" class="receita-calcular-preco" checked>
                            Calcular preço
                        </label>
                        <button type="button" class="btn btn-danger btn-remover-receita-venda">X</button>
                    </div>
                `;
                
                receitasContainer.appendChild(receitaItem);
                
                // Adicionar evento para remover
                const btnRemover = receitaItem.querySelector('.btn-remover-receita-venda');
                if (btnRemover) {
                    btnRemover.addEventListener('click', function() {
                        receitasContainer.removeChild(receitaItem);
                        atualizarResumoFinanceiroVendaMultipla();
                        
                        // Se não houver mais receitas, mostrar notificação
                        if (receitasContainer.querySelectorAll('.receita-item').length === 0) {
                            receitasContainer.innerHTML = `
                                <div class="notification notification-info">
                                    Adicione receitas para registrar a venda.
                                </div>
                            `;
                        }
                    });
                }
                
                // Adicionar evento para o checkbox
                const checkbox = receitaItem.querySelector('.receita-calcular-preco');
                if (checkbox) {
                    checkbox.addEventListener('change', atualizarResumoFinanceiroVendaMultipla);
                }
                
                // Atualizar resumo financeiro
                atualizarResumoFinanceiroVendaMultipla();
            }
        }, 100);
    } catch (error) {
        console.error("Erro ao produzir receita:", error);
    }
}

// Função para adicionar função de configuração para botão de adicionar ingrediente
function setupReceitaEvents() {
    try {
        // Evento para adicionar ingrediente
        const btnAdicionarIngrediente = document.getElementById('adicionar-ingrediente');
        if (btnAdicionarIngrediente) {
            btnAdicionarIngrediente.removeEventListener('click', handleAdicionarIngrediente);
            btnAdicionarIngrediente.addEventListener('click', handleAdicionarIngrediente);
        }
        
        // Configurar o formulário de adicionar receita
        setupFormAddReceitaEvent();
    } catch (error) {
        console.error("Erro ao configurar eventos de receita:", error);
    }
}

// Handler para adicionar ingrediente
function handleAdicionarIngrediente() {
    adicionarCampoIngrediente();
}

// Função para configurar o formulário de adicionar receita separadamente
function setupFormAddReceitaEvent() {
    try {
        const formAdicionarReceita = document.getElementById('form-adicionar-receita');
        if (!formAdicionarReceita) return;
        
        // Remover evento anterior para evitar duplicação
        formAdicionarReceita.removeEventListener('submit', handleFormAddReceita);
        // Adicionar novo evento
        formAdicionarReceita.addEventListener('submit', handleFormAddReceita);
    } catch (error) {
        console.error("Erro ao configurar formulário de receita:", error);
    }
}

// Função handler para o formulário de adicionar receita
function handleFormAddReceita(e) {
    e.preventDefault();
    
    try {
        const nome = document.getElementById('nome-receita').value;
        const descricao = document.getElementById('descricao-receita').value;
        const precoVenda = parseFloat(document.getElementById('preco-venda').value);
        
        if (!nome || isNaN(precoVenda) || precoVenda <= 0) {
            console.error('Preencha o nome e o preço de venda corretamente.');
            return;
        }
        
        // Coletar ingredientes
        const ingredientes = [];
        let ingredientesValidos = true;
        
        document.querySelectorAll('.ingrediente-item').forEach(item => {
            const select = item.querySelector('.ingrediente-select');
            if (!select || !select.value) {
                ingredientesValidos = false;
                return;
            }
            
            const materialId = select.value;
            const quantidade = parseFloat(item.querySelector('.ingrediente-quantidade').value);
            const unidadeMedida = item.querySelector('.ingrediente-unidade-medida').value;
            
            if (!materialId || isNaN(quantidade) || quantidade <= 0) {
                ingredientesValidos = false;
                return;
            }
            
            ingredientes.push({
                materialId: materialId,
                quantidade: quantidade,
                unidadeMedida: unidadeMedida
            });
        });
        
        if (!ingredientesValidos || ingredientes.length === 0) {
            console.error('Adicione pelo menos um ingrediente com quantidade válida.');
            return;
        }
        
        // Verificar se é edição ou nova receita
        const submitBtn = document.querySelector('#form-adicionar-receita button[type="submit"]');
        const indexEdicao = submitBtn.getAttribute('data-edicao');
        
        if (indexEdicao !== null && indexEdicao !== undefined) {
            // Edição de receita existente
            const receitaIndex = parseInt(indexEdicao);
            if (!isNaN(receitaIndex) && receitas[receitaIndex]) {
                receitas[receitaIndex].nome = nome;
                receitas[receitaIndex].descricao = descricao;
                receitas[receitaIndex].ingredientes = ingredientes;
                receitas[receitaIndex].precoVenda = precoVenda;
                
                // Resetar o botão
                submitBtn.textContent = 'Salvar Receita';
                submitBtn.removeAttribute('data-edicao');
                
                console.log('Receita atualizada com sucesso!');
            }
        } else {
            // Nova receita
            const novaReceita = {
                id: gerarId(),
                nome: nome,
                descricao: descricao,
                ingredientes: ingredientes,
                precoVenda: precoVenda,
                dataCriacao: new Date().toISOString()
            };
            
            receitas.push(novaReceita);
            console.log('Receita adicionada com sucesso!');
        }
        
        // Limpar o formulário
        this.reset();
        document.getElementById('lista-ingredientes').innerHTML = '';
        
        // Atualizar o localStorage e a interface
        atualizarLocalStorage();
        carregarReceitas();
        
        // Mudar para a aba de listar receitas
        const tabButton = document.querySelector('[data-tab="listar-receitas"]');
        if (tabButton) {
            tabButton.click();
        }
    } catch (error) {
        console.error("Erro ao processar formulário de receita:", error);
    }
}

// Função para corrigir os botões da receita
function corrigirBotoesReceita() {
    console.log("Corrigindo eventos dos botões de receitas");
    
    // Obter o container que contém todas as receitas
    const listaReceitas = document.getElementById('lista-receitas');
    if (!listaReceitas) {
        console.error("Elemento lista-receitas não encontrado");
        return;
    }
    
    // Remover eventos antigos que possam estar causando conflitos
    if (listaReceitas._delegationHandlers) {
        for (const eventType in listaReceitas._delegationHandlers) {
            listaReceitas.removeEventListener(eventType, listaReceitas._delegationHandlers[eventType]);
        }
        listaReceitas._delegationHandlers = {};
    }
    
    // Adicionar eventos diretamente aos botões existentes
    const botoesEditar = listaReceitas.querySelectorAll('.btn-editar-receita');
    const botoesRemover = listaReceitas.querySelectorAll('.btn-remover-receita');
    const botoesProduzir = listaReceitas.querySelectorAll('.btn-produzir-receita');
    
    console.log(`Encontrados ${botoesEditar.length} botões de edição, ${botoesRemover.length} de remoção e ${botoesProduzir.length} de produção`);
    
    // Adicionar eventos diretamente
    botoesEditar.forEach(botao => {
        botao.addEventListener('click', function(e) {
            e.preventDefault();
            const index = parseInt(this.getAttribute('data-index'));
            console.log("Clique no botão editar detectado, index:", index);
            if (!isNaN(index)) {
                editarReceita(index);
            }
        });
    });
    
    botoesRemover.forEach(botao => {
        botao.addEventListener('click', function(e) {
            e.preventDefault();
            const index = parseInt(this.getAttribute('data-index'));
            console.log("Clique no botão remover detectado, index:", index);
            if (!isNaN(index)) {
                if (confirm("Tem certeza que deseja remover esta receita?")) {
                    removerReceita(index);
                }
            }
        });
    });
    
    botoesProduzir.forEach(botao => {
        botao.addEventListener('click', function(e) {
            e.preventDefault();
            const index = parseInt(this.getAttribute('data-index'));
            console.log("Clique no botão produzir detectado, index:", index);
            if (!isNaN(index)) {
                produzirReceita(index);
            }
        });
    });
}

// Atualizar carregarReceitas para sempre chamar corrigirBotoesReceita
if (typeof carregarReceitasOriginal === 'undefined') {
    const carregarReceitasOriginal = carregarReceitas;
    carregarReceitas = function() {
        carregarReceitasOriginal.apply(this, arguments);
        setTimeout(corrigirBotoesReceita, 100);
    };
}
//Parte 8: JavaScript - Funções para Vendas
// Função para confirmar venda com múltiplas receitas - NOVA
function confirmarVendaMultiplasReceitas() {
    try {
        // Verificar se há receitas adicionadas
        const receitasContainer = document.getElementById('receitas-venda-container');
        const receitasItems = receitasContainer.querySelectorAll('.receita-item');
        
        if (receitasItems.length === 0) {
            console.error("Adicione pelo menos uma receita para registrar a venda");
            return;
        }
        
        // Coletar dados do cliente
        const clienteNome = document.getElementById('cliente-nome').value;
        if (!clienteNome) {
            console.error("O nome do cliente é obrigatório");
            return;
        }
        
        const clienteTelefone = document.getElementById('cliente-telefone').value;
        const clienteEndereco = document.getElementById('cliente-endereco').value;
        const observacoes = document.getElementById('observacoes-venda').value;
        const dataVenda = document.getElementById('data-venda').value || new Date().toISOString().split('T')[0];
        
        // Coletar custos adicionais
        const custoFrete = parseFloat(document.getElementById('custo-frete').value) || 0;
        const custoDecoracao = parseFloat(document.getElementById('custo-decoracao').value) || 0;
        const despesasAdicionais = parseFloat(document.getElementById('despesas-adicionais').value) || 0;
        
        // Mostrar modal de processamento
        toggleModal(true, "Registrando venda...", "Processando itens e atualizando estoque.");
        
        // Estrutura da venda com múltiplas receitas
        const novaVenda = {
            id: gerarId(),
            receitas: [],
            cliente: {
                nome: clienteNome,
                telefone: clienteTelefone,
                endereco: clienteEndereco
            },
            custoFrete: custoFrete,
            custoDecoracao: custoDecoracao,
            despesasAdicionaisOriginal: despesasAdicionais,
            observacoes: observacoes,
            data: dataVenda,
            dataCriacao: new Date().toISOString()
        };
        
        // Variáveis para cálculos totais
        let custoProducaoTotal = 0;
        let custosVariadosTotal = 0;
        let valorVendaTotal = 0;
        
        // Verificar disponibilidade de ingredientes
        const estoqueUnificado = unificarEstoque();
        let ingredientesDisponiveis = true;
        
        // Mapear todos os ingredientes necessários para as receitas
        const ingredientesNecessarios = [];
        
        // Primeiro passo: verificar disponibilidade de todos os ingredientes
        for (const receitaItem of receitasItems) {
            const receitaId = receitaItem.getAttribute('data-id');
            const quantidade = parseInt(receitaItem.querySelector('.receita-quantidade').textContent) || 1;
            const calcularPreco = receitaItem.querySelector('.receita-calcular-preco').checked;
            
            const receita = receitas.find(r => r.id === receitaId);
            if (!receita) continue;
            
            if (receita.ingredientes) {
                for (const ingrediente of receita.ingredientes) {
                    const material = materiais.find(m => m.id === ingrediente.materialId);
                    if (!material) continue;
                    
                    // Adicionar à lista de ingredientes necessários
                    ingredientesNecessarios.push({
                        materialId: ingrediente.materialId,
                        material: material,
                        quantidade: ingrediente.quantidade * quantidade,
                        unidadeMedida: ingrediente.unidadeMedida
                    });
                }
            }
        }
        
        // Verificar disponibilidade dos ingredientes
        for (const ingrediente of ingredientesNecessarios) {
            const material = ingrediente.material;
            
            // Encontrar o material no estoque
            let materialEstoque = null;
            
            // Procurar primeiro por código
            if (material.codigo) {
                materialEstoque = estoqueUnificado.find(item => {
                    const itemMaterial = materiais.find(m => m.id === item.materialId);
                    return itemMaterial && itemMaterial.codigo === material.codigo;
                });
            }
            
            // Se não encontrou por código, tenta por nome
            if (!materialEstoque) {
                materialEstoque = estoqueUnificado.find(item => 
                    item.nome && item.nome.toLowerCase() === material.nome.toLowerCase());
            }
            
            if (!materialEstoque) {
                ingredientesDisponiveis = false;
                break;
            }
            
            // Verificar quantidade
            let quantidadeNormalizada = ingrediente.quantidade;
            
            // Converter KG para g, L para ml se necessário
            if (ingrediente.unidadeMedida.toLowerCase() === 'kg' && materialEstoque.unidadeMedida.toLowerCase() === 'g') {
                quantidadeNormalizada *= 1000;
            } else if (ingrediente.unidadeMedida.toLowerCase() === 'l' && materialEstoque.unidadeMedida.toLowerCase() === 'ml') {
                quantidadeNormalizada *= 1000;
            } else if (ingrediente.unidadeMedida.toLowerCase() === 'g' && materialEstoque.unidadeMedida.toLowerCase() === 'kg') {
                quantidadeNormalizada /= 1000;
            } else if (ingrediente.unidadeMedida.toLowerCase() === 'ml' && materialEstoque.unidadeMedida.toLowerCase() === 'l') {
                quantidadeNormalizada /= 1000;
            }
            
            // Converter para unidades do estoque
            const quantidadeEmUnidades = quantidadeNormalizada / (materialEstoque.quantidadeMedida || 1);
            
            if (materialEstoque.quantidade < quantidadeEmUnidades) {
                ingredientesDisponiveis = false;
                break;
            }
        }
        
        if (!ingredientesDisponiveis) {
            toggleModal(false);
            console.error("Estoque insuficiente para alguns ingredientes");
            return;
        }
        
        // Segundo passo: remover ingredientes do estoque
        for (const ingrediente of ingredientesNecessarios) {
            removerItemEstoque(
                ingrediente.materialId,
                ingrediente.quantidade,
                ingrediente.unidadeMedida
            );
        }
        
        // Terceiro passo: adicionar receitas à venda
        for (const receitaItem of receitasItems) {
            const receitaId = receitaItem.getAttribute('data-id');
            const quantidade = parseInt(receitaItem.querySelector('.receita-quantidade').textContent) || 1;
            const calcularPreco = receitaItem.querySelector('.receita-calcular-preco').checked;
            
            const receita = receitas.find(r => r.id === receitaId);
            if (!receita) continue;
            
            // Calcular custo de produção com base no preço médio por g/ml
            const custoProducao = calcularCustoReceita(receita);
            const custosVariados = custoProducao * 0.1;
            
            // Adicionar aos totais apenas se for para calcular o preço
            if (calcularPreco) {
                custoProducaoTotal += custoProducao * quantidade;
                custosVariadosTotal += custosVariados * quantidade;
                valorVendaTotal += receita.precoVenda * quantidade;
            }
            
            // Adicionar receita à venda
            novaVenda.receitas.push({
                id: receitaId,
                nome: receita.nome,
                quantidade: quantidade,
                precoVenda: receita.precoVenda,
                calcularPreco: calcularPreco,
                custoProducao: custoProducao,
                custosVariados: custosVariados
            });
        }
        
        // Cálculos finais
        const despesa = custoProducaoTotal + custosVariadosTotal;
        const valorReinvestir = despesa;
        const despesasAdicionaisComAcrescimo = despesasAdicionais * 1.1;
        const totalDespesasAdicionais = despesasAdicionaisComAcrescimo + custoFrete + custoDecoracao;
        
        // Valor total da venda
        const valorTotal = valorVendaTotal + custoFrete + custoDecoracao;
        
        // Lucro
        const lucro = valorTotal - despesa - valorReinvestir - totalDespesasAdicionais;
        
        // Adicionar cálculos à venda
        novaVenda.custoProducaoTotal = custoProducaoTotal;
        novaVenda.custosVariadosTotal = custosVariadosTotal;
        novaVenda.despesa = despesa;
        novaVenda.valorReinvestir = valorReinvestir;
        novaVenda.despesasAdicionaisComAcrescimo = despesasAdicionaisComAcrescimo;
        novaVenda.totalDespesasAdicionais = totalDespesasAdicionais;
        novaVenda.valorTotal = valorTotal;
        novaVenda.lucro = lucro;
        
        // Adicionar venda à lista
        vendas.push(novaVenda);
        
        // Atualizar localStorage
        atualizarLocalStorage();
        
        // Fechar modal de processamento
        toggleModal(false);
        
        // Redirecionar para a aba de listar vendas
        const tabButton = document.querySelector('[data-tab="listar-vendas"]');
        if (tabButton) {
            tabButton.click();
        }
        
        console.log("Venda registrada com sucesso!");
        return true;
    } catch (error) {
        toggleModal(false);
        console.error("Erro ao registrar venda:", error);
        return false;
    }
}

// Função para editar uma venda - ATUALIZADA para múltiplas receitas
function editarVenda(vendaId, dadosAtualizados) {
    try {
        const venda = vendas.find(v => v.id === vendaId);
        if (!venda) {
            console.error("Venda não encontrada");
            return false;
        }
        
        // Salvar os dados originais para restaurar o estoque
        const vendaOriginal = JSON.parse(JSON.stringify(venda));
        
        // Extrair dados atualizados
        const {
            clienteNome,
            clienteTelefone,
            clienteEndereco,
            observacoes,
            dataVenda,
            custoFrete,
            custoDecoracao,
            despesasAdicionais,
            valorTotal,
            receitas = []
        } = dadosAtualizados;
        
        // Verificar se as receitas mudaram para atualizar o estoque
        const receitasModificadas = !compararReceitas(venda.receitas, receitas);
        
        if (receitasModificadas) {
            // Primeiro devolvemos os itens ao estoque
            for (const receitaVenda of vendaOriginal.receitas) {
                const receita = receitas.find(r => r.id === receitaVenda.id);
                if (!receita || !receita.calcularPreco) continue;
                
                // Buscar a receita original
                const receitaOriginal = receitas.find(r => r.id === receitaVenda.id);
                if (!receitaOriginal || !receitaOriginal.ingredientes) continue;
                
                // Devolver ao estoque a quantidade original
                receitaOriginal.ingredientes.forEach(ingrediente => {
                    adicionarEstoqueDeVolta(
                        ingrediente.materialId, 
                        ingrediente.quantidade * receitaVenda.quantidade, 
                        ingrediente.unidadeMedida
                    );
                });
            }
            
            // Agora verificamos disponibilidade das novas receitas
            // usando estoque unificado
            const estoqueUnificado = unificarEstoque();
            let todosProdutosDisponiveis = true;
            
            // Mapear todos os ingredientes necessários para as receitas
            const ingredientesNecessarios = [];
            
            for (const receitaVenda of receitas) {
                if (!receitaVenda.calcularPreco) continue;
                
                const receita = receitas.find(r => r.id === receitaVenda.id);
                if (!receita || !receita.ingredientes) continue;
                
                for (const ingrediente of receita.ingredientes) {
                    const material = materiais.find(m => m.id === ingrediente.materialId);
                    if (!material) continue;
                    
                    // Adicionar à lista de ingredientes necessários
                    ingredientesNecessarios.push({
                        materialId: ingrediente.materialId,
                        material: material,
                        quantidade: ingrediente.quantidade * receitaVenda.quantidade,
                        unidadeMedida: ingrediente.unidadeMedida
                    });
                }
            }
            
            // Verificar disponibilidade dos ingredientes
            for (const ingrediente of ingredientesNecessarios) {
                const material = ingrediente.material;
                
                // Encontrar o material no estoque
                let materialEstoque = null;
                
                // Procurar primeiro por código
                if (material.codigo) {
                    materialEstoque = estoqueUnificado.find(item => {
                        const itemMaterial = materiais.find(m => m.id === item.materialId);
                        return itemMaterial && itemMaterial.codigo === material.codigo;
                    });
                }
                
                // Se não encontrou por código, tenta por nome
                if (!materialEstoque) {
                    materialEstoque = estoqueUnificado.find(item => 
                        item.nome && item.nome.toLowerCase() === material.nome.toLowerCase());
                }
                
                if (!materialEstoque) {
                    todosProdutosDisponiveis = false;
                    break;
                }
                
                // Verificar quantidade
                let quantidadeNormalizada = ingrediente.quantidade;
                
                // Converter KG para g, L para ml se necessário
                if (ingrediente.unidadeMedida.toLowerCase() === 'kg' && materialEstoque.unidadeMedida.toLowerCase() === 'g') {
                    quantidadeNormalizada *= 1000;
                } else if (ingrediente.unidadeMedida.toLowerCase() === 'l' && materialEstoque.unidadeMedida.toLowerCase() === 'ml') {
                    quantidadeNormalizada *= 1000;
                } else if (ingrediente.unidadeMedida.toLowerCase() === 'g' && materialEstoque.unidadeMedida.toLowerCase() === 'kg') {
                    quantidadeNormalizada /= 1000;
                } else if (ingrediente.unidadeMedida.toLowerCase() === 'ml' && materialEstoque.unidadeMedida.toLowerCase() === 'l') {
                    quantidadeNormalizada /= 1000;
                }
                
                // Converter para unidades do estoque
                const quantidadeEmUnidades = quantidadeNormalizada / (materialEstoque.quantidadeMedida || 1);
                
                if (materialEstoque.quantidade < quantidadeEmUnidades) {
                    todosProdutosDisponiveis = false;
                    break;
                }
            }
            
            if (!todosProdutosDisponiveis) {
                // Se não há produtos suficientes, restaurar estoque original e abortar
                for (const receitaVenda of vendaOriginal.receitas) {
                    const receita = receitas.find(r => r.id === receitaVenda.id);
                    if (!receita || !receita.calcularPreco) continue;
                    
                    const receitaOriginal = receitas.find(r => r.id === receitaVenda.id);
                    if (!receitaOriginal || !receitaOriginal.ingredientes) continue;
                    
                    // Remover do estoque novamente
                    receitaOriginal.ingredientes.forEach(ingrediente => {
                        removerItemEstoque(
                            ingrediente.materialId, 
                            ingrediente.quantidade * receitaVenda.quantidade, 
                            ingrediente.unidadeMedida
                        );
                    });
                }
                
                console.error("Estoque insuficiente para os novos ingredientes");
                return false;
            }
            
            // Remover ingredientes do estoque para as novas receitas
            for (const ingrediente of ingredientesNecessarios) {
                removerItemEstoque(
                    ingrediente.materialId,
                    ingrediente.quantidade,
                    ingrediente.unidadeMedida
                );
            }
        }
        
        // Variáveis para cálculos totais
        let custoProducaoTotal = 0;
        let custosVariadosTotal = 0;
        let valorVendaTotal = 0;
        
        // Atualizar receitas e cálculos
        venda.receitas = receitas.map(receitaVenda => {
            const receita = receitas.find(r => r.id === receitaVenda.id);
            if (!receita) return receitaVenda;
            
            // Calcular custo de produção com base no preço médio por g/ml
            const custoProducao = calcularCustoReceita(receita);
            const custosVariados = custoProducao * 0.1;
            
            // Adicionar aos totais apenas se for para calcular o preço
            if (receitaVenda.calcularPreco) {
                custoProducaoTotal += custoProducao * receitaVenda.quantidade;
                custosVariadosTotal += custosVariados * receitaVenda.quantidade;
                valorVendaTotal += receita.precoVenda * receitaVenda.quantidade;
            }
            
            return {
                id: receitaVenda.id,
                nome: receita.nome,
                quantidade: receitaVenda.quantidade,
                precoVenda: receita.precoVenda,
                calcularPreco: receitaVenda.calcularPreco,
                custoProducao: custoProducao,
                custosVariados: custosVariados
            };
        });
        
        // Atualizar os dados da venda
        venda.cliente.nome = clienteNome;
        venda.cliente.telefone = clienteTelefone;
        venda.cliente.endereco = clienteEndereco;
        venda.custoFrete = custoFrete;
        venda.custoDecoracao = custoDecoracao;
        venda.despesasAdicionaisOriginal = despesasAdicionais;
        venda.observacoes = observacoes;
        
        if (dataVenda) {
            venda.data = new Date(dataVenda).toISOString();
        }
        
        // Cálculos finais
        const despesa = custoProducaoTotal + custosVariadosTotal;
        const valorReinvestir = despesa;
        const despesasAdicionaisComAcrescimo = despesasAdicionais * 1.1;
        const totalDespesasAdicionais = despesasAdicionaisComAcrescimo + custoFrete + custoDecoracao;
        
        // Atualizar valor total e cálculos
        venda.custoProducaoTotal = custoProducaoTotal;
        venda.custosVariadosTotal = custosVariadosTotal;
        venda.despesa = despesa;
        venda.valorReinvestir = valorReinvestir;
        venda.despesasAdicionaisComAcrescimo = despesasAdicionaisComAcrescimo;
        venda.totalDespesasAdicionais = totalDespesasAdicionais;
        venda.valorTotal = valorTotal || (valorVendaTotal + custoFrete + custoDecoracao);
        
        // Recalcular lucro
        venda.lucro = venda.valorTotal - despesa - valorReinvestir - totalDespesasAdicionais;
        
        atualizarLocalStorage();
        console.log("Venda atualizada com sucesso!");
        return true;
    } catch (error) {
        console.error("Erro ao editar venda:", error);
        return false;
    }
}

// Função auxiliar para comparar receitas
function compararReceitas(receitasA, receitasB) {
    if (receitasA.length !== receitasB.length) return false;
    
    for (let i = 0; i < receitasA.length; i++) {
        const a = receitasA[i];
        const b = receitasB[i];
        
        if (a.id !== b.id || 
            a.quantidade !== b.quantidade || 
            a.calcularPreco !== b.calcularPreco) {
            return false;
        }
    }
    
    return true;
}

// Função para excluir uma venda - ATUALIZADA para múltiplas receitas
function excluirVenda(vendaId) {
    try {
        const index = vendas.findIndex(v => v.id === vendaId);
        if (index === -1) {
            console.error("Venda não encontrada");
            return false;
        }
        
        const venda = vendas[index];
        
        // Devolver itens ao estoque
        for (const receitaVenda of venda.receitas) {
            if (!receitaVenda.calcularPreco) continue;
            
            const receita = receitas.find(r => r.id === receitaVenda.id);
            if (!receita || !receita.ingredientes) continue;
            
            receita.ingredientes.forEach(ingrediente => {
                adicionarEstoqueDeVolta(
                    ingrediente.materialId, 
                    ingrediente.quantidade * receitaVenda.quantidade, 
                    ingrediente.unidadeMedida
                );
            });
        }
        
        // Remover a venda
        vendas.splice(index, 1);
        atualizarLocalStorage();
        
        console.log("Venda excluída com sucesso!");
        return true;
    } catch (error) {
        console.error("Erro ao excluir venda:", error);
        return false;
    }
}

// Função para mostrar detalhes de uma venda - ATUALIZADA para múltiplas receitas
function mostrarDetalhesVenda(vendaId) {
    try {
        const venda = vendas.find(v => v.id === vendaId);
        if (!venda) return;
        
        const modal = document.getElementById('venda-details-modal');
        const content = document.getElementById('venda-details-content');
        
        if (!modal || !content) return;
        
        // Calcular totais
        const despesa = venda.despesa || venda.custoProducaoTotal + venda.custosVariadosTotal;
        const valorReinvestir = despesa;
        const despesasAdicionaisComAcrescimo = venda.despesasAdicionaisComAcrescimo || venda.despesasAdicionaisOriginal * 1.1;
        const totalDespesasAdicionais = venda.totalDespesasAdicionais || (despesasAdicionaisComAcrescimo + venda.custoFrete + venda.custoDecoracao);
        const lucro = venda.lucro || (venda.valorTotal - despesa - valorReinvestir - totalDespesasAdicionais);
        
        let receitasHTML = '';
        
        // Gerar HTML para cada receita
        if (venda.receitas && venda.receitas.length > 0) {
            receitasHTML = `
                <h4>Receitas:</h4>
                <ul style="list-style: none; padding-left: 0;">
                    ${venda.receitas.map(r => `
                        <li style="margin-bottom: 10px; padding: 5px; border-bottom: 1px solid #eee;">
                            <div><strong>${r.nome}</strong> (${r.quantidade} un.) - ${formatarMoeda(r.precoVenda * r.quantidade)}</div>
                            <div style="font-size: 12px; color: #666;">
                                ${r.calcularPreco ? 
                                    `Custo: ${formatarMoeda(r.custoProducao * r.quantidade)} | 
                                    Custo Variado: ${formatarMoeda(r.custosVariados * r.quantidade)}` : 
                                    'Receita sem cálculo de custos'}
                            </div>
                        </li>
                    `).join('')}
                </ul>
            `;
        } else if (venda.receitaId) {
            // Compatibilidade com vendas antigas (uma receita)
            const receita = receitas.find(r => r.id === venda.receitaId);
            receitasHTML = `
                <h4>Receita:</h4>
                <ul style="list-style: none; padding-left: 0;">
                    <li style="margin-bottom: 10px; padding: 5px; border-bottom: 1px solid #eee;">
                        <div><strong>${venda.receitaNome || (receita ? receita.nome : 'Receita não encontrada')}</strong> (${venda.quantidade} un.)</div>
                        <div style="font-size: 12px; color: #666;">
                            Custo: ${formatarMoeda(venda.custoProducao * venda.quantidade)} | 
                            Custo Variado: ${formatarMoeda(venda.custosVariados * venda.quantidade)}
                        </div>
                    </li>
                </ul>
            `;
        }
        
        content.innerHTML = `
            <div class="sale-details">
                <h4>Dados do Cliente</h4>
                <p><strong>Data:</strong> ${formatarData(venda.data)}</p>
                <p><strong>Cliente:</strong> ${venda.cliente.nome}</p>
                <p><strong>Telefone:</strong> ${venda.cliente.telefone || 'N/A'}</p>
                <p><strong>Endereço:</strong> ${venda.cliente.endereco || 'N/A'}</p>
                
                ${venda.observacoes ? `<p><strong>Observações:</strong> ${venda.observacoes}</p>` : ''}
                
                ${receitasHTML}
                
                <div class="recipe-pricing" style="margin: 15px 0;">
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Frete</div>
                        <div class="recipe-price-value">${formatarMoeda(venda.custoFrete || 0)}</div>
                    </div>
                    
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Decoração</div>
                        <div class="recipe-price-value">${formatarMoeda(venda.custoDecoracao || 0)}</div>
                    </div>
                    
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Despesas Adicionais</div>
                        <div class="recipe-price-value">${formatarMoeda(venda.despesasAdicionaisOriginal || 0)}</div>
                    </div>
                    
                    <div class="recipe-price-item">
                        <div class="recipe-price-label">Desp. Adic. + 10%</div>
                        <div class="recipe-price-value">${formatarMoeda(despesasAdicionaisComAcrescimo)}</div>
                    </div>
                </div>
                
                <div class="venda-resumo-financeiro">
                    <div class="venda-resumo-grid">
                        <div class="venda-resumo-item">
                            <div class="venda-resumo-label">Valor Total</div>
                            <div class="venda-resumo-valor">${formatarMoeda(venda.valorTotal)}</div>
                        </div>
                        
                        <div class="venda-resumo-item">
                            <div class="venda-resumo-label">Despesa</div>
                            <div class="venda-resumo-valor">${formatarMoeda(despesa)}</div>
                            <div class="material-detalhes">(preço médio por g/ml)</div>
                        </div>
                        
                        <div class="venda-resumo-item">
                            <div class="venda-resumo-label">Reinvestir</div>
                            <div class="venda-resumo-valor">${formatarMoeda(valorReinvestir)}</div>
                        </div>
                        
                        <div class="venda-resumo-item">
                            <div class="venda-resumo-label">Total Desp. Adic.</div>
                            <div class="venda-resumo-valor">${formatarMoeda(totalDespesasAdicionais)}</div>
                        </div>
                        
                        <div class="venda-resumo-item">
                            <div class="venda-resumo-label">Lucro</div>
                            <div class="venda-resumo-valor ${lucro >= 0 ? 'lucro-positivo' : 'lucro-negativo'}">${formatarMoeda(lucro)}</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        modal.classList.remove('hidden');
    } catch (error) {
        console.error("Erro ao mostrar detalhes da venda:", error);
    }
}

// Função para mostrar o formulário de edição de venda - ATUALIZADA para múltiplas receitas
function mostrarFormEditarVenda(vendaId) {
    try {
        const venda = vendas.find(v => v.id === vendaId);
        if (!venda) return;
        
        // Preencher formulário de edição
        document.getElementById('editar-venda-id').value = venda.id;
        document.getElementById('editar-cliente-nome').value = venda.cliente.nome;
        document.getElementById('editar-cliente-telefone').value = venda.cliente.telefone || '';
        document.getElementById('editar-cliente-endereco').value = venda.cliente.endereco || '';
        document.getElementById('editar-observacoes-venda').value = venda.observacoes || '';
        document.getElementById('editar-custo-frete').value = venda.custoFrete || 0;
        document.getElementById('editar-custo-decoracao').value = venda.custoDecoracao || 0;
        document.getElementById('editar-despesas-adicionais').value = venda.despesasAdicionaisOriginal || 0;
        document.getElementById('editar-valor-total-venda').value = venda.valorTotal;
        
        // Data da venda
        const dataVendaEl = document.getElementById('editar-data-venda');
        if (dataVendaEl) {
            const data = new Date(venda.data);
            dataVendaEl.value = data.toISOString().split('T')[0];
        }
        
        // Carregar receitas da venda
        const receitasContainer = document.getElementById('editar-receitas-container');
        if (receitasContainer) {
            receitasContainer.innerHTML = '';
            
            if (venda.receitas && venda.receitas.length > 0) {
                // Nova estrutura com múltiplas receitas
                venda.receitas.forEach(receitaVenda => {
                    const receita = receitas.find(r => r.id === receitaVenda.id);
                    if (!receita) return;
                    
                    const receitaItem = document.createElement('div');
                    receitaItem.className = 'receita-item';
                    receitaItem.setAttribute('data-id', receitaVenda.id);
                    
                    receitaItem.innerHTML = `
                        <div class="receita-info">
                            <strong>${receita.nome}</strong> - 
                            <input type="number" class="form-control receita-quantidade-edit" value="${receitaVenda.quantidade}" min="1" style="width: 60px; display: inline-block;">
                            unidade(s)
                            <span style="margin-left: 10px; font-size: 0.9em;">
                                (${formatarMoeda(receita.precoVenda)}/un)
                            </span>
                        </div>
                        <div class="receita-acoes">
                            <label class="receita-toggle">
                                <input type="checkbox" class="receita-calcular-preco-edit" ${receitaVenda.calcularPreco ? 'checked' : ''}>
                                Calcular preço
                            </label>
                            <button type="button" class="btn btn-danger btn-remover-receita-edit">X</button>
                        </div>
                    `;
                    
                    receitasContainer.appendChild(receitaItem);
                    
                    // Adicionar evento para remover
                    const btnRemover = receitaItem.querySelector('.btn-remover-receita-edit');
                    if (btnRemover) {
                        btnRemover.addEventListener('click', function() {
                            receitasContainer.removeChild(receitaItem);
                            atualizarResumoFinanceiroEdicao();
                        });
                    }
                    
                    // Adicionar eventos para os inputs
                    const qtyInput = receitaItem.querySelector('.receita-quantidade-edit');
                    if (qtyInput) {
                        qtyInput.addEventListener('input', atualizarResumoFinanceiroEdicao);
                    }
                    
                    const checkbox = receitaItem.querySelector('.receita-calcular-preco-edit');
                    if (checkbox) {
                        checkbox.addEventListener('change', atualizarResumoFinanceiroEdicao);
                    }
                });
            } else if (venda.receitaId) {
                // Compatibilidade com vendas antigas (uma receita)
                const receita = receitas.find(r => r.id === venda.receitaId);
                if (receita) {
                    const receitaItem = document.createElement('div');
                    receitaItem.className = 'receita-item';
                    receitaItem.setAttribute('data-id', receita.id);
                    
                    receitaItem.innerHTML = `
                        <div class="receita-info">
                            <strong>${receita.nome}</strong> - 
                            <input type="number" class="form-control receita-quantidade-edit" value="${venda.quantidade}" min="1" style="width: 60px; display: inline-block;">
                            unidade(s)
                            <span style="margin-left: 10px; font-size: 0.9em;">
                                (${formatarMoeda(receita.precoVenda)}/un)
                            </span>
                        </div>
                        <div class="receita-acoes">
                            <label class="receita-toggle">
                                <input type="checkbox" class="receita-calcular-preco-edit" checked>
                                Calcular preço
                            </label>
                            <button type="button" class="btn btn-danger btn-remover-receita-edit">X</button>
                        </div>
                    `;
                    
                    receitasContainer.appendChild(receitaItem);
                    
                    // Adicionar evento para remover
                    const btnRemover = receitaItem.querySelector('.btn-remover-receita-edit');
                    if (btnRemover) {
                        btnRemover.addEventListener('click', function() {
                            receitasContainer.removeChild(receitaItem);
                            atualizarResumoFinanceiroEdicao();
                        });
                    }
                    
                    // Adicionar eventos para os inputs
                    const qtyInput = receitaItem.querySelector('.receita-quantidade-edit');
                    if (qtyInput) {
                        qtyInput.addEventListener('input', atualizarResumoFinanceiroEdicao);
                    }
                    
                    const checkbox = receitaItem.querySelector('.receita-calcular-preco-edit');
                    if (checkbox) {
                        checkbox.addEventListener('change', atualizarResumoFinanceiroEdicao);
                    }
                }
            }
            
            // Adicionar botão para adicionar mais receitas
            const btnAdicionar = document.createElement('button');
            btnAdicionar.type = 'button';
            btnAdicionar.className = 'btn btn-secondary btn-adicionar-receita';
            btnAdicionar.textContent = '+ Adicionar Receita';
            btnAdicionar.addEventListener('click', function() {
                abrirModalAdicionarReceitaEdicao(vendaId);
            });
            
            receitasContainer.appendChild(btnAdicionar);
        }
        
        // Atualizar resumo financeiro
        atualizarResumoFinanceiroEdicao();
        
        // Mostrar o modal
        document.getElementById('editar-venda-modal').classList.remove('hidden');
    } catch (error) {
        console.error("Erro ao mostrar formulário de edição:", error);
    }
}

// Função para atualizar o resumo financeiro na tela de edição - ATUALIZADA para múltiplas receitas
function atualizarResumoFinanceiroEdicao() {
    try {
        const receitasContainer = document.getElementById('editar-receitas-container');
        if (!receitasContainer) return;
        
        // Coletar receitas e suas quantidades
        const receitasItems = receitasContainer.querySelectorAll('.receita-item');
        if (receitasItems.length === 0) return;
        
        let custoProducaoTotal = 0;
        let custosVariadosTotal = 0;
        let valorVendaTotal = 0;
        
        // Para cada receita
        receitasItems.forEach(item => {
            const receitaId = item.getAttribute('data-id');
            if (!receitaId) return;
            
            const quantidade = parseInt(item.querySelector('.receita-quantidade-edit').value) || 1;
            const calcularPreco = item.querySelector('.receita-calcular-preco-edit').checked;
            
            if (!calcularPreco) return;
            
            const receita = receitas.find(r => r.id === receitaId);
            if (!receita) return;
            
            // Calcular custo usando preço médio por g/ml
            const custoProducao = calcularCustoReceita(receita);
            const custosVariados = custoProducao * 0.1;
            
            // Somar aos totais
            custoProducaoTotal += custoProducao * quantidade;
            custosVariadosTotal += custosVariados * quantidade;
            valorVendaTotal += receita.precoVenda * quantidade;
        });
        
        // Obter despesas adicionais
        const custoFrete = parseFloat(document.getElementById('editar-custo-frete').value) || 0;
        const custoDecoracao = parseFloat(document.getElementById('editar-custo-decoracao').value) || 0;
        const despesasAdicionais = parseFloat(document.getElementById('editar-despesas-adicionais').value) || 0;
        
        // Cálculos finais
        const despesa = custoProducaoTotal + custosVariadosTotal;
        const valorReinvestir = despesa;
        const despesasAdicionaisComAcrescimo = despesasAdicionais * 1.1;
        const totalDespesasAdicionais = despesasAdicionaisComAcrescimo + custoFrete + custoDecoracao;
        
        // Valor total da venda
        const valorTotal = valorVendaTotal + custoFrete + custoDecoracao;
        document.getElementById('editar-valor-total-venda').value = valorTotal.toFixed(2);
        
        // Lucro
        const lucro = valorTotal - despesa - valorReinvestir - totalDespesasAdicionais;
        
        // Atualizar interface
        document.getElementById('editar-resumo-valor-total').textContent = formatarMoeda(valorTotal);
        document.getElementById('editar-resumo-despesa').textContent = formatarMoeda(despesa);
        document.getElementById('editar-resumo-reinvestir').textContent = formatarMoeda(valorReinvestir);
        document.getElementById('editar-resumo-desp-adic').textContent = formatarMoeda(totalDespesasAdicionais);
        
        const resumoLucro = document.getElementById('editar-resumo-lucro');
        if (resumoLucro) {
            resumoLucro.textContent = formatarMoeda(lucro);
            resumoLucro.className = 'venda-resumo-valor ' + (lucro >= 0 ? 'lucro-positivo' : 'lucro-negativo');
        }
    } catch (error) {
        console.error("Erro ao atualizar resumo financeiro de edição:", error);
    }
}

// Função para abrir o modal de adicionar receita durante a edição - NOVA
function abrirModalAdicionarReceitaEdicao(vendaId) {
    // Implementa lógica similar ao abrirModalAdicionarReceita
    // mas adaptada para o contexto de edição
    abrirModalAdicionarReceita();
    
    // Armazenar o ID da venda em edição em um atributo do modal
    const modal = document.getElementById('adicionar-receita-venda-modal');
    if (modal) {
        modal.setAttribute('data-editing-venda', vendaId);
        
        // Substituir o evento do botão confirmar
        const btnConfirmar = document.getElementById('confirmar-adicionar-receita');
        if (btnConfirmar) {
            btnConfirmar.removeEventListener('click', adicionarReceitaAVenda);
            btnConfirmar.addEventListener('click', adicionarReceitaAEdicaoVenda);
        }
    }
}

// Função para adicionar receita durante a edição - NOVA
function adicionarReceitaAEdicaoVenda() {
    const receitaId = document.getElementById('selecionar-receita-modal').value;
    if (!receitaId) return;
    
    const receita = receitas.find(r => r.id === receitaId);
    if (!receita) return;
    
    const quantidade = parseInt(document.getElementById('quantidade-receita-modal').value) || 1;
    const calcularPreco = document.getElementById('calcular-preco-modal').checked;
    
    // Obter o container de receitas da edição
    const receitasContainer = document.getElementById('editar-receitas-container');
    if (!receitasContainer) return;
    
    // Verificar se a receita já foi adicionada
    const receitaExistente = receitasContainer.querySelector(`.receita-item[data-id="${receitaId}"]`);
    if (receitaExistente) {
        // Atualizar quantidade
        const qtyInput = receitaExistente.querySelector('.receita-quantidade-edit');
        if (qtyInput) {
            qtyInput.value = parseInt(qtyInput.value) + quantidade;
        }
    } else {
        // Adicionar nova receita
        const receitaItem = document.createElement('div');
        receitaItem.className = 'receita-item';
        receitaItem.setAttribute('data-id', receitaId);
        
        receitaItem.innerHTML = `
            <div class="receita-info">
                <strong>${receita.nome}</strong> - 
                <input type="number" class="form-control receita-quantidade-edit" value="${quantidade}" min="1" style="width: 60px; display: inline-block;">
                unidade(s)
                <span style="margin-left: 10px; font-size: 0.9em;">
                    (${formatarMoeda(receita.precoVenda)}/un)
                </span>
            </div>
            <div class="receita-acoes">
                <label class="receita-toggle">
                    <input type="checkbox" class="receita-calcular-preco-edit" ${calcularPreco ? 'checked' : ''}>
                    Calcular preço
                </label>
                <button type="button" class="btn btn-danger btn-remover-receita-edit">X</button>
            </div>
        `;
        
        // Inserir antes do botão adicionar
        const btnAdicionar = receitasContainer.querySelector('.btn-adicionar-receita');
        receitasContainer.insertBefore(receitaItem, btnAdicionar);
        
        // Adicionar evento para remover
        const btnRemover = receitaItem.querySelector('.btn-remover-receita-edit');
        if (btnRemover) {
            btnRemover.addEventListener('click', function() {
                receitasContainer.removeChild(receitaItem);
                atualizarResumoFinanceiroEdicao();
            });
        }
        
        // Adicionar eventos para os inputs
        const qtyInput = receitaItem.querySelector('.receita-quantidade-edit');
        if (qtyInput) {
            qtyInput.addEventListener('input', atualizarResumoFinanceiroEdicao);
        }
        
        const checkbox = receitaItem.querySelector('.receita-calcular-preco-edit');
        if (checkbox) {
            checkbox.addEventListener('change', atualizarResumoFinanceiroEdicao);
        }
    }
    
    // Fechar modal
    fecharModalAdicionarReceita();
    
    // Atualizar resumo financeiro
    atualizarResumoFinanceiroEdicao();
    
    // Restaurar o botão confirmar para o evento original após fechar o modal
    const btnConfirmar = document.getElementById('confirmar-adicionar-receita');
    if (btnConfirmar) {
        btnConfirmar.removeEventListener('click', adicionarReceitaAEdicaoVenda);
        btnConfirmar.addEventListener('click', adicionarReceitaAVenda);
    }
}

// Handler para o envio do formulário de edição de venda - ATUALIZADO para múltiplas receitas
function handleEditarVenda(e) {
    e.preventDefault();
    
    try {
        // Coletar dados do formulário
        const vendaId = document.getElementById('editar-venda-id').value;
        const clienteNome = document.getElementById('editar-cliente-nome').value;
        const clienteTelefone = document.getElementById('editar-cliente-telefone').value;
        const clienteEndereco = document.getElementById('editar-cliente-endereco').value;
        const custoFrete = parseFloat(document.getElementById('editar-custo-frete').value) || 0;
        const custoDecoracao = parseFloat(document.getElementById('editar-custo-decoracao').value) || 0;
        const despesasAdicionais = parseFloat(document.getElementById('editar-despesas-adicionais').value) || 0;
        const observacoes = document.getElementById('editar-observacoes-venda').value;
        const dataVenda = document.getElementById('editar-data-venda').value;
        const valorTotal = parseFloat(document.getElementById('editar-valor-total-venda').value) || 0;
        
        // Coletar receitas
        const receitas = [];
        const receitasItems = document.getElementById('editar-receitas-container').querySelectorAll('.receita-item');
        
        receitasItems.forEach(item => {
            const receitaId = item.getAttribute('data-id');
            if (!receitaId) return;
            
            const quantidade = parseInt(item.querySelector('.receita-quantidade-edit').value) || 1;
            const calcularPreco = item.querySelector('.receita-calcular-preco-edit').checked;
            
            receitas.push({
                id: receitaId,
                quantidade: quantidade,
                calcularPreco: calcularPreco
            });
        });
        
        // Mostrar modal de processamento
        toggleModal(true, "Atualizando venda...", "Aguarde enquanto atualizamos a venda.");
        
        // Editar a venda
        const resultado = editarVenda(vendaId, {
            clienteNome,
            clienteTelefone,
            clienteEndereco,
            custoFrete,
            custoDecoracao,
            despesasAdicionais,
            observacoes,
            dataVenda,
            valorTotal,
            receitas
        });
        
        // Fechar modal
        toggleModal(false);
        
        if (resultado) {
            // Fechar o modal de edição
            document.getElementById('editar-venda-modal').classList.add('hidden');
            
            // Recarregar listas
            carregarVendas();
            carregarEstoque();
        }
    } catch (error) {
        toggleModal(false);
        console.error("Erro ao editar venda:", error);
    }
}
//Parte 9: JavaScript - Filtrar Vendas e Resumo
// Função para filtrar vendas - OTIMIZADA
function filtrarVendas() {
    try {
        const dataInicio = document.getElementById('filtro-data-inicio').value;
        const dataFim = document.getElementById('filtro-data-fim').value;
        const receitaId = document.getElementById('filtro-receita').value;
        
        const vendasFiltradas = vendas.filter(venda => {
            // Filtrar por data
            let passaFiltroData = true;
            if (dataInicio) {
                const dataVenda = new Date(venda.data);
                const dataInicioDate = new Date(dataInicio);
                passaFiltroData = passaFiltroData && dataVenda >= dataInicioDate;
            }
            
            if (dataFim) {
                const dataVenda = new Date(venda.data);
                const dataFimDate = new Date(dataFim);
                // Adicionar 1 dia para incluir o dia final completo
                dataFimDate.setDate(dataFimDate.getDate() + 1);
                passaFiltroData = passaFiltroData && dataVenda < dataFimDate;
            }
            
            // Filtrar por receita
            let passaFiltroReceita = true;
            if (receitaId) {
                // Para vendas com múltiplas receitas
                if (venda.receitas && venda.receitas.length > 0) {
                    passaFiltroReceita = venda.receitas.some(r => r.id === receitaId);
                } else {
                    // Compatibilidade com vendas antigas
                    passaFiltroReceita = venda.receitaId === receitaId;
                }
            }
            
            return passaFiltroData && passaFiltroReceita;
        });
        
        // Renderizar vendas filtradas
        renderizarVendas(vendasFiltradas);
        
        // Adicionar o resumo financeiro para as vendas filtradas
        adicionarResumoFinanceiroVendas(vendasFiltradas);
    } catch (error) {
        console.error("Erro ao filtrar vendas:", error);
    }
}

// Nova função para renderizar vendas (extraída para evitar duplicação)
function renderizarVendas(vendasLista) {
    try {
        const container = document.getElementById('lista-vendas');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (!vendasLista || vendasLista.length === 0) {
            container.innerHTML = '<p>Nenhuma venda encontrada com os filtros selecionados.</p>';
            return;
        }
        
        // Ordenar vendas da mais recente para a mais antiga e remover duplicatas
        const vendasOrdenadas = [...vendasLista].sort((a, b) => new Date(b.data) - new Date(a.data));
        const vendasUnicas = [];
        const vendasIds = new Set();
        
        for (const venda of vendasOrdenadas) {
            // Criar uma chave única baseada em dados críticos
            const vendaKey = `${venda.id}_${venda.cliente.nome}_${venda.data}`;
            if (!vendasIds.has(vendaKey)) {
                vendasIds.add(vendaKey);
                vendasUnicas.push(venda);
            }
        }
        
        vendasUnicas.forEach((venda) => {
            // Calcular valores financeiros
            const despesa = venda.despesa || (venda.custoProducao + venda.custosVariados);
            const valorReinvestir = despesa;
            
            // Compatibilidade com vendas antigas
            const despesasAdicionaisComAcrescimo = venda.despesasAdicionaisComAcrescimo || 
                                                ((venda.despesasAdicionaisOriginal || venda.despesasAdicionais || 0) * 1.1);
            const totalDespesasAdicionais = venda.totalDespesasAdicionais || 
                                          (despesasAdicionaisComAcrescimo + (venda.custoFrete || 0) + (venda.custoDecoracao || 0));
            
            // Recalcular lucro corretamente
            const lucro = venda.lucro || (venda.valorTotal - despesa - valorReinvestir - totalDespesasAdicionais);
            
            // Lista de receitas para exibição
            let receitasHTML = '';
            if (venda.receitas && venda.receitas.length > 0) {
                // Novas vendas com múltiplas receitas
                receitasHTML = venda.receitas.map(r => 
                    `<span class="badge" style="background-color: #f0f0f0; color: #333; margin-right: 5px; padding: 2px 6px; border-radius: 3px; font-size: 12px;">${r.nome} (${r.quantidade})</span>`
                ).join('');
            } else if (venda.receitaNome) {
                // Vendas antigas
                receitasHTML = `<span class="badge" style="background-color: #f0f0f0; color: #333; margin-right: 5px; padding: 2px 6px; border-radius: 3px; font-size: 12px;">${venda.receitaNome} (${venda.quantidade})</span>`;
            }
            
            const card = document.createElement('div');
            card.className = 'sale-card';
            card.innerHTML = `
                <div class="sale-header">
                    <div class="sale-title">${venda.cliente.nome}</div>
                    <div class="sale-date">${formatarData(venda.data)}</div>
                </div>
                <div>Receitas: ${receitasHTML}</div>
                
                <div class="venda-resumo-financeiro" style="margin-top: 10px;">
                    <div class="venda-resumo-grid">
                        <div class="venda-resumo-item">
                            <div class="venda-resumo-label">Valor Total</div>
                            <div class="venda-resumo-valor">${formatarMoeda(venda.valorTotal)}</div>
                        </div>
                        <div class="venda-resumo-item">
                            <div class="venda-resumo-label">Despesa</div>
                            <div class="venda-resumo-valor">${formatarMoeda(despesa)}</div>
                            <div class="material-detalhes">(preço médio)</div>
                        </div>
                        <div class="venda-resumo-item">
                            <div class="venda-resumo-label">Reinvestir</div>
                            <div class="venda-resumo-valor">${formatarMoeda(valorReinvestir)}</div>
                        </div>
                        <div class="venda-resumo-item">
                            <div class="venda-resumo-label">Total Desp. Adic.</div>
                            <div class="venda-resumo-valor">${formatarMoeda(totalDespesasAdicionais)}</div>
                        </div>
                        <div class="venda-resumo-item">
                            <div class="venda-resumo-label">Lucro</div>
                            <div class="venda-resumo-valor ${lucro >= 0 ? 'lucro-positivo' : 'lucro-negativo'}">${formatarMoeda(lucro)}</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 10px;">
                    <button class="btn btn-secondary btn-detalhes-venda" data-id="${venda.id}">Ver Detalhes</button>
                    <button class="btn btn-primary btn-editar-venda" data-id="${venda.id}">Editar</button>
                    <button class="btn btn-danger btn-excluir-venda" data-id="${venda.id}">Excluir</button>
                </div>
            `;
            container.appendChild(card);
        });
    } catch (error) {
        console.error("Erro ao renderizar vendas:", error);
    }
}

// NOVA FUNÇÃO: Adiciona um resumo financeiro para as vendas filtradas
function adicionarResumoFinanceiroVendas(vendasLista) {
    try {
        // Verificar se estamos na página de vendas
        const vendasPage = document.getElementById('vendas-page');
        if (!vendasPage || !vendasPage.classList.contains('active')) {
            return; // Não adicionar resumo se não estivermos na página de vendas
        }
        
        // Verificar se o container de filtros existe
        const filtroContainer = document.querySelector('#vendas-page .form-row');
        if (!filtroContainer) return;
        
        // Verificar se o resumo já existe e removê-lo
        let resumoExistente = document.getElementById('resumo-vendas-filtradas');
        if (resumoExistente) {
            resumoExistente.remove();
        }
        
        // Calcular totais
        let totalValorTotal = 0;
        let totalDespesa = 0;
        let totalReinvestir = 0;
        let totalDespesasAdicionais = 0;
        let totalLucro = 0;
        
        vendasLista.forEach(venda => {
            // Para vendas com estrutura nova
            if (venda.despesa !== undefined) {
                totalValorTotal += venda.valorTotal || 0;
                totalDespesa += venda.despesa || 0;
                totalReinvestir += venda.valorReinvestir || venda.despesa || 0;
                totalDespesasAdicionais += venda.totalDespesasAdicionais || 0;
                totalLucro += venda.lucro || 0;
            } else {
                // Para vendas antigas
                const despesa = (venda.custoProducao + venda.custosVariados) * venda.quantidade;
                const valorReinvestir = despesa;
                const despesasAdicionaisComAcrescimo = (venda.despesasAdicionaisOriginal || venda.despesasAdicionais || 0) * 1.1;
                const totalDespAdicionais = despesasAdicionaisComAcrescimo + (venda.custoFrete || 0) + (venda.custoDecoracao || 0);
                const lucro = venda.valorTotal - despesa - valorReinvestir - totalDespAdicionais;
                
                totalValorTotal += venda.valorTotal || 0;
                totalDespesa += despesa;
                totalReinvestir += valorReinvestir;
                totalDespesasAdicionais += totalDespAdicionais;
                totalLucro += lucro;
            }
        });
        
        // Criar o elemento de resumo
        const resumoDiv = document.createElement('div');
        resumoDiv.id = 'resumo-vendas-filtradas';
        resumoDiv.className = 'venda-resumo-financeiro';
        resumoDiv.style.marginTop = '20px';
        resumoDiv.style.marginBottom = '20px';
        
        resumoDiv.innerHTML = `
            <h4>Resumo das Vendas (${vendasLista.length} ${vendasLista.length === 1 ? 'venda' : 'vendas'})</h4>
            <div class="venda-resumo-grid">
                <div class="venda-resumo-item">
                    <div class="venda-resumo-label">Valor Total</div>
                    <div class="venda-resumo-valor">${formatarMoeda(totalValorTotal)}</div>
                </div>
                <div class="venda-resumo-item">
                    <div class="venda-resumo-label">Despesa</div>
                    <div class="venda-resumo-valor">${formatarMoeda(totalDespesa)}</div>
                </div>
                <div class="venda-resumo-item">
                    <div class="venda-resumo-label">Reinvestir</div>
                    <div class="venda-resumo-valor">${formatarMoeda(totalReinvestir)}</div>
                </div>
                <div class="venda-resumo-item">
                    <div class="venda-resumo-label">Total Desp. Adic.</div>
                    <div class="venda-resumo-valor">${formatarMoeda(totalDespesasAdicionais)}</div>
                </div>
                <div class="venda-resumo-item">
                    <div class="venda-resumo-label">Lucro</div>
                    <div class="venda-resumo-valor ${totalLucro >= 0 ? 'lucro-positivo' : 'lucro-negativo'}">${formatarMoeda(totalLucro)}</div>
                </div>
            </div>
        `;
        
        // Inserir após o container de filtros
        filtroContainer.parentNode.insertBefore(resumoDiv, filtroContainer.nextSibling);
    } catch (error) {
        console.error("Erro ao adicionar resumo financeiro:", error);
    }
}

// Função para limpar filtros de vendas
function limparFiltrosVendas() {
    document.getElementById('filtro-data-inicio').value = '';
    document.getElementById('filtro-data-fim').value = '';
    document.getElementById('filtro-receita').value = '';
    document.getElementById('pesquisar-vendas').value = '';
    
    carregarVendas();
}

// Função para carregar a lista de vendas - OTIMIZADA
function carregarVendas() {
    try {
        // Chamar a função de renderizar com todas as vendas
        renderizarVendas(vendas);
        
        // Adicionar resumo financeiro para todas as vendas
        adicionarResumoFinanceiroVendas(vendas);
        
        // Configurar delegação de eventos para os botões de vendas
        const listaVendas = document.getElementById('lista-vendas');
        if (listaVendas) {
            // Remover eventos anteriores se existirem
            if (listaVendas._delegationHandlers) {
                for (const eventType in listaVendas._delegationHandlers) {
                    listaVendas.removeEventListener(eventType, listaVendas._delegationHandlers[eventType]);
                }
            }
            
            // Adicionar eventos de delegação para os botões
            EventManager.delegateEvent(listaVendas, '.btn-detalhes-venda', 'click', function() {
                const id = this.getAttribute('data-id');
                if (id) mostrarDetalhesVenda(id);
            });
            
            EventManager.delegateEvent(listaVendas, '.btn-editar-venda', 'click', function() {
                const id = this.getAttribute('data-id');
                if (id) mostrarFormEditarVenda(id);
            });
            
            EventManager.delegateEvent(listaVendas, '.btn-excluir-venda', 'click', function() {
                const id = this.getAttribute('data-id');
                if (id) {
                    confirmarExclusaoVenda(id); // Alterado para usar confirmação
                }
            });
        }
    } catch (error) {
        console.error("Erro ao carregar vendas:", error);
    }
}

// Função para confirmar exclusão de venda - OTIMIZADA
function confirmarExclusaoVenda(vendaId) {
    try {
        // Configurar o ID da venda para exclusão
        document.getElementById('excluir-venda-id').value = vendaId;
        
        // Mostrar modal de confirmação
        document.getElementById('confirmar-exclusao-modal').classList.remove('hidden');
    } catch (error) {
        console.error("Erro ao confirmar exclusão:", error);
    }
}

// Handler para confirmar exclusão
function handleConfirmarExclusao() {
    try {
        const vendaId = document.getElementById('excluir-venda-id').value;
        
        if (!vendaId) {
            document.getElementById('confirmar-exclusao-modal').classList.add('hidden');
            return;
        }
        
        // Excluir a venda
        const resultado = excluirVenda(vendaId);
        
        // Fechar modal de confirmação
        document.getElementById('confirmar-exclusao-modal').classList.add('hidden');
        
        // Recarregar listas
        carregarVendas();
        carregarEstoque();
        
        return true;
    } catch (error) {
        console.error("Erro ao excluir venda:", error);
        document.getElementById('confirmar-exclusao-modal').classList.add('hidden');
        return true; // Retornar true mesmo com erro para evitar travamentos
    }
}

// Função para fechar o modal de confirmação
function fecharModalConfirmacaoExclusao() {
    document.getElementById('confirmar-exclusao-modal').classList.add('hidden');
}

// Função para inicializar eventos dos modais de venda
function inicializarEventosModaisVenda() {
    try {
        // Modal de detalhes de venda
        const btnFecharDetalhes = document.getElementById('fechar-detalhes-venda');
        if (btnFecharDetalhes) {
            btnFecharDetalhes.removeEventListener('click', fecharModalDetalhesVenda);
            btnFecharDetalhes.addEventListener('click', fecharModalDetalhesVenda);
        }
        
        // Modal de edição de venda
        const btnFecharEditar = document.getElementById('fechar-editar-venda');
        if (btnFecharEditar) {
            btnFecharEditar.removeEventListener('click', fecharModalEditarVenda);
            btnFecharEditar.addEventListener('click', fecharModalEditarVenda);
        }
        
        // Modal de confirmação de exclusão
        const btnConfirmarExclusao = document.getElementById('confirmar-exclusao');
        if (btnConfirmarExclusao) {
            btnConfirmarExclusao.removeEventListener('click', handleConfirmarExclusao);
            btnConfirmarExclusao.addEventListener('click', handleConfirmarExclusao);
        }
        
        const btnCancelarExclusao = document.getElementById('cancelar-exclusao');
        if (btnCancelarExclusao) {
            btnCancelarExclusao.removeEventListener('click', fecharModalConfirmacaoExclusao);
            btnCancelarExclusao.addEventListener('click', fecharModalConfirmacaoExclusao);
        }
        
        // Modal de adicionar receita à venda
        const btnFecharAdicionarReceita = document.getElementById('fechar-adicionar-receita-modal');
        if (btnFecharAdicionarReceita) {
            btnFecharAdicionarReceita.removeEventListener('click', fecharModalAdicionarReceita);
            btnFecharAdicionarReceita.addEventListener('click', fecharModalAdicionarReceita);
        }
        
        // Evento de quantidade de receita no modal
        const qtdReceitaModal = document.getElementById('quantidade-receita-modal');
        if (qtdReceitaModal) {
            qtdReceitaModal.removeEventListener('input', handleQtdReceitaModalChange);
            qtdReceitaModal.addEventListener('input', handleQtdReceitaModalChange);
        }
    } catch (error) {
        console.error("Erro ao inicializar eventos dos modais:", error);
    }
}

// Handler para mudança de quantidade no modal
function handleQtdReceitaModalChange() {
    const receitaId = document.getElementById('selecionar-receita-modal').value;
    if (!receitaId) return;
    
    const receita = receitas.find(r => r.id === receitaId);
    if (!receita) return;
    
    const quantidade = parseInt(this.value) || 1;
    verificarDisponibilidadeEstoqueReceita(receita, quantidade);
}

// Funções auxiliares para modais
function fecharModalDetalhesVenda() {
    document.getElementById('venda-details-modal').classList.add('hidden');
}

function fecharModalEditarVenda() {
    document.getElementById('editar-venda-modal').classList.add('hidden');
}

// Evento para pesquisar vendas pelo termo
function handlePesquisarVendasInput() {
    const termo = document.getElementById('pesquisar-vendas').value.toLowerCase();
    
    if (!termo) {
        // Se a pesquisa estiver vazia, mostrar todas as vendas
        carregarVendas();
        return;
    }
    
    // Filtrar vendas por nome do cliente ou receita
    const vendasFiltradas = vendas.filter(venda => {
        const nomeCliente = venda.cliente && venda.cliente.nome ? venda.cliente.nome.toLowerCase() : '';
        
        let nomeReceitas = '';
        if (venda.receitas && venda.receitas.length > 0) {
            // Novas vendas com múltiplas receitas
            nomeReceitas = venda.receitas.map(r => r.nome.toLowerCase()).join(' ');
        } else {
            // Vendas antigas
            nomeReceitas = venda.receitaNome ? venda.receitaNome.toLowerCase() : '';
        }
        
        return nomeCliente.includes(termo) || nomeReceitas.includes(termo);
    });
    
    // Renderizar vendas filtradas
    renderizarVendas(vendasFiltradas);
    
    // Adicionar resumo financeiro
    adicionarResumoFinanceiroVendas(vendasFiltradas);
}

// Função para inicializar a tela de vendas
function setupVendasEvents() {
    try {
        // Evento para selecionar receita na tela de vendas (agora no modal)
        const selectReceitaModal = document.getElementById('selecionar-receita-modal');
        if (selectReceitaModal) {
            selectReceitaModal.removeEventListener('change', carregarDetalhesReceitaModal);
            selectReceitaModal.addEventListener('change', carregarDetalhesReceitaModal);
        }
        
        // Eventos para os botões de filtrar vendas
        const btnFiltrarVendas = document.getElementById('btn-filtrar-vendas');
        if (btnFiltrarVendas) {
            btnFiltrarVendas.removeEventListener('click', filtrarVendas);
            btnFiltrarVendas.addEventListener('click', filtrarVendas);
        }
        
        const btnLimparFiltros = document.getElementById('btn-limpar-filtros');
        if (btnLimparFiltros) {
            btnLimparFiltros.removeEventListener('click', limparFiltrosVendas);
            btnLimparFiltros.addEventListener('click', limparFiltrosVendas);
        }
        
        // Evento para pesquisar vendas
        const pesquisarVendas = document.getElementById('pesquisar-vendas');
        if (pesquisarVendas) {
            pesquisarVendas.removeEventListener('input', handlePesquisarVendasInput);
            pesquisarVendas.addEventListener('input', handlePesquisarVendasInput);
        }
        
        // Inicializar eventos dos modais
        inicializarEventosModaisVenda();
        inicializarGerenciadorReceitasVenda();
        
        // Formulário de editar venda
        const formEditarVenda = document.getElementById('form-editar-venda');
        if (formEditarVenda) {
            formEditarVenda.removeEventListener('submit', handleEditarVenda);
            formEditarVenda.addEventListener('submit', handleEditarVenda);
        }
    } catch (error) {
        console.error("Erro ao configurar eventos de vendas:", error);
    }
}

// NOVA FUNÇÃO: Inicializar o sistema completo
function inicializarSistema() {
    // 1. Verificar autenticação
    if (!currentUser) {
        mostrarTelaLogin();
        return;
    }
    
    // 2. Configurar eventos globais de navegação
    setupEventListeners();
    
    // 3. Configurar eventos específicos de cada módulo
    setupMaterialButtonEvents();
    setupReceitaEvents();
    setupVendasEvents();
    
    // 4. Carregar interfaces
    carregarEstoque();
    carregarMateriais();
    carregarReceitas();
    carregarVendas();
    
    // 5. Iniciar sistema de monitoramento
    sistemaMonitor.iniciar();
    
    // 6. Otimizar para dispositivos móveis
    otimizarParaDispositivos();
    
    console.log("Sistema inicializado com sucesso!");
}

// Iniciar quando o documento estiver pronto
document.addEventListener('DOMContentLoaded', function() {
    console.log("Documento carregado, iniciando aplicação...");
    
    // Carregar dados do localStorage
    try {
        estoque = JSON.parse(localStorage.getItem('estoque')) || [];
        materiais = JSON.parse(localStorage.getItem('materiais')) || [];
        receitas = JSON.parse(localStorage.getItem('receitas')) || [];
        vendas = JSON.parse(localStorage.getItem('vendas')) || [];
    } catch (e) {
        console.error('Erro ao carregar dados do localStorage:', e);
        estoque = [];
        materiais = [];
        receitas = [];
        vendas = [];
    }
    
    // Verificar autenticação
    firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
            console.log("Usuário autenticado:", user.email);
            currentUser = user;
            
            // Mostrar informações do usuário
            const userInfoEl = document.getElementById('user-info');
            if (userInfoEl) {
                userInfoEl.classList.remove('hidden');
                document.getElementById('user-email').textContent = user.email;
            }
            
            // Inicializar o sistema
            inicializarSistema();
            
            // Verificar se há dados na nuvem
            iniciarSincronizacao();
            
            // Adicionar botão de sincronização
            adicionarBotaoSincronizacao();
        } else {
            console.log("Usuário não autenticado");
            currentUser = null;
            mostrarTelaLogin();
        }
    });
});
//Parte 10: JavaScript - Inicialização Final e Funções Auxiliares
// INICIALIZAÇÃO DE PREÇO MÉDIO DE MATERIAIS - NOVA
function atualizarPrecosMediosMateriais() {
    materiais.forEach(material => {
        // Calcular preço médio por unidade
        material.precoMedio = calcularPrecoMedio(material);
        
        // Calcular preço médio por grama/ml
        if (material.quantidadeMedida > 0) {
            material.precoMedioPorGramaMl = material.precoMedio / material.quantidadeMedida;
        } else {
            material.precoMedioPorGramaMl = 0;
        }
    });
}

// CORREÇÃO DE VALORES DE DESPESAS ADICIONAIS - NOVA
function corrigirDespesasAdicionaisVendas() {
    vendas.forEach(venda => {
        // Verificar se o campo totalDespesasAdicionais está correto
        if (venda.despesasAdicionaisOriginal !== undefined && 
            venda.custoFrete !== undefined && 
            venda.custoDecoracao !== undefined) {
            
            const despesasAdicionaisComAcrescimo = venda.despesasAdicionaisOriginal * 1.1;
            const totalDespesasAdicionais = despesasAdicionaisComAcrescimo + venda.custoFrete + venda.custoDecoracao;
            
            // Atualizar se o valor estiver incorreto
            if (venda.totalDespesasAdicionais !== totalDespesasAdicionais) {
                venda.despesasAdicionaisComAcrescimo = despesasAdicionaisComAcrescimo;
                venda.totalDespesasAdicionais = totalDespesasAdicionais;
                
                // Recalcular lucro
                if (venda.lucro !== undefined && venda.valorTotal !== undefined && 
                    venda.despesa !== undefined && venda.valorReinvestir !== undefined) {
                    
                    venda.lucro = venda.valorTotal - venda.despesa - venda.valorReinvestir - totalDespesasAdicionais;
                }
            }
        }
    });
}

// MIGRAÇÃO DE VENDAS ANTIGAS PARA O NOVO FORMATO - NOVA
function migrarVendasAntigasParaNovoFormato() {
    vendas.forEach((venda, index) => {
        // Verificar se é uma venda antiga (sem múltiplas receitas)
        if (!venda.receitas && venda.receitaId) {
            const receita = receitas.find(r => r.id === venda.receitaId);
            if (!receita) return;
            
            // Criar o array de receitas
            venda.receitas = [{
                id: venda.receitaId,
                nome: venda.receitaNome || receita.nome,
                quantidade: venda.quantidade || 1,
                precoVenda: venda.precoVenda || receita.precoVenda,
                calcularPreco: true,
                custoProducao: venda.custoProducao || 0,
                custosVariados: venda.custosVariados || 0
            }];
            
            // Outras atualizações para o novo formato
            if (!venda.despesa) {
                venda.despesa = venda.custoProducao + venda.custosVariados;
            }
            
            if (!venda.valorReinvestir) {
                venda.valorReinvestir = venda.despesa;
            }
            
            if (!venda.despesasAdicionaisComAcrescimo && venda.despesasAdicionaisOriginal) {
                venda.despesasAdicionaisComAcrescimo = venda.despesasAdicionaisOriginal * 1.1;
            }
            
            if (!venda.totalDespesasAdicionais && venda.despesasAdicionaisComAcrescimo) {
                venda.totalDespesasAdicionais = venda.despesasAdicionaisComAcrescimo + venda.custoFrete + venda.custoDecoracao;
            }
            
            if (!venda.lucro && venda.valorTotal) {
                venda.lucro = venda.valorTotal - venda.despesa - venda.valorReinvestir - venda.totalDespesasAdicionais;
            }
            
            // Manter os campos antigos por compatibilidade, mas focar nos novos
            venda.custoProducaoTotal = venda.custoProducao * venda.quantidade;
            venda.custosVariadosTotal = venda.custosVariados * venda.quantidade;
        }
    });
}

// NOVA FUNÇÃO PARA ATUALIZAR DATAS COM FUSO HORÁRIO CORRETO
function corrigirDatasVendas() {
    vendas.forEach(venda => {
        if (venda.data) {
            try {
                const data = new Date(venda.data);
                // Ajustar apenas se a data não estiver no formato local
                if (data.getHours() !== 0 || data.getMinutes() !== 0) {
                    // Criar data apenas com ano, mês e dia
                    const dataCorrigida = new Date(data.getFullYear(), data.getMonth(), data.getDate());
                    venda.data = dataCorrigida.toISOString();
                }
            } catch (e) {
                console.error("Erro ao corrigir data de venda:", e);
            }
        }
    });
}

// INICIALIZAÇÃO DO BANCO DE DADOS - OTIMIZADA
function inicializarDados() {
    try {
        console.log("Inicializando dados...");
        
        // Garantir que arrays existam
        estoque = estoque || [];
        materiais = materiais || [];
        receitas = receitas || [];
        vendas = vendas || [];
        
        // Inicializar IDs para itens de estoque e materiais
        estoque.forEach((item) => {
            if (!item.id) {
                item.id = gerarId();
            }
            if (!item.materialId && item.codigo) {
                // Tentar encontrar material correspondente
                const material = materiais.find(m => m.codigo === item.codigo);
                if (material) {
                    item.materialId = material.id;
                }
            }
        });
        
        materiais.forEach((material) => {
            if (!material.id) {
                material.id = gerarId();
            }
            
            // Garantir que o histórico de preços existe
            if (!material.historicoPrecos) {
                material.historicoPrecos = [{
                    data: material.dataCadastro || new Date().toISOString(),
                    preco: material.ultimoPreco || 0
                }];
            }
        });
        
        receitas.forEach(receita => {
            if (!receita.id) {
                receita.id = gerarId();
            }
            
            // Inicializar array de ingredientes se não existir
            if (!receita.ingredientes) {
                receita.ingredientes = [];
            }
            
            // Remover ingredientes que não têm materialId válido
            receita.ingredientes = receita.ingredientes.filter(ing => {
                return ing.materialId && materiais.some(m => m.id === ing.materialId);
            });
            
            // Garantir que precoVenda existe
            if (!receita.precoVenda) {
                const custoProducao = calcularCustoReceita(receita);
                const custosVariados = custoProducao * 0.1;
                receita.precoVenda = (custoProducao + custosVariados) * 2.5;
            }
        });
        
        // Atualizar preços médios por grama/ml
        atualizarPrecosMediosMateriais();
        
        // Corrigir despesas adicionais nas vendas
        corrigirDespesasAdicionaisVendas();
        
        // Migrar vendas antigas para o novo formato
        migrarVendasAntigasParaNovoFormato();
        
        // Corrigir datas das vendas
        corrigirDatasVendas();
        
        // Unificar estoque - agrupar itens similares
        unificarEstoque();
        
        atualizarLocalStorage();
        console.log("Dados inicializados com sucesso!");
    } catch (error) {
        console.error("Erro ao inicializar dados:", error);
    }
}

// INTEGRAÇÃO COMPLETA PARA INICIALIZAÇÃO DO SISTEMA COM TODAS AS MODIFICAÇÕES
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Carregado! Inicializando aplicativo...');
    
    // Carregar dados do localStorage
    try {
        estoque = JSON.parse(localStorage.getItem('estoque')) || [];
        materiais = JSON.parse(localStorage.getItem('materiais')) || [];
        receitas = JSON.parse(localStorage.getItem('receitas')) || [];
        vendas = JSON.parse(localStorage.getItem('vendas')) || [];
    } catch (e) {
        console.error('Erro ao carregar dados do localStorage:', e);
        estoque = [];
        materiais = [];
        receitas = [];
        vendas = [];
    }
    
    // Inicializar dados
    inicializarDados();
    
    // Verificar autenticação do Firebase
    firebase.auth().onAuthStateChanged((user) => {
        if (user) {
            // Usuário está logado
            currentUser = user;
            
            // Mostrar email do usuário
            const userInfoEl = document.getElementById('user-info');
            if (userInfoEl) {
                userInfoEl.classList.remove('hidden');
                document.getElementById('user-email').textContent = user.email;
            }
            
            // Configurar eventos
            setupEventListeners();
            setupMaterialButtonEvents();
            setupReceitaEvents();
            setupVendasEvents();
            inicializarEventosModaisVenda();
            inicializarGerenciadorReceitasVenda();
            
            // Iniciar sincronização
            iniciarSincronizacao();
            
            // Adicionar botão de sincronização
            adicionarBotaoSincronizacao();
            
            // Verificar botões após carregamento
            setTimeout(verificarBotoesFuncionando, 500);
            
            // Iniciar o sistema de monitoramento
            setTimeout(() => {
                sistemaMonitor.iniciar();
                otimizarParaDispositivos();
            }, 1000);
        } else {
            // Usuário não está logado, mostrar tela de login
            mostrarTelaLogin();
        }
    });
    
    // Configurar eventos de login
    const btnLogin = document.getElementById('btn-login');
    if (btnLogin) {
        btnLogin.removeEventListener('click', fazerLogin);
        btnLogin.addEventListener('click', fazerLogin);
    }
    
    const btnCadastrar = document.getElementById('btn-cadastrar');
    if (btnCadastrar) {
        btnCadastrar.removeEventListener('click', fazerCadastro);
        btnCadastrar.addEventListener('click', fazerCadastro);
    }
    
    const btnLogout = document.getElementById('btn-logout');
    if (btnLogout) {
        btnLogout.removeEventListener('click', fazerLogout);
        btnLogout.addEventListener('click', fazerLogout);
    }
});

// Função para verificar se o sistema está em um estado válido
window.verificarSistema = function() {
    console.log("Verificação de sistema iniciada");
    
    // Verificar integridade dos dados
    console.log("Estoque:", estoque.length, "itens");
    console.log("Materiais:", materiais.length, "itens");
    console.log("Receitas:", receitas.length, "itens");
    console.log("Vendas:", vendas.length, "itens");
    
    // Verificar autenticação
    console.log("Usuário autenticado:", currentUser ? currentUser.email : "Não");
    
    // Verificar interfaces
    const paginasAtivas = document.querySelectorAll('.page-content.active');
    console.log("Páginas ativas:", paginasAtivas.length);
    
    // Verificar botões
    verificarBotoesFuncionando();
    
    // Verificar status do monitor
    console.log("Status do monitor:", sistemaMonitor.ultimoEstado);
    
    return {
        usuario: currentUser ? currentUser.email : null,
        estoque: estoque.length,
        materiais: materiais.length,
        receitas: receitas.length,
        vendas: vendas.length,
        paginaAtiva: paginasAtivas.length > 0 ? paginasAtivas[0].id : null,
        paginasTotal: document.querySelectorAll('.page-content').length,
        modaisAbertos: document.querySelectorAll('.modal-overlay:not(.hidden)').length,
        statusSistema: "OK"
    };
};

// Mecanismo de backup e restauração
window.fazerBackup = function() {
    try {
        const dadosBackup = {
            estoque: estoque,
            materiais: materiais,
            receitas: receitas,
            vendas: vendas,
            dataBackup: new Date().toISOString(),
            versao: "2.0"
        };
        
        const jsonBackup = JSON.stringify(dadosBackup);
        const blob = new Blob([jsonBackup], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup_deia_cakes_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 100);
        
        return true;
    } catch (error) {
        console.error("Erro ao fazer backup:", error);
        return false;
    }
};

window.restaurarBackup = function(jsonString) {
    try {
        const dadosBackup = JSON.parse(jsonString);
        
        if (!dadosBackup.estoque || !dadosBackup.materiais || 
            !dadosBackup.receitas || !dadosBackup.vendas) {
            console.error("Arquivo de backup inválido ou incompleto");
            return false;
        }
        
        // Atualizar dados
        estoque = dadosBackup.estoque;
        materiais = dadosBackup.materiais;
        receitas = dadosBackup.receitas;
        vendas = dadosBackup.vendas;
        
        // Inicializar dados para garantir consistência
        inicializarDados();
        
        // Atualizar localStorage
        atualizarLocalStorage();
        
        // Recarregar interfaces
        carregarEstoque();
        carregarMateriais();
        carregarReceitas();
        carregarVendas();
        
        return true;
    } catch (error) {
        console.error("Erro ao restaurar backup:", error);
        return false;
    }
};

// Verificação final do sistema
setTimeout(() => {
    if (window.verificarSistema) {
        window.verificarSistema();
    }
}, 5000);
// Parte 11: JavaScript - Setup e Registro de Múltiplas Receitas na Venda

// Função para carregar detalhes da receita no modal de adicionar receita à venda
function carregarDetalhesReceitaModal() {
    const receitaId = document.getElementById('selecionar-receita-modal').value;
    if (!receitaId) {
        document.getElementById('detalhes-receita-modal').classList.add('hidden');
        return;
    }
    
    const receita = receitas.find(r => r.id === receitaId);
    if (!receita) return;
    
    // Mostrar detalhes
    document.getElementById('detalhes-receita-modal').classList.remove('hidden');
    document.getElementById('nome-receita-selecionada-modal').textContent = receita.nome;
    
    // Calcular custo usando preço médio por g/ml
    const custoProducao = calcularCustoReceita(receita);
    const custosVariados = custoProducao * 0.1;
    
    // Atualizar valores
    document.getElementById('custo-producao-modal').textContent = formatarMoeda(custoProducao);
    document.getElementById('preco-venda-modal').textContent = formatarMoeda(receita.precoVenda || 0);
    
    // Verificar disponibilidade de estoque
    const qtyInput = document.getElementById('quantidade-receita-modal');
    const quantidade = parseInt(qtyInput.value) || 1;
    
    verificarDisponibilidadeEstoqueReceita(receita, quantidade);
}

// Função para adicionar receita à venda
function adicionarReceitaAVenda() {
    const receitaId = document.getElementById('selecionar-receita-modal').value;
    if (!receitaId) return;
    
    const receita = receitas.find(r => r.id === receitaId);
    if (!receita) return;
    
    const quantidade = parseInt(document.getElementById('quantidade-receita-modal').value) || 1;
    const calcularPreco = document.getElementById('calcular-preco-modal').checked;
    
    // Adicionar à lista de receitas na venda
    const receitasContainer = document.getElementById('receitas-venda-container');
    if (!receitasContainer) return;
    
    // Remover notificação inicial se existir
    const notificacao = receitasContainer.querySelector('.notification');
    if (notificacao) {
        receitasContainer.removeChild(notificacao);
    }
    
    // Verificar se a receita já foi adicionada
    const receitaExistente = receitasContainer.querySelector(`.receita-item[data-id="${receitaId}"]`);
    if (receitaExistente) {
        // Atualizar quantidade
        const qtySpan = receitaExistente.querySelector('.receita-quantidade');
        if (qtySpan) {
            qtySpan.textContent = parseInt(qtySpan.textContent) + quantidade;
        }
    } else {
        // Adicionar nova receita
        const receitaItem = document.createElement('div');
        receitaItem.className = 'receita-item';
        receitaItem.setAttribute('data-id', receitaId);
        
        receitaItem.innerHTML = `
            <div class="receita-info">
                <strong>${receita.nome}</strong> - 
                <span class="receita-quantidade">${quantidade}</span> unidade(s)
                <span style="margin-left: 10px; font-size: 0.9em;">
                    (${formatarMoeda(receita.precoVenda)}/un)
                </span>
            </div>
            <div class="receita-acoes">
                <label class="receita-toggle">
                    <input type="checkbox" class="receita-calcular-preco" ${calcularPreco ? 'checked' : ''}>
                    Calcular preço
                </label>
                <button type="button" class="btn btn-danger btn-remover-receita-venda">X</button>
            </div>
        `;
        
        receitasContainer.appendChild(receitaItem);
        
        // Adicionar evento para remover
        const btnRemover = receitaItem.querySelector('.btn-remover-receita-venda');
        if (btnRemover) {
            btnRemover.addEventListener('click', function() {
                receitasContainer.removeChild(receitaItem);
                atualizarResumoFinanceiroVendaMultipla();
                
                // Se não houver mais receitas, mostrar notificação
                if (receitasContainer.querySelectorAll('.receita-item').length === 0) {
                    receitasContainer.innerHTML = `
                        <div class="notification notification-info">
                            Adicione receitas para registrar a venda.
                        </div>
                    `;
                }
            });
        }
        
        // Adicionar evento para o checkbox
        const checkbox = receitaItem.querySelector('.receita-calcular-preco');
        if (checkbox) {
            checkbox.addEventListener('change', atualizarResumoFinanceiroVendaMultipla);
        }
    }
    
    // Fechar modal
    fecharModalAdicionarReceita();
    
    // Atualizar resumo financeiro
    atualizarResumoFinanceiroVendaMultipla();
}

// Função para configurar eventos relacionados ao formulário de venda
function setupFormularioVenda() {
    // Evento para o formulário de venda
    const formVenda = document.getElementById('form-registrar-venda');
    if (formVenda) {
        formVenda.addEventListener('submit', function(e) {
            e.preventDefault();
            confirmarVendaMultiplasReceitas();
        });
    }
    
    // Eventos para os campos de custo
    ['custo-frete', 'custo-decoracao', 'despesas-adicionais'].forEach(id => {
        const campo = document.getElementById(id);
        if (campo) {
            campo.addEventListener('input', atualizarResumoFinanceiroVendaMultipla);
        }
    });
}

// Função para configurar os botões de receitas na venda
function setupBotoesReceitas() {
    // Botão para adicionar receita
    const btnAdicionarReceita = document.getElementById('btn-adicionar-receita-venda');
    if (btnAdicionarReceita) {
        btnAdicionarReceita.addEventListener('click', abrirModalAdicionarReceita);
    }
    
    // Botão para confirmar adição de receita
    const btnConfirmarReceita = document.getElementById('confirmar-adicionar-receita');
    if (btnConfirmarReceita) {
        btnConfirmarReceita.addEventListener('click', adicionarReceitaAVenda);
    }
    
    // Botão para fechar modal
    const btnFecharModal = document.getElementById('fechar-adicionar-receita-modal');
    if (btnFecharModal) {
        btnFecharModal.addEventListener('click', fecharModalAdicionarReceita);
    }
    
    // Eventos no modal
    const selectReceita = document.getElementById('selecionar-receita-modal');
    if (selectReceita) {
        selectReceita.addEventListener('change', carregarDetalhesReceitaModal);
    }
    
    const qtdReceita = document.getElementById('quantidade-receita-modal');
    if (qtdReceita) {
        qtdReceita.addEventListener('input', function() {
            const receitaId = document.getElementById('selecionar-receita-modal').value;
            if (!receitaId) return;
            
            const receita = receitas.find(r => r.id === receitaId);
            if (!receita) return;
            
            const quantidade = parseInt(this.value) || 1;
            verificarDisponibilidadeEstoqueReceita(receita, quantidade);
        });
    }
}

// Parte 12: JavaScript - Modificações Específicas das Solicitações

// Função para corrigir datas com fuso horário
function corrigirDatasFusoHorario() {
    // Ajustar data atual para input de data
    document.querySelectorAll('input[type="date"]').forEach(input => {
        if (!input.value) {
            const hoje = new Date();
            // Ajustando para o fuso horário local
            const dataLocal = new Date(hoje.getTime() - (hoje.getTimezoneOffset() * 60000));
            input.value = dataLocal.toISOString().split('T')[0];
        }
    });
    
    // Corrigir todas as datas nas vendas
    vendas.forEach(venda => {
        if (venda.data) {
            try {
                const data = new Date(venda.data);
                // Ajuste para compensar fuso horário
                const dataCorrigida = new Date(data.getTime() + (data.getTimezoneOffset() * 60000));
                venda.data = dataCorrigida.toISOString();
            } catch (e) {
                console.error("Erro ao corrigir data de venda:", e);
            }
        }
    });
    
    // Corrigir datas nos materiais
    materiais.forEach(material => {
        if (material.ultimaCompra) {
            try {
                const data = new Date(material.ultimaCompra);
                const dataCorrigida = new Date(data.getTime() + (data.getTimezoneOffset() * 60000));
                material.ultimaCompra = dataCorrigida.toISOString();
            } catch (e) {
                console.error("Erro ao corrigir data de material:", e);
            }
        }
        
        // Corrigir datas no histórico de preços
        if (material.historicoPrecos && Array.isArray(material.historicoPrecos)) {
            material.historicoPrecos.forEach(registro => {
                if (registro.data) {
                    try {
                        const data = new Date(registro.data);
                        const dataCorrigida = new Date(data.getTime() + (data.getTimezoneOffset() * 60000));
                        registro.data = dataCorrigida.toISOString();
                    } catch (e) {
                        console.error("Erro ao corrigir data no histórico de preços:", e);
                    }
                }
            });
        }
    });
}

// Função para adicionar eventos de login/logout
function setupLoginLogout() {
    // Evento para fazer login
    const btnLogin = document.getElementById('btn-login');
    if (btnLogin) {
        // Verificar se o botão já tem o evento
        const novoBtn = btnLogin.cloneNode(true);
        btnLogin.parentNode.replaceChild(novoBtn, btnLogin);
        novoBtn.addEventListener('click', fazerLogin);
    }
    
    // Evento para cadastrar
    const btnCadastrar = document.getElementById('btn-cadastrar');
    if (btnCadastrar) {
        btnCadastrar.removeEventListener('click', fazerCadastro);
        btnCadastrar.addEventListener('click', fazerCadastro);
    }
    
    // Evento para fazer logout
    const btnLogout = document.getElementById('btn-logout');
    if (btnLogout) {
        btnLogout.removeEventListener('click', fazerLogout);
        btnLogout.addEventListener('click', fazerLogout);
    }
}

// Função para corrigir despesas adicionais
function corrigirDespesasAdicionais() {
    vendas.forEach(venda => {
        // Verificar se temos o valor original da despesa adicional
        if (venda.despesasAdicionaisOriginal !== undefined) {
            // Calcular o valor do acréscimo (10%)
            const acrescimo = venda.despesasAdicionaisOriginal * 0.1;
            // Atualizar o valor com acréscimo
            venda.despesasAdicionaisComAcrescimo = venda.despesasAdicionaisOriginal + acrescimo;
            // Atualizar o total de despesas adicionais
            venda.totalDespesasAdicionais = venda.despesasAdicionaisComAcrescimo + 
                                         (venda.custoFrete || 0) + 
                                         (venda.custoDecoracao || 0);
            
            // Recalcular o lucro
            if (venda.valorTotal !== undefined && venda.despesa !== undefined) {
                venda.lucro = venda.valorTotal - venda.despesa - venda.valorReinvestir - venda.totalDespesasAdicionais;
            }
        }
    });
}

// Parte 13: JavaScript - Utilitários Adicionais

// Função para verificar disponibilidade de estoque para uma receita
function verificarDisponibilidadeEstoqueReceita(receita, quantidade) {
    if (!receita || !receita.ingredientes || !quantidade) return;
    
    const avisoEstoque = document.getElementById('aviso-estoque-modal');
    if (!avisoEstoque) return;
    
    // Verificar estoque
    const estoqueUnificado = unificarEstoque();
    let disponibilidadeOk = true;
    let mensagensErro = [];
    
    for (const ingrediente of receita.ingredientes) {
        const material = materiais.find(m => m.id === ingrediente.materialId);
        if (!material) {
            mensagensErro.push(`Material não encontrado para o ingrediente ${ingrediente.materialId}`);
            disponibilidadeOk = false;
            continue;
        }
        
        // Quantidade necessária
        const quantidadeNecessaria = ingrediente.quantidade * quantidade;
        
        // Encontrar o material no estoque
        let materialEstoque = null;
        
        // Procurar primeiro por código
        if (material.codigo) {
            materialEstoque = estoqueUnificado.find(item => {
                const itemMaterial = materiais.find(m => m.id === item.materialId);
                return itemMaterial && itemMaterial.codigo === material.codigo;
            });
        }
        
        // Se não encontrou por código, tenta por nome
        if (!materialEstoque) {
            materialEstoque = estoqueUnificado.find(item => 
                item.nome && item.nome.toLowerCase() === material.nome.toLowerCase());
        }
        
        if (!materialEstoque) {
            mensagensErro.push(`Material ${material.nome} não encontrado no estoque`);
            disponibilidadeOk = false;
            continue;
        }
        
        // Verificar quantidade
        let quantidadeNormalizada = quantidadeNecessaria;
        
        // Converter KG para g, L para ml se necessário
        if (ingrediente.unidadeMedida.toLowerCase() === 'kg' && materialEstoque.unidadeMedida.toLowerCase() === 'g') {
            quantidadeNormalizada *= 1000;
        } else if (ingrediente.unidadeMedida.toLowerCase() === 'l' && materialEstoque.unidadeMedida.toLowerCase() === 'ml') {
            quantidadeNormalizada *= 1000;
        } else if (ingrediente.unidadeMedida.toLowerCase() === 'g' && materialEstoque.unidadeMedida.toLowerCase() === 'kg') {
            quantidadeNormalizada /= 1000;
        } else if (ingrediente.unidadeMedida.toLowerCase() === 'ml' && materialEstoque.unidadeMedida.toLowerCase() === 'l') {
            quantidadeNormalizada /= 1000;
        }
        
        // Converter para unidades do estoque
        const quantidadeEmUnidades = quantidadeNormalizada / (materialEstoque.quantidadeMedida || 1);
        
        if (materialEstoque.quantidade < quantidadeEmUnidades) {
            mensagensErro.push(`Quantidade insuficiente de ${material.nome}: necessário ${quantidadeNecessaria} ${ingrediente.unidadeMedida}, disponível ${materialEstoque.quantidade} ${materialEstoque.unidade}`);
            disponibilidadeOk = false;
        }
    }
    
    // Atualizar aviso
    if (disponibilidadeOk) {
        avisoEstoque.className = 'notification notification-success';
        avisoEstoque.textContent = 'Todos os ingredientes estão disponíveis em estoque.';
    } else {
        avisoEstoque.className = 'notification notification-error';
        avisoEstoque.innerHTML = `Atenção: Alguns ingredientes não estão disponíveis em quantidade suficiente!<br>${mensagensErro.join('<br>')}`;
    }
    
    avisoEstoque.classList.remove('hidden');
}

// Função para gerar relatório de cálculos de uma venda
function gerarRelatorioCalculosVenda(venda) {
    if (!venda) return "Venda não encontrada";
    
    let relatorio = "RELATÓRIO DE CÁLCULOS DA VENDA\n\n";
    
    // Detalhes da venda
    relatorio += `ID da Venda: ${venda.id}\n`;
    relatorio += `Data: ${formatarData(venda.data)}\n`;
    relatorio += `Cliente: ${venda.cliente.nome}\n\n`;
    
    // Receitas
    relatorio += "RECEITAS:\n";
    
    if (venda.receitas && venda.receitas.length > 0) {
        // Nova estrutura com múltiplas receitas
        venda.receitas.forEach(receitaVenda => {
            const receita = receitas.find(r => r.id === receitaVenda.id);
            if (!receita) return;
            
            relatorio += `- ${receita.nome} (${receitaVenda.quantidade} un.)\n`;
            
            if (receitaVenda.calcularPreco) {
                relatorio += `  Preço Unitário: ${formatarMoeda(receita.precoVenda)}\n`;
                relatorio += `  Custo Produção (un.): ${formatarMoeda(receitaVenda.custoProducao)}\n`;
                relatorio += `  Custos Variados (un.): ${formatarMoeda(receitaVenda.custosVariados)}\n`;
                relatorio += `  Subtotal: ${formatarMoeda(receita.precoVenda * receitaVenda.quantidade)}\n`;
            } else {
                relatorio += `  (Receita sem cálculo de preço)\n`;
            }
            
            relatorio += "\n";
        });
    } else if (venda.receitaId) {
        // Compatibilidade com vendas antigas
        const receita = receitas.find(r => r.id === venda.receitaId);
        
        relatorio += `- ${venda.receitaNome || (receita ? receita.nome : "Desconhecida")} (${venda.quantidade} un.)\n`;
        relatorio += `  Preço Unitário: ${formatarMoeda(venda.precoVenda)}\n`;
        relatorio += `  Custo Produção (un.): ${formatarMoeda(venda.custoProducao)}\n`;
        relatorio += `  Custos Variados (un.): ${formatarMoeda(venda.custosVariados)}\n`;
        relatorio += `  Subtotal: ${formatarMoeda(venda.precoVenda * venda.quantidade)}\n\n`;
    }
    
    // Custos adicionais
    relatorio += "CUSTOS ADICIONAIS:\n";
    relatorio += `- Frete: ${formatarMoeda(venda.custoFrete || 0)}\n`;
    relatorio += `- Decoração: ${formatarMoeda(venda.custoDecoracao || 0)}\n`;
    relatorio += `- Despesas Adicionais: ${formatarMoeda(venda.despesasAdicionaisOriginal || 0)}\n`;
    relatorio += `- Acréscimo (10%): ${formatarMoeda((venda.despesasAdicionaisOriginal || 0) * 0.1)}\n`;
    relatorio += `- Total Despesas Adicionais: ${formatarMoeda(venda.totalDespesasAdicionais || 0)}\n\n`;
    
    // Resumo financeiro
    relatorio += "RESUMO FINANCEIRO:\n";
    relatorio += `- Valor Total: ${formatarMoeda(venda.valorTotal || 0)}\n`;
    relatorio += `- Despesa: ${formatarMoeda(venda.despesa || 0)}\n`;
    relatorio += `- Reinvestir: ${formatarMoeda(venda.valorReinvestir || 0)}\n`;
    relatorio += `- Total Despesas Adicionais: ${formatarMoeda(venda.totalDespesasAdicionais || 0)}\n`;
    relatorio += `- Lucro: ${formatarMoeda(venda.lucro || 0)}\n`;
    
    return relatorio;
}

// Parte 14: JavaScript - Inicialização e Configuração Final

// Função para inicializar o sistema
function inicializarSistema() {
    console.log("Inicializando sistema...");
    
    // Inicializar dados
    inicializarDados();
    
    // Corrigir datas
    corrigirDatasFusoHorario();
    
    // Corrigir despesas adicionais
    corrigirDespesasAdicionais();
    
    // Configurar eventos
    setupEventListeners();
    setupMaterialButtonEvents();
    setupReceitaEvents();
    setupVendasEvents();
    setupFormularioVenda();
    setupBotoesReceitas();
    setupLoginLogout();
    
    // Carregar interfaces
    carregarEstoque();
    carregarMateriais();
    carregarReceitas();
    carregarVendas();
    
    // Iniciar monitores
    setTimeout(() => {
        sistemaMonitor.iniciar();
        otimizarParaDispositivos();
    }, 1000);
    
    console.log("Sistema inicializado com sucesso!");
}

// Configuração para exportar/importar dados
function configurarExportacaoImportacao() {
    // Função para exportar dados
    window.exportarDados = function() {
        try {
            const dados = {
                estoque: estoque,
                materiais: materiais,
                receitas: receitas,
                vendas: vendas,
                versao: "2.0",
                dataExportacao: new Date().toISOString()
            };
            
            // Converter para JSON
            const jsonString = JSON.stringify(dados, null, 2);
            
            // Criar elemento para download
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `deia_cakes_dados_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            
            // Limpar
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
            
            return true;
        } catch (error) {
            console.error("Erro ao exportar dados:", error);
            return false;
        }
    };
    
    // Função para importar dados
    window.importarDados = function(jsonString) {
        try {
            const dados = JSON.parse(jsonString);
            
            // Verificar se os dados são válidos
            if (!dados.estoque || !dados.materiais || !dados.receitas || !dados.vendas) {
                throw new Error("Arquivo de dados inválido");
            }
            
            // Fazer backup dos dados atuais
            const backup = {
                estoque: [...estoque],
                materiais: [...materiais],
                receitas: [...receitas],
                vendas: [...vendas]
            };
            
            try {
                // Atualizar dados
                estoque = dados.estoque;
                materiais = dados.materiais;
                receitas = dados.receitas;
                vendas = dados.vendas;
                
                // Inicializar dados
                inicializarDados();
                
                // Atualizar localStorage
                atualizarLocalStorage();
                
                // Recarregar interfaces
                carregarEstoque();
                carregarMateriais();
                carregarReceitas();
                carregarVendas();
                
                return true;
            } catch (importError) {
                // Restaurar backup em caso de erro
                estoque = backup.estoque;
                materiais = backup.materiais;
                receitas = backup.receitas;
                vendas = backup.vendas;
                
                atualizarLocalStorage();
                
                throw importError;
            }
        } catch (error) {
            console.error("Erro ao importar dados:", error);
            return false;
        }
    };
}

// Inicialização quando o documento estiver pronto
document.addEventListener('DOMContentLoaded', function() {
    console.log("Documento carregado, verificando autenticação...");
    
    // Carregar dados do localStorage
    try {
        estoque = JSON.parse(localStorage.getItem('estoque')) || [];
        materiais = JSON.parse(localStorage.getItem('materiais')) || [];
        receitas = JSON.parse(localStorage.getItem('receitas')) || [];
        vendas = JSON.parse(localStorage.getItem('vendas')) || [];
    } catch (e) {
        console.error('Erro ao carregar dados do localStorage:', e);
        estoque = [];
        materiais = [];
        receitas = [];
        vendas = [];
    }
    
    // Configurar funções de exportação/importação
    configurarExportacaoImportacao();
    
    // Verificar autenticação
    firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
            console.log("Usuário autenticado:", user.email);
            currentUser = user;
            
            // Mostrar informações do usuário
            const userInfoEl = document.getElementById('user-info');
            if (userInfoEl) {
                userInfoEl.classList.remove('hidden');
                document.getElementById('user-email').textContent = user.email;
            }
            
            // Adicionar botão de sincronização
            adicionarBotaoSincronizacao();
            
            // Iniciar sincronização e inicializar sistema
            iniciarSincronizacao().then(() => {
                inicializarSistema();
            });
        } else {
            console.log("Usuário não autenticado");
            currentUser = null;
            mostrarTelaLogin();
        }
    });
});

// Parte 15: JavaScript - Funções de Relatórios e Análises

// Função para gerar relatório de vendas em um período
function gerarRelatorioVendas(dataInicio, dataFim) {
    // Filtrar vendas no período
    const vendasFiltradas = vendas.filter(venda => {
        const dataVenda = new Date(venda.data);
        const inicio = dataInicio ? new Date(dataInicio) : new Date(0);
        const fim = dataFim ? new Date(dataFim) : new Date();
        fim.setHours(23, 59, 59, 999); // Até o final do dia
        
        return dataVenda >= inicio && dataVenda <= fim;
    });
    
    if (vendasFiltradas.length === 0) {
        return "Nenhuma venda encontrada no período.";
    }
    
    let relatorio = "RELATÓRIO DE VENDAS\n\n";
    relatorio += `Período: ${dataInicio ? formatarData(dataInicio) : 'Início'} a ${dataFim ? formatarData(dataFim) : 'Hoje'}\n\n`;
    
    // Totais
    let totalVendas = 0;
    let totalReceitas = 0;
    let totalCustoProducao = 0;
    let totalCustosVariados = 0;
    let totalDespesasAdicionais = 0;
    let totalLucro = 0;
    
    // Mapa de receitas vendidas
    const receitasVendidas = new Map();
    
    // Processar vendas
    vendasFiltradas.forEach(venda => {
        totalVendas += venda.valorTotal || 0;
        totalCustoProducao += venda.custoProducaoTotal || 0;
        totalCustosVariados += venda.custosVariadosTotal || 0;
        totalDespesasAdicionais += venda.totalDespesasAdicionais || 0;
        totalLucro += venda.lucro || 0;
        
        // Contar receitas vendidas
        if (venda.receitas && venda.receitas.length > 0) {
            venda.receitas.forEach(receitaVenda => {
                const receitaId = receitaVenda.id;
                const quantidade = receitaVenda.quantidade;
                
                if (!receitasVendidas.has(receitaId)) {
                    receitasVendidas.set(receitaId, {
                        nome: receitaVenda.nome,
                        quantidade: 0,
                        valor: 0
                    });
                }
                
                const info = receitasVendidas.get(receitaId);
                info.quantidade += quantidade;
                info.valor += receitaVenda.precoVenda * quantidade;
                receitasVendidas.set(receitaId, info);
                
                totalReceitas++;
            });
        } else if (venda.receitaId) {
            // Compatibilidade com vendas antigas
            const receitaId = venda.receitaId;
            const quantidade = venda.quantidade || 1;
            
            if (!receitasVendidas.has(receitaId)) {
                receitasVendidas.set(receitaId, {
                    nome: venda.receitaNome,
                    quantidade: 0,
                    valor: 0
                });
            }
            
            const info = receitasVendidas.get(receitaId);
            info.quantidade += quantidade;
            info.valor += venda.precoVenda * quantidade;
            receitasVendidas.set(receitaId, info);
            
            totalReceitas++;
        }
    });
    
    // Resumo geral
    relatorio += "RESUMO GERAL\n";
    relatorio += `Número de Vendas: ${vendasFiltradas.length}\n`;
    relatorio += `Receitas Vendidas: ${totalReceitas}\n`;
    relatorio += `Valor Total: ${formatarMoeda(totalVendas)}\n`;
    relatorio += `Custo de Produção: ${formatarMoeda(totalCustoProducao)}\n`;
    relatorio += `Custos Variados: ${formatarMoeda(totalCustosVariados)}\n`;
    relatorio += `Despesas Adicionais: ${formatarMoeda(totalDespesasAdicionais)}\n`;
    relatorio += `Lucro Total: ${formatarMoeda(totalLucro)}\n`;
    relatorio += `Margem de Lucro: ${((totalLucro / totalVendas) * 100).toFixed(2)}%\n\n`;
    // Relatório das receitas mais vendidas
    relatorio += "\nRECEITAS MAIS VENDIDAS\n";
    
    // Converter mapa para array e ordenar
    const receitasArray = Array.from(receitasVendidas.entries())
        .map(([id, info]) => ({ id, ...info }))
        .sort((a, b) => b.quantidade - a.quantidade);
    
    receitasArray.forEach((receita, index) => {
        relatorio += `${index + 1}. ${receita.nome} - ${receita.quantidade} unidades - ${formatarMoeda(receita.valor)}\n`;
    });
    
    // Detalhes de cada venda
    relatorio += "\nDETALHES DAS VENDAS\n";
    
    vendasFiltradas.forEach((venda, index) => {
        relatorio += `\n--- Venda #${index + 1} ---\n`;
        relatorio += `Data: ${formatarData(venda.data)}\n`;
        relatorio += `Cliente: ${venda.cliente.nome}\n`;
        
        // Listar receitas
        if (venda.receitas && venda.receitas.length > 0) {
            relatorio += "Receitas:\n";
            venda.receitas.forEach(receitaVenda => {
                relatorio += `- ${receitaVenda.nome} (${receitaVenda.quantidade} un.) - ${formatarMoeda(receitaVenda.precoVenda * receitaVenda.quantidade)}\n`;
            });
        } else if (venda.receitaNome) {
            relatorio += `Receita: ${venda.receitaNome} (${venda.quantidade} un.) - ${formatarMoeda(venda.precoVenda * venda.quantidade)}\n`;
        }
        
        // Valores
        relatorio += `Valor Total: ${formatarMoeda(venda.valorTotal)}\n`;
        relatorio += `Lucro: ${formatarMoeda(venda.lucro)}\n`;
    });
    
    return relatorio;
}

// Função para gerar relatório de ingredientes mais utilizados
function gerarRelatorioIngredientes() {
    // Mapa para rastrear uso de ingredientes
    const ingredientesUso = new Map();
    
    // Processar todas as vendas
    vendas.forEach(venda => {
        let receitasVendidas = [];
        
        // Obter as receitas da venda
        if (venda.receitas && venda.receitas.length > 0) {
            // Nova estrutura
            receitasVendidas = venda.receitas.map(rv => ({
                id: rv.id,
                quantidade: rv.quantidade,
                calcularPreco: rv.calcularPreco
            }));
        } else if (venda.receitaId) {
            // Estrutura antiga
            receitasVendidas = [{
                id: venda.receitaId,
                quantidade: venda.quantidade || 1,
                calcularPreco: true
            }];
        }
        
        // Processar cada receita
        receitasVendidas.forEach(receitaVenda => {
            if (!receitaVenda.calcularPreco) return;
            
            const receita = receitas.find(r => r.id === receitaVenda.id);
            if (!receita || !receita.ingredientes) return;
            
            // Processar ingredientes
            receita.ingredientes.forEach(ingrediente => {
                const material = materiais.find(m => m.id === ingrediente.materialId);
                if (!material) return;
                
                const key = material.nome;
                const quantidadeTotal = ingrediente.quantidade * receitaVenda.quantidade;
                
                if (!ingredientesUso.has(key)) {
                    ingredientesUso.set(key, {
                        material: material,
                        quantidade: 0,
                        unidadeMedida: ingrediente.unidadeMedida,
                        custo: 0
                    });
                }
                
                const info = ingredientesUso.get(key);
                
                // Normalizar unidades se necessário
                let quantidadeNormalizada = quantidadeTotal;
                
                if (ingrediente.unidadeMedida !== info.unidadeMedida) {
                    // Converter para a unidade já registrada
                    if (ingrediente.unidadeMedida.toLowerCase() === 'kg' && info.unidadeMedida.toLowerCase() === 'g') {
                        quantidadeNormalizada *= 1000;
                    } else if (ingrediente.unidadeMedida.toLowerCase() === 'l' && info.unidadeMedida.toLowerCase() === 'ml') {
                        quantidadeNormalizada *= 1000;
                    } else if (ingrediente.unidadeMedida.toLowerCase() === 'g' && info.unidadeMedida.toLowerCase() === 'kg') {
                        quantidadeNormalizada /= 1000;
                    } else if (ingrediente.unidadeMedida.toLowerCase() === 'ml' && info.unidadeMedida.toLowerCase() === 'l') {
                        quantidadeNormalizada /= 1000;
                    }
                }
                
                info.quantidade += quantidadeNormalizada;
                
                // Calcular custo baseado no preço médio por g/ml
                const precoMedioPorGramaMl = material.precoMedioPorGramaMl || 
                                            (material.precoMedio / (material.quantidadeMedida || 1));
                
                info.custo += precoMedioPorGramaMl * quantidadeNormalizada;
                
                ingredientesUso.set(key, info);
            });
        });
    });
    
    // Gerar o relatório
    let relatorio = "RELATÓRIO DE INGREDIENTES UTILIZADOS\n\n";
    
    // Ordenar ingredientes por quantidade utilizada
    const ingredientesArray = Array.from(ingredientesUso.entries())
        .map(([nome, info]) => ({ nome, ...info }))
        .sort((a, b) => b.quantidade - a.quantidade);
    
    // Total de custos
    let custoTotal = 0;
    ingredientesArray.forEach(item => {
        custoTotal += item.custo;
    });
    
    relatorio += `Total de Ingredientes Diferentes: ${ingredientesArray.length}\n`;
    relatorio += `Custo Total: ${formatarMoeda(custoTotal)}\n\n`;
    
    // Listar ingredientes
    relatorio += "INGREDIENTES POR QUANTIDADE UTILIZADA:\n";
    
    ingredientesArray.forEach((item, index) => {
        relatorio += `${index + 1}. ${item.nome} - ${item.quantidade.toFixed(2)} ${item.unidadeMedida} - ${formatarMoeda(item.custo)}\n`;
    });
    
    return relatorio;
}

// Função para gerar análise de lucratividade
function gerarAnaliseRentabilidade() {
    // Filtrar apenas vendas válidas
    const vendasValidas = vendas.filter(v => v.valorTotal && v.lucro !== undefined);
    
    if (vendasValidas.length === 0) {
        return "Não há vendas suficientes para análise.";
    }
    
    // Mapa para estatísticas por receita
    const estatisticasReceitas = new Map();
    
    // Processar vendas
    vendasValidas.forEach(venda => {
        if (venda.receitas && venda.receitas.length > 0) {
            // Nova estrutura
            venda.receitas.forEach(receitaVenda => {
                if (!receitaVenda.calcularPreco) return;
                
                const receitaId = receitaVenda.id;
                
                if (!estatisticasReceitas.has(receitaId)) {
                    estatisticasReceitas.set(receitaId, {
                        nome: receitaVenda.nome,
                        quantidade: 0,
                        valorTotal: 0,
                        custoTotal: 0,
                        lucroTotal: 0
                    });
                }
                
                const stats = estatisticasReceitas.get(receitaId);
                stats.quantidade += receitaVenda.quantidade;
                stats.valorTotal += receitaVenda.precoVenda * receitaVenda.quantidade;
                stats.custoTotal += (receitaVenda.custoProducao + receitaVenda.custosVariados) * receitaVenda.quantidade;
                
                // Lucro proporcional à receita (simplificação)
                const proporcaoValor = (receitaVenda.precoVenda * receitaVenda.quantidade) / venda.valorTotal;
                stats.lucroTotal += venda.lucro * proporcaoValor;
                
                estatisticasReceitas.set(receitaId, stats);
            });
        } else if (venda.receitaId) {
            // Estrutura antiga
            const receitaId = venda.receitaId;
            
            if (!estatisticasReceitas.has(receitaId)) {
                estatisticasReceitas.set(receitaId, {
                    nome: venda.receitaNome,
                    quantidade: 0,
                    valorTotal: 0,
                    custoTotal: 0,
                    lucroTotal: 0
                });
            }
            
            const stats = estatisticasReceitas.get(receitaId);
            stats.quantidade += venda.quantidade || 1;
            stats.valorTotal += venda.valorTotal;
            stats.custoTotal += (venda.custoProducao + venda.custosVariados) * (venda.quantidade || 1);
            stats.lucroTotal += venda.lucro;
            
            estatisticasReceitas.set(receitaId, stats);
        }
    });
    
    // Gerar o relatório
    let relatorio = "ANÁLISE DE RENTABILIDADE POR RECEITA\n\n";
    
    // Estatísticas gerais
    let totalVendas = 0;
    let totalCusto = 0;
    let totalLucro = 0;
    
    estatisticasReceitas.forEach(stats => {
        totalVendas += stats.valorTotal;
        totalCusto += stats.custoTotal;
        totalLucro += stats.lucroTotal;
    });
    
    relatorio += "RESUMO GERAL\n";
    relatorio += `Valor Total de Vendas: ${formatarMoeda(totalVendas)}\n`;
    relatorio += `Custo Total: ${formatarMoeda(totalCusto)}\n`;
    relatorio += `Lucro Total: ${formatarMoeda(totalLucro)}\n`;
    relatorio += `Margem de Lucro Média: ${((totalLucro / totalVendas) * 100).toFixed(2)}%\n\n`;
    
    // Ordenar receitas por lucro
    const receitasArray = Array.from(estatisticasReceitas.entries())
        .map(([id, stats]) => ({ id, ...stats }))
        .sort((a, b) => b.lucroTotal - a.lucroTotal);
    
    relatorio += "RECEITAS POR RENTABILIDADE:\n";
    
    receitasArray.forEach((receita, index) => {
        const margemLucro = (receita.lucroTotal / receita.valorTotal) * 100;
        
        relatorio += `${index + 1}. ${receita.nome}\n`;
        relatorio += `   Quantidade Vendida: ${receita.quantidade} unidades\n`;
        relatorio += `   Valor Total: ${formatarMoeda(receita.valorTotal)}\n`;
        relatorio += `   Custo Total: ${formatarMoeda(receita.custoTotal)}\n`;
        relatorio += `   Lucro Total: ${formatarMoeda(receita.lucroTotal)}\n`;
        relatorio += `   Margem de Lucro: ${margemLucro.toFixed(2)}%\n`;
        relatorio += `   Lucro Médio por Unidade: ${formatarMoeda(receita.lucroTotal / receita.quantidade)}\n\n`;
    });
    
    return relatorio;
}

// Parte 16: JavaScript - Funcionalidades de Backup e Restauração

// Função para fazer backup dos dados
function criarBackupDados() {
    try {
        // Estrutura de dados do backup
        const dadosBackup = {
            estoque: estoque,
            materiais: materiais,
            receitas: receitas,
            vendas: vendas,
            dataBackup: new Date().toISOString(),
            versaoApp: "2.0.0"
        };
        
        // Converter para JSON
        const jsonBackup = JSON.stringify(dadosBackup, null, 2);
        
        // Criar blob e link para download
        const blob = new Blob([jsonBackup], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup_deia_cakes_${new Date().toISOString().split('T')[0].replace(/-/g, '')}.json`;
        document.body.appendChild(a);
        a.click();
        
        // Limpar
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 100);
        
        console.log("Backup criado com sucesso!");
        return true;
    } catch (error) {
        console.error("Erro ao criar backup:", error);
        return false;
    }
}

// Função para restaurar dados a partir de um backup
function restaurarDadosDeBackup(jsonString) {
    try {
        // Backup dos dados atuais (para caso de falha)
        const backupAtual = {
            estoque: [...estoque],
            materiais: [...materiais],
            receitas: [...receitas],
            vendas: [...vendas]
        };
        
        // Interpretar o JSON
        const dadosBackup = JSON.parse(jsonString);
        
        // Verificar se o backup é válido
        if (!dadosBackup.estoque || !dadosBackup.materiais || 
            !dadosBackup.receitas || !dadosBackup.vendas) {
            console.error("Backup inválido: estrutura incompleta");
            return false;
        }
        
        try {
            // Aplicar os dados do backup
            estoque = dadosBackup.estoque;
            materiais = dadosBackup.materiais;
            receitas = dadosBackup.receitas;
            vendas = dadosBackup.vendas;
            
            // Garantir que os dados estão no formato correto
            inicializarDados();
            
            // Atualizar localStorage e sincronizar
            atualizarLocalStorage();
            
            // Recarregar interfaces
            carregarEstoque();
            carregarMateriais();
            carregarReceitas();
            carregarVendas();
            
            console.log("Backup restaurado com sucesso!");
            return true;
        } catch (error) {
            console.error("Erro durante a restauração:", error);
            
            // Reverter para os dados originais
            estoque = backupAtual.estoque;
            materiais = backupAtual.materiais;
            receitas = backupAtual.receitas;
            vendas = backupAtual.vendas;
            
            atualizarLocalStorage();
            return false;
        }
    } catch (error) {
        console.error("Erro ao restaurar backup:", error);
        return false;
    }
}

// Implementação da interface de backup e restauração
function implementarInterfaceBackupRestauracao() {
    // Criar botão de backup
    const criarBotaoBackup = () => {
        const btn = document.createElement('button');
        btn.id = 'btn-backup';
        btn.className = 'btn btn-primary';
        btn.innerHTML = '↓ Backup';
        btn.style.position = 'fixed';
        btn.style.bottom = '80px';
        btn.style.right = '20px';
        btn.style.zIndex = '999';
        btn.style.borderRadius = '50%';
        btn.style.width = '60px';
        btn.style.height = '60px';
        btn.style.fontSize = '12px';
        btn.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
        
        btn.addEventListener('click', criarBackupDados);
        
        document.body.appendChild(btn);
    };
    
    // Criar botão de restauração
    const criarBotaoRestauracao = () => {
        const btn = document.createElement('button');
        btn.id = 'btn-restaurar';
        btn.className = 'btn btn-secondary';
        btn.innerHTML = '↑ Restaurar';
        btn.style.position = 'fixed';
        btn.style.bottom = '140px';
        btn.style.right = '20px';
        btn.style.zIndex = '999';
        btn.style.borderRadius = '50%';
        btn.style.width = '60px';
        btn.style.height = '60px';
        btn.style.fontSize = '12px';
        btn.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
        
        btn.addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    
                    reader.onload = function(event) {
                        const jsonString = event.target.result;
                        restaurarDadosDeBackup(jsonString);
                    };
                    
                    reader.readAsText(file);
                }
            });
            
            input.click();
        });
        
        document.body.appendChild(btn);
    };
    
    // Verificar se os botões já existem e criar se necessário
    if (!document.getElementById('btn-backup')) {
        criarBotaoBackup();
    }
    
    if (!document.getElementById('btn-restaurar')) {
        criarBotaoRestauracao();
    }
}

// Parte 17: JavaScript - Otimizações para Mobile e Performance

// Otimizações para interface mobile
function otimizarInterfaceMobile() {
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    if (isMobile) {
        console.log("Aplicando otimizações para dispositivo móvel...");
        
        // Adicionar estilos específicos para mobile
        const mobileStyles = document.createElement('style');
        mobileStyles.type = 'text/css';
        mobileStyles.innerHTML = `
            @media (max-width: 768px) {
                /* Ajustes gerais */
                body { font-size: 14px; }
                .btn { padding: 8px 16px; margin-bottom: 5px; }
                
                /* Layout adaptativo */
                .form-row { flex-direction: column; }
                .form-col { margin-bottom: 10px; width: 100%; }
                
                /* Tabelas */
                table { display: block; overflow-x: auto; }
                
                /* Modais */
                .modal-content { width: 95% !important; max-width: 95% !important; }
                
                /* Resumo financeiro */
                .venda-resumo-grid { grid-template-columns: repeat(2, 1fr); }
                
                /* Itens de receita na venda */
                .receita-item { flex-direction: column; }
                .receita-acoes { margin-top: 10px; display: flex; justify-content: space-between; }
                
                /* Botões flutuantes */
                #btn-sync, #btn-backup, #btn-restaurar {
                    width: 50px;
                    height: 50px;
                    font-size: 10px;
                }
            }
        `;
        
        document.head.appendChild(mobileStyles);
        
        // Aumentar área de toque nos elementos interativos
        document.querySelectorAll('.btn, .nav-link, .tab-button, select, input[type="checkbox"]').forEach(el => {
            el.style.minHeight = '44px';
            
            if (el.tagName === 'INPUT' && el.type === 'checkbox') {
                el.style.transform = 'scale(1.2)';
                el.style.margin = '8px';
            }
        });
        
        // Adicionar meta viewport para garantir responsividade
        let viewport = document.querySelector('meta[name="viewport"]');
        if (!viewport) {
            viewport = document.createElement('meta');
            viewport.name = 'viewport';
            document.head.appendChild(viewport);
        }
        viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
        
        // Otimizar gestos de toque
        document.addEventListener('touchstart', function() {}, {passive: true});
    }
}

// Otimizações de performance
function otimizarPerformance() {
    console.log("Aplicando otimizações de performance...");
    
    // Limitar o tamanho máximo das listas
    const MAX_ITEMS_DISPLAY = 100;
    
    // Função para renderizar grandes listas de forma otimizada
    window.renderizarListaOtimizada = function(container, items, renderFunc, limit = MAX_ITEMS_DISPLAY) {
        if (!container) return;
        
        // Limpar container
        container.innerHTML = '';
        
        // Verificar se há muitos itens
        if (items.length > limit) {
            console.log(`Lista muito grande (${items.length} itens), limitando a ${limit}`);
            // Adicionar aviso
            const aviso = document.createElement('div');
            aviso.className = 'notification notification-info';
            aviso.textContent = `Mostrando ${limit} de ${items.length} itens. Use a pesquisa para filtrar.`;
            container.appendChild(aviso);
            
            // Renderizar apenas os primeiros itens
            items.slice(0, limit).forEach(renderFunc);
        } else {
            // Renderizar todos os itens
            items.forEach(renderFunc);
        }
    };
    
    // Otimizar eventos de scroll
    let scrollTimeout;
    window.addEventListener('scroll', function() {
        if (scrollTimeout) {
            clearTimeout(scrollTimeout);
        }
        
        scrollTimeout = setTimeout(function() {
            // Verificar elementos visíveis e otimizar renderização
            document.querySelectorAll('.page-content.active').forEach(page => {
                const rect = page.getBoundingClientRect();
                if (rect.top < window.innerHeight && rect.bottom > 0) {
                    // Página visível, otimizar elementos fora da tela
                    page.querySelectorAll('.card, .sale-card, .recipe-card').forEach(card => {
                        const cardRect = card.getBoundingClientRect();
                        if (cardRect.top > window.innerHeight || cardRect.bottom < 0) {
                            card.style.visibility = 'hidden';
                        } else {
                            card.style.visibility = 'visible';
                        }
                    });
                }
            });
        }, 100);
    }, { passive: true });
    
    // Reduzir processamento em operações pesadas
    const operacoesPesadas = ['unificarEstoque', 'calcularCustoReceita', 'atualizarCalculosReceita'];
    
    operacoesPesadas.forEach(funcName => {
        if (typeof window[funcName] === 'function') {
            var funcOriginal = window[funcName];
            
            window[funcName] = function(...args) {
                // Verificar se a função já foi chamada recentemente
                const lastCall = window[`last_${funcName}_call`];
                const now = Date.now();
                
                if (lastCall && now - lastCall < 300) {
                    console.log(`Ignorando chamada frequente para ${funcName}`);
                    return window[`last_${funcName}_result`];
                }
                
                // Executar a função
                const result = funcOriginal.apply(this, args);
                
                // Armazenar resultado e timestamp
                window[`last_${funcName}_result`] = result;
                window[`last_${funcName}_call`] = now;
                
                return result;
            };
        }
    });
}

// Parte 18: JavaScript - Inicialização Final

// Função para inicializar tudo após autenticação
function inicializarAplicacao() {
    console.log("Inicializando aplicação...");
    
    try {
        // Inicializar dados
        inicializarDados();
        
        // Corrigir problemas específicos
        corrigirDatasFusoHorario();
        corrigirDespesasAdicionais();
        
        // Configurar eventos
        setupEventListeners();
        setupMaterialButtonEvents();
        setupReceitaEvents();
        setupVendasEvents();
        setupFormularioVenda();
        setupBotoesReceitas();
        setupLoginLogout();
        
        // Carregar interfaces
        carregarEstoque();
        carregarMateriais();
        carregarReceitas();
        carregarVendas();
        
        // Aplicar otimizações
        otimizarInterfaceMobile();
        otimizarPerformance();
        
        // Configurar backup e restauração
        implementarInterfaceBackupRestauracao();
        
        // Iniciar monitores
        setTimeout(() => {
            sistemaMonitor.iniciar();
        }, 1000);
        
        console.log("Aplicação inicializada com sucesso!");
    } catch (error) {
        console.error("Erro ao inicializar aplicação:", error);
        
        // Tentar recuperar o sistema
        setTimeout(() => {
            recuperarSistema();
        }, 1000);
    }
}

// Verificação final após carregamento
window.addEventListener('load', function() {
    setTimeout(() => {
        // Verificar se há alguma página ativa
        const paginasAtivas = document.querySelectorAll('.page-content.active');
        if (paginasAtivas.length === 0 && currentUser) {
            console.warn("Nenhuma página ativa detectada, navegando para estoque");
            const estoquePage = document.querySelector('.nav-link[data-page="estoque"]');
            if (estoquePage) {
                estoquePage.click();
            }
        }
        
        // Verificar modais travados
        document.querySelectorAll('.modal-overlay:not(.hidden)').forEach(modal => {
            if (modal.id === 'processing-modal' || modal.id === 'confirmar-exclusao-modal') {
                console.warn(`Modal travado detectado: ${modal.id}, fechando...`);
                modal.classList.add('hidden');
            }
        });
        
        // Verificar botões
        verificarBotoesFuncionando();
    }, 2000);
});

// Inicialização quando o documento estiver pronto
document.addEventListener('DOMContentLoaded', function() {
    console.log("Documento carregado, verificando autenticação...");
    
    // Carregar dados do localStorage
    try {
        estoque = JSON.parse(localStorage.getItem('estoque')) || [];
        materiais = JSON.parse(localStorage.getItem('materiais')) || [];
        receitas = JSON.parse(localStorage.getItem('receitas')) || [];
        vendas = JSON.parse(localStorage.getItem('vendas')) || [];
    } catch (e) {
        console.error('Erro ao carregar dados do localStorage:', e);
        estoque = [];
        materiais = [];
        receitas = [];
        vendas = [];
    }
    
    // Verificar autenticação
    firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
            console.log("Usuário autenticado:", user.email);
            currentUser = user;
            
            // Mostrar informações do usuário
            const userInfoEl = document.getElementById('user-info');
            if (userInfoEl) {
                userInfoEl.classList.remove('hidden');
                document.getElementById('user-email').textContent = user.email;
            }
            
            // Adicionar botão de sincronização
            adicionarBotaoSincronizacao();
            
            // Iniciar sincronização e inicializar sistema
            iniciarSincronizacao().then(() => {
                inicializarAplicacao();
            });
        } else {
            console.log("Usuário não autenticado");
            currentUser = null;
            mostrarTelaLogin();
            
            // Configurar eventos de login/cadastro
            setupLoginLogout();
        }
    });
});  
</script>
</body>
</html>

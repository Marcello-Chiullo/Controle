<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão de Confeitaria</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.4/html5-qrcode.min.js"></script>
    <style>
        /* Estilos Gerais */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #ff85a2;
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        nav {
            background-color: #ffb5c8;
            padding: 10px 0;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        nav ul li {
            margin-right: 20px;
        }
        
        nav ul li a {
            color: #333;
            text-decoration: none;
            font-weight: 500;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        
        nav ul li a:hover, nav ul li a.active {
            background-color: #ff85a2;
            color: white;
        }
        
        h1, h2, h3 {
            margin-top: 0;
            color: #333;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            padding: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 2px;
        }
        
        .btn-primary {
            background-color: #ff85a2;
            color: white;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        table th, table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        table th {
            background-color: #f4f4f4;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Estilos de Página */
        .page-content {
            display: none;
        }
        
        .page-content.active {
            display: block;
        }
        
        /* Estilos do Scanner */
        #reader {
            width: 100%;
            height: 300px;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .scanner-container {
            margin-top: 20px;
        }
        
        /* Estilos de Formulários */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .form-row {
            display: flex;
            margin: 0 -10px;
        }
        
        .form-col {
            flex: 1;
            padding: 0 10px;
        }
        
        /* Animações */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        /* Notificações */
        .notification {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .notification-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .notification-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .notification-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        .notification-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* Estilos para Receitas */
        .recipe-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .recipe-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        
        .ingredients-table {
            margin-top: 10px;
        }
        
        .tab-buttons {
            display: flex;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: 10px 20px;
            border: none;
            background-color: #f1f1f1;
            cursor: pointer;
            transition: background-color 0.3s;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        .tab-button.active {
            background-color: #ff85a2;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        /* Modal para carregamento e feedback */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            max-width: 80%;
            width: 500px;
            text-align: center;
        }
        
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #ff85a2;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #iframe-container {
            width: 100%;
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 15px;
            display: none;
        }
        
        #web-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* Estilos para área de vendas */
        .sale-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .sale-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .sale-title {
            font-weight: bold;
            font-size: 18px;
        }
        
        .sale-date {
            color: #666;
        }
        
        .sale-details {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>Confeitaria System</h1>
            <div>
                <span id="date-time"></span>
            </div>
        </div>
    </header>
    
    <nav>
        <ul>
            <li><a href="#estoque" class="nav-link active" data-page="estoque">Estoque</a></li>
            <li><a href="#materiais" class="nav-link" data-page="materiais">Materiais</a></li>
            <li><a href="#receitas" class="nav-link" data-page="receitas">Receitas</a></li>
            <li><a href="#vendas" class="nav-link" data-page="vendas">Vendas</a></li>
        </ul>
    </nav>
    
    <div class="container">
        <!-- Página de Estoque -->
        <div class="page-content active" id="estoque-page">
            <h2>Gestão de Estoque</h2>
            
            <div class="tab-buttons">
                <button class="tab-button active" data-tab="listar-estoque">Listar Estoque</button>
                <button class="tab-button" data-tab="adicionar-estoque">Adicionar Item</button>
                <button class="tab-button" data-tab="remover-estoque">Remover com Receita</button>
            </div>
            
            <!-- Tab: Listar Estoque -->
            <div class="tab-content active" id="listar-estoque">
                <div class="card">
                    <h3>Itens em Estoque</h3>
                    <div id="notification-estoque"></div>
                    <input type="text" id="pesquisar-estoque" class="form-control" placeholder="Pesquisar item..." style="margin-bottom: 20px;">
                    
                    <table id="tabela-estoque">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Nome</th>
                                <th>Quantidade</th>
                                <th>Unidade</th>
                                <th>Unidade de Medida</th>
                                <th>Preço (R$)</th>
                                <th>Data de Adição</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="itens-estoque">
                            <!-- Os itens do estoque serão adicionados aqui dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Tab: Adicionar Item ao Estoque -->
            <div class="tab-content" id="adicionar-estoque">
                <div class="card">
                    <h3>Adicionar Item ao Estoque</h3>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <button id="iniciar-scanner" class="btn btn-primary">Escanear Código de Barras/QR</button>
                            <div class="scanner-container hidden" id="scanner-container">
                                <div id="reader"></div>
                                <div id="scanner-result"></div>
                                <button id="parar-scanner" class="btn btn-secondary" style="margin-top: 10px;">Parar Scanner</button>
                            </div>
                            <div id="iframe-container">
                                <iframe id="web-iframe" sandbox="allow-same-origin allow-scripts"></iframe>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="codigo-item">Código do Item:</label>
                                <input type="text" id="codigo-item" class="form-control" placeholder="Código ou código de barras">
                            </div>
                        </div>
                    </div>
                    
                    <form id="form-adicionar-estoque">
                        <div class="form-group">
                            <label for="nome-item">Nome do Item:</label>
                            <input type="text" id="nome-item" class="form-control" placeholder="Ex: Farinha de Trigo" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="quantidade-item">Quantidade de Itens:</label>
                                    <input type="number" id="quantidade-item" class="form-control" min="0" step="0.01" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="unidade-item">Unidade:</label>
                                    <select id="unidade-item" class="form-control" required>
                                        <option value="un">Unidades (un)</option>
                                        <option value="cx">Caixas (cx)</option>
                                        <option value="pct">Pacotes (pct)</option>
                                        <option value="lata">Latas (lata)</option>
                                        <option value="garrafa">Garrafas (garrafa)</option>
                                        <option value="caixa">Caixas (caixa)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="unidade-medida-item">Unidade de Medida:</label>
                                    <select id="unidade-medida-item" class="form-control" required>
                                        <option value="kg">Quilogramas (kg)</option>
                                        <option value="g">Gramas (g)</option>
                                        <option value="l">Litros (l)</option>
                                        <option value="ml">Mililitros (ml)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="quantidade-medida-item">Quantidade por Unidade:</label>
                                    <input type="number" id="quantidade-medida-item" class="form-control" min="0" step="0.01" required placeholder="Ex: 350 (para 350ml)">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="preco-item">Preço (R$):</label>
                                    <input type="number" id="preco-item" class="form-control" min="0" step="0.01" placeholder="0.00" required>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Adicionar ao Estoque</button>
                    </form>
                </div>
            </div>
            
            <!-- Tab: Remover com Receita -->
            <div class="tab-content" id="remover-estoque">
                <div class="card">
                    <h3>Remover Itens com Receita</h3>
                    
                    <div class="form-group">
                        <label for="selecionar-receita">Selecione uma Receita:</label>
                        <select id="selecionar-receita" class="form-control">
                            <option value="">Selecione uma receita...</option>
                            <!-- As receitas serão adicionadas aqui dinamicamente -->
                        </select>
                    </div>
                    
                    <div id="detalhes-receita" class="hidden">
                        <h4>Detalhes da Receita: <span id="nome-receita-selecionada"></span></h4>
                        
                        <table id="tabela-ingredientes-receita">
                            <thead>
                                <tr>
                                    <th>Ingrediente</th>
                                    <th>Quantidade Necessária</th>
                                    <th>Estoque Atual</th>
                                    <th>Preço Unitário</th>
                                    <th>Custo</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="ingredientes-receita-selecionada">
                                <!-- Os ingredientes da receita serão adicionados aqui dinamicamente -->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="4" style="text-align: right;"><strong>Custo Total:</strong></td>
                                    <td id="custo-total-receita" style="font-weight: bold;"></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                        
                        <div id="aviso-estoque" class="notification hidden"></div>
                        
                        <div class="form-group">
                            <label for="quantidade-receitas">Quantidade de Receitas:</label>
                            <input type="number" id="quantidade-receitas" class="form-control" value="1" min="1">
                        </div>
                        
                        <button id="confirmar-remocao" class="btn btn-primary">Confirmar Produção</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Página de Materiais -->
        <div class="page-content" id="materiais-page">
            <h2>Catálogo de Materiais</h2>
            
            <div class="tab-buttons">
                <button class="tab-button active" data-tab="listar-materiais">Listar Materiais</button>
                <button class="tab-button" data-tab="adicionar-material">Adicionar Material</button>
            </div>
            
            <!-- Tab: Listar Materiais -->
            <div class="tab-content active" id="listar-materiais">
                <div class="card">
                    <h3>Materiais Cadastrados</h3>
                    <div id="notification-materiais"></div>
                    <input type="text" id="pesquisar-materiais" class="form-control" placeholder="Pesquisar material..." style="margin-bottom: 20px;">
                    
                    <table id="tabela-materiais">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Nome</th>
                                <th>Unidade</th>
                                <th>Unidade de Medida</th>
                                <th>Quantidade por Unidade</th>
                                <th>Última Compra</th>
                                <th>Último Preço (R$)</th>
                                <th>Preço Médio (R$)</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="itens-materiais">
                            <!-- Os materiais serão adicionados aqui dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Tab: Adicionar Material -->
            <div class="tab-content" id="adicionar-material">
                <div class="card">
                    <h3>Adicionar Novo Material</h3>
                    
                    <form id="form-adicionar-material">
                        <div class="form-group">
                            <label for="codigo-material">Código do Material:</label>
                            <input type="text" id="codigo-material" class="form-control" placeholder="Código ou código de barras">
                        </div>
                        
                        <div class="form-group">
                            <label for="nome-material">Nome do Material:</label>
                            <input type="text" id="nome-material" class="form-control" placeholder="Ex: Farinha de Trigo" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="unidade-material">Unidade:</label>
                                    <select id="unidade-material" class="form-control" required>
                                        <option value="un">Unidades (un)</option>
                                        <option value="cx">Caixas (cx)</option>
                                        <option value="pct">Pacotes (pct)</option>
                                        <option value="lata">Latas (lata)</option>
                                        <option value="garrafa">Garrafas (garrafa)</option>
                                        <option value="caixa">Caixas (caixa)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="unidade-medida-material">Unidade de Medida:</label>
                                    <select id="unidade-medida-material" class="form-control" required>
                                        <option value="kg">Quilogramas (kg)</option>
                                        <option value="g">Gramas (g)</option>
                                        <option value="l">Litros (l)</option>
                                        <option value="ml">Mililitros (ml)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="quantidade-medida-material">Quantidade por Unidade:</label>
                                    <input type="number" id="quantidade-medida-material" class="form-control" min="0" step="0.01" required placeholder="Ex: 350 (para 350ml)">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="preco-material">Preço (R$):</label>
                                    <input type="number" id="preco-material" class="form-control" min="0" step="0.01" placeholder="0.00" required>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Adicionar Material</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Página de Receitas -->
        <div class="page-content" id="receitas-page">
            <h2>Gestão de Receitas</h2>
            
            <div class="tab-buttons">
                <button class="tab-button active" data-tab="listar-receitas">Listar Receitas</button>
                <button class="tab-button" data-tab="adicionar-receita">Adicionar Receita</button>
            </div>
            
            <!-- Tab: Listar Receitas -->
            <div class="tab-content active" id="listar-receitas">
                <div class="card">
                    <h3>Receitas Cadastradas</h3>
                    <input type="text" id="pesquisar-receita" class="form-control" placeholder="Pesquisar receita..." style="margin-bottom: 20px;">
                    
                    <div id="lista-receitas">
                        <!-- As receitas serão adicionadas aqui dinamicamente -->
                    </div>
                </div>
            </div>
            
            <!-- Tab: Adicionar Receita -->
            <div class="tab-content" id="adicionar-receita">
                <div class="card">
                    <h3>Adicionar Nova Receita</h3>
                    
                    <form id="form-adicionar-receita">
                        <div class="form-group">
                            <label for="nome-receita">Nome da Receita:</label>
                            <input type="text" id="nome-receita" class="form-control" placeholder="Ex: Bolo de Chocolate" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="descricao-receita">Descrição:</label>
                            <textarea id="descricao-receita" class="form-control" rows="3" placeholder="Descreva brevemente a receita..."></textarea>
                        </div>
                        
                        <h4>Ingredientes</h4>
                        <div id="lista-ingredientes">
                            <!-- Os ingredientes serão adicionados aqui dinamicamente -->
                        </div>
                        
                        <button type="button" id="adicionar-ingrediente" class="btn btn-secondary">+ Adicionar Ingrediente</button>
                        
                        <div style="margin-top: 20px;">
                            <button type="submit" class="btn btn-primary">Salvar Receita</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Página de Vendas -->
        <div class="page-content" id="vendas-page">
            <h2>Histórico de Vendas</h2>
            
            <div class="tab-buttons">
                <button class="tab-button active" data-tab="listar-vendas">Histórico de Vendas</button>
            </div>
            
            <!-- Tab: Listar Vendas -->
            <div class="tab-content active" id="listar-vendas">
                <div class="card">
                    <h3>Registro de Produções / Vendas</h3>
                    <div id="notification-vendas"></div>
                    <input type="text" id="pesquisar-vendas" class="form-control" placeholder="Pesquisar vendas..." style="margin-bottom: 20px;">
                    
                    <div class="form-row" style="margin-bottom: 20px;">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="filtro-data-inicio">Data Inicial:</label>
                                <input type="date" id="filtro-data-inicio" class="form-control">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="filtro-data-fim">Data Final:</label>
                                <input type="date" id="filtro-data-fim" class="form-control">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="filtro-receita">Receita:</label>
                                <select id="filtro-receita" class="form-control">
                                    <option value="">Todas as receitas</option>
                                    <!-- As receitas serão adicionadas aqui dinamicamente -->
                                </select>
                            </div>
                        </div>
                        <div class="form-col" style="display: flex; align-items: flex-end;">
                            <button id="btn-filtrar-vendas" class="btn btn-primary">Filtrar</button>
                            <button id="btn-limpar-filtros" class="btn btn-secondary" style="margin-left: 10px;">Limpar</button>
                        </div>
                    </div>
                    
                    <div id="lista-vendas">
                        <!-- As vendas serão adicionadas aqui dinamicamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para processamento de dados -->
    <div id="processing-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="modal-title">Processando...</h3>
            <div class="loader"></div>
            <p id="modal-message">Aguarde enquanto processamos as informações.</p>
        </div>
    </div>

    <script>
// Inicialização do localStorage se necessário
if (!localStorage.getItem('estoque')) {
    localStorage.setItem('estoque', JSON.stringify([]));
}

if (!localStorage.getItem('materiais')) {
    localStorage.setItem('materiais', JSON.stringify([]));
}

if (!localStorage.getItem('receitas')) {
    localStorage.setItem('receitas', JSON.stringify([]));
}

if (!localStorage.getItem('vendas')) {
    localStorage.setItem('vendas', JSON.stringify([]));
}

// Variáveis globais
let estoque = JSON.parse(localStorage.getItem('estoque')) || [];
let materiais = JSON.parse(localStorage.getItem('materiais')) || [];
let receitas = JSON.parse(localStorage.getItem('receitas')) || [];
let vendas = JSON.parse(localStorage.getItem('vendas')) || [];
let html5QrCode;
        // Função para atualizar o localStorage
function atualizarLocalStorage() {
    localStorage.setItem('estoque', JSON.stringify(estoque));
    localStorage.setItem('materiais', JSON.stringify(materiais));
    localStorage.setItem('receitas', JSON.stringify(receitas));
    localStorage.setItem('vendas', JSON.stringify(vendas));
}

// Função para mostrar uma notificação
function mostrarNotificacao(elemento, mensagem, tipo) {
    const notificacao = document.getElementById(elemento);
    notificacao.className = `notification notification-${tipo}`;
    notificacao.textContent = mensagem;
    
    // Esconder a notificação após 5 segundos
    setTimeout(() => {
        notificacao.className = 'notification hidden';
    }, 5000);
}

// Função para mostrar/esconder o modal de processamento
function toggleModal(show, title = "Processando...", message = "Aguarde enquanto processamos as informações.") {
    const modal = document.getElementById('processing-modal');
    
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-message').textContent = message;
    
    if (show) {
        modal.classList.remove('hidden');
        
        // Adicionar timer de segurança - fechará o modal após 10 segundos
        window.modalSafetyTimer = setTimeout(() => {
            modal.classList.add('hidden');
        }, 10000);
    } else {
        modal.classList.add('hidden');
        // Limpar o timer de segurança se o modal for fechado manualmente
        if (window.modalSafetyTimer) {
            clearTimeout(window.modalSafetyTimer);
        }
    }
}

// Função para formatar data
function formatarData(data) {
    const d = new Date(data);
    return `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getFullYear()}`;
}

// Função para formatar valor monetário
function formatarMoeda(valor) {
    return 'R$ ' + valor.toFixed(2).replace('.', ',');
}

// Função para gerar ID único
function gerarId() {
    return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// Função para encontrar um material pelo código
function encontrarMaterialPorCodigo(codigo) {
    return materiais.find(m => m.codigo === codigo);
}

// Função para adicionar ou atualizar um material no catálogo
function adicionarOuAtualizarMaterial(codigoMaterial, nomeMaterial, unidadeMaterial, unidadeMedidaMaterial, quantidadeMedidaMaterial, precoMaterial) {
    // Verificar se o material já existe
    const materialExistente = encontrarMaterialPorCodigo(codigoMaterial);
    
    if (materialExistente) {
        // Atualizar material existente
        materialExistente.nome = nomeMaterial;
        materialExistente.unidade = unidadeMaterial;
        materialExistente.unidadeMedida = unidadeMedidaMaterial;
        materialExistente.quantidadeMedida = quantidadeMedidaMaterial;
        
        // Adicionar histórico de preço
        materialExistente.historicoPrecos.push({
            data: new Date().toISOString(),
            preco: precoMaterial
        });
        
        // Atualizar o último preço
        materialExistente.ultimoPreco = precoMaterial;
        materialExistente.ultimaCompra = new Date().toISOString();
        
        // Recalcular o preço médio
        const totalPrecos = materialExistente.historicoPrecos.reduce((soma, item) => soma + item.preco, 0);
        materialExistente.precoMedio = totalPrecos / materialExistente.historicoPrecos.length;
        
        return materialExistente.id;
    } else {
        // Criar novo material
        const novoMaterial = {
            id: gerarId(),
            codigo: codigoMaterial,
            nome: nomeMaterial,
            unidade: unidadeMaterial,
            unidadeMedida: unidadeMedidaMaterial,
            quantidadeMedida: quantidadeMedidaMaterial,
            ultimoPreco: precoMaterial,
            precoMedio: precoMaterial,
            ultimaCompra: new Date().toISOString(),
            dataCadastro: new Date().toISOString(),
            historicoPrecos: [{
                data: new Date().toISOString(),
                preco: precoMaterial
            }]
        };
        
        materiais.push(novoMaterial);
        return novoMaterial.id;
    }
}

// Função para carregar materiais na tabela
function carregarMateriais() {
    const tbody = document.getElementById('itens-materiais');
    tbody.innerHTML = '';
    
    if (materiais.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="9" style="text-align: center;">Nenhum material cadastrado.</td>';
        tbody.appendChild(tr);
        return;
    }
    
    materiais.forEach((material, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${material.codigo || 'N/A'}</td>
            <td>${material.nome}</td>
            <td>${material.unidade}</td>
            <td>${material.unidadeMedida}</td>
            <td>${material.quantidadeMedida}</td>
            <td>${formatarData(material.ultimaCompra)}</td>
            <td>${formatarMoeda(material.ultimoPreco)}</td>
            <td>${formatarMoeda(material.precoMedio)}</td>
            <td>
                <button class="btn btn-primary btn-editar-material" data-index="${index}">Editar</button>
                <button class="btn btn-success btn-adicionar-estoque" data-id="${material.id}">+ Estoque</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
    
    // Adicionar eventos aos botões
    document.querySelectorAll('.btn-editar-material').forEach(btn => {
        btn.addEventListener('click', function() {
            const index = this.getAttribute('data-index');
            editarMaterial(index);
        });
    });
    
    document.querySelectorAll('.btn-adicionar-estoque').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            adicionarAoEstoque(id);
        });
    });
}

// Função para editar um material
function editarMaterial(index) {
    const material = materiais[index];
    
    // Mudar para a aba de adicionar material
    document.querySelector('[data-tab="adicionar-material"]').click();
    
    // Preencher o formulário
    document.getElementById('codigo-material').value = material.codigo || '';
    document.getElementById('nome-material').value = material.nome;
    document.getElementById('unidade-material').value = material.unidade;
    document.getElementById('unidade-medida-material').value = material.unidadeMedida;
    document.getElementById('quantidade-medida-material').value = material.quantidadeMedida;
    document.getElementById('preco-material').value = material.ultimoPreco;
    
    // Modificar o botão de submit
    const submitBtn = document.querySelector('#form-adicionar-material button[type="submit"]');
    submitBtn.textContent = 'Atualizar Material';
    submitBtn.setAttribute('data-edicao', index);
}

// Função para adicionar um material ao estoque
function adicionarAoEstoque(materialId) {
    const material = materiais.find(m => m.id === materialId);
    if (!material) return;
    
    // Mudar para a página de estoque e a aba de adicionar
    document.querySelector('[data-page="estoque"]').click();
    document.querySelector('[data-tab="adicionar-estoque"]').click();
    
    // Preencher o formulário com os dados do material
    document.getElementById('codigo-item').value = material.codigo || '';
    document.getElementById('nome-item').value = material.nome;
    document.getElementById('quantidade-item').value = 1;
    document.getElementById('unidade-item').value = material.unidade;
    document.getElementById('unidade-medida-item').value = material.unidadeMedida;
    document.getElementById('quantidade-medida-item').value = material.quantidadeMedida;
    document.getElementById('preco-item').value = material.ultimoPreco;
}

// Função para calcular o custo de uma receita
function calcularCustoReceita(receita) {
    let custoTotal = 0;
    
    receita.ingredientes.forEach(ingrediente => {
        const itemEstoque = estoque.find(item => item.id === ingrediente.id);
        if (itemEstoque && itemEstoque.preco) {
            // Calculamos o custo com base na quantidade da unidade de medida
            const custoUnitario = itemEstoque.preco / (itemEstoque.quantidade * itemEstoque.quantidadeMedida);
            custoTotal += custoUnitario * ingrediente.quantidade;
        }
    });
    
    return custoTotal;
}

// Função para carregar o estoque na tabela
function carregarEstoque() {
    const tbody = document.getElementById('itens-estoque');
    tbody.innerHTML = '';
    
    if (estoque.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="8" style="text-align: center;">Nenhum item no estoque.</td>';
        tbody.appendChild(tr);
        return;
    }
    
    estoque.forEach((item, index) => {
        // Calcular a quantidade em unidade de medida (ex: ml restantes)
        const quantidadeTotalMedida = item.quantidade * item.quantidadeMedida;
        // Verificar se é um número fracionário
        const quantidadeFracionada = item.quantidade % 1 !== 0;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${item.codigo || 'N/A'}</td>
            <td>${item.nome}</td>
            <td>${item.quantidade.toFixed(2)} ${quantidadeFracionada ? `(${Math.floor(item.quantidade)} + ${((item.quantidade % 1) * 100).toFixed(0)}%)` : ''}</td>
            <td>${item.unidade}</td>
            <td>${quantidadeTotalMedida.toFixed(0)} ${item.unidadeMedida || 'N/A'}</td>
            <td>${formatarMoeda(item.preco || 0)}</td>
            <td>${formatarData(item.dataAdicao)}</td>
            <td>
                <button class="btn btn-primary btn-editar-estoque" data-index="${index}">Editar</button>
                <button class="btn btn-danger btn-remover-estoque" data-index="${index}">Remover</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
    
    // Adicionar eventos aos botões
    addBotaoEditarEstoqueEvents();
    addBotaoRemoverEstoqueEvents();
}

// Função para adicionar eventos aos botões de editar estoque
function addBotaoEditarEstoqueEvents() {
    document.querySelectorAll('.btn-editar-estoque').forEach(btn => {
        btn.addEventListener('click', function() {
            const index = this.getAttribute('data-index');
            editarItemEstoque(index);
        });
    });
}

// Função para adicionar eventos aos botões de remover estoque
function addBotaoRemoverEstoqueEvents() {
    document.querySelectorAll('.btn-remover-estoque').forEach(btn => {
        btn.addEventListener('click', function() {
            const index = this.getAttribute('data-index');
            removerItemEstoque(index);
        });
    });
}

// Função para editar um item do estoque
function editarItemEstoque(index) {
    const item = estoque[index];
    
    // Mudar para a aba de adicionar
    document.querySelector('[data-tab="adicionar-estoque"]').click();
    
    // Preencher o formulário
    document.getElementById('codigo-item').value = item.codigo || '';
    document.getElementById('nome-item').value = item.nome;
    document.getElementById('quantidade-item').value = item.quantidade;
    document.getElementById('unidade-item').value = item.unidade;
    document.getElementById('unidade-medida-item').value = item.unidadeMedida || 'ml';
    document.getElementById('quantidade-medida-item').value = item.quantidadeMedida || '';
    document.getElementById('preco-item').value = item.preco || '';
    
    // Modificar o botão de submit
    const submitBtn = document.querySelector('#form-adicionar-estoque button[type="submit"]');
    submitBtn.textContent = 'Atualizar Item';
    submitBtn.setAttribute('data-edicao', index);
}

// Função para remover um item do estoque
function removerItemEstoque(index) {
    if (confirm('Tem certeza que deseja remover este item do estoque?')) {
        estoque.splice(index, 1);
        atualizarLocalStorage();
        carregarEstoque();
        atualizarSelectsIngredientes();
        mostrarNotificacao('notification-estoque', 'Item removido com sucesso!', 'success');
    }
}

// Função para carregar receitas
function carregarReceitas() {
    const container = document.getElementById('lista-receitas');
    container.innerHTML = '';
    
    // Carregar no select da página de remoção com receita
    const selectRemocao = document.getElementById('selecionar-receita');
    selectRemocao.innerHTML = '<option value="">Selecione uma receita...</option>';
    
    // Carregar no select do filtro de vendas
    const selectFiltroVendas = document.getElementById('filtro-receita');
    if (selectFiltroVendas) {
        selectFiltroVendas.innerHTML = '<option value="">Todas as receitas</option>';
    }
    
    if (receitas.length === 0) {
        container.innerHTML = '<p>Nenhuma receita cadastrada.</p>';
        return;
    }
    
    receitas.forEach((receita, index) => {
        // Calcular o custo total da receita
        const custoTotal = calcularCustoReceita(receita);
        
        // Adicionar ao container de lista
        const card = document.createElement('div');
        card.className = 'recipe-card';
        card.innerHTML = `
            <h3>${receita.nome}</h3>
            <p>${receita.descricao || 'Sem descrição'}</p>
            <p><strong>Custo de Produção:</strong> ${formatarMoeda(custoTotal)}</p>
            <div class="ingredients-table">
                <h4>Ingredientes:</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Ingrediente</th>
                            <th>Quantidade</th>
                            <th>Custo</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${receita.ingredientes.map(ing => {
                            const itemEstoque = estoque.find(item => item.id === ing.id);
                            let custoExibicao = 0;
                            
                            if (itemEstoque) {
                                // Calculamos o custo unitário baseado na unidade de medida
                                const custoUnitario = itemEstoque.preco / (itemEstoque.quantidade * itemEstoque.quantidadeMedida);
                                custoExibicao = custoUnitario * ing.quantidade;
                            }
                            
                            return `
                                <tr>
                                    <td>${ing.nome}</td>
                                    <td>${ing.quantidade} ${ing.unidadeMedida}</td>
                                    <td>${formatarMoeda(custoExibicao)}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            <div style="margin-top: 15px;">
                <button class="btn btn-primary btn-editar-receita" data-index="${index}">Editar</button>
                <button class="btn btn-danger btn-remover-receita" data-index="${index}">Remover</button>
                <button class="btn btn-success btn-produzir-receita" data-index="${index}">Produzir</button>
            </div>
        `;
        container.appendChild(card);
        
        // Adicionar ao select de remoção de estoque
        const optionRemocao = document.createElement('option');
        optionRemocao.value = index;
        optionRemocao.textContent = receita.nome;
        selectRemocao.appendChild(optionRemocao);
        
        // Adicionar ao select de filtro de vendas
        if (selectFiltroVendas) {
            const optionFiltro = document.createElement('option');
            optionFiltro.value = receita.id;
            optionFiltro.textContent = receita.nome;
            selectFiltroVendas.appendChild(optionFiltro);
        }
    });
    
    // Adicionar eventos aos botões
    addRecipeButtonEvents();
}

// Função para adicionar eventos aos botões das receitas
function addRecipeButtonEvents() {
    document.querySelectorAll('.btn-editar-receita').forEach(btn => {
        btn.addEventListener('click', function() {
            const index = this.getAttribute('data-index');
            editarReceita(index);
        });
    });
    
    document.querySelectorAll('.btn-remover-receita').forEach(btn => {
        btn.addEventListener('click', function() {
            const index = this.getAttribute('data-index');
            removerReceita(index);
        });
    });
    
    document.querySelectorAll('.btn-produzir-receita').forEach(btn => {
        btn.addEventListener('click', function() {
            const index = this.getAttribute('data-index');
            
            // Mudar para a página de estoque e aba de remover
            document.querySelector('[data-page="estoque"]').click();
            document.querySelector('[data-tab="remover-estoque"]').click();
            
            // Selecionar a receita
            document.getElementById('selecionar-receita').value = index;
            document.getElementById('selecionar-receita').dispatchEvent(new Event('change'));
        });
    });
}

// Evento para mostrar a data/hora atual
function atualizarDataHora() {
    const agora = new Date();
    const dataFormatada = agora.toLocaleDateString('pt-BR');
    const horaFormatada = agora.toLocaleTimeString('pt-BR');
    document.getElementById('date-time').textContent = `${dataFormatada} ${horaFormatada}`;
}

// Configurar eventos quando o DOM estiver carregado
document.addEventListener('DOMContentLoaded', function() {
    // Garantir que o modal esteja oculto ao iniciar
    const modalElement = document.getElementById('processing-modal');
    if (modalElement) {
        modalElement.classList.add('hidden');
    }
    
    // Inicializar IDs para itens de estoque e materiais
    estoque.forEach((item, index) => {
        if (!item.id) {
            item.id = gerarId();
        }
    });
    
    materiais.forEach((material, index) => {
        if (!material.id) {
            material.id = gerarId();
        }
        
        // Garantir que o histórico de preços existe
        if (!material.historicoPrecos) {
            material.historicoPrecos = [{
                data: material.dataCadastro || new Date().toISOString(),
                preco: material.ultimoPreco || 0
            }];
        }
    });
    
    receitas.forEach(receita => {
        if (!receita.id) {
            receita.id = gerarId();
        }
    });
    
    vendas.forEach(venda => {
        if (!venda.id) {
            venda.id = gerarId();
        }
    });
    
    atualizarLocalStorage();
    
    // Carregar dados nas interfaces
    carregarEstoque();
    carregarMateriais();
    carregarReceitas();
    carregarVendas();
    
    // Eventos de navegação
    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Atualizar navegação
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            this.classList.add('active');
            
            // Mostrar página correspondente
            const pagina = this.getAttribute('data-page');
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            document.getElementById(`${pagina}-page`).classList.add('active');
        });
    });
    
    // Eventos das abas
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', function() {
            // Atualizar botões
            const parent = this.parentElement;
            parent.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Mostrar conteúdo correspondente
            const tab = this.getAttribute('data-tab');
            const container = parent.parentElement;
            container.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
        });
    });
    
    // Iniciar o relógio
    atualizarDataHora();
    setInterval(atualizarDataHora, 1000);
});
    </script>
</body>
</html>
